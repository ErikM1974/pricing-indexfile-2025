<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Art Invoicing System - Northwest Custom Apparel</title>
    <link rel="icon" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Art Invoice Service V2 -->
    <script src="calculators/art-invoice-service-v2.js?v=2.2"></script>
    
    <!-- Art Invoice Dashboard Styles -->
    <link rel="stylesheet" href="css/art-invoice-dashboard.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                     alt="Northwest Custom Apparel" class="logo">
                <nav class="breadcrumb">
                    <a href="/staff-dashboard.html">Staff Dashboard</a>
                    <span>/</span>
                    <span>Art Invoicing</span>
                </nav>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i>
                    Print
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <h1>Art Invoicing System</h1>
            </div>
            <div class="page-actions">
                <button class="btn btn-secondary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <form class="search-form" onsubmit="handleSearch(event)">
                <input type="text" 
                       class="search-input" 
                       id="searchInput"
                       placeholder="Search by company name, ID Design, invoice ID, or customer name..."
                       autocomplete="off">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearSearch()">
                    Clear
                </button>
            </form>
        </div>

        <!-- Date Filter -->
        <div class="date-filter-container">
            <div class="date-filter-header">
                <i class="fas fa-calendar-alt"></i>
                <span>Date Filter</span>
            </div>
            <div class="date-filter-controls">
                <div class="date-input-group">
                    <label class="date-input-label" for="dateFrom">From:</label>
                    <input type="date" id="dateFrom" class="date-input" value="2025-06-26">
                </div>
                <div class="date-input-group">
                    <label class="date-input-label" for="dateTo">To:</label>
                    <input type="date" id="dateTo" class="date-input" value="2025-07-03">
                </div>
                <div class="date-filter-actions">
                    <button type="button" class="btn btn-primary btn-sm" onclick="applyDateFilter()">
                        <i class="fas fa-filter"></i>
                        Apply Filter
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="clearDateFilter()">
                        <i class="fas fa-times"></i>
                        Clear Dates
                    </button>
                </div>
            </div>
            <div class="date-filter-info">
                <i class="fas fa-info-circle"></i>
                <span id="dateFilterInfo">Showing art requests from the last 7 days. Clear dates to see all records.</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs" id="tabsContainer">
                <button class="tab active" onclick="switchTab('needs-invoice')">
                    Needs Invoice
                    <span class="tab-badge" id="needsInvoiceCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('draft')">
                    Draft
                    <span class="tab-badge" id="draftCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('sent')">
                    Sent
                    <span class="tab-badge" id="sentCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('paid')">
                    Paid
                    <span class="tab-badge" id="paidCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('overdue')">
                    Overdue
                    <span class="tab-badge" id="overdueCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('all')">
                    All
                    <span class="tab-badge" id="allCount">0</span>
                </button>
            </div>
        </div>

        <!-- Status Filters (only shown for Needs Invoice tab) -->
        <div class="status-filters" id="statusFilters" style="display: block;">
            <div class="filter-group">
                <label class="filter-label">
                    <input type="checkbox" id="filterNew" onchange="filterStatusChanged()">
                    <span>New (No Status)</span>
                </label>
                <label class="filter-label">
                    <input type="checkbox" id="filterAwaitingApproval" onchange="filterStatusChanged()">
                    <span>Awaiting Approval ðŸŸ£</span>
                </label>
                <label class="filter-label">
                    <input type="checkbox" id="filterCompleted" checked onchange="filterStatusChanged()">
                    <span>Completed âœ…</span>
                </label>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-table-container">
            <div id="loadingContainer" class="loading-container" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <h3>No items found</h3>
                <p>Try adjusting your search or filters</p>
            </div>
            <table class="data-table" id="dataTable" style="display: none;">
                <thead id="tableHeader">
                    <!-- Dynamic headers based on tab -->
                </thead>
                <tbody id="tableBody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </main>


    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header" style="background: var(--success-bg); color: var(--success-text);">
                <h3><i class="fas fa-check-circle"></i> Invoice Created Successfully!</h3>
                <button class="modal-close" onclick="closeSuccessModal()">Ã—</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 2rem;">
                <div style="font-size: 1.125rem; margin-bottom: 1.5rem;">
                    <p>Invoice <strong id="successInvoiceId"></strong> has been created successfully!</p>
                    <p id="successEmailStatus" style="color: var(--text-secondary);"></p>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-secondary" onclick="viewInvoice()">
                        <i class="fas fa-eye"></i>
                        View Invoice
                    </button>
                    <button class="btn btn-primary" onclick="createAnother()">
                        <i class="fas fa-plus"></i>
                        Create Another
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Artwork Helper Functions
        function hasArtwork(cdnLink) {
            return cdnLink && cdnLink.includes('/Artwork/') && cdnLink !== 'https://cdn.caspio.com/A0E15000';
        }

        function getFirstArtwork(artRequest) {
            const cdnFields = ['CDN_Link', 'CDN_Link_Two', 'CDN_Link_Three', 'CDN_Link_Four'];
            
            for (const field of cdnFields) {
                if (hasArtwork(artRequest[field])) {
                    return artRequest[field];
                }
            }
            return null;
        }

        function getAllArtworks(artRequest) {
            const cdnFields = ['CDN_Link', 'CDN_Link_Two', 'CDN_Link_Three', 'CDN_Link_Four'];
            const artworks = [];
            
            cdnFields.forEach((field, index) => {
                if (hasArtwork(artRequest[field])) {
                    artworks.push({
                        url: artRequest[field],
                        label: `Artwork ${index + 1}`
                    });
                }
            });
            
            return artworks;
        }

        function createArtworkThumbnail(artRequest) {
            const artworkUrl = getFirstArtwork(artRequest);
            
            if (!artworkUrl) {
                return '';
            }
            
            // Count total artwork files
            const artworkCount = getAllArtworks(artRequest).length;
            const countBadge = artworkCount > 1 ? `<span class="artwork-count-badge">+${artworkCount - 1}</span>` : '';
            
            return `
                <div class="artwork-thumbnail" onclick='showArtworkModal(${JSON.stringify(artRequest).replace(/'/g, "&#39;")})' style="position: relative;">
                    <img src="${artworkUrl}" 
                         alt="Artwork ${artRequest.ID_Design}" 
                         onload="this.classList.add('loaded')"
                         onerror="this.parentElement.style.display='none'"
                         loading="lazy">
                    <i class="fas fa-search-plus"></i>
                    ${countBadge}
                </div>
            `;
        }

        let currentArtworkIndex = 0;
        let currentArtworks = [];
        let currentDesignId = null;

        function showArtworkModal(artRequest) {
            let modal = document.getElementById('artworkModal');
            if (!modal) {
                modal = createArtworkModal();
            }
            
            // Get all artworks for this request
            currentArtworks = getAllArtworks(artRequest);
            currentDesignId = artRequest.ID_Design;
            currentArtworkIndex = 0;
            
            if (currentArtworks.length === 0) {
                return;
            }
            
            // Update modal for gallery view
            updateArtworkModalContent();
            modal.classList.add('active');
        }

        function updateArtworkModalContent() {
            const modal = document.getElementById('artworkModal');
            const modalTitle = modal.querySelector('.artwork-modal-title');
            
            // Update title with counter
            if (currentArtworks.length > 1) {
                modalTitle.textContent = `Design #${currentDesignId} - ${currentArtworkIndex + 1} of ${currentArtworks.length}`;
            } else {
                modalTitle.textContent = `Design #${currentDesignId}`;
            }
            
            // Update images
            const images = modal.querySelectorAll('.modal-artwork-image');
            images.forEach((img, index) => {
                if (index < currentArtworks.length && index === currentArtworkIndex) {
                    img.src = currentArtworks[index].url;
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
            
            // Update navigation buttons visibility
            const prevBtn = modal.querySelector('.artwork-modal-prev');
            const nextBtn = modal.querySelector('.artwork-modal-next');
            if (currentArtworks.length > 1) {
                if (prevBtn) {
                    prevBtn.style.display = 'block';
                    prevBtn.disabled = currentArtworkIndex === 0;
                }
                if (nextBtn) {
                    nextBtn.style.display = 'block';
                    nextBtn.disabled = currentArtworkIndex === currentArtworks.length - 1;
                }
            } else {
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            }
            
            // Update indicators
            const indicators = modal.querySelectorAll('.artwork-indicator');
            const indicatorsContainer = modal.querySelector('.artwork-modal-indicators');
            
            indicators.forEach((indicator, index) => {
                if (index < currentArtworks.length) {
                    indicator.style.display = 'block';
                    if (index === currentArtworkIndex) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                } else {
                    indicator.style.display = 'none';
                }
            });
            
            // Hide indicators container if only one image
            if (indicatorsContainer) {
                indicatorsContainer.style.display = currentArtworks.length > 1 ? 'flex' : 'none';
            }
        }

        function navigateArtwork(direction) {
            if (direction === 'prev' && currentArtworkIndex > 0) {
                currentArtworkIndex--;
            } else if (direction === 'next' && currentArtworkIndex < currentArtworks.length - 1) {
                currentArtworkIndex++;
            }
            updateArtworkModalContent();
        }

        function setArtworkIndex(index) {
            if (index >= 0 && index < currentArtworks.length) {
                currentArtworkIndex = index;
                updateArtworkModalContent();
            }
        }

        function createArtworkModal() {
            const modal = document.createElement('div');
            modal.id = 'artworkModal';
            modal.className = 'artwork-modal';
            
            let modalContent = `
                <div class="artwork-modal-content">
                    <span class="artwork-modal-title"></span>
                    <button class="artwork-modal-close" onclick="closeArtworkModal()">Ã—</button>
                    
                    <!-- Navigation buttons -->
                    <button class="artwork-modal-nav artwork-modal-prev" onclick="navigateArtwork('prev')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="artwork-modal-nav artwork-modal-next" onclick="navigateArtwork('next')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <!-- Images container -->
                    <div class="artwork-images-container">`;
            
            // Create placeholders for up to 4 images
            for (let i = 0; i < 4; i++) {
                modalContent += `<img class="modal-artwork-image" src="" alt="Artwork ${i + 1}">`;
            }
            
            modalContent += `
                    </div>
                    
                    <!-- Footer with indicators and download -->
                    <div class="artwork-modal-footer">
                        <div class="artwork-modal-indicators">`;
            
            // Create indicators
            for (let i = 0; i < 4; i++) {
                modalContent += `<span class="artwork-indicator" onclick="setArtworkIndex(${i})"></span>`;
            }
            
            modalContent += `
                        </div>
                        <button class="artwork-modal-download" onclick="downloadCurrentArtwork()">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeArtworkModal();
                }
            });
            
            return modal;
        }

        function closeArtworkModal() {
            const modal = document.getElementById('artworkModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function downloadCurrentArtwork() {
            if (currentArtworks.length === 0 || currentArtworkIndex < 0) return;
            
            const artwork = currentArtworks[currentArtworkIndex];
            const link = document.createElement('a');
            link.href = artwork.url;
            link.download = `Design_${currentDesignId}_${artwork.label.replace(' ', '_')}.png`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Utility function to safely get DOM elements
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }
        
        // Show loading indicator
        function showLoading() {
            const container = document.querySelector('.main-container');
            if (container) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingIndicator';
                loadingDiv.style.cssText = 'text-align: center; padding: 2rem;';
                loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i><p>Loading data...</p>';
                container.insertBefore(loadingDiv, container.firstChild);
            }
        }
        
        // Hide loading indicator
        function hideLoading() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        // Set button loading state
        function setButtonLoading(button, loading = true) {
            if (!button) return;
            
            if (loading) {
                button.disabled = true;
                button.classList.add('btn-loading');
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = '<span style="opacity: 0;">Loading</span>';
            } else {
                button.disabled = false;
                button.classList.remove('btn-loading');
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                    delete button.dataset.originalText;
                }
            }
        }

        // Initialize
        const invoiceService = new ArtInvoiceServiceV2();
        let currentTab = 'needs-invoice';
        let allArtRequests = [];
        let allInvoices = [];
        let filteredData = [];

        // Date filter functions
        function getDateFilters() {
            const dateFrom = document.getElementById('dateFrom')?.value;
            const dateTo = document.getElementById('dateTo')?.value;
            
            const filters = {};
            if (dateFrom) {
                filters.dateCreatedFrom = dateFrom;
            }
            if (dateTo) {
                filters.dateCreatedTo = dateTo;
            }
            
            return filters;
        }

        function applyDateFilter() {
            // Get date values
            const dateFrom = document.getElementById('dateFrom')?.value;
            const dateTo = document.getElementById('dateTo')?.value;
            
            // Update info text
            const dateFilterInfo = document.getElementById('dateFilterInfo');
            if (dateFilterInfo) {
                if (dateFrom && dateTo) {
                    const fromDate = new Date(dateFrom).toLocaleDateString();
                    const toDate = new Date(dateTo).toLocaleDateString();
                    dateFilterInfo.textContent = `Showing art requests from ${fromDate} to ${toDate}`;
                } else if (dateFrom) {
                    const fromDate = new Date(dateFrom).toLocaleDateString();
                    dateFilterInfo.textContent = `Showing art requests from ${fromDate}`;
                } else if (dateTo) {
                    const toDate = new Date(dateTo).toLocaleDateString();
                    dateFilterInfo.textContent = `Showing art requests up to ${toDate}`;
                } else {
                    dateFilterInfo.textContent = 'Showing all art requests';
                }
            }
            
            // Reload data with filters
            loadData();
        }

        function clearDateFilter() {
            // Clear date inputs
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            if (dateFrom) dateFrom.value = '';
            if (dateTo) dateTo.value = '';
            
            // Update info text
            const dateFilterInfo = document.getElementById('dateFilterInfo');
            if (dateFilterInfo) {
                dateFilterInfo.textContent = 'Showing all art requests. Use the date filter to limit results.';
            }
            
            // Reload data without filters
            loadData();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            emailjs.init('4qSbDO-SQs19TbP80');
            
            // Set default date range (7 days ago to today)
            const today = new Date();
            const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const dateFromInput = document.getElementById('dateFrom');
            const dateToInput = document.getElementById('dateTo');
            
            if (dateFromInput) {
                dateFromInput.value = sevenDaysAgo.toISOString().split('T')[0];
            }
            if (dateToInput) {
                dateToInput.value = today.toISOString().split('T')[0];
            }
            
            loadData();
        });

        // Load all data
        async function loadData() {
            showLoading();
            try {
                // Get date filters
                const dateFilters = getDateFilters();
                
                // Build art request filters
                const artRequestFilters = {
                    ...dateFilters,
                    limit: 1000  // Still set a reasonable limit
                };
                
                // Fetch both art requests and invoices in parallel
                const [requests, invoices] = await Promise.all([
                    invoiceService.getArtRequests(artRequestFilters).catch(err => {
                        console.error('Failed to load art requests:', err);
                        return [];
                    }),
                    invoiceService.getInvoices().catch(err => {
                        console.error('Failed to load invoices:', err);
                        return [];
                    })
                ]);

                allArtRequests = requests || [];
                allInvoices = invoices || [];

                // Check if we got any data
                if (allArtRequests.length === 0 && allInvoices.length === 0) {
                    showError('No data loaded. The API may be unavailable.');
                } else {
                    // Process and display data
                    updateTabCounts();
                    displayCurrentTab();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data. Please check your connection and try again.');
            } finally {
                hideLoading();
            }
        }

        // Update tab counts
        function updateTabCounts() {
            // Create a map of art requests by ID_Design for quick lookup
            const invoiceMap = new Map();
            allInvoices.forEach(inv => {
                const artRequestId = inv.InvoiceID.replace('ART-', '');
                invoiceMap.set(artRequestId, inv);
            });

            // Count items for each tab
            const counts = {
                'needs-invoice': 0,
                'draft': 0,
                'sent': 0,
                'paid': 0,
                'overdue': 0,
                'all': allInvoices.length
            };

            // Build a map of active invoices (excluding voided/deleted)
            const activeInvoiceMap = new Map();
            allInvoices.forEach(inv => {
                if (inv.Status !== 'Voided' && inv.Status !== 'Cancelled' && !inv.IsDeleted) {
                    const artRequestId = inv.InvoiceID.replace('ART-', '');
                    activeInvoiceMap.set(artRequestId, inv);
                }
            });
            
            // Count art requests that need invoices
            allArtRequests.forEach(req => {
                if (!activeInvoiceMap.has(req.ID_Design)) {
                    counts['needs-invoice']++;
                }
            });

            // Count invoices by status
            allInvoices.forEach(inv => {
                const status = (inv.Status || '').toLowerCase();
                if (status === 'draft') counts.draft++;
                else if (status === 'sent' || status === 'pending') counts.sent++;
                else if (status === 'paid' || status === 'completed') counts.paid++;
                
                // Check if overdue
                if (status !== 'paid' && status !== 'completed' && status !== 'voided') {
                    const dueDate = new Date(inv.DueDate);
                    if (dueDate < new Date()) {
                        counts.overdue++;
                    }
                }
            });

            // Update UI
            document.getElementById('needsInvoiceCount').textContent = counts['needs-invoice'];
            document.getElementById('draftCount').textContent = counts.draft;
            document.getElementById('sentCount').textContent = counts.sent;
            document.getElementById('paidCount').textContent = counts.paid;
            document.getElementById('overdueCount').textContent = counts.overdue;
            document.getElementById('allCount').textContent = counts.all;
        }

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide status filters
            const statusFilters = document.getElementById('statusFilters');
            if (tab === 'needs-invoice') {
                statusFilters.style.display = 'block';
            } else {
                statusFilters.style.display = 'none';
            }
            
            // Display data for current tab
            displayCurrentTab();
        }

        // Handle status filter changes
        function filterStatusChanged() {
            displayCurrentTab();
        }

        // Display data for current tab
        function displayCurrentTab() {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            // Clear existing content
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (currentTab === 'needs-invoice') {
                displayNeedsInvoice();
            } else {
                displayInvoices();
            }
        }

        // Display art requests that need invoices
        function displayNeedsInvoice() {
            const invoiceMap = new Map();
            // Only consider active invoices (exclude voided/deleted)
            allInvoices.forEach(inv => {
                // Skip voided, cancelled, or deleted invoices
                if (inv.Status === 'Voided' || inv.Status === 'Cancelled' || inv.IsDeleted) {
                    console.log(`[Dashboard] Skipping invoice ${inv.InvoiceID} - Status: ${inv.Status}, IsDeleted: ${inv.IsDeleted}`);
                    return;
                }
                const artRequestId = inv.InvoiceID.replace('ART-', '');
                console.log(`[Dashboard] Adding active invoice ${inv.InvoiceID} (Status: ${inv.Status}) to map for art request ${artRequestId}`);
                invoiceMap.set(artRequestId, inv);
            });

            console.log(`[Dashboard] Built invoice map with ${invoiceMap.size} active invoices`);
            console.log(`[Dashboard] Invoice map contents:`, Array.from(invoiceMap.entries()));

            // Filter art requests without invoices
            const needsInvoiceAll = allArtRequests.filter(req => {
                const hasInvoice = invoiceMap.has(req.ID_Design);
                if (!hasInvoice) {
                    console.log(`[Dashboard] Art request ${req.ID_Design} NEEDS invoice - no active invoice found`);
                } else {
                    console.log(`[Dashboard] Art request ${req.ID_Design} HAS invoice - excluding from needs list`);
                }
                return !hasInvoice;
            });
            
            // Deduplicate by ID_Design - keep the most recent record
            const deduplicatedMap = new Map();
            needsInvoiceAll.forEach(req => {
                const existingReq = deduplicatedMap.get(req.ID_Design);
                if (!existingReq) {
                    // First occurrence of this ID_Design
                    deduplicatedMap.set(req.ID_Design, req);
                } else {
                    // Compare dates to keep the most recent
                    const existingDate = new Date(existingReq.Date_Created || 0);
                    const currentDate = new Date(req.Date_Created || 0);
                    
                    // If current record is newer, or if dates are equal but PK_ID is higher, replace
                    if (currentDate > existingDate || 
                        (currentDate.getTime() === existingDate.getTime() && req.PK_ID > existingReq.PK_ID)) {
                        deduplicatedMap.set(req.ID_Design, req);
                    }
                }
            });
            
            // Convert map back to array
            let needsInvoice = Array.from(deduplicatedMap.values());
            
            // Apply status filters with safe element access
            const filterNewEl = safeGetElement('filterNew');
            const filterAwaitingApprovalEl = safeGetElement('filterAwaitingApproval');
            const filterCompletedEl = safeGetElement('filterCompleted');
            
            const filterNew = filterNewEl ? filterNewEl.checked : false;
            const filterAwaitingApproval = filterAwaitingApprovalEl ? filterAwaitingApprovalEl.checked : false;
            const filterCompleted = filterCompletedEl ? filterCompletedEl.checked : true;
            
            needsInvoice = needsInvoice.filter(req => {
                const status = req.Status || '';
                
                if (!status && filterNew) return true;
                if (status === 'Awaiting Approval ðŸŸ£' && filterAwaitingApproval) return true;
                if (status === 'Completed âœ…' && filterCompleted) return true;
                
                return false;
            });
            
            if (needsInvoice.length === 0) {
                showEmptyState();
                return;
            }

            // Set up headers
            const tableHeader = document.getElementById('tableHeader');
            tableHeader.innerHTML = `
                <tr>
                    <th>ID Design</th>
                    <th>Art</th>
                    <th>Company</th>
                    <th>Request Date</th>
                    <th>Status</th>
                    <th>Art Minutes</th>
                    <th>Sales Rep</th>
                    <th>Actions</th>
                </tr>
            `;

            // Display rows
            const tableBody = document.getElementById('tableBody');
            needsInvoice.forEach(req => {
                const row = document.createElement('tr');
                // Calculate age for Awaiting Approval items
                let ageWarning = '';
                let workingDays = 0;
                if (req.Status === 'Awaiting Approval ðŸŸ£') {
                    const createdDate = new Date(req.Date_Created);
                    const now = new Date();
                    workingDays = getWorkingDays(createdDate, now);
                    
                    if (workingDays > 7) {
                        ageWarning = `<span class="age-warning">${workingDays} days old</span>`;
                    }
                }
                
                // Determine status for visual stripe
                const status = req.Status === 'Awaiting Approval ðŸŸ£' ? 'awaiting-approval' : 
                              req.Status === 'Completed âœ…' ? 'ready-to-invoice' : 'new';
                row.setAttribute('data-status', status);
                
                // Create custom status display for items needing invoices
                let statusDisplay = '';
                let statusClass = '';
                let daysWaitingBadge = '';
                
                if (req.Status === 'Completed âœ…') {
                    statusDisplay = '<i class="fas fa-file-invoice"></i> Ready to Invoice';
                    statusClass = 'ready-to-invoice';
                    
                    // Calculate days since completion if Date_Updated is available
                    if (req.Date_Updated) {
                        const completedDate = new Date(req.Date_Updated);
                        const now = new Date();
                        const daysWaiting = Math.floor((now - completedDate) / (1000 * 60 * 60 * 24));
                        if (daysWaiting > 0) {
                            daysWaitingBadge = `<span class="days-waiting-badge" title="Completed ${daysWaiting} day${daysWaiting !== 1 ? 's' : ''} ago">
                                <i class="fas fa-exclamation-triangle"></i> ${daysWaiting}d
                            </span>`;
                        }
                    }
                } else if (req.Status === 'Awaiting Approval ðŸŸ£') {
                    statusDisplay = '<i class="fas fa-clock"></i> ' + req.Status;
                    statusClass = 'awaiting-approval';
                } else {
                    statusDisplay = '<i class="fas fa-star"></i> ' + (req.Status || 'New');
                    statusClass = 'new';
                }
                
                row.innerHTML = `
                    <td><strong>${req.ID_Design || '-'}</strong></td>
                    <td class="artwork-cell">${createArtworkThumbnail(req)}</td>
                    <td>${req.CompanyName || '-'}</td>
                    <td>${formatDate(req.Date_Created)}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusDisplay}
                        </span>
                        ${daysWaitingBadge}
                        ${ageWarning}
                    </td>
                    <td>${req.Art_Minutes || 0} min</td>
                    <td>${getFirstNameFromEmail(req.User_Email) || req.CustomerServiceRep || '-'}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <a href="/calculators/art-invoice-creator.html?id=${req.ID_Design}" class="btn btn-warning btn-sm">
                                <i class="fas fa-file-invoice"></i>
                                Create Invoice
                            </a>
                            ${req.Status === 'Awaiting Approval ðŸŸ£' && workingDays > 7 ? `
                                <button class="btn btn-warning btn-sm" onclick="sendApprovalReminder('${req.ID_Design}', '${req.CompanyName || ''}', '${req.Email_Contact || ''}')">
                                    <i class="fas fa-bell"></i>
                                    Remind
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            showTable();
        }

        // Display invoices based on current tab
        function displayInvoices() {
            let invoices = [...allInvoices];
            
            // Filter by tab
            if (currentTab === 'draft') {
                invoices = invoices.filter(inv => inv.Status === 'Draft');
            } else if (currentTab === 'sent') {
                invoices = invoices.filter(inv => inv.Status === 'Sent' || inv.Status === 'Pending');
            } else if (currentTab === 'paid') {
                invoices = invoices.filter(inv => inv.Status === 'Paid' || inv.Status === 'Completed');
            } else if (currentTab === 'overdue') {
                invoices = invoices.filter(inv => {
                    if (inv.Status === 'Paid' || inv.Status === 'Completed' || inv.Status === 'Voided') return false;
                    const dueDate = new Date(inv.DueDate);
                    return dueDate < new Date();
                });
            }

            if (invoices.length === 0) {
                showEmptyState();
                return;
            }

            // Set up headers
            const tableHeader = document.getElementById('tableHeader');
            // Add checkbox column only for sent/overdue tabs
            const showCheckbox = currentTab === 'sent' || currentTab === 'overdue';
            tableHeader.innerHTML = `
                <tr>
                    ${showCheckbox ? '<th style="width: 40px;"><input type="checkbox" id="selectAllInvoices" onchange="toggleAllInvoices()"></th>' : ''}
                    <th>Invoice ID</th>
                    <th>Art</th>
                    <th>Customer</th>
                    <th>Project</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Due Date</th>
                    <th>Actions</th>
                </tr>
            `;

            // Display rows
            const tableBody = document.getElementById('tableBody');
            
            invoices.forEach(inv => {
                const row = document.createElement('tr');
                const status = getStatusBadge(inv);
                const actions = getQuickActions(inv);
                
                // Set data-status attribute based on invoice status
                let statusAttr = (inv.Status || 'draft').toLowerCase();
                if (statusAttr === 'pending') statusAttr = 'sent';
                if (statusAttr === 'completed') statusAttr = 'paid';
                
                // Check if overdue
                if (statusAttr !== 'paid' && statusAttr !== 'voided') {
                    const dueDate = new Date(inv.DueDate);
                    if (dueDate < new Date()) {
                        statusAttr = 'overdue';
                    }
                }
                
                row.setAttribute('data-status', statusAttr);
                
                // Get artwork for invoice - need to find the related art request
                let artworkThumbnail = '<div class="no-artwork">No artwork</div>';
                if (inv.ArtRequestID) {
                    // Extract the numeric ID from the invoice ID (e.g., "ART-52483" -> "52483")
                    const artRequestId = inv.InvoiceID.replace('ART-', '');
                    
                    // Find the art request by matching ID_Design
                    // Convert both to strings to ensure proper comparison
                    const artRequest = allArtRequests.find(req => 
                        String(req.ID_Design) === String(artRequestId) || 
                        String(req.ID_Design) === String(inv.ArtRequestID)
                    );
                    
                    if (artRequest) {
                        artworkThumbnail = createArtworkThumbnail(artRequest);
                    }
                }
                
                row.innerHTML = `
                    ${showCheckbox ? `<td><input type="checkbox" class="invoice-checkbox" value="${inv.InvoiceID}" data-pk="${inv.PK_ID}"></td>` : ''}
                    <td><strong>${inv.InvoiceID}</strong></td>
                    <td class="artwork-cell">${artworkThumbnail}</td>
                    <td>
                        ${inv.CustomerName || '-'}<br>
                        <small class="text-secondary">${inv.CustomerCompany || ''}</small>
                    </td>
                    <td>${inv.ProjectName || '-'}</td>
                    <td><strong>$${parseFloat(inv.GrandTotal || 0).toFixed(2)}</strong></td>
                    <td>${status}</td>
                    <td>${formatDate(inv.DueDate)}</td>
                    <td>
                        <div class="quick-actions">
                            <button class="btn btn-icon btn-sm" onclick="toggleQuickActions(this)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="quick-actions-menu">
                                ${actions}
                            </div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            showTable();
        }

        // Get status badge HTML
        function getStatusBadge(invoice) {
            const status = invoice.Status || 'Draft';
            const statusClass = status.toLowerCase().replace(' ', '-');
            
            // Check if overdue
            if (status !== 'Paid' && status !== 'Completed' && status !== 'Voided') {
                const dueDate = new Date(invoice.DueDate);
                if (dueDate < new Date()) {
                    const daysOverdue = Math.floor((new Date() - dueDate) / (1000 * 60 * 60 * 24));
                    return `<span class="status-badge overdue">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Overdue${daysOverdue > 0 ? ` (${daysOverdue}d)` : ''}
                    </span>`;
                }
            }
            
            // Add icons based on status
            let icon = '';
            let displayStatus = status;
            let additionalInfo = '';
            
            switch(status.toLowerCase()) {
                case 'draft':
                    icon = '<i class="fas fa-pencil-alt"></i> ';
                    break;
                case 'sent':
                case 'pending':
                    icon = '<i class="fas fa-paper-plane"></i> ';
                    displayStatus = 'Sent';
                    // Add email sent info if available
                    if (invoice.EmailSentDate) {
                        const sentDate = new Date(invoice.EmailSentDate);
                        const daysSent = Math.floor((new Date() - sentDate) / (1000 * 60 * 60 * 24));
                        additionalInfo = `<span class="email-status">
                            <i class="fas fa-clock"></i> ${daysSent}d ago
                        </span>`;
                    }
                    // Add reminder count if available
                    if (invoice.ReminderCount && invoice.ReminderCount > 0) {
                        additionalInfo += `<span class="reminder-count" title="${invoice.ReminderCount} reminder${invoice.ReminderCount !== 1 ? 's' : ''} sent">
                            <i class="fas fa-bell"></i> ${invoice.ReminderCount}
                        </span>`;
                    }
                    break;
                case 'paid':
                case 'completed':
                    icon = '<i class="fas fa-check-circle"></i> ';
                    displayStatus = 'Paid';
                    // Add payment date if available
                    if (invoice.PaymentDate) {
                        const payDate = new Date(invoice.PaymentDate);
                        additionalInfo = `<span class="email-status">
                            <i class="fas fa-calendar-check"></i> ${payDate.toLocaleDateString()}
                        </span>`;
                    }
                    break;
                case 'voided':
                    icon = '<i class="fas fa-ban"></i> ';
                    break;
            }
            
            return `<span class="status-badge ${statusClass}">${icon}${displayStatus}</span>${additionalInfo}`;
        }

        // Get quick actions HTML
        function getQuickActions(invoice) {
            let actions = `
                <a href="/art-invoice-view.html?id=${invoice.InvoiceID}" class="quick-actions-item">
                    <i class="fas fa-eye"></i>
                    View
                </a>
            `;

            if (invoice.Status === 'Draft') {
                actions += `
                    <a href="/calculators/art-invoice-creator.html?edit=${invoice.ArtRequestID}" class="quick-actions-item">
                        <i class="fas fa-edit"></i>
                        Edit
                    </a>
                    <a href="#" onclick="sendInvoice('${invoice.InvoiceID}')" class="quick-actions-item">
                        <i class="fas fa-paper-plane"></i>
                        Send
                    </a>
                `;
            } else if (invoice.Status === 'Sent' || invoice.Status === 'Pending') {
                // Check if invoice has payments - if so, can't revert to draft
                const hasPayments = invoice.PaymentAmount && parseFloat(invoice.PaymentAmount) > 0;
                
                if (!hasPayments) {
                    actions += `
                        <a href="#" onclick="revertToDraft('${invoice.InvoiceID}')" class="quick-actions-item">
                            <i class="fas fa-undo"></i>
                            Revert to Draft
                        </a>
                    `;
                }
                
                actions += `
                    <a href="#" onclick="resendInvoice('${invoice.InvoiceID}')" class="quick-actions-item">
                        <i class="fas fa-envelope"></i>
                        Resend
                    </a>
                    <a href="#" onclick="sendReminder('${invoice.InvoiceID}')" class="quick-actions-item">
                        <i class="fas fa-bell"></i>
                        Send Reminder
                    </a>
                    <a href="#" onclick="markAsPaid('${invoice.InvoiceID}')" class="quick-actions-item">
                        <i class="fas fa-check-circle"></i>
                        Mark Paid
                    </a>
                `;
            }

            if (invoice.Status !== 'Voided' && invoice.Status !== 'Paid') {
                actions += `
                    <a href="#" onclick="voidInvoice('${invoice.InvoiceID}')" class="quick-actions-item">
                        <i class="fas fa-ban"></i>
                        Void
                    </a>
                `;
            }

            return actions;
        }


        // Helper function to extract Order_Type value
        function getOrderType(orderType) {
            if (!orderType) return 'General';
            
            // Handle if it's an object
            if (typeof orderType === 'object') {
                return orderType.value || orderType.name || orderType.text || 'General';
            }
            
            return orderType.toString();
        }

        // Helper function to extract ShopWorks references
        function extractShopworksReferences(notes) {
            if (!notes) return '';
            
            // Look for patterns like SW12345, SW-12345, ShopWorks #12345, etc.
            const patterns = [
                /SW[\s-]?(\d+)/gi,
                /ShopWorks[\s#:]+(\d+)/gi,
                /Order[\s#:]+(\d+)/gi
            ];
            
            const references = new Set();
            patterns.forEach(pattern => {
                const matches = notes.matchAll(pattern);
                for (const match of matches) {
                    references.add(match[0]);
                }
            });
            
            return Array.from(references).join(', ');
        }






        // Send invoice email
        async function sendInvoiceEmail(invoiceId, invoiceData) {
            try {
                // Prepare email data
                const emailData = {
                    to_email: invoiceData.customerEmail,
                    from_name: 'Northwest Custom Apparel',
                    reply_to: invoiceData.salesRepEmail,
                    
                    // Invoice identification
                    invoice_id: invoiceId,
                    invoice_date: new Date().toLocaleDateString(),
                    due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                    
                    // Customer info
                    customer_name: invoiceData.customerName,
                    customer_company: invoiceData.customerCompany || '',
                    customer_email: invoiceData.customerEmail,
                    customer_phone: invoiceData.customerPhone || '',
                    
                    // Project info
                    project_name: invoiceData.projectName || '',
                    id_design: invoiceData.idDesign,
                    order_type: invoiceData.orderType || 'General',
                    
                    // Service details
                    service_code: invoiceData.serviceItems[0].code,
                    service_description: invoiceData.serviceItems[0].description,
                    amount_art_billed: invoiceData.totalCost.toFixed(2),
                    
                    // Additional info
                    art_minutes: invoiceData.artMinutes || 0,
                    shopworks_references: invoiceData.shopworksReferences || 'N/A',
                    notes: invoiceData.customerNotes || '',
                    
                    // Sales rep
                    sales_rep_name: invoiceData.salesRepName,
                    sales_rep_email: invoiceData.salesRepEmail,
                    sales_rep_phone: '253-922-5793',
                    
                    // Company
                    company_phone: '253-922-5793',
                    company_year: '1977',
                    
                    // Artist
                    artist_name: invoiceData.artistName,
                    artist_email: invoiceData.artistEmail
                };

                // Send via EmailJS
                await emailjs.send('service_1c4k67j', 'art_invoice', emailData);
                
                // Mark invoice as sent in database
                await invoiceService.markInvoiceAsSent(invoiceId, invoiceData.customerEmail);
                
                return true;
            } catch (error) {
                console.error('Error sending invoice email:', error);
                // Don't throw - invoice was created successfully
                return false;
            }
        }

        // Show success modal
        function showSuccessModal(invoiceId, emailSent) {
            document.getElementById('successInvoiceId').textContent = invoiceId;
            document.getElementById('successEmailStatus').textContent = 
                emailSent ? 'Email has been sent to the customer.' : 'Invoice saved as draft.';
            document.getElementById('successModal').classList.add('active');
        }

        // Close success modal
        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
        }

        // View invoice from success modal
        function viewInvoice() {
            const invoiceId = document.getElementById('successInvoiceId').textContent;
            window.location.href = `/art-invoice-view.html?id=${invoiceId}`;
        }

        // Create another invoice
        function createAnother() {
            closeSuccessModal();
            // Optionally reset the form or prepare for next invoice
        }

        // Helper functions
        function getSalesRepName(email) {
            const reps = {
                'nika@nwcustomapparel.com': 'Nika Lao',
                'taylar@nwcustomapparel.com': 'Taylar Hanson',
                'ruth@nwcustomapparel.com': 'Ruth Nhong',
                'erik@nwcustomapparel.com': 'Erik Mickelson',
                'adriyella@nwcustomapparel.com': 'Adriyella',
                'bradley@nwcustomapparel.com': 'Bradley Wright',
                'jim@nwcustomapparel.com': 'Jim Mickelson',
                'art@nwcustomapparel.com': 'Steve Deland',
                'sales@nwcustomapparel.com': 'Northwest Custom Apparel Sales Team'
            };
            return reps[email] || 'Northwest Custom Apparel Sales Team';
        }

        // Extract and capitalize first name from email
        function getFirstNameFromEmail(email) {
            if (!email) return '-';
            
            // First check if we have a full name mapping
            const fullName = getSalesRepName(email);
            if (fullName !== 'Northwest Custom Apparel Sales Team') {
                // Extract just the first name from the full name
                return fullName.split(' ')[0];
            }
            
            // Otherwise, extract from email
            const emailParts = email.split('@');
            if (emailParts.length > 0 && emailParts[0]) {
                // Capitalize first letter
                const firstName = emailParts[0];
                return firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
            }
            
            return '-';
        }

        function getSalesRepEmail(name) {
            const emails = {
                'Nika': 'nika@nwcustomapparel.com',
                'Taylar': 'taylar@nwcustomapparel.com',
                'Ruth': 'ruth@nwcustomapparel.com',
                'Erik': 'erik@nwcustomapparel.com',
                'Adriyella': 'adriyella@nwcustomapparel.com',
                'Bradley': 'bradley@nwcustomapparel.com',
                'Jim': 'jim@nwcustomapparel.com',
                'Steve': 'art@nwcustomapparel.com'
            };
            return emails[name] || 'sales@nwcustomapparel.com';
        }

        // Toggle quick actions menu
        function toggleQuickActions(button) {
            const menu = button.nextElementSibling;
            const isOpen = menu.classList.contains('show');
            
            // Close all other menus
            document.querySelectorAll('.quick-actions-menu').forEach(m => m.classList.remove('show'));
            
            // Toggle this menu
            if (!isOpen) {
                menu.classList.add('show');
                
                // Close on click outside
                setTimeout(() => {
                    document.addEventListener('click', closeQuickActions);
                }, 0);
            }
        }

        function closeQuickActions(e) {
            if (!e.target.closest('.quick-actions')) {
                document.querySelectorAll('.quick-actions-menu').forEach(m => m.classList.remove('show'));
                document.removeEventListener('click', closeQuickActions);
            }
        }

        // Search functionality
        function handleSearch(e) {
            e.preventDefault();
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                displayCurrentTab();
                return;
            }

            // Search in current tab data
            // Implementation depends on current tab
            // For now, just filter displayed data
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            displayCurrentTab();
        }

        // UI Helper functions
        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'flex';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }

        function showTable() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
            document.getElementById('emptyState').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function showError(message) {
            console.error(message);
            showNotification(message, 'error');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString();
        }

        function refreshData() {
            loadData();
        }

        function closeQuickInvoiceModal() {
            document.getElementById('quickInvoiceModal').classList.remove('active');
        }

        // Quick action handlers
        async function sendInvoice(invoiceId) {
            if (confirm('Send this invoice to the customer?')) {
                try {
                    // Get invoice details
                    const invoice = allInvoices.find(inv => inv.InvoiceID === invoiceId);
                    if (!invoice) {
                        alert('Invoice not found');
                        return;
                    }

                    // Update status to Sent
                    const updateData = {
                        Status: 'Sent',
                        EmailSentDate: new Date().toISOString(),
                        EmailSentTo: invoice.CustomerEmail
                    };

                    const result = await invoiceService.updateInvoice(invoice.PK_ID, updateData);
                    if (result.success) {
                        alert('Invoice sent successfully!');
                        // In production, this would trigger actual email send
                        loadData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error sending invoice:', error);
                    alert('Failed to send invoice');
                }
            }
        }

        async function resendInvoice(invoiceId) {
            if (confirm('Resend this invoice to the customer?')) {
                try {
                    const invoice = allInvoices.find(inv => inv.InvoiceID === invoiceId);
                    if (!invoice) {
                        alert('Invoice not found');
                        return;
                    }

                    // Update reminder count
                    const reminderCount = parseInt(invoice.ReminderCount || 0) + 1;
                    const updateData = {
                        ReminderCount: reminderCount,
                        LastReminderDate: new Date().toISOString()
                    };

                    const result = await invoiceService.updateInvoice(invoice.PK_ID, updateData);
                    if (result.success) {
                        alert('Invoice resent successfully!');
                        loadData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error resending invoice:', error);
                    alert('Failed to resend invoice');
                }
            }
        }

        async function sendReminder(invoiceId) {
            if (confirm('Send a payment reminder for this invoice?')) {
                try {
                    // Get invoice details
                    const invoice = allInvoices.find(inv => inv.InvoiceID === invoiceId);
                    if (!invoice) {
                        alert('Invoice not found');
                        return;
                    }

                    // Prepare reminder email data
                    const emailData = {
                        to_email: invoice.CustomerEmail,
                        from_name: 'Northwest Custom Apparel',
                        reply_to: invoice.SalesRepEmail || 'sales@nwcustomapparel.com',
                        
                        // Invoice info
                        invoice_id: invoice.InvoiceID,
                        customer_name: invoice.CustomerName,
                        company_name: invoice.CustomerCompany || '',
                        amount_due: parseFloat(invoice.GrandTotal || 0).toFixed(2),
                        due_date: new Date(invoice.DueDate).toLocaleDateString(),
                        days_overdue: Math.max(0, Math.floor((new Date() - new Date(invoice.DueDate)) / (1000 * 60 * 60 * 24))),
                        
                        // Sales rep
                        sales_rep_name: invoice.SalesRepName || 'Northwest Custom Apparel Sales Team',
                        sales_rep_email: invoice.SalesRepEmail || 'sales@nwcustomapparel.com',
                        sales_rep_phone: '253-922-5793',
                        
                        // Company
                        company_phone: '253-922-5793'
                    };

                    // Send reminder via EmailJS
                    try {
                        await emailjs.send('service_1c4k67j', 'art_invoice_reminder', emailData);
                    } catch (emailError) {
                        console.error('EmailJS Error:', emailError);
                        if (emailError.text && emailError.text.includes('template')) {
                            alert('Email template "art_invoice_reminder" not found. Please create it in EmailJS.');
                        } else {
                            alert('Failed to send email reminder. Please check your EmailJS configuration.');
                        }
                        return;
                    }

                    // Update reminder count
                    const reminderCount = parseInt(invoice.ReminderCount || 0) + 1;
                    const updateData = {
                        ReminderCount: reminderCount,
                        LastReminderDate: new Date().toISOString()
                    };

                    const result = await invoiceService.updateInvoice(invoice.PK_ID, updateData);
                    if (result.success) {
                        showNotification('Payment reminder sent successfully!', 'success');
                        loadData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error sending reminder:', error);
                    showNotification('Failed to send reminder. Please try again.', 'error');
                }
            }
        }

        async function markAsPaid(invoiceId) {
            const paymentDate = prompt('Enter payment date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!paymentDate) return;

            const paymentAmount = prompt('Enter payment amount:');
            if (!paymentAmount) return;

            const paymentMethod = prompt('Enter payment method (Check, Credit Card, etc.):');
            if (!paymentMethod) return;

            try {
                const invoice = allInvoices.find(inv => inv.InvoiceID === invoiceId);
                if (!invoice) {
                    alert('Invoice not found');
                    return;
                }

                const updateData = {
                    Status: 'Paid',
                    PaymentDate: paymentDate,
                    PaymentAmount: parseFloat(paymentAmount),
                    PaymentMethod: paymentMethod,
                    BalanceDue: 0
                };

                const result = await invoiceService.updateInvoice(invoice.PK_ID, updateData);
                if (result.success) {
                    alert('Invoice marked as paid!');
                    loadData();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error marking as paid:', error);
                alert('Failed to update invoice status');
            }
        }

        async function revertToDraft(invoiceId) {
            if (!confirm('Are you sure you want to revert this invoice to draft status? This will allow it to be edited again.')) {
                return;
            }

            try {
                showLoading();
                
                const invoice = allInvoices.find(inv => inv.InvoiceID === invoiceId);
                if (!invoice) {
                    alert('Invoice not found');
                    return;
                }

                // Check if invoice has payments
                if (invoice.PaymentAmount && parseFloat(invoice.PaymentAmount) > 0) {
                    alert('Cannot revert invoice to draft - payment has been recorded. Please undo payment first.');
                    return;
                }

                console.log(`[Dashboard] Reverting invoice ${invoiceId} to draft status`);

                const result = await invoiceService.revertToDraft(invoice.PK_ID, 'Dashboard User');
                
                if (result.success) {
                    showNotification('Invoice successfully reverted to draft status!', 'success');
                    loadData(); // Refresh the dashboard
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error reverting invoice to draft:', error);
                showNotification(`Failed to revert invoice: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function voidInvoice(invoiceId) {
            const reason = prompt('Please provide a reason for voiding this invoice:');
            if (!reason) return;

            if (confirm('Are you sure you want to void this invoice? This action cannot be undone.')) {
                try {
                    const invoice = allInvoices.find(inv => inv.InvoiceID === invoiceId);
                    if (!invoice) {
                        alert('Invoice not found');
                        return;
                    }

                    const updateData = {
                        Status: 'Voided',
                        IsDeleted: true,
                        DeletedDate: new Date().toISOString(),
                        DeletedBy: 'Unified Dashboard',
                        Notes: (invoice.Notes || '') + `\n\nVOIDED: ${reason}`
                    };

                    const result = await invoiceService.updateInvoice(invoice.PK_ID, updateData);
                    if (result.success) {
                        alert('Invoice voided successfully!');
                        loadData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Error voiding invoice:', error);
                    alert('Failed to void invoice');
                }
            }
        }

        // Calculate working days between two dates
        function getWorkingDays(startDate, endDate) {
            let count = 0;
            const current = new Date(startDate);
            
            while (current <= endDate) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday or Saturday
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            return count;
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'flex';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }

        // Show table
        function showTable() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
            document.getElementById('emptyState').style.display = 'none';
        }

        // Show empty state
        function showEmptyState() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
        }

        // Show error message
        // Removed duplicate showError function

        // Handle search
        function handleSearch(event) {
            event.preventDefault();
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                displayCurrentTab();
                return;
            }
            
            // Search functionality to be implemented
            console.log('Search for:', searchTerm);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            displayCurrentTab();
        }


        // Send approval reminder for art requests
        async function sendApprovalReminder(idDesign, companyName, customerEmail) {
            if (!customerEmail) {
                alert('No customer email found for this request.');
                return;
            }
            
            if (confirm(`Send approval reminder to ${customerEmail}?`)) {
                try {
                    // Get the full art request details
                    const artRequest = allArtRequests.find(req => req.ID_Design === idDesign);
                    if (!artRequest) {
                        alert('Art request not found');
                        return;
                    }

                    // Calculate days waiting
                    const createdDate = new Date(artRequest.Date_Created);
                    const now = new Date();
                    const daysWaiting = getWorkingDays(createdDate, now);

                    // Prepare email data
                    const emailData = {
                        to_email: customerEmail,
                        from_name: 'Northwest Custom Apparel',
                        reply_to: artRequest.User_Email || 'sales@nwcustomapparel.com',
                        
                        // Art request info
                        id_design: idDesign,
                        company_name: companyName,
                        customer_name: artRequest.Full_Name_Contact || 'Customer',
                        days_waiting: daysWaiting,
                        request_date: formatDate(artRequest.Date_Created),
                        
                        // Artist info
                        artist_name: 'Steve Deland',
                        artist_email: 'art@nwcustomapparel.com',
                        
                        // Sales rep
                        sales_rep_name: getSalesRepName(artRequest.User_Email) || 'Sales Team',
                        sales_rep_email: artRequest.User_Email || 'sales@nwcustomapparel.com',
                        sales_rep_phone: '253-922-5793',
                        
                        // Company
                        company_phone: '253-922-5793'
                    };

                    // Send reminder via EmailJS
                    try {
                        await emailjs.send('service_1c4k67j', 'art_approval_reminder', emailData);
                        showNotification('Approval reminder sent successfully!', 'success');
                    } catch (emailError) {
                        console.error('EmailJS Error:', emailError);
                        if (emailError.text && emailError.text.includes('template')) {
                            alert('Email template "art_approval_reminder" not found. Please create it in EmailJS.');
                        } else {
                            alert('Failed to send approval reminder. Please check your EmailJS configuration.');
                        }
                        return;
                    }
                    
                    // Could update a reminder count in the database here if needed
                    
                } catch (error) {
                    console.error('Error sending approval reminder:', error);
                    showNotification('Failed to send reminder. Please try again.', 'error');
                }
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'};
                border-radius: 4px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1001;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Toggle all invoice checkboxes
        function toggleAllInvoices() {
            const selectAll = document.getElementById('selectAllInvoices');
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActionUI();
        }
        
        // Update UI based on selected invoices
        function updateBulkActionUI() {
            const checkedBoxes = document.querySelectorAll('.invoice-checkbox:checked');
            const bulkActionContainer = document.getElementById('bulkActionContainer');
            
            if (checkedBoxes.length > 0) {
                // Show bulk action button if it doesn't exist
                if (!bulkActionContainer) {
                    const container = document.createElement('div');
                    container.id = 'bulkActionContainer';
                    container.style.cssText = 'margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; gap: 1rem;';
                    container.innerHTML = `
                        <span><strong>${checkedBoxes.length}</strong> invoice(s) selected</span>
                        <button class="btn btn-primary" onclick="markSelectedAsPaid()">
                            <i class="fas fa-check-circle"></i> Mark Selected as Paid
                        </button>
                        <button class="btn btn-secondary" onclick="clearSelection()">
                            Clear Selection
                        </button>
                    `;
                    
                    const tableContainer = document.querySelector('.table-container');
                    tableContainer.parentNode.insertBefore(container, tableContainer);
                } else {
                    // Update count
                    bulkActionContainer.querySelector('span').innerHTML = `<strong>${checkedBoxes.length}</strong> invoice(s) selected`;
                }
            } else {
                // Remove bulk action container
                if (bulkActionContainer) {
                    bulkActionContainer.remove();
                }
            }
        }
        
        // Clear all selections
        function clearSelection() {
            const selectAll = document.getElementById('selectAllInvoices');
            if (selectAll) selectAll.checked = false;
            document.querySelectorAll('.invoice-checkbox').forEach(cb => cb.checked = false);
            updateBulkActionUI();
        }
        
        // Mark selected invoices as paid
        async function markSelectedAsPaid() {
            const checkedBoxes = document.querySelectorAll('.invoice-checkbox:checked');
            if (checkedBoxes.length === 0) return;
            
            const invoiceIds = Array.from(checkedBoxes).map(cb => ({
                invoiceId: cb.value,
                pkId: cb.dataset.pk
            }));
            
            if (!confirm(`Mark ${invoiceIds.length} invoice(s) as paid?`)) return;
            
            const paymentDate = new Date().toISOString().split('T')[0];
            let successCount = 0;
            let failCount = 0;
            
            // Show progress
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: white; padding: 1rem; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000;';
            progressDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing payments...';
            document.body.appendChild(progressDiv);
            
            // Process each invoice
            for (const invoice of invoiceIds) {
                try {
                    const response = await fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/art-invoices/${invoice.pkId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            Status: 'paid',
                            PaymentDate: paymentDate,
                            PaymentMethod: 'Bulk Update',
                            BalanceDue: 0
                        })
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error(`Failed to update invoice ${invoice.invoiceId}`);
                    }
                } catch (error) {
                    failCount++;
                    console.error(`Error updating invoice ${invoice.invoiceId}:`, error);
                }
            }
            
            // Remove progress and show result
            progressDiv.remove();
            
            if (successCount > 0) {
                showNotification(`Successfully marked ${successCount} invoice(s) as paid!`, 'success');
                loadData(); // Reload all data
                clearSelection();
            }
            
            if (failCount > 0) {
                showNotification(`Failed to update ${failCount} invoice(s)`, 'error');
            }
        }
        
        // Add event listener for individual checkboxes
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('invoice-checkbox')) {
                updateBulkActionUI();
                
                // Update select all checkbox state
                const allCheckboxes = document.querySelectorAll('.invoice-checkbox');
                const checkedBoxes = document.querySelectorAll('.invoice-checkbox:checked');
                const selectAll = document.getElementById('selectAllInvoices');
                
                if (selectAll) {
                    selectAll.checked = allCheckboxes.length === checkedBoxes.length && allCheckboxes.length > 0;
                }
            }
        });
        
        // Initialize - Removed duplicate DOMContentLoaded listener
        // The main initialization is already done above at line 1381
    </script>
</body>
</html>