<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Art Invoice Creator - Northwest Custom Apparel</title>
    <link rel="icon" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Art Invoice Service V2 - Using dedicated API endpoints -->
    <script src="art-invoice-service-v2.js?v=2.1"></script>
    
    <style>
        /* Root variables - Professional Invoice Theme */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --bg-color: #ecf0f1;
            --card-bg: #ffffff;
            --border-color: #bdc3c7;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --hover-bg: #f8f9fa;
            --invoice-header-bg: #34495e;
            --invoice-accent: #3498db;
            --table-header-bg: #ecf0f1;
            --table-border: #ddd;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--invoice-header-bg);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            height: 40px;
            filter: brightness(0) invert(1);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255,255,255,0.8);
            font-size: 0.875rem;
        }

        .breadcrumb a {
            color: var(--invoice-accent);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Main Container - Split Layout */
        .main-container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Split Screen Layout */
        .split-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        .form-panel {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .preview-panel {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            position: sticky;
            top: 2rem;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .preview-header {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .preview-content {
            padding: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Mobile responsiveness */
        @media (max-width: 1200px) {
            .split-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .preview-panel {
                position: static;
                max-height: none;
                order: -1;
            }
        }

        /* Invoice Document Style */
        .invoice-document {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .invoice-header-section {
            background: var(--invoice-header-bg);
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .invoice-title h1 {
            font-size: 2rem;
            margin: 0;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .invoice-number {
            text-align: right;
        }

        .invoice-number h2 {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }

        .invoice-number .number {
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Invoice Body */
        .invoice-body {
            padding: 2rem;
        }

        /* Two Column Layout */
        .invoice-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-section h3 {
            font-size: 0.875rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .detail-field {
            margin-bottom: 0.75rem;
        }

        .detail-field label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .detail-field input,
        .detail-field select,
        .detail-field textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .detail-field input:focus,
        .detail-field select:focus,
        .detail-field textarea:focus {
            outline: none;
            border-color: var(--invoice-accent);
        }

        /* Service Table */
        .service-table {
            width: 100%;
            margin: 2rem 0;
            border-collapse: collapse;
        }

        .service-table th {
            background: var(--table-header-bg);
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 600;
            border-bottom: 2px solid var(--table-border);
        }

        .service-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--table-border);
        }

        .service-table .text-right {
            text-align: right;
        }

        .service-table .text-center {
            text-align: center;
        }

        /* Service Line Item */
        .service-line-item {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .service-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.875rem;
        }

        .quantity-input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.875rem;
            text-align: center;
        }

        .line-total {
            font-weight: 600;
            text-align: right;
            min-width: 80px;
        }

        .remove-line-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .remove-line-btn:hover {
            background: #c0392b;
        }

        /* Add Service Button */
        .add-service-btn {
            background: none;
            border: 2px dashed var(--border-color);
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.875rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            margin-top: 1rem;
        }

        .add-service-btn:hover {
            border-color: var(--invoice-accent);
            color: var(--invoice-accent);
            background: var(--hover-bg);
        }

        /* Invoice Totals */
        .invoice-totals {
            margin-left: auto;
            width: 350px;
            margin-top: 2rem;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }

        .total-line.subtotal {
            border-top: 1px solid var(--table-border);
            margin-top: 0.5rem;
            padding-top: 1rem;
        }

        .total-line.grand-total {
            border-top: 2px solid var(--text-primary);
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Tax Section */
        .tax-notice {
            background: #fff8dc;
            border: 1px solid #ffd700;
            padding: 1rem;
            border-radius: 3px;
            margin: 1.5rem 0;
            font-size: 0.875rem;
        }

        .tax-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        /* Notes Section */
        .notes-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .notes-section h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            background: var(--table-header-bg);
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 3px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--invoice-accent);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        /* Art Request Search */
        .search-section {
            background: white;
            padding: 2rem;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .search-header h2 {
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .search-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.875rem;
        }

        /* Enhanced Request Results */
        .request-results {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #f8f9fa;
            padding: 0.5rem;
        }

        /* Date Filter Controls */
        .date-filter-controls {
            background: var(--bg-color);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }
        
        .date-filter-controls .form-control {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            color: var(--text-primary);
            transition: border-color 0.2s;
        }
        
        .date-filter-controls .form-control:focus {
            outline: none;
            border-color: var(--invoice-accent);
        }
        
        /* Search Filters */
        .search-filters {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-btn:hover {
            background: var(--hover-bg);
            border-color: var(--invoice-accent);
        }
        
        .filter-btn.active {
            background: var(--invoice-header-bg);
            color: white;
            border-color: var(--invoice-header-bg);
        }

        /* Enhanced Request Cards */
        .request-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            gap: 1rem;
        }
        
        .request-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: var(--invoice-accent);
        }
        
        .request-card.selected {
            border-color: var(--success-color);
            border-width: 2px;
            background: #f0fff4;
        }
        
        .request-card.invoiced {
            opacity: 0.6;
            background: #f8f9fa;
        }
        
        /* Card Content Area */
        .card-main-content {
            flex: 1;
            min-width: 0;
        }
        
        /* Thumbnail Styles */
        .card-thumbnail {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f5f5;
            flex-shrink: 0;
            position: relative;
            border: 1px solid var(--border-color);
        }
        
        .card-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }
        
        .card-thumbnail:hover img {
            transform: scale(1.05);
        }
        
        .card-thumbnail.no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #999;
            font-size: 0.875rem;
        }
        
        .card-thumbnail.no-image i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }
        
        /* Multiple images indicator */
        .image-count {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .image-count i {
            font-size: 0.625rem;
        }

        /* Card Header with Badges */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .card-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .badge-ready {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-new-request {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-in-progress {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .badge-awaiting {
            background: #e9d5ff;
            color: #6b21a8;
        }
        
        .badge-invoiced {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-rush {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Quick Invoice Button */
        .quick-invoice-btn {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--invoice-accent);
        }
        
        .quick-invoice-btn:hover {
            background: var(--invoice-accent);
            color: white;
        }

        /* Card Body */
        .card-body h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .card-body .customer {
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .card-body .description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        /* Card Footer */
        .card-footer {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding-top: 0.5rem;
            border-top: 1px solid #f3f4f6;
            margin-top: 0.75rem;
        }
        
        .card-footer span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .card-footer i {
            font-size: 0.875rem;
        }

        /* Search Input Enhancement */
        .enhanced-search {
            flex: 1;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            border: 2px solid var(--border-color);
            transition: all 0.2s;
            border-radius: 6px;
        }
        
        .enhanced-search:focus {
            border-color: var(--invoice-accent);
            box-shadow: 0 0 0 3px rgba(52, 73, 94, 0.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        /* Legacy styles for compatibility */
        .request-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .request-item:hover {
            background: var(--hover-bg);
        }

        .request-item.selected {
            background: #e3f2fd;
            border-left: 3px solid var(--invoice-accent);
        }
        
        .request-info {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .request-details {
            flex: 1;
        }
        
        .request-details h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }
        
        .request-details p {
            margin: 0.25rem 0;
            color: var(--text-secondary);
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 3px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--invoice-accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .request-card {
                flex-direction: column;
            }
            
            .card-thumbnail {
                width: 100%;
                height: 200px;
                order: -1; /* Move thumbnail to top on mobile */
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            .header,
            .search-section,
            .action-buttons,
            .add-service-btn,
            .remove-line-btn {
                display: none !important;
            }
            
            .invoice-document {
                box-shadow: none;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .invoice-details-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 1rem;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .invoice-totals {
                width: 100%;
            }
            
            /* Responsive thumbnail styles */
            .request-card {
                flex-direction: column;
            }
            
            .card-thumbnail {
                width: 100%;
                height: 200px;
                margin-bottom: 1rem;
            }
        }

        /* Artwork Modal Styles */
        .artwork-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .artwork-modal.active {
            display: flex;
        }

        .artwork-modal-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .artwork-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .artwork-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
            z-index: 10001;
        }

        .artwork-modal-close:hover {
            color: var(--text-primary);
        }

        .artwork-images-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .modal-artwork-image {
            display: none;
            max-width: 80vw;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 4px;
        }

        .modal-artwork-image.active {
            display: block;
        }

        .artwork-modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 1rem;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.2s;
            z-index: 10001;
        }

        .artwork-modal-nav:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .artwork-modal-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .artwork-modal-prev {
            left: -60px;
        }

        .artwork-modal-next {
            right: -60px;
        }

        .artwork-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 1rem;
        }

        .artwork-modal-indicators {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .artwork-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .artwork-indicator.active {
            background: var(--primary-color);
        }

        .artwork-indicator:hover {
            background: var(--primary-light);
        }

        .artwork-modal-download {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }

        .artwork-modal-download:hover {
            background: var(--primary-dark);
        }

        /* Artwork Thumbnail Enhancements */
        .artwork-thumbnail {
            position: relative;
            cursor: pointer;
        }

        .artwork-thumbnail::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            transition: background 0.2s;
            border-radius: 8px;
            z-index: 1;
        }

        .artwork-thumbnail:hover::before {
            background: rgba(0, 0, 0, 0.3);
        }

        .artwork-thumbnail i {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }

        .artwork-thumbnail:hover i {
            opacity: 1;
        }

        .artwork-count-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 3;
        }

        /* Mobile responsiveness for modal */
        @media (max-width: 768px) {
            .artwork-modal-content {
                max-width: 95vw;
                max-height: 95vh;
                padding: 0.5rem;
            }

            .artwork-modal-nav {
                padding: 0.75rem;
                font-size: 1.25rem;
            }

            .artwork-modal-prev {
                left: -50px;
            }

            .artwork-modal-next {
                right: -50px;
            }

            .modal-artwork-image {
                max-width: 90vw;
                max-height: 75vh;
            }
        }

        /* Professional Invoice Preview Styles */
        .invoice-preview {
            background: white;
            border: 1px solid #ddd;
            font-family: 'Inter', sans-serif;
        }

        .invoice-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #4cb354;
        }

        .invoice-preview-logo {
            max-width: 120px;
            height: auto;
        }

        .invoice-preview-title {
            text-align: right;
        }

        .invoice-preview-title h1 {
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            color: #4cb354;
            font-weight: bold;
        }

        .invoice-preview-title p {
            margin: 0.125rem 0;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .invoice-preview-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .invoice-preview-section {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 0.75rem;
            border-radius: 4px;
        }

        .invoice-preview-section h3 {
            font-size: 0.875rem;
            margin: 0 0 0.5rem 0;
            color: #4cb354;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.25rem;
        }

        .invoice-preview-section p {
            margin: 0.125rem 0;
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .invoice-preview-project {
            grid-column: 1 / -1;
            margin-bottom: 1rem;
        }

        .invoice-preview-project-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .invoice-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.75rem;
        }

        .invoice-preview-table th {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 0.5rem 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-align: left;
        }

        .invoice-preview-table td {
            border: 1px solid #ddd;
            padding: 0.5rem 0.25rem;
            font-size: 0.7rem;
            line-height: 1.2;
        }

        .invoice-preview-totals {
            margin: 1rem 0;
            font-size: 0.75rem;
        }

        .invoice-preview-total-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            line-height: 1.2;
        }

        .invoice-preview-grand-total {
            border-top: 2px solid #4cb354;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .invoice-preview-footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 0.65rem;
            line-height: 1.3;
            color: #666;
        }

        .invoice-preview-empty {
            text-align: center;
            padding: 2rem;
            color: #999;
            font-style: italic;
        }

        .invoice-preview-artwork {
            margin: 1rem 0;
            display: none;
        }

        .invoice-preview-artwork.show {
            display: block;
        }

        .invoice-preview-artwork h3 {
            font-size: 0.875rem;
            margin: 0 0 0.5rem 0;
            color: #4cb354;
            font-weight: bold;
        }

        .invoice-preview-artwork-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .invoice-preview-artwork-item {
            text-align: center;
            padding: 0.5rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .invoice-preview-artwork-item img {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 2px;
            margin-bottom: 0.25rem;
        }

        .invoice-preview-artwork-item label {
            font-size: 0.6rem;
            color: #666;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                     alt="Northwest Custom Apparel" class="logo">
                <nav class="breadcrumb">
                    <a href="/staff-dashboard.html">Staff Dashboard</a>
                    <span>/</span>
                    <a href="/art-invoice-unified-dashboard.html">Art Invoicing</a>
                    <span>/</span>
                    <span>Create Invoice</span>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Split Screen Layout -->
        <div class="split-container">
            <!-- Form Panel -->
            <div class="form-panel">
                <!-- Art Request Selection -->
        <div class="search-section" id="searchSection">
            <div class="search-header">
                <h2>Select Art Request</h2>
                <div id="selectedIndicator" style="display: none;">
                    <span style="color: var(--success-color); font-size: 0.875rem;">
                        <i class="fas fa-check-circle"></i> Request Selected
                    </span>
                </div>
            </div>
            
            <div class="search-controls">
                <input type="text" 
                       id="searchInput" 
                       class="enhanced-search" 
                       placeholder="Search by ID, customer, project, or invoice amount...">
                <button type="button" class="btn btn-secondary" onclick="searchArtRequests()">
                    <i class="fas fa-search"></i>
                    Search
                </button>
            </div>
            
            <div class="date-filter-controls">
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="dateFrom" style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">From:</label>
                        <input type="date" 
                               id="dateFrom" 
                               class="form-control" 
                               value="2025-06-01"
                               style="padding: 0.5rem; font-size: 0.875rem; min-width: 150px;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="dateTo" style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">To:</label>
                        <input type="date" 
                               id="dateTo" 
                               class="form-control"
                               style="padding: 0.5rem; font-size: 0.875rem; min-width: 150px;">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="clearDateFilter()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        <i class="fas fa-times"></i>
                        Clear Dates
                    </button>
                </div>
                <div style="margin-top: 0.5rem;">
                    <span style="font-size: 0.75rem; color: var(--text-secondary); font-style: italic;">
                        <i class="fas fa-info-circle"></i>
                        Default filter shows requests from June 1, 2025 onwards. Clear dates to see all records.
                    </span>
                </div>
            </div>
            
            <div class="search-filters">
                <button class="filter-btn active" data-filter="all" onclick="filterRequests('all')">
                    <i class="fas fa-list"></i> All Uninvoiced
                </button>
                <button class="filter-btn" data-filter="ready" onclick="filterRequests('ready')">
                    <i class="fas fa-check-circle"></i> Ready to Invoice
                </button>
                <button class="filter-btn" data-filter="overdue" onclick="filterRequests('overdue')">
                    <i class="fas fa-exclamation-triangle"></i> Overdue
                </button>
            </div>
            
            <div id="requestResults" class="request-results" style="display: none;">
                <!-- Results will be populated here -->
            </div>
        </div>

        <!-- Invoice Form -->
        <form id="invoiceForm" style="display: none;">
            <div class="invoice-document">
                <!-- Invoice Header -->
                <div class="invoice-header-section">
                    <div class="invoice-title">
                        <h1>ART INVOICE</h1>
                    </div>
                    <div class="invoice-number">
                        <h2>INVOICE NUMBER</h2>
                        <div class="number" id="invoiceNumberDisplay">DRAFT</div>
                    </div>
                </div>

                <!-- Invoice Body -->
                <div class="invoice-body">
                    <!-- Invoice Details Grid -->
                    <div class="invoice-details-grid">
                        <!-- Bill To Section -->
                        <div class="detail-section">
                            <h3>Bill To</h3>
                            <div class="detail-field">
                                <label>Customer Name</label>
                                <input type="text" id="customerName" readonly>
                            </div>
                            <div class="detail-field">
                                <label>Company</label>
                                <input type="text" id="customerCompany" readonly>
                            </div>
                            <div class="detail-field">
                                <label>Email</label>
                                <input type="email" id="customerEmail" readonly>
                            </div>
                            <div class="detail-field">
                                <label>Sales Rep</label>
                                <input type="text" id="salesRepDisplay" readonly>
                            </div>
                        </div>

                        <!-- Invoice Details -->
                        <div class="detail-section">
                            <h3>Invoice Details</h3>
                            <div class="detail-field">
                                <label>Invoice Date</label>
                                <input type="date" id="invoiceDate" value="" readonly>
                            </div>
                            <div class="detail-field">
                                <label>Due Date</label>
                                <input type="date" id="dueDate" value="" readonly>
                            </div>
                            <div class="detail-field">
                                <label>Project Name</label>
                                <input type="text" id="projectName" required>
                            </div>
                            <div class="detail-field">
                                <label>Art Request ID</label>
                                <input type="text" id="artRequestId" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Services Section -->
                    <h3 style="margin: 2rem 0 1rem 0; font-size: 1rem; text-transform: uppercase; color: var(--text-secondary);">
                        Art Services
                    </h3>

                    <table class="service-table">
                        <thead>
                            <tr>
                                <th style="width: 60%">Description</th>
                                <th class="text-center" style="width: 10%">Qty</th>
                                <th class="text-right" style="width: 15%">Rate</th>
                                <th class="text-right" style="width: 15%">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="serviceTableBody">
                            <!-- Service lines will be added here -->
                        </tbody>
                    </table>

                    <!-- Add Service Button -->
                    <button type="button" class="add-service-btn" onclick="addServiceLineItem()">
                        <i class="fas fa-plus-circle"></i>
                        Add Service Line
                    </button>

                    <!-- Totals Section -->
                    <div class="invoice-totals">
                        <div class="total-line">
                            <span>Subtotal:</span>
                            <span id="subtotalDisplay">$0.00</span>
                        </div>
                        
                        <!-- Tax Notice -->
                        <div class="tax-notice">
                            <div class="tax-checkbox">
                                <input type="checkbox" id="applyTax" checked onchange="handleTaxToggle()">
                                <label for="applyTax">Apply WA State Sales Tax (10.20%)</label>
                            </div>
                            <div id="resellerSection" style="display: none;">
                                <input type="text" id="resellerPermit" placeholder="Enter WA reseller permit #" 
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 3px; margin-top: 0.5rem;">
                            </div>
                        </div>
                        
                        <div class="total-line">
                            <span>Tax (10.20%):</span>
                            <span id="taxDisplay">$0.00</span>
                        </div>
                        
                        <div class="total-line grand-total">
                            <span>TOTAL DUE:</span>
                            <span id="grandTotalDisplay">$0.00</span>
                        </div>
                    </div>

                    <!-- Spec Art Credit Section -->
                    <div class="spec-art-section" style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;">
                        <h3 style="margin-bottom: 1rem; color: #495057;">Spec Art & Credits</h3>
                        
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <input type="checkbox" id="isSpecArtwork" onchange="handleSpecArtworkToggle()">
                            <label for="isSpecArtwork" style="margin: 0; font-weight: 500;">This is spec artwork (complimentary)</label>
                        </div>
                        
                        <div id="specArtDetails" style="display: none;">
                            <div class="detail-field" style="margin-bottom: 1rem;">
                                <label>Spec Art Purpose</label>
                                <input type="text" id="specArtPurpose" placeholder="e.g., New customer mockup, design variation, etc." 
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 3px;">
                            </div>
                            
                            <div class="detail-field" style="margin-bottom: 1rem;">
                                <label>Apply Sales Rep Credit</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span>$</span>
                                    <input type="number" id="creditAmount" min="0" max="1000" step="0.01" placeholder="0.00"
                                           style="width: 120px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 3px; text-align: right;"
                                           onchange="calculateTotals()">
                                    <div id="creditInfo" style="font-size: 0.875rem; color: #6c757d;">
                                        Available credit will be shown here
                                    </div>
                                </div>
                            </div>
                            
                            <div id="creditWarning" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem;">
                                <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                                <span style="color: #856404; font-size: 0.875rem;">Credit amount exceeds available balance. Manager approval may be required.</span>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="notes-section">
                        <h3>Notes</h3>
                        <div class="detail-field">
                            <label>Customer Notes (visible on invoice)</label>
                            <textarea id="customerNotes" rows="3" 
                                      placeholder="Enter any notes that should appear on the invoice..."></textarea>
                        </div>
                        <div class="detail-field">
                            <label>Internal Notes (not shown on invoice)</label>
                            <textarea id="internalNotes" rows="3" 
                                      placeholder="Internal notes for reference only..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="saveAsDraft" checked>
                        <label for="saveAsDraft" style="margin: 0;">Save as Draft</label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='/art-invoices-dashboard.html'">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="window.print()">
                            <i class="fas fa-print"></i>
                            Print
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            Create Invoice
                        </button>
                    </div>
                </div>
            </div>
        </form>
            </div>
            <!-- End Form Panel -->

            <!-- Preview Panel -->
            <div class="preview-panel">
                <div class="preview-header">
                    <i class="fas fa-eye"></i>
                    Live Invoice Preview
                </div>
                <div class="preview-content">
                    <div id="invoicePreviewContainer" class="invoice-preview">
                        <div class="invoice-preview-empty">
                            <i class="fas fa-file-invoice"></i>
                            <p>Select an art request to see the invoice preview</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Preview Panel -->
        </div>
        <!-- End Split Container -->
    </main>

    <script>
        // Initialize
        let invoiceService;
        let selectedRequest = null;
        let serviceLineCount = 0;
        
        document.addEventListener('DOMContentLoaded', async function() {
            invoiceService = new ArtInvoiceServiceV2();
            
            // Initialize EmailJS
            emailjs.init('4qSbDO-SQs19TbP80');
            
            // Set default dates
            const today = new Date();
            const dueDate = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days
            
            document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            
            // Parse URL parameters for deep linking
            const urlParams = new URLSearchParams(window.location.search);
            const designIdFromUrl = urlParams.get('id');
            
            if (designIdFromUrl) {
                console.log('Deep link detected - Design ID:', designIdFromUrl);
                
                try {
                    // Show loading state
                    document.getElementById('requestResults').innerHTML = '<div style="padding: 2rem; text-align: center;"><div class="loading"></div><p>Loading art request...</p></div>';
                    document.getElementById('requestResults').style.display = 'block';
                    
                    // Fetch the specific request
                    const requests = await invoiceService.getArtRequests({ id_design: designIdFromUrl });
                    const request = requests.find(r => r.ID_Design == designIdFromUrl);
                    
                    if (request) {
                        console.log('Art request loaded:', request);
                        
                        // Hide the search section
                        document.getElementById('searchSection').style.display = 'none';
                        
                        // Select the request directly
                        await selectRequest(designIdFromUrl, null);
                        
                        // Clear loading state
                        document.getElementById('requestResults').innerHTML = '';
                        document.getElementById('requestResults').style.display = 'none';
                        
                        // Show form section if it's hidden
                        const formSection = document.getElementById('formSection');
                        if (formSection) {
                            formSection.style.display = 'block';
                        }
                        
                        // Update preview
                        if (typeof updateInvoicePreview === 'function') {
                            setTimeout(updateInvoicePreview, 500);
                        }
                    } else {
                        console.error('Art request not found for ID:', designIdFromUrl);
                        showAlert('Art request not found', 'error');
                        // Fall back to search interface
                        searchArtRequests();
                    }
                } catch (error) {
                    console.error('Error loading art request:', error);
                    showAlert('Failed to load art request', 'error');
                    // Fall back to search interface
                    searchArtRequests();
                }
            } else {
                // No deep link - show regular search interface
                searchArtRequests();
            }
            
            // Form submit handler
            document.getElementById('invoiceForm').addEventListener('submit', handleSubmit);
            
            // Add initial service line
            addServiceLineItem();
        });
        
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Helper function to extract order type
        function getOrderType(request) {
            if (!request) return 'General';
            
            let orderType = '';
            
            if (request.Order_Type_1) {
                if (typeof request.Order_Type_1 === 'object') {
                    orderType = request.Order_Type_1.value || request.Order_Type_1.name || request.Order_Type_1.text || JSON.stringify(request.Order_Type_1);
                } else {
                    orderType = request.Order_Type_1;
                }
            } else if (request.Order_Type) {
                if (typeof request.Order_Type === 'object') {
                    orderType = request.Order_Type.value || request.Order_Type.name || request.Order_Type.text || JSON.stringify(request.Order_Type);
                } else {
                    orderType = request.Order_Type;
                }
            }
            
            if (orderType && orderType !== '[object Object]') {
                return orderType;
            }
            
            return 'General';
        }
        
        // Search Art Requests
        async function searchArtRequests() {
            const searchTerm = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('requestResults');
            
            // Show loading
            resultsDiv.innerHTML = '<div style="padding: 2rem; text-align: center;"><div class="loading"></div></div>';
            resultsDiv.style.display = 'block';
            
            try {
                // Get date filter values for API call
                const dateFromInput = document.getElementById('dateFrom').value;
                const dateToInput = document.getElementById('dateTo').value;
                
                // Build API filters
                const apiFilters = {
                    invoiced: false, // Only get uninvoiced requests
                    limit: 500 // Reasonable limit
                };
                
                // Add date filters to API call if available
                if (dateFromInput) {
                    apiFilters.dateCreatedFrom = dateFromInput;
                }
                if (dateToInput) {
                    apiFilters.dateCreatedTo = dateToInput;
                }
                
                console.log('[searchArtRequests] API filters:', apiFilters);
                
                // Fetch art requests with filters
                const requests = await invoiceService.getArtRequests(apiFilters);
                
                // Debug: Log first 2 requests to see data structure
                console.log('[searchArtRequests] Sample requests:', requests.slice(0, 2));
                
                // Filter requests (API already filtered by date and invoiced status)
                let filteredRequests = requests.filter(req => {
                    // Include all statuses: NULL (new), Awaiting Approval , and Completed 
                    // We'll show them all and let user see the full workflow
                    
                    // Basic validation - API should have already filtered most of this
                    return req.Date_Created && req.ID_Design;
                });
                
                // Further filter based on search term
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredRequests = filteredRequests.filter(req => 
                        (req.ID_Design && req.ID_Design.toString().includes(term)) ||
                        (req.CompanyName && req.CompanyName.toLowerCase().includes(term)) ||
                        (req.NOTES && req.NOTES.toLowerCase().includes(term)) ||
                        (req.Note_Mockup && req.Note_Mockup.toLowerCase().includes(term)) ||
                        (req.Full_Name_Contact && req.Full_Name_Contact.toLowerCase().includes(term))
                    );
                }
                
                // Remove duplicates based on ID_Design
                const uniqueRequests = [];
                const seenIds = new Set();
                filteredRequests.forEach(req => {
                    if (!seenIds.has(req.ID_Design)) {
                        seenIds.add(req.ID_Design);
                        uniqueRequests.push(req);
                    }
                });
                
                // Sort by date, newest first
                uniqueRequests.sort((a, b) => new Date(b.Date_Created) - new Date(a.Date_Created));
                
                // Display results
                if (uniqueRequests.length === 0) {
                    const dateMessage = dateFromInput ? `from ${new Date(dateFromInput).toLocaleDateString()}` : '';
                    const toMessage = dateToInput ? ` to ${new Date(dateToInput).toLocaleDateString()}` : '';
                    resultsDiv.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No uninvoiced art requests found ${dateMessage}${toMessage}.</div>`;
                } else {
                    // Store all requests for filtering
                    window.allRequests = uniqueRequests;
                    displayFilteredRequests(uniqueRequests);
                }
            } catch (error) {
                console.error('Error searching requests:', error);
                resultsDiv.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--danger-color);">Error loading requests</div>';
            }
        }
        
        // Artwork Helper Functions (matching working dashboard)
        function hasArtwork(cdnLink) {
            return cdnLink && cdnLink.includes('/Artwork/') && cdnLink !== 'https://cdn.caspio.com/A0E15000';
        }

        function getFirstArtwork(artRequest) {
            const cdnFields = ['CDN_Link', 'CDN_Link_Two', 'CDN_Link_Three', 'CDN_Link_Four'];
            
            for (const field of cdnFields) {
                if (hasArtwork(artRequest[field])) {
                    return artRequest[field];
                }
            }
            return null;
        }

        function getAllArtworks(artRequest) {
            const cdnFields = ['CDN_Link', 'CDN_Link_Two', 'CDN_Link_Three', 'CDN_Link_Four'];
            const artworks = [];
            
            cdnFields.forEach((field, index) => {
                if (hasArtwork(artRequest[field])) {
                    artworks.push({
                        url: artRequest[field],
                        label: `Artwork ${index + 1}`
                    });
                }
            });
            
            return artworks;
        }
        
        function createArtworkThumbnail(artRequest) {
            const artworkUrl = getFirstArtwork(artRequest);
            
            if (!artworkUrl) {
                return `
                    <div class="card-thumbnail no-image">
                        <i class="fas fa-image"></i>
                        <span>No artwork</span>
                    </div>
                `;
            }
            
            // Count total artwork files
            const artworkCount = getAllArtworks(artRequest).length;
            const countBadge = artworkCount > 1 ? `<span class="artwork-count-badge">+${artworkCount - 1}</span>` : '';
            
            return `
                <div class="card-thumbnail artwork-thumbnail" onclick='showArtworkModal(${JSON.stringify(artRequest).replace(/'/g, "&#39;")})' style="position: relative; cursor: pointer;">
                    <img src="${artworkUrl}" 
                         alt="Artwork ${artRequest.ID_Design}" 
                         onload="this.classList.add('loaded')"
                         onerror="this.parentElement.innerHTML='<div class=\\'card-thumbnail no-image\\'><i class=\\'fas fa-exclamation-triangle\\'></i><span>Failed to load</span></div>'"
                         loading="lazy">
                    <i class="fas fa-search-plus"></i>
                    ${countBadge}
                </div>
            `;
        }

        // Alias for compatibility
        function generateThumbnailHTML(request) {
            return createArtworkThumbnail(request);
        }

        // Modal Gallery System
        let currentArtworkIndex = 0;
        let currentArtworks = [];
        let currentDesignId = null;

        function showArtworkModal(artRequest) {
            let modal = document.getElementById('artworkModal');
            if (!modal) {
                modal = createArtworkModal();
            }
            
            // Get all artworks for this request
            currentArtworks = getAllArtworks(artRequest);
            currentDesignId = artRequest.ID_Design;
            currentArtworkIndex = 0;
            
            if (currentArtworks.length === 0) {
                return;
            }
            
            // Update modal for gallery view
            updateArtworkModalContent();
            modal.classList.add('active');
        }

        function updateArtworkModalContent() {
            const modal = document.getElementById('artworkModal');
            const modalTitle = modal.querySelector('.artwork-modal-title');
            
            // Update title with counter
            if (currentArtworks.length > 1) {
                modalTitle.textContent = `Design #${currentDesignId} - ${currentArtworkIndex + 1} of ${currentArtworks.length}`;
            } else {
                modalTitle.textContent = `Design #${currentDesignId}`;
            }
            
            // Update images
            const images = modal.querySelectorAll('.modal-artwork-image');
            images.forEach((img, index) => {
                if (index < currentArtworks.length && index === currentArtworkIndex) {
                    img.src = currentArtworks[index].url;
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
            
            // Update navigation buttons visibility
            const prevBtn = modal.querySelector('.artwork-modal-prev');
            const nextBtn = modal.querySelector('.artwork-modal-next');
            if (currentArtworks.length > 1) {
                if (prevBtn) {
                    prevBtn.style.display = 'block';
                    prevBtn.disabled = currentArtworkIndex === 0;
                }
                if (nextBtn) {
                    nextBtn.style.display = 'block';
                    nextBtn.disabled = currentArtworkIndex === currentArtworks.length - 1;
                }
            } else {
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            }
            
            // Update indicators
            const indicators = modal.querySelectorAll('.artwork-indicator');
            const indicatorsContainer = modal.querySelector('.artwork-modal-indicators');
            
            indicators.forEach((indicator, index) => {
                if (index < currentArtworks.length) {
                    indicator.style.display = 'block';
                    if (index === currentArtworkIndex) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                } else {
                    indicator.style.display = 'none';
                }
            });
            
            // Hide indicators container if only one image
            if (indicatorsContainer) {
                indicatorsContainer.style.display = currentArtworks.length > 1 ? 'flex' : 'none';
            }
        }

        function navigateArtwork(direction) {
            if (direction === 'prev' && currentArtworkIndex > 0) {
                currentArtworkIndex--;
            } else if (direction === 'next' && currentArtworkIndex < currentArtworks.length - 1) {
                currentArtworkIndex++;
            }
            updateArtworkModalContent();
        }

        function setArtworkIndex(index) {
            if (index >= 0 && index < currentArtworks.length) {
                currentArtworkIndex = index;
                updateArtworkModalContent();
            }
        }

        function createArtworkModal() {
            const modal = document.createElement('div');
            modal.id = 'artworkModal';
            modal.className = 'artwork-modal';
            
            let modalContent = `
                <div class="artwork-modal-content">
                    <span class="artwork-modal-title"></span>
                    <button class="artwork-modal-close" onclick="closeArtworkModal()"></button>
                    
                    <!-- Navigation buttons -->
                    <button class="artwork-modal-nav artwork-modal-prev" onclick="navigateArtwork('prev')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="artwork-modal-nav artwork-modal-next" onclick="navigateArtwork('next')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <!-- Images container -->
                    <div class="artwork-images-container">`;
            
            // Create placeholders for up to 4 images
            for (let i = 0; i < 4; i++) {
                modalContent += `<img class="modal-artwork-image" src="" alt="Artwork ${i + 1}">`;
            }
            
            modalContent += `
                    </div>
                    
                    <!-- Footer with indicators and download -->
                    <div class="artwork-modal-footer">
                        <div class="artwork-modal-indicators">`;
            
            // Create indicators
            for (let i = 0; i < 4; i++) {
                modalContent += `<span class="artwork-indicator" onclick="setArtworkIndex(${i})"></span>`;
            }
            
            modalContent += `
                        </div>
                        <button class="artwork-modal-download" onclick="downloadCurrentArtwork()">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeArtworkModal();
                }
            });
            
            return modal;
        }

        function closeArtworkModal() {
            const modal = document.getElementById('artworkModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function downloadCurrentArtwork() {
            if (currentArtworks.length === 0 || currentArtworkIndex < 0) return;
            
            const artwork = currentArtworks[currentArtworkIndex];
            const link = document.createElement('a');
            link.href = artwork.url;
            link.download = `Design_${currentDesignId}_${artwork.label.replace(' ', '_')}.png`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Display filtered requests with enhanced card UI
        function displayFilteredRequests(requests) {
            const resultsDiv = document.getElementById('requestResults');
            
            if (requests.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                        <h3>No Requests Found</h3>
                        <p>Try adjusting your filters or search criteria</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="request-list">';
            
            // Debug: Log first request to see field names
            if (requests.length > 0) {
                console.log('[displayFilteredRequests] First request object:', requests[0]);
                console.log('[displayFilteredRequests] Field names:', Object.keys(requests[0]));
            }
            
            requests.forEach(req => {
                const status = getRequestStatus(req);
                const orderType = getOrderType(req);
                const timeSpent = req.Art_Minutes ? `${req.Art_Minutes} min` : 'Not tracked';
                const isInvoiced = req.Invoiced || false;
                const daysSinceCreated = Math.floor((new Date() - new Date(req.Date_Created)) / (1000 * 60 * 60 * 24));
                
                // Determine badges based on status
                let badges = '';
                
                // Primary status badges
                if (status === 'New') {
                    badges += '<span class="badge badge-new-request">New Request</span>';
                } else if (status === 'In Progress') {
                    badges += '<span class="badge badge-in-progress">In Progress</span>';
                } else if (status === 'Awaiting Approval') {
                    badges += '<span class="badge badge-awaiting">Awaiting Approval</span>';
                } else if (status === 'Completed ' && !isInvoiced) {
                    badges += '<span class="badge badge-ready">Ready to Invoice</span>';
                }
                
                // Secondary badges
                if (isInvoiced) {
                    badges += '<span class="badge badge-invoiced">Invoiced</span>';
                }
                if (req.Priority === 'High' || req.RUSH) {
                    badges += '<span class="badge badge-rush">Rush</span>';
                }
                
                html += `
                    <div class="request-card ${isInvoiced ? 'invoiced' : ''}" onclick="selectRequest('${req.ID_Design}', event)">
                        <div class="card-main-content">
                            <div class="card-header">
                                <div class="card-title">
                                    <h3>${req.CompanyName || 'No Company'} - Design #${req.ID_Design}</h3>
                                    <div class="badges">${badges}</div>
                                </div>
                                <div class="card-meta">
                                    <span><i class="fas fa-calendar"></i> ${formatDate(req.Date_Created)}</span>
                                    <span class="status-badge status-${status.toLowerCase().replace(/\s+/g, '-')}">${status}</span>
                                </div>
                            </div>
                            
                            <div class="card-body">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>Contact:</label>
                                        <span>${req.Full_Name_Contact || 'Unknown'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Sales Rep:</label>
                                        <span>${getSalesRepFirstName(req.User_Email) || 'Unassigned'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Order Type:</label>
                                        <span>${orderType}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Time Spent:</label>
                                        <span>${timeSpent}</span>
                                    </div>
                                </div>
                                
                                ${req.NOTES ? `
                                    <div class="card-description">
                                        <label>Description:</label>
                                        <p>${req.NOTES.substring(0, 150)}${req.NOTES.length > 150 ? '...' : ''}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="card-footer">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); selectRequest('${req.ID_Design}', event)">
                                    <i class="fas fa-file-invoice"></i> Create Invoice
                                </button>
                            </div>
                        </div>
                        
                        ${generateThumbnailHTML(req)}
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        // Get request status
        function getRequestStatus(request) {
            if (!request.Status) return 'New';
            
            const status = request.Status.toString().trim();
            if (status === 'Awaiting Approval ') return 'Awaiting Approval';
            if (status === 'Completed ') return 'Completed ';
            if (status === 'In Progress') return 'In Progress';
            
            return status || 'New';
        }
        
        // Filter requests
        function filterRequests(filterType) {
            if (!window.allRequests) return;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let filtered = [...window.allRequests];
            
            switch(filterType) {
                case 'ready':
                    filtered = filtered.filter(req => 
                        getRequestStatus(req) === 'Completed ' && !req.Invoiced
                    );
                    break;
                    
                case 'overdue':
                    const fourteenDaysAgo = new Date();
                    fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);
                    filtered = filtered.filter(req => 
                        new Date(req.Date_Created) < fourteenDaysAgo && 
                        getRequestStatus(req) === 'Completed '
                    );
                    break;
                    
                case 'all':
                default:
                    // Show all requests
                    break;
            }
            
            displayFilteredRequests(filtered);
        }
        
        // Select Art Request
        async function selectRequest(idDesign, event) {
            try {
                // Fetch the specific request
                const requests = await invoiceService.getArtRequests({ id_design: idDesign });
                const request = requests.find(r => r.ID_Design == idDesign);
                
                if (!request) {
                    showAlert('Request not found', 'error');
                    return;
                }
                
                // Check if invoice already exists
                const existingInvoice = await invoiceService.checkExistingInvoice(idDesign);
                if (existingInvoice) {
                    showAlert(`An invoice already exists for this request (${existingInvoice.InvoiceID}). Please void it first.`, 'error');
                    return;
                }
                
                selectedRequest = request;
                
                // Update UI to show selection
                document.querySelectorAll('.request-card').forEach(card => {
                    card.classList.remove('selected');
                });
                const selectedCard = event.target.closest('.request-card');
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
                
                // Show selected indicator
                document.getElementById('selectedIndicator').style.display = 'block';
                
                // Use the new populateInvoiceForm function with intelligent defaults
                populateInvoiceForm(request);
                
            } catch (error) {
                console.error('Error selecting request:', error);
                showAlert('Error loading request details', 'error');
            }
        }
        
        // Helper function to get sales rep first name from email
        function getSalesRepFirstName(email) {
            if (!email) return null;
            
            // Extract the part before @ 
            const username = email.split('@')[0];
            
            // Capitalize first letter
            return username.charAt(0).toUpperCase() + username.slice(1);
        }
        
        // Helper function to get sales rep name from email
        function getSalesRepName(repEmail) {
            const repNames = {
                'nika@nwcustomapparel.com': 'Nika Lao',
                'taylar@nwcustomapparel.com': 'Taylar Hanson',
                'ruth@nwcustomapparel.com': 'Ruth Nhong',
                'erik@nwcustomapparel.com': 'Erik Mickelson',
                'adriyella@nwcustomapparel.com': 'Adriyella',
                'bradley@nwcustomapparel.com': 'Bradley Wright',
                'jim@nwcustomapparel.com': 'Jim Mickelson',
                'art@nwcustomapparel.com': 'Steve Deland',
                'sales@nwcustomapparel.com': 'Northwest Custom Apparel Sales Team'
            };
            return repNames[repEmail] || 'Northwest Custom Apparel Sales Team';
        }
        
        // Helper function to get sales rep email from name
        function getSalesRepEmail(repName) {
            const repEmails = {
                'Nika Lao': 'nika@nwcustomapparel.com',
                'Nika': 'nika@nwcustomapparel.com',
                'Taylar': 'taylar@nwcustomapparel.com',
                'Taylar Hanson': 'taylar@nwcustomapparel.com',
                'Ruth Nhong': 'ruth@nwcustomapparel.com',
                'Ruth': 'ruth@nwcustomapparel.com',
                'Ruthie': 'ruth@nwcustomapparel.com',
                'Erik Mickelson': 'erik@nwcustomapparel.com',
                'Erik': 'erik@nwcustomapparel.com',
                'Adriyella': 'adriyella@nwcustomapparel.com',
                'Bradley Wright': 'bradley@nwcustomapparel.com',
                'Bradley': 'bradley@nwcustomapparel.com',
                'Jim Mickelson': 'jim@nwcustomapparel.com',
                'Jim': 'jim@nwcustomapparel.com',
                'Steve Deland': 'art@nwcustomapparel.com',
                'Steve': 'art@nwcustomapparel.com'
            };
            return repEmails[repName] || 'sales@nwcustomapparel.com';
        }
        
        // Data cleaning helper functions
        
        /**
         * Clean project name from raw notes/internal data
         * @param {string} rawText - Raw text from NOTES or Note_Mockup fields
         * @returns {string} Clean, professional project name
         */
        function cleanProjectName(rawText) {
            if (!rawText) return '';
            
            // Remove common internal prefixes/patterns
            let cleaned = rawText
                .replace(/^(mockup|mock up|mock-up|proof|sample|test|draft)[\s:-]*/i, '')
                .replace(/^(rush|urgent|asap|priority)[\s:-]*/i, '')
                .replace(/^(reorder|re-order|repeat|redo)[\s:-]*/i, '');
            
            // Remove file extensions
            cleaned = cleaned.replace(/\.(jpg|jpeg|png|pdf|ai|eps|psd|svg|gif|bmp|tiff?)$/i, '');
            
            // Remove paths
            cleaned = cleaned.replace(/^.*[\\\/]/, '');
            
            // Remove special characters and clean up spacing
            cleaned = cleaned
                .replace(/[_-]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            // Capitalize first letter of each word
            cleaned = cleaned.replace(/\b\w/g, l => l.toUpperCase());
            
            // Limit length for cleanliness
            if (cleaned.length > 100) {
                cleaned = cleaned.substring(0, 97) + '...';
            }
            
            return cleaned || 'Design Project';
        }
        
        /**
         * Infer service codes based on art request data
         * @param {Object} request - Art request object
         * @returns {Array} Array of suggested service codes with reasons
         */
        function inferServiceCodes(request) {
            const suggestions = [];
            
            // Check art minutes for primary service code
            if (request.Art_Minutes) {
                const minutes = parseInt(request.Art_Minutes);
                const suggestedCode = invoiceService.suggestServiceCode(minutes);
                if (suggestedCode && suggestedCode !== 'CUSTOM') {
                    suggestions.push({
                        code: suggestedCode,
                        reason: `Based on ${minutes} minutes of art time`,
                        primary: true
                    });
                }
            }
            
            // Check for mockup indication
            const notes = (request.NOTES || '').toLowerCase();
            const noteMockup = (request.Note_Mockup || '').toLowerCase();
            const allText = notes + ' ' + noteMockup;
            
            if (request.Mockup === 'Yes' || request.Mockup === true || 
                allText.includes('mockup') || allText.includes('mock up')) {
                suggestions.push({
                    code: 'V-MOCK',
                    reason: 'Mockup requested',
                    primary: false
                });
            }
            
            // Check for digitizing indication
            if (allText.includes('digitiz') || allText.includes('embroidery') || 
                allText.includes('stitch') || allText.includes('dst')) {
                suggestions.push({
                    code: 'DIGIT',
                    reason: 'Digitizing work detected',
                    primary: false
                });
            }
            
            // Check for rush indication
            if (allText.includes('rush') || allText.includes('urgent') || 
                allText.includes('asap') || allText.includes('priority')) {
                // Find the primary suggestion and suggest its rush version
                const primarySuggestion = suggestions.find(s => s.primary);
                if (primarySuggestion) {
                    const rushCode = primarySuggestion.code + '-R';
                    suggestions.push({
                        code: rushCode,
                        reason: 'Rush service indicated',
                        primary: false
                    });
                }
            }
            
            // Check for vector/redraw work
            if (allText.includes('vector') || allText.includes('redraw') || 
                allText.includes('recreate') || allText.includes('trace')) {
                suggestions.push({
                    code: 'GRT-75',
                    reason: 'Vector/redraw work indicated',
                    primary: !suggestions.some(s => s.primary)
                });
            }
            
            return suggestions;
        }
        
        /**
         * Populate invoice form with cleaned and intelligent defaults
         * @param {Object} request - Art request object
         */
        function populateInvoiceForm(request) {
            // Clean and set project name
            const projectName = cleanProjectName(request.NOTES || request.Note_Mockup || '');
            document.getElementById('projectName').value = projectName;
            
            // Set customer information
            document.getElementById('customerName').value = request.Full_Name_Contact || '';
            document.getElementById('customerCompany').value = request.CompanyName || '';
            document.getElementById('customerEmail').value = request.Email_Contact || request.Email || '';
            document.getElementById('artRequestId').value = request.ID_Design || '';
            
            // Get and display sales rep
            const salesRepEmail = request.User_Email || 'sales@nwcustomapparel.com';
            const salesRepName = getSalesRepName(salesRepEmail);
            document.getElementById('salesRepDisplay').value = `${salesRepName} (${salesRepEmail})`;
            
            // Show invoice number
            const invoiceId = invoiceService.generateInvoiceID(request.ID_Design);
            document.getElementById('invoiceNumberDisplay').textContent = invoiceId;
            
            // Get service code suggestions
            const suggestions = inferServiceCodes(request);
            
            // Apply primary suggestion to first service line
            const primarySuggestion = suggestions.find(s => s.primary);
            if (primarySuggestion) {
                const firstSelect = document.querySelector('.service-select');
                if (firstSelect) {
                    firstSelect.value = primarySuggestion.code;
                    updateServiceLine(firstSelect);
                }
            }
            
            // Add additional suggested services
            suggestions.filter(s => !s.primary).forEach((suggestion, index) => {
                if (index === 0 && document.querySelectorAll('.service-line').length === 1) {
                    // If only one line exists and it's filled, add a new line
                    addServiceLineItem();
                }
                
                const serviceLines = document.querySelectorAll('.service-line');
                const targetLine = serviceLines[serviceLines.length - 1];
                const select = targetLine.querySelector('.service-select');
                
                if (select && !select.value) {
                    select.value = suggestion.code;
                    updateServiceLine(select);
                }
            });
            
            // Show the invoice form
            document.getElementById('invoiceForm').style.display = 'block';
            
            // Scroll to invoice
            document.getElementById('invoiceForm').scrollIntoView({ behavior: 'smooth' });
            
            // Update preview
            updateInvoicePreview();
        }
        
        // Add Service Line Item
        function addServiceLineItem() {
            serviceLineCount++;
            const tbody = document.getElementById('serviceTableBody');
            
            // Get all available service codes
            const serviceCodes = invoiceService.getAllServiceCodes(false); // Don't include rush versions in dropdown
            
            const row = document.createElement('tr');
            row.className = 'service-line';
            row.innerHTML = `
                <td>
                    <select class="service-select" onchange="updateServiceLine(this)" style="width: 100%;">
                        <option value="">-- Select Service --</option>
                        ${serviceCodes.filter(s => !s.isAdditional).map(service => 
                            `<option value="${service.code}" data-amount="${service.amount}">${service.code} - ${service.name} ($${service.amount})</option>`
                        ).join('')}
                        <optgroup label="Additional Services">
                            ${serviceCodes.filter(s => s.isAdditional).map(service => 
                                `<option value="${service.code}" data-amount="${service.amount}">${service.code} - ${service.name} ($${service.amount})</option>`
                            ).join('')}
                        </optgroup>
                        <option value="CUSTOM">Custom Service (Enter Amount)</option>
                    </select>
                    <input type="text" class="service-description" placeholder="Enter description..." 
                           style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 3px; font-size: 0.875rem; display: none;">
                </td>
                <td class="text-center">
                    <input type="number" class="quantity-input" value="1" min="1" onchange="updateServiceLine(this)">
                </td>
                <td class="text-right">
                    <span class="rate-display">$0.00</span>
                    <input type="number" class="custom-rate" placeholder="0.00" step="0.01" min="0" 
                           style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 3px; font-size: 0.875rem; text-align: right; display: none;"
                           onchange="updateServiceLine(this)">
                </td>
                <td class="text-right">
                    <span class="line-total">$0.00</span>
                    ${serviceLineCount > 1 ? '<button type="button" class="remove-line-btn" onclick="removeServiceLine(this)" style="margin-left: 1rem;"><i class="fas fa-trash"></i></button>' : ''}
                </td>
            `;
            
            tbody.appendChild(row);
        }
        
        // Update Service Line
        function updateServiceLine(element) {
            const row = element.closest('tr');
            const serviceSelect = row.querySelector('.service-select');
            const descriptionInput = row.querySelector('.service-description');
            const quantityInput = row.querySelector('.quantity-input');
            const rateDisplay = row.querySelector('.rate-display');
            const customRateInput = row.querySelector('.custom-rate');
            const lineTotalSpan = row.querySelector('.line-total');
            
            const selectedCode = serviceSelect.value;
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (selectedCode === 'CUSTOM') {
                // Show custom inputs
                descriptionInput.style.display = 'block';
                rateDisplay.style.display = 'none';
                customRateInput.style.display = 'inline-block';
                
                const customRate = parseFloat(customRateInput.value) || 0;
                const total = customRate * quantity;
                lineTotalSpan.textContent = `$${total.toFixed(2)}`;
                
            } else if (selectedCode) {
                // Get service details
                const service = invoiceService.getServiceByCode(selectedCode);
                if (service) {
                    descriptionInput.style.display = 'block';
                    descriptionInput.value = service.description;
                    rateDisplay.style.display = 'inline';
                    customRateInput.style.display = 'none';
                    
                    const rate = service.amount;
                    rateDisplay.textContent = `$${rate.toFixed(2)}`;
                    
                    const total = rate * quantity;
                    lineTotalSpan.textContent = `$${total.toFixed(2)}`;
                }
            } else {
                // No service selected
                descriptionInput.style.display = 'none';
                rateDisplay.style.display = 'inline';
                customRateInput.style.display = 'none';
                rateDisplay.textContent = '$0.00';
                lineTotalSpan.textContent = '$0.00';
            }
            
            // Update totals
            calculateTotals();
        }
        
        // Remove Service Line
        function removeServiceLine(button) {
            const row = button.closest('tr');
            row.remove();
            serviceLineCount--;
            calculateTotals();
        }
        
        // Calculate Totals
        function calculateTotals() {
            let subtotal = 0;
            
            // Calculate service lines total
            document.querySelectorAll('.service-line').forEach(row => {
                const totalText = row.querySelector('.line-total').textContent;
                const total = parseFloat(totalText.replace('$', '')) || 0;
                subtotal += total;
            });
            
            // Calculate tax
            const applyTax = document.getElementById('applyTax').checked;
            const taxRate = 0.102; // 10.20%
            const taxAmount = applyTax ? subtotal * taxRate : 0;
            const grandTotal = subtotal + taxAmount;
            
            // Update displays
            document.getElementById('subtotalDisplay').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('taxDisplay').textContent = `$${taxAmount.toFixed(2)}`;
            document.getElementById('grandTotalDisplay').textContent = `$${grandTotal.toFixed(2)}`;
        }
        
        // Handle Tax Toggle
        function handleTaxToggle() {
            const applyTax = document.getElementById('applyTax').checked;
            const resellerSection = document.getElementById('resellerSection');
            
            if (!applyTax) {
                resellerSection.style.display = 'block';
            } else {
                resellerSection.style.display = 'none';
                document.getElementById('resellerPermit').value = '';
            }
            
            calculateTotals();
        }

        // Handle Spec Artwork Toggle
        function handleSpecArtworkToggle() {
            const isSpec = document.getElementById('isSpecArtwork').checked;
            const specDetails = document.getElementById('specArtDetails');
            const creditAmount = document.getElementById('creditAmount');
            
            if (isSpec) {
                specDetails.style.display = 'block';
                // Set credit amount to the current subtotal by default
                const subtotalText = document.getElementById('subtotalDisplay').textContent;
                const subtotal = parseFloat(subtotalText.replace('$', '')) || 0;
                creditAmount.value = subtotal.toFixed(2);
                
                // Update credit info
                updateCreditInfo();
            } else {
                specDetails.style.display = 'none';
                creditAmount.value = '';
            }
            
            calculateTotals();
        }

        // Get Service Items from form
        function getServiceItems() {
            const serviceRows = document.querySelectorAll('.service-line');
            const items = [];
            
            serviceRows.forEach((row, index) => {
                const serviceSelect = row.querySelector('.service-select');
                const quantityInput = row.querySelector('.quantity-input');
                const customRate = row.querySelector('.custom-rate');
                const lineTotal = row.querySelector('.line-total');
                
                if (serviceSelect && serviceSelect.value) {
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    items.push({
                        serviceCode: serviceSelect.value,
                        description: selectedOption ? selectedOption.textContent : serviceSelect.value,
                        quantity: parseFloat(quantityInput?.value || 1),
                        rate: parseFloat(customRate?.value || 0),
                        amount: parseFloat(lineTotal?.textContent.replace('$', '') || 0),
                        lineNumber: index + 1
                    });
                }
            });
            
            return items;
        }

        // Update credit availability info (placeholder for future implementation)
        function updateCreditInfo() {
            const creditInfo = document.getElementById('creditInfo');
            const salesRepEmail = selectedRequest?.User_Email || 'sales@nwcustomapparel.com';
            const salesRepName = getSalesRepName(salesRepEmail);
            
            // For now, show static message - can be enhanced later with real credit tracking
            creditInfo.textContent = `Sales rep: ${salesRepName} (Credit tracking coming soon)`;
        }
        
        // Show Alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            alertContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Handle Form Submit
        async function handleSubmit(e) {
            e.preventDefault();
            
            if (!selectedRequest) {
                showAlert('Please select an art request first', 'error');
                return;
            }
            
            // Validate reseller permit if tax exempt
            if (!document.getElementById('applyTax').checked) {
                const permit = document.getElementById('resellerPermit').value.trim();
                if (!permit) {
                    showAlert('Reseller permit number is required for tax exemption', 'error');
                    return;
                }
            }
            
            // Gather service items
            const serviceItems = [];
            let hasValidService = false;
            
            document.querySelectorAll('.service-line').forEach(row => {
                const serviceSelect = row.querySelector('.service-select');
                const descriptionInput = row.querySelector('.service-description');
                const quantityInput = row.querySelector('.quantity-input');
                const customRateInput = row.querySelector('.custom-rate');
                const lineTotalText = row.querySelector('.line-total').textContent;
                
                const code = serviceSelect.value;
                if (code) {
                    hasValidService = true;
                    const quantity = parseInt(quantityInput.value) || 1;
                    const total = parseFloat(lineTotalText.replace('$', '')) || 0;
                    
                    if (code === 'CUSTOM') {
                        serviceItems.push({
                            code: 'CUSTOM',
                            description: descriptionInput.value || 'Custom Art Service',
                            quantity: quantity,
                            rate: parseFloat(customRateInput.value) || 0,
                            amount: total
                        });
                    } else {
                        const service = invoiceService.getServiceByCode(code);
                        serviceItems.push({
                            code: code,
                            description: descriptionInput.value || service.description,
                            quantity: quantity,
                            rate: service.amount,
                            amount: total
                        });
                    }
                }
            });
            
            if (!hasValidService) {
                showAlert('Please add at least one service', 'error');
                return;
            }
            
            // Calculate totals
            const subtotal = serviceItems.reduce((sum, item) => sum + item.amount, 0);
            const applyTax = document.getElementById('applyTax').checked;
            const taxAmount = applyTax ? subtotal * 0.102 : 0;
            const grandTotal = subtotal + taxAmount;
            
            // Get sales rep info
            const salesRepEmail = selectedRequest.User_Email || 'sales@nwcustomapparel.com';
            const salesRepName = getSalesRepName(salesRepEmail);
            
            // Prepare invoice data
            const invoiceData = {
                idDesign: selectedRequest.ID_Design,
                
                // Customer info
                customerName: document.getElementById('customerName').value,
                customerCompany: document.getElementById('customerCompany').value,
                customerEmail: document.getElementById('customerEmail').value,
                
                // Sales rep info
                salesRepName: salesRepName,
                salesRepEmail: salesRepEmail,
                
                // Project info
                projectName: document.getElementById('projectName').value,
                originalRequestDate: selectedRequest.Date_Created,
                completionDate: new Date(),
                
                // Service items (as object for processing)
                serviceItems: serviceItems,
                serviceSummary: serviceItems.map(item => `${item.code}: ${item.description}`).join('; '),
                
                // Amounts
                subtotalAmount: subtotal,
                rushFee: 0, // Not used in service code model
                revisionFee: 0, // Not used in service code model
                otherFees: 0, // Not used in service code model
                taxAmount: taxAmount,
                totalCost: grandTotal,
                
                // Notes
                customerNotes: document.getElementById('customerNotes').value,
                notes: document.getElementById('internalNotes').value,
                
                // Status
                status: document.getElementById('saveAsDraft').checked ? 'Draft' : 'Sent',
                
                // Spec Art Credit Fields
                isSpecArtwork: document.getElementById('isSpecArtwork').checked,
                creditApplied: parseFloat(document.getElementById('creditAmount').value) || 0,
                specArtPurpose: document.getElementById('specArtPurpose').value.trim(),
                
                // Additional fields
                artistName: 'Steve Deland',
                artistEmail: 'art@nwcustomapparel.com',
                ccEmails: 'erik@nwcustomapparel.com',
                createdBy: salesRepName
            };
            
            // Get submit button reference
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                // Show loading
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                submitBtn.disabled = true;
                
                // Log the invoice data for debugging
                console.log('Invoice data being sent:', invoiceData);
                
                // Create invoice
                const result = await invoiceService.createInvoice(invoiceData);
                
                if (result.success) {
                    showAlert(`Invoice ${result.invoiceID} created successfully!`, 'success');
                    
                    // Redirect to invoice view
                    setTimeout(() => {
                        window.location.href = `/art-invoice-view.html?id=${result.invoiceID}`;
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to create invoice');
                }
                
            } catch (error) {
                console.error('Error creating invoice:', error);
                showAlert(error.message || 'Failed to create invoice', 'error');
                
                // Restore button
                if (submitBtn) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }
        }

        // Live Preview Functions
        function updateInvoicePreview() {
            const previewContainer = document.getElementById('invoicePreviewContainer');
            
            if (!selectedRequest) {
                previewContainer.innerHTML = `
                    <div class="invoice-preview-empty">
                        <i class="fas fa-file-invoice"></i>
                        <p>Select an art request to see the invoice preview</p>
                    </div>
                `;
                return;
            }

            // Get form values
            const customerName = document.getElementById('customerName').value || 'Customer Name';
            const customerCompany = document.getElementById('customerCompany').value || '';
            const customerEmail = document.getElementById('customerEmail').value || 'customer@email.com';
            const projectName = document.getElementById('projectName').value || selectedRequest.NOTES || 'Project Name';
            const projectType = document.getElementById('projectType').value || 'Design Work';
            const complexity = document.getElementById('complexity').value || 'Standard';
            const artistName = 'Steve Deland';
            const requestDate = selectedRequest.Date_Created ? new Date(selectedRequest.Date_Created).toLocaleDateString() : 'N/A';
            const completionDate = new Date().toLocaleDateString();
            
            // Get service items and calculate totals
            const serviceItems = getServiceItems();
            const subtotal = serviceItems.reduce((sum, item) => sum + item.amount, 0);
            const applyTax = document.getElementById('applyTax').checked;
            const taxAmount = applyTax ? subtotal * 0.102 : 0;
            const grandTotal = subtotal + taxAmount;
            
            // Generate invoice ID preview
            const now = new Date();
            const invoiceDate = now.toLocaleDateString();
            const dueDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString();
            const invoiceId = `ART-${selectedRequest.ID_Design}`;
            
            // Build the preview HTML
            previewContainer.innerHTML = `
                <!-- Invoice Header -->
                <div class="invoice-preview-header">
                    <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                         alt="Northwest Custom Apparel" class="invoice-preview-logo">
                    <div class="invoice-preview-title">
                        <h1>ART INVOICE</h1>
                        <p><strong>Invoice ID:</strong> ${invoiceId}</p>
                        <p><strong>Date:</strong> ${invoiceDate}</p>
                        <p><strong>Due Date:</strong> ${dueDate}</p>
                    </div>
                </div>

                <!-- Invoice Details -->
                <div class="invoice-preview-details">
                    <div class="invoice-preview-section">
                        <h3>Bill To</h3>
                        <p><strong>Northwest Custom Apparel</strong></p>
                        <p>2025 Freeman Road East</p>
                        <p>Milton, WA 98354</p>
                    </div>
                    
                    <div class="invoice-preview-section">
                        <h3>Customer</h3>
                        <p><strong>${customerName}</strong></p>
                        ${customerCompany ? `<p>${customerCompany}</p>` : ''}
                        <p>${customerEmail}</p>
                    </div>
                </div>

                <!-- Project Info -->
                <div class="invoice-preview-section invoice-preview-project">
                    <h3>Project Details</h3>
                    <div class="invoice-preview-project-grid">
                        <div>
                            <p><strong>Project:</strong> ${projectName}</p>
                            <p><strong>Type:</strong> ${projectType}</p>
                            <p><strong>Complexity:</strong> ${complexity}</p>
                        </div>
                        <div>
                            <p><strong>Request Date:</strong> ${requestDate}</p>
                            <p><strong>Completion Date:</strong> ${completionDate}</p>
                            <p><strong>Artist:</strong> ${artistName}</p>
                        </div>
                    </div>
                </div>

                <!-- Service Items Table -->
                <table class="invoice-preview-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th style="text-align: right;">Qty</th>
                            <th style="text-align: right;">Rate</th>
                            <th style="text-align: right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${serviceItems.length > 0 ? serviceItems.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td style="text-align: right;">${item.quantity}</td>
                                <td style="text-align: right;">$${item.rate.toFixed(2)}</td>
                                <td style="text-align: right;">$${item.amount.toFixed(2)}</td>
                            </tr>
                        `).join('') : `
                            <tr>
                                <td colspan="4" style="text-align: center; color: #999; font-style: italic;">
                                    No service items added yet
                                </td>
                            </tr>
                        `}
                    </tbody>
                </table>

                <!-- Invoice Totals -->
                <div class="invoice-preview-totals">
                    <div class="invoice-preview-total-row">
                        <span>Subtotal:</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    ${applyTax ? `
                        <div class="invoice-preview-total-row">
                            <span>WA State Sales Tax (10.20%):</span>
                            <span>$${taxAmount.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="invoice-preview-total-row invoice-preview-grand-total">
                        <span>Total Due:</span>
                        <span>$${grandTotal.toFixed(2)}</span>
                    </div>
                </div>

                ${generateArtworkPreview(selectedRequest)}

                <!-- Footer -->
                <div class="invoice-preview-footer">
                    <p>Payment due within 30 days</p>
                    <p>Please reference Invoice ID: <strong>${invoiceId}</strong> with payment</p>
                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">
                    <p><strong>Northwest Custom Apparel</strong></p>
                    <p>Family Owned & Operated Since 1977</p>
                    <p>Phone: 253-922-5793 | Email: sales@nwcustomapparel.com</p>
                </div>
            `;
        }

        function generateArtworkPreview(artRequest) {
            const artworks = getAllArtworks(artRequest);
            if (artworks.length === 0) {
                return '';
            }

            return `
                <div class="invoice-preview-artwork show">
                    <h3>Artwork</h3>
                    <div class="invoice-preview-artwork-grid">
                        ${artworks.map(artwork => `
                            <div class="invoice-preview-artwork-item">
                                <img src="${artwork.url}" alt="${artwork.label}" loading="lazy">
                                <label>${artwork.label}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Add event listeners for real-time updates
        function initializePreviewUpdates() {
            // Update preview when form fields change
            const formFields = [
                'customerName', 'customerCompany', 'customerEmail',
                'projectName', 'projectType', 'complexity', 'applyTax'
            ];
            
            formFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', updateInvoicePreview);
                    element.addEventListener('change', updateInvoicePreview);
                }
            });
            
            // Update preview when service items change
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('service-select') || 
                    e.target.classList.contains('quantity-input') ||
                    e.target.classList.contains('custom-rate') ||
                    e.target.classList.contains('add-service-btn') ||
                    e.target.classList.contains('remove-line-btn')) {
                    setTimeout(updateInvoicePreview, 100); // Small delay to let DOM update
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('service-select') || 
                    e.target.classList.contains('quantity-input') ||
                    e.target.classList.contains('custom-rate')) {
                    updateInvoicePreview();
                }
            });
        }

        // Override the existing selectRequest function to update preview
        const originalSelectRequest = window.selectRequest;
        window.selectRequest = async function(idDesign, event) {
            // Call the original function with correct parameters
            if (originalSelectRequest) {
                await originalSelectRequest.call(this, idDesign, event);
            } else {
                // Fallback implementation
                try {
                    // Fetch the specific request
                    const requests = await invoiceService.getArtRequests({ id_design: idDesign });
                    const request = requests.find(r => r.ID_Design == idDesign);
                    
                    if (!request) {
                        showAlert('Request not found', 'error');
                        return;
                    }
                    
                    selectedRequest = request;
                    showInvoiceForm();
                    populateInvoiceForm(request);
                } catch (error) {
                    console.error('Error in selectRequest fallback:', error);
                    showAlert('Failed to select request', 'error');
                }
            }
            // Update preview after selection
            setTimeout(updateInvoicePreview, 100);
        };
        
        // Clear date filter function
        function clearDateFilter() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            // Re-run search to show all results
            searchArtRequests();
        }

        // Initialize preview updates when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Art Invoice Creator] Page loaded, initializing...');
            setTimeout(initializePreviewUpdates, 1000); // Wait for other initializations
            
            // Set default date values
            const today = new Date();
            const in30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            const invoiceDateInput = document.getElementById('invoiceDate');
            const dueDateInput = document.getElementById('dueDate');
            const dateFromInput = document.getElementById('dateFrom');
            
            if (invoiceDateInput) {
                invoiceDateInput.value = today.toISOString().split('T')[0];
            }
            if (dueDateInput) {
                dueDateInput.value = in30Days.toISOString().split('T')[0];
            }
            
            // Verify date filter elements exist
            if (dateFromInput) {
                console.log('[Art Invoice Creator] Date filter elements found, default value:', dateFromInput.value);
            } else {
                console.error('[Art Invoice Creator] Date filter elements not found!');
            }
            
            // Automatically run search with default date filter on page load
            setTimeout(() => {
                console.log('[Art Invoice Creator] Running initial search...');
                searchArtRequests();
            }, 500); // Small delay to ensure everything is loaded
        });
    </script>
</body>
</html>