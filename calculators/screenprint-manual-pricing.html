<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Manual Screen Print Pricing Calculator - Northwest Custom Apparel</title>
    <link rel="icon" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- Shared Calculator Styles -->
    <link href="manual-calculator-styles.css" rel="stylesheet">
    
    <style>
        /* Screen Print-specific styles */
        /* Location sections */
        .location-section {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .location-header {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .color-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .safety-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .safety-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #ff6b35;
        }

        .safety-label {
            color: #ff6b35;
            font-weight: 600;
        }

        /* Add location button */
        .add-location-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .add-location-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .add-location-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Location rows */
        .location-row {
            display: grid;
            grid-template-columns: 180px 140px 40px;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        /* Setup breakdown */
        .setup-section {
            background: #f0f7f3;
            border: 1px solid #d4e8d4;
            padding: 1.25rem;
            border-radius: 8px;
            margin-top: 1.25rem;
        }

        .setup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .setup-title {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .setup-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .setup-breakdown {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.8;
        }

        .setup-item {
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0;
            border-bottom: 1px solid rgba(212, 232, 212, 0.5);
        }

        .setup-item:last-child {
            border-bottom: none;
        }

        /* Order summary */
        .summary-table {
            width: 100%;
            margin-top: 1.25rem;
        }

        .summary-table td {
            padding: 0.625rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .summary-value {
            text-align: right;
            font-weight: 600;
        }

        .summary-divider {
            border-top: 2px solid var(--primary-color);
            margin-top: 0.625rem;
            padding-top: 0.625rem;
        }

        .summary-total {
            font-size: 1.15rem;
            color: var(--primary-color);
        }

        /* Tier info */
        .tier-info {
            background: #e7f5e7;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.25rem;
            text-align: center;
            font-size: 0.95rem;
        }

        .tier-label {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Price display adjustments */
        .price-section {
            text-align: center;
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, #f8fafb 0%, #f0f4f6 100%);
            border-radius: 12px;
            margin-bottom: 1.25rem;
        }

        .price-display {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
            line-height: 1;
        }

        .price-label {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .price-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .main-content {
                margin-top: 1rem;
            }
            
            .card {
                margin-bottom: 1rem;
                padding: 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .location-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .location-grid {
                grid-template-columns: 1fr;
            }

            .remove-btn {
                width: 100%;
                margin-top: 0.5rem;
            }

            .price-display {
                font-size: 2.5rem;
            }
            
            .setup-section {
                padding: 1rem;
            }
            
            .order-summary-section {
                padding: 1rem;
            }
            
            .breadcrumb {
                font-size: 0.75rem;
            }
            
            .feature-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .feature-buttons .btn {
                width: 100%;
            }
        }

        /* Loading state */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Debug mode indicator */
        .debug-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff6b35;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }

        /* Blank cost input improvements */
        .blank-cost-section {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .blank-cost-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .blank-cost-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .blank-cost-help {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .blank-cost-example {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(76, 179, 84, 0.05);
            border-radius: 4px;
            border: 1px dashed rgba(76, 179, 84, 0.2);
        }

        /* Pricing details toggle */
        .pricing-details-toggle {
            margin-top: 0.5rem;
            text-align: center;
        }

        .toggle-details-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: underline;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .toggle-details-btn:hover {
            color: var(--primary-dark);
        }

        .pricing-details {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(76, 179, 84, 0.05);
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .pricing-details.show {
            display: block;
        }

        /* Improved order summary */
        .order-summary-section {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .order-summary-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .order-line-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .order-line-item:last-child {
            border-bottom: none;
        }

        .subtotal-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 2px solid var(--border-color);
        }

        .grand-total-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 3px double var(--primary-color);
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Improved additional location grid */
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .location-card {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            position: relative;
        }

        .location-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .location-card-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .remove-location-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .remove-location-btn:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        /* Fallback data notice */
        .fallback-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 0.75rem 1rem;
            text-align: center;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .fallback-notice i {
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                     alt="Northwest Custom Apparel" class="logo">
                <nav class="breadcrumb">
                    <a href="/staff-dashboard.html">Dashboard</a>
                    <span>/</span>
                    <span>Manual Screen Print Pricing</span>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <div class="calculator-title text-center">
            <h1>Manual Screen Print Pricing Calculator</h1>
            <p>Calculate pricing for screen printing on customer-supplied items</p>
        </div>

        <!-- Calculator Grid -->
        <div class="calculator-grid">
            <!-- Input Section -->
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-palette" style="color: var(--primary-color);"></i>
                    Screen Print Details
                </h2>

                <div class="form-group">
                    <label class="form-label">Quantity <span class="required">*</span></label>
                    <input type="number" class="form-control" id="quantity" value="48" min="1" required>
                    <div class="help-text">Minimum order quantity is 24 pieces</div>
                </div>

                <div class="blank-cost-section">
                    <div class="blank-cost-header">
                        <label for="blankCost" class="blank-cost-title">
                            <i class="fas fa-tshirt"></i> Manual Blank Cost ($)
                        </label>
                        <span class="blank-cost-help">Required</span>
                    </div>
                    <input type="number" class="form-control" id="blankCost" value="3.41" min="0" step="0.01" required>
                    <div class="blank-cost-example">
                        <strong>Common Examples:</strong> PC61 = $3.41 | PC54 = $4.50 | G500 = $4.75
                    </div>
                </div>

                <!-- Front Location -->
                <div class="location-section">
                    <div class="location-header">Front Location (Primary)</div>
                    
                    <div class="form-group">
                        <label class="form-label">Number of Colors</label>
                        <select class="form-control" id="frontColors">
                            <option value="0">No Print</option>
                            <option value="1" selected>1 Color</option>
                            <option value="2">2 Colors</option>
                            <option value="3">3 Colors</option>
                            <option value="4">4 Colors</option>
                            <option value="5">5 Colors</option>
                            <option value="6">6 Colors</option>
                        </select>
                    </div>

                    <div class="safety-checkbox">
                        <input type="checkbox" id="frontSafety">
                        <label for="frontSafety" class="safety-label">Add Safety Stripes (+$2.00)</label>
                    </div>
                </div>

                <!-- Dark Garment Option -->
                <div class="form-group" style="margin-top: 1rem; padding: 1rem; background: var(--bg-color); border-radius: 6px;">
                    <div class="safety-checkbox">
                        <input type="checkbox" id="darkGarment">
                        <label for="darkGarment" style="font-weight: 600;">
                            <i class="fas fa-fill-drip" style="color: #666;"></i>
                            Dark garment (needs white underbase)
                        </label>
                    </div>
                    <div class="help-text" style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        Adds 1 color per location for white underbase ink
                    </div>
                </div>

                <!-- Additional Locations -->
                <div class="form-group">
                    <button class="add-location-btn" id="addLocationBtn">
                        <i class="fas fa-plus"></i> Add Location
                    </button>
                    <span class="help-text" style="margin-left: 0.75rem">Max 3 additional locations</span>
                </div>

                <div id="additionalLocations"></div>
            </div>

            <!-- Results Section -->
            <div class="card">
                <div class="results-section">
                    <div class="results-header">
                        <h3 class="card-title">Your Quote</h3>
                        <div class="price-section">
                            <div class="price-display" id="priceDisplay">$0.00</div>
                            <div class="price-label">per shirt</div>
                            <div class="price-subtitle" id="priceSubtitle">Enter details to see pricing</div>
                            <div class="pricing-details-toggle">
                                <button class="toggle-details-btn" onclick="togglePricingDetails()">
                                    <i class="fas fa-info-circle"></i> Show calculation details
                                </button>
                            </div>
                            <div class="pricing-details" id="pricingDetails"></div>
                        </div>
                    </div>

                    <div id="tierInfo" class="tier-info" style="display: none;">
                        <span class="tier-label">Current Tier: </span>
                        <span id="tierLabel"></span>
                    </div>

                    <div id="ltmWarning" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle alert-icon"></i>
                        <div>
                            <strong>Less Than Minimum Fee Applied</strong><br>
                            A $50.00 fee has been added for orders under 48 pieces
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary-section">
                        <h4 class="order-summary-title">Order Summary</h4>
                        <div class="order-line-item">
                            <span class="summary-label">Blank Garment</span>
                            <span class="summary-value" id="summaryBlank">$0.00</span>
                        </div>
                        <div class="order-line-item">
                            <span class="summary-label">Screen Printing</span>
                            <span class="summary-value" id="summaryPrint">$0.00</span>
                        </div>
                        <div class="subtotal-section">
                            <div class="order-line-item">
                                <span class="summary-label">Subtotal</span>
                                <span class="summary-value" id="subtotalAmount">$0.00</span>
                            </div>
                        </div>
                        <div class="grand-total-section">
                            <div class="order-line-item">
                                <span class="summary-label">Total Per Shirt</span>
                                <span class="summary-value" id="summaryTotal">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Setup Fee Breakdown -->
                    <div id="setupSection" class="setup-section" style="display: none;">
                        <div class="setup-header">
                            <span class="setup-title">One-Time Setup Fees</span>
                            <span class="setup-total" id="setupTotal">$0.00</span>
                        </div>
                        <div class="setup-breakdown" id="setupBreakdown"></div>
                    </div>

                    <!-- Future Features -->
                    <div class="feature-buttons mt-4">
                        <button class="btn btn-secondary" disabled title="Feature coming soon">
                            <i class="fas fa-envelope"></i>
                            Email Quote
                        </button>
                        <button class="btn btn-secondary" disabled title="Feature coming soon">
                            <i class="fas fa-print"></i>
                            Print
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Section -->
        <div class="card">
            <h3 class="card-title">
                <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                About Manual Screen Print Pricing
            </h3>
            <div class="alert alert-info">
                <i class="fas fa-lightbulb alert-icon"></i>
                <div>
                    <p><strong>How It Works:</strong></p>
                    <p>This calculator uses the same pricing logic as the automated screen print pricing page, but allows you to input manual garment costs. Use the same cost as your product (e.g., PC61 = $3.41) to verify pricing consistency between manual and automated calculations.</p>
                    <p class="mt-2">
                        <strong>Includes:</strong> Blank garment with margin + Screen printing costs + Setup fees per color per location.<br>
                        <strong>Pricing Tiers:</strong> Automatic quantity-based discounts apply (same as automated version).<br>
                        <strong>LTM Fee:</strong> $50 fee applies for orders under 48 pieces (updated to match automated version).<br>
                        <strong>Safety Stripes:</strong> Add $2.00 per location when safety stripes are selected.
                    </p>
                    <p class="mt-2" style="background: #e8f5e8; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem;">
                        <strong>🔗 Comparison Test:</strong> Set cost to $3.41 and compare results with 
                        <a href="/pricing/screen-print?StyleNumber=PC61&COLOR=Deep%20Marine" target="_blank" style="color: var(--primary-color);">automated PC61 pricing</a>
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const urlParams = new URLSearchParams(window.location.search);
        const DEBUG_MODE = urlParams.get('debug') === 'true';
        const API_URL = 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/pricing-bundle?method=ScreenPrint&styleNumber=';
        const CACHE_KEY = 'screenprint_manual_pricing_data';
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // Fallback data for when API is unavailable
        const FALLBACK_DATA = {
            version: "2025-01-14",
            lastUpdated: "January 14, 2025",
            notice: "Using offline pricing data",
            tiersR: [
                {
                    "PK_ID": 13,
                    "TierID": 13,
                    "DecorationMethod": "ScreenPrint",
                    "TierLabel": "13-36",
                    "MinQuantity": 13,
                    "MaxQuantity": 36,
                    "MarginDenominator": 0.45,
                    "TargetMargin": 0,
                    "LTM_Fee": 50
                },
                {
                    "PK_ID": 14,
                    "TierID": 14,
                    "DecorationMethod": "ScreenPrint",
                    "TierLabel": "37-72",
                    "MinQuantity": 37,
                    "MaxQuantity": 72,
                    "MarginDenominator": 0.5,
                    "TargetMargin": 0,
                    "LTM_Fee": 0
                },
                {
                    "PK_ID": 15,
                    "TierID": 15,
                    "DecorationMethod": "ScreenPrint",
                    "TierLabel": "73-144",
                    "MinQuantity": 73,
                    "MaxQuantity": 144,
                    "MarginDenominator": 0.55,
                    "TargetMargin": 0,
                    "LTM_Fee": 0
                },
                {
                    "PK_ID": 16,
                    "TierID": 16,
                    "DecorationMethod": "ScreenPrint",
                    "TierLabel": "145-576",
                    "MinQuantity": 145,
                    "MaxQuantity": 576,
                    "MarginDenominator": 0.6,
                    "TargetMargin": 0,
                    "LTM_Fee": 0
                }
            ],
            rulesR: {
                "RoundingMethod": "HalfDollarCeil_Final",
                "FlashCharge": "0.35",
                "SetupFeePerColor": "30"
            },
            locations: [
                {
                    "code": "LC",
                    "name": "Left Chest"
                },
                {
                    "code": "FB",
                    "name": "Full Back"
                }
            ],
            allScreenprintCostsR: [
                {"PK_ID": 1, "ScreenPrintCostID": 1, "CostType": "PrimaryLocation", "TierLabel": "13-36", "ColorCount": 1, "BasePrintCost": 2.35},
                {"PK_ID": 2, "ScreenPrintCostID": 2, "CostType": "PrimaryLocation", "TierLabel": "13-36", "ColorCount": 2, "BasePrintCost": 2.85},
                {"PK_ID": 3, "ScreenPrintCostID": 3, "CostType": "PrimaryLocation", "TierLabel": "13-36", "ColorCount": 3, "BasePrintCost": 3.15},
                {"PK_ID": 4, "ScreenPrintCostID": 4, "CostType": "PrimaryLocation", "TierLabel": "13-36", "ColorCount": 4, "BasePrintCost": 3.45},
                {"PK_ID": 5, "ScreenPrintCostID": 5, "CostType": "PrimaryLocation", "TierLabel": "13-36", "ColorCount": 5, "BasePrintCost": 3.7},
                {"PK_ID": 6, "ScreenPrintCostID": 6, "CostType": "PrimaryLocation", "TierLabel": "13-36", "ColorCount": 6, "BasePrintCost": 3.95},
                {"PK_ID": 7, "ScreenPrintCostID": 7, "CostType": "PrimaryLocation", "TierLabel": "37-72", "ColorCount": 1, "BasePrintCost": 2.05},
                {"PK_ID": 8, "ScreenPrintCostID": 8, "CostType": "PrimaryLocation", "TierLabel": "37-72", "ColorCount": 2, "BasePrintCost": 2.15},
                {"PK_ID": 9, "ScreenPrintCostID": 9, "CostType": "PrimaryLocation", "TierLabel": "37-72", "ColorCount": 3, "BasePrintCost": 2.35},
                {"PK_ID": 10, "ScreenPrintCostID": 10, "CostType": "PrimaryLocation", "TierLabel": "37-72", "ColorCount": 4, "BasePrintCost": 2.55},
                {"PK_ID": 11, "ScreenPrintCostID": 11, "CostType": "PrimaryLocation", "TierLabel": "37-72", "ColorCount": 5, "BasePrintCost": 2.75},
                {"PK_ID": 12, "ScreenPrintCostID": 12, "CostType": "PrimaryLocation", "TierLabel": "37-72", "ColorCount": 6, "BasePrintCost": 2.9},
                {"PK_ID": 13, "ScreenPrintCostID": 13, "CostType": "PrimaryLocation", "TierLabel": "73-144", "ColorCount": 1, "BasePrintCost": 1.95},
                {"PK_ID": 14, "ScreenPrintCostID": 14, "CostType": "PrimaryLocation", "TierLabel": "73-144", "ColorCount": 2, "BasePrintCost": 2},
                {"PK_ID": 15, "ScreenPrintCostID": 15, "CostType": "PrimaryLocation", "TierLabel": "73-144", "ColorCount": 3, "BasePrintCost": 2.1},
                {"PK_ID": 16, "ScreenPrintCostID": 16, "CostType": "PrimaryLocation", "TierLabel": "73-144", "ColorCount": 4, "BasePrintCost": 2.2},
                {"PK_ID": 17, "ScreenPrintCostID": 17, "CostType": "PrimaryLocation", "TierLabel": "73-144", "ColorCount": 5, "BasePrintCost": 2.4},
                {"PK_ID": 18, "ScreenPrintCostID": 18, "CostType": "PrimaryLocation", "TierLabel": "73-144", "ColorCount": 6, "BasePrintCost": 2.6},
                {"PK_ID": 19, "ScreenPrintCostID": 19, "CostType": "PrimaryLocation", "TierLabel": "145-576", "ColorCount": 1, "BasePrintCost": 1.8},
                {"PK_ID": 20, "ScreenPrintCostID": 20, "CostType": "PrimaryLocation", "TierLabel": "145-576", "ColorCount": 2, "BasePrintCost": 1.85},
                {"PK_ID": 21, "ScreenPrintCostID": 21, "CostType": "PrimaryLocation", "TierLabel": "145-576", "ColorCount": 3, "BasePrintCost": 1.95},
                {"PK_ID": 22, "ScreenPrintCostID": 22, "CostType": "PrimaryLocation", "TierLabel": "145-576", "ColorCount": 4, "BasePrintCost": 2.05},
                {"PK_ID": 23, "ScreenPrintCostID": 23, "CostType": "PrimaryLocation", "TierLabel": "145-576", "ColorCount": 5, "BasePrintCost": 2.2},
                {"PK_ID": 24, "ScreenPrintCostID": 24, "CostType": "PrimaryLocation", "TierLabel": "145-576", "ColorCount": 6, "BasePrintCost": 2.3},
                {"PK_ID": 25, "ScreenPrintCostID": 25, "CostType": "AdditionalLocation", "TierLabel": "13-36", "ColorCount": 1, "BasePrintCost": 5.5},
                {"PK_ID": 26, "ScreenPrintCostID": 26, "CostType": "AdditionalLocation", "TierLabel": "13-36", "ColorCount": 2, "BasePrintCost": 6},
                {"PK_ID": 27, "ScreenPrintCostID": 27, "CostType": "AdditionalLocation", "TierLabel": "13-36", "ColorCount": 3, "BasePrintCost": 7},
                {"PK_ID": 28, "ScreenPrintCostID": 28, "CostType": "AdditionalLocation", "TierLabel": "13-36", "ColorCount": 4, "BasePrintCost": 7.5},
                {"PK_ID": 29, "ScreenPrintCostID": 29, "CostType": "AdditionalLocation", "TierLabel": "13-36", "ColorCount": 5, "BasePrintCost": 8},
                {"PK_ID": 30, "ScreenPrintCostID": 30, "CostType": "AdditionalLocation", "TierLabel": "13-36", "ColorCount": 6, "BasePrintCost": 8.5},
                {"PK_ID": 31, "ScreenPrintCostID": 31, "CostType": "AdditionalLocation", "TierLabel": "37-72", "ColorCount": 1, "BasePrintCost": 5},
                {"PK_ID": 32, "ScreenPrintCostID": 32, "CostType": "AdditionalLocation", "TierLabel": "37-72", "ColorCount": 2, "BasePrintCost": 5.5},
                {"PK_ID": 33, "ScreenPrintCostID": 33, "CostType": "AdditionalLocation", "TierLabel": "37-72", "ColorCount": 3, "BasePrintCost": 6},
                {"PK_ID": 34, "ScreenPrintCostID": 34, "CostType": "AdditionalLocation", "TierLabel": "37-72", "ColorCount": 4, "BasePrintCost": 6.5},
                {"PK_ID": 35, "ScreenPrintCostID": 35, "CostType": "AdditionalLocation", "TierLabel": "37-72", "ColorCount": 5, "BasePrintCost": 7},
                {"PK_ID": 36, "ScreenPrintCostID": 36, "CostType": "AdditionalLocation", "TierLabel": "37-72", "ColorCount": 6, "BasePrintCost": 7.5},
                {"PK_ID": 37, "ScreenPrintCostID": 37, "CostType": "AdditionalLocation", "TierLabel": "73-144", "ColorCount": 1, "BasePrintCost": 4.5},
                {"PK_ID": 38, "ScreenPrintCostID": 38, "CostType": "AdditionalLocation", "TierLabel": "73-144", "ColorCount": 2, "BasePrintCost": 5},
                {"PK_ID": 39, "ScreenPrintCostID": 39, "CostType": "AdditionalLocation", "TierLabel": "73-144", "ColorCount": 3, "BasePrintCost": 5.5},
                {"PK_ID": 40, "ScreenPrintCostID": 40, "CostType": "AdditionalLocation", "TierLabel": "73-144", "ColorCount": 4, "BasePrintCost": 6},
                {"PK_ID": 41, "ScreenPrintCostID": 41, "CostType": "AdditionalLocation", "TierLabel": "73-144", "ColorCount": 5, "BasePrintCost": 6.5},
                {"PK_ID": 42, "ScreenPrintCostID": 42, "CostType": "AdditionalLocation", "TierLabel": "73-144", "ColorCount": 6, "BasePrintCost": 7},
                {"PK_ID": 43, "ScreenPrintCostID": 43, "CostType": "AdditionalLocation", "TierLabel": "145-576", "ColorCount": 1, "BasePrintCost": 4},
                {"PK_ID": 44, "ScreenPrintCostID": 44, "CostType": "AdditionalLocation", "TierLabel": "145-576", "ColorCount": 2, "BasePrintCost": 4.5},
                {"PK_ID": 45, "ScreenPrintCostID": 45, "CostType": "AdditionalLocation", "TierLabel": "145-576", "ColorCount": 3, "BasePrintCost": 5},
                {"PK_ID": 46, "ScreenPrintCostID": 46, "CostType": "AdditionalLocation", "TierLabel": "145-576", "ColorCount": 4, "BasePrintCost": 5.5},
                {"PK_ID": 47, "ScreenPrintCostID": 47, "CostType": "AdditionalLocation", "TierLabel": "145-576", "ColorCount": 5, "BasePrintCost": 6},
                {"PK_ID": 48, "ScreenPrintCostID": 48, "CostType": "AdditionalLocation", "TierLabel": "145-576", "ColorCount": 6, "BasePrintCost": 6.5}
            ]
        };

        // State
        let state = {
            quantity: 48,
            blankCost: 3.41,
            frontColors: 1,
            frontSafety: false,
            isDarkGarment: false,
            additionalLocations: [],
            masterBundle: null,
            isLoading: false
        };

        // DOM Elements
        const elements = {
            quantity: document.getElementById('quantity'),
            blankCost: document.getElementById('blankCost'),
            frontColors: document.getElementById('frontColors'),
            frontSafety: document.getElementById('frontSafety'),
            darkGarment: document.getElementById('darkGarment'),
            addLocationBtn: document.getElementById('addLocationBtn'),
            additionalLocations: document.getElementById('additionalLocations'),
            priceDisplay: document.getElementById('priceDisplay'),
            priceSubtitle: document.getElementById('priceSubtitle'),
            tierInfo: document.getElementById('tierInfo'),
            tierLabel: document.getElementById('tierLabel'),
            ltmWarning: document.getElementById('ltmWarning'),
            summaryBlank: document.getElementById('summaryBlank'),
            summaryPrint: document.getElementById('summaryPrint'),
            summaryTotal: document.getElementById('summaryTotal'),
            setupSection: document.getElementById('setupSection'),
            setupTotal: document.getElementById('setupTotal'),
            setupBreakdown: document.getElementById('setupBreakdown')
        };

        // Initialize
        async function init() {
            if (DEBUG_MODE) {
                document.body.insertAdjacentHTML('beforeend', '<div class="debug-indicator">DEBUG MODE</div>');
            }

            // Bind events
            elements.quantity.addEventListener('input', debounce(handleQuantityChange, 300));
            elements.blankCost.addEventListener('input', debounce(handleBlankCostChange, 300));
            elements.frontColors.addEventListener('change', handleFrontColorsChange);
            elements.frontSafety.addEventListener('change', handleFrontSafetyChange);
            elements.darkGarment.addEventListener('change', handleDarkGarmentChange);
            elements.addLocationBtn.addEventListener('click', addLocation);

            // Load pricing data
            await loadPricingData();
            
            // Initial calculation
            calculatePricing();
        }

        // Load pricing data
        async function loadPricingData() {
            try {
                // Check cache first
                const cached = getCachedData();
                if (cached) {
                    if (DEBUG_MODE) console.log('[Manual Screen Print] Using cached data');
                    state.masterBundle = cached;
                    hideFallbackNotice(); // Hide notice if we had shown it
                    return;
                }

                if (DEBUG_MODE) console.log('[Manual Screen Print] Fetching from API');
                state.isLoading = true;
                
                const response = await fetch(API_URL);
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Transform the API response to the expected format
                if (data && data.tiersR && data.allScreenprintCostsR) {
                    const transformedBundle = {
                        tierData: data.tiersR,
                        printCosts: transformPrintCosts(data.allScreenprintCostsR),
                        rules: data.rulesR,
                        marginDenominator: {} // Will be populated from tierData
                    };
                    
                    // Create marginDenominator lookup for compatibility
                    transformedBundle.tierData.forEach(tier => {
                        transformedBundle.marginDenominator[tier.TierLabel] = tier.MarginDenominator;
                    });
                    
                    state.masterBundle = transformedBundle;
                    setCachedData(transformedBundle);
                    hideFallbackNotice(); // Hide notice if we had shown it
                    if (DEBUG_MODE) console.log('[Manual Screen Print] Data loaded from API:', transformedBundle);
                } else {
                    throw new Error('Invalid API response structure');
                }
            } catch (error) {
                console.warn('[Manual Screen Print] API failed, using fallback data:', error);
                
                // Use fallback data
                const transformedBundle = {
                    tierData: FALLBACK_DATA.tiersR,
                    printCosts: transformPrintCosts(FALLBACK_DATA.allScreenprintCostsR),
                    rules: FALLBACK_DATA.rulesR,
                    marginDenominator: {}
                };
                
                // Create marginDenominator lookup
                transformedBundle.tierData.forEach(tier => {
                    transformedBundle.marginDenominator[tier.TierLabel] = tier.MarginDenominator;
                });
                
                state.masterBundle = transformedBundle;
                showFallbackNotice(); // Show visual indicator
                
                if (DEBUG_MODE) console.log('[Manual Screen Print] Using fallback data (version ' + FALLBACK_DATA._fallbackVersion + ')');
            } finally {
                state.isLoading = false;
            }
        }

        // Transform print costs from API format to expected format
        function transformPrintCosts(allScreenprintCostsR) {
            const printCosts = {
                PrimaryLocation: {},
                AdditionalLocation: {}
            };
            
            allScreenprintCostsR.forEach(cost => {
                const location = cost.CostType;
                const tierLabel = cost.TierLabel;
                const colorCount = cost.ColorCount;
                
                if (!printCosts[location][tierLabel]) {
                    printCosts[location][tierLabel] = {};
                }
                
                printCosts[location][tierLabel][colorCount] = cost.BasePrintCost;
            });
            
            return printCosts;
        }

        // Cache management
        function getCachedData() {
            try {
                const cached = sessionStorage.getItem(CACHE_KEY);
                if (!cached) return null;
                
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp > CACHE_DURATION) {
                    sessionStorage.removeItem(CACHE_KEY);
                    return null;
                }
                
                return data;
            } catch (e) {
                return null;
            }
        }

        function setCachedData(data) {
            try {
                sessionStorage.setItem(CACHE_KEY, JSON.stringify({
                    data: data,
                    timestamp: Date.now()
                }));
            } catch (e) {
                console.warn('[Manual Screen Print] Failed to cache data');
            }
        }

        // Fallback notice functions
        function showFallbackNotice() {
            // Check if notice already exists
            if (document.getElementById('fallbackNotice')) return;
            
            const notice = document.createElement('div');
            notice.id = 'fallbackNotice';
            notice.className = 'fallback-notice';
            notice.innerHTML = `
                <i class="fas fa-info-circle"></i>
                <span>Using offline pricing data (${FALLBACK_DATA._fallbackDate})</span>
            `;
            
            // Insert after header or at top of body
            const header = document.querySelector('header');
            if (header) {
                header.after(notice);
            } else {
                document.body.insertBefore(notice, document.body.firstChild);
            }
        }

        function hideFallbackNotice() {
            const notice = document.getElementById('fallbackNotice');
            if (notice) {
                notice.remove();
            }
        }

        // Event handlers
        function handleQuantityChange(e) {
            const value = parseInt(e.target.value) || 0;
            state.quantity = Math.max(1, value);
            if (state.quantity !== value) {
                e.target.value = state.quantity;
            }
            calculatePricing();
        }

        function handleBlankCostChange(e) {
            const value = parseFloat(e.target.value) || 0;
            state.blankCost = Math.max(0, value);
            calculatePricing();
        }

        function handleFrontColorsChange(e) {
            state.frontColors = parseInt(e.target.value);
            calculatePricing();
        }

        function handleFrontSafetyChange(e) {
            state.frontSafety = e.target.checked;
            calculatePricing();
        }

        function handleDarkGarmentChange(e) {
            state.isDarkGarment = e.target.checked;
            calculatePricing();
        }

        // Location management
        function addLocation() {
            if (state.additionalLocations.length >= 3) return;
            
            const locationIndex = state.additionalLocations.length;
            const locationOptions = ['Back', 'Left Chest', 'Right Chest', 'Left Sleeve', 'Right Sleeve', 'Other'];
            
            state.additionalLocations.push({
                name: locationOptions[locationIndex] || 'Other',
                colors: 1,
                hasSafety: false
            });
            
            renderLocations();
            calculatePricing();
            
            // Disable button if max reached
            if (state.additionalLocations.length >= 3) {
                elements.addLocationBtn.disabled = true;
            }
        }

        function removeLocation(index) {
            state.additionalLocations.splice(index, 1);
            renderLocations();
            calculatePricing();
            
            // Enable add button
            elements.addLocationBtn.disabled = false;
        }

        function updateLocation(index, field, value) {
            if (field === 'colors') {
                state.additionalLocations[index].colors = parseInt(value);
            } else if (field === 'safety') {
                state.additionalLocations[index].hasSafety = value;
            } else if (field === 'name') {
                state.additionalLocations[index].name = value;
            }
            calculatePricing();
        }

        function renderLocations() {
            const html = state.additionalLocations.map((loc, index) => `
                <div class="location-section">
                    <div class="location-header">${loc.name} (Additional Location)</div>
                    <div class="location-row">
                        <select class="form-control" onchange="updateLocation(${index}, 'name', this.value)">
                            <option value="Back" ${loc.name === 'Back' ? 'selected' : ''}>Back</option>
                            <option value="Left Chest" ${loc.name === 'Left Chest' ? 'selected' : ''}>Left Chest</option>
                            <option value="Right Chest" ${loc.name === 'Right Chest' ? 'selected' : ''}>Right Chest</option>
                            <option value="Left Sleeve" ${loc.name === 'Left Sleeve' ? 'selected' : ''}>Left Sleeve</option>
                            <option value="Right Sleeve" ${loc.name === 'Right Sleeve' ? 'selected' : ''}>Right Sleeve</option>
                            <option value="Other" ${loc.name === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                        <select class="form-control" onchange="updateLocation(${index}, 'colors', this.value)">
                            <option value="1" ${loc.colors === 1 ? 'selected' : ''}>1 Color</option>
                            <option value="2" ${loc.colors === 2 ? 'selected' : ''}>2 Colors</option>
                            <option value="3" ${loc.colors === 3 ? 'selected' : ''}>3 Colors</option>
                            <option value="4" ${loc.colors === 4 ? 'selected' : ''}>4 Colors</option>
                            <option value="5" ${loc.colors === 5 ? 'selected' : ''}>5 Colors</option>
                            <option value="6" ${loc.colors === 6 ? 'selected' : ''}>6 Colors</option>
                        </select>
                        <button class="remove-btn" onclick="removeLocation(${index})">×</button>
                    </div>
                    <div class="safety-checkbox">
                        <input type="checkbox" id="safety-${index}" ${loc.hasSafety ? 'checked' : ''} 
                               onchange="updateLocation(${index}, 'safety', this.checked)">
                        <label for="safety-${index}" class="safety-label">Add Safety Stripes (+$2.00)</label>
                    </div>
                </div>
            `).join('');
            
            elements.additionalLocations.innerHTML = html;
        }

        // Pricing calculation using exact Caspio 3-part logic
        function calculatePricing() {
            if (!state.masterBundle || state.isLoading) {
                elements.priceDisplay.textContent = '$0.00';
                elements.priceSubtitle.textContent = 'Loading pricing data...';
                return;
            }

            const quantity = state.quantity;
            const blankCost = state.blankCost;

            // Use exact Caspio 3-part calculation structure
            const pricing = {
                quantity: quantity,
                frontColors: state.frontColors,
                additionalLocations: state.additionalLocations,
                blankCost: blankCost,
                
                // Part 1: Garment pricing
                garmentSellingPrice: 0,
                
                // Part 2: Print costs
                frontPrintCost: 0,
                additionalPrintCosts: [],
                totalPrintCost: 0,
                
                // Part 3: Final assembly
                subtotal: 0,
                ltmFee: 0,
                ltmImpactPerShirt: 0,
                roundedTotal: 0,
                grandTotal: 0,
                
                // Setup and breakdown for display
                setupFee: 0,
                setupPerShirt: 0,
                setupBreakdown: [],
                colorBreakdown: {
                    front: 0,
                    locations: []
                }
            };

            if (quantity === 0) return updateDisplay(0, 0, 0, null, false, [], 0);

            const tier = findTier(quantity);
            if (!tier) {
                console.error('[Manual Screen Print] No tier found for quantity:', quantity);
                return;
            }

            // PART 1: Calculate garment selling price with margin (exact Caspio logic)
            pricing.garmentSellingPrice = blankCost / tier.MarginDenominator;

            if (DEBUG_MODE) console.log('[Manual Screen Print] Part 1 - Garment:', {
                blankCost: blankCost,
                marginDenom: tier.MarginDenominator,
                garmentSellingPrice: pricing.garmentSellingPrice
            });

            // PART 2: Calculate print costs (exact Caspio logic)
            let totalSetupFee = 0;

            // Front location (primary) - includes flash charge and margin
            if (state.frontColors > 0) {
                // Add 1 color for white underbase if dark garment OR safety stripes
                // Safety stripes are ALWAYS printed on dark garments
                const needsUnderbase = state.isDarkGarment || state.frontSafety;
                const effectiveColors = state.frontColors + (needsUnderbase ? 1 : 0);
                const basePrintCost = getPrintCost('PrimaryLocation', effectiveColors, tier);
                
                // Add flash charge ($0.35) as per Caspio logic
                const totalCost = basePrintCost + 0.35;
                
                // Add safety stripe surcharge if applicable
                let costWithSafety = totalCost;
                if (state.frontSafety) {
                    costWithSafety += 2.00;
                    if (DEBUG_MODE) console.log('[Manual Screen Print] Front safety stripe added: $2.00');
                }
                
                // Apply margin to primary location (exact Caspio logic)
                pricing.frontPrintCost = costWithSafety / tier.MarginDenominator;
                pricing.totalPrintCost += pricing.frontPrintCost;
                
                if (DEBUG_MODE && state.frontSafety) {
                    console.log('[Manual Screen Print] Front safety stripe calculation:');
                    console.log('  - Effective colors (with underbase): ' + effectiveColors);
                    console.log('  - Base print cost (' + effectiveColors + ' colors): $' + basePrintCost.toFixed(2));
                    console.log('  - Flash charge: $0.35');
                    console.log('  - Total before safety: $' + totalCost.toFixed(2));
                    console.log('  - Safety stripe surcharge: $2.00');
                    console.log('  - Total with safety: $' + costWithSafety.toFixed(2));
                    console.log('  - Margin denominator: ' + tier.MarginDenominator);
                    console.log('  - Final print cost after margin: $' + pricing.frontPrintCost.toFixed(2));
                }

                // Setup fee - use effective colors for dark garment
                const frontSetup = 30 * effectiveColors;
                totalSetupFee += frontSetup;
                pricing.setupBreakdown.push({
                    location: 'Front',
                    colors: effectiveColors,
                    fee: frontSetup,
                    hasSafety: state.frontSafety
                });

                pricing.colorBreakdown.front = effectiveColors;

                if (DEBUG_MODE) console.log('[Manual Screen Print] Front print cost:', {
                    basePrintCost: basePrintCost,
                    withFlash: totalCost,
                    withSafety: costWithSafety,
                    withMargin: pricing.frontPrintCost
                });
            }

            // Additional locations - already have margin built in (exact Caspio logic)
            state.additionalLocations.forEach((loc, index) => {
                if (loc.colors > 0) {
                    // Add 1 color for white underbase if dark garment OR safety stripes
                    // Safety stripes are ALWAYS printed on dark garments
                    const needsUnderbase = state.isDarkGarment || loc.hasSafety;
                    const effectiveColors = loc.colors + (needsUnderbase ? 1 : 0);
                    const basePrintCost = getPrintCost('AdditionalLocation', effectiveColors, tier);
                    
                    // Additional locations already have margin - use as-is (key insight from user)
                    let finalCost = basePrintCost;
                    if (loc.hasSafety) {
                        finalCost += 2.00; // Safety stripe surcharge
                        if (DEBUG_MODE) console.log(`[Manual Screen Print] ${loc.name} safety stripe added: $2.00`);
                    }
                    
                    if (DEBUG_MODE && loc.hasSafety) {
                        console.log(`[Manual Screen Print] ${loc.name} safety stripe calculation:`);
                        console.log('  - Effective colors (with underbase): ' + effectiveColors);
                        console.log('  - Base print cost (' + effectiveColors + ' colors): $' + basePrintCost.toFixed(2));
                        console.log('  - Safety stripe surcharge: $2.00');
                        console.log('  - Final cost: $' + finalCost.toFixed(2));
                        console.log('  - Note: No margin applied to additional locations');
                    }
                    
                    pricing.additionalPrintCosts.push({
                        location: loc.name,
                        cost: finalCost
                    });
                    pricing.totalPrintCost += finalCost;

                    // Setup fee - use effective colors for dark garment
                    const locSetup = 30 * effectiveColors;
                    totalSetupFee += locSetup;
                    pricing.setupBreakdown.push({
                        location: loc.name,
                        colors: effectiveColors,
                        fee: locSetup,
                        hasSafety: loc.hasSafety
                    });

                    pricing.colorBreakdown.locations.push({
                        name: loc.name,
                        colors: effectiveColors,
                        hasSafety: loc.hasSafety
                    });

                    if (DEBUG_MODE) console.log(`[Manual Screen Print] Additional location ${loc.name}:`, {
                        baseCost: basePrintCost,
                        withSafety: finalCost,
                        note: 'No margin applied - already included'
                    });
                }
            });

            pricing.setupFee = totalSetupFee;

            // PART 3: Final assembly (exact Caspio logic)
            pricing.subtotal = pricing.garmentSellingPrice + pricing.totalPrintCost;

            // Apply LTM fee if needed (threshold is 72 to match automated version)
            if (quantity < 72) {
                pricing.ltmFee = 50;
                pricing.ltmImpactPerShirt = pricing.ltmFee / quantity;
                pricing.subtotal += pricing.ltmImpactPerShirt;
            }

            // Setup cost per shirt for display
            if (quantity > 0) {
                pricing.setupPerShirt = totalSetupFee / quantity;
            }

            // Apply half-dollar ceiling rounding (always round UP as per Caspio)
            pricing.roundedTotal = halfDollarCeil(pricing.subtotal);
            pricing.grandTotal = pricing.roundedTotal * quantity;

            // Debug output for the test case - Enhanced for safety stripe debugging
            if (quantity === 48 && state.frontColors === 3 && 
                state.additionalLocations.length === 1 && state.additionalLocations[0].colors === 3) {
                console.log('[Manual Screen Print] SAFETY STRIPE TEST CASE - Full pricing breakdown:', {
                    configuration: {
                        quantity: quantity,
                        frontColors: state.frontColors,
                        backColors: state.additionalLocations[0].colors,
                        isDarkGarment: state.isDarkGarment,
                        frontSafety: state.frontSafety,
                        backSafety: state.additionalLocations[0].hasSafety
                    },
                    tier: {
                        label: tier.TierLabel,
                        marginDenom: tier.MarginDenominator
                    },
                    part1_garment: {
                        blankCost: blankCost,
                        sellingPrice: pricing.garmentSellingPrice
                    },
                    part2_print: {
                        front: {
                            effectiveColors: pricing.colorBreakdown.front,
                            baseCost: getPrintCost('PrimaryLocation', pricing.colorBreakdown.front, tier),
                            withFlash: getPrintCost('PrimaryLocation', pricing.colorBreakdown.front, tier) + 0.35,
                            withSafety: getPrintCost('PrimaryLocation', pricing.colorBreakdown.front, tier) + 0.35 + (state.frontSafety ? 2 : 0),
                            finalCost: pricing.frontPrintCost
                        },
                        back: {
                            effectiveColors: pricing.colorBreakdown.locations[0]?.colors,
                            baseCost: getPrintCost('AdditionalLocation', pricing.colorBreakdown.locations[0]?.colors || 0, tier),
                            withSafety: getPrintCost('AdditionalLocation', pricing.colorBreakdown.locations[0]?.colors || 0, tier) + (state.additionalLocations[0].hasSafety ? 2 : 0),
                            finalCost: pricing.additionalPrintCosts[0]?.cost
                        },
                        totalPrintCost: pricing.totalPrintCost
                    },
                    part3_final: {
                        subtotal: pricing.subtotal,
                        roundedTotal: pricing.roundedTotal,
                        perShirtPrice: pricing.roundedTotal
                    }
                });
            }

            if (DEBUG_MODE) {
                console.log('[Manual Screen Print] Part 3 - Final assembly:');
                console.log('  - Garment price: $' + pricing.garmentSellingPrice.toFixed(2));
                console.log('  - Total print cost: $' + pricing.totalPrintCost.toFixed(2));
                console.log('  - Subtotal: $' + pricing.subtotal.toFixed(2));
                console.log('  - LTM impact per shirt: $' + pricing.ltmImpactPerShirt.toFixed(2));
                console.log('  - Rounded total: $' + pricing.roundedTotal.toFixed(2));
                console.log('  - Grand total (x' + quantity + '): $' + pricing.grandTotal.toFixed(2));
                
                // Special debug for safety stripe scenarios
                const hasSafetyStripes = state.frontSafety || state.additionalLocations.some(loc => loc.hasSafety);
                if (hasSafetyStripes) {
                    console.log('[Manual Screen Print] SAFETY STRIPE SUMMARY:', {
                        frontSafety: state.frontSafety,
                        backSafety: state.additionalLocations[0]?.hasSafety || false,
                        totalSafetyStripeSurcharges: (state.frontSafety ? 1 : 0) + state.additionalLocations.filter(loc => loc.hasSafety).length,
                        expectedSafetyStripeImpact: ((state.frontSafety ? 1 : 0) + state.additionalLocations.filter(loc => loc.hasSafety).length) * 2.00,
                        finalPerShirtPrice: pricing.roundedTotal,
                        expectedAutomatedPrice: 23.50,
                        difference: pricing.roundedTotal - 23.50
                    });
                }
                
                console.log('[Manual Screen Print] COMPARISON TEST - Use PC61 at $3.41 cost to verify against automated pricing');
            }

            // Update display with new pricing structure
            updateDisplayModern(pricing, tier, pricing.setupBreakdown);
        }
        function findTier(quantity) {
            if (!state.masterBundle || !state.masterBundle.tierData) return null;
            
            return state.masterBundle.tierData.find(tier =>
                quantity >= tier.MinQuantity && quantity <= tier.MaxQuantity
            );
        }

        function getPrintCost(locationType, colorCount, tier) {
            if (!state.masterBundle || !state.masterBundle.printCosts) {
                return 0;
            }

            const tierLabel = tier.TierLabel;
            const locationCosts = state.masterBundle.printCosts[locationType];
            
            if (!locationCosts || !locationCosts[tierLabel]) {
                console.warn(`[Manual Screen Print] No ${locationType} costs found for tier ${tierLabel}`);
                return 0;
            }

            const cost = locationCosts[tierLabel][colorCount];
            if (typeof cost !== 'number') {
                console.warn(`[Manual Screen Print] Invalid cost for ${locationType}, ${tierLabel}, ${colorCount} colors`);
                return 0;
            }

            return cost;
        }

        function halfDollarCeil(value) {
            return Math.ceil(value * 2) / 2;
        }

        function updateDisplayModern(pricing, tier, setupBreakdown) {
            // Main price display - use rounded total from 3-part calculation
            elements.priceDisplay.textContent = `$${pricing.roundedTotal.toFixed(2)}`;
            
            // Calculate total locations and colors
            let totalLocations = pricing.frontColors > 0 ? 1 : 0;
            totalLocations += pricing.additionalLocations.filter(loc => loc.colors > 0).length;
            
            let totalColors = pricing.frontColors;
            pricing.additionalLocations.forEach(loc => totalColors += loc.colors);

            // Price subtitle with detailed breakdown showing 3-part calculation
            if (totalLocations === 0) {
                elements.priceSubtitle.textContent = 'Blank garment only (no printing)';
            } else {
                // Adjust display for dark garment or safety stripes
                let displayText = '';
                // Check if any location has safety stripes
                const hasSafetyStripes = state.frontSafety || state.additionalLocations.some(loc => loc.hasSafety);
                
                if (state.isDarkGarment || hasSafetyStripes) {
                    const actualFrontColors = state.frontColors;
                    const actualAdditionalColors = pricing.additionalLocations.reduce((sum, loc) => sum + loc.colors, 0);
                    const actualTotalColors = actualFrontColors + actualAdditionalColors;
                    
                    const locText = totalLocations === 1 ? 'location' : 'locations';
                    const colorText = actualTotalColors === 1 ? 'color' : 'colors';
                    
                    if (hasSafetyStripes && !state.isDarkGarment) {
                        displayText = `${actualTotalColors} ${colorText} + white underbase (safety stripes) across ${totalLocations} ${locText}`;
                    } else {
                        displayText = `${actualTotalColors} ${colorText} + white underbase across ${totalLocations} ${locText}`;
                    }
                } else {
                    const locText = totalLocations === 1 ? 'location' : 'locations';
                    const colorText = totalColors === 1 ? 'color' : 'colors';
                    displayText = `${totalColors} ${colorText} across ${totalLocations} ${locText}`;
                }
                
                // Add detailed cost breakdown showing exact 3-part Caspio calculation
                const breakdownParts = [];
                if (pricing.garmentSellingPrice > 0) breakdownParts.push(`Garment: $${pricing.garmentSellingPrice.toFixed(2)}`);
                if (pricing.totalPrintCost > 0) breakdownParts.push(`Print: $${pricing.totalPrintCost.toFixed(2)}`);
                if (pricing.ltmImpactPerShirt > 0) breakdownParts.push(`LTM: +$${pricing.ltmImpactPerShirt.toFixed(2)}`);
                
                if (breakdownParts.length > 0) {
                    const subtotalText = `Subtotal: $${pricing.subtotal.toFixed(2)}`;
                    const roundedText = `Rounded: $${pricing.roundedTotal.toFixed(2)}`;
                    displayText += ` | ${breakdownParts.join(' + ')} = ${subtotalText} → ${roundedText}`;
                }
                
                elements.priceSubtitle.textContent = displayText;
            }

            // Tier info
            if (tier) {
                elements.tierInfo.style.display = 'block';
                elements.tierLabel.textContent = `${tier.TierLabel} (${tier.MinQuantity}-${tier.MaxQuantity} pcs)`;
            }

            // LTM warning - updated threshold to 48
            elements.ltmWarning.style.display = pricing.ltmFee > 0 ? 'block' : 'none';

            // Summary with updated structure matching 3-part calculation
            elements.summaryBlank.textContent = `$${pricing.garmentSellingPrice.toFixed(2)}`;
            elements.summaryPrint.textContent = `$${pricing.totalPrintCost.toFixed(2)}`;
            document.getElementById('subtotalAmount').textContent = `$${pricing.preRoundedTotal.toFixed(2)}`;
            elements.summaryTotal.textContent = `$${pricing.roundedTotal.toFixed(2)}`;

            // Setup breakdown with safety stripe indicators
            if (setupBreakdown.length > 0) {
                elements.setupSection.style.display = 'block';
                elements.setupTotal.textContent = `$${pricing.setupFee.toFixed(2)}`;
                
                const breakdownHTML = setupBreakdown.map(item => {
                    const safetyNote = item.hasSafety ? ' (with safety stripes)' : '';
                    return `
                        <div class="setup-item">
                            <span>${item.location}: ${item.colors} ${item.colors === 1 ? 'color' : 'colors'} × $30${safetyNote}</span>
                            <span>$${item.fee.toFixed(2)}</span>
                        </div>
                    `;
                }).join('');
                
                elements.setupBreakdown.innerHTML = breakdownHTML;
            } else {
                elements.setupSection.style.display = 'none';
            }

            // Debug logging for comparison with automated version
            if (DEBUG_MODE) {
                console.log('[Manual Screen Print] Final pricing:', {
                    perShirt: pricing.perShirtTotal,
                    garment: pricing.basePrice,
                    print: pricing.additionalCost,
                    setup: pricing.setupFee,
                    ltm: pricing.ltmFee,
                    quantity: pricing.quantity
                });
                console.log('[Manual Screen Print] Compare with automated version using PC61 + same print options');
            }
        }

        // Legacy function for compatibility - calls new function
        function updateDisplay(finalPrice, garmentPrice, printSellingPrice, tier, hasLTM, setupBreakdown, totalSetupFee) {
            const pricing = {
                perShirtTotal: finalPrice,
                basePrice: garmentPrice,
                additionalCost: printSellingPrice,
                setupFee: totalSetupFee,
                ltmFee: hasLTM ? 50 : 0,
                ltmImpactPerShirt: hasLTM ? 50 / state.quantity : 0,
                frontColors: state.frontColors,
                additionalLocations: state.additionalLocations,
                quantity: state.quantity
            };
            updateDisplayModern(pricing, tier, setupBreakdown);
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>