<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Customer Supplied Embroidery Calculator - Northwest Custom Apparel</title>
    <link rel="icon" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- Shared Calculator Styles -->
    <link href="../shared_components/css/calculator-base.css" rel="stylesheet">
    <!-- Customer Embroidery-Specific Styles -->
    <link href="embroidery-customer-styles.css" rel="stylesheet">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Base Quote Service -->
    <script src="../shared_components/js/base-quote-service.js"></script>
    <!-- Customer Embroidery Quote Service -->
    <script src="embroidery-customer-quote-service.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                     alt="Northwest Custom Apparel" class="logo">
                <nav class="breadcrumb">
                    <a href="/staff-dashboard.html">Dashboard</a>
                    <span>/</span>
                    <span>Customer Supplied Embroidery</span>
                </nav>
            </div>
            <div class="header-right">
                <button class="help-btn" onclick="window.print()">
                    <i class="fas fa-print"></i>
                    Print Quote
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <h1 class="calculator-title">
            <i class="fas fa-hand-holding"></i>
            Customer Supplied Embroidery Calculator
        </h1>

        <div class="calculator-grid">
            <!-- Input Section -->
            <div class="card">
                <h2 class="card-title">Quote Details</h2>
                
                <div class="form-group">
                    <label>1. Select Item Type</label>
                    <div class="selector-group">
                        <button class="selector-btn active" data-item-type="flats">Flats (Jackets, etc.)</button>
                        <button class="selector-btn" data-item-type="caps">Caps (-20% Price)</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="quantity">2. Enter Quantity</label>
                    <input type="number" 
                           id="quantity" 
                           class="form-control" 
                           placeholder="Enter quantity"
                           min="1">
                </div>

                <div class="switch-container" id="heavyweight-container">
                    <label for="isHeavyweight">Heavy/Difficult Item? (Add $10.00)</label>
                    <label class="switch">
                        <input type="checkbox" id="isHeavyweight">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Add-on Order Toggle -->
                <div class="addon-toggle-container">
                    <label for="isAddon" style="font-weight: 600; color: var(--primary-color);">
                        <i class="fas fa-plus-circle"></i>
                        This is an add-on to an existing order
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="isAddon">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Add-on Order Details -->
                <div class="addon-section hidden" id="addonSection">
                    <h4 style="margin-top: 0; margin-bottom: 1rem; color: var(--primary-color);">
                        <i class="fas fa-info-circle"></i>
                        Main Order Details
                    </h4>
                    
                    <div class="addon-grid">
                        <div class="form-group">
                            <label for="mainOrderQty">Items purchasing from us</label>
                            <input type="number" 
                                   id="mainOrderQty" 
                                   class="form-control" 
                                   placeholder="e.g. 24"
                                   min="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="mainOrderValue">Main order value ($)</label>
                            <input type="number" 
                                   id="mainOrderValue" 
                                   class="form-control" 
                                   placeholder="e.g. 1200.00"
                                   min="0"
                                   step="0.01">
                        </div>
                    </div>
                    
                    <div class="addon-summary">
                        <div class="addon-summary-item">
                            <span>Items from NWCA:</span>
                            <span id="summaryMainQty">0</span>
                        </div>
                        <div class="addon-summary-item">
                            <span>Customer supplied:</span>
                            <span id="summaryAddonQty">0</span>
                        </div>
                        <div class="addon-summary-item" style="font-weight: 600; border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.25rem;">
                            <span>Total quantity:</span>
                            <span id="summaryTotalQty">0</span>
                        </div>
                    </div>
                    
                    <div id="discountIndicator" class="discount-indicator" style="display: none;">
                        <i class="fas fa-tag"></i>
                        <span id="discountText">Calculating discount...</span>
                    </div>
                </div>

                <!-- Program Account Toggle -->
                <div class="program-account-container">
                    <label for="isProgramAccount" style="font-weight: 600; color: #7c3aed;">
                        <i class="fas fa-shield-alt"></i>
                        Program Account (Police, Fire, Schools)
                        <span class="program-badge" id="programBadge" style="display: none;">
                            <i class="fas fa-check"></i>
                            25% Discount Applied
                        </span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="isProgramAccount">
                        <span class="slider"></span>
                    </label>
                </div>

            </div>

            <!-- Results Section -->
            <div class="card">
                <div class="results-section">
                    <div class="results-header">
                        <h3 class="card-title">Your Quote</h3>
                        <div class="price-display prompt" id="priceDisplay">Enter Quantity</div>
                        <div class="price-label">Price per Item</div>
                    </div>
                    
                    <div class="summary-section">
                        <div id="ltmWarning" class="ltm-warning" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span id="ltmMessage"></span>
                        </div>
                        
                        <div class="summary-item">
                            <span>Base Price:</span>
                            <span id="basePrice">$0.00</span>
                        </div>
                        
                        <div class="summary-item" id="capDiscountRow" style="display: none;">
                            <span>Cap Discount (20%):</span>
                            <span id="capDiscount">-$0.00</span>
                        </div>
                        
                        <div class="summary-item" id="heavyweightRow" style="display: none;">
                            <span>Heavyweight Surcharge:</span>
                            <span id="heavyweightCharge">+$10.00</span>
                        </div>
                        
                        <div class="summary-item" id="ltmRow" style="display: none;">
                            <span>Less Than Minimum Fee:</span>
                            <span id="ltmCharge">+$0.00</span>
                        </div>
                        
                        <div class="summary-item" id="addonDiscountRow" style="display: none;">
                            <span id="addonDiscountLabel">Add-on Discount:</span>
                            <span id="addonDiscount">-$0.00</span>
                        </div>
                        
                        <div class="summary-item" id="programDiscountRow" style="display: none;">
                            <span>Program Account Discount (25%):</span>
                            <span id="programDiscount">-$0.00</span>
                        </div>
                        
                        <div class="summary-item total">
                            <span>Total Order Cost:</span>
                            <span id="totalDisplay">$0.00</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="emailQuoteBtn" style="width: 100%; margin-top: 1.5rem; display: none;">
                        <i class="fas fa-envelope"></i>
                        Email This Quote
                    </button>
                </div>
            </div>
        </div>

        <!-- Notice Section -->
        <div class="notice-section">
            <h2>
                <i class="fas fa-exclamation-triangle"></i>
                Important Notice: Customer Supplied Garments
            </h2>
            <p>
                Northwest Custom Apparel is not responsible for the damage of ANY customer supplied garments during 
                the production process in either our screening or embroidery departments. Should one or all of your 
                items be damaged while in our facility, Northwest Custom Apparel WILL NOT reimburse you for the value 
                of the garments or replace them.
            </p>
            <p>
                Please note that we try very hard to take extreme care when dealing with customer supplied goods. 
                It is a very rare occurrence that goods are damaged in our facility. Due to the nature of the high 
                end equipment used in production there is a chance for machine or human error.
            </p>
        </div>
    </main>

    <!-- Email Modal -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Send Quote</h3>
                <button class="modal-close" onclick="closeEmailModal()">×</button>
            </div>
            <form id="quoteForm">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName">Customer Name *</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="companyName">Company Name</label>
                            <input type="text" class="form-control" id="companyName">
                        </div>
                        
                        <div class="form-group">
                            <label for="customerEmail">Customer Email *</label>
                            <input type="email" class="form-control" id="customerEmail" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="customerPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="projectName">Project/Order Name</label>
                        <input type="text" class="form-control" id="projectName" placeholder="e.g., Police Department Uniforms">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="salesRep">Sales Representative *</label>
                        <select class="form-control" id="salesRep" required>
                            <option value="sales@nwcustomapparel.com" selected>General Sales</option>
                            <option value="ruth@nwcustomapparel.com">Ruth Nhong</option>
                            <option value="taylar@nwcustomapparel.com">Taylar Hanson</option>
                            <option value="nika@nwcustomapparel.com">Nika Lao</option>
                            <option value="erik@nwcustomapparel.com">Erik Mickelson</option>
                            <option value="adriyella@nwcustomapparel.com">Adriyella</option>
                            <option value="bradley@nwcustomapparel.com">Bradley Wright</option>
                            <option value="jim@nwcustomapparel.com">Jim Mickelson</option>
                            <option value="art@nwcustomapparel.com">Steve Deland</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="notes">Notes</label>
                        <textarea class="form-control" id="notes" rows="3" placeholder="Special instructions or additional information..."></textarea>
                    </div>
                    
                    <div class="quote-preview">
                        <h4>Quote Preview</h4>
                        <div id="quotePreview"></div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="sendEmailBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Quote
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header" style="background: #10b981;">
                <h3 class="modal-title">Quote Sent Successfully!</h3>
                <button class="modal-close" onclick="closeSuccessModal()">×</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 2.5rem;">
                <div style="margin-bottom: 2rem;">
                    <i class="fas fa-check-circle" style="font-size: 4rem; color: #10b981; margin-bottom: 1rem; display: block;"></i>
                    <p style="font-size: 1.125rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Your quote has been sent successfully!
                    </p>
                </div>
                
                <div style="background: var(--bg-color); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
                    <p style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 0.875rem;">Your Quote ID:</p>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                        <h2 id="successQuoteID" style="margin: 0; font-size: 2rem; color: var(--primary-color); letter-spacing: 0.05em;">EMBC-0000-0</h2>
                        <button class="btn btn-secondary" onclick="copyQuoteID()" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-copy"></i>
                            Copy
                        </button>
                    </div>
                </div>
                
                <div style="background: #e8f4fd; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; font-size: 0.875rem; color: #1e40af;">
                    <i class="fas fa-info-circle"></i>
                    Please save this Quote ID for your records. You'll need it to reference this quote.
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary" onclick="printQuote()">
                        <i class="fas fa-print"></i>
                        Print Quote
                    </button>
                    <button class="btn btn-secondary" onclick="closeSuccessModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CALCULATOR_CONFIG = {
            emailPublicKey: '4qSbDO-SQs19TbP80',
            emailServiceId: 'service_1c4k67j',
            emailTemplateId: 'template_yrrt52c' // Customer Supplied template
        };

        // Pricing configuration
        const PRICING_CONFIG = {
            heavyweight_surcharge: 10.00,
            cap_discount_percent: 0.20,
            ltm_threshold: 24,
            ltm_fee: 50.00,
            tiers: {
                "1-2": 45.00,
                "3-5": 40.00,
                "6-11": 38.00,
                "12-23": 32.00,
                "24-71": 30.00,
                "72-143": 25.00,
                "144+": 15.00
            }
        };

        class CustomerEmbroideryCalculator {
            constructor() {
                this.state = {
                    itemType: 'flats',
                    quantity: 0,
                    isHeavyweight: false,
                    isAddon: false,
                    mainOrderQty: 0,
                    mainOrderValue: 0,
                    isProgramAccount: false
                };
                
                this.currentQuote = null;
                this.quoteService = new CustomerEmbroideryQuoteService();
                
                // Initialize EmailJS
                emailjs.init(CALCULATOR_CONFIG.emailPublicKey);
                
                this.initializeElements();
                this.bindEvents();
                this.updateUI();
            }

            initializeElements() {
                this.elements = {
                    // Item type buttons
                    itemTypeBtns: document.querySelectorAll('[data-item-type]'),
                    // Input fields
                    quantity: document.getElementById('quantity'),
                    isHeavyweight: document.getElementById('isHeavyweight'),
                    heavyweightContainer: document.getElementById('heavyweight-container'),
                    // Display elements
                    priceDisplay: document.getElementById('priceDisplay'),
                    totalDisplay: document.getElementById('totalDisplay'),
                    basePrice: document.getElementById('basePrice'),
                    capDiscount: document.getElementById('capDiscount'),
                    capDiscountRow: document.getElementById('capDiscountRow'),
                    heavyweightCharge: document.getElementById('heavyweightCharge'),
                    heavyweightRow: document.getElementById('heavyweightRow'),
                    ltmCharge: document.getElementById('ltmCharge'),
                    ltmRow: document.getElementById('ltmRow'),
                    ltmWarning: document.getElementById('ltmWarning'),
                    ltmMessage: document.getElementById('ltmMessage'),
                    // Add-on elements
                    isAddon: document.getElementById('isAddon'),
                    addonSection: document.getElementById('addonSection'),
                    mainOrderQty: document.getElementById('mainOrderQty'),
                    mainOrderValue: document.getElementById('mainOrderValue'),
                    summaryMainQty: document.getElementById('summaryMainQty'),
                    summaryAddonQty: document.getElementById('summaryAddonQty'),
                    summaryTotalQty: document.getElementById('summaryTotalQty'),
                    discountIndicator: document.getElementById('discountIndicator'),
                    discountText: document.getElementById('discountText'),
                    addonDiscountRow: document.getElementById('addonDiscountRow'),
                    addonDiscountLabel: document.getElementById('addonDiscountLabel'),
                    addonDiscount: document.getElementById('addonDiscount'),
                    // Program account elements
                    isProgramAccount: document.getElementById('isProgramAccount'),
                    programBadge: document.getElementById('programBadge'),
                    programDiscountRow: document.getElementById('programDiscountRow'),
                    programDiscount: document.getElementById('programDiscount'),
                    // Email form
                    emailQuoteBtn: document.getElementById('emailQuoteBtn'),
                    emailModal: document.getElementById('emailModal'),
                    quoteForm: document.getElementById('quoteForm'),
                    customerName: document.getElementById('customerName'),
                    customerEmail: document.getElementById('customerEmail'),
                    companyName: document.getElementById('companyName'),
                    customerPhone: document.getElementById('customerPhone'),
                    projectName: document.getElementById('projectName'),
                    salesRep: document.getElementById('salesRep'),
                    notes: document.getElementById('notes'),
                    quotePreview: document.getElementById('quotePreview'),
                    sendEmailBtn: document.getElementById('sendEmailBtn')
                };
            }

            bindEvents() {
                // Item type selection
                this.elements.itemTypeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.state.itemType = btn.dataset.itemType;
                        this.updateUI();
                    });
                });

                // Quantity input
                this.elements.quantity.addEventListener('input', () => {
                    this.state.quantity = parseInt(this.elements.quantity.value) || 0;
                    this.calculatePrice();
                });

                // Heavyweight toggle
                this.elements.isHeavyweight.addEventListener('change', () => {
                    this.state.isHeavyweight = this.elements.isHeavyweight.checked;
                    this.calculatePrice();
                });

                // Add-on toggle
                this.elements.isAddon.addEventListener('change', () => {
                    this.state.isAddon = this.elements.isAddon.checked;
                    this.elements.addonSection.classList.toggle('hidden', !this.state.isAddon);
                    if (!this.state.isAddon) {
                        // Reset add-on values
                        this.elements.mainOrderQty.value = '';
                        this.elements.mainOrderValue.value = '';
                        this.state.mainOrderQty = 0;
                        this.state.mainOrderValue = 0;
                    }
                    this.updateAddonSummary();
                    this.calculatePrice();
                });

                // Main order inputs
                this.elements.mainOrderQty.addEventListener('input', () => {
                    this.state.mainOrderQty = parseInt(this.elements.mainOrderQty.value) || 0;
                    this.updateAddonSummary();
                    this.calculatePrice();
                });

                this.elements.mainOrderValue.addEventListener('input', () => {
                    this.state.mainOrderValue = parseFloat(this.elements.mainOrderValue.value) || 0;
                    this.updateAddonSummary();
                    this.calculatePrice();
                });

                // Program account toggle
                this.elements.isProgramAccount.addEventListener('change', () => {
                    this.state.isProgramAccount = this.elements.isProgramAccount.checked;
                    this.elements.programBadge.style.display = this.state.isProgramAccount ? 'inline-flex' : 'none';
                    this.calculatePrice();
                });

                // Email form
                this.elements.emailQuoteBtn.addEventListener('click', () => {
                    this.showEmailForm();
                });

                this.elements.quoteForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendQuote();
                });
            }

            updateUI() {
                // Update item type buttons
                this.elements.itemTypeBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.itemType === this.state.itemType);
                });

                // Show/hide heavyweight option for flats only
                const isFlats = this.state.itemType === 'flats';
                this.elements.heavyweightContainer.style.display = isFlats ? 'flex' : 'none';
                if (!isFlats) {
                    this.elements.isHeavyweight.checked = false;
                    this.state.isHeavyweight = false;
                }

                this.calculatePrice();
            }

            getAddonDiscount() {
                const value = this.state.mainOrderValue;
                const qty = this.state.mainOrderQty;
                
                // Base discount from order value
                let baseDiscount = 0;
                if (value >= 2000) baseDiscount = 20;
                else if (value >= 1000) baseDiscount = 15;
                else if (value >= 500) baseDiscount = 10;
                
                // Volume bonus from quantity
                let volumeBonus = 0;
                if (qty >= 96) volumeBonus = 15;
                else if (qty >= 48) volumeBonus = 10;
                else if (qty >= 24) volumeBonus = 5;
                
                // Total discount capped at 35%
                return Math.min(35, baseDiscount + volumeBonus);
            }

            updateAddonSummary() {
                if (!this.state.isAddon) return;
                
                // Update summary quantities
                this.elements.summaryMainQty.textContent = this.state.mainOrderQty;
                this.elements.summaryAddonQty.textContent = this.state.quantity;
                this.elements.summaryTotalQty.textContent = this.state.mainOrderQty + this.state.quantity;
                
                // Update discount indicator
                if (this.state.mainOrderValue > 0) {
                    const discount = this.getAddonDiscount();
                    this.elements.discountIndicator.style.display = 'flex';
                    this.elements.discountText.textContent = `${discount}% Add-on Discount Applied`;
                    
                    // Set color based on discount level
                    this.elements.discountIndicator.className = 'discount-indicator';
                    if (discount >= 30) {
                        this.elements.discountIndicator.classList.add('gold');
                    } else if (discount >= 20) {
                        this.elements.discountIndicator.classList.add('silver');
                    } else if (discount >= 10) {
                        this.elements.discountIndicator.classList.add('bronze');
                    }
                } else {
                    this.elements.discountIndicator.style.display = 'none';
                }
            }

            calculatePrice() {
                const quantity = this.state.quantity;

                if (quantity < 1) {
                    this.resetDisplay("Enter Quantity");
                    return;
                }

                // Get base price from tier
                let basePrice = 0;
                if (quantity >= 144) basePrice = PRICING_CONFIG.tiers["144+"];
                else if (quantity >= 72) basePrice = PRICING_CONFIG.tiers["72-143"];
                else if (quantity >= 24) basePrice = PRICING_CONFIG.tiers["24-71"];
                else if (quantity >= 12) basePrice = PRICING_CONFIG.tiers["12-23"];
                else if (quantity >= 6) basePrice = PRICING_CONFIG.tiers["6-11"];
                else if (quantity >= 3) basePrice = PRICING_CONFIG.tiers["3-5"];
                else basePrice = PRICING_CONFIG.tiers["1-2"];

                // Calculate cap discount
                let priceAfterDiscount = basePrice;
                let capDiscountAmount = 0;
                if (this.state.itemType === 'caps') {
                    capDiscountAmount = basePrice * PRICING_CONFIG.cap_discount_percent;
                    priceAfterDiscount = basePrice - capDiscountAmount;
                }

                // Add heavyweight surcharge (flats only)
                const heavyweightSurcharge = (this.state.isHeavyweight && this.state.itemType === 'flats') 
                    ? PRICING_CONFIG.heavyweight_surcharge : 0;

                // Calculate LTM fee (only if NOT an add-on order AND NOT a program account)
                let ltmFeeTotal = 0;
                let ltmPerUnit = 0;
                if (!this.state.isAddon && !this.state.isProgramAccount && quantity < PRICING_CONFIG.ltm_threshold) {
                    ltmFeeTotal = PRICING_CONFIG.ltm_fee;
                    ltmPerUnit = ltmFeeTotal / quantity;
                }

                // Calculate add-on discount
                let addonDiscountAmount = 0;
                let addonDiscountPercent = 0;
                if (this.state.isAddon && this.state.mainOrderValue > 0) {
                    addonDiscountPercent = this.getAddonDiscount();
                    addonDiscountAmount = (priceAfterDiscount + heavyweightSurcharge) * (addonDiscountPercent / 100);
                }

                // Calculate program account discount (25% off everything except LTM)
                let programDiscountAmount = 0;
                if (this.state.isProgramAccount) {
                    // Apply program discount to base price after other discounts
                    const priceBeforeProgramDiscount = priceAfterDiscount + heavyweightSurcharge - addonDiscountAmount;
                    programDiscountAmount = priceBeforeProgramDiscount * 0.25;
                }

                // Final calculations
                const finalPricePerPiece = priceAfterDiscount + heavyweightSurcharge + ltmPerUnit - addonDiscountAmount - programDiscountAmount;
                const totalCost = finalPricePerPiece * quantity;

                // Update display
                this.elements.priceDisplay.classList.remove('prompt');
                this.elements.priceDisplay.textContent = `$${finalPricePerPiece.toFixed(2)}`;
                
                // Update summary
                this.elements.basePrice.textContent = `$${basePrice.toFixed(2)}`;
                
                // Cap discount
                if (this.state.itemType === 'caps') {
                    this.elements.capDiscountRow.style.display = 'flex';
                    this.elements.capDiscount.textContent = `-$${capDiscountAmount.toFixed(2)}`;
                } else {
                    this.elements.capDiscountRow.style.display = 'none';
                }

                // Heavyweight surcharge
                if (heavyweightSurcharge > 0) {
                    this.elements.heavyweightRow.style.display = 'flex';
                    this.elements.heavyweightCharge.textContent = `+$${heavyweightSurcharge.toFixed(2)}`;
                } else {
                    this.elements.heavyweightRow.style.display = 'none';
                }

                // LTM fee
                if (ltmFeeTotal > 0) {
                    this.elements.ltmRow.style.display = 'flex';
                    this.elements.ltmCharge.textContent = `+$${ltmPerUnit.toFixed(2)}`;
                    this.elements.ltmWarning.style.display = 'flex';
                    this.elements.ltmMessage.textContent = 
                        `Less than minimum charge of $${ltmFeeTotal.toFixed(2)} has been applied ($${ltmPerUnit.toFixed(2)}/piece)`;
                } else {
                    this.elements.ltmRow.style.display = 'none';
                    this.elements.ltmWarning.style.display = 'none';
                }

                // Add-on discount
                if (addonDiscountAmount > 0) {
                    this.elements.addonDiscountRow.style.display = 'flex';
                    this.elements.addonDiscountLabel.textContent = `Add-on Discount (${addonDiscountPercent}%):`;
                    this.elements.addonDiscount.textContent = `-$${addonDiscountAmount.toFixed(2)}`;
                } else {
                    this.elements.addonDiscountRow.style.display = 'none';
                }

                // Program discount
                if (programDiscountAmount > 0) {
                    this.elements.programDiscountRow.style.display = 'flex';
                    this.elements.programDiscount.textContent = `-$${programDiscountAmount.toFixed(2)}`;
                } else {
                    this.elements.programDiscountRow.style.display = 'none';
                }

                this.elements.totalDisplay.textContent = `$${totalCost.toFixed(2)}`;
                this.elements.emailQuoteBtn.style.display = 'block';

                // Update add-on summary
                if (this.state.isAddon) {
                    this.updateAddonSummary();
                }

                // Store current quote data
                this.currentQuote = {
                    itemType: this.state.itemType,
                    quantity: quantity,
                    isHeavyweight: this.state.isHeavyweight,
                    basePrice: basePrice,
                    capDiscountAmount: capDiscountAmount,
                    priceAfterDiscount: priceAfterDiscount,
                    heavyweightSurcharge: heavyweightSurcharge,
                    ltmFeeTotal: ltmFeeTotal,
                    ltmPerUnit: ltmPerUnit,
                    unitPrice: finalPricePerPiece,
                    totalCost: totalCost,
                    // Add-on specific data
                    isAddon: this.state.isAddon,
                    mainOrderQty: this.state.mainOrderQty,
                    mainOrderValue: this.state.mainOrderValue,
                    addonDiscountPercent: addonDiscountPercent,
                    addonDiscountAmount: addonDiscountAmount,
                    // Program account data
                    isProgramAccount: this.state.isProgramAccount,
                    programDiscountAmount: programDiscountAmount
                };
            }

            resetDisplay(promptText) {
                this.elements.priceDisplay.textContent = promptText;
                this.elements.priceDisplay.classList.add('prompt');
                this.elements.totalDisplay.textContent = "$0.00";
                this.elements.basePrice.textContent = "$0.00";
                this.elements.emailQuoteBtn.style.display = 'none';
                this.elements.capDiscountRow.style.display = 'none';
                this.elements.heavyweightRow.style.display = 'none';
                this.elements.ltmRow.style.display = 'none';
                this.elements.ltmWarning.style.display = 'none';
                this.elements.addonDiscountRow.style.display = 'none';
                this.elements.programDiscountRow.style.display = 'none';
                this.currentQuote = null;
            }

            showEmailForm() {
                // Update quote preview
                this.updateQuotePreview();
                // Open modal
                openEmailModal();
            }

            hideEmailForm() {
                closeEmailModal();
            }

            updateQuotePreview() {
                if (!this.currentQuote) return;
                
                const preview = `
                    <p><strong>Item:</strong> ${this.currentQuote.itemType === 'caps' ? 'Caps' : 'Flats'} ${this.currentQuote.isHeavyweight ? '(Heavyweight)' : ''}</p>
                    <p><strong>Quantity:</strong> ${this.currentQuote.quantity}</p>
                    <p><strong>Unit Price:</strong> $${this.currentQuote.unitPrice.toFixed(2)}</p>
                    <p><strong>Total:</strong> $${this.currentQuote.totalCost.toFixed(2)}</p>
                    ${this.currentQuote.isAddon ? '<p><strong>Type:</strong> Add-on Order</p>' : ''}
                    ${this.currentQuote.isProgramAccount ? '<p><strong>Type:</strong> Program Account</p>' : ''}
                `;
                this.elements.quotePreview.innerHTML = preview;
            }

            async sendQuote() {
                // Validate required fields
                if (!this.elements.customerName.value || !this.elements.customerEmail.value) {
                    alert('Please fill in all required fields');
                    return;
                }

                if (!this.currentQuote) {
                    alert('Please calculate a quote first');
                    return;
                }

                const submitBtn = this.elements.sendEmailBtn;
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner"></span> Sending...';
                submitBtn.disabled = true;

                try {
                    // Get sales rep info
                    const salesRepEmail = this.elements.salesRep.value;
                    const salesRepOption = this.elements.salesRep.options[this.elements.salesRep.selectedIndex];
                    const salesRepName = salesRepOption.text.replace(' (Embroidery)', '');
                    
                    // Prepare quote data
                    const quoteData = {
                        ...this.currentQuote,
                        customerName: this.elements.customerName.value,
                        customerEmail: this.elements.customerEmail.value,
                        companyName: this.elements.companyName.value || 'Not Provided',
                        customerPhone: this.elements.customerPhone.value || '',
                        projectName: this.elements.projectName.value || '',
                        salesRepName: salesRepName,
                        salesRepEmail: salesRepEmail,
                        notes: this.elements.notes.value || ''
                    };

                    // Save to database
                    const result = await this.quoteService.saveQuote(quoteData);
                    const quoteID = result.quoteID;

                    // Prepare email data
                    const emailData = {
                        to_email: quoteData.customerEmail,
                        to_name: quoteData.customerName,
                        from_name: 'Northwest Custom Apparel',
                        reply_to: salesRepEmail,
                        quote_type: 'Customer Supplied Embroidery',
                        
                        // Quote details
                        quote_id: quoteID,
                        quote_date: new Date().toLocaleDateString(),
                        expires_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                        
                        // Customer info
                        customer_name: quoteData.customerName,
                        company_name: quoteData.companyName,
                        customer_email: quoteData.customerEmail,
                        customer_phone: quoteData.customerPhone || 'Not provided',
                        project_name: quoteData.projectName || 'Not specified',
                        
                        // Item details
                        item_type: quoteData.itemType === 'caps' ? 'Caps' : 'Flats (Jackets, etc.)',
                        quantity: quoteData.quantity.toString(),
                        heavyweight: quoteData.isHeavyweight ? '(Heavyweight)' : '',
                        notes: quoteData.notes || 'None',
                        
                        // Pricing breakdown
                        base_price: `$${quoteData.basePrice.toFixed(2)}`,
                        cap_discount: quoteData.capDiscountAmount > 0 ? `-$${quoteData.capDiscountAmount.toFixed(2)}` : 'N/A',
                        heavyweight_charge: quoteData.heavyweightSurcharge > 0 ? `+$${quoteData.heavyweightSurcharge.toFixed(2)}` : 'N/A',
                        ltm_fee: quoteData.ltmFeeTotal > 0 ? `$${quoteData.ltmFeeTotal.toFixed(2)} ($${quoteData.ltmPerUnit.toFixed(2)}/piece)` : 'N/A',
                        addon_discount: quoteData.addonDiscountAmount > 0 ? `-$${quoteData.addonDiscountAmount.toFixed(2)} (${quoteData.addonDiscountPercent}%)` : 'N/A',
                        program_discount: quoteData.programDiscountAmount > 0 ? `-$${quoteData.programDiscountAmount.toFixed(2)} (25%)` : 'N/A',
                        unit_price: `$${quoteData.unitPrice.toFixed(2)}`,
                        total_price: `$${quoteData.totalCost.toFixed(2)}`,
                        
                        // Add-on order details
                        is_addon: quoteData.isAddon ? 'Yes' : 'No',
                        main_order_qty: quoteData.mainOrderQty ? quoteData.mainOrderQty.toString() : 'N/A',
                        main_order_value: quoteData.mainOrderValue > 0 ? `$${quoteData.mainOrderValue.toFixed(2)}` : 'N/A',
                        total_combined_qty: quoteData.isAddon ? (quoteData.mainOrderQty + quoteData.quantity).toString() : quoteData.quantity.toString(),
                        
                        // Program account
                        is_program_account: quoteData.isProgramAccount ? 'Yes' : 'No',
                        
                        // Sales rep info
                        sales_rep_name: quoteData.salesRepName,
                        sales_rep_email: quoteData.salesRepEmail,
                        sales_rep_phone: '253-922-5793',
                        
                        // Company info
                        company_logo: 'https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1',
                        company_year: '1977',
                        
                        // Special notice for customer supplied
                        special_notice: 'IMPORTANT: Northwest Custom Apparel is not responsible for damage to customer supplied garments during production.',
                        
                        // Required grand_total variable
                        grand_total: `$${quoteData.totalCost.toFixed(2)}`,
                        
                        // Generate HTML for products section
                        products_html: this.generateQuoteHTML(quoteData)
                    };

                    // Send email
                    await emailjs.send(
                        CALCULATOR_CONFIG.emailServiceId,
                        CALCULATOR_CONFIG.emailTemplateId,
                        emailData
                    );

                    // Show success
                    this.showSuccessModal(quoteID);
                    this.hideEmailForm();

                } catch (error) {
                    console.error('Error sending quote:', error);
                    alert('Error sending quote. Please try again or contact support.');
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }

            generateQuoteHTML(quoteData) {
                let html = `
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background-color: #f3f4f6;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Description</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">Qty</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Unit Price</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #e5e7eb;">
                                    Customer Supplied ${quoteData.itemType === 'caps' ? 'Caps' : 'Garments'} - Embroidery
                                    ${quoteData.isHeavyweight ? '<br><small>(Heavyweight Item)</small>' : ''}
                                    ${quoteData.isAddon ? '<br><small style="color: #4cb354;">Add-on Order</small>' : ''}
                                    ${quoteData.isProgramAccount ? '<br><small style="color: #7c3aed;">Program Account</small>' : ''}
                                </td>
                                <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">${quoteData.quantity}</td>
                                <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">$${quoteData.unitPrice.toFixed(2)}</td>
                                <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">$${quoteData.totalCost.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin: 20px 0;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Price Breakdown:</h4>
                        <table style="width: 100%;">
                            <tr><td style="padding: 4px 0;">Base Price:</td><td style="text-align: right;">$${quoteData.basePrice.toFixed(2)}</td></tr>
                            ${quoteData.capDiscountAmount > 0 ? `<tr><td style="padding: 4px 0;">Cap Discount (20%):</td><td style="text-align: right; color: #10b981;">-$${quoteData.capDiscountAmount.toFixed(2)}</td></tr>` : ''}
                            ${quoteData.heavyweightSurcharge > 0 ? `<tr><td style="padding: 4px 0;">Heavyweight Surcharge:</td><td style="text-align: right;">+$${quoteData.heavyweightSurcharge.toFixed(2)}</td></tr>` : ''}
                            ${quoteData.ltmFeeTotal > 0 ? `<tr><td style="padding: 4px 0;">Less Than Minimum Fee:</td><td style="text-align: right;">+$${quoteData.ltmPerUnit.toFixed(2)}/pc</td></tr>` : ''}
                            ${quoteData.addonDiscountAmount > 0 ? `<tr><td style="padding: 4px 0;">Add-on Discount (${quoteData.addonDiscountPercent}%):</td><td style="text-align: right; color: #10b981;">-$${quoteData.addonDiscountAmount.toFixed(2)}</td></tr>` : ''}
                            ${quoteData.programDiscountAmount > 0 ? `<tr><td style="padding: 4px 0;">Program Account Discount (25%):</td><td style="text-align: right; color: #10b981;">-$${quoteData.programDiscountAmount.toFixed(2)}</td></tr>` : ''}
                            <tr style="border-top: 2px solid #e5e7eb; font-weight: bold;">
                                <td style="padding: 8px 0;">Final Unit Price:</td>
                                <td style="text-align: right;">$${quoteData.unitPrice.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    ${quoteData.isAddon ? `
                    <div style="background-color: #e8f9ea; padding: 15px; border-radius: 6px; margin: 20px 0;">
                        <h4 style="margin: 0 0 10px 0; color: #4cb354;">Add-on Order Details:</h4>
                        <p style="margin: 5px 0;">Main Order Quantity: ${quoteData.mainOrderQty} items</p>
                        <p style="margin: 5px 0;">Main Order Value: $${quoteData.mainOrderValue.toFixed(2)}</p>
                        <p style="margin: 5px 0;">Customer Supplied: ${quoteData.quantity} items</p>
                        <p style="margin: 5px 0; font-weight: bold;">Total Combined Quantity: ${quoteData.mainOrderQty + quoteData.quantity} items</p>
                    </div>
                    ` : ''}
                `;
                
                return html;
            }

            showSuccessModal(quoteID) {
                // Store the quote ID and data for printing
                this.lastQuoteID = quoteID;
                
                // Update the quote ID in the success modal
                document.getElementById('successQuoteID').textContent = quoteID;
                
                // Show the success modal
                document.getElementById('successModal').classList.add('active');
            }
        }

        // Initialize calculator when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.customerEmbroideryCalculator = new CustomerEmbroideryCalculator();
        });

        // Modal functions
        function openEmailModal() {
            document.getElementById('emailModal').classList.add('active');
            document.getElementById('customerName').focus();
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.remove('active');
            // Clear form
            document.getElementById('quoteForm').reset();
            document.getElementById('quotePreview').innerHTML = '';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
        }

        // Copy quote ID to clipboard
        function copyQuoteID() {
            const quoteID = document.getElementById('successQuoteID').textContent;
            navigator.clipboard.writeText(quoteID).then(() => {
                // Change button text temporarily
                const copyBtn = event.target.closest('button');
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        // Print quote functionality
        function printQuote() {
            const calculator = window.customerEmbroideryCalculator;
            if (!calculator || !calculator.currentQuote || !calculator.lastQuoteID) {
                alert('No quote data available to print.');
                return;
            }

            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            const quote = calculator.currentQuote;
            const quoteID = calculator.lastQuoteID;
            
            // Build the print HTML
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quote ${quoteID} - Northwest Custom Apparel</title>
                    <style>
                        @page { margin: 0.5in; }
                        body { 
                            font-family: Arial, sans-serif; 
                            line-height: 1.6; 
                            color: #333;
                            margin: 0;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 2rem;
                            padding-bottom: 1rem;
                            border-bottom: 2px solid #4cb354;
                        }
                        .logo {
                            max-width: 200px;
                            height: auto;
                            margin-bottom: 1rem;
                        }
                        .quote-info {
                            background: #f8f9fa;
                            padding: 1rem;
                            border-radius: 8px;
                            margin-bottom: 1.5rem;
                        }
                        .quote-info h2 {
                            color: #4cb354;
                            margin: 0 0 0.5rem 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 1rem 0;
                        }
                        th, td {
                            padding: 0.75rem;
                            text-align: left;
                            border: 1px solid #ddd;
                        }
                        th {
                            background: #f3f4f6;
                            font-weight: 600;
                        }
                        .total-row {
                            font-weight: bold;
                            background: #f8f9fa;
                        }
                        .footer {
                            margin-top: 2rem;
                            padding-top: 1rem;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            font-size: 0.875rem;
                            color: #666;
                        }
                        .notice {
                            background: #fffbeb;
                            border: 1px solid #fde68a;
                            padding: 1rem;
                            border-radius: 8px;
                            margin: 1rem 0;
                        }
                        .notice h3 {
                            color: #92400e;
                            margin: 0 0 0.5rem 0;
                        }
                        @media print {
                            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                             alt="Northwest Custom Apparel" class="logo">
                        <h1 style="margin: 0; color: #333;">Customer Supplied Embroidery Quote</h1>
                    </div>
                    
                    <div class="quote-info">
                        <h2>Quote ID: ${quoteID}</h2>
                        <p style="margin: 0;">Date: ${new Date().toLocaleDateString()}</p>
                        <p style="margin: 0;">Valid for 30 days</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th style="text-align: center;">Quantity</th>
                                <th style="text-align: right;">Unit Price</th>
                                <th style="text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    Customer Supplied ${quote.itemType === 'caps' ? 'Caps' : 'Garments'} - Embroidery
                                    ${quote.isHeavyweight ? '<br><small>(Heavyweight Item)</small>' : ''}
                                    ${quote.isAddon ? '<br><small style="color: #4cb354;">Add-on Order</small>' : ''}
                                    ${quote.isProgramAccount ? '<br><small style="color: #7c3aed;">Program Account</small>' : ''}
                                </td>
                                <td style="text-align: center;">${quote.quantity}</td>
                                <td style="text-align: right;">$${quote.unitPrice.toFixed(2)}</td>
                                <td style="text-align: right;">$${quote.totalCost.toFixed(2)}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3" style="text-align: right;">TOTAL:</td>
                                <td style="text-align: right;">$${quote.totalCost.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="notice">
                        <h3>Important Notice: Customer Supplied Garments</h3>
                        <p style="margin: 0;">Northwest Custom Apparel is not responsible for the damage of ANY customer supplied garments during the production process. Should items be damaged while in our facility, Northwest Custom Apparel WILL NOT reimburse you for the value of the garments or replace them.</p>
                    </div>
                    
                    <div class="footer">
                        <p><strong>Northwest Custom Apparel</strong></p>
                        <p>2025 Freeman Road East, Milton, WA 98354</p>
                        <p>Phone: 253-922-5793 | Email: sales@nwcustomapparel.com</p>
                        <p>www.nwcustomapparel.com</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                printWindow.print();
                // Close the window after printing (optional)
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }
    </script>
</body>
</html>