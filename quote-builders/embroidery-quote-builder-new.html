<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Embroidery Quote Builder | Northwest Custom Apparel</title>

    <!-- NWCA Favicon -->
    <link rel="icon" type="image/png" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Power Quote Styles (inline for now, will move to separate file) -->
    <style>
        :root {
            --nwca-blue: #003f7f;
            --nwca-green: #28a745;
            --nwca-red: #dc3545;
            --border-color: #dee2e6;
            --bg-light: #f8f9fa;
            --bg-sidebar: #f1f3f5;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        /* Compact Header */
        .power-header {
            background: var(--nwca-blue);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .power-header .logo {
            height: 40px;
        }

        .power-header .header-actions {
            display: flex;
            gap: 10px;
        }

        .power-header .btn-header {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .power-header .btn-header:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .power-main {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        .power-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .power-sidebar {
            width: 300px;
            background: var(--bg-sidebar);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Logo Preset Bar */
        /* Logo Configuration Section */
        .logo-section {
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
        }

        .primary-logo-config {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }

        .logo-section-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            min-width: 120px;
        }

        .logo-section-label i {
            margin-right: 6px;
            color: var(--nwca-green);
        }

        .logo-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        .logo-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .stitch-input-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .stitch-input-group input {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .digitizing-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        .digitizing-label input {
            cursor: pointer;
        }

        /* Additional Logos Section */
        .additional-logos-section {
            padding-top: 12px;
            border-top: 1px dashed #ddd;
        }

        .al-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .add-logo-btn {
            padding: 6px 14px;
            background: var(--nwca-green);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .add-logo-btn:hover {
            background: #3da344;
        }

        .additional-logos-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .no-logos {
            color: #999;
            font-size: 12px;
            font-style: italic;
            padding: 8px;
        }

        .additional-logo-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }

        .additional-logo-row select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .additional-logo-row .stitch-input-group input {
            width: 70px;
            padding: 5px 8px;
            font-size: 12px;
        }

        .additional-logo-row .stitch-input-group span {
            font-size: 11px;
            color: #666;
        }

        .al-digitizing {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .al-price {
            font-weight: 600;
            color: var(--nwca-green);
            min-width: 75px;
            font-size: 13px;
        }

        .remove-al-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 14px;
            transition: color 0.2s;
        }

        .remove-al-btn:hover {
            color: #a71d2a;
        }

        /* Legacy preset-btn kept for any remaining uses */
        .preset-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .preset-btn:hover {
            border-color: var(--nwca-blue);
            background: #f0f7ff;
        }

        .preset-btn.active {
            border-color: var(--nwca-blue);
            background: var(--nwca-blue);
            color: white;
        }

        .preset-btn i {
            font-size: 12px;
        }

        .logo-config-display {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 13px;
            color: #666;
        }

        .logo-config-display strong {
            color: #333;
        }

        .digitizing-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .digitizing-toggle input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Product Grid Section */
        .product-grid-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px 20px;
            overflow: hidden;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--nwca-blue);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .suggestion-item:hover {
            background: #f5f5f5;
        }

        .suggestion-item .style {
            font-weight: 600;
        }

        .suggestion-item .name {
            color: #666;
            font-size: 13px;
        }

        /* Keyboard navigation selection state */
        .suggestion-item.selected {
            background-color: #e3f2fd;
        }

        /* Highlight matched text in search results */
        .suggestion-item .style strong {
            color: #1976d2;
            font-weight: 700;
        }

        /* Excel-Style Product Table */
        .product-table-wrapper {
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .product-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .product-table th {
            background: #2c3e50;
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            border-right: 1px solid #34495e;
            white-space: nowrap;
        }

        .product-table th:first-child {
            text-align: left;
            padding-left: 12px;
        }

        .product-table th.size-col {
            width: 55px;
            min-width: 55px;
        }

        .product-table th.style-col {
            width: 100px;
        }

        .product-table th.desc-col {
            width: auto;
            min-width: 180px;
        }

        .product-table th.color-col {
            width: 200px;
            min-width: 200px;
        }

        .product-table th.qty-col {
            width: 60px;
            background: #1a5276;
        }

        .product-table th.price-col {
            width: 80px;
            background: #1e8449;
        }

        .product-table th.actions-col {
            width: 40px;
            background: #7f8c8d;
        }

        .product-table td {
            padding: 0;
            border: 1px solid #e0e0e0;
            vertical-align: middle;
        }

        .product-table tr:nth-child(even) {
            background: #fafafa;
        }

        .product-table tr:hover {
            background: #fff8e1;
        }

        .product-table tr.new-row {
            background: #e8f5e9;
        }

        /* Child rows for extended sizes (2XL+) */
        .product-table tr.child-row {
            background: #fafafa;
        }

        .product-table tr.child-row td:first-child {
            padding-left: 25px;
        }

        /* Child row style display (part number) */
        .product-table tr.child-row .style-display {
            color: #888;
            font-size: 12px;
        }

        /* Child row description display (product name + size) */
        .product-table tr.child-row .desc-display {
            color: #666;
            font-size: 12px;
        }

        /* Add padding to child row description cell */
        .product-table tr.child-row td:nth-child(2) {
            padding-left: 8px;
        }

        .product-table tr.child-row .cell-input,
        .product-table tr.child-row .cell-select {
            background: #fafafa;
        }

        .product-table tr.child-row .size-input:disabled {
            background: #f5f5f5;
            color: #999;
        }

        /* Make editable input in child rows visually obvious with green border */
        .product-table tr.child-row .size-input:not([disabled]) {
            background: #fff !important;
            border: 2px solid #4CAF50 !important;
            font-weight: bold;
        }

        .child-indicator {
            font-size: 10px;
            color: #ccc;
            margin-right: 5px;
        }

        /* Child row color picker styling */
        .child-color-picker .color-picker-selected {
            background: #fafafa;
            padding: 4px 6px;
            height: 32px;
        }

        .child-color-picker .color-picker-selected:hover {
            background: #f0f0f0;
        }

        .child-color-picker .color-swatch {
            width: 18px;
            height: 18px;
        }

        .child-color-picker .color-name {
            font-size: 12px;
        }

        /* Visual indicator when child has different color than parent */
        .product-table tr.child-row.different-color {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .product-table tr.child-row.different-color td:first-child {
            color: #856404;
            font-weight: 600;
        }

        /* Parent/Child Row Visual Grouping */
        .product-table tr.parent-row {
            border-left: 4px solid var(--nwca-blue);
        }

        .product-table tr.child-row {
            border-left: 4px solid var(--nwca-blue);
        }

        /* Tree structure indicator for child rows */
        .product-table tr.child-row td:first-child::before {
            content: "â””";
            color: #999;
            margin-right: 6px;
            font-family: monospace;
            font-size: 14px;
        }

        /* Last child row gets bottom border */
        .product-table tr.child-row:last-of-type,
        .product-table tr.child-row + tr:not(.child-row) {
            border-bottom: 2px solid var(--border-color);
        }

        /* Size badge for extended sizes */
        .size-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--nwca-blue);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .size-badge.upcharge {
            background: #f59e0b;
        }

        /* Upcharge indicator */
        .upcharge-indicator {
            color: #f59e0b;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }

        /* Cell inputs - Excel style */
        .cell-input {
            width: 100%;
            height: 36px;
            border: none;
            padding: 0 8px;
            font-size: 13px;
            background: transparent;
            text-align: center;
        }

        .cell-input:focus {
            outline: none;
            background: #fff;
            box-shadow: inset 0 0 0 2px var(--nwca-blue);
        }

        .cell-input.style-input {
            text-align: left;
            font-weight: 600;
        }

        .cell-input.desc-input {
            text-align: left;
            color: #666;
        }

        .cell-input.size-input {
            text-align: center;
        }

        .cell-input.size-input::-webkit-inner-spin-button,
        .cell-input.size-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Size Input Validation States */
        .size-input.size-available {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .size-input.size-available:focus {
            box-shadow: inset 0 0 0 2px #22c55e;
        }

        .size-input.size-unavailable {
            background-color: #f0f0f0 !important;
            color: #999 !important;
            cursor: not-allowed;
            border-color: #ddd !important;
        }

        .size-input.size-unavailable::placeholder {
            color: #bbb;
        }

        /* Inventory Status Indicators */
        .size-input.inventory-ok {
            border-left: 3px solid #22c55e;
        }

        .size-input.inventory-low {
            border-left: 3px solid #f59e0b;
        }

        .size-input.inventory-out {
            border-left: 3px solid #ef4444;
            background: #fef2f2;
        }

        .cell-select {
            width: 100%;
            height: 36px;
            border: none;
            padding: 0 4px;
            font-size: 13px;
            background: transparent;
            cursor: pointer;
        }

        .cell-select:focus {
            outline: none;
            box-shadow: inset 0 0 0 2px var(--nwca-blue);
        }

        /* Custom Color Picker with Swatches */
        .color-picker-wrapper {
            position: relative;
            width: 100%;
        }

        .color-picker-selected {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
            height: 36px;
        }

        .color-picker-selected.disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .color-picker-selected:hover:not(.disabled) {
            background: #f0f7ff;
        }

        .color-picker-selected .color-swatch {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }

        .color-picker-selected .color-swatch.empty {
            background: linear-gradient(135deg, #eee 25%, #ddd 25%, #ddd 50%, #eee 50%, #eee 75%, #ddd 75%);
            background-size: 8px 8px;
        }

        .color-picker-selected .color-name {
            flex: 1;
            text-align: left;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #333;
        }

        .color-picker-selected .color-name.placeholder {
            color: #999;
        }

        .color-picker-selected .picker-arrow {
            color: #666;
            font-size: 10px;
            flex-shrink: 0;
        }

        .color-picker-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 220px;
            max-height: 280px;
            overflow-y: auto;
            background: white;
            border: 2px solid var(--nwca-blue);
            border-radius: 6px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .color-picker-dropdown.hidden {
            display: none;
        }

        .color-picker-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .color-picker-option:last-child {
            border-bottom: none;
        }

        .color-picker-option:hover {
            background: #e8f4fd;
        }

        .color-picker-option.focused {
            background: #d0e8fa;
            outline: 2px solid var(--nwca-blue);
            outline-offset: -2px;
        }

        .color-picker-option.selected {
            background: #e8f5e9;
            font-weight: 600;
        }

        .color-picker-option .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }

        .color-picker-option .color-name {
            font-size: 13px;
            color: #333;
        }

        .cell-qty {
            font-weight: 700;
            text-align: center;
            padding: 0 8px;
            background: #e3f2fd;
        }

        .cell-price {
            font-weight: 600;
            text-align: right;
            padding: 0 10px;
            color: var(--nwca-green);
            background: #e8f5e9;
        }

        .cell-actions {
            text-align: center;
        }

        .btn-delete-row {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 8px;
            font-size: 14px;
        }

        .btn-delete-row:hover {
            color: var(--nwca-red);
        }

        /* Add row button */
        .add-row-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 0 0 6px 6px;
            cursor: pointer;
            color: #666;
            font-size: 13px;
            transition: all 0.2s;
        }

        .add-row-btn:hover {
            background: #e8f5e9;
            border-color: var(--nwca-green);
            color: var(--nwca-green);
        }

        /* Pricing Sidebar */
        .pricing-panel {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .pricing-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pricing-title i {
            color: var(--nwca-green);
        }

        .pricing-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        .pricing-row.total {
            font-size: 18px;
            font-weight: 700;
            color: var(--nwca-blue);
            border-top: 2px solid var(--nwca-blue);
            border-bottom: none;
            padding-top: 15px;
            margin-top: 10px;
        }

        .pricing-row .label {
            color: #666;
        }

        .pricing-row .value {
            font-weight: 600;
        }

        /* LTM Distribution Toggle Button */
        .ltm-value-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ltm-distribute-btn {
            padding: 4px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #666;
        }

        .ltm-distribute-btn .btn-text {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .ltm-distribute-btn:hover {
            border-color: var(--nwca-green);
            color: var(--nwca-green);
            background: #f0fdf4;
        }

        .ltm-distribute-btn.active {
            background: var(--nwca-green);
            border-color: var(--nwca-green);
            color: white;
        }

        /* Distributed value style - shows per-unit amount */
        #ltm-fee.distributed {
            color: var(--nwca-green);
            font-style: italic;
            font-size: 12px;
        }

        .tier-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--nwca-blue);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Customer Info Panel */
        .customer-panel {
            border-top: 1px solid var(--border-color);
            padding: 15px 20px;
            background: white;
        }

        .customer-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .customer-panel-header h4 {
            margin: 0;
            font-size: 14px;
            color: #333;
        }

        .customer-fields {
            display: grid;
            gap: 10px;
        }

        .customer-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .customer-field label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }

        .customer-field input,
        .customer-field select {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
        }

        .customer-field input:focus,
        .customer-field select:focus {
            outline: none;
            border-color: var(--nwca-blue);
        }

        /* Action Buttons */
        .action-panel {
            padding: 15px 20px;
            background: #2c3e50;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-action {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary-action {
            background: var(--nwca-green);
            color: white;
        }

        .btn-primary-action:hover {
            background: #218838;
        }

        .btn-secondary-action {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .btn-secondary-action:hover {
            background: rgba(255,255,255,0.2);
        }

        .action-row {
            display: flex;
            gap: 10px;
        }

        .action-row .btn-action {
            flex: 1;
        }

        /* Coming Soon Accordion */
        .coming-soon-accordion {
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .coming-soon-header {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .coming-soon-header:hover {
            background: rgba(255,255,255,0.1);
        }

        .coming-soon-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coming-soon-title i {
            font-size: 16px;
        }

        .coming-soon-chevron {
            transition: transform 0.3s ease;
        }

        .coming-soon-chevron.rotated {
            transform: rotate(180deg);
        }

        .coming-soon-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(255,255,255,0.95);
        }

        .coming-soon-content.open {
            max-height: 600px;
        }

        .coming-soon-description {
            padding: 15px;
            color: #333;
        }

        .coming-soon-description p {
            margin: 0 0 10px 0;
            font-size: 13px;
            color: #666;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
        }

        .feature-list li {
            padding: 8px 0;
            font-size: 13px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px dashed #e0e0e0;
        }

        .feature-list li:last-child {
            border-bottom: none;
        }

        .feature-list li i {
            color: #667eea;
            width: 20px;
            text-align: center;
        }

        .coming-soon-note {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 6px;
            color: #2e7d32 !important;
            font-weight: 500;
        }

        .coming-soon-disabled {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .coming-soon-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .coming-soon-badge-small {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 5px;
        }

        .coming-soon-disabled .customer-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Logo Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: var(--nwca-green);
        }

        .toast.error {
            background: var(--nwca-red);
        }

        .toast.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        /* OSFA-only row styling */
        .osfa-only-row td.size-disabled {
            background-color: #f5f5f5;
        }

        .osfa-only-row td.size-disabled input {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .osfa-qty-input {
            width: 60px !important;
            text-align: center;
            font-weight: 600;
            background-color: #fff !important;
            cursor: text !important;
        }

        /* Cap badge indicator */
        .desc-cell {
            position: relative;
        }

        .cap-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            white-space: nowrap;
            vertical-align: middle;
        }

        .cap-badge i {
            font-size: 10px;
        }

        /* Size label override for non-standard columns */
        .size-label-override {
            display: block;
            font-size: 9px;
            color: #666;
            text-align: center;
            margin-bottom: 2px;
            font-weight: 600;
        }

        /* Visual indicator for non-standard products */
        tr[data-size-category="osfa-only"] {
            background-color: #f8f9fa;
        }

        tr[data-size-category="combo-only"],
        tr[data-size-category="youth-only"],
        tr[data-size-category="toddler-only"],
        tr[data-size-category="tall-only"] {
            background-color: #fff9e6;
        }

        /* Size-disabled cells */
        td.size-disabled input {
            background-color: #f5f5f5 !important;
            color: #999 !important;
            cursor: not-allowed !important;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Keyboard hint */
        .keyboard-hint {
            font-size: 11px;
            color: #999;
            text-align: center;
            padding: 8px;
            background: #f5f5f5;
            border-top: 1px solid var(--border-color);
        }

        .keyboard-hint kbd {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        /* Extended Size Picker Popup */
        .size-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid var(--nwca-blue);
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 2000;
            min-width: 480px;
            max-width: 520px;
        }
        .size-popup.hidden { display: none; }

        .size-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--nwca-blue);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        .size-popup-header h4 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .size-popup-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .size-popup-close:hover { opacity: 0.8; }

        .size-popup-hint {
            font-size: 12px;
            color: #666;
            margin: 12px 16px 8px;
            padding: 0;
        }

        .size-popup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 12px 16px;
            min-height: 60px;
        }
        .size-popup-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .size-popup-item label {
            font-weight: 600;
            font-size: 14px;
            color: var(--nwca-blue);
            min-width: 45px;
        }
        .size-popup-item input {
            width: 60px;
            padding: 6px 8px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .size-popup-item input:focus {
            border-color: var(--nwca-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 63, 127, 0.2);
        }

        /* Pants waist group styles */
        .pants-waist-group {
            grid-column: 1 / -1;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        .waist-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--nwca-blue);
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            user-select: none;
        }
        .waist-header:hover {
            background: #002a56;
        }
        .waist-header i {
            width: 12px;
            text-align: center;
        }
        .waist-count {
            margin-left: auto;
            font-weight: normal;
            font-size: 12px;
            opacity: 0.8;
        }
        .waist-sizes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 10px;
            background: #f8f9fa;
        }
        .waist-sizes .size-popup-item {
            margin: 0;
        }
        /* Max height for pants popup grid with scroll */
        .size-popup-grid:has(.pants-waist-group) {
            max-height: 400px;
            overflow-y: auto;
        }

        .size-popup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 10px 10px;
        }
        .size-popup-cancel {
            padding: 10px 20px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .size-popup-cancel:hover { background: #f0f0f0; }
        .size-popup-apply {
            padding: 10px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .size-popup-apply:hover { background: #218838; }
        .size-popup-apply:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Loading state for popup */
        .size-popup-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            color: #666;
            gap: 10px;
        }
        .size-popup-loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e0e0e0;
            border-top-color: var(--nwca-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* No sizes available message */
        .size-popup-empty {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        /* XXXL cell clickable style */
        .xxxl-picker-btn {
            cursor: pointer !important;
            background: #e8f4fd !important;
            border: 1px dashed var(--nwca-blue) !important;
            color: var(--nwca-blue) !important;
            font-weight: 600;
        }
        .xxxl-picker-btn:hover {
            background: #d0e8fa !important;
        }
        .xxxl-picker-btn::placeholder {
            color: var(--nwca-blue);
            opacity: 0.7;
        }

        /* Popup backdrop */
        .size-popup-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1999;
        }
        .size-popup-backdrop.hidden { display: none; }

        /* Loading state */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: var(--nwca-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Compact Header -->
    <header class="power-header">
        <a href="/staff-dashboard.html">
            <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1"
                 alt="Northwest Custom Apparel"
                 class="logo">
        </a>
        <div style="font-size: 18px; font-weight: 600;">2026 Embroidery Quote Builder</div>
        <div class="header-actions">
            <button class="btn-header" onclick="window.location.href='/staff-dashboard.html'">
                <i class="fas fa-arrow-left"></i> Dashboard
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="power-main">
        <!-- Left: Content Area -->
        <div class="power-content">
            <!-- Logo Configuration Section -->
            <div class="logo-section">
                <!-- Primary Logo -->
                <div class="primary-logo-config">
                    <span class="logo-section-label"><i class="fas fa-palette"></i> Primary Logo</span>
                    <div class="logo-controls">
                        <select id="primary-position" class="logo-select">
                            <option value="Left Chest" selected>Left Chest</option>
                            <option value="Right Chest">Right Chest</option>
                            <option value="Center Chest">Center Chest</option>
                        </select>
                        <div class="stitch-input-group">
                            <label>Stitches:</label>
                            <input type="number" id="primary-stitches" value="8000"
                                   min="1000" max="50000" step="1000">
                        </div>
                        <label class="digitizing-label">
                            <input type="checkbox" id="primary-digitizing">
                            Digitizing ($100)
                        </label>
                    </div>
                </div>

                <!-- Additional Logos -->
                <div class="additional-logos-section">
                    <div class="al-section-header">
                        <span class="logo-section-label">Additional Logos</span>
                        <button id="add-logo-btn" class="add-logo-btn" onclick="addAdditionalLogo()">
                            <i class="fas fa-plus"></i> Add Logo
                        </button>
                    </div>
                    <div id="additional-logos-list" class="additional-logos-list">
                        <div class="no-logos">No additional logos added</div>
                    </div>
                </div>
            </div>

            <!-- Product Grid Section -->
            <div class="product-grid-section">
                <!-- Search Row -->
                <div class="search-row">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               id="product-search"
                               class="search-input"
                               placeholder="Type style # to add (e.g., PC54, G500...)"
                               autocomplete="off">
                        <div id="search-suggestions" class="search-suggestions"></div>
                    </div>
                </div>

                <!-- Excel-Style Product Table -->
                <div class="product-table-wrapper">
                    <table class="product-table" id="product-table">
                        <thead>
                            <tr>
                                <th class="style-col">Style</th>
                                <th class="desc-col">Description</th>
                                <th class="color-col">Color</th>
                                <th class="size-col">S</th>
                                <th class="size-col">M</th>
                                <th class="size-col">LG</th>
                                <th class="size-col">XL</th>
                                <th class="size-col">XXL</th>
                                <th class="size-col" style="line-height: 1.1;">XXXL<br><span style="font-size: 10px; font-weight: 400;">(Other)</span></th>
                                <th class="qty-col">Qty</th>
                                <th class="price-col">Unit $</th>
                                <th class="actions-col"></th>
                            </tr>
                        </thead>
                        <tbody id="product-tbody">
                            <!-- Product rows will be added here -->
                        </tbody>
                    </table>
                </div>

                <!-- Add Row Button -->
                <button class="add-row-btn" onclick="addNewRow()">
                    <i class="fas fa-plus"></i> Add Product (or press Tab from last cell)
                </button>

                <!-- Keyboard Hints -->
                <div class="keyboard-hint">
                    <kbd>Tab</kbd> Next cell &nbsp;|&nbsp;
                    <kbd>Enter</kbd> Next row &nbsp;|&nbsp;
                    <kbd>Ctrl+S</kbd> Save &nbsp;|&nbsp;
                    <kbd>Ctrl+P</kbd> Print PDF
                </div>

                <!-- Extended Size Picker Backdrop -->
                <div id="size-popup-backdrop" class="size-popup-backdrop hidden" onclick="closeExtendedSizePopup()"></div>

                <!-- Extended Size Picker Popup (for Size06/Other sizes) -->
                <div id="extended-size-popup" class="size-popup hidden">
                    <div class="size-popup-header">
                        <h4><i class="fas fa-ruler"></i> Extended Sizes (Size06)</h4>
                        <button class="size-popup-close" onclick="closeExtendedSizePopup()">&times;</button>
                    </div>
                    <p class="size-popup-hint">Enter quantities for extended sizes. These create separate line items.</p>
                    <div class="size-popup-grid" id="size-popup-grid">
                        <!-- Size inputs generated dynamically -->
                    </div>
                    <div class="size-popup-actions">
                        <button class="size-popup-cancel" onclick="closeExtendedSizePopup()">Cancel</button>
                        <button class="size-popup-apply" onclick="applyExtendedSizes()">
                            <i class="fas fa-check"></i> Apply Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Pricing Sidebar -->
        <div class="power-sidebar">
            <!-- Pricing Panel -->
            <div class="pricing-panel">
                <div class="pricing-title">
                    <i class="fas fa-calculator"></i> Quote Summary
                </div>

                <div class="pricing-row">
                    <span class="label">Total Pieces:</span>
                    <span class="value" id="total-qty">0</span>
                </div>

                <div class="pricing-row">
                    <span class="label">Pricing Tier:</span>
                    <span class="tier-badge" id="pricing-tier">1-23</span>
                </div>

                <div class="pricing-row">
                    <span class="label">Products Subtotal:</span>
                    <span class="value" id="subtotal">$0.00</span>
                </div>

                <div class="pricing-row" id="additional-stitches-row" style="display: none;">
                    <span class="label">Additional Stitches:</span>
                    <span class="value" id="additional-stitches-fee">$0.00</span>
                </div>

                <div id="additional-logos-pricing"></div>

                <div class="pricing-row" id="ltm-row" style="display: none;">
                    <span class="label">LTM Fee (&lt; 24 pcs):</span>
                    <span class="ltm-value-group">
                        <button class="ltm-distribute-btn" id="ltm-distribute-btn"
                                title="Click to hide/show LTM as separate line">
                            <span class="btn-text">Hide LTM</span>
                        </button>
                        <span class="value" id="ltm-fee">$50.00</span>
                    </span>
                </div>

                <div class="pricing-row" id="setup-row" style="display: none;">
                    <span class="label">Setup (Digitizing):</span>
                    <span class="value" id="setup-fee">$100.00</span>
                </div>

                <div class="pricing-row total">
                    <span class="label">TOTAL:</span>
                    <span class="value" id="grand-total">$0.00</span>
                </div>

            </div>

            <!-- Copy to Clipboard - Always Available -->
            <div class="action-panel">
                <button class="btn-action btn-primary-action" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i> Copy Quote to Clipboard
                </button>
            </div>

            <!-- Coming Soon Accordion -->
            <div class="coming-soon-accordion">
                <button class="coming-soon-header" onclick="toggleComingSoon()">
                    <span class="coming-soon-title">
                        <i class="fas fa-rocket"></i> New Features Coming Soon
                    </span>
                    <i class="fas fa-chevron-down coming-soon-chevron" id="coming-soon-chevron"></i>
                </button>
                <div class="coming-soon-content" id="coming-soon-content">
                    <div class="coming-soon-description">
                        <p>These features are currently in development:</p>
                        <ul class="feature-list">
                            <li><i class="fas fa-save"></i> Save quotes to database</li>
                            <li><i class="fas fa-envelope"></i> Email quotes directly to customers</li>
                            <li><i class="fas fa-print"></i> Print professional PDF quotes</li>
                            <li><i class="fas fa-user"></i> Customer info management</li>
                        </ul>
                        <p class="coming-soon-note">For now, use "Copy Quote to Clipboard" above to share quote details.</p>
                    </div>

                    <!-- Hidden Customer Info (for future use) -->
                    <div class="customer-panel coming-soon-disabled">
                        <div class="customer-panel-header">
                            <h4><i class="fas fa-user"></i> Customer Info</h4>
                            <span class="coming-soon-badge">Coming Soon</span>
                        </div>
                        <div class="customer-fields">
                            <div class="customer-field">
                                <label>Name</label>
                                <input type="text" id="customer-name" placeholder="Customer name" disabled>
                            </div>
                            <div class="customer-field">
                                <label>Email</label>
                                <input type="email" id="customer-email" placeholder="email@company.com" disabled>
                            </div>
                            <div class="customer-field">
                                <label>Company</label>
                                <input type="text" id="company-name" placeholder="Company name" disabled>
                            </div>
                            <div class="customer-field">
                                <label>Phone</label>
                                <input type="tel" id="customer-phone" placeholder="(555) 555-5555" disabled>
                            </div>
                            <div class="customer-field">
                                <label>Sales Rep</label>
                                <select id="sales-rep" disabled>
                                    <option value="sales@nwcustomapparel.com">General Sales</option>
                                    <option value="adriyella@nwcustomapparel.com">Adriyella</option>
                                    <option value="bradley@nwcustomapparel.com">Bradley Wright</option>
                                    <option value="erik@nwcustomapparel.com">Erik Mickelson</option>
                                    <option value="jim@nwcustomapparel.com">Jim Mickelson</option>
                                    <option value="nika@nwcustomapparel.com">Nika Lao</option>
                                    <option value="ruth@nwcustomapparel.com">Ruth Nhong</option>
                                    <option value="art@nwcustomapparel.com">Steve Deland</option>
                                    <option value="taneisha@nwcustomapparel.com">Taneisha Clark</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden Action Buttons (for future use) -->
                    <div class="action-panel coming-soon-disabled">
                        <button class="btn-action btn-primary-action" disabled>
                            <i class="fas fa-print"></i> Print PDF
                            <span class="coming-soon-badge-small">Soon</span>
                        </button>
                        <div class="action-row">
                            <button class="btn-action btn-secondary-action" disabled>
                                <i class="fas fa-save"></i> Save
                                <span class="coming-soon-badge-small">Soon</span>
                            </button>
                            <button class="btn-action btn-secondary-action" disabled>
                                <i class="fas fa-envelope"></i> Email
                                <span class="coming-soon-badge-small">Soon</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Logo Modal -->
    <div id="logo-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-palette"></i> Custom Logo Setup</h3>
                <button class="modal-close" onclick="closeLogoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Position</label>
                    <select id="logo-position">
                        <option value="Left Chest">Left Chest</option>
                        <option value="Right Chest">Right Chest</option>
                        <option value="Center Chest">Center Chest</option>
                        <option value="Full Front">Full Front</option>
                        <option value="Full Back">Full Back</option>
                        <option value="Upper Back">Upper Back</option>
                        <option value="Left Sleeve">Left Sleeve</option>
                        <option value="Right Sleeve">Right Sleeve</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stitch Count</label>
                    <input type="number" id="logo-stitches" value="8000" min="1000" step="1000">
                    <small style="color: #666;">Min: 1,000 | Increment: 1,000</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-action btn-secondary-action" onclick="closeLogoModal()" style="background: #6c757d;">Cancel</button>
                <button class="btn-action btn-primary-action" onclick="applyCustomLogo()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Core Dependencies -->
    <script src="/shared_components/js/embroidery-pricing-service.js"></script>
    <script src="/shared_components/js/embroidery-quote-pricing.js?v=20251219-no-monogram"></script>
    <script src="/shared_components/js/embroidery-quote-service.js"></script>
    <script src="/shared_components/js/embroidery-quote-invoice.js?v=20251219-no-monogram"></script>
    <script src="/shared_components/js/sku-validation-service.js?v=20260104"></script>

    <!-- Power Quote Controller -->
    <script>
        // ============================================================
        // EMBROIDERY POWER QUOTE - Excel-Style Quote Builder
        // ============================================================

        const API_BASE = 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com';

        // LTM Distribution Toggle State
        // When true, $50 LTM fee is distributed into unit prices (hidden as separate line)
        // When false, $50 LTM fee shown as separate line item (default)
        let ltmDistributed = false;

        // NOTE: SIZE_MODIFIERS was removed - use SIZE_TO_SUFFIX (line ~1520) instead
        // SIZE_TO_SUFFIX contains ALL size suffixes including tall, youth, toddler, etc.

        // Standard sizes that group together (same pricing) - Slots 1-4
        const STANDARD_SIZES = ['S', 'M', 'L', 'XL'];

        // Extended sizes that get their own line items
        // Note: 2XL goes to Size05 (dedicated), all others go to Size06 (Other)
        const EXTENDED_SIZES = ['XS', '2XL', '3XL', '4XL', '5XL', '6XL'];

        // ShopWorks size slot mapping
        // Size01-04: Standard sizes (S, M, L, XL) - combined into one line item
        // Size05: 2XL only - separate line item
        // Size06: ALL others (XS, 3XL, 4XL, 5XL, Youth, Tall, OSFA) - each gets separate line item
        const SIZE_TO_SLOT = {
            'S': 'Size01', 'M': 'Size02', 'L': 'Size03', 'XL': 'Size04',
            '2XL': 'Size05',  // 2XL has dedicated slot
            'XS': 'Size06', '3XL': 'Size06', '4XL': 'Size06',
            '5XL': 'Size06', '6XL': 'Size06', 'OSFA': 'Size06'
        };

        // Display labels matching ShopWorks column headers
        // Note: Internally we use L/2XL/3XL, but display as LG/XXL/XXXL
        const SIZE_DISPLAY_LABELS = {
            'S': 'S', 'M': 'M', 'L': 'LG', 'XL': 'XL',
            '2XL': 'XXL', '3XL': 'XXXL',
            'XS': 'XXXL', '4XL': 'XXXL', '5XL': 'XXXL', '6XL': 'XXXL'
        };

        // State
        let pricingCalculator = null;
        let quoteService = null;
        // Primary logo configuration
        let primaryLogo = {
            position: 'Left Chest',
            stitchCount: 8000,
            needsDigitizing: false,
            isPrimary: true
        };

        // Additional logos array
        let additionalLogos = [];
        // Example entry: { id: 'al-1', position: 'Right Chest', stitchCount: 8000, needsDigitizing: false, isPrimary: false }

        let products = [];
        let rowCounter = 0;
        let productCache = {}; // Cache product data for quick lookup
        let childRowMap = {}; // Track child rows: { parentRowId: { '2XL': childRowId, '3XL': childRowId } }

        // Extended sizes available for Size06 (Other) column
        // Note: Actual available sizes are fetched dynamically per product via API
        // Includes OSFA for beanies, bags, and other one-size-fits-all items
        // All sizes that go in Size06 column (the "Other/Catch-All" column)
        // Based on Python Inksoft/Inksoft_Size_Translation_Import.csv
        const SIZE06_EXTENDED_SIZES = [
            // Extended large
            'XS', '3XL', '4XL', '5XL', '6XL', '7XL', '8XL', '9XL', '10XL',
            // One-size
            'OSFA', 'OSFM',
            // Combos (for fitted caps)
            'S/M', 'M/L', 'L/XL', 'XS/S', 'X/2X', 'S/XL',
            // Tall
            'LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT', 'ST', 'MT', 'XST',
            // Youth
            'YXS', 'YS', 'YM', 'YL', 'YXL',
            // Toddler
            '2T', '3T', '4T', '5T', '5/6T', '6T',
            // Big
            'LB', 'XLB', '2XLB',
            // Extra small
            'XXS', '2XS', 'XXL'
        ];

        // Full extended size ordering for child row display
        // Organized by category for easier reading
        const EXTENDED_SIZE_ORDER = [
            // Extra small first
            'XXS', '2XS', 'XS', 'XS/S',
            // Standard combos
            'S/M', 'M/L', 'L/XL', 'X/2X', 'S/XL',
            // Extended large (2XL in Size05, but included for sorting)
            '2XL', 'XXL', '3XL', '4XL', '5XL', '6XL', '7XL', '8XL', '9XL', '10XL',
            // Tall
            'ST', 'MT', 'XST', 'LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT',
            // Big
            'LB', 'XLB', '2XLB',
            // Youth
            'YXS', 'YS', 'YM', 'YL', 'YXL',
            // Toddler (smallest to largest)
            '2T', '3T', '4T', '5T', '5/6T', '6T',
            // One-size at end (for beanies/bags)
            'OSFA', 'OSFM'
        ];

        // Complete SIZE_TO_SUFFIX mapping for ShopWorks part numbers
        // Standard sizes (S, M, L, XL) have no suffix
        // All other sizes get a suffix appended to the base part number
        const SIZE_TO_SUFFIX = {
            // Standard sizes (no suffix) - Size01-04
            'S': '', 'M': '', 'L': '', 'XL': '',
            // 2XL - Size05
            '2XL': '_2X',
            // Extended large - Size06
            '3XL': '_3X', '4XL': '_4X', '5XL': '_5X', '6XL': '_6X',
            '7XL': '_7XL', '8XL': '_8XL', '9XL': '_9XL', '10XL': '_10XL',
            // Extra small - Size06
            'XS': '_XS', 'XXS': '_XXS', '2XS': '_2XS', 'XXL': '_XXL',
            // One-size options - Size06
            'OSFA': '_OSFA', 'OSFM': '_OSFM',
            // Size combinations - Size06
            'S/M': '_S/M', 'M/L': '_M/L', 'L/XL': '_L/XL',
            'XS/S': '_XS/S', 'X/2X': '_X/2X', 'S/XL': '_S/XL',
            // Tall sizes - Size06
            'LT': '_LT', 'XLT': '_XLT', '2XLT': '_2XLT', '3XLT': '_3XLT',
            '4XLT': '_4XLT', '5XLT': '_5XLT', '6XLT': '_6XLT',
            'ST': '_ST', 'MT': '_MT', 'XST': '_XST',
            // Youth sizes - Size06
            'YXS': '_YXS', 'YS': '_YS', 'YM': '_YM', 'YL': '_YL', 'YXL': '_YXL',
            // Toddler sizes - Size06
            '2T': '_2T', '3T': '_3T', '4T': '_4T', '5T': '_5T', '5/6T': '_5/6T', '6T': '_6T',
            // Big sizes - Size06
            'LB': '_LB', 'XLB': '_XLB', '2XLB': '_2XLB'
        };

        // ============================================================
        // EXTENDED SIZE PICKER POPUP (for Size06/XXXL column)
        // ============================================================

        /**
         * Fetch available extended sizes for a product from the API
         * @param {string} styleNumber - Product style number (e.g., 'J790')
         * @param {string} color - Product color (CATALOG_COLOR)
         * @returns {Promise<string[]>} Array of available extended sizes (e.g., ['XS', '3XL', '4XL'])
         */
        async function getAvailableExtendedSizes(styleNumber, color) {
            try {
                // Query the ShopWorks import format endpoint to get available SKUs
                const url = `${API_BASE}/api/sanmar-shopworks/import-format?styleNumber=${encodeURIComponent(styleNumber)}&color=${encodeURIComponent(color || '')}`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.warn('Failed to fetch extended sizes for this product');
                    return []; // Return empty to trigger "No extended sizes available" message
                }

                const skus = await response.json();

                // Extract available extended sizes from Size06 field in response
                const extendedSizes = new Set();

                skus.forEach(sku => {
                    // Check Size06 field for extended sizes (XS, 3XL, 4XL, etc.)
                    if (sku.Size06 && typeof sku.Size06 === 'string') {
                        extendedSizes.add(sku.Size06);
                    }

                    // Also check ID_Product for suffix pattern to identify available sizes
                    // e.g., J790_3X indicates 3XL is available
                    if (sku.ID_Product && sku.ID_Product.includes('_')) {
                        const suffix = sku.ID_Product.split('_').pop();
                        // Map suffix back to size name (reverse of SIZE_TO_SUFFIX)
                        const suffixToSize = {
                            // Extended large
                            '2X': '2XL', '3X': '3XL', '4X': '4XL', '5X': '5XL', '6X': '6XL',
                            '7XL': '7XL', '8XL': '8XL', '9XL': '9XL', '10XL': '10XL',
                            // Extra small
                            'XS': 'XS', 'XXS': 'XXS', '2XS': '2XS', 'XXL': 'XXL',
                            // One-size
                            'OSFA': 'OSFA', 'OSFM': 'OSFM',
                            // Combos
                            'S/M': 'S/M', 'M/L': 'M/L', 'L/XL': 'L/XL',
                            'XS/S': 'XS/S', 'X/2X': 'X/2X', 'S/XL': 'S/XL',
                            // Tall
                            'LT': 'LT', 'XLT': 'XLT', '2XLT': '2XLT', '3XLT': '3XLT',
                            '4XLT': '4XLT', '5XLT': '5XLT', '6XLT': '6XLT',
                            'ST': 'ST', 'MT': 'MT', 'XST': 'XST',
                            // Youth
                            'YXS': 'YXS', 'YS': 'YS', 'YM': 'YM', 'YL': 'YL', 'YXL': 'YXL',
                            // Toddler
                            '2T': '2T', '3T': '3T', '4T': '4T', '5T': '5T', '5/6T': '5/6T', '6T': '6T',
                            // Big
                            'LB': 'LB', 'XLB': 'XLB', '2XLB': '2XLB'
                        };
                        if (suffixToSize[suffix]) {
                            extendedSizes.add(suffixToSize[suffix]);
                        }
                    }
                });

                // Return as sorted array, maintaining standard order
                const orderedSizes = SIZE06_EXTENDED_SIZES.filter(size => extendedSizes.has(size));
                console.log(`ðŸ“¦ Available extended sizes for ${styleNumber}:`, orderedSizes);
                return orderedSizes;

            } catch (error) {
                console.error('Error fetching extended sizes:', error);
                return []; // Return empty to trigger "No extended sizes available" message
            }
        }

        /**
         * Open the extended size picker popup for a product row
         * Dynamically fetches available sizes from API
         * @param {string} rowId - The parent row ID (e.g., 'row-1')
         */
        async function openExtendedSizePopup(rowId) {
            const popup = document.getElementById('extended-size-popup');
            const backdrop = document.getElementById('size-popup-backdrop');
            const grid = document.getElementById('size-popup-grid');
            const applyBtn = popup.querySelector('.size-popup-apply');

            // Store which row we're editing (as numeric ID)
            popup.dataset.rowId = rowId;

            // Get parent row to find style and color info (DOM ID has 'row-' prefix)
            const parentRow = document.getElementById(`row-${rowId}`);
            if (!parentRow) {
                console.error('Cannot find row:', `row-${rowId}`);
                return;
            }

            const styleNumber = parentRow.dataset.style;
            const catalogColor = parentRow.dataset.catalogColor || parentRow.dataset.color;

            if (!styleNumber) {
                showToast('Select a product first', 'error');
                return;
            }

            // Show popup with loading state
            popup.classList.remove('hidden');
            backdrop.classList.remove('hidden');
            applyBtn.disabled = true;

            // Check if this is a pants or shorts product (use stored sizes directly)
            const isPants = parentRow.dataset.sizeCategory === 'pants';
            const isShorts = parentRow.dataset.sizeCategory === 'shorts';
            let availableSizes;

            if (isPants && parentRow.dataset.pantsSizes) {
                // For pants, use the sizes stored from analyzeSizeCategory
                availableSizes = JSON.parse(parentRow.dataset.pantsSizes);
                // Update popup header for pants
                popup.querySelector('.size-popup-header h4').innerHTML = '<i class="fas fa-ruler"></i> Waist/Inseam Sizes';
                popup.querySelector('.size-popup-hint').textContent = 'Enter quantities for each waist/inseam combination. These create separate line items.';
            } else if (isShorts && parentRow.dataset.shortsSizes) {
                // For shorts (waist-only), use the sizes stored from analyzeSizeCategory
                availableSizes = JSON.parse(parentRow.dataset.shortsSizes);
                // Update popup header for shorts
                popup.querySelector('.size-popup-header h4').innerHTML = '<i class="fas fa-ruler"></i> Waist Sizes';
                popup.querySelector('.size-popup-hint').textContent = 'Enter quantities for each waist size. These create separate line items.';
            } else {
                // Show loading spinner for non-pants
                grid.innerHTML = `
                    <div class="size-popup-loading" style="grid-column: 1 / -1;">
                        <div class="spinner"></div>
                        <span>Loading available sizes...</span>
                    </div>
                `;
                // Fetch available sizes from API
                availableSizes = await getAvailableExtendedSizes(styleNumber, catalogColor);
                // Reset header for non-pants
                popup.querySelector('.size-popup-header h4').innerHTML = '<i class="fas fa-ruler"></i> Extended Sizes (Size06)';
                popup.querySelector('.size-popup-hint').textContent = 'Enter quantities for extended sizes. These create separate line items.';
            }

            // Check if we have any sizes
            if (!availableSizes || availableSizes.length === 0) {
                const sizeType = isPants ? 'waist/inseam' : (isShorts ? 'waist' : 'extended');
                grid.innerHTML = `
                    <div class="size-popup-empty" style="grid-column: 1 / -1;">
                        <i class="fas fa-info-circle"></i><br>
                        No ${sizeType} sizes available for ${styleNumber}.
                    </div>
                `;
                applyBtn.disabled = true;
                console.log(`â„¹ï¸ No ${sizeType} sizes available for ${styleNumber}`);
                return;
            }

            // Generate size inputs with current values
            if (isShorts) {
                // Shorts: simple waist-only list (W30, W32, etc.)
                grid.innerHTML = availableSizes.map(size => {
                    const currentQty = getExtendedSizeQty(rowId, size);
                    // Display as "Waist 30" instead of "W30"
                    const waistNum = size.replace('W', '');
                    return `
                        <div class="size-popup-item">
                            <label>Waist ${waistNum}</label>
                            <input type="number"
                                   min="0"
                                   data-size="${size}"
                                   value="${currentQty || ''}"
                                   placeholder="0"
                                   class="size-popup-input">
                        </div>
                    `;
                }).join('');
            } else if (isPants) {
                // Group pants sizes by waist for better UX
                const waistGroups = {};
                availableSizes.forEach(size => {
                    if (/^\d{4}$/.test(size)) {
                        const waist = size.substring(0, 2);
                        if (!waistGroups[waist]) waistGroups[waist] = [];
                        waistGroups[waist].push(size);
                    }
                });

                // Common waists that should be expanded by default
                const commonWaists = ['30', '32', '34', '36'];

                grid.innerHTML = Object.keys(waistGroups).sort((a, b) => parseInt(a) - parseInt(b)).map(waist => {
                    const isExpanded = commonWaists.includes(waist);
                    const sizesHtml = waistGroups[waist].map(size => {
                        const currentQty = getExtendedSizeQty(rowId, size);
                        const inseam = size.substring(2, 4);
                        return `
                            <div class="size-popup-item">
                                <label>${waist}x${inseam}</label>
                                <input type="number"
                                       min="0"
                                       data-size="${size}"
                                       value="${currentQty || ''}"
                                       placeholder="0"
                                       class="size-popup-input">
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="pants-waist-group ${isExpanded ? 'expanded' : 'collapsed'}">
                            <div class="waist-header" onclick="toggleWaistGroup(this)">
                                <i class="fas fa-chevron-${isExpanded ? 'down' : 'right'}"></i>
                                <span>Waist ${waist}</span>
                                <span class="waist-count">(${waistGroups[waist].length} sizes)</span>
                            </div>
                            <div class="waist-sizes" style="${isExpanded ? '' : 'display: none;'}">
                                ${sizesHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Non-pants: flat list (existing behavior)
                grid.innerHTML = availableSizes.map(size => {
                    const currentQty = getExtendedSizeQty(rowId, size);
                    return `
                        <div class="size-popup-item">
                            <label>${size}</label>
                            <input type="number"
                                   min="0"
                                   data-size="${size}"
                                   value="${currentQty || ''}"
                                   placeholder="0"
                                   class="size-popup-input">
                        </div>
                    `;
                }).join('');
            }

            // Enable apply button
            applyBtn.disabled = false;

            // Focus first input
            const firstInput = grid.querySelector('input');
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }

            // Store available sizes for OSFA-only detection in applyExtendedSizes()
            popup.dataset.availableSizes = JSON.stringify(availableSizes);
            console.log(`ðŸ“ Extended size popup opened for ${styleNumber} with sizes:`, availableSizes);
        }

        /**
         * Close the extended size picker popup
         */
        function closeExtendedSizePopup() {
            const popup = document.getElementById('extended-size-popup');
            const backdrop = document.getElementById('size-popup-backdrop');

            popup.classList.add('hidden');
            backdrop.classList.add('hidden');
            popup.dataset.rowId = '';
        }

        /**
         * Toggle a waist group in the pants size picker
         * @param {HTMLElement} headerElement - The clicked waist-header element
         */
        function toggleWaistGroup(headerElement) {
            const group = headerElement.closest('.pants-waist-group');
            const sizesDiv = group.querySelector('.waist-sizes');
            const icon = headerElement.querySelector('i');

            if (group.classList.contains('expanded')) {
                group.classList.remove('expanded');
                group.classList.add('collapsed');
                sizesDiv.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            } else {
                group.classList.remove('collapsed');
                group.classList.add('expanded');
                sizesDiv.style.display = '';
                icon.className = 'fas fa-chevron-down';
            }
        }

        /**
         * Get current quantity for an extended size from child rows
         * @param {string} parentRowId - Parent row ID
         * @param {string} size - Size name (e.g., '4XL')
         * @returns {number} Current quantity or 0
         */
        function getExtendedSizeQty(parentRowId, size) {
            // Check if there's a child row for this size
            if (childRowMap[parentRowId] && childRowMap[parentRowId][size]) {
                const childRowId = childRowMap[parentRowId][size];
                const childRow = document.getElementById(`row-${childRowId}`);
                if (childRow) {
                    const qtyCell = childRow.querySelector('.qty-display');
                    if (qtyCell) {
                        return parseInt(qtyCell.textContent) || 0;
                    }
                }
            }

            // Also check the parent row's 3XL input for existing value (old behavior)
            if (size === '3XL') {
                const parentRow = document.getElementById(`row-${parentRowId}`);
                if (parentRow) {
                    const xxxlInput = parentRow.querySelector('input[data-size="3XL"]');
                    if (xxxlInput && !xxxlInput.classList.contains('xxxl-picker-btn')) {
                        return parseInt(xxxlInput.value) || 0;
                    }
                }
            }

            return 0;
        }

        /**
         * Apply extended size changes from the popup
         */
        function applyExtendedSizes() {
            const popup = document.getElementById('extended-size-popup');
            const rowId = popup.dataset.rowId;

            if (!rowId) {
                console.error('No row ID stored in popup');
                closeExtendedSizePopup();
                return;
            }

            // rowId is numeric, DOM elements have 'row-' prefix
            const parentRow = document.getElementById(`row-${rowId}`);
            if (!parentRow) {
                console.error('Parent row not found:', `row-${rowId}`);
                closeExtendedSizePopup();
                return;
            }

            // Check if this is an OSFA-only product (beanies, caps, bags)
            // OSFA is the BASE size for these products, not an upcharge
            const availableSizes = JSON.parse(popup.dataset.availableSizes || '[]');
            const isOSFAOnly = availableSizes.length === 1 && availableSizes[0] === 'OSFA';

            // Get all size inputs from popup
            const sizeInputs = popup.querySelectorAll('.size-popup-input');
            let totalExtendedQty = 0;
            let sizesChanged = [];

            sizeInputs.forEach(input => {
                const size = input.dataset.size;
                const qty = parseInt(input.value) || 0;
                const currentQty = getExtendedSizeQty(rowId, size);

                if (qty !== currentQty) {
                    sizesChanged.push({ size, qty, previousQty: currentQty });
                }

                if (qty > 0) {
                    totalExtendedQty += qty;

                    // OSFA-only product: put qty in parent row, don't create child row
                    // OSFA is the BASE size for these products (beanies, caps, bags)
                    if (isOSFAOnly && size === 'OSFA') {
                        parentRow.dataset.osfaQty = qty;
                        parentRow.dataset.isOsfaOnly = 'true';
                        document.getElementById(`row-qty-${rowId}`).textContent = qty;
                        console.log(`ðŸ§¢ OSFA-only product: qty ${qty} in parent row (no child row)`);
                    } else {
                        // Normal extended size - create child row with upcharge
                        createOrUpdateExtendedChildRow(rowId, size, qty);
                    }
                } else if (currentQty > 0) {
                    // Remove quantity - handle differently for OSFA-only
                    if (isOSFAOnly && size === 'OSFA') {
                        parentRow.dataset.osfaQty = '0';
                        document.getElementById(`row-qty-${rowId}`).textContent = '0';
                    } else {
                        removeChildRow(rowId, size);
                    }
                }
            });

            // Update the XXXL cell display
            if (isOSFAOnly) {
                // For OSFA-only, show the qty in the XXXL cell (not "+")
                const xxxlCell = parentRow.querySelector('.xxxl-picker-btn');
                if (xxxlCell) {
                    xxxlCell.value = totalExtendedQty > 0 ? totalExtendedQty.toString() : '';
                }
            } else {
                updateXXXLCellDisplay(rowId, totalExtendedQty);
            }

            // Recalculate pricing
            recalculatePricing();

            // Close popup
            closeExtendedSizePopup();

            if (sizesChanged.length > 0) {
                console.log('ðŸ“ Extended sizes applied:', sizesChanged);
            }
        }

        /**
         * Create or update a child row for an extended size
         * @param {string} parentRowId - Parent row ID
         * @param {string} size - Size name (e.g., '4XL')
         * @param {number} qty - Quantity
         */
        function createOrUpdateExtendedChildRow(parentRowId, size, qty) {
            // Initialize map entry if needed
            if (!childRowMap[parentRowId]) {
                childRowMap[parentRowId] = {};
            }

            // Check if child row already exists
            if (childRowMap[parentRowId][size]) {
                const existingChildId = childRowMap[parentRowId][size];
                const existingRow = document.getElementById(`row-${existingChildId}`);
                if (existingRow) {
                    // Update existing row's quantity
                    const qtyDisplay = existingRow.querySelector('.qty-display');
                    if (qtyDisplay) qtyDisplay.textContent = qty;

                    // Update the size input value
                    const sizeInput = existingRow.querySelector(`input[data-size="${size}"]`);
                    if (sizeInput) sizeInput.value = qty;

                    // Recalculate unit price display
                    updateChildRowPrice(existingChildId);
                    return;
                }
            }

            // Need to create new child row - use existing createChildRow function
            createChildRow(parentRowId, size, qty);
        }

        /**
         * Update the XXXL cell display to show total extended sizes
         * @param {string|number} rowId - Row ID (numeric)
         * @param {number} total - Total quantity of all Size06 items
         */
        function updateXXXLCellDisplay(rowId, total) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            const xxxlInput = row.querySelector('input[data-size="3XL"]');
            if (!xxxlInput) return;

            // Make it a picker button if not already
            if (!xxxlInput.classList.contains('xxxl-picker-btn')) {
                xxxlInput.classList.add('xxxl-picker-btn');
                xxxlInput.readOnly = true;
            }

            // Always clear value - child rows display individual quantities
            // Show checkmark (âœ“) if sizes exist, + if none - avoids confusing "4" display
            xxxlInput.value = '';
            xxxlInput.placeholder = total > 0 ? 'âœ“' : '+';
        }

        /**
         * Update child row price after qty change
         * @param {string|number} childRowId - Child row ID (numeric)
         */
        function updateChildRowPrice(childRowId) {
            const childRow = document.getElementById(`row-${childRowId}`);
            if (!childRow) return;

            const priceCell = childRow.querySelector('.unit-price-display');
            const qtyDisplay = childRow.querySelector('.qty-display');
            if (!priceCell || !qtyDisplay) return;

            // Get qty and recalculate (price logic is handled by recalculatePricing)
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Power Quote Builder initializing...');

            showLoading(true);

            try {
                // Initialize pricing calculator
                pricingCalculator = new EmbroideryPricingCalculator();
                await pricingCalculator.initializeConfig();

                // Initialize quote service
                quoteService = new EmbroideryQuoteService();

                // Setup event listeners
                setupSearchAutocomplete();
                setupKeyboardShortcuts();
                setupPrimaryLogoHandlers();
                setupLTMToggle();

                // Add initial empty row
                addNewRow();

                console.log('âœ… Power Quote Builder ready');
                showToast('Ready to build quotes!', 'success');

            } catch (error) {
                console.error('Failed to initialize:', error);
                showToast('Failed to initialize. Please refresh.', 'error');
            }

            showLoading(false);
        });

        // ============================================================
        // LOGO PRESETS
        // ============================================================

        // ============================================================
        // PRIMARY LOGO HANDLERS
        // ============================================================

        function setupPrimaryLogoHandlers() {
            // Position dropdown
            const positionSelect = document.getElementById('primary-position');
            if (positionSelect) {
                positionSelect.addEventListener('change', function() {
                    primaryLogo.position = this.value;
                    recalculatePricing();
                });
            }

            // Stitch count input
            const stitchInput = document.getElementById('primary-stitches');
            if (stitchInput) {
                stitchInput.addEventListener('change', function() {
                    primaryLogo.stitchCount = parseInt(this.value) || 8000;
                    recalculatePricing();
                });
            }

            // Digitizing checkbox
            const digitizingCheckbox = document.getElementById('primary-digitizing');
            if (digitizingCheckbox) {
                digitizingCheckbox.addEventListener('change', function() {
                    primaryLogo.needsDigitizing = this.checked;
                    recalculatePricing();
                });
            }
        }

        // ============================================================
        // ADDITIONAL LOGO MANAGEMENT
        // ============================================================

        function addAdditionalLogo() {
            const id = 'al-' + Date.now();
            const newLogo = {
                id: id,
                position: 'Right Chest',
                stitchCount: 8000,
                needsDigitizing: false,
                isPrimary: false
            };
            additionalLogos.push(newLogo);
            renderAdditionalLogos();
            recalculatePricing();
        }

        function removeAdditionalLogo(id) {
            additionalLogos = additionalLogos.filter(logo => logo.id !== id);
            renderAdditionalLogos();
            recalculatePricing();
        }

        function updateAdditionalLogo(id, field, value) {
            const logo = additionalLogos.find(l => l.id === id);
            if (logo) {
                logo[field] = value;
                recalculatePricing();
            }
        }

        function renderAdditionalLogos() {
            const container = document.getElementById('additional-logos-list');
            if (!container) return;

            if (additionalLogos.length === 0) {
                container.innerHTML = '<div class="no-logos">No additional logos added</div>';
                return;
            }

            container.innerHTML = additionalLogos.map(logo => `
                <div class="additional-logo-row" data-logo-id="${logo.id}">
                    <select class="al-position" onchange="updateAdditionalLogo('${logo.id}', 'position', this.value)">
                        <option value="Right Chest" ${logo.position === 'Right Chest' ? 'selected' : ''}>Right Chest</option>
                        <option value="Left Sleeve" ${logo.position === 'Left Sleeve' ? 'selected' : ''}>Left Sleeve</option>
                        <option value="Right Sleeve" ${logo.position === 'Right Sleeve' ? 'selected' : ''}>Right Sleeve</option>
                    </select>
                    <div class="stitch-input-group">
                        <input type="number" class="al-stitches" value="${logo.stitchCount}"
                               min="1000" step="1000"
                               onchange="updateAdditionalLogo('${logo.id}', 'stitchCount', parseInt(this.value) || 8000)">
                        <span>stitches</span>
                    </div>
                    <label class="al-digitizing">
                        <input type="checkbox" ${logo.needsDigitizing ? 'checked' : ''}
                               onchange="updateAdditionalLogo('${logo.id}', 'needsDigitizing', this.checked)">
                        Digitizing
                    </label>
                    <span class="al-price" id="al-price-${logo.id}">$0.00/ea</span>
                    <button class="remove-al-btn" onclick="removeAdditionalLogo('${logo.id}')" title="Remove logo">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Legacy functions for backward compatibility
        function setupDigitizingToggle() {
            // Now handled by setupPrimaryLogoHandlers
        }

        function setupLTMToggle() {
            const btn = document.getElementById('ltm-distribute-btn');
            if (!btn) return;

            btn.addEventListener('click', function() {
                ltmDistributed = !ltmDistributed;

                // Show toast feedback
                if (ltmDistributed) {
                    showToast('LTM fee distributed into unit prices', 'success');
                } else {
                    showToast('LTM fee shown as separate line', 'info');
                }

                // Re-render pricing display (handles button appearance) and grid
                if (window.currentPricingData) {
                    updatePricingDisplay(window.currentPricingData);
                }
                recalculatePricing();
            });
        }

        // ============================================================
        // PRODUCT SEARCH & AUTOCOMPLETE
        // ============================================================

        function setupSearchAutocomplete() {
            const searchInput = document.getElementById('product-search');
            const suggestions = document.getElementById('search-suggestions');

            let debounceTimer;
            let selectedIndex = -1;

            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const query = this.value.trim();
                selectedIndex = -1; // Reset selection on new input

                if (query.length < 3) {
                    suggestions.classList.remove('show');
                    return;
                }

                debounceTimer = setTimeout(() => searchProducts(query), 150);
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = suggestions.querySelectorAll('.suggestion-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items, selectedIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items, selectedIndex);
                } else if (e.key === 'Enter') {
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        e.preventDefault();
                        items[selectedIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    suggestions.classList.remove('show');
                    selectedIndex = -1;
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-input-wrapper')) {
                    suggestions.classList.remove('show');
                    selectedIndex = -1;
                }
            });
        }

        /**
         * Update visual selection state for keyboard navigation
         */
        function updateSelection(items, selectedIndex) {
            items.forEach((item, i) => {
                item.classList.toggle('selected', i === selectedIndex);
            });
            if (selectedIndex >= 0 && items[selectedIndex]) {
                items[selectedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        /**
         * Highlight matched text in search results
         */
        function highlightMatch(text, query) {
            if (!query) return text;
            // Escape regex special characters in query
            const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedQuery})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }

        /**
         * Rank search results by relevance to query (best web practices)
         * Priority: exact match > starts with > contains > other
         */
        function rankSearchResults(results, query) {
            const q = query.toUpperCase();

            return results.sort((a, b) => {
                const aStyle = (a.value || '').toUpperCase();
                const bStyle = (b.value || '').toUpperCase();

                // Calculate priority score (lower = higher priority)
                const getScore = (style) => {
                    if (style === q) return 0;           // Exact match
                    if (style.startsWith(q)) return 1;   // Starts with
                    if (style.includes(q)) return 2;     // Contains
                    return 3;                             // Other
                };

                const aScore = getScore(aStyle);
                const bScore = getScore(bStyle);

                // Primary sort: by relevance score
                if (aScore !== bScore) return aScore - bScore;

                // Secondary sort: alphabetically
                return aStyle.localeCompare(bStyle);
            });
        }

        async function searchProducts(query) {
            const suggestions = document.getElementById('search-suggestions');

            try {
                // Use stylesearch API endpoint (returns {value, label} format)
                const response = await fetch(`${API_BASE}/api/stylesearch?term=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    // Rank results: exact matches first, then starts-with, then contains
                    // Limit to 10 results for focused display
                    const rankedResults = rankSearchResults(data, query).slice(0, 10);

                    suggestions.innerHTML = rankedResults.map(product => {
                        // Extract product name (remove style prefix from label)
                        const productName = (product.label || '').split(' - ').slice(1).join(' - ') || '';
                        return `
                            <div class="suggestion-item" onclick="selectProduct('${product.value}')">
                                <span class="style">${highlightMatch(product.value, query)}</span>
                                <span class="name">${productName}</span>
                            </div>
                        `;
                    }).join('');
                    suggestions.classList.add('show');

                    // Cache product data (convert to expected format)
                    rankedResults.forEach(p => {
                        productCache[p.value] = {
                            STYLE: p.value,
                            PRODUCT_TITLE: p.label
                        };
                    });
                } else {
                    suggestions.innerHTML = '<div class="suggestion-item"><span>No products found</span></div>';
                    suggestions.classList.add('show');
                }
            } catch (error) {
                console.error('Search error:', error);
                suggestions.innerHTML = '<div class="suggestion-item"><span>Search error - try again</span></div>';
                suggestions.classList.add('show');
            }
        }

        async function selectProduct(styleNumber) {
            const searchInput = document.getElementById('product-search');
            const suggestions = document.getElementById('search-suggestions');

            searchInput.value = '';
            suggestions.classList.remove('show');

            // Add product to table
            await addProductRow(styleNumber);
        }

        // ============================================================
        // PRODUCT TABLE MANAGEMENT
        // ============================================================

        function addNewRow() {
            const tbody = document.getElementById('product-tbody');
            const rowId = ++rowCounter;

            const row = document.createElement('tr');
            row.id = `row-${rowId}`;
            row.className = 'new-row';
            row.dataset.rowId = rowId;

            row.innerHTML = `
                <td>
                    <input type="text" class="cell-input style-input"
                           placeholder="Style #"
                           data-field="style"
                           onchange="onStyleChange(this, ${rowId})"
                           onkeydown="handleCellKeydown(event, this)">
                </td>
                <td class="desc-cell">
                    <input type="text" class="cell-input desc-input"
                           placeholder="(auto)"
                           data-field="description"
                           readonly>
                    <span class="cap-badge" id="cap-badge-${rowId}" style="display: none;">
                        <i class="fas fa-hat-cowboy"></i> Cap
                    </span>
                </td>
                <td>
                    <div class="color-picker-wrapper" data-row-id="${rowId}">
                        <div class="color-picker-selected disabled" onclick="toggleColorPicker(${rowId})" tabindex="0" onkeydown="handleColorPickerKeydown(event, ${rowId})">
                            <span class="color-swatch empty"></span>
                            <span class="color-name placeholder">Select color...</span>
                            <i class="fas fa-chevron-down picker-arrow"></i>
                        </div>
                        <div class="color-picker-dropdown hidden" id="color-dropdown-${rowId}"></div>
                    </div>
                </td>
                <td><input type="number" class="cell-input size-input" data-size="S" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="number" class="cell-input size-input" data-size="M" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="number" class="cell-input size-input" data-size="L" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="number" class="cell-input size-input" data-size="XL" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="number" class="cell-input size-input" data-size="2XL" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="text" class="cell-input size-input xxxl-picker-btn" data-size="3XL" value="" placeholder="+" readonly onclick="openExtendedSizePopup(${rowId})" onkeydown="if(event.key==='Enter'){openExtendedSizePopup(${rowId})}" disabled title="Click to add extended sizes (3XL, 4XL, 5XL, XS, etc.)"></td>
                <td class="cell-qty" id="row-qty-${rowId}">0</td>
                <td class="cell-price" id="row-price-${rowId}">-</td>
                <td class="cell-actions">
                    <button class="btn-delete-row" onclick="deleteRow(${rowId})" title="Delete row">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);

            // Focus on the style input
            setTimeout(() => {
                row.querySelector('.style-input').focus();
            }, 50);

            // Remove the "new-row" highlight after a moment
            setTimeout(() => {
                row.classList.remove('new-row');
            }, 1000);
        }

        async function addProductRow(styleNumber) {
            // Find or create empty row
            let targetRow = document.querySelector('tr.new-row');
            if (!targetRow) {
                addNewRow();
                targetRow = document.querySelector('tr.new-row');
            }

            const rowId = targetRow.dataset.rowId;
            const styleInput = targetRow.querySelector('.style-input');
            styleInput.value = styleNumber;

            await onStyleChange(styleInput, parseInt(rowId));
        }

        async function onStyleChange(input, rowId) {
            const styleNumber = input.value.trim().toUpperCase();
            if (!styleNumber) return;

            const row = document.getElementById(`row-${rowId}`);
            const descInput = row.querySelector('[data-field="description"]');
            const pickerWrapper = row.querySelector('.color-picker-wrapper');
            const pickerSelected = row.querySelector('.color-picker-selected');
            const pickerDropdown = row.querySelector('.color-picker-dropdown');

            try {
                // Fetch product data using stylesearch API
                let product = productCache[styleNumber];
                if (!product) {
                    const response = await fetch(`${API_BASE}/api/stylesearch?term=${styleNumber}`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        // Find exact match or use first result
                        const exactMatch = data.find(p => p.value.toUpperCase() === styleNumber);
                        const result = exactMatch || data[0];
                        product = {
                            STYLE: result.value,
                            PRODUCT_TITLE: result.label
                        };
                        productCache[styleNumber] = product;
                    }
                }

                if (product) {
                    // Check for cap products - now supported with cap-specific pricing
                    const isCap = isCapProduct(styleNumber, product.PRODUCT_TITLE);
                    const capBadge = document.getElementById(`cap-badge-${rowId}`);
                    if (isCap) {
                        row.dataset.isCap = 'true';
                        if (capBadge) capBadge.style.display = 'inline-flex';
                        showToast('Cap detected - using cap embroidery pricing', 'info', 3000);
                    } else {
                        row.dataset.isCap = 'false';
                        if (capBadge) capBadge.style.display = 'none';
                    }

                    // Pants products (PT20, etc.) are now supported via size picker popup
                    // Size category detection will handle waist/inseam sizing

                    // Clean product title (remove duplicate style numbers from API response)
                    const cleanTitle = cleanProductTitle(product.PRODUCT_TITLE, styleNumber);

                    // Update description with clean title
                    descInput.value = cleanTitle || styleNumber;

                    // Fetch colors using product-colors API
                    const colorsResponse = await fetch(`${API_BASE}/api/product-colors?styleNumber=${styleNumber}`);
                    const colorsData = await colorsResponse.json();
                    const colors = colorsData.colors || [];

                    if (colors && colors.length > 0) {
                        // Populate custom color picker dropdown with swatches
                        pickerDropdown.innerHTML = colors.map(c => `
                            <div class="color-picker-option"
                                 data-color-name="${escapeHtml(c.COLOR_NAME)}"
                                 data-catalog-color="${escapeHtml(c.CATALOG_COLOR || c.COLOR_NAME)}"
                                 data-swatch-url="${escapeHtml(c.COLOR_SQUARE_IMAGE || '')}"
                                 data-hex="${escapeHtml(c.HEX_CODE || '#ccc')}"
                                 onclick="selectColor(${rowId}, this)">
                                <span class="color-swatch" style="${getSwatchStyle(c)}"></span>
                                <span class="color-name">${escapeHtml(c.COLOR_NAME)}</span>
                            </div>
                        `).join('');

                        // Enable the picker
                        pickerSelected.classList.remove('disabled');

                        // Store colors for later (child rows, etc.)
                        row.dataset.colors = JSON.stringify(colors);
                    }

                    // Store product info
                    row.dataset.style = styleNumber;
                    row.dataset.productName = cleanTitle || styleNumber;

                } else {
                    descInput.value = 'Not found';
                    showToast(`Style ${styleNumber} not found`, 'error');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showToast('Error loading product', 'error');
            }
        }

        // Helper function to escape HTML for safe attribute values
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        /**
         * Extract clean product name from API title
         * API returns: "NF0A3LH4 - The North Face DryVent Rain Jacket. NF0A3LH4"
         * We want: "The North Face DryVent Rain Jacket"
         */
        function cleanProductTitle(title, styleNumber) {
            if (!title || !styleNumber) return title || '';

            // Escape special regex characters in style number
            const escapedStyle = styleNumber.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

            // Remove style number prefix pattern: "STYLE - " or "STYLE. "
            let cleaned = title.replace(new RegExp(`^${escapedStyle}\\s*[-.]\\s*`, 'i'), '');

            // Remove trailing style number: ". STYLE" or " STYLE" at end
            cleaned = cleaned.replace(new RegExp(`[.\\s]+${escapedStyle}\\s*$`, 'i'), '');

            return cleaned.trim() || title;
        }

        /**
         * Check if a style number is a cap/hat product
         * @param {string} style - Style number
         * @param {string} productTitle - Product title/description
         * @returns {boolean} True if cap/hat
         */
        function isCapProduct(style, productTitle = '') {
            if (!style) return false;
            const styleUpper = style.toUpperCase();
            const titleUpper = (productTitle || '').toUpperCase();

            // Check style patterns:
            // CP* caps (CP80, CP90, etc)
            // NE* caps (NE1000, NE400)
            // C+digit (C112, C118)
            // Richardson styles (112, 110, 115, etc) - numeric only
            if (/^C[P0-9]/.test(styleUpper) || styleUpper.startsWith('NE')) {
                return true;
            }

            // Richardson caps - 2-3 digit numeric styles (100-999)
            if (/^\d{2,3}$/.test(styleUpper)) {
                return true;
            }

            // Check title keywords
            if (titleUpper.includes('CAP') || titleUpper.includes('HAT') ||
                titleUpper.includes('BEANIE') || titleUpper.includes('SNAPBACK') ||
                titleUpper.includes('TRUCKER') || titleUpper.includes('RICHARDSON')) {
                return true;
            }

            return false;
        }

        /**
         * Check if product is pants (waist/inseam sizing not supported)
         * @param {string} style - Style number
         * @param {string} productTitle - Product title/description
         * @returns {boolean} True if pants
         */
        function isPantsProduct(style, productTitle = '') {
            if (!style) return false;
            const styleUpper = style.toUpperCase();
            const titleUpper = (productTitle || '').toUpperCase();

            // Red Kap work pants (PT prefix)
            if (styleUpper.startsWith('PT') && /^PT\d/.test(styleUpper)) return true;

            // Title keywords for pants
            if (titleUpper.includes('PANT') || titleUpper.includes('WORK PANT') ||
                titleUpper.includes('CARGO') || titleUpper.includes('TROUSER') ||
                titleUpper.includes('INDUSTRIAL PANT')) {
                return true;
            }

            return false;
        }

        /**
         * Analyze available sizes and determine the product's size category
         * Handles OSFA, combo sizes, youth, toddler, tall, and standard products
         * @param {string[]} availableSizes - Array of available sizes from API
         * @returns {Object} Category info with display configuration
         */
        function analyzeSizeCategory(availableSizes) {
            if (!availableSizes || availableSizes.length === 0) {
                return { category: 'unknown', columns: [], useQtyOnly: false };
            }

            const sizes = availableSizes.map(s => s.toUpperCase());
            const STANDARD = ['S', 'M', 'L', 'XL'];
            const COMBO = ['S/M', 'M/L', 'L/XL', 'XS/S', 'X/2X'];
            const YOUTH = ['YXS', 'YS', 'YM', 'YL', 'YXL'];
            const TODDLER = ['2T', '3T', '4T', '5T', '5/6T', '6T'];
            const TALL = ['LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT', 'ST', 'MT'];
            const ONE_SIZE = ['OSFA', 'OSFM'];
            const PANTS_PATTERN = /^\d{4}$/;  // 4-digit waist/inseam codes like 2737, 2830
            const WAIST_ONLY_PATTERN = /^W\d{2}$/;  // Waist-only codes like W30, W32 (PT66 shorts)

            // Count sizes in each category for dominant detection
            const youthCount = sizes.filter(s => YOUTH.includes(s)).length;
            const toddlerCount = sizes.filter(s => TODDLER.includes(s)).length;
            const tallCount = sizes.filter(s => TALL.includes(s)).length;
            const comboCount = sizes.filter(s => COMBO.includes(s)).length;
            const osfaCount = sizes.filter(s => ONE_SIZE.includes(s)).length;
            const standardCount = sizes.filter(s => STANDARD.includes(s)).length;
            const pantsCount = sizes.filter(s => PANTS_PATTERN.test(s)).length;
            const waistOnlyCount = sizes.filter(s => WAIST_ONLY_PATTERN.test(s)).length;

            // Priority 1a: Waist-only shorts (W30, W32, etc. - PT66, CT103542)
            if (waistOnlyCount > 0 && waistOnlyCount >= sizes.length / 2) {
                // Extract all valid waist-only sizes
                const waistSizes = sizes.filter(s => WAIST_ONLY_PATTERN.test(s));
                return {
                    category: 'shorts',
                    columns: [],
                    useQtyOnly: false,
                    shortsSizes: waistSizes,
                    baseSize: waistSizes[0],
                    message: 'Select waist sizes'
                };
            }

            // Priority 1b: Pants (waist/inseam sizes like 3032 for 30x32)
            if (pantsCount > 0 && pantsCount >= sizes.length / 2) {
                // Extract all valid pants sizes (4-digit codes)
                const pantsSizes = sizes.filter(s => PANTS_PATTERN.test(s));
                return {
                    category: 'pants',
                    columns: [],
                    useQtyOnly: false,
                    pantsSizes: pantsSizes,
                    baseSize: pantsSizes[0],
                    message: 'Select waist/inseam sizes'
                };
            }

            // Priority 2: OSFA-only (caps, bags, beanies)
            if (osfaCount > 0 && osfaCount === sizes.length) {
                return {
                    category: 'osfa-only',
                    columns: [],
                    useQtyOnly: true,
                    baseSize: sizes[0],
                    message: 'One Size Fits All'
                };
            }

            // Priority 3: Combo-only (fitted caps like NE1000)
            if (comboCount > 0 && comboCount === sizes.length) {
                return {
                    category: 'combo-only',
                    columns: sizes,
                    useQtyOnly: false,
                    baseSize: sizes[0]
                };
            }

            // Priority 4: Youth-dominant (has youth sizes AND more youth than standard)
            // PC61Y returns both S,M,L,XL AND YS,YM,YL,YXL - youth should win
            if (youthCount > 0 && youthCount >= standardCount) {
                return {
                    category: 'youth-only',
                    columns: YOUTH.filter(y => sizes.includes(y)),
                    useQtyOnly: false,
                    baseSize: sizes.find(s => YOUTH.includes(s)) || sizes[0]
                };
            }

            // Priority 5: Toddler-dominant
            if (toddlerCount > 0 && toddlerCount >= standardCount) {
                return {
                    category: 'toddler-only',
                    columns: TODDLER.filter(t => sizes.includes(t)),
                    useQtyOnly: false,
                    baseSize: sizes.find(s => TODDLER.includes(s)) || sizes[0]
                };
            }

            // Priority 6: Tall-dominant (LT, XLT without S, M, L, XL)
            if (tallCount > 0 && standardCount === 0) {
                return {
                    category: 'tall-only',
                    columns: sizes.filter(s => TALL.includes(s) || s === '2XL'),
                    useQtyOnly: false,
                    baseSize: sizes.find(s => TALL.includes(s)) || sizes[0]
                };
            }

            // Priority 7: Standard (has S, M, L, XL as dominant)
            if (standardCount > 0) {
                return {
                    category: 'standard',
                    columns: ['S', 'M', 'L', 'XL', '2XL'],
                    useQtyOnly: false,
                    baseSize: 'S',
                    extendedSizes: sizes.filter(s => !STANDARD.includes(s) && s !== '2XL')
                };
            }

            // Fallback for unknown patterns
            return {
                category: 'other',
                columns: sizes.slice(0, 5),
                useQtyOnly: false,
                baseSize: sizes[0]
            };
        }

        /**
         * Update row UI based on size category
         * Handles OSFA (single qty input), combo sizes, and other non-standard layouts
         * @param {HTMLElement} row - The product row element
         * @param {Object} sizeInfo - Result from analyzeSizeCategory()
         */
        function updateRowForSizeCategory(row, sizeInfo) {
            const rowId = row.dataset.rowId;
            const sizeInputs = row.querySelectorAll('.size-input:not(.xxxl-picker-btn)');
            const xxxlCell = row.querySelector('.xxxl-picker-btn');

            // Store category info for later use
            row.dataset.sizeCategory = sizeInfo.category;
            row.dataset.baseSize = sizeInfo.baseSize || '';

            // Handle PANTS (waist/inseam sizes) - use size picker popup
            if (sizeInfo.category === 'pants') {
                // Disable all size columns (parent row doesn't take quantities)
                sizeInputs.forEach(input => {
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = '-';
                    input.closest('td').classList.add('size-disabled');
                });

                // Enable XXXL cell as "Select Sizes" picker button
                if (xxxlCell && sizeInfo.pantsSizes && sizeInfo.pantsSizes.length > 0) {
                    row.dataset.pantsSizes = JSON.stringify(sizeInfo.pantsSizes);
                    row.dataset.extendedSizes = JSON.stringify(sizeInfo.pantsSizes); // For compatibility
                    xxxlCell.classList.add('pants-picker-btn');
                    xxxlCell.disabled = false;
                    xxxlCell.placeholder = '+';
                    xxxlCell.closest('td').classList.remove('size-disabled');
                } else if (xxxlCell) {
                    xxxlCell.disabled = true;
                    xxxlCell.placeholder = '-';
                    xxxlCell.closest('td').classList.add('size-disabled');
                }

                row.classList.add('pants-row');
                row.classList.add('non-standard-sizes');
                showToast('Pants product - click + to select waist/inseam sizes', 'info', 4000);
                return;
            }

            // Handle SHORTS (waist-only sizes like W30, W32) - use size picker popup
            if (sizeInfo.category === 'shorts') {
                // Disable all size columns (parent row doesn't take quantities)
                sizeInputs.forEach(input => {
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = '-';
                    input.closest('td').classList.add('size-disabled');
                });

                // Enable XXXL cell as "Select Sizes" picker button
                if (xxxlCell && sizeInfo.shortsSizes && sizeInfo.shortsSizes.length > 0) {
                    row.dataset.shortsSizes = JSON.stringify(sizeInfo.shortsSizes);
                    row.dataset.extendedSizes = JSON.stringify(sizeInfo.shortsSizes); // For compatibility
                    row.dataset.sizeCategory = 'shorts'; // Ensure category is set
                    xxxlCell.classList.add('shorts-picker-btn');
                    xxxlCell.disabled = false;
                    xxxlCell.placeholder = '+';
                    xxxlCell.closest('td').classList.remove('size-disabled');
                } else if (xxxlCell) {
                    xxxlCell.disabled = true;
                    xxxlCell.placeholder = '-';
                    xxxlCell.closest('td').classList.add('size-disabled');
                }

                row.classList.add('shorts-row');
                row.classList.add('non-standard-sizes');
                showToast('Shorts product - click + to select waist sizes', 'info', 4000);
                return;
            }

            if (sizeInfo.useQtyOnly) {
                // OSFA-only: Hide all size columns, convert to single qty input
                sizeInputs.forEach(input => {
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = '-';
                    input.closest('td').classList.add('size-disabled');
                });

                // Convert XXXL cell to qty input for OSFA
                if (xxxlCell) {
                    xxxlCell.classList.remove('xxxl-picker-btn');
                    xxxlCell.classList.add('osfa-qty-input');
                    xxxlCell.removeAttribute('readonly');
                    xxxlCell.type = 'number';
                    xxxlCell.min = '0';
                    xxxlCell.placeholder = 'Qty';
                    xxxlCell.value = '';
                    xxxlCell.disabled = false;
                    xxxlCell.onclick = null;
                    xxxlCell.onkeydown = null;
                    xxxlCell.onchange = () => onOSFAQtyChange(rowId);
                    xxxlCell.closest('td').classList.remove('size-disabled');
                }

                // Update header for this row (visual indicator)
                row.classList.add('osfa-only-row');

            } else if (sizeInfo.category === 'tall-only') {
                // TALL products: All sizes via extended size popup (like OSFA but with size picker)
                // Parent row has disabled columns; child rows handle each tall size
                const ALL_TALL = ['LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT'];
                const availableTallSizes = ALL_TALL.filter(s => sizeInfo.columns.includes(s));

                // Disable ALL size columns (parent row doesn't take quantities)
                sizeInputs.forEach((input, index) => {
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = '-';
                    input.closest('td').classList.add('size-disabled');
                });

                // Enable XXXL picker for ALL tall sizes
                if (availableTallSizes.length > 0 && xxxlCell) {
                    row.dataset.extendedSizes = JSON.stringify(availableTallSizes);
                    xxxlCell.disabled = false;
                    xxxlCell.placeholder = '+';
                    xxxlCell.closest('td').classList.remove('size-disabled');
                } else if (xxxlCell) {
                    xxxlCell.disabled = true;
                    xxxlCell.placeholder = '-';
                    xxxlCell.closest('td').classList.add('size-disabled');
                }

                row.classList.add('non-standard-sizes');
                row.classList.add('tall-only-row');

            } else if (sizeInfo.category !== 'standard' && sizeInfo.category !== 'unknown') {
                // Non-standard columns (combo, youth, toddler)
                const columns = sizeInfo.columns;

                sizeInputs.forEach((input, index) => {
                    if (index < columns.length) {
                        // Remap this column to new size
                        const newSize = columns[index];
                        input.dataset.size = newSize;
                        input.disabled = false;
                        input.placeholder = '0';
                        input.closest('td').classList.remove('size-disabled');

                        // Update column header visually
                        updateColumnLabel(row, index, newSize);
                    } else {
                        // Hide extra columns
                        input.disabled = true;
                        input.value = '';
                        input.placeholder = '-';
                        input.closest('td').classList.add('size-disabled');
                    }
                });

                // Handle XXXL picker based on extended sizes
                if (!sizeInfo.extendedSizes || sizeInfo.extendedSizes.length === 0) {
                    if (xxxlCell) {
                        xxxlCell.disabled = true;
                        xxxlCell.placeholder = '-';
                        xxxlCell.closest('td').classList.add('size-disabled');
                    }
                }

                // Add visual indicator class
                row.classList.add('non-standard-sizes');
            }
            // Standard category keeps default UI
        }

        /**
         * Update column label for a specific row's size input
         * Creates inline label overlay showing the actual size name
         */
        function updateColumnLabel(row, colIndex, newLabel) {
            const sizeInputs = row.querySelectorAll('.size-input:not(.xxxl-picker-btn)');
            const input = sizeInputs[colIndex];
            if (!input) return;

            const td = input.closest('td');

            // Add a label overlay showing the size
            let label = td.querySelector('.size-label-override');
            if (!label) {
                label = document.createElement('span');
                label.className = 'size-label-override';
                td.insertBefore(label, input);
            }
            label.textContent = newLabel;
        }

        /**
         * Handle quantity change for OSFA-only products
         * Updates dataset, qty display, and triggers pricing recalculation
         */
        function onOSFAQtyChange(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            const osfaInput = row.querySelector('.osfa-qty-input');
            const qty = parseInt(osfaInput?.value) || 0;

            // Store OSFA qty in dataset
            row.dataset.osfaQty = qty;
            row.dataset.isOsfaOnly = 'true';

            // Update qty display
            const qtyDisplay = document.getElementById(`row-qty-${rowId}`);
            if (qtyDisplay) qtyDisplay.textContent = qty;

            // Trigger pricing recalculation
            recalculatePricing();
        }

        /**
         * Fetch available sizes and adjust UI based on product type
         * Called after color selection to determine proper size columns
         */
        async function detectAndAdjustSizeUI(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            const styleNumber = row.dataset.style;
            const catalogColor = row.dataset.catalogColor;

            if (!styleNumber || !catalogColor) return;

            try {
                // Fetch all available sizes for this style+color
                const url = `${API_BASE}/api/sanmar-shopworks/import-format?styleNumber=${encodeURIComponent(styleNumber)}&color=${encodeURIComponent(catalogColor)}`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.error(`[Size Detection] API failed for ${styleNumber}:`);
                    console.error(`  Status: ${response.status} ${response.statusText}`);
                    console.error(`  URL: ${url}`);
                    console.error(`  CatalogColor: ${catalogColor}`);

                    // Try fallback: fetch without color filter to at least get size info
                    try {
                        const altUrl = `${API_BASE}/api/sanmar-shopworks/import-format?styleNumber=${encodeURIComponent(styleNumber)}`;
                        console.log(`[Size Detection] Trying fallback without color: ${altUrl}`);
                        const altResponse = await fetch(altUrl);

                        if (altResponse.ok) {
                            const skus = await altResponse.json();
                            if (skus && skus.length > 0) {
                                console.log(`[Size Detection] Fallback succeeded with ${skus.length} SKUs`);
                                const allSizes = extractAllSizes(skus);
                                const sizeInfo = analyzeSizeCategory(allSizes);
                                console.log(`ðŸ“ Size category for ${styleNumber} (fallback): ${sizeInfo.category}`, sizeInfo);
                                updateRowForSizeCategory(row, sizeInfo);
                                row.dataset.availableSizes = JSON.stringify(allSizes);
                                return;
                            }
                        }
                    } catch (fallbackError) {
                        console.error('[Size Detection] Fallback also failed:', fallbackError);
                    }
                    return;
                }

                const skus = await response.json();

                // Extract ALL available sizes (not just Size06)
                const allSizes = extractAllSizes(skus);

                // Analyze and update UI
                const sizeInfo = analyzeSizeCategory(allSizes);
                console.log(`ðŸ“ Size category for ${styleNumber}: ${sizeInfo.category}`, sizeInfo);

                updateRowForSizeCategory(row, sizeInfo);

                // Store for pricing calculations
                row.dataset.availableSizes = JSON.stringify(allSizes);

                // Validate size availability using SKU service
                validateSizeAvailability(row, allSizes);

            } catch (error) {
                console.error('Error detecting size category:', error);
            }
        }

        /**
         * Validate size availability and update UI indicators
         * Uses SKUValidationService to check which sizes exist in ShopWorks
         *
         * @param {HTMLElement} row - Product row element
         * @param {string[]} availableSizes - Sizes available for this product/color
         */
        function validateSizeAvailability(row, availableSizes) {
            if (!row || !availableSizes) return;

            const styleNumber = row.dataset.style;
            const catalogColor = row.dataset.catalogColor;
            const skuService = window.skuValidationService || new SKUValidationService();
            window.skuValidationService = skuService; // Cache for reuse

            // Get all size inputs in this row
            const sizeInputs = row.querySelectorAll('.size-input:not(.xxxl-picker-btn)');
            const xxxlCell = row.querySelector('.xxxl-picker-btn');

            // Standard size columns (S, M, L, XL, XXL)
            const columnSizes = ['S', 'M', 'L', 'XL', '2XL'];

            sizeInputs.forEach((input, index) => {
                const size = columnSizes[index];
                if (!size) return;

                const isAvailable = availableSizes.includes(size);
                const sku = skuService.sanmarToShopWorksSKU(styleNumber, size);

                // Update input state based on availability
                if (isAvailable) {
                    input.classList.add('size-available');
                    input.classList.remove('size-unavailable');
                    input.disabled = false;
                    input.placeholder = '0';
                    input.title = `${size} (SKU: ${sku})`;
                } else {
                    input.classList.add('size-unavailable');
                    input.classList.remove('size-available');
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = 'N/A';
                    input.title = `${size} not available for this style/color`;
                    input.closest('td')?.classList.add('size-disabled');
                }

                // Store SKU on input for reference
                input.dataset.sku = sku;
            });

            // Update extended size picker (XXXL column) if present
            if (xxxlCell && !xxxlCell.classList.contains('osfa-qty-input')) {
                const extendedSizes = availableSizes.filter(s =>
                    !columnSizes.includes(s) && s !== 'OSFA'
                );
                const hasExtended = extendedSizes.length > 0;

                if (hasExtended) {
                    xxxlCell.classList.remove('size-unavailable');
                    xxxlCell.disabled = false;
                    xxxlCell.title = `Extended sizes: ${extendedSizes.join(', ')}`;
                    row.dataset.extendedSizes = JSON.stringify(extendedSizes);
                } else {
                    xxxlCell.classList.add('size-unavailable');
                    xxxlCell.disabled = true;
                    xxxlCell.placeholder = '-';
                    xxxlCell.title = 'No extended sizes available';
                }
            }

            console.log(`[SKU Validation] ${styleNumber} validated:`, {
                availableSizes,
                catalogColor,
                validatedAt: new Date().toISOString()
            });
        }

        /**
         * Extract ALL sizes from SKU data (Size01-06 fields)
         * Returns sizes in logical display order
         */
        function extractAllSizes(skus) {
            const sizes = new Set();

            skus.forEach(sku => {
                ['Size01', 'Size02', 'Size03', 'Size04', 'Size05', 'Size06'].forEach(field => {
                    if (sku[field] && typeof sku[field] === 'string' && sku[field].trim()) {
                        sizes.add(sku[field].trim());
                    }
                });
            });

            // Return in logical order
            const ORDER = ['S', 'M', 'L', 'XL', '2XL', 'XS', 'S/M', 'M/L', 'L/XL',
                           'YXS', 'YS', 'YM', 'YL', 'YXL', '2T', '3T', '4T', '5T', '6T',
                           'LT', 'XLT', '2XLT', '3XLT', 'OSFA', 'OSFM'];
            return [...sizes].sort((a, b) => {
                const ai = ORDER.indexOf(a);
                const bi = ORDER.indexOf(b);
                if (ai === -1 && bi === -1) return a.localeCompare(b);
                if (ai === -1) return 1;
                if (bi === -1) return -1;
                return ai - bi;
            });
        }

        // Generate inline style for color swatch (image or fallback hex)
        function getSwatchStyle(color) {
            if (color.COLOR_SQUARE_IMAGE) {
                return `background-image: url('${color.COLOR_SQUARE_IMAGE}'); background-size: cover; background-position: center;`;
            }
            return `background-color: ${color.HEX_CODE || '#ccc'};`;
        }

        // ============================================================
        // COLOR PICKER FUNCTIONS
        // ============================================================

        /**
         * Toggle color picker dropdown open/closed
         */
        function toggleColorPicker(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const pickerSelected = row.querySelector('.color-picker-selected');
            const dropdown = row.querySelector('.color-picker-dropdown');

            // Don't open if disabled
            if (pickerSelected.classList.contains('disabled')) return;

            // Close all other open dropdowns first
            document.querySelectorAll('.color-picker-dropdown').forEach(d => {
                if (d !== dropdown) d.classList.add('hidden');
            });

            // Toggle this dropdown
            dropdown.classList.toggle('hidden');

            // Scroll selected option into view if open
            if (!dropdown.classList.contains('hidden')) {
                const selectedOption = dropdown.querySelector('.color-picker-option.selected');
                if (selectedOption) {
                    selectedOption.scrollIntoView({ block: 'nearest' });
                }
            }
        }

        /**
         * Detect if product is tall/youth/toddler-only and gray out unavailable size columns
         * This improves UX by showing users which sizes actually exist for the product
         */
        async function detectProductTypeAndAdjustUI(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            const style = row.dataset.style;
            const catalogColor = row.dataset.catalogColor;
            if (!style || !catalogColor) return;

            try {
                // Fetch available sizes from API
                const availableSizes = await getAvailableExtendedSizes(style, catalogColor);

                // Check for standard sizes (S, M, L, XL)
                const standardSizeLabels = ['S', 'M', 'L', 'XL'];
                const hasStandardSizes = standardSizeLabels.some(s => availableSizes.includes(s));

                // Detect tall/youth/toddler-only products
                const tallSizes = ['LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT', 'ST', 'MT', 'XST'];
                const youthSizes = ['YXS', 'YS', 'YM', 'YL', 'YXL'];
                const toddlerSizes = ['2T', '3T', '4T', '5T', '5/6T', '6T'];

                const hasTallOnly = !hasStandardSizes && availableSizes.some(s => tallSizes.includes(s));
                const hasYouthOnly = !hasStandardSizes && availableSizes.some(s => youthSizes.includes(s));
                const hasToddlerOnly = !hasStandardSizes && availableSizes.some(s => toddlerSizes.includes(s));

                if (hasTallOnly || hasYouthOnly || hasToddlerOnly) {
                    // Gray out standard size columns - they don't exist for this product
                    standardSizeLabels.forEach(size => {
                        const input = row.querySelector(`input[data-size="${size}"]`);
                        if (input) {
                            input.disabled = true;
                            input.value = '';
                            input.placeholder = 'N/A';
                            input.style.backgroundColor = '#f0f0f0';
                            input.style.color = '#999';
                            input.title = 'Size not available for this product';
                        }
                    });

                    // Store product type for reference
                    row.dataset.productType = hasTallOnly ? 'tall-only' :
                                               hasYouthOnly ? 'youth-only' : 'toddler-only';

                    // Focus on the extended size picker instead
                    const xxxlInput = row.querySelector('input[data-size="3XL"]');
                    if (xxxlInput) xxxlInput.focus();
                }
            } catch (error) {
                console.warn('Could not detect product type for UI adjustment:', error);
            }
        }

        /**
         * Select a color from the dropdown
         */
        function selectColor(rowId, optionEl) {
            const row = document.getElementById(`row-${rowId}`);
            const colorName = optionEl.dataset.colorName;
            const catalogColor = optionEl.dataset.catalogColor;
            const swatchUrl = optionEl.dataset.swatchUrl;
            const hex = optionEl.dataset.hex;
            const style = row.dataset.style;

            // Check for duplicate row (same style + color)
            const existingRow = findExistingRow(style, catalogColor, rowId);
            if (existingRow) {
                showToast(`${style} in ${colorName} already exists. Adding to existing row.`, 'info');
                row.querySelector('.color-picker-dropdown').classList.add('hidden');
                const existingFirstSize = existingRow.querySelector('.size-input:not([disabled])');
                if (existingFirstSize) existingFirstSize.focus();
                return;
            }

            // Update selected display with swatch and full color name
            const pickerSelected = row.querySelector('.color-picker-selected');
            const swatch = pickerSelected.querySelector('.color-swatch');
            const nameSpan = pickerSelected.querySelector('.color-name');

            // Set swatch style (image or hex fallback)
            if (swatchUrl) {
                swatch.style.backgroundImage = `url('${swatchUrl}')`;
                swatch.style.backgroundColor = '';
                swatch.style.backgroundSize = 'cover';
                swatch.style.backgroundPosition = 'center';
            } else {
                swatch.style.backgroundImage = '';
                swatch.style.backgroundColor = hex || '#ccc';
            }
            swatch.classList.remove('empty');

            // Set full color name
            nameSpan.textContent = colorName;
            nameSpan.classList.remove('placeholder');

            // Mark selected option in dropdown
            row.querySelectorAll('.color-picker-option').forEach(opt => opt.classList.remove('selected'));
            optionEl.classList.add('selected');

            // Store data on row
            row.dataset.color = colorName;
            row.dataset.catalogColor = catalogColor;
            row.dataset.swatchUrl = swatchUrl || '';
            row.dataset.hex = hex || '';

            // Close dropdown
            row.querySelector('.color-picker-dropdown').classList.add('hidden');

            // Enable size inputs initially (may be disabled by detectAndAdjustSizeUI for special products)
            row.querySelectorAll('.size-input').forEach(input => input.disabled = false);

            // Detect size category and adjust UI (OSFA, combo, youth, toddler, tall, standard)
            // This runs async but doesn't block - will update UI when API returns
            detectAndAdjustSizeUI(rowId);

            // Focus first size input (may be overridden by detectAndAdjustSizeUI for special products)
            const firstSize = row.querySelector('.size-input');
            if (firstSize) firstSize.focus();

            // Cascade to child rows if any
            cascadeColorToChildRows(rowId, colorName, catalogColor, swatchUrl, hex);

            recalculatePricing();
        }

        /**
         * Cascade color selection to child rows (for extended sizes)
         */
        function cascadeColorToChildRows(parentRowId, colorName, catalogColor, swatchUrl, hex) {
            if (!childRowMap[parentRowId]) return;

            Object.values(childRowMap[parentRowId]).forEach(childRowId => {
                const childRow = document.getElementById(`row-${childRowId}`);
                if (childRow && childRow.dataset.colorManuallySet !== 'true') {
                    childRow.dataset.color = colorName;
                    childRow.dataset.catalogColor = catalogColor;

                    // Update child row's color picker display if it has one
                    const childPicker = childRow.querySelector('.color-picker-selected');
                    if (childPicker) {
                        const childSwatch = childPicker.querySelector('.color-swatch');
                        const childName = childPicker.querySelector('.color-name');
                        if (childSwatch && childName) {
                            if (swatchUrl) {
                                childSwatch.style.backgroundImage = `url('${swatchUrl}')`;
                                childSwatch.style.backgroundColor = '';
                            } else {
                                childSwatch.style.backgroundImage = '';
                                childSwatch.style.backgroundColor = hex || '#ccc';
                            }
                            childSwatch.classList.remove('empty');
                            childName.textContent = colorName;
                            childName.classList.remove('placeholder');
                        }
                    }
                }
            });
            updateChildRowColorIndicators(parentRowId);
        }

        /**
         * Handle keyboard navigation in color picker
         */
        function handleColorPickerKeydown(event, rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const dropdown = row.querySelector('.color-picker-dropdown');
            const isOpen = !dropdown.classList.contains('hidden');

            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleColorPicker(rowId);
            } else if (event.key === 'Escape' && isOpen) {
                event.preventDefault();
                dropdown.classList.add('hidden');
            } else if (event.key === 'ArrowDown' && isOpen) {
                event.preventDefault();
                navigateOptions(dropdown, 1);
            } else if (event.key === 'ArrowUp' && isOpen) {
                event.preventDefault();
                navigateOptions(dropdown, -1);
            } else if (event.key === 'Tab') {
                // Close dropdown on tab
                dropdown.classList.add('hidden');
            }
        }

        /**
         * Navigate through dropdown options with arrow keys
         */
        function navigateOptions(dropdown, direction) {
            const options = dropdown.querySelectorAll('.color-picker-option');
            if (options.length === 0) return;

            let currentIndex = -1;
            options.forEach((opt, i) => {
                if (opt.classList.contains('focused')) currentIndex = i;
            });

            // Remove current focus
            options.forEach(opt => opt.classList.remove('focused'));

            // Calculate new index
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = options.length - 1;
            if (newIndex >= options.length) newIndex = 0;

            // Add focus to new option
            options[newIndex].classList.add('focused');
            options[newIndex].scrollIntoView({ block: 'nearest' });
        }

        // Click outside handler to close all dropdowns
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.color-picker-wrapper')) {
                document.querySelectorAll('.color-picker-dropdown').forEach(d => d.classList.add('hidden'));
            }
        });

        /**
         * Select a color for a child row (extended size)
         * Similar to selectColor but marks color as manually set
         */
        function selectChildColor(childRowId, parentRowId, optionEl) {
            const childRow = document.getElementById(`row-${childRowId}`);
            const colorName = optionEl.dataset.colorName;
            const catalogColor = optionEl.dataset.catalogColor;
            const swatchUrl = optionEl.dataset.swatchUrl;
            const hex = optionEl.dataset.hex;

            // Update selected display with swatch and full color name
            const pickerSelected = childRow.querySelector('.color-picker-selected');
            const swatch = pickerSelected.querySelector('.color-swatch');
            const nameSpan = pickerSelected.querySelector('.color-name');

            // Set swatch style (image or hex fallback)
            if (swatchUrl) {
                swatch.style.backgroundImage = `url('${swatchUrl}')`;
                swatch.style.backgroundColor = '';
                swatch.style.backgroundSize = 'cover';
                swatch.style.backgroundPosition = 'center';
            } else {
                swatch.style.backgroundImage = '';
                swatch.style.backgroundColor = hex || '#ccc';
            }
            swatch.classList.remove('empty');

            // Set full color name
            nameSpan.textContent = colorName;
            nameSpan.classList.remove('placeholder');

            // Mark selected option in dropdown
            childRow.querySelectorAll('.color-picker-option').forEach(opt => opt.classList.remove('selected'));
            optionEl.classList.add('selected');

            // Store data on row
            childRow.dataset.color = colorName;
            childRow.dataset.catalogColor = catalogColor;
            childRow.dataset.swatchUrl = swatchUrl || '';
            childRow.dataset.hex = hex || '';
            childRow.dataset.colorManuallySet = 'true';  // Mark as manually changed

            // Close dropdown
            childRow.querySelector('.color-picker-dropdown').classList.add('hidden');

            // Update visual indicator for different color
            updateChildRowColorIndicators(parentRowId);

            recalculatePricing();
        }

        async function onColorChange(select, rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const color = select.value;

            if (!color) return;

            const selectedOption = select.options[select.selectedIndex];
            const catalogColor = selectedOption.dataset.catalog || '';
            const style = row.dataset.style;

            // Check for duplicate row (same style + color)
            const existingRow = findExistingRow(style, catalogColor, rowId);
            if (existingRow) {
                // Show toast and focus on existing row
                showToast(`${style} in ${color} already exists. Adding to existing row.`, 'info');

                // Clear this row's color selection
                select.value = '';

                // Focus on the existing row's first size input
                const existingFirstSize = existingRow.querySelector('.size-input:not([disabled])');
                if (existingFirstSize) existingFirstSize.focus();
                return;
            }

            row.dataset.color = color;
            row.dataset.catalogColor = catalogColor;

            // Enable size inputs
            row.querySelectorAll('.size-input').forEach(input => {
                input.disabled = false;
            });

            // Cascade color change to child rows that haven't been manually edited
            if (childRowMap[rowId]) {
                Object.entries(childRowMap[rowId]).forEach(([size, childRowId]) => {
                    const childRow = document.getElementById(`row-${childRowId}`);
                    if (childRow && childRow.dataset.colorManuallySet !== 'true') {
                        // Update child row color
                        childRow.dataset.color = color;
                        childRow.dataset.catalogColor = catalogColor;

                        // Update child row's color dropdown selection
                        const childColorSelect = childRow.querySelector('.child-color-select');
                        if (childColorSelect) {
                            childColorSelect.value = color;
                        }

                        console.log(`Cascaded color change to child row ${childRowId}: ${color}`);
                    }
                });
                updateChildRowColorIndicators(rowId);
            }

            // Focus first size input
            const firstSize = row.querySelector('.size-input');
            if (firstSize) firstSize.focus();
        }

        /**
         * Handle color change in a child row
         * Updates child row's color and marks it as manually set
         */
        function onChildColorChange(select, childRowId, parentRowId) {
            const childRow = document.getElementById(`row-${childRowId}`);
            if (!childRow) return;

            const color = select.value;
            const selectedOption = select.options[select.selectedIndex];
            const catalogColor = selectedOption.dataset.catalog || '';

            // Update child row data attributes
            childRow.dataset.color = color;
            childRow.dataset.catalogColor = catalogColor;
            childRow.dataset.colorManuallySet = 'true';  // Mark as manually edited

            // Update visual indicator
            updateChildRowColorIndicators(parentRowId);

            console.log(`Child row ${childRowId} color changed to ${color} (catalog: ${catalogColor})`);

            // Recalculate pricing
            recalculatePricing();
        }

        /**
         * Update visual styling for child rows based on color match with parent
         */
        function updateChildRowColorIndicators(parentRowId) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow) return;

            const parentCatalogColor = parentRow.dataset.catalogColor;

            if (childRowMap[parentRowId]) {
                Object.values(childRowMap[parentRowId]).forEach(childRowId => {
                    const childRow = document.getElementById(`row-${childRowId}`);
                    if (childRow) {
                        if (childRow.dataset.catalogColor !== parentCatalogColor) {
                            childRow.classList.add('different-color');
                        } else {
                            childRow.classList.remove('different-color');
                        }
                    }
                });
            }
        }

        /**
         * Find an existing row with the same style and catalogColor (excluding current row)
         */
        function findExistingRow(style, catalogColor, excludeRowId) {
            const rows = document.querySelectorAll('#product-tbody tr:not(.child-row)');
            for (const row of rows) {
                const rowNumericId = parseInt(row.id.replace('row-', ''));
                if (rowNumericId === excludeRowId) continue;
                if (row.dataset.style === style && row.dataset.catalogColor === catalogColor) {
                    return row;
                }
            }
            return null;
        }

        function onSizeChange(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            // Skip if this is a child row (child rows don't trigger size changes)
            if (row.classList.contains('child-row')) {
                recalculatePricing();
                return;
            }

            const sizeCategory = row.dataset.sizeCategory;

            // OSFA-only products are handled separately by onOSFAQtyChange()
            if (sizeCategory === 'osfa-only') {
                recalculatePricing();
                return;
            }

            // Calculate total from ALL enabled size inputs (handles remapped columns)
            // This works for standard, combo-only, youth-only, toddler-only, tall-only
            let total = 0;
            row.querySelectorAll('.size-input:not(.xxxl-picker-btn):not(.osfa-qty-input):not(:disabled)').forEach(input => {
                total += parseInt(input.value) || 0;
            });

            // Add quantities from child rows (extended sizes)
            const childRows = document.querySelectorAll(`tr[data-parent-row-id="${rowId}"]`);
            childRows.forEach(childRow => {
                const qtyDisplay = childRow.querySelector('.qty-display');
                total += parseInt(qtyDisplay?.textContent) || 0;
            });

            // Update parent row quantity display
            document.getElementById(`row-qty-${rowId}`).textContent = total;

            // Handle 2XL size (has direct input) - create/update/remove child rows
            // Note: Size06 sizes (XS, 3XL, 4XL, 5XL, 6XL) are handled by the Extended Size Picker popup
            const xxlInput = row.querySelector('[data-size="2XL"]');
            if (xxlInput) {
                const qty = parseInt(xxlInput.value) || 0;
                const existingChildId = childRowMap[rowId]?.['2XL'];

                if (qty > 0) {
                    // Need a child row for 2XL
                    if (existingChildId) {
                        updateChildRow(existingChildId, qty);
                    } else {
                        createChildRow(rowId, '2XL', qty);
                    }
                    // Disable the 2XL input in parent
                    xxlInput.disabled = true;
                    xxlInput.style.background = '#f5f5f5';
                    xxlInput.style.color = '#999';
                } else {
                    // Remove child row if it exists
                    if (existingChildId) {
                        removeChildRow(rowId, '2XL');
                    }
                    // Re-enable 2XL input in parent
                    xxlInput.disabled = false;
                    xxlInput.style.background = '';
                    xxlInput.style.color = '';
                }
            }

            // Recalculate pricing
            recalculatePricing();
        }

        /**
         * Generate ShopWorks-compatible part number
         * Uses SIZE_TO_SUFFIX which contains ALL size suffixes (tall, youth, toddler, etc.)
         */
        function getPartNumber(baseStyle, size) {
            // For pants sizes (4-digit codes like 3032), append directly with underscore
            if (/^\d{4}$/.test(size)) {
                return `${baseStyle}_${size}`;
            }
            return baseStyle + (SIZE_TO_SUFFIX[size] || '');
        }

        /**
         * Create a child row for an extended size
         */
        function createChildRow(parentRowId, size, qty) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow) return;

            const childRowId = ++rowCounter;
            const baseStyle = parentRow.dataset.style;
            const partNumber = getPartNumber(baseStyle, size);

            // Get parent's available colors for the dropdown
            const parentColors = parentRow.dataset.colors ? JSON.parse(parentRow.dataset.colors) : [];
            const parentColor = parentRow.dataset.color || '';
            const parentCatalogColor = parentRow.dataset.catalogColor || '';
            const parentSwatchUrl = parentRow.dataset.swatchUrl || '';
            const parentHex = parentRow.dataset.hex || '#ccc';

            // Build color picker options HTML with swatches
            const colorOptionsHtml = parentColors.map(c =>
                `<div class="color-picker-option ${c.COLOR_NAME === parentColor ? 'selected' : ''}"
                     data-color-name="${escapeHtml(c.COLOR_NAME)}"
                     data-catalog-color="${escapeHtml(c.CATALOG_COLOR || c.COLOR_NAME)}"
                     data-swatch-url="${escapeHtml(c.COLOR_SQUARE_IMAGE || '')}"
                     data-hex="${escapeHtml(c.HEX_CODE || '#ccc')}"
                     onclick="selectChildColor(${childRowId}, ${parentRowId}, this)">
                    <span class="color-swatch" style="${getSwatchStyle(c)}"></span>
                    <span class="color-name">${escapeHtml(c.COLOR_NAME)}</span>
                </div>`
            ).join('');

            // Build current color display
            const currentSwatchStyle = parentSwatchUrl
                ? `background-image: url('${parentSwatchUrl}'); background-size: cover; background-position: center;`
                : `background-color: ${parentHex};`;

            const childRow = document.createElement('tr');
            childRow.id = `row-${childRowId}`;
            childRow.className = 'child-row';
            childRow.dataset.rowId = childRowId;
            childRow.dataset.parentRowId = parentRowId;
            childRow.dataset.extendedSize = size;
            childRow.dataset.style = partNumber;
            childRow.dataset.baseStyle = baseStyle;
            childRow.dataset.color = parentRow.dataset.color;
            childRow.dataset.catalogColor = parentRow.dataset.catalogColor;
            childRow.dataset.swatchUrl = parentSwatchUrl;
            childRow.dataset.hex = parentHex;
            childRow.dataset.productName = parentRow.dataset.productName;
            childRow.dataset.colorManuallySet = 'false';  // Track if user manually changed color

            // Determine which column this size goes to:
            // - Size05 (XXL column): only 2XL
            // - Size06 (XXXL column): XS, 3XL, 4XL, 5XL, 6XL, pants sizes, shorts sizes
            const isSize05 = size === '2XL';
            const isPantsSize = /^\d{4}$/.test(size);  // 4-digit pants sizes like 3032
            const isShortsSize = /^W\d{2}$/.test(size);  // Waist-only shorts sizes like W30
            const isSize06 = SIZE06_EXTENDED_SIZES.includes(size) || isPantsSize || isShortsSize;

            // Format display size (pants: "3032" -> "30x32", shorts: "W30" -> "Waist 30", others: keep as-is)
            let displaySize = size;
            if (isPantsSize) {
                const waist = size.substring(0, 2);
                const inseam = size.substring(2, 4);
                displaySize = `${waist}x${inseam}`;
            } else if (isShortsSize) {
                const waist = size.replace('W', '');
                displaySize = `Waist ${waist}`;
            }

            // Create cell content - only the specific size column is editable
            childRow.innerHTML = `
                <td>
                    <span class="child-indicator">â””</span>
                    <span class="style-display">${partNumber}</span>
                </td>
                <td>
                    <span class="desc-display" style="color: #666; font-size: 12px;">${escapeHtml(parentRow.dataset.productName)} - <strong>${displaySize}</strong></span>
                </td>
                <td>
                    <div class="color-picker-wrapper child-color-picker" data-row-id="${childRowId}">
                        <div class="color-picker-selected" onclick="toggleColorPicker(${childRowId})" tabindex="0" onkeydown="handleColorPickerKeydown(event, ${childRowId})">
                            <span class="color-swatch" style="${currentSwatchStyle}"></span>
                            <span class="color-name">${escapeHtml(parentColor)}</span>
                            <i class="fas fa-chevron-down picker-arrow"></i>
                        </div>
                        <div class="color-picker-dropdown hidden" id="color-dropdown-${childRowId}">
                            ${colorOptionsHtml}
                        </div>
                    </div>
                </td>
                <td><input type="number" class="cell-input size-input" data-size="S" disabled value="" style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" data-size="M" disabled value="" style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" data-size="L" disabled value="" style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" data-size="XL" disabled value="" style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" data-size="2XL" ${isSize05 ? '' : 'disabled'} value="${isSize05 ? qty : ''}" placeholder="${isSize05 ? qty : ''}" style="${isSize05 ? '' : 'background: #f5f5f5;'}" onchange="onChildSizeChange(${childRowId}, ${parentRowId}, '${size}')" onkeydown="handleCellKeydown(event, this)"></td>
                <td><input type="number" class="cell-input size-input" data-size="${size}" ${isSize06 ? '' : 'disabled'} value="${isSize06 ? qty : ''}" placeholder="${isSize06 ? qty : ''}" style="${isSize06 ? '' : 'background: #f5f5f5;'}" onchange="onChildSizeChange(${childRowId}, ${parentRowId}, '${size}')" onkeydown="handleCellKeydown(event, this)"></td>
                <td class="cell-qty qty-display" id="row-qty-${childRowId}">${qty}</td>
                <td class="cell-price unit-price-display" id="row-price-${childRowId}">-</td>
                <td class="cell-actions">
                    <button class="btn-delete-row" onclick="clearExtendedSize(${parentRowId}, '${size}')" title="Remove ${displaySize}">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            // Insert in correct size order: XS, 2XL, 3XL, 4XL, 5XL, 6XL
            const existingChildren = Array.from(document.querySelectorAll(`tr[data-parent-row-id="${parentRowId}"]`));

            if (existingChildren.length === 0) {
                // No children yet, insert after parent
                parentRow.after(childRow);
            } else {
                // Find correct position based on size order (XS first, then 2XL, 3XL, etc.)
                const newSizeIndex = EXTENDED_SIZE_ORDER.indexOf(size);
                let insertAfter = parentRow;  // Default: after parent (for XS or first size)

                for (const existingChild of existingChildren) {
                    const existingSize = existingChild.dataset.extendedSize;
                    const existingSizeIndex = EXTENDED_SIZE_ORDER.indexOf(existingSize);

                    // If existing size comes before new size in order, insert after this child
                    if (existingSizeIndex < newSizeIndex) {
                        insertAfter = existingChild;
                    } else {
                        // Found a size that should come after us, stop here
                        break;
                    }
                }

                insertAfter.after(childRow);
            }

            // Track child row
            if (!childRowMap[parentRowId]) {
                childRowMap[parentRowId] = {};
            }
            childRowMap[parentRowId][size] = childRowId;

            console.log(`Created child row ${childRowId} for ${baseStyle} ${size}`);
        }

        /**
         * Update an existing child row quantity
         */
        function updateChildRow(childRowId, qty) {
            const childRow = document.getElementById(`row-${childRowId}`);
            if (!childRow) return;

            const size = childRow.dataset.extendedSize;
            const sizeInput = childRow.querySelector(`[data-size="${size}"]`);
            if (sizeInput) {
                sizeInput.value = qty;
            }
            document.getElementById(`row-qty-${childRowId}`).textContent = qty;
        }

        /**
         * Remove a child row
         */
        function removeChildRow(parentRowId, size) {
            const childRowId = childRowMap[parentRowId]?.[size];
            if (childRowId) {
                const childRow = document.getElementById(`row-${childRowId}`);
                if (childRow) {
                    childRow.remove();
                }
                delete childRowMap[parentRowId][size];
            }
        }

        /**
         * Handle size change in child row - sync back to parent
         */
        function onChildSizeChange(childRowId, parentRowId, size) {
            const childRow = document.getElementById(`row-${childRowId}`);
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!childRow || !parentRow) return;

            const sizeInput = childRow.querySelector(`[data-size="${size}"]`);
            const qty = parseInt(sizeInput?.value) || 0;

            // Update child row quantity display
            document.getElementById(`row-qty-${childRowId}`).textContent = qty;

            // Sync back to parent row's hidden input
            const parentInput = parentRow.querySelector(`[data-size="${size}"]`);
            if (parentInput) {
                parentInput.value = qty;
            }

            // If qty is 0, remove the child row
            if (qty === 0) {
                clearExtendedSize(parentRowId, size);
            }

            recalculatePricing();
        }

        /**
         * Clear an extended size (remove child row, enable parent input)
         */
        function clearExtendedSize(parentRowId, size) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow) return;

            // Clear parent input
            const parentInput = parentRow.querySelector(`[data-size="${size}"]`);
            if (parentInput) {
                parentInput.value = '';
                parentInput.disabled = false;
                parentInput.style.background = '';
                parentInput.style.color = '';
            }

            // Remove child row
            removeChildRow(parentRowId, size);

            recalculatePricing();
        }

        function deleteRow(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            // If this is a parent row, also remove all child rows
            if (!row.classList.contains('child-row') && childRowMap[rowId]) {
                Object.keys(childRowMap[rowId]).forEach(size => {
                    const childRowId = childRowMap[rowId][size];
                    const childRow = document.getElementById(`row-${childRowId}`);
                    if (childRow) {
                        childRow.remove();
                    }
                });
                delete childRowMap[rowId];
            }

            row.remove();
            recalculatePricing();
        }

        // ============================================================
        // KEYBOARD NAVIGATION (Excel-style)
        // ============================================================

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S = Save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveQuote();
                }

                // Ctrl+P = Print
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    printQuote();
                }
            });
        }

        function handleCellKeydown(event, input) {
            const row = input.closest('tr');
            const cells = Array.from(row.querySelectorAll('input:not([readonly]), select:not(:disabled)'));
            const currentIndex = cells.indexOf(input);

            if (event.key === 'Tab' && !event.shiftKey) {
                // Tab to next cell
                if (currentIndex === cells.length - 1) {
                    // Last cell in row - add new row
                    event.preventDefault();
                    addNewRow();
                }
            } else if (event.key === 'Enter') {
                // Enter = next row
                event.preventDefault();

                const tbody = document.getElementById('product-tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const currentRowIndex = rows.indexOf(row);

                if (currentRowIndex === rows.length - 1) {
                    // Last row - add new
                    addNewRow();
                } else {
                    // Focus same column in next row
                    const nextRow = rows[currentRowIndex + 1];
                    const nextCells = Array.from(nextRow.querySelectorAll('input:not([readonly]), select:not(:disabled)'));
                    if (nextCells[currentIndex]) {
                        nextCells[currentIndex].focus();
                    } else if (nextCells[0]) {
                        nextCells[0].focus();
                    }
                }
            } else if (event.key === 'ArrowDown') {
                // Arrow down
                event.preventDefault();
                const tbody = document.getElementById('product-tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const currentRowIndex = rows.indexOf(row);

                if (currentRowIndex < rows.length - 1) {
                    const nextRow = rows[currentRowIndex + 1];
                    const field = input.dataset.field || input.dataset.size;
                    const nextInput = nextRow.querySelector(`[data-field="${field}"], [data-size="${field}"]`);
                    if (nextInput && !nextInput.disabled) {
                        nextInput.focus();
                    }
                }
            } else if (event.key === 'ArrowUp') {
                // Arrow up
                event.preventDefault();
                const tbody = document.getElementById('product-tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const currentRowIndex = rows.indexOf(row);

                if (currentRowIndex > 0) {
                    const prevRow = rows[currentRowIndex - 1];
                    const field = input.dataset.field || input.dataset.size;
                    const prevInput = prevRow.querySelector(`[data-field="${field}"], [data-size="${field}"]`);
                    if (prevInput && !prevInput.disabled) {
                        prevInput.focus();
                    }
                }
            }
        }

        // ============================================================
        // PRICING CALCULATIONS
        // ============================================================

        async function recalculatePricing() {
            // Collect products from table (parent rows only)
            const productList = collectProductsFromTable();

            if (productList.length === 0) {
                updatePricingDisplay({
                    totalQuantity: 0,
                    tier: '1-23',
                    subtotal: 0,
                    ltmFee: 0,
                    setupFees: 0,
                    grandTotal: 0
                });
                // Clear all price cells
                document.querySelectorAll('.cell-price').forEach(cell => {
                    cell.textContent = '-';
                });
                return;
            }

            // Calculate using the existing pricing calculator
            // Combine primary logo + all additional logos
            const allLogos = [
                { ...primaryLogo, id: 'primary' },
                ...additionalLogos
            ];

            try {
                const pricing = await pricingCalculator.calculateQuote(productList, allLogos);

                if (pricing) {
                    // Update row prices - match line items to rows by style AND color
                    // With different colors per extended size, we now get separate products for each color
                    pricing.products.forEach((pp) => {
                        const style = pp.product.style;
                        const productCatalogColor = pp.product.catalogColor;
                        // Match by BOTH style AND catalogColor to handle duplicate styles with different colors
                        const parentRow = document.querySelector(`tr[data-style="${style}"][data-catalog-color="${productCatalogColor}"]:not(.child-row)`);

                        if (!parentRow) return;

                        const rowId = parentRow.dataset.rowId;
                        const isParentColor = productCatalogColor === parentRow.dataset.catalogColor;

                        if (pp.lineItems.length > 0) {
                            // For products matching the parent's color, update parent row price
                            if (isParentColor) {
                                // Find standard sizes line item (no upcharge)
                                const standardLineItem = pp.lineItems.find(li => !li.hasUpcharge);
                                if (standardLineItem) {
                                    const priceCell = document.getElementById(`row-price-${rowId}`);
                                    if (priceCell) {
                                        // Use unitPriceWithLTM if LTM is distributed, otherwise unitPrice
                                        const displayPrice = ltmDistributed && standardLineItem.unitPriceWithLTM
                                            ? standardLineItem.unitPriceWithLTM
                                            : standardLineItem.unitPrice;
                                        priceCell.textContent = `$${displayPrice.toFixed(2)}`;
                                    }
                                }
                            }

                            // Update child row prices - match by BOTH size AND color
                            // A child row price only updates if its color matches this product's color
                            pp.lineItems.forEach(li => {
                                const description = li.description;
                                // Match ALL extended sizes in description (handles grouped sizes like "3XL(2) 4XL(3)" or "3T(5)")
                                // Uses SIZE06_EXTENDED_SIZES for comprehensive matching including toddler, youth, tall, pants (4-digit), etc.
                                const extendedSizeRegex = new RegExp(
                                    '(' + SIZE06_EXTENDED_SIZES.map(s => s.replace(/\//g, '\\/')).concat(['2XL', '\\d{4}']).join('|') + ')(?=\\(|\\s|$)',
                                    'g'
                                );
                                const sizeMatches = description.match(extendedSizeRegex);
                                if (sizeMatches) {
                                    sizeMatches.forEach(size => {
                                        const childRowId = childRowMap[rowId]?.[size];
                                        if (childRowId) {
                                            const childRow = document.getElementById(`row-${childRowId}`);
                                            // Only update price if child row's color matches this product's color
                                            if (childRow && childRow.dataset.catalogColor === productCatalogColor) {
                                                const childPriceCell = document.getElementById(`row-price-${childRowId}`);
                                                if (childPriceCell) {
                                                    // Use unitPriceWithLTM if LTM is distributed, otherwise unitPrice
                                                    const displayPrice = ltmDistributed && li.unitPriceWithLTM
                                                        ? li.unitPriceWithLTM
                                                        : li.unitPrice;
                                                    childPriceCell.textContent = `$${displayPrice.toFixed(2)}`;
                                                }
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });

                    updatePricingDisplay(pricing);
                }
            } catch (error) {
                console.error('Pricing calculation error:', error);
            }
        }

        function collectProductsFromTable() {
            const products = [];
            // Only collect from parent rows (not child rows)
            const rows = document.querySelectorAll('#product-tbody tr:not(.child-row)');

            rows.forEach(row => {
                const rowId = parseInt(row.id.replace('row-', ''));
                const style = row.dataset.style;
                const parentColor = row.dataset.color;
                const parentCatalogColor = row.dataset.catalogColor || '';

                if (!style || !parentColor) return;

                // Group sizes by color - different colors become separate products
                const colorGroups = {};

                // Initialize parent color group
                colorGroups[parentCatalogColor] = {
                    color: parentColor,
                    catalogColor: parentCatalogColor,
                    sizeBreakdown: {},
                    totalQty: 0
                };

                // Collect size inputs from parent row (standard or remapped sizes)
                // IMPORTANT: Exclude .xxxl-picker-btn (shows TOTAL) and .osfa-qty-input (handled separately)
                // Note: For non-standard products (combo, youth, toddler, tall), data-size is remapped
                const sizeCategory = row.dataset.sizeCategory;
                row.querySelectorAll('.size-input:not(.xxxl-picker-btn):not(.osfa-qty-input):not(:disabled)').forEach(input => {
                    const size = input.dataset.size;
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0 && size) {
                        colorGroups[parentCatalogColor].sizeBreakdown[size] = qty;
                        colorGroups[parentCatalogColor].totalQty += qty;
                    }
                });

                // Handle OSFA-only products (beanies, caps, bags)
                // OSFA qty is stored in parent row, not child rows
                if (row.dataset.isOsfaOnly === 'true') {
                    const osfaQty = parseInt(row.dataset.osfaQty) || 0;
                    if (osfaQty > 0) {
                        colorGroups[parentCatalogColor].sizeBreakdown['OSFA'] = osfaQty;
                        colorGroups[parentCatalogColor].totalQty += osfaQty;
                    }
                }

                // Collect extended sizes from CHILD ROWS - GROUP BY COLOR
                // Child rows may have different colors than parent
                const childRows = document.querySelectorAll(`tr[data-parent-row-id="${rowId}"]`);
                childRows.forEach(childRow => {
                    const size = childRow.dataset.extendedSize;
                    const childColor = childRow.dataset.color;
                    const childCatalogColor = childRow.dataset.catalogColor || '';
                    const qtyDisplay = childRow.querySelector('.qty-display');
                    const qty = parseInt(qtyDisplay?.textContent) || 0;

                    if (qty > 0 && size) {
                        // Initialize color group if different from parent
                        if (!colorGroups[childCatalogColor]) {
                            colorGroups[childCatalogColor] = {
                                color: childColor,
                                catalogColor: childCatalogColor,
                                sizeBreakdown: {},
                                totalQty: 0
                            };
                        }

                        colorGroups[childCatalogColor].sizeBreakdown[size] = qty;
                        colorGroups[childCatalogColor].totalQty += qty;
                    }
                });

                // Create product entry for each color group with quantities
                Object.entries(colorGroups).forEach(([catalogColor, group]) => {
                    if (group.totalQty > 0) {
                        products.push({
                            style: style,
                            color: group.color,
                            catalogColor: group.catalogColor,
                            productName: row.dataset.productName || style,
                            sizeBreakdown: group.sizeBreakdown,
                            totalQuantity: group.totalQty,
                            isCap: row.dataset.isCap === 'true',  // Cap detection for pricing routing
                            logoAssignments: {
                                primary: { logoId: 'primary', quantity: group.totalQty },
                                additional: []
                            }
                        });
                    }
                });
            });

            return products;
        }

        function updatePricingDisplay(pricing) {
            // Store for toggle reference
            window.currentPricingData = pricing;

            document.getElementById('total-qty').textContent = pricing.totalQuantity || 0;
            document.getElementById('pricing-tier').textContent = pricing.tier || '1-23';
            document.getElementById('subtotal').textContent = `$${(pricing.subtotal || 0).toFixed(2)}`;
            document.getElementById('grand-total').textContent = `$${(pricing.grandTotal || 0).toFixed(2)}`;

            // LTM row - keep visible in both states so button is always accessible
            const ltmRow = document.getElementById('ltm-row');
            const ltmBtn = document.getElementById('ltm-distribute-btn');
            const ltmFeeEl = document.getElementById('ltm-fee');

            if (pricing.ltmFee > 0) {
                // Show LTM row (always visible when LTM applies)
                ltmRow.style.display = 'flex';
                const ltmPerUnit = pricing.ltmFee / pricing.totalQuantity;

                if (ltmDistributed) {
                    // Distributed state - LTM built into unit prices
                    ltmFeeEl.textContent = `(+$${ltmPerUnit.toFixed(2)}/ea)`;
                    ltmFeeEl.classList.add('distributed');
                    ltmBtn.querySelector('.btn-text').textContent = 'Show LTM';
                    ltmBtn.classList.add('active');
                } else {
                    // Default state - LTM shown as separate line
                    ltmFeeEl.textContent = `$${pricing.ltmFee.toFixed(2)}`;
                    ltmFeeEl.classList.remove('distributed');
                    ltmBtn.querySelector('.btn-text').textContent = 'Hide LTM';
                    ltmBtn.classList.remove('active');
                }
            } else {
                // No LTM fee (qty >= 24) - hide row entirely
                ltmRow.style.display = 'none';
                // Reset distributed state when LTM no longer applies
                if (ltmDistributed) {
                    ltmDistributed = false;
                }
            }

            // Setup row
            const setupRow = document.getElementById('setup-row');
            if (pricing.setupFees > 0) {
                setupRow.style.display = 'flex';
                document.getElementById('setup-fee').textContent = `$${pricing.setupFees.toFixed(2)}`;
            } else {
                setupRow.style.display = 'none';
            }

            // Additional Stitches row (when primary logo > 8K)
            const asRow = document.getElementById('additional-stitches-row');
            const extraStitches = primaryLogo.stitchCount - 8000;
            if (extraStitches > 0 && pricing.totalQuantity > 0) {
                asRow.style.display = 'flex';
                const extraK = extraStitches / 1000;
                const asFee = extraK * 1.25 * pricing.totalQuantity;
                document.getElementById('additional-stitches-fee').textContent =
                    `+${extraK}K Ã— ${pricing.totalQuantity} = $${asFee.toFixed(2)}`;
            } else {
                asRow.style.display = 'none';
            }

            // Additional Logos pricing section
            const alContainer = document.getElementById('additional-logos-pricing');
            if (additionalLogos.length > 0 && pricing.totalQuantity > 0) {
                // Calculate AL pricing based on tier
                const tier = pricing.tier || '1-23';
                let alBaseRate = 12.50; // Default tier 1-23
                if (tier.includes('72')) alBaseRate = 8.50;
                else if (tier.includes('48')) alBaseRate = 9.50;
                else if (tier.includes('24')) alBaseRate = 11.50;

                let alHtml = '';
                additionalLogos.forEach(logo => {
                    const logoExtraStitches = Math.max(0, logo.stitchCount - 8000);
                    const logoExtraK = logoExtraStitches / 1000;
                    const stitchCost = logoExtraK * 1.25;
                    const alUnitPrice = alBaseRate + stitchCost;
                    const alTotal = alUnitPrice * pricing.totalQuantity;

                    // Update price in the logo row
                    const priceEl = document.getElementById(`al-price-${logo.id}`);
                    if (priceEl) {
                        priceEl.textContent = `$${alUnitPrice.toFixed(2)}/ea`;
                    }

                    // Add line item to quote summary
                    const stitchNote = logoExtraStitches > 0 ? ` (+${logoExtraK}K)` : '';
                    alHtml += `
                        <div class="pricing-row al-pricing-row">
                            <span class="label">AL: ${logo.position}${stitchNote}:</span>
                            <span class="value">$${alTotal.toFixed(2)}</span>
                        </div>
                    `;
                });
                alContainer.innerHTML = alHtml;
            } else {
                alContainer.innerHTML = '';
            }
        }

        // ============================================================
        // ACTIONS (Save, Print, Email, Copy)
        // ============================================================

        async function printQuote() {
            const products = collectProductsFromTable();
            if (products.length === 0) {
                showToast('Add products before printing', 'error');
                return;
            }

            showLoading(true);

            try {
                // Combine primary logo + all additional logos
                const allLogos = [
                    { ...primaryLogo, id: 'primary' },
                    ...additionalLogos
                ];
                const pricing = await pricingCalculator.calculateQuote(products, allLogos);

                // Generate and open print window
                const invoiceGenerator = new EmbroideryInvoiceGenerator();
                const customerData = {
                    customerName: document.getElementById('customer-name').value || 'Customer',
                    companyName: document.getElementById('company-name').value || '',
                    customerEmail: document.getElementById('customer-email').value || '',
                    customerPhone: document.getElementById('customer-phone').value || '',
                    salesRepEmail: document.getElementById('sales-rep').value
                };

                // Pass LTM distribution state to invoice generator
                pricing.ltmDistributed = ltmDistributed;

                const invoiceHTML = invoiceGenerator.generateInvoiceHTML(pricing, customerData);
                const printWindow = window.open('', '_blank');
                printWindow.document.write(invoiceHTML);
                printWindow.document.close();

                setTimeout(() => {
                    printWindow.print();
                }, 300);

                showToast('Opening print dialog...', 'success');
            } catch (error) {
                console.error('Print error:', error);
                showToast('Error generating PDF', 'error');
            }

            showLoading(false);
        }

        async function saveQuote() {
            const products = collectProductsFromTable();
            if (products.length === 0) {
                showToast('Add products before saving', 'error');
                return;
            }

            const customerName = document.getElementById('customer-name').value;
            if (!customerName) {
                showToast('Enter customer name to save', 'error');
                document.getElementById('customer-name').focus();
                return;
            }

            showLoading(true);

            try {
                // Combine primary logo + all additional logos
                const allLogos = [
                    { ...primaryLogo, id: 'primary' },
                    ...additionalLogos
                ];
                const pricing = await pricingCalculator.calculateQuote(products, allLogos);

                // Build separate objects matching service signature: saveQuote(quoteData, customerData, pricingResults)
                const customerData = {
                    email: document.getElementById('customer-email').value || '',
                    name: customerName,
                    company: document.getElementById('company-name').value || '',
                    phone: document.getElementById('customer-phone').value || '',
                    salesRepEmail: document.getElementById('sales-rep').value,
                    notes: ''
                };

                const quoteData = {
                    products: products,
                    logos: allLogos
                };

                // Attach logos to pricing for service to access
                pricing.logos = allLogos;

                const result = await quoteService.saveQuote(quoteData, customerData, pricing);

                if (result && result.quoteID) {
                    showToast(`Quote ${result.quoteID} saved!`, 'success');
                } else if (result && result.success) {
                    showToast('Quote saved successfully', 'success');
                } else {
                    showToast('Error saving quote', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showToast('Error saving quote', 'error');
            }

            showLoading(false);
        }

        async function emailQuote() {
            const products = collectProductsFromTable();
            if (products.length === 0) {
                showToast('Add products before emailing', 'error');
                return;
            }

            const customerEmail = document.getElementById('customer-email').value;
            if (!customerEmail) {
                showToast('Enter customer email', 'error');
                document.getElementById('customer-email').focus();
                return;
            }

            showToast('Email functionality coming soon', 'info');
        }

        // Toggle Coming Soon accordion
        function toggleComingSoon() {
            const content = document.getElementById('coming-soon-content');
            const chevron = document.getElementById('coming-soon-chevron');
            content.classList.toggle('open');
            chevron.classList.toggle('rotated');
        }

        async function copyToClipboard() {
            const products = collectProductsFromTable();
            if (products.length === 0) {
                showToast('Add products first', 'error');
                return;
            }

            try {
                // Combine primary logo + all additional logos
                const allLogos = [
                    { ...primaryLogo, id: 'primary' },
                    ...additionalLogos
                ];
                const pricing = await pricingCalculator.calculateQuote(products, allLogos);

                const text = generateQuoteText(products, pricing, allLogos);
                await navigator.clipboard.writeText(text);

                showToast('Quote copied to clipboard!', 'success');
            } catch (error) {
                console.error('Copy error:', error);
                showToast('Error copying to clipboard', 'error');
            }
        }

        function generateQuoteText(products, pricing, logos) {
            const lines = [
                'NORTHWEST CUSTOM APPAREL - EMBROIDERY QUOTE',
                '================================================',
                `Date: ${new Date().toLocaleDateString()}`,
                `Customer: ${document.getElementById('customer-name').value || 'N/A'}`,
                `Company: ${document.getElementById('company-name').value || 'N/A'}`,
                '',
                `Primary Logo: ${primaryLogo.position}, ${primaryLogo.stitchCount.toLocaleString()} stitches`,
            ];

            // Add additional logos if any
            if (additionalLogos.length > 0) {
                additionalLogos.forEach(logo => {
                    lines.push(`Additional Logo: ${logo.position}, ${logo.stitchCount.toLocaleString()} stitches`);
                });
            }

            lines.push('');
            lines.push('PRODUCTS:');
            lines.push('------------------------------------------------');

            products.forEach(p => {
                const sizes = Object.entries(p.sizeBreakdown).map(([s, q]) => `${s}:${q}`).join(' ');
                lines.push(`${p.style} - ${p.color} | ${sizes} | Total: ${p.totalQuantity}`);
            });

            lines.push('');
            lines.push('------------------------------------------------');
            lines.push(`Total Pieces: ${pricing.totalQuantity}`);
            lines.push(`Tier: ${pricing.tier}`);
            lines.push(`Subtotal: $${pricing.subtotal.toFixed(2)}`);
            if (pricing.ltmFee > 0) lines.push(`LTM Fee: $${pricing.ltmFee.toFixed(2)}`);
            if (pricing.setupFees > 0) lines.push(`Setup: $${pricing.setupFees.toFixed(2)}`);
            lines.push(`TOTAL: $${pricing.grandTotal.toFixed(2)}`);
            lines.push('');
            lines.push('Northwest Custom Apparel | 253-922-5793');

            return lines.join('\n');
        }

        // ============================================================
        // UTILITIES
        // ============================================================

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // Select icon based on type
            const icons = {
                success: 'check',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            const icon = icons[type] || 'info-circle';

            toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, duration);
        }
    </script>
</body>
</html>
