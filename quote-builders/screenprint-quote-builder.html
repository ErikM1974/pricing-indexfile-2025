<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Print Quote Builder | Northwest Custom Apparel</title>

    <!-- NWCA Favicon -->
    <link rel="icon" type="image/png" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1">

    <!-- Font Awesome - Simplified without integrity check -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Force Font Awesome font-family -->
    <style>
    .fas, .far, .fab, .fa {
        font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
        font-weight: 900 !important;
        font-style: normal !important;
        font-variant: normal !important;
        text-rendering: auto !important;
        -webkit-font-smoothing: antialiased !important;
    }
    .fas::before, .far::before, .fab::before, .fa::before {
        font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
        font-weight: 900 !important;
    }

    /* E-Commerce Style Product Layout */

    /* Search Section */
    .search-section {
        margin-bottom: 2rem;
    }

    .search-section .search-input {
        width: 100%;
        max-width: 600px;
        padding: 1rem;
        font-size: 1.1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        transition: border-color 0.2s;
    }

    .search-section .search-input:focus {
        outline: none;
        border-color: #4cb354;
    }

    /* Two Column Product Layout - Image hidden during color selection */
    .product-layout {
        display: grid;
        grid-template-columns: 1fr; /* Full width - no image column */
        gap: 2rem;
        margin-bottom: 2rem;
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Hide product image during color selection to maximize space */
    .product-image-col {
        display: none; /* Hidden to save horizontal space */
    }

    .product-image-col img {
        width: 100%;
        max-width: 450px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .product-info-col {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .product-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .product-desc {
        color: #6b7280;
        margin: 0;
        font-size: 0.95rem;
    }

    .color-selection h4 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1f2937;
    }

    /* Color Grid - Optimized for many colors */
    .color-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
        gap: 0.5rem;
        max-width: 100%;
    }

    .color-swatch {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.5rem 0.375rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        position: relative;
    }

    .color-swatch:hover {
        border-color: #4cb354;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 179, 84, 0.3);
        z-index: 10;
    }

    .color-swatch.selected {
        border-color: #4cb354;
        background: #e8f5e9;
        box-shadow: 0 0 0 3px rgba(76, 179, 84, 0.2);
    }

    .color-swatch.selected::after {
        content: '\2713'; /* Checkmark */
        position: absolute;
        top: 2px;
        right: 2px;
        background: #4cb354;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }

    .color-swatch-image {
        width: 50px;
        height: 50px;
        border-radius: 6px;
        margin-bottom: 0.375rem;
        object-fit: cover;
    }

    .color-swatch-name {
        font-size: 0.7rem;
        text-align: center;
        line-height: 1.1;
        color: #374151;
        font-weight: 500;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    /* Tooltip on hover for long color names */
    .color-swatch:hover .color-swatch-name {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 0.375rem 0.625rem;
        border-radius: 6px;
        white-space: nowrap;
        font-size: 0.75rem;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        max-width: none;
        overflow: visible;
        text-overflow: clip;
        display: block;
        -webkit-line-clamp: unset;
    }

    /* Size Section */
    .size-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    .size-section h4 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: #1f2937;
    }

    /* Size Grid */
    .size-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .size-input-group {
        text-align: center;
    }

    .size-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
        font-size: 0.95rem;
    }

    .size-quantity {
        width: 100%;
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        transition: border-color 0.2s;
    }

    .size-quantity:focus {
        outline: none;
        border-color: #4cb354;
    }

    .size-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }

    .total-display {
        font-size: 1.1rem;
        color: #374151;
    }

    .total-display strong {
        color: #4cb354;
        font-size: 1.3rem;
    }

    /* Product List Enhancements */
    .product-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        background: white;
        transition: box-shadow 0.2s;
    }

    .product-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .product-item-info {
        display: flex;
        gap: 1rem;
        flex: 1;
    }

    .product-color-swatch {
        flex-shrink: 0;
    }

    .color-swatch-indicator {
        width: 50px;
        height: 50px;
        border-radius: 6px;
        border: 2px solid #e5e7eb;
        object-fit: cover;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .product-item-details {
        flex: 1;
    }

    .product-item-details h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
    }

    .product-item-details p {
        margin: 0 0 0.5rem 0;
        color: #6b7280;
        font-size: 0.875rem;
    }

    .size-breakdown {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
        margin-top: 0.5rem;
    }

    .size-chip {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        color: #374151;
    }

    .product-item-actions {
        flex-shrink: 0;
    }

    .product-item-actions .btn-danger {
        padding: 0.5rem 0.75rem;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .product-item-actions .btn-danger:hover {
        background: #dc2626;
    }

    /* Responsive */
    @media (max-width: 968px) {
        .product-layout {
            grid-template-columns: 1fr;
        }

        .product-image-col {
            position: static;
        }
    }
    </style>

    <!-- Bootstrap CSS FIRST (foundation layer) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Universal Styles (override Bootstrap) -->
    <link rel="stylesheet" href="/shared_components/css/universal-header.css">
    <link rel="stylesheet" href="/shared_components/css/universal-calculator-theme.css">

    <!-- Base Quote Builder Styles (screenprint inherits from embroidery) -->
    <link rel="stylesheet" href="/shared_components/css/embroidery-quote-builder.css">

    <!-- Unified Step 1 Styles -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-unified-step1.css">
    <link rel="stylesheet" href="/shared_components/css/quote-builder-unified-step1-v2.css">

    <!-- ScreenPrint Specific Overrides (highest priority - must load AFTER unified CSS) -->
    <link rel="stylesheet" href="/shared_components/css/screenprint-quote-builder.css?v=20250911">

    <!-- Phase 1 Infrastructure - v20250911 -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-common.css?v=20250911">
    <link rel="stylesheet" href="/shared_components/css/quote-print.css?v=20250911">
    <script src="/shared_components/js/quote-builder-base.js?v=20250911"></script>
    <script src="/shared_components/js/quote-formatter.js?v=20250911"></script>

    <!-- Phase 2 Persistence - v20250911 -->
    <script src="/shared_components/js/quote-persistence.js?v=20250911"></script>
    <script src="/shared_components/js/quote-session.js?v=20250911"></script>

    <!-- Phase 3 Advanced Features - v20250911 -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-phase3.css?v=20250911">
    <script src="/shared_components/js/quote-validation.js?v=20250911"></script>
    <script src="/shared_components/js/quote-ui-feedback.js?v=20250911"></script>
</head>
<body>
    <!-- Header -->
    <header class="embroidery-header">
        <div class="header-contact-bar">
            <div class="contact-bar-content">
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>(253) 922-5793</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>sales@nwcustomapparel.com</span>
                    </div>
                </div>
                <div class="business-hours">
                    <i class="fas fa-clock"></i>
                    Monday - Friday: 8:30 AM - 5:00 PM PST
                </div>
            </div>
        </div>

        <div class="header-nav">
            <div class="nav-content">
                <div class="logo-section">
                    <a href="/staff-dashboard.html" class="logo-link">
                        <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1"
                             alt="Northwest Custom Apparel"
                             class="logo-image">
                    </a>
                </div>

                <div class="nav-actions">
                    <button class="btn-secondary header-btn" onclick="window.location.href='/staff-dashboard.html'">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            </div>
        </div>

        <div class="context-bar">
            <div class="context-bar-content">
                <div class="context-left">
                    <div class="breadcrumb">
                        <a href="/staff-dashboard.html">Dashboard</a>
                        <i class="fas fa-chevron-right"></i>
                        <span>Screen Print Quote Builder</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <h1 class="page-title">Screen Print Quote Builder</h1>
        <p class="page-description">
            Create professional screen print quotes with automatic tier pricing
        </p>

        <!-- Progress Indicator -->
        <div class="phase-nav">
            <div class="phase-step active" id="phase-1-nav" data-phase="1">
                <div class="phase-step-number">1</div>
                <div class="phase-step-label">Setup</div>
            </div>
            <div class="phase-connector" id="connector-1"></div>
            <div class="phase-step" id="phase-2-nav" data-phase="2">
                <div class="phase-step-number">2</div>
                <div class="phase-step-label">Add Products</div>
            </div>
            <div class="phase-connector" id="connector-2"></div>
            <div class="phase-step" id="phase-3-nav" data-phase="3">
                <div class="phase-step-number">3</div>
                <div class="phase-step-label">Review & Save</div>
            </div>
        </div>

        <!-- Phase 1: Print Setup -->
        <section id="setup-phase" class="phase-section active">
            <div class="phase-header">
                <h2><span class="phase-number">1</span> Print Setup</h2>
                <p>Select primary location and colors</p>
            </div>

            <div class="setup-card">
                <h3 class="setup-title">Primary Location</h3>
                <div class="primary-location-info">
                    <div class="location-icon"><i class="fas fa-shirt"></i></div>
                    <div class="location-details">
                        <div class="location-name">Front Print Location</div>
                        <div class="location-description">Primary design area for all products</div>
                    </div>
                </div>

                <h3 class="setup-title" style="margin-top: 2rem;">Number of Colors</h3>
                <div class="color-buttons">
                    <button class="color-btn active" data-colors="1">1 Color</button>
                    <button class="color-btn" data-colors="2">2 Colors</button>
                    <button class="color-btn" data-colors="3">3 Colors</button>
                    <button class="color-btn" data-colors="4">4 Colors</button>
                    <button class="color-btn" data-colors="5">5 Colors</button>
                    <button class="color-btn" data-colors="6">6 Colors</button>
                </div>

                <div class="dark-garment-section" style="margin-top: 2rem;">
                    <div class="dark-garment-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="dark-garment-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <div>
                            <strong>Dark Garments</strong>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                Adds white underbase layer (+1 color)
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="setup-card" id="additional-locations-card">
                <h3 class="setup-title">Additional Locations</h3>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                    Add up to 3 more print locations. Each location counts as a separate setup fee.
                </p>
                <div id="additional-locations-list"></div>
                <button id="add-location-btn" class="btn btn-secondary">
                    <i class="fas fa-plus"></i> Add Location
                </button>
            </div>

            <div class="phase-actions">
                <div></div>
                <button id="continue-to-products" class="btn btn-primary">
                    Continue to Products <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Phase 2: Add Products -->
        <section id="product-phase" class="phase-section">
            <div class="phase-header">
                <h2><span class="phase-number">2</span> Add Products</h2>
                <p>Search and add products</p>
            </div>

            <!-- Search Section (Full Width) -->
            <div class="search-section">
                <div class="form-group" style="position: relative;">
                    <label for="style-search">Search Product Style</label>
                    <input type="text" id="style-search" class="search-input" placeholder="Enter style number (e.g., PC54, PC61, 18500)" autocomplete="off">
                    <div id="style-suggestions" class="suggestions-dropdown" style="display: none;"></div>
                </div>
            </div>

            <!-- Product Display (Two Column Layout) -->
            <div id="product-display" class="product-layout" style="display: none;">
                <!-- Left Column: Product Image -->
                <div class="product-image-col">
                    <img id="product-image" src="" alt="Product">
                </div>

                <!-- Right Column: Product Info & Colors -->
                <div class="product-info-col">
                    <h3 id="product-name" class="product-title"></h3>
                    <p id="product-description" class="product-desc"></p>

                    <div class="color-selection">
                        <h4>Select Color</h4>
                        <div id="color-swatches" class="color-grid"></div>
                        <input type="hidden" id="selected-color">
                    </div>
                </div>
            </div>

            <!-- Size Selection (Full Width - Shows After Color Selected) -->
            <div id="size-section" class="size-section" style="display: none;">
                <h4>Select Sizes & Quantities</h4>
                <div id="size-inputs" class="size-grid"></div>

                <div class="size-actions">
                    <div class="total-display">
                        Total Quantity: <strong id="product-total-qty">0</strong>
                    </div>
                    <button id="add-to-quote-btn" class="btn btn-primary" disabled>
                        <i class="fas fa-plus"></i> Add to Quote
                    </button>
                </div>
            </div>

            <div class="products-list">
                <h3>Products in Quote (<span id="products-count">0</span> items, <span id="total-pieces">0</span> pieces)</h3>
                <div id="products-container">
                    <p style="color: var(--text-secondary);">No products added yet.</p>
                </div>

                <div id="minimum-warning" class="alert alert-warning" style="display: none; margin-top: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Minimum 36 pieces required. Current total: <span id="current-total">0</span> pieces.
                </div>
            </div>

            <div class="phase-actions">
                <button id="back-to-setup" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Setup
                </button>
                <button id="continue-to-summary" class="btn btn-primary" disabled>
                    Continue to Summary <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Phase 3: Review & Save -->
        <section id="summary-phase" class="phase-section">
            <div class="phase-header">
                <h2><span class="phase-number">3</span> Review & Save</h2>
                <p>Review and enter customer information</p>
            </div>

            <div id="quote-summary" class="quote-summary"></div>

            <div class="customer-info-section">
                <h3>Customer Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-name">Customer Name *</label>
                        <input type="text" id="customer-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-email">Email *</label>
                        <input type="email" id="customer-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-phone">Phone</label>
                        <input type="tel" id="customer-phone" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="company-name">Company Name</label>
                        <input type="text" id="company-name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="sales-rep">Sales Representative *</label>
                        <select id="sales-rep" class="form-control" required>
                            <option value="sales@nwcustomapparel.com" selected>General Sales</option>
                            <option value="adriyella@nwcustomapparel.com">Adriyella</option>
                            <option value="bradley@nwcustomapparel.com">Bradley Wright</option>
                            <option value="erik@nwcustomapparel.com">Erik Mickelson</option>
                            <option value="jim@nwcustomapparel.com">Jim Mickelson</option>
                            <option value="nika@nwcustomapparel.com">Nika Lao</option>
                            <option value="ruth@nwcustomapparel.com">Ruth Nhong</option>
                            <option value="art@nwcustomapparel.com">Steve Deland</option>
                            <option value="taneisha@nwcustomapparel.com">Taneisha Clark</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="phase-actions">
                <button id="back-to-products" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Products
                </button>
                <button id="save-quote-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Quote
                </button>
            </div>
        </section>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header success">
                <i class="fas fa-check-circle"></i>
                <h2>Quote Saved Successfully!</h2>
            </div>
            <div class="modal-body">
                <p>Your quote has been created.</p>
                <div class="quote-id-display" id="modal-quote-id"></div>
            </div>
            <div class="modal-footer">
                <button onclick="newQuote()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Quote
                </button>
            </div>
        </div>
    </div>

    <!-- Services -->
    <script src="/shared_components/js/screenprint-pricing-service.js"></script>
    <script src="/shared_components/js/screenprint-pricing-v2.js"></script>
    <script src="/shared_components/js/screenprint-quote-service.js"></script>

    <script>
    class ScreenPrintQuoteBuilder {
        constructor() {
            this.currentPhase = 1;

            // Print setup state
            this.printSetup = {
                frontColors: 1,
                isDarkGarment: false,
                additionalLocations: []
            };

            // Products array
            this.products = [];
            this.currentProduct = null;

            // Search state
            this.lastSearchTerm = '';  // Track last searched term to prevent re-searching

            // Services
            this.quoteService = new ScreenPrintQuoteService();
            this.pricingService = new ScreenPrintPricingService();

            // Search debouncing
            this.searchDebounceTimer = null;
            this.isSettingValue = false; // Flag to prevent input event during programmatic updates

            // Initialize
            emailjs.init('4qSbDO-SQs19TbP80');
            this.initializeEventListeners();

            console.log('[ScreenPrintQuoteBuilder] Initialized - using screenprint-pricing-v2.js for ALL calculations');
        }

        initializeEventListeners() {
            // Color selection
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.printSetup.frontColors = parseInt(e.target.dataset.colors);
                });
            });

            // Dark garment toggle
            document.getElementById('dark-garment-toggle').addEventListener('change', (e) => {
                this.printSetup.isDarkGarment = e.target.checked;
            });

            // Navigation
            document.getElementById('continue-to-products').addEventListener('click', () => this.navigateToPhase(2));
            document.getElementById('back-to-setup').addEventListener('click', () => this.navigateToPhase(1));
            document.getElementById('continue-to-summary').addEventListener('click', () => {
                if (this.products.length > 0) {
                    this.generateQuoteSummary();
                    this.navigateToPhase(3);
                }
            });
            document.getElementById('back-to-products').addEventListener('click', () => this.navigateToPhase(2));

            // Product search with debouncing
            const styleSearch = document.getElementById('style-search');
            styleSearch.addEventListener('input', (e) => {
                // Skip if we're setting the value programmatically
                if (this.isSettingValue) {
                    return;
                }

                const term = e.target.value.trim();

                // Skip if the term hasn't changed (prevents re-searching while scrolling dropdown)
                if (term === this.lastSearchTerm) {
                    return;
                }

                // Clear existing timer
                if (this.searchDebounceTimer) {
                    clearTimeout(this.searchDebounceTimer);
                }

                if (term.length >= 2) {
                    // Debounce: wait 300ms before searching
                    this.searchDebounceTimer = setTimeout(() => {
                        this.lastSearchTerm = term;  // Track what we searched for
                        this.searchProducts(term);
                    }, 300);
                } else {
                    this.lastSearchTerm = '';  // Reset when clearing search
                    document.getElementById('style-suggestions').style.display = 'none';
                }
            });

            // Close suggestions dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const suggestionsEl = document.getElementById('style-suggestions');
                if (!e.target.closest('#style-search') && !e.target.closest('#style-suggestions')) {
                    suggestionsEl.style.display = 'none';
                }
            });

            // Prevent dropdown from closing when scrolling/clicking inside it
            const suggestionsEl = document.getElementById('style-suggestions');
            suggestionsEl.addEventListener('mousedown', (e) => {
                // Prevent input blur and event bubbling when interacting with dropdown
                e.preventDefault();
                e.stopPropagation();
            });

            // Prevent scroll events from affecting the input
            suggestionsEl.addEventListener('scroll', (e) => {
                e.stopPropagation();
            });

            // Add to quote
            document.getElementById('add-to-quote-btn').addEventListener('click', () => this.addProductToQuote());

            // Additional locations
            document.getElementById('add-location-btn').addEventListener('click', () => this.addLocation());

            // Save quote
            document.getElementById('save-quote-btn').addEventListener('click', () => this.saveQuote());
        }

        // Additional Locations Management
        addLocation() {
            if (this.printSetup.additionalLocations.length >= 3) {
                alert('Maximum 3 additional locations allowed');
                return;
            }

            this.printSetup.additionalLocations.push({
                location: '',
                colors: 0
            });

            this.updateAdditionalLocationsUI();
        }

        removeLocation(index) {
            this.printSetup.additionalLocations.splice(index, 1);
            this.updateAdditionalLocationsUI();
        }

        updateAdditionalLocationsUI() {
            const container = document.getElementById('additional-locations-list');
            const addBtn = document.getElementById('add-location-btn');

            if (this.printSetup.additionalLocations.length === 0) {
                container.innerHTML = '';
                addBtn.style.display = 'block';
                return;
            }

            container.innerHTML = this.printSetup.additionalLocations.map((loc, index) => {
                const availableOptions = this.getAvailableLocationOptions(index);

                return `
                    <div class="additional-location-item" style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                            <h4 style="margin: 0; font-size: 1rem;">Location ${index + 1}</h4>
                            <button class="btn-icon-danger" onclick="screenPrintQuoteBuilder.removeLocation(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem;">Location</label>
                                <select onchange="screenPrintQuoteBuilder.updateLocationSelection(${index}, this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
                                    <option value="">Select location...</option>
                                    ${availableOptions.map(opt => `
                                        <option value="${opt.value}" ${loc.location === opt.value ? 'selected' : ''}>${opt.label}</option>
                                    `).join('')}
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem;">Colors</label>
                                <select onchange="screenPrintQuoteBuilder.updateLocationColors(${index}, parseInt(this.value))" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;" ${!loc.location ? 'disabled' : ''}>
                                    <option value="0">Select colors...</option>
                                    ${[1,2,3,4,5,6].map(n => `
                                        <option value="${n}" ${loc.colors === n ? 'selected' : ''}>${n} Color${n > 1 ? 's' : ''}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Hide add button if at max locations
            addBtn.style.display = this.printSetup.additionalLocations.length >= 3 ? 'none' : 'block';
        }

        getAvailableLocationOptions(currentIndex) {
            // All available locations
            const allLocations = [
                { value: 'back', label: 'Full Back' },
                { value: 'left-sleeve', label: 'Left Sleeve' },
                { value: 'right-sleeve', label: 'Right Sleeve' },
                { value: 'custom', label: 'Custom Location' }
            ];

            // Locations to exclude (already selected in OTHER slots)
            const excluded = [];

            this.printSetup.additionalLocations.forEach((loc, index) => {
                if (index !== currentIndex && loc.location) {
                    excluded.push(loc.location);
                }
            });

            return allLocations.filter(opt => !excluded.includes(opt.value));
        }

        updateLocationSelection(index, value) {
            this.printSetup.additionalLocations[index].location = value;

            // If location is cleared, also clear colors
            if (!value) {
                this.printSetup.additionalLocations[index].colors = 0;
            }

            this.updateAdditionalLocationsUI();
        }

        updateLocationColors(index, colors) {
            this.printSetup.additionalLocations[index].colors = colors;
        }

        getLocationName(code) {
            const locationNames = {
                'back': 'Full Back',
                'left-sleeve': 'Left Sleeve',
                'right-sleeve': 'Right Sleeve',
                'custom': 'Custom Location'
            };
            return locationNames[code] || code;
        }

        async searchProducts(term) {
            const suggestionsEl = document.getElementById('style-suggestions');

            if (term.length < 2) {
                suggestionsEl.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/products/search?q=${term}&limit=10`);
                const data = await response.json();

                // Unwrap API response - handles both {data: {products: []}} and flat array formats
                const products = data.data?.products || data.products || [];

                if (products.length > 0) {
                    // Show dropdown with clickable suggestions - using correct camelCase field names
                    suggestionsEl.innerHTML = products.map(p => `
                        <div class="suggestion-item" data-style="${p.styleNumber}">
                            <strong>${p.styleNumber}</strong> - ${p.productName || ''}
                        </div>
                    `).join('');
                    suggestionsEl.style.display = 'block';

                    // Add click handlers to suggestions
                    suggestionsEl.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', async () => {
                            const style = item.dataset.style;

                            // Set flag to prevent input event from firing
                            this.isSettingValue = true;
                            document.getElementById('style-search').value = style;

                            // Keep flag true for a bit to ensure input event is blocked
                            setTimeout(() => {
                                this.isSettingValue = false;
                            }, 100); // 100ms is enough to block the input event

                            suggestionsEl.style.display = 'none';
                            await this.selectProductStyle(style);
                        });
                    });
                } else {
                    suggestionsEl.innerHTML = '<div class="suggestion-item no-results">No products found</div>';
                    suggestionsEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Search error:', error);
                suggestionsEl.innerHTML = '<div class="suggestion-item no-results">Error loading products</div>';
                suggestionsEl.style.display = 'block';
            }
        }

        async selectProductStyle(styleNumber) {
            try {
                // Fetch product details and color swatches in parallel
                const [detailsResponse, swatchesResponse] = await Promise.all([
                    fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/product-details?styleNumber=${styleNumber}`),
                    fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/color-swatches?styleNumber=${styleNumber}`)
                ]);

                const detailsData = await detailsResponse.json();
                const swatchesData = await swatchesResponse.json();

                // API returns an array of rows (one per color/size combination)
                const productRows = Array.isArray(detailsData) ? detailsData : (detailsData.data || []);

                if (productRows.length === 0) {
                    throw new Error('No product data found');
                }

                // Store ALL product rows and first row for easy access
                this.currentProduct = {
                    styleNumber: styleNumber,
                    allRows: productRows,
                    details: productRows[0],
                    colorSwatches: swatchesData || []
                };

                // Display generic product image
                const productImage = document.getElementById('product-image');

                if (productRows[0].FRONT_FLAT || productRows[0].PRODUCT_IMAGE) {
                    productImage.src = productRows[0].FRONT_FLAT || productRows[0].PRODUCT_IMAGE;
                    productImage.alt = productRows[0].PRODUCT_TITLE || styleNumber;
                }

                // Display product info and color swatches
                document.getElementById('product-name').textContent = `${productRows[0].PRODUCT_TITLE || styleNumber}`;
                document.getElementById('product-description').textContent = productRows[0].PRODUCT_DESCRIPTION || 'Select a color to continue';

                this.displayColorSwatches(swatchesData);

                // Show the product display section
                document.getElementById('product-display').style.display = 'grid';

            } catch (error) {
                console.error('Error loading style:', error);
                alert('Error loading product details. Please try again.');
            }
        }

        displayColorSwatches(swatches) {
            const container = document.getElementById('color-swatches');
            container.innerHTML = '';

            if (!swatches || swatches.length === 0) {
                container.innerHTML = '<p>No color options available</p>';
                return;
            }

            swatches.forEach(swatch => {
                const swatchEl = document.createElement('div');
                swatchEl.className = 'color-swatch';
                swatchEl.onclick = () => this.selectColor(swatch.COLOR_NAME, swatchEl);

                swatchEl.innerHTML = `
                    <img class="color-swatch-image" src="${swatch.COLOR_SQUARE_IMAGE}" alt="${swatch.COLOR_NAME}">
                    <div class="color-swatch-name">${swatch.COLOR_NAME}</div>
                `;

                container.appendChild(swatchEl);
            });

            container.style.display = 'grid';
        }

        async selectColor(colorName, swatchElement) {
            // Update visual selection
            document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
            swatchElement.classList.add('selected');

            // Store selected color and swatch image
            document.getElementById('selected-color').value = colorName;
            this.currentProduct.color = colorName;

            // Store swatch image from the clicked element
            const swatchImage = swatchElement.querySelector('.color-swatch-image');
            this.currentProduct.colorSwatchImage = swatchImage ? swatchImage.src : '';

            // Update product image to show selected color
            const colorRow = this.currentProduct.allRows.find(row =>
                row.COLOR_NAME === colorName || row.CATALOG_COLOR === colorName
            );

            if (colorRow && (colorRow.FRONT_FLAT || colorRow.FRONT_MODEL)) {
                const productImage = document.getElementById('product-image');
                productImage.src = colorRow.FRONT_FLAT || colorRow.FRONT_MODEL;
            }

            // Load sizes for this color
            await this.loadProductDetails(colorName);
        }

        async loadProductDetails(colorName) {
            // Color is passed from selectColor(), or get from hidden input
            const color = colorName || document.getElementById('selected-color').value;

            if (!color) {
                alert('Please select a color');
                return;
            }

            if (!this.currentProduct) {
                alert('Please select a product style first');
                return;
            }

            try {
                // Fetch accurate sizes from sizes-by-style-color API
                const response = await fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/sizes-by-style-color?styleNumber=${this.currentProduct.styleNumber}&color=${encodeURIComponent(color)}`);
                const sizeData = await response.json();

                // Extract sizes array from response
                const displaySizes = sizeData.sizes || ['S', 'M', 'L', 'XL', '2XL', '3XL'];

                // Update product description with selected color
                document.getElementById('product-description').textContent = `Color: ${color}`;

                // Create size inputs
                const sizeInputsContainer = document.getElementById('size-inputs');
                sizeInputsContainer.innerHTML = '';

                displaySizes.forEach(size => {
                    const sizeGroup = document.createElement('div');
                    sizeGroup.className = 'size-input-group';
                    sizeGroup.innerHTML = `
                        <label class="size-label">${size}</label>
                        <input type="number"
                               class="size-quantity"
                               data-size="${size}"
                               min="0"
                               value="0"
                               onchange="screenPrintQuoteBuilder.updateProductTotal()">
                    `;
                    sizeInputsContainer.appendChild(sizeGroup);
                });

                this.currentProduct.color = color;
                this.currentProduct.sizes = displaySizes;

                // Show the size section
                document.getElementById('size-section').style.display = 'block';

                document.getElementById('add-to-quote-btn').disabled = false;
            } catch (error) {
                console.error('Error loading product details:', error);
                alert('Error loading product details. Please try again.');
            }
        }

        updateProductTotal() {
            let total = 0;
            document.querySelectorAll('.size-quantity').forEach(input => {
                total += parseInt(input.value) || 0;
            });

            document.getElementById('product-total-qty').textContent = total;
            document.getElementById('add-to-quote-btn').disabled = total === 0;
        }

        addProductToQuote() {
            const sizeBreakdown = {};
            let totalQuantity = 0;

            document.querySelectorAll('.size-quantity').forEach(input => {
                const size = input.dataset.size;
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    sizeBreakdown[size] = qty;
                    totalQuantity += qty;
                }
            });

            if (totalQuantity === 0) {
                alert('Please enter at least one quantity');
                return;
            }

            // Store product WITHOUT pricing calculations (pricing done in summary phase)
            const product = {
                styleNumber: this.currentProduct.styleNumber,
                productName: this.currentProduct.details.PRODUCT_TITLE || '',
                color: this.currentProduct.color,
                colorSwatchImage: this.currentProduct.colorSwatchImage || '',
                sizeBreakdown: sizeBreakdown,
                quantity: totalQuantity
            };

            this.products.push(product);
            this.displayProductsList();

            // Reset form
            document.getElementById('style-search').value = '';
            this.lastSearchTerm = '';  // Reset search tracking

            // Clear color swatches and product image
            document.getElementById('color-swatches').innerHTML = '';
            document.getElementById('color-swatches').style.display = 'none';
            document.getElementById('selected-color').value = '';

            // Clear size inputs
            document.getElementById('size-inputs').innerHTML = '';
            document.getElementById('product-total-qty').textContent = '0';

            // Hide both sections
            document.getElementById('product-display').style.display = 'none';
            document.getElementById('size-section').style.display = 'none';

            // Show warning if under minimum, but don't block
            this.checkMinimum();
        }

        getTierForQuantity(qty) {
            if (qty >= 13 && qty <= 36) return '13-36';
            if (qty >= 37 && qty <= 72) return '37-72';
            if (qty >= 73 && qty <= 144) return '73-144';
            if (qty >= 145) return '145-576';
            return '13-36';
        }

        displayProductsList() {
            const container = document.getElementById('products-container');
            const totalPieces = this.products.reduce((sum, p) => sum + p.quantity, 0);

            document.getElementById('products-count').textContent = this.products.length;
            document.getElementById('total-pieces').textContent = totalPieces;

            if (this.products.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No products added yet.</p>';
                return;
            }

            container.innerHTML = this.products.map((product, index) => `
                <div class="product-item">
                    <div class="product-item-info">
                        ${product.colorSwatchImage ? `
                            <div class="product-color-swatch">
                                <img src="${product.colorSwatchImage}" alt="${product.color}" class="color-swatch-indicator">
                            </div>
                        ` : ''}
                        <div class="product-item-details">
                            <h4>${product.styleNumber} - ${product.productName}</h4>
                            <p><strong>${product.color}</strong> | <strong>${product.quantity} pieces</strong></p>
                            <div class="size-breakdown">
                                ${Object.entries(product.sizeBreakdown)
                                    .sort(([a], [b]) => {
                                        const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL', '6XL'];
                                        return sizeOrder.indexOf(a) - sizeOrder.indexOf(b);
                                    })
                                    .map(([size, qty]) => `<span class="size-chip">${size}: ${qty}</span>`)
                                    .join('')}
                            </div>
                        </div>
                    </div>
                    <div class="product-item-actions">
                        <button class="btn-danger" onclick="screenPrintQuoteBuilder.removeProduct(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        removeProduct(index) {
            if (confirm('Remove this product?')) {
                this.products.splice(index, 1);
                this.displayProductsList();
                this.checkMinimum();
            }
        }

        checkMinimum() {
            const total = this.products.reduce((sum, p) => sum + p.quantity, 0);
            const warning = document.getElementById('minimum-warning');

            if (total > 0 && total < 36) {
                // Show warning with current count
                warning.style.display = 'block';
                document.getElementById('current-total').textContent = total;
                document.getElementById('continue-to-summary').disabled = false;
            } else if (total >= 36) {
                // Hide warning when minimum met
                warning.style.display = 'none';
                document.getElementById('continue-to-summary').disabled = false;
            } else {
                // Hide warning when no products
                warning.style.display = 'none';
                document.getElementById('continue-to-summary').disabled = true;
            }
        }

        async generateQuoteSummary() {
            const totalQuantity = this.products.reduce((sum, p) => sum + p.quantity, 0);

            // Get unique styles and fetch pricing for each
            const uniqueStyles = [...new Set(this.products.map(p => p.styleNumber))];
            const pricingDataByStyle = {};

            for (const styleNumber of uniqueStyles) {
                const data = await this.pricingService.fetchPricingData(styleNumber);
                pricingDataByStyle[styleNumber] = data;
            }

            // Calculate pricing for each product
            const productPricing = this.products.map(product => {
                return this.calculateProductPricing(product, pricingDataByStyle[product.styleNumber], totalQuantity);
            });

            // Calculate totals
            const subtotal = productPricing.reduce((sum, p) => sum + p.lineTotal, 0);
            const setupFee = this.calculateTotalSetupFee();
            const ltmFee = this.calculateLTMFee(totalQuantity, pricingDataByStyle);
            const grandTotal = subtotal + setupFee + ltmFee;

            // Display breakdown
            const summaryContainer = document.getElementById('quote-summary');
            summaryContainer.innerHTML = `
                <div class="summary-section">
                    <h3>Print Setup</h3>
                    <div class="summary-row">
                        <span>Front Colors:</span>
                        <span>${this.printSetup.frontColors} ${this.printSetup.frontColors === 1 ? 'color' : 'colors'}${this.printSetup.isDarkGarment ? ' + 1 underbase' : ''}</span>
                    </div>
                    ${this.printSetup.additionalLocations.length > 0 ? `
                        <div class="summary-row">
                            <span>Additional Locations:</span>
                            <span>${this.printSetup.additionalLocations.length}</span>
                        </div>
                        ${this.printSetup.additionalLocations.map((loc, index) => `
                            <div class="summary-row" style="padding-left: 1rem; font-size: 0.875rem;">
                                <span>${this.getLocationName(loc.location)}: ${loc.colors} ${loc.colors === 1 ? 'color' : 'colors'}${this.printSetup.isDarkGarment ? ' + 1 underbase' : ''}</span>
                            </div>
                        `).join('')}
                    ` : ''}
                    <div class="summary-row" style="border-top: 1px solid #ddd; padding-top: 0.5rem; margin-top: 0.5rem;">
                        <span>Setup Fee:</span>
                        <span>$${setupFee.toFixed(2)}</span>
                    </div>
                </div>

                <div class="summary-section">
                    <h3>Products</h3>
                    ${productPricing.map(p => `
                        <div class="summary-row">
                            <span>${p.styleNumber} - ${p.color}</span>
                            <span>${p.quantity} pcs  $${p.perShirtTotal.toFixed(2)} = $${p.lineTotal.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="summary-section">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    ${ltmFee > 0 ? `
                        <div class="summary-row">
                            <span>LTM Fee (&lt; 13 pieces):</span>
                            <span>$${ltmFee.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="summary-row" style="border-top: 2px solid #333; padding-top: 0.5rem; margin-top: 0.5rem; font-weight: bold; font-size: 1.25rem;">
                        <span>Grand Total:</span>
                        <span style="color: #2d5f3f;">$${grandTotal.toFixed(2)}</span>
                    </div>
                </div>
            `;

            // Store pricing for quote save
            this.currentPricing = {
                totalQuantity,
                productPricing,
                subtotal,
                setupFee,
                ltmFee,
                grandTotal
            };
        }

        calculateProductPricing(product, pricingData, totalQuantity) {
            // Calculate effective colors (design + underbase if dark)
            let frontEffectiveColors = this.printSetup.frontColors;
            if (this.printSetup.isDarkGarment && this.printSetup.frontColors > 0) {
                frontEffectiveColors += 1;
            }

            // Get base price from primaryLocationPricing
            const frontPricingData = pricingData.primaryLocationPricing?.[frontEffectiveColors.toString()];
            if (!frontPricingData) {
                console.error('[ScreenPrintQuote] No pricing data for', frontEffectiveColors, 'colors');
                return { styleNumber: product.styleNumber, color: product.color, quantity: product.quantity, sizeBreakdown: product.sizeBreakdown, basePrice: 0, additionalCost: 0, perShirtTotal: 0, lineTotal: 0 };
            }

            const tier = frontPricingData.tiers.find(t =>
                totalQuantity >= t.minQty && (!t.maxQty || totalQuantity <= t.maxQty)
            );

            if (!tier || !tier.prices) {
                console.error('[ScreenPrintQuote] No tier found for quantity', totalQuantity);
                return { styleNumber: product.styleNumber, color: product.color, quantity: product.quantity, sizeBreakdown: product.sizeBreakdown, basePrice: 0, additionalCost: 0, perShirtTotal: 0, lineTotal: 0 };
            }

            // Calculate weighted average base price based on size breakdown
            let totalBaseCost = 0;
            let totalPieces = 0;

            Object.entries(product.sizeBreakdown).forEach(([size, qty]) => {
                const sizePrice = parseFloat(tier.prices[size]) || parseFloat(tier.prices['S']) || 0;
                totalBaseCost += sizePrice * qty;
                totalPieces += qty;
            });

            const basePrice = totalPieces > 0 ? totalBaseCost / totalPieces : 0;

            // Add additional locations
            let additionalCost = 0;
            this.printSetup.additionalLocations.forEach(loc => {
                let effectiveColors = loc.colors;
                if (this.printSetup.isDarkGarment && loc.colors > 0) {
                    effectiveColors += 1;
                }

                const locPricingData = pricingData.additionalLocationPricing?.[effectiveColors.toString()];
                if (locPricingData) {
                    const locTier = locPricingData.tiers.find(t =>
                        totalQuantity >= t.minQty && (!t.maxQty || totalQuantity <= t.maxQty)
                    );
                    if (locTier) {
                        // Additional locations are per-piece, no size variation
                        additionalCost += parseFloat(locTier.pricePerPiece) || 0;
                    }
                }
            });

            // Per shirt total (weighted average base + additional)
            const perShirtTotal = basePrice + additionalCost;
            const lineTotal = perShirtTotal * product.quantity;

            return {
                styleNumber: product.styleNumber,
                color: product.color,
                quantity: product.quantity,
                sizeBreakdown: product.sizeBreakdown,
                basePrice,
                additionalCost,
                perShirtTotal,
                lineTotal
            };
        }

        calculateTotalSetupFee() {
            // Front setup (MATCHES screenprint-pricing-v2.js LINE 1338)
            let frontColors = this.printSetup.frontColors;
            if (this.printSetup.isDarkGarment && frontColors > 0) {
                frontColors += 1; // Add underbase
            }
            const frontSetup = frontColors * 30;

            // Additional locations setup
            let additionalSetup = 0;
            this.printSetup.additionalLocations.forEach(loc => {
                let colors = loc.colors;
                if (this.printSetup.isDarkGarment && colors > 0) {
                    colors += 1;
                }
                additionalSetup += colors * 30;
            });

            return frontSetup + additionalSetup;
        }

        calculateLTMFee(totalQuantity, pricingDataByStyle) {
            // MATCHES screenprint-pricing-v2.js LINE 1341-1360
            if (totalQuantity >= 13) return 0;

            // Get LTM fee from first product's tier data
            const firstStyle = Object.values(pricingDataByStyle)[0];
            if (!firstStyle?.tierData) return 0;

            const tierKey = Object.keys(firstStyle.tierData).find(key => {
                const tier = firstStyle.tierData[key];
                return totalQuantity >= tier.MinQuantity &&
                       (!tier.MaxQuantity || totalQuantity <= tier.MaxQuantity);
            });

            return tierKey ? parseFloat(firstStyle.tierData[tierKey].LTM_Fee || 0) : 0;
        }

        async saveQuote() {
            const customerName = document.getElementById('customer-name').value.trim();
            const customerEmail = document.getElementById('customer-email').value.trim();
            const salesRep = document.getElementById('sales-rep').value;

            if (!customerName || !customerEmail || !salesRep) {
                alert('Please fill in all required fields');
                return;
            }

            const quoteData = {
                customerName,
                customerEmail,
                customerPhone: document.getElementById('customer-phone').value.trim(),
                companyName: document.getElementById('company-name').value.trim(),
                salesRepEmail: salesRep,

                printSetup: this.printSetup,
                items: this.products,
                totalQuantity: this.currentPricing.totalQuantity,
                subtotal: this.currentPricing.subtotal,
                setupFees: this.currentPricing.setupFees,
                grandTotal: this.currentPricing.grandTotal
            };

            const result = await this.quoteService.saveQuote(quoteData);

            if (result.success) {
                document.getElementById('modal-quote-id').textContent = result.quoteID;
                document.getElementById('success-modal').style.display = 'block';
            } else {
                alert('Error saving quote: ' + result.error);
            }
        }

        navigateToPhase(phase) {
            document.querySelectorAll('.phase-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.phase-step').forEach(s => s.classList.remove('active', 'completed'));

            const phases = ['setup-phase', 'product-phase', 'summary-phase'];
            document.getElementById(phases[phase - 1]).classList.add('active');

            document.querySelectorAll('.phase-step').forEach(step => {
                const stepPhase = parseInt(step.dataset.phase);
                if (stepPhase < phase) step.classList.add('completed');
                else if (stepPhase === phase) step.classList.add('active');
            });

            this.currentPhase = phase;
        }
    }

    const screenPrintQuoteBuilder = new ScreenPrintQuoteBuilder();

    function newQuote() {
        if (confirm('Start a new quote?')) {
            location.reload();
        }
    }

    console.log(' Screen Print Quote Builder loaded - using screenprint-pricing-v2.js for pricing');
    </script>
</body>
</html>
