<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Print Quote Builder | Northwest Custom Apparel</title>

    <!-- NWCA Favicon -->
    <link rel="icon" type="image/png" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1">

    <!-- Font Awesome - Simplified without integrity check -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Force Font Awesome font-family -->
    <style>
    .fas, .far, .fab, .fa {
        font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
        font-weight: 900 !important;
        font-style: normal !important;
        font-variant: normal !important;
        text-rendering: auto !important;
        -webkit-font-smoothing: antialiased !important;
    }
    .fas::before, .far::before, .fab::before, .fa::before {
        font-family: "Font Awesome 6 Free", "Font Awesome 5 Free", FontAwesome !important;
        font-weight: 900 !important;
    }
    </style>

    <!-- Bootstrap CSS FIRST (foundation layer) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Universal Styles (override Bootstrap) -->
    <link rel="stylesheet" href="/shared_components/css/universal-header.css">
    <link rel="stylesheet" href="/shared_components/css/universal-calculator-theme.css">

    <!-- Base Quote Builder Styles (screenprint inherits from embroidery) -->
    <link rel="stylesheet" href="/shared_components/css/embroidery-quote-builder.css">

    <!-- Unified Step 1 Styles -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-unified-step1.css">
    <link rel="stylesheet" href="/shared_components/css/quote-builder-unified-step1-v2.css">

    <!-- ScreenPrint Specific Overrides (highest priority - must load AFTER unified CSS) -->
    <link rel="stylesheet" href="/shared_components/css/screenprint-quote-builder.css?v=20250911">

    <!-- Phase 1 Infrastructure - v20250911 -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-common.css?v=20250911">
    <link rel="stylesheet" href="/shared_components/css/quote-print.css?v=20250911">
    <script src="/shared_components/js/quote-builder-base.js?v=20250911"></script>
    <script src="/shared_components/js/quote-formatter.js?v=20250911"></script>

    <!-- Phase 2 Persistence - v20250911 -->
    <script src="/shared_components/js/quote-persistence.js?v=20250911"></script>
    <script src="/shared_components/js/quote-session.js?v=20250911"></script>

    <!-- Phase 3 Advanced Features - v20250911 -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-phase3.css?v=20250911">
    <script src="/shared_components/js/quote-validation.js?v=20250911"></script>
    <script src="/shared_components/js/quote-ui-feedback.js?v=20250911"></script>
</head>
<body>
    <!-- Header -->
    <header class="embroidery-header">
        <div class="header-contact-bar">
            <div class="contact-bar-content">
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>(253) 922-5793</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>sales@nwcustomapparel.com</span>
                    </div>
                </div>
                <div class="business-hours">
                    <i class="fas fa-clock"></i>
                    Monday - Friday: 8:30 AM - 5:00 PM PST
                </div>
            </div>
        </div>

        <div class="header-nav">
            <div class="nav-content">
                <div class="logo-section">
                    <a href="/staff-dashboard.html" class="logo-link">
                        <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1"
                             alt="Northwest Custom Apparel"
                             class="logo-image">
                    </a>
                </div>

                <div class="nav-actions">
                    <button class="btn-secondary header-btn" onclick="window.location.href='/staff-dashboard.html'">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            </div>
        </div>

        <div class="context-bar">
            <div class="context-bar-content">
                <div class="context-left">
                    <div class="breadcrumb">
                        <a href="/staff-dashboard.html">Dashboard</a>
                        <i class="fas fa-chevron-right"></i>
                        <span>Screen Print Quote Builder</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <h1 class="page-title">Screen Print Quote Builder</h1>
        <p class="page-description">
            Create professional screen print quotes with automatic tier pricing
        </p>

        <!-- Progress Indicator -->
        <div class="phase-nav">
            <div class="phase-step active" id="phase-1-nav" data-phase="1">
                <div class="phase-step-number">1</div>
                <div class="phase-step-label">Setup</div>
            </div>
            <div class="phase-connector" id="connector-1"></div>
            <div class="phase-step" id="phase-2-nav" data-phase="2">
                <div class="phase-step-number">2</div>
                <div class="phase-step-label">Add Products</div>
            </div>
            <div class="phase-connector" id="connector-2"></div>
            <div class="phase-step" id="phase-3-nav" data-phase="3">
                <div class="phase-step-number">3</div>
                <div class="phase-step-label">Review & Save</div>
            </div>
        </div>

        <!-- Phase 1: Print Setup -->
        <section id="setup-phase" class="phase-section active">
            <div class="phase-header">
                <h2><span class="phase-number">1</span> Print Setup</h2>
                <p>Select primary location and colors</p>
            </div>

            <div class="setup-card">
                <h3 class="setup-title">Primary Location</h3>
                <div class="primary-location-info">
                    <div class="location-icon"><i class="fas fa-shirt"></i></div>
                    <div class="location-details">
                        <div class="location-name">Front Print Location</div>
                        <div class="location-description">Primary design area for all products</div>
                    </div>
                </div>

                <h3 class="setup-title" style="margin-top: 2rem;">Number of Colors</h3>
                <div class="color-buttons">
                    <button class="color-btn active" data-colors="1">1 Color</button>
                    <button class="color-btn" data-colors="2">2 Colors</button>
                    <button class="color-btn" data-colors="3">3 Colors</button>
                    <button class="color-btn" data-colors="4">4 Colors</button>
                    <button class="color-btn" data-colors="5">5 Colors</button>
                    <button class="color-btn" data-colors="6">6 Colors</button>
                </div>

                <div class="dark-garment-section" style="margin-top: 2rem;">
                    <div class="dark-garment-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="dark-garment-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <div>
                            <strong>Dark Garments</strong>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                Adds white underbase layer (+1 color)
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="setup-card" id="additional-locations-card">
                <h3 class="setup-title">Additional Locations</h3>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                    Add up to 3 more print locations. Each location counts as a separate setup fee.
                </p>
                <div id="additional-locations-list"></div>
                <button id="add-location-btn" class="btn btn-secondary">
                    <i class="fas fa-plus"></i> Add Location
                </button>
            </div>

            <div class="phase-actions">
                <div></div>
                <button id="continue-to-products" class="btn btn-primary">
                    Continue to Products <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Phase 2: Add Products -->
        <section id="product-phase" class="phase-section">
            <div class="phase-header">
                <h2><span class="phase-number">2</span> Add Products</h2>
                <p>Search and add products</p>
            </div>

            <div class="product-search-container">
                <div class="search-row">
                    <div class="form-group" style="position: relative;">
                        <label for="style-search">Style Number</label>
                        <input type="text" id="style-search" placeholder="Enter style (e.g., PC54)" autocomplete="off">
                        <div id="style-suggestions" class="suggestions-dropdown" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label for="color-select">Color</label>
                        <select id="color-select" disabled>
                            <option value="">Select style first</option>
                        </select>
                    </div>

                    <button id="load-product-btn" class="btn btn-primary" disabled>
                        <i class="fas fa-search"></i> Load Product
                    </button>
                </div>
            </div>

            <div id="product-display" class="product-display" style="display: none;">
                <div class="product-info">
                    <div class="product-details">
                        <h3 id="product-name"></h3>
                        <p id="product-description"></p>
                    </div>
                </div>

                <div class="size-matrix">
                    <h4>Enter Quantities by Size</h4>
                    <div id="size-inputs" class="size-inputs"></div>

                    <div class="phase-actions" style="border-top: none; padding-top: 1rem;">
                        <div>
                            Total Quantity: <strong id="product-total-qty">0</strong>
                        </div>
                        <button id="add-to-quote-btn" class="btn btn-primary" disabled>
                            <i class="fas fa-plus"></i> Add to Quote
                        </button>
                    </div>
                </div>
            </div>

            <div class="products-list">
                <h3>Products in Quote (<span id="products-count">0</span> items, <span id="total-pieces">0</span> pieces)</h3>
                <div id="products-container">
                    <p style="color: var(--text-secondary);">No products added yet.</p>
                </div>

                <div id="minimum-warning" class="alert alert-warning" style="display: none; margin-top: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Minimum 36 pieces required. Current total: <span id="current-total">0</span> pieces.
                </div>
            </div>

            <div class="phase-actions">
                <button id="back-to-setup" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Setup
                </button>
                <button id="continue-to-summary" class="btn btn-primary" disabled>
                    Continue to Summary <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Phase 3: Review & Save -->
        <section id="summary-phase" class="phase-section">
            <div class="phase-header">
                <h2><span class="phase-number">3</span> Review & Save</h2>
                <p>Review and enter customer information</p>
            </div>

            <div id="quote-summary" class="quote-summary"></div>

            <div class="customer-info-section">
                <h3>Customer Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-name">Customer Name *</label>
                        <input type="text" id="customer-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-email">Email *</label>
                        <input type="email" id="customer-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-phone">Phone</label>
                        <input type="tel" id="customer-phone" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="company-name">Company Name</label>
                        <input type="text" id="company-name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="sales-rep">Sales Representative *</label>
                        <select id="sales-rep" class="form-control" required>
                            <option value="sales@nwcustomapparel.com" selected>General Sales</option>
                            <option value="adriyella@nwcustomapparel.com">Adriyella</option>
                            <option value="bradley@nwcustomapparel.com">Bradley Wright</option>
                            <option value="erik@nwcustomapparel.com">Erik Mickelson</option>
                            <option value="jim@nwcustomapparel.com">Jim Mickelson</option>
                            <option value="nika@nwcustomapparel.com">Nika Lao</option>
                            <option value="ruth@nwcustomapparel.com">Ruth Nhong</option>
                            <option value="art@nwcustomapparel.com">Steve Deland</option>
                            <option value="taneisha@nwcustomapparel.com">Taneisha Clark</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="phase-actions">
                <button id="back-to-products" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Products
                </button>
                <button id="save-quote-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Quote
                </button>
            </div>
        </section>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header success">
                <i class="fas fa-check-circle"></i>
                <h2>Quote Saved Successfully!</h2>
            </div>
            <div class="modal-body">
                <p>Your quote has been created.</p>
                <div class="quote-id-display" id="modal-quote-id"></div>
            </div>
            <div class="modal-footer">
                <button onclick="newQuote()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Quote
                </button>
            </div>
        </div>
    </div>

    <!-- Services -->
    <script src="/shared_components/js/screenprint-pricing-service.js"></script>
    <script src="/shared_components/js/screenprint-pricing-v2.js"></script>
    <script src="/shared_components/js/screenprint-quote-service.js"></script>

    <script>
    class ScreenPrintQuoteBuilder {
        constructor() {
            this.currentPhase = 1;

            // Print setup state
            this.printSetup = {
                frontColors: 1,
                isDarkGarment: false,
                additionalLocations: []
            };

            // Products array
            this.products = [];
            this.currentProduct = null;

            // Services
            this.quoteService = new ScreenPrintQuoteService();
            this.pricingCalculator = new ScreenPrintPricing();
            this.pricingService = new ScreenPrintPricingService();

            // Initialize
            emailjs.init('4qSbDO-SQs19TbP80');
            this.initializeEventListeners();

            console.log('[ScreenPrintQuoteBuilder] Initialized - using screenprint-pricing-v2.js for ALL calculations');
        }

        initializeEventListeners() {
            // Color selection
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.printSetup.frontColors = parseInt(e.target.dataset.colors);
                    this.updatePricingCalculator();
                });
            });

            // Dark garment toggle
            document.getElementById('dark-garment-toggle').addEventListener('change', (e) => {
                this.printSetup.isDarkGarment = e.target.checked;
                this.updatePricingCalculator();
            });

            // Navigation
            document.getElementById('continue-to-products').addEventListener('click', () => this.navigateToPhase(2));
            document.getElementById('back-to-setup').addEventListener('click', () => this.navigateToPhase(1));
            document.getElementById('continue-to-summary').addEventListener('click', () => {
                if (this.products.length > 0) {
                    this.generateQuoteSummary();
                    this.navigateToPhase(3);
                }
            });
            document.getElementById('back-to-products').addEventListener('click', () => this.navigateToPhase(2));

            // Product search
            const styleSearch = document.getElementById('style-search');
            styleSearch.addEventListener('input', (e) => {
                const term = e.target.value.trim();
                if (term.length >= 2) {
                    this.searchProducts(term);
                } else {
                    document.getElementById('style-suggestions').style.display = 'none';
                }
            });

            // Close suggestions dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const suggestionsEl = document.getElementById('style-suggestions');
                if (!e.target.closest('#style-search') && !e.target.closest('#style-suggestions')) {
                    suggestionsEl.style.display = 'none';
                }
            });

            // Load product
            document.getElementById('load-product-btn').addEventListener('click', () => this.loadProductDetails());

            // Add to quote
            document.getElementById('add-to-quote-btn').addEventListener('click', () => this.addProductToQuote());

            // Additional locations
            document.getElementById('add-location-btn').addEventListener('click', () => this.addLocation());

            // Save quote
            document.getElementById('save-quote-btn').addEventListener('click', () => this.saveQuote());
        }

        updatePricingCalculator() {
            this.pricingCalculator.state.frontColors = this.printSetup.frontColors;
            this.pricingCalculator.state.isDarkGarment = this.printSetup.isDarkGarment;
            this.pricingCalculator.state.additionalLocations = this.printSetup.additionalLocations;
        }

        // Additional Locations Management
        addLocation() {
            if (this.printSetup.additionalLocations.length >= 3) {
                alert('Maximum 3 additional locations allowed');
                return;
            }

            this.printSetup.additionalLocations.push({
                location: '',
                colors: 0
            });

            this.updateAdditionalLocationsUI();
        }

        removeLocation(index) {
            this.printSetup.additionalLocations.splice(index, 1);
            this.updateAdditionalLocationsUI();
            this.updatePricingCalculator();
        }

        updateAdditionalLocationsUI() {
            const container = document.getElementById('additional-locations-list');
            const addBtn = document.getElementById('add-location-btn');

            if (this.printSetup.additionalLocations.length === 0) {
                container.innerHTML = '';
                addBtn.style.display = 'block';
                return;
            }

            container.innerHTML = this.printSetup.additionalLocations.map((loc, index) => {
                const availableOptions = this.getAvailableLocationOptions(index);

                return `
                    <div class="additional-location-item" style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                            <h4 style="margin: 0; font-size: 1rem;">Location ${index + 1}</h4>
                            <button class="btn-icon-danger" onclick="screenPrintQuoteBuilder.removeLocation(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem;">Location</label>
                                <select onchange="screenPrintQuoteBuilder.updateLocationSelection(${index}, this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
                                    <option value="">Select location...</option>
                                    ${availableOptions.map(opt => `
                                        <option value="${opt.value}" ${loc.location === opt.value ? 'selected' : ''}>${opt.label}</option>
                                    `).join('')}
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem;">Colors</label>
                                <select onchange="screenPrintQuoteBuilder.updateLocationColors(${index}, parseInt(this.value))" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;" ${!loc.location ? 'disabled' : ''}>
                                    <option value="0">Select colors...</option>
                                    ${[1,2,3,4,5,6].map(n => `
                                        <option value="${n}" ${loc.colors === n ? 'selected' : ''}>${n} Color${n > 1 ? 's' : ''}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Hide add button if at max locations
            addBtn.style.display = this.printSetup.additionalLocations.length >= 3 ? 'none' : 'block';
        }

        getAvailableLocationOptions(currentIndex) {
            // All available locations
            const allLocations = [
                { value: 'back', label: 'Full Back' },
                { value: 'left-sleeve', label: 'Left Sleeve' },
                { value: 'right-sleeve', label: 'Right Sleeve' },
                { value: 'custom', label: 'Custom Location' }
            ];

            // Locations to exclude (already selected in OTHER slots)
            const excluded = [];

            this.printSetup.additionalLocations.forEach((loc, index) => {
                if (index !== currentIndex && loc.location) {
                    excluded.push(loc.location);
                }
            });

            return allLocations.filter(opt => !excluded.includes(opt.value));
        }

        updateLocationSelection(index, value) {
            this.printSetup.additionalLocations[index].location = value;

            // If location is cleared, also clear colors
            if (!value) {
                this.printSetup.additionalLocations[index].colors = 0;
            }

            this.updateAdditionalLocationsUI();
            this.updatePricingCalculator();
        }

        updateLocationColors(index, colors) {
            this.printSetup.additionalLocations[index].colors = colors;
            this.updatePricingCalculator();
        }

        getLocationName(code) {
            const locationNames = {
                'back': 'Full Back',
                'left-sleeve': 'Left Sleeve',
                'right-sleeve': 'Right Sleeve',
                'custom': 'Custom Location'
            };
            return locationNames[code] || code;
        }

        async searchProducts(term) {
            const suggestionsEl = document.getElementById('style-suggestions');

            if (term.length < 2) {
                suggestionsEl.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/products/search?q=${term}&limit=10`);
                const products = await response.json();

                if (products.length > 0) {
                    // Show dropdown with clickable suggestions
                    suggestionsEl.innerHTML = products.map(p => `
                        <div class="suggestion-item" data-style="${p.STYLE_NUMBER || p.style}">
                            <strong>${p.STYLE_NUMBER || p.style}</strong> - ${p.PRODUCT_TITLE || p.name || ''}
                        </div>
                    `).join('');
                    suggestionsEl.style.display = 'block';

                    // Add click handlers to suggestions
                    suggestionsEl.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', async () => {
                            const style = item.dataset.style;
                            document.getElementById('style-search').value = style;
                            suggestionsEl.style.display = 'none';
                            await this.selectProductStyle(style);
                        });
                    });
                } else {
                    suggestionsEl.innerHTML = '<div class="suggestion-item no-results">No products found</div>';
                    suggestionsEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Search error:', error);
                suggestionsEl.style.display = 'none';
            }
        }

        async selectProductStyle(styleNumber) {
            try {
                const response = await fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/products/${styleNumber}`);
                const product = await response.json();

                this.currentProduct = {
                    styleNumber: styleNumber,
                    details: product
                };

                // Load colors
                const colorSelect = document.getElementById('color-select');
                colorSelect.disabled = false;
                colorSelect.innerHTML = '<option value="">Select a color...</option>';

                if (product.colors && product.colors.length > 0) {
                    product.colors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color;
                        option.textContent = color;
                        colorSelect.appendChild(option);
                    });
                }

                document.getElementById('load-product-btn').disabled = false;
            } catch (error) {
                console.error('Error loading style:', error);
                alert('Error loading product');
            }
        }

        async loadProductDetails() {
            const color = document.getElementById('color-select').value;
            if (!color) {
                alert('Please select a color');
                return;
            }

            // Get pricing data
            const pricingData = await this.pricingService.fetchPricingData(this.currentProduct.styleNumber);

            // Update calculator with pricing data
            this.pricingCalculator.setPricingData(pricingData);

            // Display product
            document.getElementById('product-display').style.display = 'block';
            document.getElementById('product-name').textContent = `${this.currentProduct.styleNumber} - ${this.currentProduct.details.PRODUCT_TITLE || ''}`;
            document.getElementById('product-description').textContent = color;

            // Create size inputs
            const sizeInputsContainer = document.getElementById('size-inputs');
            sizeInputsContainer.innerHTML = '';

            const sizes = pricingData.sizes || ['S', 'M', 'L', 'XL', '2XL'];
            sizes.forEach(sizeObj => {
                const size = sizeObj.size || sizeObj;
                const sizeGroup = document.createElement('div');
                sizeGroup.className = 'size-input-group';
                sizeGroup.innerHTML = `
                    <label class="size-label">${size}</label>
                    <input type="number"
                           class="size-quantity"
                           data-size="${size}"
                           min="0"
                           value="0"
                           onchange="screenPrintQuoteBuilder.updateProductTotal()">
                `;
                sizeInputsContainer.appendChild(sizeGroup);
            });

            this.currentProduct.color = color;
            this.currentProduct.sizes = sizes.map(s => s.size || s);
            this.currentProduct.pricingData = pricingData;
        }

        updateProductTotal() {
            let total = 0;
            document.querySelectorAll('.size-quantity').forEach(input => {
                total += parseInt(input.value) || 0;
            });

            document.getElementById('product-total-qty').textContent = total;
            document.getElementById('add-to-quote-btn').disabled = total === 0;
        }

        addProductToQuote() {
            const sizeBreakdown = {};
            let totalQuantity = 0;

            document.querySelectorAll('.size-quantity').forEach(input => {
                const size = input.dataset.size;
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    sizeBreakdown[size] = qty;
                    totalQuantity += qty;
                }
            });

            // Calculate total across all products for tier
            const grandTotal = this.products.reduce((sum, p) => sum + p.quantity, totalQuantity);

            // Set calculator quantity to grand total
            this.pricingCalculator.state.quantity = grandTotal;

            // Calculate pricing using screenprint-pricing-v2.js
            const pricing = this.pricingCalculator.calculatePricing();

            const product = {
                styleNumber: this.currentProduct.styleNumber,
                productName: this.currentProduct.details.PRODUCT_TITLE || '',
                color: this.currentProduct.color,
                sizeBreakdown: sizeBreakdown,
                quantity: totalQuantity,
                unitPrice: pricing.basePrice + pricing.additionalCost,
                total: (pricing.basePrice + pricing.additionalCost) * totalQuantity,
                tier: this.getTierForQuantity(grandTotal)
            };

            this.products.push(product);
            this.displayProductsList();

            // Reset
            document.getElementById('style-search').value = '';
            document.getElementById('color-select').disabled = true;
            document.getElementById('load-product-btn').disabled = true;
            document.getElementById('product-display').style.display = 'none';

            this.checkMinimum();
        }

        getTierForQuantity(qty) {
            if (qty >= 13 && qty <= 36) return '13-36';
            if (qty >= 37 && qty <= 72) return '37-72';
            if (qty >= 73 && qty <= 144) return '73-144';
            if (qty >= 145) return '145-576';
            return '13-36';
        }

        displayProductsList() {
            const container = document.getElementById('products-container');
            const totalPieces = this.products.reduce((sum, p) => sum + p.quantity, 0);

            document.getElementById('products-count').textContent = this.products.length;
            document.getElementById('total-pieces').textContent = totalPieces;

            if (this.products.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No products added yet.</p>';
                return;
            }

            container.innerHTML = this.products.map((product, index) => `
                <div class="product-item">
                    <div class="product-item-info">
                        <div class="product-item-details">
                            <h4>${product.styleNumber} - ${product.color}</h4>
                            <p>${product.quantity} pieces @ $${product.unitPrice.toFixed(2)}/ea = $${product.total.toFixed(2)}, Tier: ${product.tier}</p>
                        </div>
                    </div>
                    <div class="product-item-actions">
                        <button class="btn-danger" onclick="screenPrintQuoteBuilder.removeProduct(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        removeProduct(index) {
            if (confirm('Remove this product?')) {
                this.products.splice(index, 1);
                this.displayProductsList();
                this.checkMinimum();
            }
        }

        checkMinimum() {
            const total = this.products.reduce((sum, p) => sum + p.quantity, 0);
            const warning = document.getElementById('minimum-warning');

            if (total > 0 && total < 36) {
                warning.style.display = 'block';
                document.getElementById('current-total').textContent = total;
                document.getElementById('continue-to-summary').disabled = false;
            } else {
                warning.style.display = 'none';
                document.getElementById('continue-to-summary').disabled = this.products.length === 0;
            }
        }

        generateQuoteSummary() {
            const totalQuantity = this.products.reduce((sum, p) => sum + p.quantity, 0);

            // Update calculator state
            this.pricingCalculator.state.quantity = totalQuantity;
            const pricing = this.pricingCalculator.calculatePricing();

            const subtotal = this.products.reduce((sum, p) => sum + p.total, 0);
            const setupFees = pricing.setupFee || 0;
            const grandTotal = subtotal + setupFees;

            const summaryContainer = document.getElementById('quote-summary');
            summaryContainer.innerHTML = `
                <div class="summary-section">
                    <h3>Print Setup</h3>
                    <div class="summary-row">
                        <span>Front Colors:</span>
                        <span>${this.printSetup.frontColors} ${this.printSetup.frontColors === 1 ? 'color' : 'colors'}${this.printSetup.isDarkGarment ? ' + 1 underbase' : ''}</span>
                    </div>
                    ${this.printSetup.additionalLocations.length > 0 ? `
                        <div class="summary-row">
                            <span>Additional Locations:</span>
                            <span>${this.printSetup.additionalLocations.length}</span>
                        </div>
                        ${this.printSetup.additionalLocations.map((loc, index) => `
                            <div class="summary-row" style="padding-left: 1rem; font-size: 0.875rem;">
                                <span>${this.getLocationName(loc.location)}: ${loc.colors} ${loc.colors === 1 ? 'color' : 'colors'}${this.printSetup.isDarkGarment ? ' + 1 underbase' : ''}</span>
                                <span>$${(loc.colors + (this.printSetup.isDarkGarment ? 1 : 0)) * 30}</span>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>

                <div class="summary-section">
                    <h3>Products (${this.products.length} items, ${totalQuantity} pieces)</h3>
                    ${this.products.map(p => `
                        <div class="summary-row">
                            <span>${p.styleNumber} - ${p.color}, ${p.quantity} pieces @ $${p.unitPrice.toFixed(2)}/ea</span>
                            <span>$${p.total.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="summary-section">
                    <h3>Pricing</h3>
                    <div class="summary-row">
                        <span>Products & Printing:</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="summary-row">
                        <span>Setup Fees (Screens):</span>
                        <span>$${setupFees.toFixed(2)}</span>
                    </div>
                    <div class="summary-total">
                        <div class="summary-row">
                            <span style="font-size: 1.125rem;">Grand Total:</span>
                            <span>$${grandTotal.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;

            this.currentPricing = {
                totalQuantity,
                subtotal,
                setupFees,
                grandTotal
            };
        }

        async saveQuote() {
            const customerName = document.getElementById('customer-name').value.trim();
            const customerEmail = document.getElementById('customer-email').value.trim();
            const salesRep = document.getElementById('sales-rep').value;

            if (!customerName || !customerEmail || !salesRep) {
                alert('Please fill in all required fields');
                return;
            }

            const quoteData = {
                customerName,
                customerEmail,
                customerPhone: document.getElementById('customer-phone').value.trim(),
                companyName: document.getElementById('company-name').value.trim(),
                salesRepEmail: salesRep,

                printSetup: this.printSetup,
                items: this.products,
                totalQuantity: this.currentPricing.totalQuantity,
                subtotal: this.currentPricing.subtotal,
                setupFees: this.currentPricing.setupFees,
                grandTotal: this.currentPricing.grandTotal
            };

            const result = await this.quoteService.saveQuote(quoteData);

            if (result.success) {
                document.getElementById('modal-quote-id').textContent = result.quoteID;
                document.getElementById('success-modal').style.display = 'block';
            } else {
                alert('Error saving quote: ' + result.error);
            }
        }

        navigateToPhase(phase) {
            document.querySelectorAll('.phase-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.phase-step').forEach(s => s.classList.remove('active', 'completed'));

            const phases = ['setup-phase', 'product-phase', 'summary-phase'];
            document.getElementById(phases[phase - 1]).classList.add('active');

            document.querySelectorAll('.phase-step').forEach(step => {
                const stepPhase = parseInt(step.dataset.phase);
                if (stepPhase < phase) step.classList.add('completed');
                else if (stepPhase === phase) step.classList.add('active');
            });

            this.currentPhase = phase;
        }
    }

    const screenPrintQuoteBuilder = new ScreenPrintQuoteBuilder();

    function newQuote() {
        if (confirm('Start a new quote?')) {
            location.reload();
        }
    }

    console.log('✅ Screen Print Quote Builder loaded - using screenprint-pricing-v2.js for pricing');
    </script>
</body>
</html>
