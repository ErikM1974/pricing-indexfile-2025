<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Embroidery Quote Builder - Garments & Caps | Northwest Custom Apparel</title>

    <!-- NWCA Favicon -->
    <link rel="icon" type="image/png" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Embroidery Quote Builder Styles (External CSS - Extracted January 2026) -->
    <link rel="stylesheet" href="/shared_components/css/embroidery-quote-builder-extracted.css?v=20260106">

    <!-- Quote Builder Shared Components -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-common.css?v=20260127">

    <!-- Shared Color Picker Component -->
    <link rel="stylesheet" href="/shared_components/css/color-picker-shared.css?v=20260106">

    <!-- Shared Quote Share Modal (2026 consolidation) -->
    <link rel="stylesheet" href="/shared_components/css/quote-share-modal.css?v=20260113">

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- REMOVED: 1,799 lines of inline CSS moved to embroidery-quote-builder-extracted.css -->
    <style>
        /* Placeholder - inline styles removed, using external CSS */
    </style>

</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Compact Header -->
    <header class="power-header">
        <a href="/staff-dashboard.html">
            <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1"
                 alt="Northwest Custom Apparel"
                 class="logo">
        </a>
        <div style="text-align: center;">
            <div style="font-size: 18px; font-weight: 600;">
                2026 Embroidery Quote Builder
                <span id="unsaved-indicator" class="unsaved-badge" style="display: none;">
                    <i class="fas fa-circle"></i> Unsaved
                </span>
            </div>
            <div style="font-size: 12px; color: #ffffff; margin-top: 2px;">Garments + Caps | Embroidery, 3D Puff & Laser Patches</div>
        </div>
        <div class="header-actions">
            <button class="btn-header btn-new-quote" onclick="confirmNewQuote()">
                <i class="fas fa-plus"></i> New Quote
            </button>
            <button class="btn-header" onclick="window.location.href='/staff-dashboard.html'">
                <i class="fas fa-arrow-left"></i> Dashboard
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="power-main">
        <!-- Left: Content Area -->
        <div class="power-content">
            <!-- 2026 Modernized Logo Configuration Section -->
            <div class="logo-config-container">
                <!-- Left Column: Logo Cards -->
                <div class="logo-cards-column">
                    <!-- Primary Logo Card (Garments) - Hidden until garments added -->
                    <div class="logo-card" id="garment-logo-card" style="display: none;">
                        <div class="logo-card-header">
                            <div class="logo-card-icon garment">
                                <i class="fas fa-tshirt"></i>
                            </div>
                            <span class="logo-card-title">Primary Logo</span>
                        </div>
                        <div class="logo-card-body">
                            <div class="logo-form-row">
                                <div class="logo-form-field">
                                    <label>Position</label>
                                    <select id="primary-position">
                                        <option value="Left Chest" selected>Left Chest</option>
                                        <option value="Right Chest">Right Chest</option>
                                        <option value="Center Chest">Center Chest</option>
                                    </select>
                                </div>
                                <div class="logo-form-field">
                                    <label>Stitches</label>
                                    <input type="number" id="primary-stitches" value="8000"
                                           min="1000" max="50000" step="1000">
                                </div>
                                <div class="digitizing-checkbox" onclick="toggleDigitizingCheckbox(this, 'primary-digitizing')">
                                    <input type="checkbox" id="primary-digitizing">
                                    <div class="digitizing-checkbox-indicator">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <span class="digitizing-checkbox-label">Digitizing</span>
                                    <span class="digitizing-checkbox-price">$100</span>
                                </div>
                            </div>
                            <!-- Additional Logo Toggle -->
                            <div class="additional-logo-section">
                                <div class="toggle-switch-container">
                                    <div class="toggle-switch" id="garment-al-switch" onclick="toggleGlobalALNew('garment')">
                                        <div class="toggle-switch-handle"></div>
                                    </div>
                                    <span class="toggle-switch-label" id="garment-al-label">Additional logo on garments</span>
                                    <input type="checkbox" id="garment-al-toggle" style="display: none;">
                                </div>
                                <div class="additional-logo-config" id="garment-al-config-new">
                                    <div class="logo-form-row">
                                        <div class="logo-form-field">
                                            <label>Position</label>
                                            <select id="garment-al-position" onchange="updateGlobalAL('garment')">
                                                <option value="Right Chest">Right Chest</option>
                                                <option value="Left Chest">Left Chest</option>
                                                <option value="Left Sleeve">Left Sleeve</option>
                                                <option value="Right Sleeve">Right Sleeve</option>
                                            </select>
                                        </div>
                                        <div class="logo-form-field">
                                            <label>Stitches</label>
                                            <input type="number" id="garment-al-stitches" value="8000"
                                                   min="1000" max="50000" step="1000"
                                                   onchange="updateGlobalAL('garment')">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cap Logo Card (hidden by default) -->
                    <div class="logo-card" id="cap-logo-card" style="display: none;">
                        <div class="logo-card-header">
                            <div class="logo-card-icon cap">
                                <i class="fas fa-hat-cowboy"></i>
                            </div>
                            <span class="logo-card-title">Cap Front Logo</span>
                        </div>
                        <div class="logo-card-body">
                            <!-- Embellishment Type Selection -->
                            <div class="logo-form-row" style="margin-bottom: 12px;">
                                <div class="logo-form-field" style="flex: 1;">
                                    <label>Embellishment Type</label>
                                    <select id="cap-embellishment-type" onchange="handleCapEmbellishmentChange()">
                                        <option value="embroidery" selected>Flat Embroidery</option>
                                        <option value="3d-puff">3D Puff Embroidery (+$5/cap)</option>
                                        <option value="laser-patch">Laser Leatherette Patch (+$5/cap)</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Embroidery Options (shown for embroidery and 3d-puff) -->
                            <div id="cap-embroidery-options">
                                <div class="logo-form-row">
                                    <div class="logo-form-field">
                                        <label>Position</label>
                                        <select id="cap-primary-position" disabled>
                                            <option value="CF" selected>Cap Front</option>
                                        </select>
                                    </div>
                                    <div class="logo-form-field">
                                        <label>Stitches</label>
                                        <input type="number" id="cap-primary-stitches" value="8000"
                                               min="1000" max="50000" step="1000">
                                    </div>
                                    <div class="digitizing-checkbox" onclick="toggleDigitizingCheckbox(this, 'cap-primary-digitizing')">
                                        <input type="checkbox" id="cap-primary-digitizing">
                                        <div class="digitizing-checkbox-indicator">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <span class="digitizing-checkbox-label">Digitizing</span>
                                        <span class="digitizing-checkbox-price">$100</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Patch Options (hidden by default, shown for laser-patch) -->
                            <!-- Note: All laser patches are standard size (2-4"), no size selection needed -->
                            <div id="cap-patch-options" style="display: none;">
                                <div class="logo-form-row">
                                    <div class="logo-form-field">
                                        <label>Position</label>
                                        <select disabled style="opacity: 0.6; cursor: not-allowed;">
                                            <option value="CF" selected>Cap Front</option>
                                        </select>
                                    </div>
                                    <div class="digitizing-checkbox checked" onclick="toggleDigitizingCheckbox(this, 'cap-patch-setup')">
                                        <input type="checkbox" id="cap-patch-setup" checked>
                                        <div class="digitizing-checkbox-indicator">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <span class="digitizing-checkbox-label">Design Setup</span>
                                        <span class="digitizing-checkbox-price">$50</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Additional Logo Toggle (hidden for patches - front only) -->
                            <div class="additional-logo-section" id="cap-al-section">
                                <div class="toggle-switch-container">
                                    <div class="toggle-switch" id="cap-al-switch" onclick="toggleGlobalALNew('cap')">
                                        <div class="toggle-switch-handle"></div>
                                    </div>
                                    <span class="toggle-switch-label" id="cap-al-label">Additional logo on caps</span>
                                    <input type="checkbox" id="cap-al-toggle" style="display: none;">
                                </div>
                                <div class="additional-logo-config" id="cap-al-config-new">
                                    <div class="logo-form-row">
                                        <div class="logo-form-field">
                                            <label>Position</label>
                                            <select id="cap-al-position" onchange="updateGlobalAL('cap')">
                                                <option value="Cap Back">Cap Back</option>
                                                <option value="Cap Left">Cap Left</option>
                                                <option value="Cap Right">Cap Right</option>
                                            </select>
                                        </div>
                                        <div class="logo-form-field">
                                            <label>Stitches</label>
                                            <input type="number" id="cap-al-stitches" value="5000"
                                                   min="1000" max="50000" step="1000"
                                                   onchange="updateGlobalAL('cap')">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Artwork Services (hidden until products added) -->
                <div class="artwork-services-column" id="artwork-services" style="display: none;">
                    <div class="artwork-services-card">
                        <div class="artwork-services-header">
                            <div class="artwork-services-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <span class="artwork-services-title">Artwork Services</span>
                        </div>
                        <div class="artwork-services-body">
                            <!-- Logo Mockup & Print Review - Checkbox Toggle -->
                            <div class="artwork-field">
                                <div class="artwork-checkbox-row">
                                    <label class="artwork-toggle" onclick="toggleArtCharge()">
                                        <input type="checkbox" id="art-charge-toggle">
                                        <span class="artwork-toggle-indicator"></span>
                                        <span class="artwork-toggle-label">Logo Mockup & Review</span>
                                    </label>
                                    <div class="artwork-field-input-wrapper" id="art-charge-wrapper" style="opacity: 0.4;">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="art-charge" min="0" step="0.01" value="0" disabled
                                               onchange="updateAdditionalCharges(); updateTaxCalculation();"
                                               oninput="updateAdditionalCharges(); updateTaxCalculation();">
                                    </div>
                                </div>
                            </div>
                            <!-- Graphic Design Services -->
                            <div class="artwork-field">
                                <label class="artwork-field-label">Graphic Design ($75/hr)</label>
                                <div class="graphic-design-field">
                                    <input type="number" id="graphic-design-hours" min="0" step="0.5" placeholder="0"
                                           onchange="updateAdditionalCharges(); updateTaxCalculation();"
                                           oninput="updateAdditionalCharges(); updateTaxCalculation();">
                                    <span class="hours-label">hrs</span>
                                    <span class="hours-total">= $<span id="graphic-design-total">0.00</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legacy hidden elements for backwards compatibility with existing JS -->
            <div id="cap-logo-section" style="display: none;"></div>

            <!-- Product Grid Section -->
            <div class="product-grid-section">
                <!-- Search Row -->
                <div class="search-row">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               id="product-search"
                               class="search-input"
                               placeholder="Search by style # (e.g., PC54, G500) or product name"
                               autocomplete="off">
                        <div id="search-suggestions" class="search-suggestions"></div>
                    </div>
                </div>

                <!-- Excel-Style Product Table -->
                <div class="product-table-wrapper">
                    <table class="product-table" id="product-table">
                        <thead>
                            <tr>
                                <th class="style-col">Style</th>
                                <th class="desc-col">Description</th>
                                <th class="color-col">Color</th>
                                <th class="size-col">S</th>
                                <th class="size-col">M</th>
                                <th class="size-col">LG</th>
                                <th class="size-col">XL</th>
                                <th class="size-col">XXL</th>
                                <th class="size-col" style="line-height: 1.1;" title="Click to add extended sizes (3XL, 4XL, 5XL, etc.)">More<br><span style="font-size: 10px; font-weight: 400;">Sizes</span></th>
                                <th class="qty-col">Qty</th>
                                <th class="price-col">Unit $</th>
                                <th class="total-col">Total</th>
                                <th class="actions-col"></th>
                            </tr>
                        </thead>
                        <tbody id="product-tbody">
                            <!-- Empty State Message - shown until products added -->
                            <tr id="empty-state-row">
                                <td colspan="13" style="text-align: center; padding: 40px 20px; color: #64748b; background: #f8fafc;">
                                    <div style="font-size: 32px; margin-bottom: 12px;">&#128085;</div>
                                    <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Enter a style number to get started</div>
                                    <div style="font-size: 13px; color: #94a3b8;">Type a style # in the search bar above (e.g., PC54, G500, C112)</div>
                                </td>
                            </tr>
                            <!-- Product rows will be added here -->
                        </tbody>
                        <!-- Fee Summary Section (auto-populated by JS) -->
                        <tbody id="fees-tbody" class="fee-summary-section">
                            <!-- Garment LTM Row -->
                            <tr id="garment-ltm-table-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-tshirt"></i> Garment LTM Fee (&lt; 24 pcs)
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price">$50.00</td>
                                <td class="cell-total" id="garment-ltm-table-total">$50.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <!-- Cap LTM Row -->
                            <tr id="cap-ltm-table-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-hat-cowboy"></i> Cap LTM Fee (&lt; 24 pcs)
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price">$50.00</td>
                                <td class="cell-total" id="cap-ltm-table-total">$50.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <!-- Setup/Digitizing Fee Row -->
                            <tr id="setup-fee-table-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-cog"></i> Digitizing/Setup Fee
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="setup-fee-unit">$0.00</td>
                                <td class="cell-total" id="setup-fee-total">$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <!-- Additional Stitches Fee Row -->
                            <tr id="stitches-fee-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-layer-group"></i> Additional Stitches Fee
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="stitches-fee-unit">$0.00</td>
                                <td class="cell-total" id="stitches-fee-total">$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <!-- Art Charge Row -->
                            <tr id="art-charge-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-palette"></i> Logo Mockup & Review
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="art-charge-unit">$0.00</td>
                                <td class="cell-total" id="art-charge-total">$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <!-- Graphic Design Row -->
                            <tr id="graphic-design-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-pencil-ruler"></i> Graphic Design (<span id="design-hours-label">0</span> hrs Ã— $75)
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="graphic-design-unit">$0.00</td>
                                <td class="cell-total" id="graphic-design-total-row">$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <!-- Rush Fee Row -->
                            <tr id="rush-fee-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-bolt"></i> Rush Fee
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="rush-fee-unit">$0.00</td>
                                <td class="cell-total" id="rush-fee-total">$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <!-- Discount Row -->
                            <tr id="discount-row" class="fee-row discount-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-tag"></i> Discount <span id="discount-reason-label"></span>
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="discount-unit">-$0.00</td>
                                <td class="cell-total" id="discount-total">-$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Add Row Button -->
                <button class="add-row-btn" onclick="addNewRow()">
                    <i class="fas fa-plus"></i> Add Product (or press Tab from last cell)
                </button>

                <!-- Keyboard Hints -->
                <!-- Keyboard Hints - Show on Hover -->
                <div class="keyboard-hint-container">
                    <div class="keyboard-hint-trigger">
                        <i class="fas fa-keyboard"></i> Shortcuts
                    </div>
                    <div class="keyboard-hint-content">
                        <kbd>Tab</kbd> Next cell &nbsp;|&nbsp;
                        <kbd>Enter</kbd> Next row &nbsp;|&nbsp;
                        <kbd>Ctrl+S</kbd> Save &nbsp;|&nbsp;
                        <kbd>Ctrl+P</kbd> Print PDF
                    </div>
                </div>

                <!-- Extended Size Picker Backdrop -->
                <div id="size-popup-backdrop" class="size-popup-backdrop hidden" onclick="closeExtendedSizePopup()"></div>

                <!-- Extended Size Picker Popup (for Size06/Other sizes) -->
                <div id="extended-size-popup" class="size-popup hidden">
                    <div class="size-popup-header">
                        <h4><i class="fas fa-ruler"></i> Extended Sizes (Size06)</h4>
                        <button class="size-popup-close" onclick="closeExtendedSizePopup()">&times;</button>
                    </div>
                    <p class="size-popup-hint">Enter quantities for extended sizes. These create separate line items.</p>
                    <div class="size-popup-grid" id="size-popup-grid">
                        <!-- Size inputs generated dynamically -->
                    </div>
                    <div class="size-popup-actions">
                        <button class="size-popup-cancel" onclick="closeExtendedSizePopup()">Cancel</button>
                        <button class="size-popup-apply" onclick="applyExtendedSizes()">
                            <i class="fas fa-check"></i> Apply Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Pricing Sidebar -->
        <div class="power-sidebar" id="power-sidebar">
            <!-- Resize handle for dragging sidebar width -->
            <div class="sidebar-resize-handle" id="sidebar-resize-handle"></div>

            <!-- Scrollable content area -->
            <div class="sidebar-scroll-container">
                <!-- Pricing Panel -->
                <div class="pricing-panel">
                <div class="pricing-title">
                    <i class="fas fa-calculator"></i> Quote Summary
                </div>

                <div class="pricing-row">
                    <span class="label">Total Pieces:</span>
                    <span class="value" id="total-qty">0</span>
                </div>
                <!-- Quantity breakdown for mixed quotes -->
                <div class="pricing-row sub-breakdown" id="garment-qty-row" style="display: none;">
                    <span class="label"><i class="fas fa-tshirt" style="font-size: 11px; margin-right: 4px;"></i> Garments:</span>
                    <span class="value sub-value" id="garment-qty">0</span>
                </div>
                <div class="pricing-row sub-breakdown" id="cap-qty-row" style="display: none;">
                    <span class="label"><i class="fas fa-hat-cowboy" style="font-size: 11px; margin-right: 4px;"></i> Caps:</span>
                    <span class="value sub-value" id="cap-qty">0</span>
                </div>

                <div class="pricing-row">
                    <span class="label">Pricing Tier:</span>
                    <span class="tier-badge" id="pricing-tier">1-23</span>
                </div>
                <!-- Tier breakdown for mixed quotes -->
                <div class="pricing-row sub-breakdown" id="garment-tier-row" style="display: none;">
                    <span class="label"><i class="fas fa-tshirt" style="font-size: 11px; margin-right: 4px;"></i> Garment Tier:</span>
                    <span class="tier-badge small" id="garment-tier">1-23</span>
                </div>
                <div class="pricing-row sub-breakdown" id="cap-tier-row" style="display: none;">
                    <span class="label"><i class="fas fa-hat-cowboy" style="font-size: 11px; margin-right: 4px;"></i> Cap Tier:</span>
                    <span class="tier-badge small" id="cap-tier">1-23</span>
                </div>

                <div class="pricing-row">
                    <span class="label" id="products-label">Products (Base 8K):</span>
                    <span class="value" id="subtotal">$0.00</span>
                </div>

                <!-- Mixed Quote Breakdown (caps + garments) -->
                <div class="pricing-row sub-breakdown" id="garment-subtotal-row" style="display: none;">
                    <span class="label"><i class="fas fa-tshirt" style="font-size: 11px; margin-right: 4px;"></i> Garments:</span>
                    <span class="value sub-value" id="garment-subtotal">$0.00</span>
                </div>
                <div class="pricing-row sub-breakdown" id="cap-subtotal-row" style="display: none;">
                    <span class="label"><i class="fas fa-hat-cowboy" style="font-size: 11px; margin-right: 4px;"></i> Caps:</span>
                    <span class="value sub-value" id="cap-subtotal">$0.00</span>
                </div>

                <!-- Fee displays moved to table rows (2026 UI refactor) -->
                <div id="additional-logos-pricing"></div>
                <div id="cap-additional-logos-pricing"></div>

            </div>

            <!-- Additional Charges Panel - MOVED ABOVE TOTALS per UX best practices -->
            <div class="additional-charges-panel" style="background: #f0fdf4; border-radius: 8px; padding: 16px; margin-bottom: 16px; border: 1px solid #86efac;">
                <div class="charges-header" onclick="toggleAdditionalCharges()" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                    <div style="font-size: 14px; font-weight: 600; color: #166534; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plus-circle"></i> Additional Charges
                        <span style="font-size: 12px; font-weight: 400; color: #666;">(Optional)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="charges-badge" style="display: none; background: #22c55e; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">+$0.00</span>
                        <i id="charges-chevron" class="fas fa-chevron-up" style="color: #666; transition: transform 0.2s; transform: rotate(180deg);"></i>
                    </div>
                </div>
                <div id="charges-content" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #86efac;">
                    <!-- NOTE: Logo Mockup & Graphic Design moved to Artwork Services card at top (2026 UI update) -->
                    <!-- Rush Fee -->
                    <div class="charge-field" style="margin-bottom: 10px;">
                        <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Rush Fee</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666;">$</span>
                            <input type="number" id="rush-fee" min="0" step="0.01" placeholder="0.00"
                                   onchange="updateAdditionalCharges(); updateTaxCalculation();" oninput="updateAdditionalCharges(); updateTaxCalculation();"
                                   style="width: 100%; padding: 8px 10px 8px 24px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                        </div>
                    </div>
                    <!-- NOTE: Sample Fee removed per user request (2026-01-14) -->
                    <!-- Discount -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #fca5a5; background: #fef2f2; margin: 12px -16px -16px; padding: 12px 16px; border-radius: 0 0 8px 8px;">
                        <label style="font-size: 12px; color: #b91c1c; margin-bottom: 4px; display: block; font-weight: 600;">Discount</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="position: relative; flex: 1;">
                                <span id="discount-symbol" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666;">$</span>
                                <input type="number" id="discount-amount" min="0" step="0.01" placeholder="0.00"
                                       onchange="updateAdditionalCharges(); updateTaxCalculation();" oninput="updateAdditionalCharges(); updateTaxCalculation();"
                                       style="width: 100%; padding: 8px 10px 8px 24px; border: 1px solid #fca5a5; border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                            </div>
                            <select id="discount-type" onchange="updateDiscountType(); updateTaxCalculation();"
                                    style="width: 60px; padding: 8px; border: 1px solid #fca5a5; border-radius: 4px; font-size: 13px; background: white;">
                                <option value="fixed">$</option>
                                <option value="percent">%</option>
                            </select>
                        </div>
                        <input type="text" id="discount-reason" placeholder="Reason (optional)"
                               style="width: 100%; padding: 8px 10px; border: 1px solid #fca5a5; border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                    </div>
                </div>
            </div>

            <!-- Totals Section with Tax -->
            <div class="pricing-panel" style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; border: 1px solid #e2e8f0;">
                <!-- Totals Section with Tax -->
                <div class="pricing-totals-section" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e2e8f0;">
                    <div class="pricing-row subtotal-row">
                        <span class="label" style="font-weight: 600;">Subtotal:</span>
                        <span class="value" id="pre-tax-subtotal" style="font-weight: 600;">$0.00</span>
                    </div>
                    <div class="pricing-row tax-toggle-row" style="margin: 10px 0;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; color: #475569;">
                            <input type="checkbox" id="include-tax" checked onchange="updateTaxCalculation()"
                                   style="width: 16px; height: 16px; cursor: pointer; accent-color: #22c55e;">
                            <span>Include WA Sales Tax (10.1%)</span>
                        </label>
                    </div>
                    <div class="pricing-row tax-amount-row" id="tax-row">
                        <span class="label" style="color: #64748b;">WA Sales Tax:</span>
                        <span class="value" id="tax-amount" style="color: #64748b;">$0.00</span>
                    </div>
                    <div class="pricing-row grand-total-row" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #22c55e; background: linear-gradient(135deg, #f0fdf4, #dcfce7); margin: 10px -16px -16px; padding: 12px 16px; border-radius: 0 0 8px 8px;">
                        <span class="label" style="font-weight: 700; font-size: 16px; color: #166534;">TOTAL:</span>
                        <span class="value" id="grand-total-with-tax" style="font-weight: 700; font-size: 18px; color: #166534;">$0.00</span>
                    </div>
                </div>

            </div>

            <!-- Save & Share Section (Collapsible) -->
            <div class="save-quote-panel" style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 16px; border: 1px solid #e2e8f0;">
                <div class="save-quote-header" onclick="toggleSaveShare()" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                    <div class="save-quote-title" style="font-size: 14px; font-weight: 600; color: #334155; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-share-alt"></i> Save & Share
                    </div>
                    <i id="save-share-chevron" class="fas fa-chevron-up" style="color: #666; transition: transform 0.2s; transform: rotate(180deg);"></i>
                </div>
                <div id="save-share-content" style="display: none; margin-top: 12px;">
                    <div class="customer-fields" style="display: flex; flex-direction: column; gap: 10px;">
                        <div class="customer-field">
                            <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Name *</label>
                            <input type="text" id="customer-name" placeholder="Customer name" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                        </div>
                        <div class="customer-field">
                            <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Email *</label>
                            <input type="email" id="customer-email" placeholder="email@company.com" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                        </div>
                        <div class="customer-field">
                            <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Company</label>
                            <input type="text" id="company-name" placeholder="Company name" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                        </div>
                        <div class="customer-field">
                            <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Phone</label>
                            <input type="tel" id="customer-phone" placeholder="(555) 555-5555" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                        </div>
                        <div class="customer-field">
                            <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Sales Rep</label>
                            <select id="sales-rep" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white; box-sizing: border-box;">
                                <option value="sales@nwcustomapparel.com">General Sales</option>
                                <option value="adriyella@nwcustomapparel.com">Adriyella</option>
                                <option value="bradley@nwcustomapparel.com">Bradley Wright</option>
                                <option value="erik@nwcustomapparel.com">Erik Mickelson</option>
                                <option value="jim@nwcustomapparel.com">Jim Mickelson</option>
                                <option value="nika@nwcustomapparel.com">Nika Lao</option>
                                <option value="ruth@nwcustomapparel.com">Ruth Nhong</option>
                                <option value="art@nwcustomapparel.com">Steve Deland</option>
                                <option value="taneisha@nwcustomapparel.com">Taneisha Clark</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-save-quote" onclick="saveAndGetLink()" style="margin-top: 12px; width: 100%; padding: 12px; background: linear-gradient(135deg, #4cb354, #409a47); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-link"></i> Save & Get Shareable Link
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-panel">
                <button class="btn-action btn-primary-action" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i> Copy Quote to Clipboard
                </button>
                <button class="btn-action btn-secondary-action" onclick="printQuote()">
                    <i class="fas fa-print"></i> Print Quote
                </button>
            </div>
            </div><!-- End sidebar-scroll-container -->

            <!-- Sticky TOTAL - Hidden (totals now shown in pricing summary above) -->
            <div class="pricing-total-sticky" style="display: none;">
                <div class="pricing-row total">
                    <span class="label">TOTAL:</span>
                    <span class="value" id="grand-total">$0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Logo Modal -->
    <div id="logo-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-palette"></i> Custom Logo Setup</h3>
                <button class="modal-close" onclick="closeLogoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Position</label>
                    <select id="logo-position">
                        <option value="Left Chest">Left Chest</option>
                        <option value="Right Chest">Right Chest</option>
                        <option value="Center Chest">Center Chest</option>
                        <option value="Full Front">Full Front</option>
                        <option value="Full Back">Full Back</option>
                        <option value="Upper Back">Upper Back</option>
                        <option value="Left Sleeve">Left Sleeve</option>
                        <option value="Right Sleeve">Right Sleeve</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stitch Count</label>
                    <input type="number" id="logo-stitches" value="8000" min="1000" step="1000">
                    <small style="color: #666;">Min: 1,000 | Increment: 1,000</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-action btn-secondary-action" onclick="closeLogoModal()" style="background: #6c757d;">Cancel</button>
                <button class="btn-action btn-primary-action" onclick="applyCustomLogo()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Core Dependencies -->
    <script src="/shared_components/js/exact-match-search.js?v=20260106"></script>
    <script src="/shared_components/js/quote-share-modal.js?v=20260113"></script>
    <script src="/shared_components/js/embroidery-pricing-service.js"></script>
    <script src="/shared_components/js/embroidery-quote-pricing.js?v=20251219-no-monogram"></script>
    <script src="/shared_components/js/embroidery-quote-service.js?v=20260114-totalamount-fix"></script>
    <script src="/shared_components/js/embroidery-quote-invoice.js?v=20251219-no-monogram"></script>
    <script src="/shared_components/js/sku-validation-service.js?v=20260104"></script>

    <!-- Auto-Save & Draft Recovery (2026 consolidation) -->
    <script src="/shared_components/js/quote-persistence.js?v=20260113"></script>
    <script src="/shared_components/js/quote-session.js?v=20260113"></script>

    <!-- Sidebar Resize Functionality -->
    <script src="/shared_components/js/sidebar-resize.js?v=20260114"></script>

    <!-- Staff Authentication Helper (auto-select sales rep) -->
    <script src="/shared_components/js/staff-auth-helper.js?v=20260113"></script>

    <!-- Power Quote Controller -->
    <script>
        // ============================================================
        // EMBROIDERY POWER QUOTE - Excel-Style Quote Builder
        // ============================================================

        const API_BASE = 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com';

        // NOTE: SIZE_MODIFIERS was removed - use SIZE_TO_SUFFIX (line ~1520) instead
        // SIZE_TO_SUFFIX contains ALL size suffixes including tall, youth, toddler, etc.

        // Standard sizes that group together (same pricing) - Slots 1-4
        const STANDARD_SIZES = ['S', 'M', 'L', 'XL'];

        // Extended sizes that get their own line items
        // Note: 2XL goes to Size05 (dedicated), all others go to Size06 (Other)
        const EXTENDED_SIZES = ['XS', '2XL', '3XL', '4XL', '5XL', '6XL'];

        // ShopWorks size slot mapping
        // Size01-04: Standard sizes (S, M, L, XL) - combined into one line item
        // Size05: 2XL only - separate line item
        // Size06: ALL others (XS, 3XL, 4XL, 5XL, Youth, Tall, OSFA) - each gets separate line item
        const SIZE_TO_SLOT = {
            'S': 'Size01', 'M': 'Size02', 'L': 'Size03', 'XL': 'Size04',
            '2XL': 'Size05',  // 2XL has dedicated slot
            'XS': 'Size06', '3XL': 'Size06', '4XL': 'Size06',
            '5XL': 'Size06', '6XL': 'Size06', 'OSFA': 'Size06'
        };

        // Display labels matching ShopWorks column headers
        // Note: Internally we use L/2XL/3XL, but display as LG/XXL/XXXL
        const SIZE_DISPLAY_LABELS = {
            'S': 'S', 'M': 'M', 'L': 'LG', 'XL': 'XL',
            '2XL': 'XXL', '3XL': 'XXXL',
            'XS': 'XXXL', '4XL': 'XXXL', '5XL': 'XXXL', '6XL': 'XXXL'
        };

        // State
        let pricingCalculator = null;
        let quoteService = null;

        // Edit mode state (for revising existing quotes)
        let editingQuoteId = null;
        let editingRevision = null;

        // Unsaved changes tracking (UX improvement)
        let hasChanges = false;

        // Auto-save & Draft Recovery (2026 consolidation)
        let embPersistence = null;
        let embSession = null;

        // Primary logo configuration
        let primaryLogo = {
            position: 'Left Chest',
            stitchCount: 8000,
            needsDigitizing: false,
            isPrimary: true
        };

        // Additional logos array (for garments)
        let additionalLogos = [];
        // Example entry: { id: 'al-1', position: 'Right Chest', stitchCount: 8000, needsDigitizing: false, isPrimary: false }

        // Cap Logo Configuration (separate from garment logos)
        // Supports multiple embellishment types: 'embroidery', '3d-puff', 'patch'
        let capPrimaryLogo = {
            position: 'CF',  // Cap Front (always)
            stitchCount: 8000,
            needsDigitizing: false,
            isPrimary: true,
            embellishmentType: 'embroidery',  // Default: flat embroidery
            needsSetup: true  // For patches: $50 design setup fee (GRT-50)
        };
        let capAdditionalLogos = [];
        // Example entry: { id: 'cap-al-1', position: 'CB', stitchCount: 5000, needsDigitizing: false, isPrimary: false }

        let products = [];
        let rowCounter = 0;
        let productCache = {}; // Cache product data for quick lookup
        let childRowMap = {}; // Track child rows: { parentRowId: { '2XL': childRowId, '3XL': childRowId } }
        // Global AL config (applies to all products of type when enabled)
        let globalAL = {
            garment: { enabled: false, position: 'Right Chest', stitchCount: 8000 },
            cap: { enabled: false, position: 'Cap Back', stitchCount: 5000 }
        };

        // Toggle global AL on/off
        function toggleGlobalAL(type) {
            const checkbox = document.getElementById(`${type}-al-toggle`);
            const config = document.getElementById(`${type}-al-config`);

            globalAL[type].enabled = checkbox.checked;
            config.style.display = checkbox.checked ? 'flex' : 'none';

            // Recalculate all product prices
            recalculatePricing();
        }

        // Update global AL config (position or stitch count change)
        function updateGlobalAL(type) {
            const position = document.getElementById(`${type}-al-position`).value;
            const stitches = parseInt(document.getElementById(`${type}-al-stitches`).value) || (type === 'cap' ? 5000 : 8000);

            globalAL[type].position = position;
            globalAL[type].stitchCount = stitches;

            // Recalculate all product prices
            recalculatePricing();
        }

        // NEW: Toggle function for modernized toggle switch UI
        function toggleGlobalALNew(type) {
            const switchEl = document.getElementById(`${type}-al-switch`);
            const labelEl = document.getElementById(`${type}-al-label`);
            const configEl = document.getElementById(`${type}-al-config-new`);
            const hiddenCheckbox = document.getElementById(`${type}-al-toggle`);

            // Toggle the state
            const isActive = switchEl.classList.toggle('active');
            labelEl.classList.toggle('active', isActive);
            configEl.classList.toggle('visible', isActive);

            // Update hidden checkbox for backwards compatibility
            hiddenCheckbox.checked = isActive;

            // Update global state
            globalAL[type].enabled = isActive;

            // Recalculate pricing
            recalculatePricing();
        }

        // NEW: Toggle function for modernized digitizing checkbox
        function toggleDigitizingCheckbox(element, checkboxId) {
            const checkbox = document.getElementById(checkboxId);
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('checked', checkbox.checked);

            // Update the corresponding logo object based on checkbox ID
            if (checkboxId === 'primary-digitizing') {
                primaryLogo.needsDigitizing = checkbox.checked;
            } else if (checkboxId === 'cap-primary-digitizing') {
                capPrimaryLogo.needsDigitizing = checkbox.checked;
            } else if (checkboxId === 'cap-patch-setup') {
                capPrimaryLogo.needsSetup = checkbox.checked;
            }

            // Trigger pricing recalculation
            recalculatePricing();
        }

        // NEW: Toggle function for Logo Mockup & Print Review charge
        function toggleArtCharge() {
            const toggle = document.getElementById('art-charge-toggle');
            const input = document.getElementById('art-charge');
            const wrapper = document.getElementById('art-charge-wrapper');

            // Toggle the checkbox state
            toggle.checked = !toggle.checked;

            if (toggle.checked) {
                // Enable the input and set default $50
                input.disabled = false;
                wrapper.style.opacity = '1';
                if (!input.value || parseFloat(input.value) === 0) {
                    input.value = '50.00';
                }
            } else {
                // Disable the input and zero it out
                input.disabled = true;
                wrapper.style.opacity = '0.4';
                input.value = '0';
            }

            updateAdditionalCharges();
            updateTaxCalculation();
        }

        // Handle cap embellishment type change (Flat Embroidery, 3D Puff, or Patch)
        function handleCapEmbellishmentChange() {
            const embellishmentType = document.getElementById('cap-embellishment-type').value;
            const embroideryOptions = document.getElementById('cap-embroidery-options');
            const patchOptions = document.getElementById('cap-patch-options');
            const alSection = document.getElementById('cap-al-section');

            // Update the capPrimaryLogo object with new embellishment type
            capPrimaryLogo.embellishmentType = embellishmentType;

            if (embellishmentType === 'laser-patch') {
                // Show patch options, hide embroidery options
                embroideryOptions.style.display = 'none';
                patchOptions.style.display = 'block';
                // Hide additional logo section - patches are front only
                alSection.style.display = 'none';
                // Disable AL if it was enabled
                if (globalAL.cap.enabled) {
                    toggleGlobalALNew('cap'); // Turn it off
                }
                // Hide artwork services for patches - setup fee includes artwork
                const artworkServices = document.getElementById('artwork-services');
                if (artworkServices) {
                    artworkServices.style.display = 'none';
                }
                // For patches: no stitches needed, use setup fee instead of digitizing
                capPrimaryLogo.stitchCount = 0;
                capPrimaryLogo.needsDigitizing = false;
                capPrimaryLogo.needsSetup = document.getElementById('cap-patch-setup')?.checked ?? true;
            } else {
                // Show embroidery options (for both flat and 3D puff)
                embroideryOptions.style.display = 'block';
                patchOptions.style.display = 'none';
                // Show additional logo section for embroidery types
                alSection.style.display = 'block';
                // Show artwork services for embroidery
                const artworkServices = document.getElementById('artwork-services');
                if (artworkServices) {
                    artworkServices.style.display = 'block';
                }
                // Restore stitch count from input
                capPrimaryLogo.stitchCount = parseInt(document.getElementById('cap-primary-stitches')?.value) || 8000;
                capPrimaryLogo.needsDigitizing = document.getElementById('cap-primary-digitizing')?.checked ?? false;
                capPrimaryLogo.needsSetup = false; // Not applicable for embroidery
            }

            console.log(`[Cap Embellishment] Changed to: ${embellishmentType}`, capPrimaryLogo);

            // Recalculate pricing with new embellishment type
            recalculatePricing();
        }

        // Get current cap embellishment type
        function getCapEmbellishmentType() {
            const dropdown = document.getElementById('cap-embellishment-type');
            return dropdown ? dropdown.value : 'embroidery';
        }

        // Update embellishment dropdown labels with prices from API
        // Rule: ALWAYS pull pricing from Caspio API - never hardcode
        function updateEmbellishmentDropdownLabels() {
            if (!pricingCalculator || !pricingCalculator.capInitialized) return;

            const dropdown = document.getElementById('cap-embellishment-type');
            if (!dropdown) return;

            const upcharges = pricingCalculator.getEmbellishmentUpcharges();

            // Update 3D Puff option
            const puffOption = dropdown.querySelector('option[value="3d-puff"]');
            if (puffOption) {
                puffOption.textContent = `3D Puff Embroidery (+$${upcharges.puff}/cap)`;
            }

            // Update Patch option
            const patchOption = dropdown.querySelector('option[value="laser-patch"]');
            if (patchOption) {
                patchOption.textContent = `Laser Leatherette Patch (+$${upcharges.patch}/cap)`;
            }

            console.log('[UI] Embellishment dropdown labels updated from API:', upcharges);
        }

        // Extended sizes available for Size06 (Other) column
        // Note: Actual available sizes are fetched dynamically per product via API
        // Includes OSFA for beanies, bags, and other one-size-fits-all items
        // All sizes that go in Size06 column (the "Other/Catch-All" column)
        // Based on Python Inksoft/Inksoft_Size_Translation_Import.csv
        const SIZE06_EXTENDED_SIZES = [
            // Extended large
            'XS', '3XL', '4XL', '5XL', '6XL', '7XL', '8XL', '9XL', '10XL',
            // One-size
            'OSFA', 'OSFM',
            // Combos (for fitted caps)
            'S/M', 'M/L', 'L/XL', 'XS/S', 'X/2X', 'S/XL',
            // Tall
            'LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT', 'ST', 'MT', 'XST',
            // Youth
            'YXS', 'YS', 'YM', 'YL', 'YXL',
            // Toddler
            '2T', '3T', '4T', '5T', '5/6T', '6T',
            // Big
            'LB', 'XLB', '2XLB',
            // Extra small
            'XXS', '2XS', 'XXL'
        ];

        // Full extended size ordering for child row display
        // Organized by category for easier reading
        const EXTENDED_SIZE_ORDER = [
            // Extra small first
            'XXS', '2XS', 'XS', 'XS/S',
            // Standard combos
            'S/M', 'M/L', 'L/XL', 'X/2X', 'S/XL',
            // Extended large (2XL in Size05, but included for sorting)
            '2XL', 'XXL', '3XL', '4XL', '5XL', '6XL', '7XL', '8XL', '9XL', '10XL',
            // Tall
            'ST', 'MT', 'XST', 'LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT',
            // Big
            'LB', 'XLB', '2XLB',
            // Youth
            'YXS', 'YS', 'YM', 'YL', 'YXL',
            // Toddler (smallest to largest)
            '2T', '3T', '4T', '5T', '5/6T', '6T',
            // One-size at end (for beanies/bags)
            'OSFA', 'OSFM'
        ];

        // Complete SIZE_TO_SUFFIX mapping for ShopWorks part numbers
        // Standard sizes (S, M, L, XL) have no suffix
        // All other sizes get a suffix appended to the base part number
        const SIZE_TO_SUFFIX = {
            // Standard sizes (no suffix) - Size01-04
            'S': '', 'M': '', 'L': '', 'XL': '',
            // 2XL - Size05
            '2XL': '_2X',
            // Extended large - Size06
            '3XL': '_3X', '4XL': '_4X', '5XL': '_5X', '6XL': '_6X',
            '7XL': '_7XL', '8XL': '_8XL', '9XL': '_9XL', '10XL': '_10XL',
            // Extra small - Size06
            'XS': '_XS', 'XXS': '_XXS', '2XS': '_2XS', 'XXL': '_XXL',
            // One-size options - Size06
            'OSFA': '_OSFA', 'OSFM': '_OSFM',
            // Size combinations - Size06
            'S/M': '_S/M', 'M/L': '_M/L', 'L/XL': '_L/XL',
            'XS/S': '_XS/S', 'X/2X': '_X/2X', 'S/XL': '_S/XL',
            // Tall sizes - Size06
            'LT': '_LT', 'XLT': '_XLT', '2XLT': '_2XLT', '3XLT': '_3XLT',
            '4XLT': '_4XLT', '5XLT': '_5XLT', '6XLT': '_6XLT',
            'ST': '_ST', 'MT': '_MT', 'XST': '_XST',
            // Youth sizes - Size06
            'YXS': '_YXS', 'YS': '_YS', 'YM': '_YM', 'YL': '_YL', 'YXL': '_YXL',
            // Toddler sizes - Size06
            '2T': '_2T', '3T': '_3T', '4T': '_4T', '5T': '_5T', '5/6T': '_5/6T', '6T': '_6T',
            // Big sizes - Size06
            'LB': '_LB', 'XLB': '_XLB', '2XLB': '_2XLB'
        };

        // ============================================================
        // EXTENDED SIZE PICKER POPUP (for Size06/XXXL column)
        // ============================================================

        /**
         * Fetch available extended sizes for a product from the API
         * @param {string} styleNumber - Product style number (e.g., 'J790')
         * @param {string} color - Product color (CATALOG_COLOR)
         * @returns {Promise<string[]>} Array of available extended sizes (e.g., ['XS', '3XL', '4XL'])
         */
        async function getAvailableExtendedSizes(styleNumber, color) {
            try {
                // Query the ShopWorks import format endpoint to get available SKUs
                const url = `${API_BASE}/api/sanmar-shopworks/import-format?styleNumber=${encodeURIComponent(styleNumber)}&color=${encodeURIComponent(color || '')}`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.warn('Failed to fetch extended sizes for this product');
                    return []; // Return empty to trigger "No extended sizes available" message
                }

                const skus = await response.json();

                // Extract available extended sizes from Size06 field in response
                const extendedSizes = new Set();

                skus.forEach(sku => {
                    // Check Size06 field for extended sizes (XS, 3XL, 4XL, etc.)
                    if (sku.Size06 && typeof sku.Size06 === 'string') {
                        extendedSizes.add(sku.Size06);
                    }

                    // Also check ID_Product for suffix pattern to identify available sizes
                    // e.g., J790_3X indicates 3XL is available
                    if (sku.ID_Product && sku.ID_Product.includes('_')) {
                        const suffix = sku.ID_Product.split('_').pop();
                        // Map suffix back to size name (reverse of SIZE_TO_SUFFIX)
                        const suffixToSize = {
                            // Extended large
                            '2X': '2XL', '3X': '3XL', '4X': '4XL', '5X': '5XL', '6X': '6XL',
                            '7XL': '7XL', '8XL': '8XL', '9XL': '9XL', '10XL': '10XL',
                            // Extra small
                            'XS': 'XS', 'XXS': 'XXS', '2XS': '2XS', 'XXL': 'XXL',
                            // One-size
                            'OSFA': 'OSFA', 'OSFM': 'OSFM',
                            // Combos
                            'S/M': 'S/M', 'M/L': 'M/L', 'L/XL': 'L/XL',
                            'XS/S': 'XS/S', 'X/2X': 'X/2X', 'S/XL': 'S/XL',
                            // Tall
                            'LT': 'LT', 'XLT': 'XLT', '2XLT': '2XLT', '3XLT': '3XLT',
                            '4XLT': '4XLT', '5XLT': '5XLT', '6XLT': '6XLT',
                            'ST': 'ST', 'MT': 'MT', 'XST': 'XST',
                            // Youth
                            'YXS': 'YXS', 'YS': 'YS', 'YM': 'YM', 'YL': 'YL', 'YXL': 'YXL',
                            // Toddler
                            '2T': '2T', '3T': '3T', '4T': '4T', '5T': '5T', '5/6T': '5/6T', '6T': '6T',
                            // Big
                            'LB': 'LB', 'XLB': 'XLB', '2XLB': '2XLB'
                        };
                        if (suffixToSize[suffix]) {
                            extendedSizes.add(suffixToSize[suffix]);
                        }
                    }
                });

                // Return as sorted array, maintaining standard order
                const orderedSizes = SIZE06_EXTENDED_SIZES.filter(size => extendedSizes.has(size));
                console.log(`ðŸ“¦ Available extended sizes for ${styleNumber}:`, orderedSizes);
                return orderedSizes;

            } catch (error) {
                console.error('Error fetching extended sizes:', error);
                return []; // Return empty to trigger "No extended sizes available" message
            }
        }

        /**
         * Open the extended size picker popup for a product row
         * Dynamically fetches available sizes from API
         * @param {string} rowId - The parent row ID (e.g., 'row-1')
         */
        async function openExtendedSizePopup(rowId) {
            const popup = document.getElementById('extended-size-popup');
            const backdrop = document.getElementById('size-popup-backdrop');
            const grid = document.getElementById('size-popup-grid');
            const applyBtn = popup.querySelector('.size-popup-apply');

            // Store which row we're editing (as numeric ID)
            popup.dataset.rowId = rowId;

            // Get parent row to find style and color info (DOM ID has 'row-' prefix)
            const parentRow = document.getElementById(`row-${rowId}`);
            if (!parentRow) {
                console.error('Cannot find row:', `row-${rowId}`);
                return;
            }

            const styleNumber = parentRow.dataset.style;
            const catalogColor = parentRow.dataset.catalogColor || parentRow.dataset.color;

            if (!styleNumber) {
                showToast('Select a product first', 'error');
                return;
            }

            // Show popup with loading state
            popup.classList.remove('hidden');
            backdrop.classList.remove('hidden');
            applyBtn.disabled = true;

            // Check if this is a pants or shorts product (use stored sizes directly)
            const isPants = parentRow.dataset.sizeCategory === 'pants';
            const isShorts = parentRow.dataset.sizeCategory === 'shorts';
            let availableSizes;

            if (isPants && parentRow.dataset.pantsSizes) {
                // For pants, use the sizes stored from analyzeSizeCategory
                availableSizes = JSON.parse(parentRow.dataset.pantsSizes);
                // Update popup header for pants
                popup.querySelector('.size-popup-header h4').innerHTML = '<i class="fas fa-ruler"></i> Waist/Inseam Sizes';
                popup.querySelector('.size-popup-hint').textContent = 'Enter quantities for each waist/inseam combination. These create separate line items.';
            } else if (isShorts && parentRow.dataset.shortsSizes) {
                // For shorts (waist-only), use the sizes stored from analyzeSizeCategory
                availableSizes = JSON.parse(parentRow.dataset.shortsSizes);
                // Update popup header for shorts
                popup.querySelector('.size-popup-header h4').innerHTML = '<i class="fas fa-ruler"></i> Waist Sizes';
                popup.querySelector('.size-popup-hint').textContent = 'Enter quantities for each waist size. These create separate line items.';
            } else {
                // Show loading spinner for non-pants
                grid.innerHTML = `
                    <div class="size-popup-loading" style="grid-column: 1 / -1;">
                        <div class="spinner"></div>
                        <span>Loading available sizes...</span>
                    </div>
                `;
                // Fetch available sizes from API
                availableSizes = await getAvailableExtendedSizes(styleNumber, catalogColor);
                // Reset header for non-pants
                popup.querySelector('.size-popup-header h4').innerHTML = '<i class="fas fa-ruler"></i> Extended Sizes (Size06)';
                popup.querySelector('.size-popup-hint').textContent = 'Enter quantities for extended sizes. These create separate line items.';
            }

            // Check if we have any sizes
            if (!availableSizes || availableSizes.length === 0) {
                const sizeType = isPants ? 'waist/inseam' : (isShorts ? 'waist' : 'extended');
                grid.innerHTML = `
                    <div class="size-popup-empty" style="grid-column: 1 / -1;">
                        <i class="fas fa-info-circle"></i><br>
                        No ${sizeType} sizes available for ${styleNumber}.
                    </div>
                `;
                applyBtn.disabled = true;
                console.log(`â„¹ï¸ No ${sizeType} sizes available for ${styleNumber}`);
                return;
            }

            // Generate size inputs with current values
            if (isShorts) {
                // Shorts: simple waist-only list (W30, W32, etc.)
                grid.innerHTML = availableSizes.map(size => {
                    const currentQty = getExtendedSizeQty(rowId, size);
                    // Display as "Waist 30" instead of "W30"
                    const waistNum = size.replace('W', '');
                    return `
                        <div class="size-popup-item">
                            <label>Waist ${waistNum}</label>
                            <input type="number"
                                   min="0"
                                   data-size="${size}"
                                   value="${currentQty || ''}"
                                   placeholder="0"
                                   class="size-popup-input">
                        </div>
                    `;
                }).join('');
            } else if (isPants) {
                // Group pants sizes by waist for better UX
                const waistGroups = {};
                availableSizes.forEach(size => {
                    if (/^\d{4}$/.test(size)) {
                        const waist = size.substring(0, 2);
                        if (!waistGroups[waist]) waistGroups[waist] = [];
                        waistGroups[waist].push(size);
                    }
                });

                // Common waists that should be expanded by default
                const commonWaists = ['30', '32', '34', '36'];

                grid.innerHTML = Object.keys(waistGroups).sort((a, b) => parseInt(a) - parseInt(b)).map(waist => {
                    const isExpanded = commonWaists.includes(waist);
                    const sizesHtml = waistGroups[waist].map(size => {
                        const currentQty = getExtendedSizeQty(rowId, size);
                        const inseam = size.substring(2, 4);
                        return `
                            <div class="size-popup-item">
                                <label>${waist}x${inseam}</label>
                                <input type="number"
                                       min="0"
                                       data-size="${size}"
                                       value="${currentQty || ''}"
                                       placeholder="0"
                                       class="size-popup-input">
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="pants-waist-group ${isExpanded ? 'expanded' : 'collapsed'}">
                            <div class="waist-header" onclick="toggleWaistGroup(this)">
                                <i class="fas fa-chevron-${isExpanded ? 'down' : 'right'}"></i>
                                <span>Waist ${waist}</span>
                                <span class="waist-count">(${waistGroups[waist].length} sizes)</span>
                            </div>
                            <div class="waist-sizes" style="${isExpanded ? '' : 'display: none;'}">
                                ${sizesHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Non-pants: flat list (existing behavior)
                grid.innerHTML = availableSizes.map(size => {
                    const currentQty = getExtendedSizeQty(rowId, size);
                    return `
                        <div class="size-popup-item">
                            <label>${size}</label>
                            <input type="number"
                                   min="0"
                                   data-size="${size}"
                                   value="${currentQty || ''}"
                                   placeholder="0"
                                   class="size-popup-input">
                        </div>
                    `;
                }).join('');
            }

            // Enable apply button
            applyBtn.disabled = false;

            // Focus first input
            const firstInput = grid.querySelector('input');
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }

            // Store available sizes for OSFA-only detection in applyExtendedSizes()
            popup.dataset.availableSizes = JSON.stringify(availableSizes);
            console.log(`ðŸ“ Extended size popup opened for ${styleNumber} with sizes:`, availableSizes);
        }

        /**
         * Close the extended size picker popup
         */
        function closeExtendedSizePopup() {
            const popup = document.getElementById('extended-size-popup');
            const backdrop = document.getElementById('size-popup-backdrop');

            popup.classList.add('hidden');
            backdrop.classList.add('hidden');
            popup.dataset.rowId = '';
        }

        /**
         * Toggle a waist group in the pants size picker
         * @param {HTMLElement} headerElement - The clicked waist-header element
         */
        function toggleWaistGroup(headerElement) {
            const group = headerElement.closest('.pants-waist-group');
            const sizesDiv = group.querySelector('.waist-sizes');
            const icon = headerElement.querySelector('i');

            if (group.classList.contains('expanded')) {
                group.classList.remove('expanded');
                group.classList.add('collapsed');
                sizesDiv.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            } else {
                group.classList.remove('collapsed');
                group.classList.add('expanded');
                sizesDiv.style.display = '';
                icon.className = 'fas fa-chevron-down';
            }
        }

        /**
         * Get current quantity for an extended size from child rows
         * @param {string} parentRowId - Parent row ID
         * @param {string} size - Size name (e.g., '4XL')
         * @returns {number} Current quantity or 0
         */
        function getExtendedSizeQty(parentRowId, size) {
            // Check if there's a child row for this size
            if (childRowMap[parentRowId] && childRowMap[parentRowId][size]) {
                const childRowId = childRowMap[parentRowId][size];
                const childRow = document.getElementById(`row-${childRowId}`);
                if (childRow) {
                    const qtyCell = childRow.querySelector('.qty-display');
                    if (qtyCell) {
                        return parseInt(qtyCell.textContent) || 0;
                    }
                }
            }

            // Also check the parent row's 3XL input for existing value (old behavior)
            if (size === '3XL') {
                const parentRow = document.getElementById(`row-${parentRowId}`);
                if (parentRow) {
                    const xxxlInput = parentRow.querySelector('input[data-size="3XL"]');
                    if (xxxlInput && !xxxlInput.classList.contains('xxxl-picker-btn')) {
                        return parseInt(xxxlInput.value) || 0;
                    }
                }
            }

            return 0;
        }

        /**
         * Apply extended size changes from the popup
         */
        function applyExtendedSizes() {
            const popup = document.getElementById('extended-size-popup');
            const rowId = popup.dataset.rowId;

            if (!rowId) {
                console.error('No row ID stored in popup');
                closeExtendedSizePopup();
                return;
            }

            // rowId is numeric, DOM elements have 'row-' prefix
            const parentRow = document.getElementById(`row-${rowId}`);
            if (!parentRow) {
                console.error('Parent row not found:', `row-${rowId}`);
                closeExtendedSizePopup();
                return;
            }

            // Check if this is an OSFA-only product (beanies, caps, bags)
            // OSFA is the BASE size for these products, not an upcharge
            const availableSizes = JSON.parse(popup.dataset.availableSizes || '[]');
            const isOSFAOnly = availableSizes.length === 1 && availableSizes[0] === 'OSFA';

            // Get all size inputs from popup
            const sizeInputs = popup.querySelectorAll('.size-popup-input');
            let totalExtendedQty = 0;
            let sizesChanged = [];

            sizeInputs.forEach(input => {
                const size = input.dataset.size;
                const qty = parseInt(input.value) || 0;
                const currentQty = getExtendedSizeQty(rowId, size);

                if (qty !== currentQty) {
                    sizesChanged.push({ size, qty, previousQty: currentQty });
                }

                if (qty > 0) {
                    totalExtendedQty += qty;

                    // OSFA-only product: put qty in parent row, don't create child row
                    // OSFA is the BASE size for these products (beanies, caps, bags)
                    if (isOSFAOnly && size === 'OSFA') {
                        parentRow.dataset.osfaQty = qty;
                        parentRow.dataset.isOsfaOnly = 'true';
                        document.getElementById(`row-qty-${rowId}`).textContent = qty;
                        console.log(`ðŸ§¢ OSFA-only product: qty ${qty} in parent row (no child row)`);
                    } else {
                        // Normal extended size - create child row with upcharge
                        createOrUpdateExtendedChildRow(rowId, size, qty);
                    }
                } else if (currentQty > 0) {
                    // Remove quantity - handle differently for OSFA-only
                    if (isOSFAOnly && size === 'OSFA') {
                        parentRow.dataset.osfaQty = '0';
                        document.getElementById(`row-qty-${rowId}`).textContent = '0';
                    } else {
                        removeChildRow(rowId, size);
                    }
                }
            });

            // Update the XXXL cell display
            if (isOSFAOnly) {
                // For OSFA-only, show the qty in the XXXL cell (not "+")
                const xxxlCell = parentRow.querySelector('.xxxl-picker-btn');
                if (xxxlCell) {
                    xxxlCell.value = totalExtendedQty > 0 ? totalExtendedQty.toString() : '';
                }
            } else {
                updateXXXLCellDisplay(rowId, totalExtendedQty);
            }

            // Recalculate pricing
            recalculatePricing();

            // Close popup
            closeExtendedSizePopup();

            if (sizesChanged.length > 0) {
                console.log('ðŸ“ Extended sizes applied:', sizesChanged);
            }
        }

        /**
         * Create or update a child row for an extended size
         * @param {string} parentRowId - Parent row ID
         * @param {string} size - Size name (e.g., '4XL')
         * @param {number} qty - Quantity
         */
        function createOrUpdateExtendedChildRow(parentRowId, size, qty) {
            // Initialize map entry if needed
            if (!childRowMap[parentRowId]) {
                childRowMap[parentRowId] = {};
            }

            // Check if child row already exists
            if (childRowMap[parentRowId][size]) {
                const existingChildId = childRowMap[parentRowId][size];
                const existingRow = document.getElementById(`row-${existingChildId}`);
                if (existingRow) {
                    // Update existing row's quantity
                    const qtyDisplay = existingRow.querySelector('.qty-display');
                    if (qtyDisplay) qtyDisplay.textContent = qty;

                    // Update the size input value
                    const sizeInput = existingRow.querySelector(`input[data-size="${size}"]`);
                    if (sizeInput) sizeInput.value = qty;

                    // Recalculate unit price display
                    updateChildRowPrice(existingChildId);
                    return;
                }
            }

            // Need to create new child row - use existing createChildRow function
            createChildRow(parentRowId, size, qty);
        }

        /**
         * Update the XXXL cell display to show total extended sizes
         * @param {string|number} rowId - Row ID (numeric)
         * @param {number} total - Total quantity of all Size06 items
         */
        function updateXXXLCellDisplay(rowId, total) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            const xxxlInput = row.querySelector('input[data-size="3XL"]');
            if (!xxxlInput) return;

            // Make it a picker button if not already
            if (!xxxlInput.classList.contains('xxxl-picker-btn')) {
                xxxlInput.classList.add('xxxl-picker-btn');
                xxxlInput.readOnly = true;
            }

            // Always clear value - child rows display individual quantities
            // Show checkmark (âœ“) if sizes exist, + if none - avoids confusing "4" display
            xxxlInput.value = '';
            xxxlInput.placeholder = total > 0 ? 'âœ“' : '+';
        }

        /**
         * Update child row price after qty change
         * @param {string|number} childRowId - Child row ID (numeric)
         */
        function updateChildRowPrice(childRowId) {
            const childRow = document.getElementById(`row-${childRowId}`);
            if (!childRow) return;

            const priceCell = childRow.querySelector('.unit-price-display');
            const qtyDisplay = childRow.querySelector('.qty-display');
            if (!priceCell || !qtyDisplay) return;

            // Get qty and recalculate (price logic is handled by recalculatePricing)
        }

        // ============================================================
        // AUTO-SAVE & DRAFT RECOVERY (2026 consolidation)
        // ============================================================

        function initEmbroideryPersistence() {
            if (typeof QuotePersistence !== 'undefined') {
                embPersistence = new QuotePersistence({
                    prefix: 'EMB',
                    autoSaveInterval: 30000,
                    debug: false
                });

                // Setup auto-save callback
                embPersistence.onAutoSave = () => {
                    const data = getEmbroideryQuoteData();
                    if (data && (data.products.length > 0 || data.customerName)) {
                        embPersistence.save(data);
                    }
                };
            }

            if (typeof QuoteSession !== 'undefined' && embPersistence) {
                embSession = new QuoteSession({
                    prefix: 'EMB',
                    persistence: embPersistence,
                    debug: false
                });
            }
        }

        function getEmbroideryQuoteData() {
            return {
                products: collectProductsFromTable(),
                primaryLogo: { ...primaryLogo },
                capPrimaryLogo: typeof capPrimaryLogo !== 'undefined' ? { ...capPrimaryLogo } : null,
                garmentAL: {
                    enabled: document.getElementById('garment-al-toggle')?.checked || false,
                    position: document.getElementById('garment-al-position')?.value || 'Right Chest',
                    stitches: document.getElementById('garment-al-stitches')?.value || 8000
                },
                capAL: {
                    enabled: document.getElementById('cap-al-toggle')?.checked || false,
                    position: document.getElementById('cap-al-position')?.value || 'Cap Back',
                    stitches: document.getElementById('cap-al-stitches')?.value || 5000
                },
                customerName: document.getElementById('customer-name')?.value || '',
                customerEmail: document.getElementById('customer-email')?.value || '',
                companyName: document.getElementById('company-name')?.value || '',
                customerPhone: document.getElementById('customer-phone')?.value || '',
                salesRep: document.getElementById('sales-rep')?.value || '',
                timestamp: Date.now()
            };
        }

        function restoreEmbroideryDraft(draft) {
            if (!draft) return;

            console.log('[Embroidery] Restoring draft:', draft);

            // Restore customer info
            if (draft.customerName) {
                const nameEl = document.getElementById('customer-name');
                if (nameEl) nameEl.value = draft.customerName;
            }
            if (draft.customerEmail) {
                const emailEl = document.getElementById('customer-email');
                if (emailEl) emailEl.value = draft.customerEmail;
            }
            if (draft.companyName) {
                const companyEl = document.getElementById('company-name');
                if (companyEl) companyEl.value = draft.companyName;
            }
            if (draft.customerPhone) {
                const phoneEl = document.getElementById('customer-phone');
                if (phoneEl) phoneEl.value = draft.customerPhone;
            }
            if (draft.salesRep) {
                const salesRepEl = document.getElementById('sales-rep');
                if (salesRepEl) salesRepEl.value = draft.salesRep;
            }

            // Restore primary logo configuration
            if (draft.primaryLogo) {
                primaryLogo = { ...primaryLogo, ...draft.primaryLogo };
                const positionEl = document.getElementById('primary-position');
                if (positionEl) positionEl.value = draft.primaryLogo.position || 'Left Chest';
                const stitchesEl = document.getElementById('primary-stitches');
                if (stitchesEl) stitchesEl.value = draft.primaryLogo.stitchCount || 8000;
                const digitizingEl = document.getElementById('primary-digitizing');
                if (digitizingEl) digitizingEl.checked = draft.primaryLogo.needsDigitizing || false;
            }

            // Restore cap primary logo if present
            if (draft.capPrimaryLogo && typeof capPrimaryLogo !== 'undefined') {
                capPrimaryLogo = { ...capPrimaryLogo, ...draft.capPrimaryLogo };
                const capStitchesEl = document.getElementById('cap-primary-stitches');
                if (capStitchesEl) capStitchesEl.value = draft.capPrimaryLogo.stitchCount || 8000;
                const capDigitizingEl = document.getElementById('cap-primary-digitizing');
                if (capDigitizingEl) capDigitizingEl.checked = draft.capPrimaryLogo.needsDigitizing || false;
            }

            // Restore garment AL configuration
            if (draft.garmentAL && draft.garmentAL.enabled) {
                const garmentALToggle = document.getElementById('garment-al-toggle');
                if (garmentALToggle) {
                    garmentALToggle.checked = true;
                    toggleGlobalAL('garment');
                    const posEl = document.getElementById('garment-al-position');
                    if (posEl) posEl.value = draft.garmentAL.position;
                    const stitchEl = document.getElementById('garment-al-stitches');
                    if (stitchEl) stitchEl.value = draft.garmentAL.stitches;
                }
            }

            // Restore cap AL configuration
            if (draft.capAL && draft.capAL.enabled) {
                const capALToggle = document.getElementById('cap-al-toggle');
                if (capALToggle) {
                    capALToggle.checked = true;
                    toggleGlobalAL('cap');
                    const posEl = document.getElementById('cap-al-position');
                    if (posEl) posEl.value = draft.capAL.position;
                    const stitchEl = document.getElementById('cap-al-stitches');
                    if (stitchEl) stitchEl.value = draft.capAL.stitches;
                }
            }

            // Restore products
            if (draft.products && draft.products.length > 0) {
                // Clear any existing rows first
                const tbody = document.getElementById('product-tbody');
                if (tbody) tbody.innerHTML = '';

                draft.products.forEach(product => {
                    // Add product row with saved data
                    const rowId = addNewRow();
                    const row = document.getElementById(`row-${rowId}`);
                    if (!row) return;

                    // Set product data
                    row.dataset.style = product.style || '';
                    row.dataset.catalogColor = product.catalogColor || '';
                    row.dataset.colorName = product.color || '';
                    row.dataset.description = product.description || '';
                    row.dataset.imageUrl = product.imageUrl || '';
                    row.dataset.productType = product.productType || 'garment';

                    // Update display cells
                    const styleCell = row.querySelector('.cell-style');
                    if (styleCell) styleCell.textContent = product.style || '';

                    const descCell = row.querySelector('.cell-desc');
                    if (descCell) descCell.textContent = product.description || '';

                    const colorCell = row.querySelector('.cell-color');
                    if (colorCell) {
                        colorCell.innerHTML = `<span class="color-swatch" style="background: #ccc;"></span>${product.color || ''}`;
                    }

                    // Restore size quantities
                    if (product.sizes || product.sizeBreakdown) {
                        const sizes = product.sizes || product.sizeBreakdown;
                        Object.entries(sizes).forEach(([size, qty]) => {
                            if (qty > 0) {
                                const sizeInput = row.querySelector(`input[data-size="${size}"]`);
                                if (sizeInput) {
                                    sizeInput.value = qty;
                                    updateRowQuantityTotal(rowId);
                                }
                            }
                        });
                    }
                });

                // Check for caps/garments to show appropriate logo sections
                updateCapLogoSectionVisibility();
                updateGarmentLogoSectionVisibility();

                // Recalculate pricing after restoring products
                recalculatePricing();
            }

            showToast('Draft restored successfully', 'success');
        }

        function markEmbroideryDirty() {
            if (embPersistence) {
                embPersistence.markDirty();
            }
        }

        // ============================================================
        // EDIT MODE (Quote Revisions)
        // ============================================================

        /**
         * Check URL for edit parameter
         * Returns quote ID if editing, null otherwise
         */
        function checkForEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('edit');
        }

        /**
         * Load existing quote for editing
         * Populates all form fields with quote data
         */
        async function loadQuoteForEditing(quoteId) {
            console.log('[EditMode] Loading quote for editing:', quoteId);
            showToast('Loading quote...', 'info');

            try {
                const result = await quoteService.loadQuote(quoteId);
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load quote');
                }

                const session = result.session;
                const items = result.items;

                // Store edit mode state
                editingQuoteId = quoteId;
                editingRevision = session.RevisionNumber || 1;

                // Update page header to show edit mode
                updateEditModeUI(quoteId, editingRevision);

                // Populate customer information
                populateCustomerInfo(session);

                // Populate logo configuration
                populateLogoConfig(session, items);

                // Populate products from line items
                await populateProducts(items);

                // Populate additional charges
                populateAdditionalCharges(session);

                // Recalculate pricing to update totals
                recalculatePricing();

                console.log('[EditMode] Quote loaded successfully');
                showToast(`Editing ${quoteId} (Rev ${editingRevision})`, 'success');

            } catch (error) {
                console.error('[EditMode] Error loading quote:', error);
                showToast('Error loading quote: ' + error.message, 'error');
                // Clear edit mode and start fresh
                editingQuoteId = null;
                editingRevision = null;
                addNewRow();
            }
        }

        /**
         * Update UI to show edit mode
         */
        function updateEditModeUI(quoteId, revision) {
            // Update header subtitle
            const headerSubtitle = document.querySelector('.power-header div[style*="text-align: center"] div:last-child');
            if (headerSubtitle) {
                headerSubtitle.innerHTML = `<span style="color: #fbbf24;">âœï¸ Editing: ${quoteId} â€¢ Rev ${revision}</span>`;
            }

            // Update save button text
            const saveBtn = document.querySelector('.btn-save-quote');
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Revision';
            }
        }

        /**
         * Populate customer information fields
         */
        function populateCustomerInfo(session) {
            const fields = {
                'customer-name': session.CustomerName,
                'customer-email': session.CustomerEmail,
                'company-name': session.CompanyName,
                'customer-phone': session.Phone
            };

            for (const [id, value] of Object.entries(fields)) {
                const el = document.getElementById(id);
                if (el && value) el.value = value;
            }

            // Set sales rep dropdown
            const salesRepSelect = document.getElementById('sales-rep');
            if (salesRepSelect && session.SalesRepEmail) {
                for (let i = 0; i < salesRepSelect.options.length; i++) {
                    if (salesRepSelect.options[i].value === session.SalesRepEmail) {
                        salesRepSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }

        /**
         * Populate logo configuration from session data
         */
        function populateLogoConfig(session, items) {
            // Primary logo (garment)
            if (session.PrintLocation) {
                const posSelect = document.getElementById('primary-position');
                if (posSelect) posSelect.value = session.PrintLocation;
                primaryLogo.position = session.PrintLocation;
            }
            if (session.StitchCount) {
                const stitchInput = document.getElementById('primary-stitches');
                if (stitchInput) stitchInput.value = session.StitchCount;
                primaryLogo.stitchCount = session.StitchCount;
            }
            if (session.DigitizingFee > 0) {
                const digitizingCb = document.getElementById('primary-digitizing');
                if (digitizingCb) {
                    digitizingCb.checked = true;
                    // Update visual indicator
                    const container = digitizingCb.closest('.digitizing-checkbox');
                    if (container) container.classList.add('checked');
                }
                primaryLogo.needsDigitizing = true;
            }

            // Additional logo on garments
            if (session.AdditionalLogoLocation) {
                globalAL.garment.enabled = true;
                globalAL.garment.position = session.AdditionalLogoLocation;
                globalAL.garment.stitchCount = session.AdditionalStitchCount || 8000;

                // Update UI
                const alSwitch = document.getElementById('garment-al-switch');
                if (alSwitch) alSwitch.classList.add('active');
                const alConfig = document.getElementById('garment-al-config-new');
                if (alConfig) alConfig.style.display = 'block';
                const alToggle = document.getElementById('garment-al-toggle');
                if (alToggle) alToggle.checked = true;

                const posSelect = document.getElementById('garment-al-position');
                if (posSelect) posSelect.value = session.AdditionalLogoLocation;
                const stitchInput = document.getElementById('garment-al-stitches');
                if (stitchInput) stitchInput.value = session.AdditionalStitchCount || 8000;
            }

            // Cap primary logo
            if (session.CapPrintLocation) {
                const capPosSelect = document.getElementById('cap-primary-position');
                if (capPosSelect) capPosSelect.value = session.CapPrintLocation;
                capPrimaryLogo.position = session.CapPrintLocation;
            }
            if (session.CapStitchCount) {
                const capStitchInput = document.getElementById('cap-primary-stitches');
                if (capStitchInput) capStitchInput.value = session.CapStitchCount;
                capPrimaryLogo.stitchCount = session.CapStitchCount;
            }
            if (session.CapDigitizingFee > 0) {
                const capDigitizingCb = document.getElementById('cap-primary-digitizing');
                if (capDigitizingCb) {
                    capDigitizingCb.checked = true;
                    const container = capDigitizingCb.closest('.digitizing-checkbox');
                    if (container) container.classList.add('checked');
                }
                capPrimaryLogo.needsDigitizing = true;
            }
        }

        /**
         * Populate products from line items
         */
        async function populateProducts(items) {
            // Filter to only product items (not additional services)
            const productItems = items.filter(item =>
                item.EmbellishmentType === 'embroidery' &&
                item.StyleNumber &&
                !item.StyleNumber.startsWith('AL-')
            );

            // Group items by StyleNumber + Color to consolidate size quantities
            const productGroups = {};
            for (const item of productItems) {
                const key = `${item.StyleNumber}|${item.Color}`;
                if (!productGroups[key]) {
                    productGroups[key] = {
                        styleNumber: item.StyleNumber,
                        color: item.Color,
                        productName: item.ProductName,
                        sizeBreakdown: {}
                    };
                }
                // Merge size breakdowns
                try {
                    const sizes = JSON.parse(item.SizeBreakdown || '{}');
                    for (const [size, qty] of Object.entries(sizes)) {
                        productGroups[key].sizeBreakdown[size] =
                            (productGroups[key].sizeBreakdown[size] || 0) + qty;
                    }
                } catch (e) {
                    console.warn('[EditMode] Could not parse SizeBreakdown:', item.SizeBreakdown);
                }
            }

            // Add each product to the table
            for (const product of Object.values(productGroups)) {
                await addProductFromQuote(product);
            }
        }

        /**
         * Add a product row from loaded quote data
         */
        async function addProductFromQuote(product) {
            // Add new row
            addNewRow();
            const row = document.querySelector('tr.new-row');
            if (!row) return;

            const rowId = row.dataset.rowId;
            const styleInput = row.querySelector('.style-input');

            // Set style number and trigger color loading
            styleInput.value = product.styleNumber;
            await onStyleChange(styleInput, parseInt(rowId));

            // Small delay to let colors load
            await new Promise(resolve => setTimeout(resolve, 100));

            // Select the color
            const pickerDropdown = row.querySelector('.color-picker-dropdown');
            if (pickerDropdown) {
                const colorOption = pickerDropdown.querySelector(
                    `[data-color-name="${product.color}"], [data-catalog-color="${product.color}"]`
                );
                if (colorOption) {
                    selectColor(parseInt(rowId), colorOption);
                }
            }

            // Small delay for color selection to process
            await new Promise(resolve => setTimeout(resolve, 50));

            // Set size quantities
            for (const [size, qty] of Object.entries(product.sizeBreakdown)) {
                if (qty > 0) {
                    const sizeInput = row.querySelector(`input[data-size="${size}"]`);
                    if (sizeInput) {
                        sizeInput.value = qty;
                        // Trigger change event to update totals
                        sizeInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            }
        }

        /**
         * Populate additional charges from session data
         */
        function populateAdditionalCharges(session) {
            const chargeFields = {
                'art-charge': session.ArtCharge,
                'graphic-design-hours': session.GraphicDesignHours,
                'rush-fee': session.RushFee,
                'sample-fee': session.SampleFee,
                'sample-qty': session.SampleQty
            };

            for (const [id, value] of Object.entries(chargeFields)) {
                const el = document.getElementById(id);
                if (el && value !== undefined && value !== null) {
                    el.value = value;
                }
            }

            // Handle discount
            if (session.Discount > 0 || session.DiscountPercent > 0) {
                if (session.DiscountPercent > 0) {
                    document.getElementById('discount-type').value = 'percent';
                    document.getElementById('discount-amount').value = session.DiscountPercent;
                    document.getElementById('discount-symbol').textContent = '%';
                } else {
                    document.getElementById('discount-type').value = 'fixed';
                    document.getElementById('discount-amount').value = session.Discount;
                    document.getElementById('discount-symbol').textContent = '$';
                }
            }

            if (session.DiscountReason) {
                const reasonEl = document.getElementById('discount-reason');
                if (reasonEl) reasonEl.value = session.DiscountReason;
            }

            // Update the additional charges display
            updateAdditionalCharges();
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Power Quote Builder initializing...');

            showLoading(true);

            try {
                // Initialize pricing calculator
                pricingCalculator = new EmbroideryPricingCalculator();
                await pricingCalculator.initializeConfig();

                // Initialize quote service
                quoteService = new EmbroideryQuoteService();

                // Check for edit mode (loading existing quote for revision)
                const editQuoteId = checkForEditMode();
                if (editQuoteId) {
                    console.log('[Init] Edit mode detected:', editQuoteId);
                    // Skip draft recovery and load the existing quote instead
                    await loadQuoteForEditing(editQuoteId);
                } else {
                    // Initialize auto-save & draft recovery (2026 consolidation)
                    initEmbroideryPersistence();

                    // Check for draft recovery
                    if (embSession && embSession.shouldShowRecovery()) {
                        embSession.showRecoveryDialog(
                            (draft) => restoreEmbroideryDraft(draft),
                            () => {
                                if (embPersistence) embPersistence.clearDraft();
                                // No auto-row - user starts with empty state
                            }
                        );
                    }
                    // No auto-row - empty state message guides user to search
                }

                // Setup event listeners
                setupSearchAutocomplete();
                setupKeyboardShortcuts();
                setupPrimaryLogoHandlers();
                setupCapPrimaryLogoHandlers();  // Cap logo handlers

                // Auto-select sales rep based on logged-in staff (2026 consolidation)
                if (typeof StaffAuthHelper !== 'undefined') {
                    StaffAuthHelper.autoSelectSalesRep('sales-rep');
                }

                console.log('âœ… Power Quote Builder ready');
                showToast('Ready to build quotes!', 'success');

                // Initialize additional charges display (for default $50 art charge)
                updateAdditionalCharges();

                // Auto-focus search bar for immediate typing (UX improvement)
                const searchInput = document.getElementById('product-search');
                if (searchInput) {
                    searchInput.focus();
                }

                // Setup unsaved changes tracking for form fields (UX improvement)
                setupUnsavedChangesTracking();

            } catch (error) {
                console.error('Failed to initialize:', error);
                showToast('Failed to initialize. Please refresh.', 'error');
            }

            showLoading(false);
        });

        // ============================================================
        // LOGO PRESETS
        // ============================================================

        // ============================================================
        // PRIMARY LOGO HANDLERS
        // ============================================================

        function setupPrimaryLogoHandlers() {
            // Position dropdown
            const positionSelect = document.getElementById('primary-position');
            if (positionSelect) {
                positionSelect.addEventListener('change', function() {
                    primaryLogo.position = this.value;
                    recalculatePricing();
                });
            }

            // Stitch count input
            const stitchInput = document.getElementById('primary-stitches');
            if (stitchInput) {
                stitchInput.addEventListener('change', function() {
                    primaryLogo.stitchCount = parseInt(this.value) || 8000;
                    recalculatePricing();
                });
            }

            // Digitizing checkbox
            const digitizingCheckbox = document.getElementById('primary-digitizing');
            if (digitizingCheckbox) {
                digitizingCheckbox.addEventListener('change', function() {
                    primaryLogo.needsDigitizing = this.checked;
                    recalculatePricing();
                });
            }
        }

        // ============================================================
        // ADDITIONAL LOGO MANAGEMENT
        // ============================================================

        function addAdditionalLogo() {
            const id = 'al-' + Date.now();
            const newLogo = {
                id: id,
                position: 'Right Chest',
                stitchCount: 8000,
                needsDigitizing: false,
                isPrimary: false
            };
            additionalLogos.push(newLogo);
            renderAdditionalLogos();
            recalculatePricing();
        }

        function removeAdditionalLogo(id) {
            additionalLogos = additionalLogos.filter(logo => logo.id !== id);
            renderAdditionalLogos();
            recalculatePricing();
        }

        function updateAdditionalLogo(id, field, value) {
            const logo = additionalLogos.find(l => l.id === id);
            if (logo) {
                logo[field] = value;
                recalculatePricing();
            }
        }

        function renderAdditionalLogos() {
            const container = document.getElementById('additional-logos-list');
            if (!container) return;

            if (additionalLogos.length === 0) {
                container.innerHTML = '<div class="no-logos">No additional logos added</div>';
                return;
            }

            container.innerHTML = additionalLogos.map(logo => `
                <div class="additional-logo-row" data-logo-id="${logo.id}">
                    <select class="al-position" onchange="updateAdditionalLogo('${logo.id}', 'position', this.value)">
                        <option value="Right Chest" ${logo.position === 'Right Chest' ? 'selected' : ''}>Right Chest</option>
                        <option value="Left Sleeve" ${logo.position === 'Left Sleeve' ? 'selected' : ''}>Left Sleeve</option>
                        <option value="Right Sleeve" ${logo.position === 'Right Sleeve' ? 'selected' : ''}>Right Sleeve</option>
                    </select>
                    <div class="stitch-input-group">
                        <input type="number" class="al-stitches" value="${logo.stitchCount}"
                               min="1000" step="1000"
                               onchange="updateAdditionalLogo('${logo.id}', 'stitchCount', parseInt(this.value) || 8000)">
                        <span>stitches</span>
                    </div>
                    <label class="al-digitizing">
                        <input type="checkbox" ${logo.needsDigitizing ? 'checked' : ''}
                               onchange="updateAdditionalLogo('${logo.id}', 'needsDigitizing', this.checked)">
                        Digitizing
                    </label>
                    <span class="al-price" id="al-price-${logo.id}">$0.00/ea</span>
                    <button class="remove-al-btn" onclick="removeAdditionalLogo('${logo.id}')" title="Remove logo">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // ============================================================
        // CAP ADDITIONAL LOGO MANAGEMENT
        // ============================================================

        function addCapAdditionalLogo() {
            const id = 'cap-al-' + Date.now();
            const newLogo = {
                id: id,
                position: 'CB',  // Cap Back default
                stitchCount: 5000,  // Default 5000 for cap additional logos
                needsDigitizing: false,
                isPrimary: false
            };
            capAdditionalLogos.push(newLogo);
            renderCapAdditionalLogos();
            recalculatePricing();
        }

        function removeCapAdditionalLogo(id) {
            capAdditionalLogos = capAdditionalLogos.filter(logo => logo.id !== id);
            renderCapAdditionalLogos();
            recalculatePricing();
        }

        function updateCapAdditionalLogo(id, field, value) {
            const logo = capAdditionalLogos.find(l => l.id === id);
            if (logo) {
                logo[field] = value;
                recalculatePricing();
            }
        }

        function renderCapAdditionalLogos() {
            const container = document.getElementById('cap-additional-logos-list');
            if (!container) return;

            if (capAdditionalLogos.length === 0) {
                container.innerHTML = '<div class="no-logos">No additional cap logos added</div>';
                return;
            }

            container.innerHTML = capAdditionalLogos.map(logo => `
                <div class="additional-logo-row" data-logo-id="${logo.id}">
                    <select class="al-position" onchange="updateCapAdditionalLogo('${logo.id}', 'position', this.value)">
                        <option value="CB" ${logo.position === 'CB' ? 'selected' : ''}>Cap Back</option>
                        <option value="CL" ${logo.position === 'CL' ? 'selected' : ''}>Left Side</option>
                        <option value="CR" ${logo.position === 'CR' ? 'selected' : ''}>Right Side</option>
                    </select>
                    <div class="stitch-input-group">
                        <input type="number" class="al-stitches" value="${logo.stitchCount}"
                               min="1000" step="1000"
                               onchange="updateCapAdditionalLogo('${logo.id}', 'stitchCount', parseInt(this.value) || 5000)">
                        <span>stitches</span>
                    </div>
                    <label class="al-digitizing">
                        <input type="checkbox" ${logo.needsDigitizing ? 'checked' : ''}
                               onchange="updateCapAdditionalLogo('${logo.id}', 'needsDigitizing', this.checked)">
                        Digitizing
                    </label>
                    <span class="al-price" id="cap-al-price-${logo.id}">$0.00/ea</span>
                    <button class="remove-al-btn" onclick="removeCapAdditionalLogo('${logo.id}')" title="Remove logo">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Update cap logo section visibility based on caps in quote
        function updateCapLogoSectionVisibility() {
            const hasCaps = document.querySelectorAll('tr[data-is-cap="true"]').length > 0;
            // Use new card element (2026 modernized UI)
            const capCard = document.getElementById('cap-logo-card');
            if (capCard) {
                capCard.style.display = hasCaps ? 'block' : 'none';
                // Update dropdown labels with API prices when showing cap section
                if (hasCaps) {
                    updateEmbellishmentDropdownLabels();
                }
            }
            // Legacy fallback
            const capSection = document.getElementById('cap-logo-section');
            if (capSection) {
                capSection.style.display = hasCaps ? 'block' : 'none';
            }
            // Also update artwork services visibility
            updateArtworkServicesVisibility();
        }

        // Update garment logo section visibility based on garments in quote
        function updateGarmentLogoSectionVisibility() {
            const hasGarments = document.querySelectorAll('tr[data-is-cap="false"]').length > 0;
            const garmentCard = document.getElementById('garment-logo-card');
            if (garmentCard) {
                garmentCard.style.display = hasGarments ? 'block' : 'none';
            }
            // Also update artwork services visibility
            updateArtworkServicesVisibility();
        }

        // Update artwork services visibility - show when ANY valid products exist
        function updateArtworkServicesVisibility() {
            // Check for rows with data-is-cap attribute (indicates a valid product was added)
            const hasGarments = document.querySelectorAll('tr[data-is-cap="false"]').length > 0;
            const hasCaps = document.querySelectorAll('tr[data-is-cap="true"]').length > 0;
            const hasAnyProducts = hasGarments || hasCaps;
            const artworkServices = document.getElementById('artwork-services');
            if (artworkServices) {
                artworkServices.style.display = hasAnyProducts ? 'block' : 'none';
            }
            // Also update empty state row visibility
            const emptyStateRow = document.getElementById('empty-state-row');
            if (emptyStateRow) {
                emptyStateRow.style.display = hasAnyProducts ? 'none' : '';
            }
        }

        // Setup cap primary logo event handlers
        function setupCapPrimaryLogoHandlers() {
            const stitchesInput = document.getElementById('cap-primary-stitches');
            const digitizingCheckbox = document.getElementById('cap-primary-digitizing');

            if (stitchesInput) {
                stitchesInput.addEventListener('change', function() {
                    capPrimaryLogo.stitchCount = parseInt(this.value) || 8000;
                    recalculatePricing();
                });
            }

            if (digitizingCheckbox) {
                digitizingCheckbox.addEventListener('change', function() {
                    capPrimaryLogo.needsDigitizing = this.checked;
                    recalculatePricing();
                });
            }
        }

        // Legacy functions for backward compatibility
        function setupDigitizingToggle() {
            // Now handled by setupPrimaryLogoHandlers
        }

        // ============================================================
        // PRODUCT SEARCH & AUTOCOMPLETE (Using ExactMatchSearch module)
        // ============================================================

        // Module instance - initialized in setupSearchAutocomplete
        let exactMatchSearcher = null;

        function setupSearchAutocomplete() {
            const searchInput = document.getElementById('product-search');
            const suggestions = document.getElementById('search-suggestions');

            if (!searchInput || !window.ExactMatchSearch) {
                console.error('[Embroidery] Search input or ExactMatchSearch module not found');
                return;
            }

            // Initialize ExactMatchSearch with full keyboard navigation
            exactMatchSearcher = new window.ExactMatchSearch({
                apiBase: API_BASE,
                debounceMs: 300,  // Standardized debounce

                // Auto-load exact matches immediately
                onExactMatch: (product) => {
                    console.log('[Embroidery] Exact match found:', product.value);
                    searchInput.value = '';
                    selectProduct(product.value);
                },

                // Show suggestions dropdown
                onSuggestions: (products) => {
                    showSearchSuggestions(products);
                },

                // Keyboard navigation: update visual highlight
                onNavigate: (selectedIndex, products) => {
                    updateSearchSelectionHighlight(selectedIndex);
                },

                // Keyboard navigation: select item via Enter
                onSelect: (product) => {
                    console.log('[Embroidery] Keyboard selected:', product.value);
                    searchInput.value = '';
                    selectProduct(product.value);
                },

                // Keyboard navigation: close dropdown via Escape
                onClose: () => {
                    suggestions.classList.remove('show');
                }
            });

            // Wire up search input
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();

                if (query.length < 2) {
                    suggestions.classList.remove('show');
                    return;
                }

                exactMatchSearcher.search(query);
            });

            // Handle keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                // Let ExactMatchSearch handle navigation keys
                if (exactMatchSearcher && exactMatchSearcher.handleKeyDown(e)) {
                    return; // Event was handled
                }

                // Handle Enter for immediate search when nothing is selected
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        exactMatchSearcher.searchImmediate(query);
                    }
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-input-wrapper')) {
                    suggestions.classList.remove('show');
                    if (exactMatchSearcher) exactMatchSearcher.resetNavigation();
                }
            });

            console.log('[Embroidery] Search autocomplete initialized with ExactMatchSearch');
        }

        /**
         * Show search suggestions dropdown
         */
        function showSearchSuggestions(products) {
            const suggestions = document.getElementById('search-suggestions');

            if (!products || products.length === 0) {
                suggestions.innerHTML = '<div class="suggestion-item"><span>No products found</span></div>';
                suggestions.classList.add('show');
                return;
            }

            suggestions.innerHTML = products.map(product => {
                // Extract product name (remove style prefix from label)
                const productName = (product.label || '').split(' - ').slice(1).join(' - ') || '';
                return `
                    <div class="suggestion-item" onclick="selectProduct('${product.value}')">
                        <span class="style">${product.value}</span>
                        <span class="name">${productName}</span>
                    </div>
                `;
            }).join('');
            suggestions.classList.add('show');

            // Cache product data (convert to expected format)
            products.forEach(p => {
                productCache[p.value] = {
                    STYLE: p.value,
                    PRODUCT_TITLE: p.label
                };
            });
        }

        /**
         * Update visual highlight on selected suggestion item
         */
        function updateSearchSelectionHighlight(selectedIndex) {
            const suggestions = document.getElementById('search-suggestions');
            if (!suggestions) return;

            suggestions.querySelectorAll('.suggestion-item').forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        async function selectProduct(styleNumber) {
            const searchInput = document.getElementById('product-search');
            const suggestions = document.getElementById('search-suggestions');

            searchInput.value = '';
            suggestions.classList.remove('show');

            // Add product to table
            await addProductRow(styleNumber);

            // Mark as having unsaved changes
            markAsUnsaved();
        }

        // ============================================================
        // PRODUCT TABLE MANAGEMENT
        // ============================================================

        function addNewRow() {
            const tbody = document.getElementById('product-tbody');
            const rowId = ++rowCounter;

            // Hide empty state message when adding first row
            const emptyStateRow = document.getElementById('empty-state-row');
            if (emptyStateRow) emptyStateRow.style.display = 'none';

            const row = document.createElement('tr');
            row.id = `row-${rowId}`;
            row.className = 'new-row';
            row.dataset.rowId = rowId;

            row.innerHTML = `
                <td>
                    <input type="text" class="cell-input style-input"
                           placeholder="Style #"
                           data-field="style"
                           onchange="onStyleChange(this, ${rowId})"
                           onkeydown="handleCellKeydown(event, this)">
                </td>
                <td class="desc-cell">
                    <div class="desc-row">
                        <input type="text" class="cell-input desc-input"
                               placeholder="(auto)"
                               data-field="description"
                               readonly>
                        <span class="cap-badge" id="cap-badge-${rowId}" style="display: none;">
                            <i class="fas fa-hat-cowboy"></i> Cap
                        </span>
                    </div>
                    <div class="pricing-breakdown" id="breakdown-${rowId}"></div>
                </td>
                <td>
                    <div class="color-picker-wrapper" data-row-id="${rowId}">
                        <div class="color-picker-selected disabled" onclick="toggleColorPicker(${rowId})" tabindex="0" onkeydown="handleColorPickerKeydown(event, ${rowId})">
                            <span class="color-swatch empty"></span>
                            <span class="color-name placeholder">Select color...</span>
                            <i class="fas fa-chevron-down picker-arrow"></i>
                        </div>
                        <div class="color-picker-dropdown hidden" id="color-dropdown-${rowId}"></div>
                    </div>
                </td>
                <td><input type="number" class="cell-input size-input" data-size="S" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="number" class="cell-input size-input" data-size="M" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="number" class="cell-input size-input" data-size="L" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="number" class="cell-input size-input" data-size="XL" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="number" class="cell-input size-input" data-size="2XL" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled></td>
                <td><input type="text" class="cell-input size-input xxxl-picker-btn" data-size="3XL" value="" placeholder="+" readonly onclick="openExtendedSizePopup(${rowId})" onkeydown="if(event.key==='Enter'){openExtendedSizePopup(${rowId})}" disabled title="Click to add extended sizes (3XL, 4XL, 5XL, XS, etc.)"></td>
                <td class="cell-qty" id="row-qty-${rowId}">0</td>
                <td class="cell-price" id="row-price-${rowId}">-</td>
                <td class="cell-total" id="row-total-${rowId}">-</td>
                <td class="cell-actions">
                    <button class="btn-delete-row" onclick="deleteRow(${rowId})" title="Delete row">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);

            // Focus on the style input
            setTimeout(() => {
                row.querySelector('.style-input').focus();
            }, 50);

            // Remove the "new-row" highlight after a moment
            setTimeout(() => {
                row.classList.remove('new-row');
            }, 1000);
        }

        async function addProductRow(styleNumber) {
            // Find or create empty row
            let targetRow = document.querySelector('tr.new-row');
            if (!targetRow) {
                addNewRow();
                targetRow = document.querySelector('tr.new-row');
            }

            const rowId = targetRow.dataset.rowId;
            const styleInput = targetRow.querySelector('.style-input');
            styleInput.value = styleNumber;

            await onStyleChange(styleInput, parseInt(rowId));
        }

        async function onStyleChange(input, rowId) {
            const styleNumber = input.value.trim().toUpperCase();
            if (!styleNumber) return;

            const row = document.getElementById(`row-${rowId}`);
            const descInput = row.querySelector('[data-field="description"]');
            const pickerWrapper = row.querySelector('.color-picker-wrapper');
            const pickerSelected = row.querySelector('.color-picker-selected');
            const pickerDropdown = row.querySelector('.color-picker-dropdown');

            try {
                // Fetch product data using stylesearch API
                let product = productCache[styleNumber];
                if (!product) {
                    const response = await fetch(`${API_BASE}/api/stylesearch?term=${styleNumber}`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        // Find exact match or use first result
                        const exactMatch = data.find(p => p.value.toUpperCase() === styleNumber);
                        const result = exactMatch || data[0];
                        product = {
                            STYLE: result.value,
                            PRODUCT_TITLE: result.label
                        };
                        productCache[styleNumber] = product;
                    }
                }

                if (product) {
                    // Pants products (PT20, etc.) are now supported via size picker popup
                    // Size category detection will handle waist/inseam sizing

                    // Clean product title (remove duplicate style numbers from API response)
                    const cleanTitle = cleanProductTitle(product.PRODUCT_TITLE, styleNumber);

                    // Update description with clean title
                    descInput.value = cleanTitle || styleNumber;

                    // Fetch colors using product-colors API (also returns CATEGORY_NAME)
                    const colorsResponse = await fetch(`${API_BASE}/api/product-colors?styleNumber=${styleNumber}`);
                    const colorsData = await colorsResponse.json();
                    const colors = colorsData.colors || [];

                    // Store product category from API
                    const categoryName = colorsData.CATEGORY_NAME || '';
                    row.dataset.category = categoryName;

                    // Check for cap products using CATEGORY_NAME (definitive) or pattern matching (fallback)
                    const isCap = isCapProduct(styleNumber, product.PRODUCT_TITLE, categoryName);
                    const capBadge = document.getElementById(`cap-badge-${rowId}`);
                    if (isCap) {
                        row.dataset.isCap = 'true';
                        if (capBadge) capBadge.style.display = 'inline-flex';
                        showToast('Cap detected - using cap embroidery pricing', 'info', 3000);
                    } else {
                        row.dataset.isCap = 'false';
                        if (capBadge) capBadge.style.display = 'none';
                        // Warn about mixed orders when adding garments to laser-patch quote
                        if (getCapEmbellishmentType() === 'laser-patch') {
                            showToast('Warning: Laser patch embellishment is for caps only. Garments will use standard embroidery pricing.', 'warning', 5000);
                        }
                    }

                    // Reorder row: caps go below garments
                    reorderRowByProductType(row);

                    // Update logo section visibility based on product types
                    updateCapLogoSectionVisibility();
                    updateGarmentLogoSectionVisibility();

                    if (colors && colors.length > 0) {
                        // Populate custom color picker dropdown with swatches
                        pickerDropdown.innerHTML = colors.map(c => `
                            <div class="color-picker-option"
                                 data-color-name="${escapeHtml(c.COLOR_NAME)}"
                                 data-catalog-color="${escapeHtml(c.CATALOG_COLOR || c.COLOR_NAME)}"
                                 data-swatch-url="${escapeHtml(c.COLOR_SQUARE_IMAGE || '')}"
                                 data-hex="${escapeHtml(c.HEX_CODE || '#ccc')}"
                                 onclick="selectColor(${rowId}, this)">
                                <span class="color-swatch" style="${getSwatchStyle(c)}"></span>
                                <span class="color-name">${escapeHtml(c.COLOR_NAME)}</span>
                            </div>
                        `).join('');

                        // Enable the picker
                        pickerSelected.classList.remove('disabled');

                        // Store colors for later (child rows, etc.)
                        row.dataset.colors = JSON.stringify(colors);
                    }

                    // Store product info
                    row.dataset.style = styleNumber;
                    row.dataset.productName = cleanTitle || styleNumber;

                } else {
                    descInput.value = 'Not found';
                    showToast(`Style ${styleNumber} not found`, 'error');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showToast('Error loading product', 'error');
            }
        }

        // Helper function to escape HTML for safe attribute values
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        /**
         * Extract clean product name from API title
         * API returns: "NF0A3LH4 - The North Face DryVent Rain Jacket. NF0A3LH4"
         * We want: "The North Face DryVent Rain Jacket"
         */
        function cleanProductTitle(title, styleNumber) {
            if (!title || !styleNumber) return title || '';

            // Escape special regex characters in style number
            const escapedStyle = styleNumber.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

            // Remove style number prefix pattern: "STYLE - " or "STYLE. "
            let cleaned = title.replace(new RegExp(`^${escapedStyle}\\s*[-.]\\s*`, 'i'), '');

            // Remove trailing style number: ". STYLE" or " STYLE" at end
            cleaned = cleaned.replace(new RegExp(`[.\\s]+${escapedStyle}\\s*$`, 'i'), '');

            return cleaned.trim() || title;
        }

        // Position abbreviation mapping for compact breakdown display
        const POSITION_ABBREV = {
            'Left Chest': 'LC', 'Right Chest': 'RC', 'Center Chest': 'CC',
            'Full Front': 'FF', 'Full Back': 'FB', 'Upper Back': 'UB',
            'Left Sleeve': 'LS', 'Right Sleeve': 'RS',
            'CF': 'CF', 'CB': 'CB', 'CL': 'CL', 'CR': 'CR',
            'Cap Front': 'CF', 'Cap Back': 'CB'
        };

        // Full names for tooltip display
        const POSITION_FULL_NAMES = {
            'LC': 'Left Chest', 'RC': 'Right Chest', 'CC': 'Center Chest',
            'FF': 'Full Front', 'FB': 'Full Back', 'UB': 'Upper Back',
            'LS': 'Left Sleeve', 'RS': 'Right Sleeve',
            'CF': 'Cap Front', 'CB': 'Cap Back', 'CL': 'Cap Left Side', 'CR': 'Cap Right Side'
        };

        /**
         * Format price - remove unnecessary decimals ($23.00 -> $23, $25.50 stays)
         */
        function formatPrice(price) {
            if (price % 1 === 0) return price.toFixed(0);
            return price.toFixed(2);
        }

        /**
         * Build pricing breakdown HTML for a product row
         * Shows compact format: â””â”€ LC 10K | Base $23 + Extra $2.50 = $25.50/ea
         * Includes hover tooltip with full calculation details
         *
         * @param {Object} product - Product data with isCap flag
         * @param {Object} lineItem - Line item from pricing calculator
         * @param {Object} logoConfig - Logo configuration (position, stitchCount)
         * @returns {string} HTML string for breakdown
         */
        function buildPricingBreakdown(product, lineItem, logoConfig) {
            if (!lineItem) return '';

            const isCap = product?.isCap || false;
            const logoPos = logoConfig?.position || (isCap ? 'CF' : 'Left Chest');
            const stitchCount = logoConfig?.stitchCount || 8000;
            const stitchK = Math.round(stitchCount / 1000);

            // Check if this is a cap with laser-patch embellishment
            const capEmbellishment = isCap ? getCapEmbellishmentType() : null;
            const isLaserPatch = isCap && capEmbellishment === 'laser-patch';

            // Get abbreviated position name
            const posAbbrev = POSITION_ABBREV[logoPos] || logoPos.substring(0, 2).toUpperCase();
            const posFullName = POSITION_FULL_NAMES[posAbbrev] || logoPos;

            const basePrice = lineItem.basePrice || 0;
            const extraStitchCost = lineItem.extraStitchCost || 0;
            const alCost = lineItem.alCost || 0;
            const unitPrice = lineItem.unitPrice || 0;

            // Calculate extra stitches for tooltip
            const baseStitches = isCap ? 8000 : 8000;
            const extraK = stitchCount > baseStitches ? Math.round((stitchCount - baseStitches) / 1000) : 0;
            const rate = isCap ? 1.00 : 1.25;

            // Build tooltip text with full formula (&#10; = newline in title attribute)
            let tooltipParts = [];
            if (isLaserPatch) {
                // Laser patch tooltip - no stitches
                tooltipParts = [`Type: Laser Leatherette Patch`, `Position: Cap Front`];
            } else {
                tooltipParts = [`Position: ${posFullName}`, `Stitches: ${stitchCount.toLocaleString()}`];
            }
            tooltipParts.push(`Base: $${basePrice.toFixed(2)}`);
            if (extraStitchCost > 0 && !isLaserPatch) {
                tooltipParts.push(`Extra: ${extraK}K Ã— $${rate.toFixed(2)} = $${extraStitchCost.toFixed(2)}`);
            }
            if (alCost > 0) {
                tooltipParts.push(`AL: $${alCost.toFixed(2)}`);
            }
            tooltipParts.push(`Unit: $${unitPrice.toFixed(2)}`);
            const tooltipText = tooltipParts.join('&#10;');

            // Build visible breakdown with compact format
            let html = `<span class="breakdown-wrapper" title="${tooltipText}">`;
            html += `<span class="breakdown-icon">â””â”€</span>`;
            // For laser patches, show "Laser Patch" instead of stitch count
            if (isLaserPatch) {
                html += `<span class="breakdown-pos">Laser Patch</span>`;
            } else {
                html += `<span class="breakdown-pos">${posAbbrev} ${stitchK}K</span>`;
            }

            // CHANGED 2026-01-14: Show BASE price only (extra stitches and AL are separate sidebar line items)
            // Show base price with optional upcharge note
            if (lineItem.hasUpcharge && lineItem.upcharge > 0) {
                // Extended size with upcharge - show breakdown
                html += ` <span class="breakdown-sep">|</span> `;
                html += `<span class="breakdown-base">Base $${formatPrice(basePrice - lineItem.upcharge)} + Upcharge $${formatPrice(lineItem.upcharge)}</span>`;
                html += ` <span class="breakdown-eq">=</span> `;
                html += `<span class="breakdown-total">$${formatPrice(basePrice)}/ea</span>`;
            } else {
                // Standard size - just show base price
                html += ` <span class="breakdown-sep">|</span> <span class="breakdown-total">$${formatPrice(basePrice)}/ea</span>`;
            }

            html += `</span>`;
            return html;
        }

        /**
         * Update the pricing breakdown display for a product row
         * @param {number} rowId - Row ID
         * @param {Object} product - Product data
         * @param {Object} lineItem - Line item from pricing calculator
         * @param {Object} logoConfig - Logo configuration
         */
        function updateRowBreakdown(rowId, product, lineItem, logoConfig) {
            const breakdownEl = document.getElementById(`breakdown-${rowId}`);
            if (!breakdownEl) return;

            const breakdownHtml = buildPricingBreakdown(product, lineItem, logoConfig);
            if (breakdownHtml) {
                breakdownEl.innerHTML = breakdownHtml;
                breakdownEl.classList.add('visible');
            } else {
                breakdownEl.innerHTML = '';
                breakdownEl.classList.remove('visible');
            }
        }

        /**
         * Check if a style number is a cap/hat product
         * @param {string} style - Style number
         * @param {string} productTitle - Product title/description
         * @param {string} categoryName - CATEGORY_NAME from SanMar API (most reliable)
         * @returns {boolean} True if cap/hat
         */
        function isCapProduct(style, productTitle = '', categoryName = '') {
            // BEST METHOD: Check CATEGORY_NAME from SanMar API
            // SanMar categorizes all caps/hats under "Caps" category
            if (categoryName && categoryName.toLowerCase() === 'caps') {
                console.log(`[isCapProduct] ${style} detected as cap via CATEGORY_NAME: "${categoryName}"`);
                return true;
            }

            // FALLBACK: Pattern matching for cases where category isn't available
            if (!style) return false;
            const styleUpper = style.toUpperCase();
            const titleUpper = (productTitle || '').toUpperCase();

            // Check style patterns:
            // CP* caps (CP80, CP90, etc)
            // NE* caps (NE1000, NE400)
            // C+digit (C112, C118)
            // Richardson styles (112, 110, 115, etc) - numeric only
            if (/^C[P0-9]/.test(styleUpper) || styleUpper.startsWith('NE')) {
                console.log(`[isCapProduct] ${style} detected as cap via style pattern`);
                return true;
            }

            // Richardson caps - 2-3 digit numeric styles (100-999)
            if (/^\d{2,3}$/.test(styleUpper)) {
                console.log(`[isCapProduct] ${style} detected as cap via Richardson numeric pattern`);
                return true;
            }

            // Check title keywords
            if (titleUpper.includes('CAP') || titleUpper.includes('HAT') ||
                titleUpper.includes('BEANIE') || titleUpper.includes('SNAPBACK') ||
                titleUpper.includes('TRUCKER') || titleUpper.includes('RICHARDSON')) {
                console.log(`[isCapProduct] ${style} detected as cap via title keyword`);
                return true;
            }

            return false;
        }

        /**
         * Check if product is pants (waist/inseam sizing not supported)
         * @param {string} style - Style number
         * @param {string} productTitle - Product title/description
         * @returns {boolean} True if pants
         */
        function isPantsProduct(style, productTitle = '') {
            if (!style) return false;
            const styleUpper = style.toUpperCase();
            const titleUpper = (productTitle || '').toUpperCase();

            // Red Kap work pants (PT prefix)
            if (styleUpper.startsWith('PT') && /^PT\d/.test(styleUpper)) return true;

            // Title keywords for pants
            if (titleUpper.includes('PANT') || titleUpper.includes('WORK PANT') ||
                titleUpper.includes('CARGO') || titleUpper.includes('TROUSER') ||
                titleUpper.includes('INDUSTRIAL PANT')) {
                return true;
            }

            return false;
        }

        /**
         * Analyze available sizes and determine the product's size category
         * Handles OSFA, combo sizes, youth, toddler, tall, and standard products
         * @param {string[]} availableSizes - Array of available sizes from API
         * @returns {Object} Category info with display configuration
         */
        function analyzeSizeCategory(availableSizes) {
            if (!availableSizes || availableSizes.length === 0) {
                return { category: 'unknown', columns: [], useQtyOnly: false };
            }

            const sizes = availableSizes.map(s => s.toUpperCase());
            const STANDARD = ['S', 'M', 'L', 'XL'];
            const COMBO = ['S/M', 'M/L', 'L/XL', 'XS/S', 'X/2X'];
            const YOUTH = ['YXS', 'YS', 'YM', 'YL', 'YXL'];
            const TODDLER = ['2T', '3T', '4T', '5T', '5/6T', '6T'];
            const TALL = ['LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT', 'ST', 'MT'];
            const ONE_SIZE = ['OSFA', 'OSFM'];
            const PANTS_PATTERN = /^\d{4}$/;  // 4-digit waist/inseam codes like 2737, 2830
            const WAIST_ONLY_PATTERN = /^W\d{2}$/;  // Waist-only codes like W30, W32 (PT66 shorts)

            // Count sizes in each category for dominant detection
            const youthCount = sizes.filter(s => YOUTH.includes(s)).length;
            const toddlerCount = sizes.filter(s => TODDLER.includes(s)).length;
            const tallCount = sizes.filter(s => TALL.includes(s)).length;
            const comboCount = sizes.filter(s => COMBO.includes(s)).length;
            const osfaCount = sizes.filter(s => ONE_SIZE.includes(s)).length;
            const standardCount = sizes.filter(s => STANDARD.includes(s)).length;
            const pantsCount = sizes.filter(s => PANTS_PATTERN.test(s)).length;
            const waistOnlyCount = sizes.filter(s => WAIST_ONLY_PATTERN.test(s)).length;

            // Priority 1a: Waist-only shorts (W30, W32, etc. - PT66, CT103542)
            if (waistOnlyCount > 0 && waistOnlyCount >= sizes.length / 2) {
                // Extract all valid waist-only sizes
                const waistSizes = sizes.filter(s => WAIST_ONLY_PATTERN.test(s));
                return {
                    category: 'shorts',
                    columns: [],
                    useQtyOnly: false,
                    shortsSizes: waistSizes,
                    baseSize: waistSizes[0],
                    message: 'Select waist sizes'
                };
            }

            // Priority 1b: Pants (waist/inseam sizes like 3032 for 30x32)
            if (pantsCount > 0 && pantsCount >= sizes.length / 2) {
                // Extract all valid pants sizes (4-digit codes)
                const pantsSizes = sizes.filter(s => PANTS_PATTERN.test(s));
                return {
                    category: 'pants',
                    columns: [],
                    useQtyOnly: false,
                    pantsSizes: pantsSizes,
                    baseSize: pantsSizes[0],
                    message: 'Select waist/inseam sizes'
                };
            }

            // Priority 2: OSFA-only (caps, bags, beanies)
            if (osfaCount > 0 && osfaCount === sizes.length) {
                return {
                    category: 'osfa-only',
                    columns: [],
                    useQtyOnly: true,
                    baseSize: sizes[0],
                    message: 'One Size Fits All'
                };
            }

            // Priority 3: Combo-only (fitted caps like NE1000)
            if (comboCount > 0 && comboCount === sizes.length) {
                return {
                    category: 'combo-only',
                    columns: sizes,
                    useQtyOnly: false,
                    baseSize: sizes[0]
                };
            }

            // Priority 4: Youth-dominant (has youth sizes AND more youth than standard)
            // PC61Y returns both S,M,L,XL AND YS,YM,YL,YXL - youth should win
            if (youthCount > 0 && youthCount >= standardCount) {
                return {
                    category: 'youth-only',
                    columns: YOUTH.filter(y => sizes.includes(y)),
                    useQtyOnly: false,
                    baseSize: sizes.find(s => YOUTH.includes(s)) || sizes[0]
                };
            }

            // Priority 5: Toddler-dominant
            if (toddlerCount > 0 && toddlerCount >= standardCount) {
                return {
                    category: 'toddler-only',
                    columns: TODDLER.filter(t => sizes.includes(t)),
                    useQtyOnly: false,
                    baseSize: sizes.find(s => TODDLER.includes(s)) || sizes[0]
                };
            }

            // Priority 6: Tall-dominant (LT, XLT without S, M, L, XL)
            if (tallCount > 0 && standardCount === 0) {
                return {
                    category: 'tall-only',
                    columns: sizes.filter(s => TALL.includes(s) || s === '2XL'),
                    useQtyOnly: false,
                    baseSize: sizes.find(s => TALL.includes(s)) || sizes[0]
                };
            }

            // Priority 7: Standard (has S, M, L, XL as dominant)
            if (standardCount > 0) {
                return {
                    category: 'standard',
                    columns: ['S', 'M', 'L', 'XL', '2XL'],
                    useQtyOnly: false,
                    baseSize: 'S',
                    extendedSizes: sizes.filter(s => !STANDARD.includes(s) && s !== '2XL')
                };
            }

            // Fallback for unknown patterns
            return {
                category: 'other',
                columns: sizes.slice(0, 5),
                useQtyOnly: false,
                baseSize: sizes[0]
            };
        }

        /**
         * Update row UI based on size category
         * Handles OSFA (single qty input), combo sizes, and other non-standard layouts
         * @param {HTMLElement} row - The product row element
         * @param {Object} sizeInfo - Result from analyzeSizeCategory()
         */
        function updateRowForSizeCategory(row, sizeInfo) {
            const rowId = row.dataset.rowId;
            const sizeInputs = row.querySelectorAll('.size-input:not(.xxxl-picker-btn)');
            const xxxlCell = row.querySelector('.xxxl-picker-btn');

            // Store category info for later use
            row.dataset.sizeCategory = sizeInfo.category;
            row.dataset.baseSize = sizeInfo.baseSize || '';

            // Handle PANTS (waist/inseam sizes) - use size picker popup
            if (sizeInfo.category === 'pants') {
                // Disable all size columns (parent row doesn't take quantities)
                sizeInputs.forEach(input => {
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = '-';
                    input.closest('td').classList.add('size-disabled');
                });

                // Enable XXXL cell as "Select Sizes" picker button
                if (xxxlCell && sizeInfo.pantsSizes && sizeInfo.pantsSizes.length > 0) {
                    row.dataset.pantsSizes = JSON.stringify(sizeInfo.pantsSizes);
                    row.dataset.extendedSizes = JSON.stringify(sizeInfo.pantsSizes); // For compatibility
                    xxxlCell.classList.add('pants-picker-btn');
                    xxxlCell.disabled = false;
                    xxxlCell.placeholder = '+';
                    xxxlCell.closest('td').classList.remove('size-disabled');
                } else if (xxxlCell) {
                    xxxlCell.disabled = true;
                    xxxlCell.placeholder = '-';
                    xxxlCell.closest('td').classList.add('size-disabled');
                }

                row.classList.add('pants-row');
                row.classList.add('non-standard-sizes');
                showToast('Pants product - click + to select waist/inseam sizes', 'info', 4000);
                return;
            }

            // Handle SHORTS (waist-only sizes like W30, W32) - use size picker popup
            if (sizeInfo.category === 'shorts') {
                // Disable all size columns (parent row doesn't take quantities)
                sizeInputs.forEach(input => {
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = '-';
                    input.closest('td').classList.add('size-disabled');
                });

                // Enable XXXL cell as "Select Sizes" picker button
                if (xxxlCell && sizeInfo.shortsSizes && sizeInfo.shortsSizes.length > 0) {
                    row.dataset.shortsSizes = JSON.stringify(sizeInfo.shortsSizes);
                    row.dataset.extendedSizes = JSON.stringify(sizeInfo.shortsSizes); // For compatibility
                    row.dataset.sizeCategory = 'shorts'; // Ensure category is set
                    xxxlCell.classList.add('shorts-picker-btn');
                    xxxlCell.disabled = false;
                    xxxlCell.placeholder = '+';
                    xxxlCell.closest('td').classList.remove('size-disabled');
                } else if (xxxlCell) {
                    xxxlCell.disabled = true;
                    xxxlCell.placeholder = '-';
                    xxxlCell.closest('td').classList.add('size-disabled');
                }

                row.classList.add('shorts-row');
                row.classList.add('non-standard-sizes');
                showToast('Shorts product - click + to select waist sizes', 'info', 4000);
                return;
            }

            if (sizeInfo.useQtyOnly) {
                // OSFA-only: Hide all size columns, convert to single qty input
                sizeInputs.forEach(input => {
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = '-';
                    input.closest('td').classList.add('size-disabled');
                });

                // Convert XXXL cell to qty input for OSFA
                if (xxxlCell) {
                    xxxlCell.classList.remove('xxxl-picker-btn');
                    xxxlCell.classList.add('osfa-qty-input');
                    xxxlCell.removeAttribute('readonly');
                    xxxlCell.type = 'number';
                    xxxlCell.min = '0';
                    xxxlCell.placeholder = 'Qty';
                    xxxlCell.value = '';
                    xxxlCell.disabled = false;
                    xxxlCell.onclick = null;
                    xxxlCell.onkeydown = null;
                    xxxlCell.onchange = () => onOSFAQtyChange(rowId);
                    xxxlCell.closest('td').classList.remove('size-disabled');
                }

                // Update header for this row (visual indicator)
                row.classList.add('osfa-only-row');

            } else if (sizeInfo.category === 'tall-only') {
                // TALL products: All sizes via extended size popup (like OSFA but with size picker)
                // Parent row has disabled columns; child rows handle each tall size
                const ALL_TALL = ['LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT'];
                const availableTallSizes = ALL_TALL.filter(s => sizeInfo.columns.includes(s));

                // Disable ALL size columns (parent row doesn't take quantities)
                sizeInputs.forEach((input, index) => {
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = '-';
                    input.closest('td').classList.add('size-disabled');
                });

                // Enable XXXL picker for ALL tall sizes
                if (availableTallSizes.length > 0 && xxxlCell) {
                    row.dataset.extendedSizes = JSON.stringify(availableTallSizes);
                    xxxlCell.disabled = false;
                    xxxlCell.placeholder = '+';
                    xxxlCell.closest('td').classList.remove('size-disabled');
                } else if (xxxlCell) {
                    xxxlCell.disabled = true;
                    xxxlCell.placeholder = '-';
                    xxxlCell.closest('td').classList.add('size-disabled');
                }

                row.classList.add('non-standard-sizes');
                row.classList.add('tall-only-row');

            } else if (sizeInfo.category !== 'standard' && sizeInfo.category !== 'unknown') {
                // Non-standard columns (combo, youth, toddler)
                const columns = sizeInfo.columns;

                sizeInputs.forEach((input, index) => {
                    if (index < columns.length) {
                        // Remap this column to new size
                        const newSize = columns[index];
                        input.dataset.size = newSize;
                        input.disabled = false;
                        input.placeholder = '0';
                        input.closest('td').classList.remove('size-disabled');

                        // Update column header visually
                        updateColumnLabel(row, index, newSize);
                    } else {
                        // Hide extra columns
                        input.disabled = true;
                        input.value = '';
                        input.placeholder = '-';
                        input.closest('td').classList.add('size-disabled');
                    }
                });

                // Handle XXXL picker based on extended sizes
                if (!sizeInfo.extendedSizes || sizeInfo.extendedSizes.length === 0) {
                    if (xxxlCell) {
                        xxxlCell.disabled = true;
                        xxxlCell.placeholder = '-';
                        xxxlCell.closest('td').classList.add('size-disabled');
                    }
                }

                // Add visual indicator class
                row.classList.add('non-standard-sizes');
            }
            // Standard category keeps default UI
        }

        /**
         * Update column label for a specific row's size input
         * Creates inline label overlay showing the actual size name
         */
        function updateColumnLabel(row, colIndex, newLabel) {
            const sizeInputs = row.querySelectorAll('.size-input:not(.xxxl-picker-btn)');
            const input = sizeInputs[colIndex];
            if (!input) return;

            const td = input.closest('td');

            // Add a label overlay showing the size
            let label = td.querySelector('.size-label-override');
            if (!label) {
                label = document.createElement('span');
                label.className = 'size-label-override';
                td.insertBefore(label, input);
            }
            label.textContent = newLabel;
        }

        /**
         * Handle quantity change for OSFA-only products
         * Updates dataset, qty display, and triggers pricing recalculation
         */
        function onOSFAQtyChange(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            const osfaInput = row.querySelector('.osfa-qty-input');
            const qty = parseInt(osfaInput?.value) || 0;

            // Store OSFA qty in dataset
            row.dataset.osfaQty = qty;
            row.dataset.isOsfaOnly = 'true';

            // Update qty display
            const qtyDisplay = document.getElementById(`row-qty-${rowId}`);
            if (qtyDisplay) qtyDisplay.textContent = qty;

            // Trigger pricing recalculation
            recalculatePricing();
        }

        /**
         * Fetch available sizes and adjust UI based on product type
         * Called after color selection to determine proper size columns
         */
        async function detectAndAdjustSizeUI(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            const styleNumber = row.dataset.style;
            const catalogColor = row.dataset.catalogColor;

            if (!styleNumber || !catalogColor) return;

            // =========================================
            // CAP SPECIAL HANDLING
            // Caps use /api/sizes-by-style-color endpoint
            // =========================================
            if (row.dataset.isCap === 'true') {
                try {
                    const capUrl = `${API_BASE}/api/sizes-by-style-color?styleNumber=${encodeURIComponent(styleNumber)}&color=${encodeURIComponent(catalogColor)}`;
                    console.log(`[Cap Sizes] Fetching sizes for ${styleNumber}: ${capUrl}`);
                    const capResponse = await fetch(capUrl);

                    let capSizes = ['OSFA']; // Default fallback
                    if (capResponse.ok) {
                        const capData = await capResponse.json();
                        const sizes = capData.data || capData.sizes || capData;
                        if (Array.isArray(sizes) && sizes.length > 0) {
                            capSizes = sizes;
                        }
                    } else {
                        console.warn(`[Cap Sizes] API failed for ${styleNumber}, using OSFA fallback`);
                    }

                    console.log(`[Cap Sizes] ${styleNumber} sizes:`, capSizes);

                    // Analyze cap sizes and update UI
                    const sizeInfo = analyzeSizeCategory(capSizes);
                    console.log(`ðŸ“ Cap size category for ${styleNumber}: ${sizeInfo.category}`, sizeInfo);

                    updateRowForSizeCategory(row, sizeInfo);
                    row.dataset.availableSizes = JSON.stringify(capSizes);
                    row.dataset.capSizes = JSON.stringify(capSizes);
                    return; // Exit - cap handling complete
                } catch (capError) {
                    console.error('[Cap Sizes] Error fetching cap sizes:', capError);
                    // Fall through to use OSFA
                    const osfaInfo = { category: 'osfa-only', columns: [], useQtyOnly: true, baseSize: 'OSFA', message: 'One Size Fits All' };
                    updateRowForSizeCategory(row, osfaInfo);
                    row.dataset.availableSizes = JSON.stringify(['OSFA']);
                    row.dataset.capSizes = JSON.stringify(['OSFA']);
                    return;
                }
            }

            // =========================================
            // STANDARD GARMENT HANDLING
            // =========================================
            try {
                // Fetch all available sizes for this style+color
                const url = `${API_BASE}/api/sanmar-shopworks/import-format?styleNumber=${encodeURIComponent(styleNumber)}&color=${encodeURIComponent(catalogColor)}`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.error(`[Size Detection] API failed for ${styleNumber}:`);
                    console.error(`  Status: ${response.status} ${response.statusText}`);
                    console.error(`  URL: ${url}`);
                    console.error(`  CatalogColor: ${catalogColor}`);

                    // Try fallback: fetch without color filter to at least get size info
                    try {
                        const altUrl = `${API_BASE}/api/sanmar-shopworks/import-format?styleNumber=${encodeURIComponent(styleNumber)}`;
                        console.log(`[Size Detection] Trying fallback without color: ${altUrl}`);
                        const altResponse = await fetch(altUrl);

                        if (altResponse.ok) {
                            const skus = await altResponse.json();
                            if (skus && skus.length > 0) {
                                console.log(`[Size Detection] Fallback succeeded with ${skus.length} SKUs`);
                                const allSizes = extractAllSizes(skus);
                                const sizeInfo = analyzeSizeCategory(allSizes);
                                console.log(`ðŸ“ Size category for ${styleNumber} (fallback): ${sizeInfo.category}`, sizeInfo);
                                updateRowForSizeCategory(row, sizeInfo);
                                row.dataset.availableSizes = JSON.stringify(allSizes);
                                return;
                            }
                        }
                    } catch (fallbackError) {
                        console.error('[Size Detection] Fallback also failed:', fallbackError);
                    }
                    return;
                }

                const skus = await response.json();

                // Extract ALL available sizes (not just Size06)
                const allSizes = extractAllSizes(skus);

                // Analyze and update UI
                const sizeInfo = analyzeSizeCategory(allSizes);
                console.log(`ðŸ“ Size category for ${styleNumber}: ${sizeInfo.category}`, sizeInfo);

                updateRowForSizeCategory(row, sizeInfo);

                // Store for pricing calculations
                row.dataset.availableSizes = JSON.stringify(allSizes);

                // Validate size availability using SKU service
                validateSizeAvailability(row, allSizes);

            } catch (error) {
                console.error('Error detecting size category:', error);
            }
        }

        /**
         * Validate size availability and update UI indicators
         * Uses SKUValidationService to check which sizes exist in ShopWorks
         *
         * @param {HTMLElement} row - Product row element
         * @param {string[]} availableSizes - Sizes available for this product/color
         */
        function validateSizeAvailability(row, availableSizes) {
            if (!row || !availableSizes) return;

            const styleNumber = row.dataset.style;
            const catalogColor = row.dataset.catalogColor;
            const skuService = window.skuValidationService || new SKUValidationService();
            window.skuValidationService = skuService; // Cache for reuse

            // Get all size inputs in this row
            const sizeInputs = row.querySelectorAll('.size-input:not(.xxxl-picker-btn)');
            const xxxlCell = row.querySelector('.xxxl-picker-btn');

            // Standard size columns (S, M, L, XL, XXL)
            const columnSizes = ['S', 'M', 'L', 'XL', '2XL'];

            sizeInputs.forEach((input, index) => {
                const size = columnSizes[index];
                if (!size) return;

                const isAvailable = availableSizes.includes(size);
                const sku = skuService.sanmarToShopWorksSKU(styleNumber, size);

                // Update input state based on availability
                if (isAvailable) {
                    input.classList.add('size-available');
                    input.classList.remove('size-unavailable');
                    input.disabled = false;
                    input.placeholder = '0';
                    input.title = `${size} (SKU: ${sku})`;
                } else {
                    input.classList.add('size-unavailable');
                    input.classList.remove('size-available');
                    input.disabled = true;
                    input.value = '';
                    input.placeholder = 'N/A';
                    input.title = `${size} not available for this style/color`;
                    input.closest('td')?.classList.add('size-disabled');
                }

                // Store SKU on input for reference
                input.dataset.sku = sku;
            });

            // Update extended size picker (XXXL column) if present
            if (xxxlCell && !xxxlCell.classList.contains('osfa-qty-input')) {
                const extendedSizes = availableSizes.filter(s =>
                    !columnSizes.includes(s) && s !== 'OSFA'
                );
                const hasExtended = extendedSizes.length > 0;

                if (hasExtended) {
                    xxxlCell.classList.remove('size-unavailable');
                    xxxlCell.disabled = false;
                    xxxlCell.title = `Extended sizes: ${extendedSizes.join(', ')}`;
                    row.dataset.extendedSizes = JSON.stringify(extendedSizes);
                } else {
                    xxxlCell.classList.add('size-unavailable');
                    xxxlCell.disabled = true;
                    xxxlCell.placeholder = '-';
                    xxxlCell.title = 'No extended sizes available';
                }
            }

            console.log(`[SKU Validation] ${styleNumber} validated:`, {
                availableSizes,
                catalogColor,
                validatedAt: new Date().toISOString()
            });
        }

        /**
         * Extract ALL sizes from SKU data (Size01-06 fields)
         * Returns sizes in logical display order
         */
        function extractAllSizes(skus) {
            const sizes = new Set();

            skus.forEach(sku => {
                ['Size01', 'Size02', 'Size03', 'Size04', 'Size05', 'Size06'].forEach(field => {
                    if (sku[field] && typeof sku[field] === 'string' && sku[field].trim()) {
                        sizes.add(sku[field].trim());
                    }
                });
            });

            // Return in logical order
            const ORDER = ['S', 'M', 'L', 'XL', '2XL', 'XS', 'S/M', 'M/L', 'L/XL',
                           'YXS', 'YS', 'YM', 'YL', 'YXL', '2T', '3T', '4T', '5T', '6T',
                           'LT', 'XLT', '2XLT', '3XLT', 'OSFA', 'OSFM'];
            return [...sizes].sort((a, b) => {
                const ai = ORDER.indexOf(a);
                const bi = ORDER.indexOf(b);
                if (ai === -1 && bi === -1) return a.localeCompare(b);
                if (ai === -1) return 1;
                if (bi === -1) return -1;
                return ai - bi;
            });
        }

        // Generate inline style for color swatch (image or fallback hex)
        function getSwatchStyle(color) {
            if (color.COLOR_SQUARE_IMAGE) {
                return `background-image: url('${color.COLOR_SQUARE_IMAGE}'); background-size: cover; background-position: center;`;
            }
            return `background-color: ${color.HEX_CODE || '#ccc'};`;
        }

        // ============================================================
        // COLOR PICKER FUNCTIONS
        // ============================================================

        /**
         * Toggle color picker dropdown open/closed
         */
        function toggleColorPicker(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const pickerSelected = row.querySelector('.color-picker-selected');
            const dropdown = row.querySelector('.color-picker-dropdown');

            // Don't open if disabled
            if (pickerSelected.classList.contains('disabled')) return;

            // Close all other open dropdowns first
            document.querySelectorAll('.color-picker-dropdown').forEach(d => {
                if (d !== dropdown) d.classList.add('hidden');
            });

            // Toggle this dropdown
            dropdown.classList.toggle('hidden');

            // Scroll selected option into view if open
            if (!dropdown.classList.contains('hidden')) {
                const selectedOption = dropdown.querySelector('.color-picker-option.selected');
                if (selectedOption) {
                    selectedOption.scrollIntoView({ block: 'nearest' });
                }
            }
        }

        /**
         * Detect if product is tall/youth/toddler-only and gray out unavailable size columns
         * This improves UX by showing users which sizes actually exist for the product
         */
        async function detectProductTypeAndAdjustUI(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            const style = row.dataset.style;
            const catalogColor = row.dataset.catalogColor;
            if (!style || !catalogColor) return;

            try {
                // Fetch available sizes from API
                const availableSizes = await getAvailableExtendedSizes(style, catalogColor);

                // Check for standard sizes (S, M, L, XL)
                const standardSizeLabels = ['S', 'M', 'L', 'XL'];
                const hasStandardSizes = standardSizeLabels.some(s => availableSizes.includes(s));

                // Detect tall/youth/toddler-only products
                const tallSizes = ['LT', 'XLT', '2XLT', '3XLT', '4XLT', '5XLT', '6XLT', 'ST', 'MT', 'XST'];
                const youthSizes = ['YXS', 'YS', 'YM', 'YL', 'YXL'];
                const toddlerSizes = ['2T', '3T', '4T', '5T', '5/6T', '6T'];

                const hasTallOnly = !hasStandardSizes && availableSizes.some(s => tallSizes.includes(s));
                const hasYouthOnly = !hasStandardSizes && availableSizes.some(s => youthSizes.includes(s));
                const hasToddlerOnly = !hasStandardSizes && availableSizes.some(s => toddlerSizes.includes(s));

                if (hasTallOnly || hasYouthOnly || hasToddlerOnly) {
                    // Gray out standard size columns - they don't exist for this product
                    standardSizeLabels.forEach(size => {
                        const input = row.querySelector(`input[data-size="${size}"]`);
                        if (input) {
                            input.disabled = true;
                            input.value = '';
                            input.placeholder = 'N/A';
                            input.style.backgroundColor = '#f0f0f0';
                            input.style.color = '#999';
                            input.title = 'Size not available for this product';
                        }
                    });

                    // Store product type for reference
                    row.dataset.productType = hasTallOnly ? 'tall-only' :
                                               hasYouthOnly ? 'youth-only' : 'toddler-only';

                    // Focus on the extended size picker instead
                    const xxxlInput = row.querySelector('input[data-size="3XL"]');
                    if (xxxlInput) xxxlInput.focus();
                }
            } catch (error) {
                console.warn('Could not detect product type for UI adjustment:', error);
            }
        }

        /**
         * Select a color from the dropdown
         */
        function selectColor(rowId, optionEl) {
            const row = document.getElementById(`row-${rowId}`);
            const colorName = optionEl.dataset.colorName;
            const catalogColor = optionEl.dataset.catalogColor;
            const swatchUrl = optionEl.dataset.swatchUrl;
            const hex = optionEl.dataset.hex;
            const style = row.dataset.style;

            // Check for duplicate row (same style + color)
            const existingRow = findExistingRow(style, catalogColor, rowId);
            if (existingRow) {
                showToast(`${style} in ${colorName} already exists. Adding to existing row.`, 'info');
                row.querySelector('.color-picker-dropdown').classList.add('hidden');
                const existingFirstSize = existingRow.querySelector('.size-input:not([disabled])');
                if (existingFirstSize) existingFirstSize.focus();
                return;
            }

            // Update selected display with swatch and full color name
            const pickerSelected = row.querySelector('.color-picker-selected');
            const swatch = pickerSelected.querySelector('.color-swatch');
            const nameSpan = pickerSelected.querySelector('.color-name');

            // Set swatch style (image or hex fallback)
            if (swatchUrl) {
                swatch.style.backgroundImage = `url('${swatchUrl}')`;
                swatch.style.backgroundColor = '';
                swatch.style.backgroundSize = 'cover';
                swatch.style.backgroundPosition = 'center';
            } else {
                swatch.style.backgroundImage = '';
                swatch.style.backgroundColor = hex || '#ccc';
            }
            swatch.classList.remove('empty');

            // Set full color name
            nameSpan.textContent = colorName;
            nameSpan.classList.remove('placeholder');

            // Mark selected option in dropdown
            row.querySelectorAll('.color-picker-option').forEach(opt => opt.classList.remove('selected'));
            optionEl.classList.add('selected');

            // Store data on row
            row.dataset.color = colorName;
            row.dataset.catalogColor = catalogColor;
            row.dataset.swatchUrl = swatchUrl || '';
            row.dataset.hex = hex || '';

            // Close dropdown
            row.querySelector('.color-picker-dropdown').classList.add('hidden');

            // Enable size inputs initially (may be disabled by detectAndAdjustSizeUI for special products)
            row.querySelectorAll('.size-input').forEach(input => input.disabled = false);

            // Detect size category and adjust UI (OSFA, combo, youth, toddler, tall, standard)
            // This runs async but doesn't block - will update UI when API returns
            detectAndAdjustSizeUI(rowId);

            // Focus first size input (may be overridden by detectAndAdjustSizeUI for special products)
            const firstSize = row.querySelector('.size-input');
            if (firstSize) firstSize.focus();

            // Cascade to child rows if any
            cascadeColorToChildRows(rowId, colorName, catalogColor, swatchUrl, hex);

            recalculatePricing();
        }

        /**
         * Cascade color selection to child rows (for extended sizes)
         */
        function cascadeColorToChildRows(parentRowId, colorName, catalogColor, swatchUrl, hex) {
            if (!childRowMap[parentRowId]) return;

            Object.values(childRowMap[parentRowId]).forEach(childRowId => {
                const childRow = document.getElementById(`row-${childRowId}`);
                if (childRow && childRow.dataset.colorManuallySet !== 'true') {
                    childRow.dataset.color = colorName;
                    childRow.dataset.catalogColor = catalogColor;

                    // Update child row's color picker display if it has one
                    const childPicker = childRow.querySelector('.color-picker-selected');
                    if (childPicker) {
                        const childSwatch = childPicker.querySelector('.color-swatch');
                        const childName = childPicker.querySelector('.color-name');
                        if (childSwatch && childName) {
                            if (swatchUrl) {
                                childSwatch.style.backgroundImage = `url('${swatchUrl}')`;
                                childSwatch.style.backgroundColor = '';
                            } else {
                                childSwatch.style.backgroundImage = '';
                                childSwatch.style.backgroundColor = hex || '#ccc';
                            }
                            childSwatch.classList.remove('empty');
                            childName.textContent = colorName;
                            childName.classList.remove('placeholder');
                        }
                    }
                }
            });
            updateChildRowColorIndicators(parentRowId);
        }

        /**
         * Handle keyboard navigation in color picker
         */
        function handleColorPickerKeydown(event, rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const dropdown = row.querySelector('.color-picker-dropdown');
            const isOpen = !dropdown.classList.contains('hidden');

            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleColorPicker(rowId);
            } else if (event.key === 'Escape' && isOpen) {
                event.preventDefault();
                dropdown.classList.add('hidden');
            } else if (event.key === 'ArrowDown' && isOpen) {
                event.preventDefault();
                navigateOptions(dropdown, 1);
            } else if (event.key === 'ArrowUp' && isOpen) {
                event.preventDefault();
                navigateOptions(dropdown, -1);
            } else if (event.key === 'Tab') {
                // Close dropdown on tab
                dropdown.classList.add('hidden');
            }
        }

        /**
         * Navigate through dropdown options with arrow keys
         */
        function navigateOptions(dropdown, direction) {
            const options = dropdown.querySelectorAll('.color-picker-option');
            if (options.length === 0) return;

            let currentIndex = -1;
            options.forEach((opt, i) => {
                if (opt.classList.contains('focused')) currentIndex = i;
            });

            // Remove current focus
            options.forEach(opt => opt.classList.remove('focused'));

            // Calculate new index
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = options.length - 1;
            if (newIndex >= options.length) newIndex = 0;

            // Add focus to new option
            options[newIndex].classList.add('focused');
            options[newIndex].scrollIntoView({ block: 'nearest' });
        }

        // Click outside handler to close all dropdowns
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.color-picker-wrapper')) {
                document.querySelectorAll('.color-picker-dropdown').forEach(d => d.classList.add('hidden'));
            }
        });

        /**
         * Select a color for a child row (extended size)
         * Similar to selectColor but marks color as manually set
         */
        function selectChildColor(childRowId, parentRowId, optionEl) {
            const childRow = document.getElementById(`row-${childRowId}`);
            const colorName = optionEl.dataset.colorName;
            const catalogColor = optionEl.dataset.catalogColor;
            const swatchUrl = optionEl.dataset.swatchUrl;
            const hex = optionEl.dataset.hex;

            // Update selected display with swatch and full color name
            const pickerSelected = childRow.querySelector('.color-picker-selected');
            const swatch = pickerSelected.querySelector('.color-swatch');
            const nameSpan = pickerSelected.querySelector('.color-name');

            // Set swatch style (image or hex fallback)
            if (swatchUrl) {
                swatch.style.backgroundImage = `url('${swatchUrl}')`;
                swatch.style.backgroundColor = '';
                swatch.style.backgroundSize = 'cover';
                swatch.style.backgroundPosition = 'center';
            } else {
                swatch.style.backgroundImage = '';
                swatch.style.backgroundColor = hex || '#ccc';
            }
            swatch.classList.remove('empty');

            // Set full color name
            nameSpan.textContent = colorName;
            nameSpan.classList.remove('placeholder');

            // Mark selected option in dropdown
            childRow.querySelectorAll('.color-picker-option').forEach(opt => opt.classList.remove('selected'));
            optionEl.classList.add('selected');

            // Store data on row
            childRow.dataset.color = colorName;
            childRow.dataset.catalogColor = catalogColor;
            childRow.dataset.swatchUrl = swatchUrl || '';
            childRow.dataset.hex = hex || '';
            childRow.dataset.colorManuallySet = 'true';  // Mark as manually changed

            // Close dropdown
            childRow.querySelector('.color-picker-dropdown').classList.add('hidden');

            // Update visual indicator for different color
            updateChildRowColorIndicators(parentRowId);

            recalculatePricing();
        }

        async function onColorChange(select, rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const color = select.value;

            if (!color) return;

            const selectedOption = select.options[select.selectedIndex];
            const catalogColor = selectedOption.dataset.catalog || '';
            const style = row.dataset.style;

            // Check for duplicate row (same style + color)
            const existingRow = findExistingRow(style, catalogColor, rowId);
            if (existingRow) {
                // Show toast and focus on existing row
                showToast(`${style} in ${color} already exists. Adding to existing row.`, 'info');

                // Clear this row's color selection
                select.value = '';

                // Focus on the existing row's first size input
                const existingFirstSize = existingRow.querySelector('.size-input:not([disabled])');
                if (existingFirstSize) existingFirstSize.focus();
                return;
            }

            row.dataset.color = color;
            row.dataset.catalogColor = catalogColor;

            // Enable size inputs
            row.querySelectorAll('.size-input').forEach(input => {
                input.disabled = false;
            });

            // Cascade color change to child rows that haven't been manually edited
            if (childRowMap[rowId]) {
                Object.entries(childRowMap[rowId]).forEach(([size, childRowId]) => {
                    const childRow = document.getElementById(`row-${childRowId}`);
                    if (childRow && childRow.dataset.colorManuallySet !== 'true') {
                        // Update child row color
                        childRow.dataset.color = color;
                        childRow.dataset.catalogColor = catalogColor;

                        // Update child row's color dropdown selection
                        const childColorSelect = childRow.querySelector('.child-color-select');
                        if (childColorSelect) {
                            childColorSelect.value = color;
                        }

                        console.log(`Cascaded color change to child row ${childRowId}: ${color}`);
                    }
                });
                updateChildRowColorIndicators(rowId);
            }

            // Focus first size input
            const firstSize = row.querySelector('.size-input');
            if (firstSize) firstSize.focus();
        }

        /**
         * Handle color change in a child row
         * Updates child row's color and marks it as manually set
         */
        function onChildColorChange(select, childRowId, parentRowId) {
            const childRow = document.getElementById(`row-${childRowId}`);
            if (!childRow) return;

            const color = select.value;
            const selectedOption = select.options[select.selectedIndex];
            const catalogColor = selectedOption.dataset.catalog || '';

            // Update child row data attributes
            childRow.dataset.color = color;
            childRow.dataset.catalogColor = catalogColor;
            childRow.dataset.colorManuallySet = 'true';  // Mark as manually edited

            // Update visual indicator
            updateChildRowColorIndicators(parentRowId);

            console.log(`Child row ${childRowId} color changed to ${color} (catalog: ${catalogColor})`);

            // Recalculate pricing
            recalculatePricing();
        }

        /**
         * Update visual styling for child rows based on color match with parent
         */
        function updateChildRowColorIndicators(parentRowId) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow) return;

            const parentCatalogColor = parentRow.dataset.catalogColor;

            if (childRowMap[parentRowId]) {
                Object.values(childRowMap[parentRowId]).forEach(childRowId => {
                    const childRow = document.getElementById(`row-${childRowId}`);
                    if (childRow) {
                        if (childRow.dataset.catalogColor !== parentCatalogColor) {
                            childRow.classList.add('different-color');
                        } else {
                            childRow.classList.remove('different-color');
                        }
                    }
                });
            }
        }

        /**
         * Find an existing row with the same style and catalogColor (excluding current row)
         */
        function findExistingRow(style, catalogColor, excludeRowId) {
            const rows = document.querySelectorAll('#product-tbody tr:not(.child-row)');
            for (const row of rows) {
                const rowNumericId = parseInt(row.id.replace('row-', ''));
                if (rowNumericId === excludeRowId) continue;
                if (row.dataset.style === style && row.dataset.catalogColor === catalogColor) {
                    return row;
                }
            }
            return null;
        }

        function onSizeChange(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            // Mark as having unsaved changes
            markAsUnsaved();

            // Skip if this is a child row (child rows don't trigger size changes)
            if (row.classList.contains('child-row')) {
                recalculatePricing();
                return;
            }

            const sizeCategory = row.dataset.sizeCategory;

            // OSFA-only products are handled separately by onOSFAQtyChange()
            if (sizeCategory === 'osfa-only') {
                recalculatePricing();
                return;
            }

            // IMPORTANT: Handle 2XL child row FIRST (before quantity calculation)
            // This ensures the 2XL input is disabled before we sum enabled inputs,
            // preventing the 2XL value from being counted twice (in parent AND child)
            // Bug fix: 2026-01-14 - Parent row showed 16 instead of 14 for S/M/L/XL
            const xxlInput = row.querySelector('[data-size="2XL"]');
            if (xxlInput) {
                const qty = parseInt(xxlInput.value) || 0;
                const existingChildId = childRowMap[rowId]?.['2XL'];

                if (qty > 0) {
                    // Need a child row for 2XL
                    if (existingChildId) {
                        updateChildRow(existingChildId, qty);
                    } else {
                        createChildRow(rowId, '2XL', qty);
                    }
                    // Disable the 2XL input in parent BEFORE quantity calculation
                    xxlInput.disabled = true;
                    xxlInput.value = '';  // Clear to prevent visual confusion
                    xxlInput.style.background = '#f5f5f5';
                    xxlInput.style.color = '#999';
                } else {
                    // Remove child row if it exists
                    if (existingChildId) {
                        removeChildRow(rowId, '2XL');
                    }
                    // Re-enable 2XL input in parent
                    xxlInput.disabled = false;
                    xxlInput.style.background = '';
                    xxlInput.style.color = '';
                }
            }

            // Calculate total from enabled size inputs in parent row ONLY
            // 2XL is disabled when it has a value (child row created), so it's excluded
            // Child rows display their own quantities separately
            // Bug fix 2026-01-14: Parent row was incorrectly adding child quantities
            let total = 0;
            row.querySelectorAll('.size-input:not(.xxxl-picker-btn):not(.osfa-qty-input):not(:disabled)').forEach(input => {
                total += parseInt(input.value) || 0;
            });

            // DO NOT add child row quantities - each row displays its own quantity
            // The sidebar/pricing calculator handles the true total separately

            // Update parent row quantity display (parent sizes only)
            document.getElementById(`row-qty-${rowId}`).textContent = total;

            // Recalculate pricing
            recalculatePricing();
        }

        /**
         * Generate ShopWorks-compatible part number
         * Uses SIZE_TO_SUFFIX which contains ALL size suffixes (tall, youth, toddler, etc.)
         */
        function getPartNumber(baseStyle, size) {
            // For pants sizes (4-digit codes like 3032), append directly with underscore
            if (/^\d{4}$/.test(size)) {
                return `${baseStyle}_${size}`;
            }
            return baseStyle + (SIZE_TO_SUFFIX[size] || '');
        }

        /**
         * Create a child row for an extended size
         */
        function createChildRow(parentRowId, size, qty) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow) return;

            const childRowId = ++rowCounter;
            const baseStyle = parentRow.dataset.style;
            const partNumber = getPartNumber(baseStyle, size);

            // Get parent's available colors for the dropdown
            const parentColors = parentRow.dataset.colors ? JSON.parse(parentRow.dataset.colors) : [];
            const parentColor = parentRow.dataset.color || '';
            const parentCatalogColor = parentRow.dataset.catalogColor || '';
            const parentSwatchUrl = parentRow.dataset.swatchUrl || '';
            const parentHex = parentRow.dataset.hex || '#ccc';

            // Build color picker options HTML with swatches
            const colorOptionsHtml = parentColors.map(c =>
                `<div class="color-picker-option ${c.COLOR_NAME === parentColor ? 'selected' : ''}"
                     data-color-name="${escapeHtml(c.COLOR_NAME)}"
                     data-catalog-color="${escapeHtml(c.CATALOG_COLOR || c.COLOR_NAME)}"
                     data-swatch-url="${escapeHtml(c.COLOR_SQUARE_IMAGE || '')}"
                     data-hex="${escapeHtml(c.HEX_CODE || '#ccc')}"
                     onclick="selectChildColor(${childRowId}, ${parentRowId}, this)">
                    <span class="color-swatch" style="${getSwatchStyle(c)}"></span>
                    <span class="color-name">${escapeHtml(c.COLOR_NAME)}</span>
                </div>`
            ).join('');

            // Build current color display
            const currentSwatchStyle = parentSwatchUrl
                ? `background-image: url('${parentSwatchUrl}'); background-size: cover; background-position: center;`
                : `background-color: ${parentHex};`;

            const childRow = document.createElement('tr');
            childRow.id = `row-${childRowId}`;
            childRow.className = 'child-row';
            childRow.dataset.rowId = childRowId;
            childRow.dataset.parentRowId = parentRowId;
            childRow.dataset.extendedSize = size;
            childRow.dataset.style = partNumber;
            childRow.dataset.baseStyle = baseStyle;
            childRow.dataset.color = parentRow.dataset.color;
            childRow.dataset.catalogColor = parentRow.dataset.catalogColor;
            childRow.dataset.swatchUrl = parentSwatchUrl;
            childRow.dataset.hex = parentHex;
            childRow.dataset.productName = parentRow.dataset.productName;
            childRow.dataset.colorManuallySet = 'false';  // Track if user manually changed color

            // Determine which column this size goes to:
            // - Size05 (XXL column): only 2XL
            // - Size06 (XXXL column): XS, 3XL, 4XL, 5XL, 6XL, pants sizes, shorts sizes
            const isSize05 = size === '2XL';
            const isPantsSize = /^\d{4}$/.test(size);  // 4-digit pants sizes like 3032
            const isShortsSize = /^W\d{2}$/.test(size);  // Waist-only shorts sizes like W30
            const isSize06 = SIZE06_EXTENDED_SIZES.includes(size) || isPantsSize || isShortsSize;

            // Format display size (pants: "3032" -> "30x32", shorts: "W30" -> "Waist 30", others: keep as-is)
            let displaySize = size;
            if (isPantsSize) {
                const waist = size.substring(0, 2);
                const inseam = size.substring(2, 4);
                displaySize = `${waist}x${inseam}`;
            } else if (isShortsSize) {
                const waist = size.replace('W', '');
                displaySize = `Waist ${waist}`;
            }

            // Create cell content - only the specific size column is editable
            childRow.innerHTML = `
                <td>
                    <span class="child-indicator">â””</span>
                    <span class="style-display">${partNumber}</span>
                </td>
                <td>
                    <span class="desc-display" style="color: #666; font-size: 12px;">${escapeHtml(parentRow.dataset.productName)} - <strong>${displaySize}</strong></span>
                </td>
                <td>
                    <div class="color-picker-wrapper child-color-picker" data-row-id="${childRowId}">
                        <div class="color-picker-selected" onclick="toggleColorPicker(${childRowId})" tabindex="0" onkeydown="handleColorPickerKeydown(event, ${childRowId})">
                            <span class="color-swatch" style="${currentSwatchStyle}"></span>
                            <span class="color-name">${escapeHtml(parentColor)}</span>
                            <i class="fas fa-chevron-down picker-arrow"></i>
                        </div>
                        <div class="color-picker-dropdown hidden" id="color-dropdown-${childRowId}">
                            ${colorOptionsHtml}
                        </div>
                    </div>
                </td>
                <td><input type="number" class="cell-input size-input" data-size="S" disabled value="" style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" data-size="M" disabled value="" style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" data-size="L" disabled value="" style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" data-size="XL" disabled value="" style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" data-size="2XL" ${isSize05 ? '' : 'disabled'} value="${isSize05 ? qty : ''}" placeholder="${isSize05 ? qty : ''}" style="${isSize05 ? '' : 'background: #f5f5f5;'}" onchange="onChildSizeChange(${childRowId}, ${parentRowId}, '${size}')" onkeydown="handleCellKeydown(event, this)"></td>
                <td><input type="number" class="cell-input size-input" data-size="${size}" ${isSize06 ? '' : 'disabled'} value="${isSize06 ? qty : ''}" placeholder="${isSize06 ? qty : ''}" style="${isSize06 ? '' : 'background: #f5f5f5;'}" onchange="onChildSizeChange(${childRowId}, ${parentRowId}, '${size}')" onkeydown="handleCellKeydown(event, this)"></td>
                <td class="cell-qty qty-display" id="row-qty-${childRowId}">${qty}</td>
                <td class="cell-price unit-price-display" id="row-price-${childRowId}">-</td>
                <td class="cell-total" id="row-total-${childRowId}">-</td>
                <td class="cell-actions">
                    <button class="btn-delete-row" onclick="clearExtendedSize(${parentRowId}, '${size}')" title="Remove ${displaySize}">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            // Insert in correct size order: XS, 2XL, 3XL, 4XL, 5XL, 6XL
            const existingChildren = Array.from(document.querySelectorAll(`tr[data-parent-row-id="${parentRowId}"]`));

            if (existingChildren.length === 0) {
                // No children yet, insert after parent
                parentRow.after(childRow);
            } else {
                // Find correct position based on size order (XS first, then 2XL, 3XL, etc.)
                const newSizeIndex = EXTENDED_SIZE_ORDER.indexOf(size);
                let insertAfter = parentRow;  // Default: after parent (for XS or first size)

                for (const existingChild of existingChildren) {
                    const existingSize = existingChild.dataset.extendedSize;
                    const existingSizeIndex = EXTENDED_SIZE_ORDER.indexOf(existingSize);

                    // If existing size comes before new size in order, insert after this child
                    if (existingSizeIndex < newSizeIndex) {
                        insertAfter = existingChild;
                    } else {
                        // Found a size that should come after us, stop here
                        break;
                    }
                }

                insertAfter.after(childRow);
            }

            // Track child row
            if (!childRowMap[parentRowId]) {
                childRowMap[parentRowId] = {};
            }
            childRowMap[parentRowId][size] = childRowId;

            console.log(`Created child row ${childRowId} for ${baseStyle} ${size}`);
        }

        /**
         * Update an existing child row quantity
         */
        function updateChildRow(childRowId, qty) {
            const childRow = document.getElementById(`row-${childRowId}`);
            if (!childRow) return;

            const size = childRow.dataset.extendedSize;
            const sizeInput = childRow.querySelector(`[data-size="${size}"]`);
            if (sizeInput) {
                sizeInput.value = qty;
            }
            document.getElementById(`row-qty-${childRowId}`).textContent = qty;
        }

        /**
         * Remove a child row
         */
        function removeChildRow(parentRowId, size) {
            const childRowId = childRowMap[parentRowId]?.[size];
            if (childRowId) {
                const childRow = document.getElementById(`row-${childRowId}`);
                if (childRow) {
                    childRow.remove();
                }
                delete childRowMap[parentRowId][size];
            }
        }

        /**
         * Handle size change in child row - sync back to parent
         */
        function onChildSizeChange(childRowId, parentRowId, size) {
            const childRow = document.getElementById(`row-${childRowId}`);
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!childRow || !parentRow) return;

            const sizeInput = childRow.querySelector(`[data-size="${size}"]`);
            const qty = parseInt(sizeInput?.value) || 0;

            // Update child row quantity display
            document.getElementById(`row-qty-${childRowId}`).textContent = qty;

            // Sync back to parent row's hidden input
            const parentInput = parentRow.querySelector(`[data-size="${size}"]`);
            if (parentInput) {
                parentInput.value = qty;
            }

            // If qty is 0, remove the child row
            if (qty === 0) {
                clearExtendedSize(parentRowId, size);
            }

            recalculatePricing();
        }

        /**
         * Clear an extended size (remove child row, enable parent input)
         */
        function clearExtendedSize(parentRowId, size) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow) return;

            // Clear parent input
            const parentInput = parentRow.querySelector(`[data-size="${size}"]`);
            if (parentInput) {
                parentInput.value = '';
                parentInput.disabled = false;
                parentInput.style.background = '';
                parentInput.style.color = '';
            }

            // Remove child row
            removeChildRow(parentRowId, size);

            recalculatePricing();
        }

        /**
         * Reorder a product row based on type: garments first, caps below
         * Called after cap detection to maintain visual organization
         */
        function reorderRowByProductType(row) {
            if (!row) return;

            const tbody = document.getElementById('product-tbody');
            if (!tbody) return;

            const isCap = row.dataset.isCap === 'true';

            if (isCap) {
                // Cap rows go at the end (after all other rows)
                tbody.appendChild(row);
            } else {
                // Garment rows go before any cap rows
                const firstCapRow = tbody.querySelector('tr[data-is-cap="true"]:not(.child-row)');
                if (firstCapRow) {
                    tbody.insertBefore(row, firstCapRow);
                }
                // If no cap rows yet, row stays where it is (already at end)
            }
        }

        function deleteRow(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            // If this is a parent row, also remove all child rows
            if (!row.classList.contains('child-row') && childRowMap[rowId]) {
                Object.keys(childRowMap[rowId]).forEach(size => {
                    const childRowId = childRowMap[rowId][size];
                    const childRow = document.getElementById(`row-${childRowId}`);
                    if (childRow) {
                        childRow.remove();
                    }
                });
                delete childRowMap[rowId];
            }


            row.remove();
            recalculatePricing();

            // Update logo section visibility (hide if no products of that type remain)
            updateCapLogoSectionVisibility();
            updateGarmentLogoSectionVisibility();
        }

        // ============================================================
        // KEYBOARD NAVIGATION (Excel-style)
        // ============================================================

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Escape = Close popups
                if (e.key === 'Escape') {
                    const sizePopup = document.getElementById('extended-size-popup');
                    if (sizePopup && !sizePopup.classList.contains('hidden')) {
                        e.preventDefault();
                        closeExtendedSizePopup();
                        return;
                    }
                }

                // Ctrl+S = Save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveQuote();
                }

                // Ctrl+P = Print
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    printQuote();
                }
            });
        }

        function handleCellKeydown(event, input) {
            const row = input.closest('tr');
            const cells = Array.from(row.querySelectorAll('input:not([readonly]), select:not(:disabled)'));
            const currentIndex = cells.indexOf(input);

            if (event.key === 'Tab' && !event.shiftKey) {
                // Tab to next cell
                if (currentIndex === cells.length - 1) {
                    // Last cell in row - add new row
                    event.preventDefault();
                    addNewRow();
                }
            } else if (event.key === 'Enter') {
                // Enter = next row
                event.preventDefault();

                const tbody = document.getElementById('product-tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const currentRowIndex = rows.indexOf(row);

                if (currentRowIndex === rows.length - 1) {
                    // Last row - add new
                    addNewRow();
                } else {
                    // Focus same column in next row
                    const nextRow = rows[currentRowIndex + 1];
                    const nextCells = Array.from(nextRow.querySelectorAll('input:not([readonly]), select:not(:disabled)'));
                    if (nextCells[currentIndex]) {
                        nextCells[currentIndex].focus();
                    } else if (nextCells[0]) {
                        nextCells[0].focus();
                    }
                }
            } else if (event.key === 'ArrowDown') {
                // Arrow down
                event.preventDefault();
                const tbody = document.getElementById('product-tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const currentRowIndex = rows.indexOf(row);

                if (currentRowIndex < rows.length - 1) {
                    const nextRow = rows[currentRowIndex + 1];
                    const field = input.dataset.field || input.dataset.size;
                    const nextInput = nextRow.querySelector(`[data-field="${field}"], [data-size="${field}"]`);
                    if (nextInput && !nextInput.disabled) {
                        nextInput.focus();
                    }
                }
            } else if (event.key === 'ArrowUp') {
                // Arrow up
                event.preventDefault();
                const tbody = document.getElementById('product-tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const currentRowIndex = rows.indexOf(row);

                if (currentRowIndex > 0) {
                    const prevRow = rows[currentRowIndex - 1];
                    const field = input.dataset.field || input.dataset.size;
                    const prevInput = prevRow.querySelector(`[data-field="${field}"], [data-size="${field}"]`);
                    if (prevInput && !prevInput.disabled) {
                        prevInput.focus();
                    }
                }
            }
        }

        // ============================================================
        // PRICING CALCULATIONS
        // ============================================================

        async function recalculatePricing() {
            // Collect products from table (parent rows only)
            const productList = collectProductsFromTable();

            if (productList.length === 0) {
                // Even with no quantities, show setup fee if laser-patch cap is being configured
                const capEmbType = getCapEmbellishmentType();
                const capHasStyle = document.querySelector('tr[data-style]:not(.child-row) .cap-badge') !== null;
                const showPatchSetup = capEmbType === 'laser-patch' && capHasStyle && capPrimaryLogo.needsSetup;
                const patchSetupFee = showPatchSetup ? 50 : 0;

                updatePricingDisplay({
                    totalQuantity: 0,
                    tier: '1-23',
                    subtotal: 0,
                    ltmFee: 0,
                    setupFees: patchSetupFee,
                    capSetupFees: patchSetupFee,
                    garmentSetupFees: 0,
                    hasCaps: capHasStyle,
                    hasGarments: false,
                    grandTotal: patchSetupFee
                });
                // Clear all price cells
                document.querySelectorAll('.cell-price').forEach(cell => {
                    cell.textContent = '-';
                });
                return;
            }

            // Calculate using the existing pricing calculator
            // Build separate logo configs for garments and caps
            const logoConfigs = {
                garment: {
                    primary: { ...primaryLogo, id: 'primary' },
                    additional: additionalLogos
                },
                cap: {
                    primary: { ...capPrimaryLogo, id: 'cap-primary' },
                    additional: capAdditionalLogos
                }
            };

            // For backward compatibility, also create combined array (garment logos only for non-cap products)
            const allLogos = [
                { ...primaryLogo, id: 'primary' },
                ...additionalLogos
            ];

            try {
                const pricing = await pricingCalculator.calculateQuote(productList, allLogos, logoConfigs);

                if (pricing) {
                    // Update row prices - match line items to rows by style AND color
                    // With different colors per extended size, we now get separate products for each color
                    pricing.products.forEach((pp) => {
                        const style = pp.product.style;
                        const productCatalogColor = pp.product.catalogColor;
                        // Match by BOTH style AND catalogColor to handle duplicate styles with different colors
                        const parentRow = document.querySelector(`tr[data-style="${style}"][data-catalog-color="${productCatalogColor}"]:not(.child-row)`);

                        if (!parentRow) return;

                        const rowId = parentRow.dataset.rowId;
                        const isParentColor = productCatalogColor === parentRow.dataset.catalogColor;

                        if (pp.lineItems.length > 0) {
                            // For products matching the parent's color, update parent row price
                            if (isParentColor) {
                                // Find standard sizes line item (no upcharge)
                                const standardLineItem = pp.lineItems.find(li => !li.hasUpcharge);
                                if (standardLineItem) {
                                    const priceCell = document.getElementById(`row-price-${rowId}`);
                                    const totalCell = document.getElementById(`row-total-${rowId}`);
                                    if (priceCell) {
                                        // Display base unit price (LTM shown as separate line item)
                                        const displayPrice = standardLineItem.unitPrice;
                                        priceCell.textContent = `$${displayPrice.toFixed(2)}`;

                                        // Calculate and display line total
                                        if (totalCell) {
                                            const qty = standardLineItem.quantity || 0;
                                            const lineTotal = displayPrice * qty;
                                            totalCell.textContent = qty > 0 ? `$${lineTotal.toFixed(2)}` : '-';
                                        }
                                    }

                                    // Update pricing breakdown in description cell
                                    const logoConfig = pp.isCap ? logoConfigs.cap.primary : logoConfigs.garment.primary;

                                    // Find AL cost for this row from additionalServices
                                    const rowAL = pricing.additionalServices?.find(al => al.rowId == rowId);
                                    const lineItemWithAL = {
                                        ...standardLineItem,
                                        alCost: rowAL ? rowAL.unitPrice : 0
                                    };
                                    updateRowBreakdown(rowId, pp.product, lineItemWithAL, logoConfig);
                                }
                            }

                            // Update child row prices - match by BOTH size AND color
                            // A child row price only updates if its color matches this product's color
                            pp.lineItems.forEach(li => {
                                const description = li.description;
                                // Match ALL extended sizes in description (handles grouped sizes like "3XL(2) 4XL(3)" or "3T(5)")
                                // Uses SIZE06_EXTENDED_SIZES for comprehensive matching including toddler, youth, tall, pants (4-digit), etc.
                                const extendedSizeRegex = new RegExp(
                                    '(' + SIZE06_EXTENDED_SIZES.map(s => s.replace(/\//g, '\\/')).concat(['2XL', '\\d{4}']).join('|') + ')(?=\\(|\\s|$)',
                                    'g'
                                );
                                const sizeMatches = description.match(extendedSizeRegex);
                                if (sizeMatches) {
                                    sizeMatches.forEach(size => {
                                        const childRowId = childRowMap[rowId]?.[size];
                                        if (childRowId) {
                                            const childRow = document.getElementById(`row-${childRowId}`);
                                            // Only update price if child row's color matches this product's color
                                            if (childRow && childRow.dataset.catalogColor === productCatalogColor) {
                                                const childPriceCell = document.getElementById(`row-price-${childRowId}`);
                                                const childTotalCell = document.getElementById(`row-total-${childRowId}`);
                                                if (childPriceCell) {
                                                    // Display base unit price (LTM shown as separate line item)
                                                    const displayPrice = li.unitPrice;
                                                    childPriceCell.textContent = `$${displayPrice.toFixed(2)}`;

                                                    // Calculate and display line total for child row
                                                    if (childTotalCell) {
                                                        const qty = li.quantity || 0;
                                                        const lineTotal = displayPrice * qty;
                                                        childTotalCell.textContent = qty > 0 ? `$${lineTotal.toFixed(2)}` : '-';
                                                    }
                                                }
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });

                    updatePricingDisplay(pricing);
                }
            } catch (error) {
                console.error('Pricing calculation error:', error);
            }

            // Mark as dirty for auto-save (2026 consolidation)
            markEmbroideryDirty();
        }

        function collectProductsFromTable() {
            const products = [];
            // Only collect from parent rows (not child rows or AL config rows)
            const rows = document.querySelectorAll('#product-tbody tr:not(.child-row):not(.al-config-row)');

            rows.forEach(row => {
                const rowId = parseInt(row.id.replace('row-', ''));
                const style = row.dataset.style;
                const parentColor = row.dataset.color;
                const parentCatalogColor = row.dataset.catalogColor || '';

                if (!style || !parentColor) return;

                // Group sizes by color - different colors become separate products
                const colorGroups = {};

                // Initialize parent color group
                colorGroups[parentCatalogColor] = {
                    color: parentColor,
                    catalogColor: parentCatalogColor,
                    sizeBreakdown: {},
                    totalQty: 0
                };

                // Collect size inputs from parent row (standard or remapped sizes)
                // IMPORTANT: Exclude .xxxl-picker-btn (shows TOTAL) and .osfa-qty-input (handled separately)
                // Note: For non-standard products (combo, youth, toddler, tall), data-size is remapped
                const sizeCategory = row.dataset.sizeCategory;
                row.querySelectorAll('.size-input:not(.xxxl-picker-btn):not(.osfa-qty-input):not(:disabled)').forEach(input => {
                    const size = input.dataset.size;
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0 && size) {
                        colorGroups[parentCatalogColor].sizeBreakdown[size] = qty;
                        colorGroups[parentCatalogColor].totalQty += qty;
                    }
                });

                // Handle OSFA-only products (beanies, caps, bags)
                // OSFA qty is stored in parent row, not child rows
                if (row.dataset.isOsfaOnly === 'true') {
                    const osfaQty = parseInt(row.dataset.osfaQty) || 0;
                    if (osfaQty > 0) {
                        colorGroups[parentCatalogColor].sizeBreakdown['OSFA'] = osfaQty;
                        colorGroups[parentCatalogColor].totalQty += osfaQty;
                    }
                }

                // Collect extended sizes from CHILD ROWS - GROUP BY COLOR
                // Child rows may have different colors than parent
                const childRows = document.querySelectorAll(`tr[data-parent-row-id="${rowId}"]`);
                childRows.forEach(childRow => {
                    const size = childRow.dataset.extendedSize;
                    const childColor = childRow.dataset.color;
                    const childCatalogColor = childRow.dataset.catalogColor || '';
                    const qtyDisplay = childRow.querySelector('.qty-display');
                    const qty = parseInt(qtyDisplay?.textContent) || 0;

                    if (qty > 0 && size) {
                        // Initialize color group if different from parent
                        if (!colorGroups[childCatalogColor]) {
                            colorGroups[childCatalogColor] = {
                                color: childColor,
                                catalogColor: childCatalogColor,
                                sizeBreakdown: {},
                                totalQty: 0
                            };
                        }

                        colorGroups[childCatalogColor].sizeBreakdown[size] = qty;
                        colorGroups[childCatalogColor].totalQty += qty;
                    }
                });

                // Create product entry for each color group with quantities
                Object.entries(colorGroups).forEach(([catalogColor, group]) => {
                    if (group.totalQty > 0) {
                        const isCap = row.dataset.isCap === 'true';

                        // Get global AL config for this product type
                        const alConfig = isCap ? globalAL.cap : globalAL.garment;
                        const additionalLogos = alConfig.enabled ? [{
                            id: `global-al-${isCap ? 'cap' : 'garment'}`,
                            position: alConfig.position,
                            stitchCount: alConfig.stitchCount,
                            quantity: group.totalQty
                        }] : [];

                        products.push({
                            style: style,
                            color: group.color,
                            catalogColor: group.catalogColor,
                            productName: row.dataset.productName || style,
                            title: row.dataset.productName || style,  // For invoice PDF description column
                            sizeBreakdown: group.sizeBreakdown,
                            totalQuantity: group.totalQty,
                            isCap: isCap,  // Cap detection for pricing routing
                            rowId: rowId,  // Track row for AL price updates
                            imageUrl: row.dataset.imageUrl || '',  // Image URL for quote view display
                            logoAssignments: {
                                primary: { logoId: 'primary', quantity: group.totalQty },
                                additional: additionalLogos
                            }
                        });
                    }
                });
            });

            // Sort products: garments first, caps last (for consistent pricing display)
            products.sort((a, b) => {
                if (a.isCap === b.isCap) return 0;
                return a.isCap ? 1 : -1; // Garments first, caps last
            });

            return products;
        }

        function updatePricingDisplay(pricing) {
            // Store for toggle reference
            window.currentPricingData = pricing;

            document.getElementById('total-qty').textContent = pricing.totalQuantity || 0;
            document.getElementById('subtotal').textContent = `$${(pricing.subtotal || 0).toFixed(2)}`;
            document.getElementById('grand-total').textContent = `$${(pricing.grandTotal || 0).toFixed(2)}`;

            // Update products label based on embellishment type
            const productsLabel = document.getElementById('products-label');
            if (productsLabel) {
                const capEmbType = getCapEmbellishmentType();
                if (capEmbType === 'laser-patch' && pricing.hasCaps && !pricing.hasGarments) {
                    // Caps-only laser patch order - show "Products (Laser Patch):"
                    productsLabel.textContent = 'Products (Laser Patch):';
                } else {
                    // Default - embroidery with stitch count
                    productsLabel.textContent = 'Products (Base 8K):';
                }
            }
            // Update the pre-tax subtotal (same as grand-total before tax)
            document.getElementById('pre-tax-subtotal').textContent = `$${(pricing.grandTotal || 0).toFixed(2)}`;

            // Quantity breakdown for mixed quotes
            const garmentQtyRow = document.getElementById('garment-qty-row');
            const capQtyRow = document.getElementById('cap-qty-row');
            const isMixedQuote = pricing.hasCaps && pricing.hasGarments;

            if (isMixedQuote) {
                garmentQtyRow.style.display = 'flex';
                capQtyRow.style.display = 'flex';
                document.getElementById('garment-qty').textContent = pricing.garmentQuantity || 0;
                document.getElementById('cap-qty').textContent = pricing.capQuantity || 0;
            } else {
                garmentQtyRow.style.display = 'none';
                capQtyRow.style.display = 'none';
            }

            // Tier display - show separate tiers for mixed quotes
            const pricingTierEl = document.getElementById('pricing-tier');
            const garmentTierRow = document.getElementById('garment-tier-row');
            const capTierRow = document.getElementById('cap-tier-row');

            if (isMixedQuote) {
                // Mixed quote - show "Mixed" and separate tier breakdown
                pricingTierEl.textContent = 'Mixed';
                garmentTierRow.style.display = 'flex';
                capTierRow.style.display = 'flex';
                document.getElementById('garment-tier').textContent = pricing.garmentTier || '1-23';
                document.getElementById('cap-tier').textContent = pricing.capTier || '1-23';
            } else if (pricing.hasCaps) {
                // Caps only
                pricingTierEl.textContent = pricing.capTier || '1-23';
                garmentTierRow.style.display = 'none';
                capTierRow.style.display = 'none';
            } else {
                // Garments only or no products
                pricingTierEl.textContent = pricing.garmentTier || pricing.tier || '1-23';
                garmentTierRow.style.display = 'none';
                capTierRow.style.display = 'none';
            }

            // Mixed quote subtotal breakdown (caps + garments)
            const garmentSubtotalRow = document.getElementById('garment-subtotal-row');
            const capSubtotalRow = document.getElementById('cap-subtotal-row');

            if (isMixedQuote) {
                // Show breakdown rows
                garmentSubtotalRow.style.display = 'flex';
                capSubtotalRow.style.display = 'flex';
                document.getElementById('garment-subtotal').textContent = `$${(pricing.garmentSubtotal || 0).toFixed(2)}`;
                document.getElementById('cap-subtotal').textContent = `$${(pricing.capSubtotal || 0).toFixed(2)}`;
            } else if (pricing.hasCaps && !pricing.hasGarments) {
                // Caps only - show just cap breakdown
                garmentSubtotalRow.style.display = 'none';
                capSubtotalRow.style.display = 'flex';
                document.getElementById('cap-subtotal').textContent = `$${(pricing.capSubtotal || 0).toFixed(2)}`;
            } else if (pricing.hasGarments && !pricing.hasCaps) {
                // Garments only - hide breakdown rows (default view)
                garmentSubtotalRow.style.display = 'none';
                capSubtotalRow.style.display = 'none';
            } else {
                // No products
                garmentSubtotalRow.style.display = 'none';
                capSubtotalRow.style.display = 'none';
            }

            // LTM display (table rows only - sidebar removed in 2026 refactor)
            const garmentLtmTableRow = document.getElementById('garment-ltm-table-row');
            const capLtmTableRow = document.getElementById('cap-ltm-table-row');
            const garmentLtmTableTotal = document.getElementById('garment-ltm-table-total');
            const capLtmTableTotal = document.getElementById('cap-ltm-table-total');

            if (pricing.ltmFee > 0) {
                const hasGarmentLtm = (pricing.garmentLtmFee || 0) > 0;
                const hasCapLtm = (pricing.capLtmFee || 0) > 0;

                // Update table rows based on what applies
                if (hasGarmentLtm && garmentLtmTableRow) {
                    garmentLtmTableRow.style.display = 'table-row';
                    if (garmentLtmTableTotal) garmentLtmTableTotal.textContent = `$${pricing.garmentLtmFee.toFixed(2)}`;
                } else if (garmentLtmTableRow) {
                    garmentLtmTableRow.style.display = 'none';
                }
                if (hasCapLtm && capLtmTableRow) {
                    capLtmTableRow.style.display = 'table-row';
                    if (capLtmTableTotal) capLtmTableTotal.textContent = `$${pricing.capLtmFee.toFixed(2)}`;
                } else if (capLtmTableRow) {
                    capLtmTableRow.style.display = 'none';
                }
            } else {
                // No LTM fee (qty >= 24) - hide all LTM rows
                if (garmentLtmTableRow) garmentLtmTableRow.style.display = 'none';
                if (capLtmTableRow) capLtmTableRow.style.display = 'none';
            }

            // Setup (Digitizing) row - table row only (sidebar removed in 2026 refactor)
            const setupFeeTableRow = document.getElementById('setup-fee-table-row');
            const setupFeeUnit = document.getElementById('setup-fee-unit');
            const setupFeeTotal = document.getElementById('setup-fee-total');

            // Check cap embellishment type for label
            const capEmbType = getCapEmbellishmentType();
            const isCapLaserPatch = capEmbType === 'laser-patch';

            if (pricing.setupFees > 0) {
                if (setupFeeTableRow) {
                    setupFeeTableRow.style.display = 'table-row';
                    // Update label based on what's in quote
                    const hasCapSetup = (pricing.capSetupFees || 0) > 0;
                    const hasGarmentSetup = (pricing.garmentSetupFees || 0) > 0;
                    const setupLabel = setupFeeTableRow.querySelector('.fee-label');
                    if (setupLabel) {
                        if (hasCapSetup && !hasGarmentSetup && isCapLaserPatch) {
                            setupLabel.innerHTML = '<i class="fas fa-cog"></i> GRT-50 : Laser Patch Setup';
                        } else {
                            setupLabel.innerHTML = '<i class="fas fa-cog"></i> Digitizing/Setup Fee';
                        }
                    }
                    if (setupFeeUnit) setupFeeUnit.textContent = `$${pricing.setupFees.toFixed(2)}`;
                    if (setupFeeTotal) setupFeeTotal.textContent = `$${pricing.setupFees.toFixed(2)}`;
                }
            } else {
                if (setupFeeTableRow) setupFeeTableRow.style.display = 'none';
            }

            // Additional Stitches - table row only (sidebar removed in 2026 refactor)
            // Garments use $1.25/K rate, Caps use $1.00/K rate
            const stitchesFeeRow = document.getElementById('stitches-fee-row');
            const stitchesFeeUnit = document.getElementById('stitches-fee-unit');
            const stitchesFeeTotal = document.getElementById('stitches-fee-total');

            // Get logo configs (garment primary logo from top, cap logo from cap section)
            const garmentStitches = parseInt(document.getElementById('primary-stitches').value) || 8000;
            const capStitchesInput = document.getElementById('cap-primary-stitches');
            const capStitches = capStitchesInput ? (parseInt(capStitchesInput.value) || 8000) : 8000;

            // Calculate garment extra stitches (rate: $1.25/K)
            const garmentExtraK = Math.max(0, (garmentStitches - 8000) / 1000);
            const garmentQty = pricing.garmentQuantity || 0;
            const garmentStitchFee = garmentExtraK * 1.25 * garmentQty;

            // Calculate cap extra stitches (rate: $1.00/K)
            const capExtraK = Math.max(0, (capStitches - 8000) / 1000);
            const capQty = pricing.capQuantity || 0;
            const capStitchFee = capExtraK * 1.00 * capQty;

            const totalStitchFee = garmentStitchFee + capStitchFee;

            if (totalStitchFee > 0 && stitchesFeeRow) {
                stitchesFeeRow.style.display = 'table-row';
                if (stitchesFeeUnit) stitchesFeeUnit.textContent = `$${totalStitchFee.toFixed(2)}`;
                if (stitchesFeeTotal) stitchesFeeTotal.textContent = `$${totalStitchFee.toFixed(2)}`;
            } else if (stitchesFeeRow) {
                stitchesFeeRow.style.display = 'none';
            }

            // Additional Logos pricing section (GARMENTS) - reads from globalAL state
            const alContainer = document.getElementById('additional-logos-pricing');
            if (globalAL.garment.enabled && pricing.garmentQuantity > 0) {
                // Calculate AL pricing based on garment tier (fetch from API)
                const tier = pricing.garmentTier || pricing.tier || '1-23';
                let alBaseRate = 13.50; // 2026 fallback
                if (pricingCalculator.alTiers && pricingCalculator.alTiers[tier]) {
                    alBaseRate = pricingCalculator.alTiers[tier].embCost;
                } else {
                    // Tier-based fallback if API unavailable (2026 AL costs)
                    if (tier.includes('72')) alBaseRate = 9.50;
                    else if (tier.includes('48')) alBaseRate = 10.50;
                    else if (tier.includes('24')) alBaseRate = 12.50;
                    console.warn('[Garment AL] Using fallback rates - API data unavailable for tier:', tier);
                }

                // Get base stitch count and rate from API (with fallbacks)
                const alConfig = pricingCalculator.alTiers && pricingCalculator.alTiers[tier];
                const alBaseStitches = alConfig?.baseStitchCount || 8000;
                const alStitchRate = alConfig?.additionalStitchRate || 1.25;

                // Use globalAL.garment config instead of legacy additionalLogos array
                const logo = globalAL.garment;
                const logoExtraStitches = Math.max(0, logo.stitchCount - alBaseStitches);
                const logoExtraK = logoExtraStitches / 1000;
                const stitchCost = logoExtraK * alStitchRate;
                const alUnitPrice = alBaseRate + stitchCost;
                const alTotal = alUnitPrice * pricing.garmentQuantity;

                // Add line item to quote summary
                const stitchNote = logoExtraStitches > 0 ? ` (+${logoExtraK}K)` : '';
                alContainer.innerHTML = `
                    <div class="pricing-row al-pricing-row">
                        <span class="label"><i class="fas fa-tshirt" style="font-size: 10px; margin-right: 3px;"></i> AL: ${logo.position}${stitchNote}:</span>
                        <span class="value">$${alTotal.toFixed(2)}</span>
                    </div>
                    <div class="pricing-row sub-breakdown">
                        <span class="label">$${alUnitPrice.toFixed(2)} Ã— ${pricing.garmentQuantity}</span>
                        <span class="value sub-value"></span>
                    </div>
                `;
            } else {
                alContainer.innerHTML = '';
            }

            // Cap Additional Logos pricing section - reads from globalAL state
            const capAlContainer = document.getElementById('cap-additional-logos-pricing');
            if (globalAL.cap.enabled && pricing.capQuantity > 0) {
                // Get cap AL pricing based on CAP tier (not combined tier)
                const capTier = pricing.capTier || '1-23';
                let capAlBaseRate = 6.75; // 2026 fallback (AL-CAP tier 1-23)
                if (pricingCalculator.capAlTiers && pricingCalculator.capAlTiers[capTier]) {
                    capAlBaseRate = pricingCalculator.capAlTiers[capTier].embCost;
                } else {
                    // Tier-based fallback if API unavailable (2026 AL-CAP costs)
                    if (capTier.includes('72')) capAlBaseRate = 5.25;
                    else if (capTier.includes('48')) capAlBaseRate = 5.50;
                    else if (capTier.includes('24')) capAlBaseRate = 5.75;
                    console.warn('[Cap AL] Using fallback rates - API data unavailable for tier:', capTier);
                }

                // Get base stitch count and rate from API (with fallbacks)
                const capAlConfig = pricingCalculator.capAlTiers && pricingCalculator.capAlTiers[capTier];
                const capAlBaseStitches = capAlConfig?.baseStitchCount || 5000;
                const capAlStitchRate = capAlConfig?.additionalStitchRate || 1.00;

                // Use globalAL.cap config instead of legacy capAdditionalLogos array
                const logo = globalAL.cap;
                // Cap AL base is 5000 stitches (from API, not 8000 like garments)
                const logoExtraStitches = Math.max(0, logo.stitchCount - capAlBaseStitches);
                const logoExtraK = Math.ceil(logoExtraStitches / 1000); // Round up per 1K
                // Cap AL rate is $1.00/1K from API (not $1.25 like garments)
                const stitchCost = logoExtraK * capAlStitchRate;
                const capAlUnitPrice = capAlBaseRate + stitchCost;
                const capAlTotal = capAlUnitPrice * pricing.capQuantity;

                // Add line item to quote summary
                const stitchNote = logoExtraStitches > 0 ? ` (+${logoExtraK}K)` : '';
                capAlContainer.innerHTML = `
                    <div class="pricing-row al-pricing-row cap-al">
                        <span class="label"><i class="fas fa-hat-cowboy" style="font-size: 10px; margin-right: 3px;"></i> AL: ${logo.position}${stitchNote}:</span>
                        <span class="value">$${capAlTotal.toFixed(2)}</span>
                    </div>
                    <div class="pricing-row sub-breakdown">
                        <span class="label">$${capAlUnitPrice.toFixed(2)} Ã— ${pricing.capQuantity}</span>
                        <span class="value sub-value"></span>
                    </div>
                `;
            } else {
                capAlContainer.innerHTML = '';
            }

            // Update tax calculation at the end of pricing display
            updateTaxCalculation();
        }

        /**
         * Update tax calculation based on toggle state
         * Includes Additional Charges (Art, Rush, Sample, Discount) in subtotal
         * Called after pricing updates and when any charge input changes
         */
        function updateTaxCalculation() {
            const includeTax = document.getElementById('include-tax')?.checked ?? true;

            // Get base subtotal (products + LTM + digitizing + stitches + AL)
            const baseSubtotalText = document.getElementById('grand-total')?.textContent || '$0.00';
            const baseSubtotal = parseFloat(baseSubtotalText.replace(/[$,]/g, '')) || 0;

            // Get additional charges
            const artCharge = parseFloat(document.getElementById('art-charge')?.value) || 0;
            const rushFee = parseFloat(document.getElementById('rush-fee')?.value) || 0;
            const sampleFee = parseFloat(document.getElementById('sample-fee')?.value) || 0;
            const sampleQty = parseInt(document.getElementById('sample-qty')?.value) || 1;
            const discountValue = parseFloat(document.getElementById('discount-amount')?.value) || 0;
            const discountType = document.getElementById('discount-type')?.value || 'fixed';

            // Calculate additional charges total
            const additionalCharges = artCharge + rushFee + (sampleFee * sampleQty);

            // Calculate discount
            let discount = 0;
            if (discountType === 'percent') {
                discount = (baseSubtotal + additionalCharges) * (discountValue / 100);
            } else {
                discount = discountValue;
            }

            // Calculate adjusted subtotal (includes additional charges and discount)
            const adjustedSubtotal = baseSubtotal + additionalCharges - discount;

            const taxRate = 0.101; // WA State sales tax

            const taxRow = document.getElementById('tax-row');
            const taxAmountEl = document.getElementById('tax-amount');
            const grandTotalWithTax = document.getElementById('grand-total-with-tax');
            const preTaxSubtotal = document.getElementById('pre-tax-subtotal');

            if (!taxRow || !taxAmountEl || !grandTotalWithTax) return;

            // Update pre-tax subtotal display to show adjusted amount
            if (preTaxSubtotal) {
                preTaxSubtotal.textContent = '$' + adjustedSubtotal.toFixed(2);
            }

            if (includeTax) {
                const tax = adjustedSubtotal * taxRate;
                taxRow.style.display = 'flex';
                taxAmountEl.textContent = '$' + tax.toFixed(2);
                grandTotalWithTax.textContent = '$' + (adjustedSubtotal + tax).toFixed(2);
            } else {
                taxRow.style.display = 'none';
                grandTotalWithTax.textContent = '$' + adjustedSubtotal.toFixed(2);
            }
        }

        // ============================================================
        // ACTIONS (Save, Print, Email, Copy)
        // ============================================================

        async function printQuote() {
            const products = collectProductsFromTable();
            if (products.length === 0) {
                showToast('Add products before printing', 'error');
                return;
            }

            showLoading(true);

            try {
                // Build separate logo configs for garments and caps
                const logoConfigs = {
                    garment: {
                        primary: { ...primaryLogo, id: 'primary' },
                        additional: additionalLogos
                    },
                    cap: {
                        primary: { ...capPrimaryLogo, id: 'cap-primary' },
                        additional: capAdditionalLogos
                    }
                };

                // For backward compatibility, also create combined array
                const allLogos = [
                    { ...primaryLogo, id: 'primary' },
                    ...additionalLogos
                ];
                const pricing = await pricingCalculator.calculateQuote(products, allLogos, logoConfigs);

                // Generate and open print window
                const invoiceGenerator = new EmbroideryInvoiceGenerator();
                const customerData = {
                    customerName: document.getElementById('customer-name').value || 'Customer',
                    companyName: document.getElementById('company-name').value || '',
                    customerEmail: document.getElementById('customer-email').value || '',
                    customerPhone: document.getElementById('customer-phone').value || '',
                    salesRepEmail: document.getElementById('sales-rep').value
                };

                // LTM always shown as separate line item
                pricing.ltmDistributed = false;

                // Add additional charges to pricing data for PDF (2026 fee refactor)
                const additionalCharges = getAdditionalCharges();
                pricing.artCharge = additionalCharges.artCharge || 0;
                pricing.graphicDesignHours = additionalCharges.graphicDesignHours || 0;
                pricing.graphicDesignCharge = additionalCharges.graphicDesignCharge || 0;
                pricing.rushFee = additionalCharges.rushFee || 0;
                pricing.discount = additionalCharges.discount || 0;
                pricing.discountReason = additionalCharges.discountReason || '';

                const invoiceHTML = invoiceGenerator.generateInvoiceHTML(pricing, customerData);
                const printWindow = window.open('', '_blank');
                printWindow.document.write(invoiceHTML);
                printWindow.document.close();

                setTimeout(() => {
                    printWindow.print();
                }, 300);

                showToast('Opening print dialog...', 'success');
            } catch (error) {
                console.error('Print error:', error);
                showToast('Error generating PDF', 'error');
            }

            showLoading(false);
        }

        /**
         * Save quote and get shareable link
         * Uses EmbroideryQuoteService and QuoteShareModal
         */
        async function saveAndGetLink() {
            const products = collectProductsFromTable();
            if (products.length === 0) {
                showToast('Add products before saving', 'error');
                return;
            }

            // Validate required fields
            const customerName = document.getElementById('customer-name')?.value?.trim();
            const customerEmail = document.getElementById('customer-email')?.value?.trim();

            if (!customerName || !customerEmail) {
                showToast('Please enter customer name and email', 'error');
                if (!customerName) document.getElementById('customer-name')?.focus();
                else if (!customerEmail) document.getElementById('customer-email')?.focus();
                return;
            }

            // Get save button for loading state
            const saveBtn = document.querySelector('.btn-save-quote');
            const originalText = saveBtn?.innerHTML;
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            showLoading(true);

            try {
                // Combine ALL logos: garment primary + additional + cap primary + cap additional
                const allLogos = [
                    { ...primaryLogo, id: 'primary' },
                    ...additionalLogos,
                    { ...capPrimaryLogo, id: 'cap-primary' },
                    ...capAdditionalLogos
                ];

                // Build logoConfigs for proper garment vs cap digitizing separation
                // Bug fix 2026-01-14: Without this, pricing engine uses legacy path that
                // counts ALL logos as garment digitizing instead of separating them
                const logoConfigs = {
                    garment: {
                        primary: { ...primaryLogo, id: 'primary' },
                        additional: additionalLogos
                    },
                    cap: {
                        primary: { ...capPrimaryLogo, id: 'cap-primary' },
                        additional: capAdditionalLogos
                    }
                };
                const pricing = await pricingCalculator.calculateQuote(products, allLogos, logoConfigs);

                // Get sales rep NAME from dropdown selected option text
                const salesRepSelect = document.getElementById('sales-rep');
                const salesRepEmail = salesRepSelect?.value || 'sales@nwcustomapparel.com';
                const salesRepName = salesRepSelect?.options[salesRepSelect.selectedIndex]?.text || '';

                // Get additional charges (artwork, rush, sample, discount)
                const additionalCharges = getAdditionalCharges();

                // Build customer data with additional charges
                const customerData = {
                    email: customerEmail,
                    name: customerName,
                    company: document.getElementById('company-name')?.value?.trim() || '',
                    phone: document.getElementById('customer-phone')?.value?.trim() || '',
                    salesRepEmail: salesRepEmail,
                    salesRepName: salesRepName,
                    notes: '',
                    // Additional charges (2026-01-14)
                    artCharge: additionalCharges.artCharge,
                    graphicDesignHours: additionalCharges.graphicDesignHours,
                    graphicDesignCharge: additionalCharges.graphicDesignCharge,
                    rushFee: additionalCharges.rushFee,
                    sampleFee: additionalCharges.sampleFee,
                    sampleQty: additionalCharges.sampleQty,
                    discount: additionalCharges.discount,
                    discountPercent: additionalCharges.discountPercent,
                    discountReason: additionalCharges.discountReason
                };

                // Build quote data
                const quoteData = {
                    products: products,
                    logos: allLogos,
                    // Cap embellishment type for laser-patch orders
                    capEmbellishmentType: getCapEmbellishmentType()
                };

                // Attach logos and embellishment type to pricing for service to access
                pricing.logos = allLogos;
                pricing.capEmbellishmentType = getCapEmbellishmentType();

                let result;
                if (editingQuoteId) {
                    // Edit mode: Update existing quote (save revision)
                    console.log('[Embroidery] Updating quote:', editingQuoteId);
                    result = await quoteService.updateQuote(editingQuoteId, quoteData, customerData, pricing);
                } else {
                    // New quote mode: Create new quote
                    result = await quoteService.saveQuote(quoteData, customerData, pricing);
                }

                if (result && result.quoteID) {
                    const isUpdate = !!editingQuoteId;
                    console.log(`[Embroidery] Quote ${isUpdate ? 'updated' : 'saved'}:`, result.quoteID);

                    // Clear auto-save draft on successful save (2026 consolidation)
                    if (embPersistence) {
                        embPersistence.clearDraft();
                    }

                    // Mark as saved (no unsaved changes)
                    markAsSaved();

                    if (isUpdate) {
                        // Update mode: Show revision success message
                        const newRevision = result.revision || (editingRevision + 1);
                        editingRevision = newRevision;
                        updateEditModeUI(result.quoteID, newRevision);
                        showToast(`Revision ${newRevision} saved successfully!`, 'success');

                        // Show modal with link (don't pass message as baseUrl!)
                        if (typeof QuoteShareModal !== 'undefined' && QuoteShareModal.show) {
                            QuoteShareModal.show(result.quoteID);
                        } else {
                            const url = `${window.location.origin}/quote/${result.quoteID}`;
                            alert(`Quote updated!\n\nQuote ID: ${result.quoteID}\nRevision: ${newRevision}\n\nShareable Link:\n${url}`);
                        }
                    } else {
                        // New quote: Show success modal with shareable link
                        if (typeof QuoteShareModal !== 'undefined' && QuoteShareModal.show) {
                            QuoteShareModal.show(result.quoteID);
                        } else {
                            const url = `${window.location.origin}/quote/${result.quoteID}`;
                            alert(`Quote saved!\n\nQuote ID: ${result.quoteID}\n\nShareable Link:\n${url}`);
                        }
                    }
                } else {
                    throw new Error(result?.error || 'Failed to save quote');
                }
            } catch (error) {
                console.error('[Embroidery] Save error:', error);
                showToast('Error saving quote: ' + error.message, 'error');
            } finally {
                showLoading(false);
                // Restore button state
                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        // Legacy function - redirects to saveAndGetLink
        async function saveQuote() {
            return saveAndGetLink();
        }

        async function emailQuote() {
            const products = collectProductsFromTable();
            if (products.length === 0) {
                showToast('Add products before emailing', 'error');
                return;
            }

            const customerEmail = document.getElementById('customer-email').value;
            if (!customerEmail) {
                showToast('Enter customer email', 'error');
                document.getElementById('customer-email').focus();
                return;
            }

            showToast('Email functionality coming soon', 'info');
        }

        // Toggle Coming Soon accordion
        function toggleComingSoon() {
            const content = document.getElementById('coming-soon-content');
            const chevron = document.getElementById('coming-soon-chevron');
            content.classList.toggle('open');
            chevron.classList.toggle('rotated');
        }

        // ============================================
        // Additional Charges Section Functions
        // ============================================

        /**
         * Toggle Additional Charges panel visibility
         * Panel is COLLAPSED by default to reduce visual clutter
         */
        function toggleAdditionalCharges() {
            const content = document.getElementById('charges-content');
            const chevron = document.getElementById('charges-chevron');
            if (content.style.display === 'none') {
                // Expanding - show content, chevron points UP
                content.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                // Collapsing - hide content, chevron points DOWN
                content.style.display = 'none';
                chevron.style.transform = 'rotate(180deg)';
            }
        }

        /**
         * Toggle Save & Share panel visibility
         * Panel is COLLAPSED by default - user expands when ready to save
         */
        function toggleSaveShare() {
            const content = document.getElementById('save-share-content');
            const chevron = document.getElementById('save-share-chevron');
            if (content.style.display === 'none') {
                // Expanding - show content, chevron points UP
                content.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                // Collapsing - hide content, chevron points DOWN
                content.style.display = 'none';
                chevron.style.transform = 'rotate(180deg)';
            }
        }

        // ============================================
        // Unsaved Changes Tracking (UX Improvement)
        // ============================================

        /**
         * Mark quote as having unsaved changes
         * Shows pulsing "Unsaved" badge in header
         */
        function markAsUnsaved() {
            hasChanges = true;
            const indicator = document.getElementById('unsaved-indicator');
            if (indicator) {
                indicator.style.display = 'inline';
            }
        }

        /**
         * Mark quote as saved (no unsaved changes)
         * Hides the "Unsaved" badge
         */
        function markAsSaved() {
            hasChanges = false;
            const indicator = document.getElementById('unsaved-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        /**
         * Check if there are unsaved changes
         */
        function hasUnsavedChanges() {
            return hasChanges;
        }

        /**
         * Setup event listeners for tracking unsaved changes
         * Adds listeners to customer fields and additional charges
         */
        function setupUnsavedChangesTracking() {
            // Customer fields
            const customerFields = [
                'customer-name', 'customer-email', 'company-name', 'customer-phone', 'sales-rep'
            ];
            customerFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', markAsUnsaved);
                    el.addEventListener('change', markAsUnsaved);
                }
            });

            // Additional charges fields
            const chargeFields = [
                'rush-fee', 'discount-amount', 'discount-reason', 'art-charge', 'graphic-design-hours'
            ];
            chargeFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', markAsUnsaved);
                    el.addEventListener('change', markAsUnsaved);
                }
            });

            // Logo configuration fields
            const logoFields = [
                'primary-position', 'primary-stitches', 'primary-digitizing',
                'garment-al-position', 'garment-al-stitches',
                'cap-primary-stitches', 'cap-al-position', 'cap-al-stitches',
                'cap-embellishment-type'
            ];
            logoFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', markAsUnsaved);
                    el.addEventListener('change', markAsUnsaved);
                }
            });
        }

        // ============================================
        // New Quote Functionality (UX Improvement)
        // ============================================

        /**
         * Confirm and start a new quote
         * Prompts user if there are unsaved changes
         */
        function confirmNewQuote() {
            if (hasUnsavedChanges()) {
                if (confirm('You have unsaved changes. Start a new quote?')) {
                    resetQuote();
                }
            } else {
                resetQuote();
            }
        }

        /**
         * Reset all quote data and start fresh
         */
        function resetQuote() {
            // Clear all product rows and re-add empty state
            const tbody = document.getElementById('product-tbody');
            tbody.innerHTML = `
                <tr id="empty-state-row">
                    <td colspan="13" style="text-align: center; padding: 40px 20px; color: #64748b; background: #f8fafc;">
                        <div style="font-size: 32px; margin-bottom: 12px;">&#128085;</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Enter a style number to get started</div>
                        <div style="font-size: 13px; color: #94a3b8;">Type a style # in the search bar above (e.g., PC54, G500, C112)</div>
                    </td>
                </tr>
            `;

            // Reset row counter
            rowCounter = 0;

            // Reset logo cards visibility
            const garmentCard = document.getElementById('garment-logo-card');
            const capCard = document.getElementById('cap-logo-card');
            const artworkServices = document.getElementById('artwork-services');
            if (garmentCard) garmentCard.style.display = 'none';
            if (capCard) capCard.style.display = 'none';
            if (artworkServices) artworkServices.style.display = 'none';

            // Reset logo configurations to defaults
            primaryLogo.position = 'Left Chest';
            primaryLogo.stitches = 8000;
            primaryLogo.digitizing = false;
            document.getElementById('primary-position').value = 'Left Chest';
            document.getElementById('primary-stitches').value = 8000;
            document.getElementById('primary-digitizing').checked = false;

            // Reset additional logo toggles
            const garmentALSwitch = document.getElementById('garment-al-switch');
            const capALSwitch = document.getElementById('cap-al-switch');
            if (garmentALSwitch) garmentALSwitch.classList.remove('active');
            if (capALSwitch) capALSwitch.classList.remove('active');
            document.getElementById('garment-al-toggle').checked = false;
            document.getElementById('cap-al-toggle').checked = false;

            // Reset customer form fields
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-email').value = '';
            document.getElementById('company-name').value = '';
            document.getElementById('customer-phone').value = '';

            // Reset additional charges
            document.getElementById('rush-fee').value = '';
            document.getElementById('discount-amount').value = '';
            document.getElementById('discount-reason').value = '';
            document.getElementById('art-charge').value = 0;
            document.getElementById('art-charge-toggle').checked = false;
            document.getElementById('graphic-design-hours').value = '';

            // Clear edit mode
            editingQuoteId = null;
            editingRevision = null;

            // Clear draft storage
            if (embPersistence) {
                embPersistence.clearDraft();
            }

            // Recalculate pricing (will show zeros)
            recalculateAllPricing();
            updateAdditionalCharges();

            // Mark as saved (no unsaved changes)
            markAsSaved();

            // Focus search bar for immediate typing
            const searchInput = document.getElementById('product-search');
            if (searchInput) {
                searchInput.focus();
            }

            showToast('Ready for new quote', 'success');
        }

        /**
         * Update discount symbol when type changes ($ vs %)
         */
        function updateDiscountType() {
            const type = document.getElementById('discount-type').value;
            const symbol = document.getElementById('discount-symbol');
            symbol.textContent = type === 'percent' ? '%' : '$';
            updateAdditionalCharges();
        }

        /**
         * Calculate and update additional charges display badge
         */
        function updateAdditionalCharges() {
            const artCharge = parseFloat(document.getElementById('art-charge')?.value) || 0;
            const graphicDesignHours = parseFloat(document.getElementById('graphic-design-hours')?.value) || 0;
            const graphicDesignCharge = graphicDesignHours * 75; // $75/hr (GRT-75)
            const rushFee = parseFloat(document.getElementById('rush-fee')?.value) || 0;
            const sampleFee = parseFloat(document.getElementById('sample-fee')?.value) || 0;
            const discountAmount = parseFloat(document.getElementById('discount-amount')?.value) || 0;
            const discountType = document.getElementById('discount-type')?.value || 'fixed';

            // Update graphic design total display
            const graphicDesignTotalEl = document.getElementById('graphic-design-total');
            if (graphicDesignTotalEl) {
                graphicDesignTotalEl.textContent = graphicDesignCharge.toFixed(2);
            }

            // Calculate total additional charges (before discount)
            const totalCharges = artCharge + graphicDesignCharge + rushFee + sampleFee;

            // Calculate discount value
            let discountValue = 0;
            if (discountType === 'percent') {
                // Get current subtotal from pricing summary for percentage calculation
                const subtotalText = document.getElementById('subtotal')?.textContent || '$0.00';
                const subtotal = parseFloat(subtotalText.replace(/[$,]/g, '')) || 0;
                discountValue = subtotal * (discountAmount / 100);
            } else {
                discountValue = discountAmount;
            }

            // Net additional = charges - discount
            const netAdditional = totalCharges - discountValue;

            // Update badge
            const badge = document.getElementById('charges-badge');
            if (netAdditional !== 0) {
                badge.style.display = 'inline';
                badge.textContent = netAdditional >= 0
                    ? `+$${netAdditional.toFixed(2)}`
                    : `-$${Math.abs(netAdditional).toFixed(2)}`;
                badge.style.background = netAdditional >= 0 ? '#22c55e' : '#dc2626';
            } else {
                badge.style.display = 'none';
            }

            // Update fee table rows (2026 refactor)
            updateFeeTableRows();
        }

        /**
         * Update fee table rows based on current input values
         * Shows/hides rows in the products table based on fee values
         */
        function updateFeeTableRows() {
            // Art charge row
            const artChargeRow = document.getElementById('art-charge-row');
            const artChargeToggle = document.getElementById('art-charge-toggle');
            const artCharge = parseFloat(document.getElementById('art-charge')?.value || 0);
            if (artChargeRow) {
                if (artChargeToggle?.checked && artCharge > 0) {
                    artChargeRow.style.display = 'table-row';
                    document.getElementById('art-charge-unit').textContent = '$' + artCharge.toFixed(2);
                    document.getElementById('art-charge-total').textContent = '$' + artCharge.toFixed(2);
                } else {
                    artChargeRow.style.display = 'none';
                }
            }

            // Graphic design row
            const graphicDesignRow = document.getElementById('graphic-design-row');
            const designHours = parseFloat(document.getElementById('graphic-design-hours')?.value || 0);
            const designTotal = designHours * 75;
            if (graphicDesignRow) {
                if (designHours > 0) {
                    graphicDesignRow.style.display = 'table-row';
                    document.getElementById('design-hours-label').textContent = designHours;
                    document.getElementById('graphic-design-unit').textContent = '$' + designTotal.toFixed(2);
                    document.getElementById('graphic-design-total-row').textContent = '$' + designTotal.toFixed(2);
                } else {
                    graphicDesignRow.style.display = 'none';
                }
            }

            // Rush fee row
            const rushFeeRow = document.getElementById('rush-fee-row');
            const rushFee = parseFloat(document.getElementById('rush-fee')?.value || 0);
            if (rushFeeRow) {
                if (rushFee > 0) {
                    rushFeeRow.style.display = 'table-row';
                    document.getElementById('rush-fee-unit').textContent = '$' + rushFee.toFixed(2);
                    document.getElementById('rush-fee-total').textContent = '$' + rushFee.toFixed(2);
                } else {
                    rushFeeRow.style.display = 'none';
                }
            }

            // Discount row
            const discountRow = document.getElementById('discount-row');
            const discountAmount = parseFloat(document.getElementById('discount-amount')?.value || 0);
            const discountType = document.getElementById('discount-type')?.value || 'fixed';
            const discountReason = document.getElementById('discount-reason')?.value || '';
            if (discountRow) {
                if (discountAmount > 0) {
                    discountRow.style.display = 'table-row';
                    let actualDiscount = discountAmount;
                    if (discountType === 'percent') {
                        const subtotal = parseFloat(document.getElementById('subtotal')?.textContent?.replace(/[$,]/g, '') || 0);
                        actualDiscount = subtotal * (discountAmount / 100);
                    }
                    const reasonLabel = document.getElementById('discount-reason-label');
                    if (reasonLabel) {
                        reasonLabel.textContent = discountReason ? `(${discountReason})` : '';
                    }
                    document.getElementById('discount-unit').textContent = '-$' + actualDiscount.toFixed(2);
                    document.getElementById('discount-total').textContent = '-$' + actualDiscount.toFixed(2);
                } else {
                    discountRow.style.display = 'none';
                }
            }
        }

        /**
         * Get additional charges data for saving to database
         * @returns {Object} Additional charges object
         */
        function getAdditionalCharges() {
            const discountAmount = parseFloat(document.getElementById('discount-amount')?.value) || 0;
            const discountType = document.getElementById('discount-type')?.value || 'fixed';

            // Calculate actual discount value based on type
            let discountValue = 0;
            let discountPercent = 0;
            if (discountType === 'percent') {
                discountPercent = discountAmount;
                const subtotalText = document.getElementById('subtotal')?.textContent || '$0.00';
                const subtotal = parseFloat(subtotalText.replace(/[$,]/g, '')) || 0;
                discountValue = subtotal * (discountAmount / 100);
            } else {
                discountValue = discountAmount;
            }

            // Graphic Design Services (GRT-75) @ $75/hr
            const graphicDesignHours = parseFloat(document.getElementById('graphic-design-hours')?.value) || 0;
            const graphicDesignCharge = graphicDesignHours * 75;

            return {
                artCharge: parseFloat(document.getElementById('art-charge')?.value) || 0,
                graphicDesignHours: graphicDesignHours,
                graphicDesignCharge: graphicDesignCharge,
                rushFee: parseFloat(document.getElementById('rush-fee')?.value) || 0,
                sampleFee: parseFloat(document.getElementById('sample-fee')?.value) || 0,
                sampleQty: parseInt(document.getElementById('sample-qty')?.value) || 1,
                discount: discountValue,
                discountPercent: discountPercent,
                discountReason: document.getElementById('discount-reason')?.value?.trim() || ''
            };
        }

        async function copyToClipboard() {
            const products = collectProductsFromTable();
            if (products.length === 0) {
                showToast('Add products first', 'error');
                return;
            }

            try {
                // Combine all logos for backward compat
                const allLogos = [
                    { ...primaryLogo, id: 'primary' },
                    ...additionalLogos,
                    { ...capPrimaryLogo, id: 'cap-primary' },
                    ...capAdditionalLogos
                ];

                // Build separate logo configs for cap vs garment
                const logoConfigs = {
                    garment: {
                        primary: { ...primaryLogo, id: 'primary' },
                        additional: additionalLogos
                    },
                    cap: {
                        primary: { ...capPrimaryLogo, id: 'cap-primary' },
                        additional: capAdditionalLogos
                    }
                };

                const pricing = await pricingCalculator.calculateQuote(products, allLogos, logoConfigs);

                const text = generateQuoteText(products, pricing, logoConfigs);
                await navigator.clipboard.writeText(text);

                showToast('Quote copied to clipboard!', 'success');
            } catch (error) {
                console.error('Copy error:', error);
                showToast('Error copying to clipboard', 'error');
            }
        }

        function generateQuoteText(products, pricing, logoConfigs) {
            // Cap position name mapping
            const capPositionNames = {
                'CF': 'Cap Front',
                'CB': 'Cap Back',
                'CL': 'Left Side',
                'CR': 'Right Side'
            };

            const lines = [
                'NORTHWEST CUSTOM APPAREL - EMBROIDERY QUOTE',
                '================================================',
                `Date: ${new Date().toLocaleDateString()}`,
                `Customer: ${document.getElementById('customer-name').value || 'N/A'}`,
                `Company: ${document.getElementById('company-name').value || 'N/A'}`,
            ];

            // Separate caps from garments
            const capProducts = products.filter(p => p.isCap === true);
            const garmentProducts = products.filter(p => p.isCap !== true);

            // Show garment embroidery section if garments in quote
            if (garmentProducts.length > 0) {
                lines.push('');
                lines.push('GARMENT EMBROIDERY:');
                lines.push(`  Primary: ${logoConfigs.garment.primary.position}, ${logoConfigs.garment.primary.stitchCount.toLocaleString()} stitches`);
                if (logoConfigs.garment.additional.length > 0) {
                    logoConfigs.garment.additional.forEach(logo => {
                        lines.push(`  Additional: ${logo.position}, ${logo.stitchCount.toLocaleString()} stitches`);
                    });
                }
            }

            // Show cap embellishment section if caps in quote
            if (capProducts.length > 0) {
                lines.push('');
                // Show embellishment type in header
                const embType = logoConfigs.cap.primary.embellishmentType || 'embroidery';
                const embTypeLabel = {
                    'embroidery': 'CAP EMBROIDERY:',
                    '3d-puff': 'CAP 3D PUFF EMBROIDERY:',
                    'laser-patch': 'CAP LASER LEATHERETTE PATCH:'
                }[embType] || 'CAP EMBELLISHMENT:';
                lines.push(embTypeLabel);

                const capPosName = capPositionNames[logoConfigs.cap.primary.position] || logoConfigs.cap.primary.position;
                if (embType === 'laser-patch') {
                    // Patches don't have stitch count - standard size only (2-4")
                    lines.push(`  Position: ${capPosName}`);
                    lines.push(`  Patch Size: Standard (2-4")`);
                } else {
                    // Embroidery (flat or 3D puff) shows stitch count
                    lines.push(`  Front Logo: ${capPosName}, ${logoConfigs.cap.primary.stitchCount.toLocaleString()} stitches`);
                    if (embType === '3d-puff') {
                        lines.push(`  3D Puff Upcharge: +$3.00/cap`);
                    }
                }
                // Only show additional logos for embroidery (not patches)
                if (embType !== 'laser-patch' && logoConfigs.cap.additional.length > 0) {
                    logoConfigs.cap.additional.forEach(logo => {
                        const posName = capPositionNames[logo.position] || logo.position;
                        lines.push(`  Additional: ${posName}, ${logo.stitchCount.toLocaleString()} stitches`);
                    });
                }
            }

            // Show garment products if any
            if (garmentProducts.length > 0) {
                lines.push('');
                lines.push('GARMENTS:');
                lines.push('------------------------------------------------');
                garmentProducts.forEach(p => {
                    const sizes = Object.entries(p.sizeBreakdown).map(([s, q]) => `${s}:${q}`).join(' ');
                    lines.push(`${p.style} - ${p.color} | ${sizes} | Qty: ${p.totalQuantity}`);
                });
            }

            // Show cap products if any
            if (capProducts.length > 0) {
                lines.push('');
                lines.push('CAPS:');
                lines.push('------------------------------------------------');
                capProducts.forEach(p => {
                    const sizes = Object.entries(p.sizeBreakdown).map(([s, q]) => `${s}:${q}`).join(' ');
                    lines.push(`${p.style} - ${p.color} | ${sizes} | Qty: ${p.totalQuantity}`);
                });
            }

            lines.push('');
            lines.push('------------------------------------------------');
            lines.push(`Total Pieces: ${pricing.totalQuantity}`);
            // Show quantity breakdown for mixed quotes
            if (pricing.hasCaps && pricing.hasGarments) {
                lines.push(`  Garments: ${pricing.garmentQuantity}`);
                lines.push(`  Caps: ${pricing.capQuantity}`);
            }

            // Show tier (with breakdown for mixed quotes)
            if (pricing.hasCaps && pricing.hasGarments) {
                lines.push(`Pricing Tier: Mixed`);
                lines.push(`  Garment Tier: ${pricing.garmentTier}`);
                lines.push(`  Cap Tier: ${pricing.capTier}`);
            } else if (pricing.hasCaps) {
                lines.push(`Tier: ${pricing.capTier}`);
            } else {
                lines.push(`Tier: ${pricing.garmentTier || pricing.tier}`);
            }

            // Show subtotal breakdown for mixed quotes
            if (pricing.hasCaps && pricing.hasGarments) {
                lines.push(`Products (Base 8K): $${pricing.subtotal.toFixed(2)}`);
                lines.push(`  Garments Subtotal: $${pricing.garmentSubtotal.toFixed(2)}`);
                lines.push(`  Caps Subtotal: $${pricing.capSubtotal.toFixed(2)}`);
            } else {
                lines.push(`Products (Base 8K): $${pricing.subtotal.toFixed(2)}`);
            }

            // Show LTM (with breakdown for mixed quotes)
            if (pricing.ltmFee > 0) {
                const hasGarmentLtm = (pricing.garmentLtmFee || 0) > 0;
                const hasCapLtm = (pricing.capLtmFee || 0) > 0;

                if (hasGarmentLtm && hasCapLtm) {
                    lines.push(`LTM Fee (< 24 pcs): $${pricing.ltmFee.toFixed(2)}`);
                    lines.push(`  Garment LTM: $${pricing.garmentLtmFee.toFixed(2)}`);
                    lines.push(`  Cap LTM: $${pricing.capLtmFee.toFixed(2)}`);
                } else {
                    lines.push(`LTM Fee: $${pricing.ltmFee.toFixed(2)}`);
                }
            }
            if (pricing.setupFees > 0) lines.push(`Setup: $${pricing.setupFees.toFixed(2)}`);
            lines.push(`TOTAL: $${pricing.grandTotal.toFixed(2)}`);
            lines.push('');
            lines.push('Northwest Custom Apparel | 253-922-5793');

            return lines.join('\n');
        }

        // ============================================================
        // UTILITIES
        // ============================================================

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // Select icon based on type
            const icons = {
                success: 'check',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            const icon = icons[type] || 'info-circle';

            toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, duration);
        }
    </script>
</body>
</html>
