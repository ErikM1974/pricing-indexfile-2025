<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 DTF Quote Builder | Northwest Custom Apparel</title>

    <!-- NWCA Favicon -->
    <link rel="icon" type="image/png" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- App Configuration (centralized API URLs, settings) -->
    <script src="/config/app.config.js"></script>

    <!-- DTF Quote Builder Styles -->
    <link rel="stylesheet" href="/shared_components/css/dtf-quote-builder.css?v=20260112">

    <!-- Quote Builder Shared Components -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-common.css?v=20250911">
    <link rel="stylesheet" href="/shared_components/css/quote-print.css?v=20250911">
    <link rel="stylesheet" href="/shared_components/css/color-picker-shared.css?v=20260106">
    <link rel="stylesheet" href="/shared_components/css/quote-share-modal.css?v=20260113">
    <link rel="stylesheet" href="/shared_components/css/customer-lookup.css?v=20260129">
    <script src="/shared_components/js/quote-builder-base.js?v=20250911"></script>
    <script src="/shared_components/js/quote-formatter.js?v=20250911"></script>
    <script src="/shared_components/js/product-thumbnail-modal.js?v=20260129"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Error Banner (hidden by default) -->
    <div id="error-banner" class="error-banner" style="display: none;"></div>

    <!-- Compact Header -->
    <header class="power-header dtf-header">
        <a href="/staff-dashboard.html">
            <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1"
                 alt="Northwest Custom Apparel"
                 class="logo">
        </a>
        <div style="text-align: center;">
            <div style="font-size: 18px; font-weight: 600;">
                2026 DTF Quote Builder
                <span id="unsaved-indicator" class="unsaved-badge" style="display: none;">
                    <i class="fas fa-circle"></i> Unsaved
                </span>
            </div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 2px;">Direct-to-Film Transfers</div>
        </div>
        <div class="header-actions">
            <button class="btn-header btn-new-quote" onclick="confirmNewQuote()">
                <i class="fas fa-plus"></i> New Quote
            </button>
            <button class="btn-header" onclick="window.location.href='/staff-dashboard.html'">
                <i class="fas fa-arrow-left"></i> Dashboard
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="power-main dtf-quote-builder">
        <!-- Left: Content Area -->
        <div class="power-content">
            <!-- Location Selection Section -->
            <div class="location-config-section">
                <div class="location-header">
                    <span class="location-label"><i class="fas fa-map-marker-alt"></i> Transfer Locations</span>
                    <span class="location-hint">Choose ONE front location and/or ONE back location. Sleeves can be added to either.</span>
                </div>

                <!-- Location Columns (Radio-based like DTG) -->
                <div class="location-columns">
                    <!-- FRONT Column (Radio) -->
                    <div class="location-column">
                        <div class="column-header">FRONT (pick one)</div>
                        <label class="location-radio">
                            <input type="radio" name="front-location" value="" checked>
                            <span>None</span>
                        </label>
                        <label class="location-radio">
                            <input type="radio" name="front-location" value="left-chest" data-size="Small">
                            <span>Left Chest <small>(5"x5")</small></span>
                        </label>
                        <label class="location-radio">
                            <input type="radio" name="front-location" value="right-chest" data-size="Small">
                            <span>Right Chest <small>(5"x5")</small></span>
                        </label>
                        <label class="location-radio">
                            <input type="radio" name="front-location" value="center-front" data-size="Medium">
                            <span>Center Front <small>(9"x12")</small></span>
                        </label>
                        <label class="location-radio">
                            <input type="radio" name="front-location" value="full-front" data-size="Large">
                            <span>Full Front <small>(12"x16.5")</small></span>
                        </label>
                    </div>

                    <!-- BACK Column (Radio) -->
                    <div class="location-column">
                        <div class="column-header">BACK (optional)</div>
                        <label class="location-radio">
                            <input type="radio" name="back-location" value="" checked>
                            <span>None</span>
                        </label>
                        <label class="location-radio">
                            <input type="radio" name="back-location" value="back-of-neck" data-size="Small">
                            <span>Back of Neck <small>(5"x5")</small></span>
                        </label>
                        <label class="location-radio">
                            <input type="radio" name="back-location" value="center-back" data-size="Medium">
                            <span>Center Back <small>(9"x12")</small></span>
                        </label>
                        <label class="location-radio">
                            <input type="radio" name="back-location" value="full-back" data-size="Large">
                            <span>Full Back <small>(12"x16.5")</small></span>
                        </label>
                    </div>

                    <!-- SLEEVES Column (Checkboxes) -->
                    <div class="location-column">
                        <div class="column-header">SLEEVES (add-on)</div>
                        <label class="location-checkbox">
                            <input type="checkbox" name="sleeve-location" value="left-sleeve" data-size="Small">
                            <span>Left Sleeve <small>(5"x5")</small></span>
                        </label>
                        <label class="location-checkbox">
                            <input type="checkbox" name="sleeve-location" value="right-sleeve" data-size="Small">
                            <span>Right Sleeve <small>(5"x5")</small></span>
                        </label>
                    </div>
                </div>

                <!-- Selected Locations Summary -->
                <div class="location-summary" id="location-summary">
                    <strong>Selected:</strong> <span id="location-display">None selected</span>
                </div>
            </div>

            <!-- Product Grid Section -->
            <div class="product-grid-section">
                <!-- Search Row -->
                <div class="search-row">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               id="product-search"
                               class="search-input"
                               placeholder="Search by style # (e.g., PC54, G500) or product name"
                               autocomplete="off">
                        <div id="search-suggestions" class="search-suggestions"></div>
                    </div>
                    <span class="search-hint" id="search-hint">Select locations above to see pricing (products can be added now)</span>
                </div>

                <!-- Minimum Order Warning Banner -->
                <div id="min-order-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Minimum Order: 10 pieces required.</strong>
                    Orders of 10-23 pieces include a $50 Less Than Minimum Fee.
                </div>

                <!-- Excel-Style Product Table -->
                <div class="product-table-wrapper">
                    <table class="product-table" id="product-table">
                        <thead>
                            <tr>
                                <th class="style-col">Style</th>
                                <th class="thumbnail-col"></th>
                                <th class="desc-col">Description</th>
                                <th class="color-col">Color</th>
                                <th class="size-col">S</th>
                                <th class="size-col">M</th>
                                <th class="size-col">L</th>
                                <th class="size-col">XL</th>
                                <th class="size-col">2XL</th>
                                <th class="size-col extended-col" style="line-height: 1.1;" title="Click to add extended sizes (3XL, 4XL, 5XL, etc.)">More<br><span style="font-size: 10px; font-weight: 400;">Sizes</span></th>
                                <th class="qty-col">Qty</th>
                                <th class="price-col">Unit $</th>
                                <th class="total-col">Total</th>
                                <th class="actions-col"></th>
                            </tr>
                        </thead>
                        <tbody id="product-tbody">
                            <!-- Empty State Message - shown until products added -->
                            <tr id="empty-state-row">
                                <td colspan="14" style="text-align: center; padding: 40px 20px; color: #64748b; background: #f8fafc;">
                                    <div style="font-size: 32px; margin-bottom: 12px;">&#128085;</div>
                                    <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Enter a style number to get started</div>
                                    <div style="font-size: 13px; color: #94a3b8;">Type a style # in the search bar above (e.g., PC54, G500, C112)</div>
                                </td>
                            </tr>
                            <!-- Product rows will be added here -->
                        </tbody>
                        <!-- Fee Summary Section (auto-populated by JS) -->
                        <tbody id="fees-tbody" class="fee-summary-section">
                            <tr id="ltm-fee-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-info-circle"></i> Less Than Minimum Fee
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price">$50.00</td>
                                <td class="cell-total" id="ltm-row-total">$50.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <tr id="art-charge-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-palette"></i> Art Charge (Logo Mockup & Review)
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="art-charge-unit">$0.00</td>
                                <td class="cell-total" id="art-charge-total">$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <tr id="graphic-design-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-pencil-ruler"></i> Graphic Design (<span id="design-hours-label">0</span> hrs × $75)
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="graphic-design-unit">$0.00</td>
                                <td class="cell-total" id="graphic-design-total-row">$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <tr id="rush-fee-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-bolt"></i> Rush Fee
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="rush-fee-unit">$0.00</td>
                                <td class="cell-total" id="rush-fee-total">$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                            <tr id="discount-row" class="fee-row" style="display: none;">
                                <td colspan="10" class="fee-label">
                                    <i class="fas fa-tag"></i> Discount <span id="discount-reason-label"></span>
                                </td>
                                <td class="cell-qty">1</td>
                                <td class="cell-price" id="discount-unit">-$0.00</td>
                                <td class="cell-total" id="discount-total">-$0.00</td>
                                <td class="cell-actions"></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Empty State -->
                    <div class="empty-table-message" id="empty-table-message" style="display: none;">
                        <i class="fas fa-box-open"></i>
                        <p>No products added yet</p>
                        <span>Type a style number or search above</span>
                    </div>
                </div>

                <!-- Add Product Button -->
                <button class="add-row-btn" onclick="addNewRow()">
                    <i class="fas fa-plus"></i> Add Product (or press Tab from last cell)
                </button>

                <!-- Keyboard Hints -->
                <div class="keyboard-hint">
                    <kbd>Tab</kbd> Next cell &nbsp;|&nbsp;
                    <kbd>Enter</kbd> Next row &nbsp;|&nbsp;
                    <kbd>Ctrl+S</kbd> Save &nbsp;|&nbsp;
                    <kbd>Ctrl+P</kbd> Print PDF
                </div>
            </div>
        </div>

        <!-- Right: Pricing Sidebar (DTG Style) -->
        <div class="power-sidebar" id="power-sidebar">
            <!-- Resize handle for dragging sidebar width -->
            <div class="sidebar-resize-handle" id="sidebar-resize-handle"></div>
            <!-- Scrollable content container -->
            <div class="sidebar-scroll-container">
            <!-- Pricing Panel -->
            <div class="pricing-panel">
                <div class="pricing-title">
                    <i class="fas fa-calculator"></i> Quote Summary
                </div>

                <div class="pricing-row">
                    <span class="label">Print Location:</span>
                    <span class="value" id="sidebar-location">-</span>
                </div>

                <div class="pricing-row">
                    <span class="label">Total Pieces:</span>
                    <span class="value" id="total-qty">0</span>
                </div>

                <div class="pricing-row">
                    <span class="label">Pricing Tier:</span>
                    <span class="tier-badge" id="pricing-tier">10-23</span>
                </div>

                <div class="pricing-row">
                    <span class="label">Products Subtotal:</span>
                    <span class="value" id="subtotal">$0.00</span>
                </div>

                <!-- Tax Section -->
                <div class="pricing-totals-section">
                    <div class="pricing-row">
                        <span class="label" style="font-weight: 600;">Subtotal:</span>
                        <span class="value" id="pre-tax-subtotal">$0.00</span>
                    </div>
                    <div class="pricing-row" id="tax-toggle-row">
                        <label class="d-flex align-items-center gap-2">
                            <input type="checkbox" id="include-tax" checked onchange="updateTaxCalculation()">
                            <span>Include WA Sales Tax (10.1%)</span>
                        </label>
                    </div>
                    <div class="pricing-row" id="tax-row">
                        <span class="label text-muted">WA Sales Tax:</span>
                        <span class="value" id="tax-amount">$0.00</span>
                    </div>
                    <div class="pricing-row grand-total-row">
                        <span class="label">TOTAL:</span>
                        <span class="value" id="grand-total-with-tax">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Artwork Services Panel -->
            <div class="additional-charges-panel">
                <div class="charges-header" onclick="toggleArtworkServices()">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-palette"></i>
                        <span>Artwork Services</span>
                        <span id="artwork-badge" class="charges-badge hidden">$0.00</span>
                    </div>
                    <i id="artwork-chevron" class="fas fa-chevron-down collapsible-chevron"></i>
                </div>
                <div id="artwork-content" class="charges-content hidden">
                    <div class="charge-field">
                        <label class="d-flex align-items-center gap-2" style="cursor: pointer;">
                            <input type="checkbox" id="art-charge-toggle" onchange="toggleArtCharge()">
                            <span>Logo Mockup & Review</span>
                        </label>
                        <div class="input-with-prefix" id="art-charge-wrapper" style="opacity: 0.4;">
                            <span class="prefix">$</span>
                            <input type="number" id="art-charge" class="quote-input"
                                   min="0" step="0.01" value="0" disabled
                                   onchange="updateArtworkCharges()" oninput="updateArtworkCharges()">
                        </div>
                    </div>
                    <div class="charge-field">
                        <label class="quote-label">Graphic Design ($75/hr)</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" id="graphic-design-hours" class="quote-input" style="width: 80px;"
                                   min="0" step="0.5" placeholder="0"
                                   onchange="updateArtworkCharges()" oninput="updateArtworkCharges()">
                            <span class="text-muted">hrs</span>
                            <span class="text-muted">= $<span id="graphic-design-total">0.00</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Charges Panel -->
            <div class="additional-charges-panel">
                <div class="charges-header" onclick="toggleAdditionalCharges()">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-plus-circle"></i>
                        <span>Additional Charges</span>
                        <span id="charges-badge" class="charges-badge hidden">$0.00</span>
                    </div>
                    <i id="charges-chevron" class="fas fa-chevron-down collapsible-chevron"></i>
                </div>
                <div id="charges-content" class="charges-content hidden">
                    <div class="charge-field">
                        <label class="quote-label">Rush Fee</label>
                        <div class="input-with-prefix">
                            <span class="prefix">$</span>
                            <input type="number" id="rush-fee" class="quote-input"
                                   min="0" step="0.01" placeholder="0.00"
                                   onchange="updateAdditionalCharges()">
                        </div>
                    </div>
                    <div class="charge-field discount-field">
                        <label class="quote-label">Discount</label>
                        <div class="d-flex gap-2">
                            <div class="input-with-prefix flex-1" id="discount-input-wrapper">
                                <span class="prefix" id="discount-prefix">$</span>
                                <input type="number" id="discount-amount" class="quote-input"
                                       min="0" step="0.01" placeholder="0.00"
                                       onchange="updateAdditionalCharges()">
                            </div>
                            <select id="discount-preset" class="quote-input" style="flex: 1; display: none;"
                                    onchange="handleDiscountPresetChange()">
                                <option value="5">5%</option>
                                <option value="10" selected>10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <select id="discount-type" class="quote-input" style="width: auto;"
                                    onchange="updateDiscountType()">
                                <option value="fixed">$</option>
                                <option value="percent">%</option>
                            </select>
                        </div>
                        <input type="text" id="discount-reason" class="quote-input mt-2"
                               placeholder="Reason (optional)"
                               oninput="updateFeeTableRows()">
                    </div>
                </div>
            </div>

            <!-- Save & Share Section (Collapsible) -->
            <div class="save-quote-panel-collapsible">
                <div class="save-quote-header" onclick="toggleSaveShare()">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-share-alt"></i>
                        <span>Save & Share</span>
                    </div>
                    <i id="save-share-chevron" class="fas fa-chevron-down collapsible-chevron"></i>
                </div>
                <div id="save-share-content" class="save-share-content">
                    <div class="customer-fields d-flex flex-column gap-3">
                        <!-- Customer Lookup -->
                        <div class="customer-field customer-lookup-container">
                            <label class="quote-label"><i class="fas fa-search" style="margin-right: 4px;"></i> Find Customer</label>
                            <input type="text" id="customer-lookup" placeholder="Search by company, name, or email..." class="quote-input customer-lookup-input">
                        </div>
                        <div class="customer-lookup-divider">or enter manually</div>
                        <div class="customer-field">
                            <label class="quote-label">Name *</label>
                            <input type="text" id="customer-name" placeholder="Customer name" class="quote-input">
                        </div>
                        <div class="customer-field">
                            <label class="quote-label">Email *</label>
                            <input type="email" id="customer-email" placeholder="email@company.com" class="quote-input">
                        </div>
                        <div class="customer-field">
                            <label class="quote-label">Company</label>
                            <input type="text" id="company-name" placeholder="Company name" class="quote-input">
                        </div>
                        <div class="customer-field">
                            <label class="quote-label">Sales Rep</label>
                            <select id="sales-rep" class="quote-input" style="background: white;">
                                <option value="sales@nwcustomapparel.com">General Sales</option>
                                <option value="adriyella@nwcustomapparel.com">Adriyella</option>
                                <option value="bradley@nwcustomapparel.com">Bradley Wright</option>
                                <option value="erik@nwcustomapparel.com">Erik Mickelson</option>
                                <option value="jim@nwcustomapparel.com">Jim Mickelson</option>
                                <option value="nika@nwcustomapparel.com">Nika Lao</option>
                                <option value="ruth@nwcustomapparel.com">Ruth Nhong</option>
                                <option value="art@nwcustomapparel.com">Steve Deland</option>
                                <option value="taneisha@nwcustomapparel.com">Taneisha Clark</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-save-quote" onclick="dtfQuoteBuilder.saveAndGetLink()" style="margin-top: 12px; width: 100%; padding: 12px; background: linear-gradient(135deg, #4cb354, #409a47); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-link"></i> Save & Get Shareable Link
                    </button>
                </div>
            </div>

            </div><!-- End sidebar-scroll-container -->

            <!-- Action Buttons (DTG Style) -->
            <div class="action-panel">
                <button class="btn-action btn-primary-action" onclick="copyQuoteToClipboard()">
                    <i class="fas fa-copy"></i> Copy Quote to Clipboard
                </button>
                <button class="btn-action btn-secondary-action" onclick="printQuote()">
                    <i class="fas fa-print"></i> Print Quote
                </button>
            </div>
        </div>
    </div>

    <!-- Extended Size Picker Backdrop -->
    <div id="size-popup-backdrop" class="size-popup-backdrop hidden" onclick="closeExtendedSizePopup()"></div>

    <!-- Extended Size Picker Popup -->
    <div id="extended-size-popup" class="size-popup hidden">
        <div class="size-popup-header">
            <h4><i class="fas fa-ruler"></i> Extended Sizes</h4>
            <button class="close-popup" onclick="closeExtendedSizePopup()" aria-label="Close extended sizes popup">&times;</button>
        </div>
        <div class="size-popup-body" id="size-popup-body">
            <!-- Dynamic content will be inserted here -->
        </div>
        <div class="size-popup-footer">
            <button class="btn-cancel" onclick="closeExtendedSizePopup()">Cancel</button>
            <button class="btn-apply" onclick="applyExtendedSizes()">Apply</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Exact Match Search Module -->
    <script src="/shared_components/js/exact-match-search.js?v=20251023"></script>

    <!-- Shared Quote Share Modal (2026 consolidation) -->
    <script src="/shared_components/js/quote-share-modal.js?v=20260113"></script>

    <!-- DTF Quote Builder Scripts (4 files - consolidated architecture) -->
    <!-- Shared Quote Builder Components (2026 Consolidation) -->
    <script src="/shared_components/js/extended-sizes-config.js?v=20260107"></script>

    <!-- Auto-Save & Draft Recovery (2026 consolidation) -->
    <script src="/shared_components/js/quote-persistence.js?v=20260113"></script>
    <script src="/shared_components/js/quote-session.js?v=20260113"></script>

    <!-- Staff Authentication Helper (auto-select sales rep) -->
    <script src="/shared_components/js/staff-auth-helper.js?v=20260113"></script>

    <!-- Customer Lookup Autocomplete -->
    <script src="/shared_components/js/customer-lookup-service.js?v=20260129"></script>

    <!-- Sidebar Resize (2026 UX improvement) -->
    <script src="/shared_components/js/sidebar-resize.js?v=20260127"></script>

    <!-- Invoice Generator (for professional PDF output) -->
    <script src="/shared_components/js/embroidery-quote-invoice.js?v=20260111"></script>

    <!-- DTF-specific Scripts -->
    <script src="/shared_components/js/product-category-filter.js?v=20260127"></script>
    <script src="/shared_components/js/dtf-quote-pricing.js?v=20260106r"></script>
    <script src="/shared_components/js/dtf-quote-products.js?v=20260127"></script>
    <script src="/shared_components/js/dtf-quote-service.js?v=20260106r"></script>
    <script src="/shared_components/js/dtf-quote-builder.js?v=20260112c"></script>

    <script>
        // Global functions for onclick handlers (dtfQuoteBuilder is declared in external JS)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DTF Quote Builder: Inline init complete');

            // Setup keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Escape = Close popups
                if (e.key === 'Escape') {
                    const sizePopup = document.getElementById('extended-size-popup');
                    if (sizePopup && !sizePopup.classList.contains('hidden')) {
                        e.preventDefault();
                        closeExtendedSizePopup();
                        return;
                    }
                }

                // Ctrl+S = Save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (dtfQuoteBuilder) dtfQuoteBuilder.saveQuote();
                }

                // Ctrl+P = Print
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    if (dtfQuoteBuilder) dtfQuoteBuilder.printQuote();
                }
            });
        });

        // Extended size popup functions
        function openExtendedSizePopup(productId) {
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.openExtendedSizePopup(productId);
            }
        }

        function closeExtendedSizePopup() {
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.closeExtendedSizePopup();
            }
        }

        function applyExtendedSizes() {
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.applyExtendedSizes();
            }
        }

        function focusProductSearch() {
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.focusProductSearch();
            }
        }

        // ============================================
        // TAX CALCULATION & ADDITIONAL CHARGES
        // ============================================

        function updateTaxCalculation() {
            const includeTax = document.getElementById('include-tax')?.checked;
            const subtotalEl = document.getElementById('pre-tax-subtotal');
            const taxRowEl = document.getElementById('tax-row');
            const taxAmountEl = document.getElementById('tax-amount');
            const grandTotalEl = document.getElementById('grand-total-with-tax');

            // Get base subtotal from pricing
            let subtotal = parseFloat(subtotalEl?.textContent?.replace(/[$,]/g, '') || 0);

            // Add art charge if enabled
            const artChargeToggle = document.getElementById('art-charge-toggle');
            const artCharge = artChargeToggle?.checked ? parseFloat(document.getElementById('art-charge')?.value || 0) : 0;
            subtotal += artCharge;

            // Add graphic design fee
            const designHours = parseFloat(document.getElementById('graphic-design-hours')?.value || 0);
            const designFee = designHours * 75;
            subtotal += designFee;

            // Add rush fee if present
            const rushFee = parseFloat(document.getElementById('rush-fee')?.value || 0);
            subtotal += rushFee;

            // Subtract discount if present
            const discountAmount = parseFloat(document.getElementById('discount-amount')?.value || 0);
            const discountType = document.getElementById('discount-type')?.value || 'fixed';
            let discount = 0;
            if (discountType === 'percent') {
                discount = subtotal * (discountAmount / 100);
            } else {
                discount = discountAmount;
            }
            subtotal = Math.max(0, subtotal - discount);

            // Update the pre-tax subtotal display to show adjusted amount
            if (subtotalEl) {
                subtotalEl.textContent = '$' + subtotal.toFixed(2);
            }

            const taxRate = 0.101; // 10.1% WA sales tax

            if (includeTax) {
                const tax = subtotal * taxRate;
                const total = subtotal + tax;
                taxRowEl.style.display = 'flex';
                taxAmountEl.textContent = '$' + tax.toFixed(2);
                grandTotalEl.textContent = '$' + total.toFixed(2);
            } else {
                taxRowEl.style.display = 'none';
                grandTotalEl.textContent = '$' + subtotal.toFixed(2);
            }
        }

        function toggleAdditionalCharges() {
            const content = document.getElementById('charges-content');
            const chevron = document.getElementById('charges-chevron');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function updateAdditionalCharges() {
            const rushFee = parseFloat(document.getElementById('rush-fee')?.value || 0);
            const discountAmount = parseFloat(document.getElementById('discount-amount')?.value || 0);
            const badge = document.getElementById('charges-badge');

            const netCharges = rushFee - discountAmount;
            if (netCharges !== 0) {
                badge.textContent = (netCharges >= 0 ? '+' : '') + '$' + netCharges.toFixed(2);
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // Update fee table rows
            updateFeeTableRows();

            // Recalculate tax with new charges
            updateTaxCalculation();
        }

        function updateDiscountType() {
            const discountType = document.getElementById('discount-type')?.value;
            const prefix = document.getElementById('discount-prefix');
            const inputWrapper = document.getElementById('discount-input-wrapper');
            const presetDropdown = document.getElementById('discount-preset');
            const amountInput = document.getElementById('discount-amount');

            if (discountType === 'percent') {
                // Show preset dropdown, hide number input
                if (inputWrapper) inputWrapper.style.display = 'none';
                if (presetDropdown) presetDropdown.style.display = 'block';
                // Set amount from preset (unless custom is selected)
                if (presetDropdown && presetDropdown.value !== 'custom') {
                    if (amountInput) amountInput.value = presetDropdown.value;
                }
            } else {
                // Show number input, hide preset dropdown
                if (inputWrapper) inputWrapper.style.display = 'flex';
                if (presetDropdown) presetDropdown.style.display = 'none';
                if (prefix) prefix.textContent = '$';
            }

            updateAdditionalCharges();
        }

        function handleDiscountPresetChange() {
            const preset = document.getElementById('discount-preset')?.value;
            const inputWrapper = document.getElementById('discount-input-wrapper');
            const amountInput = document.getElementById('discount-amount');
            const prefix = document.getElementById('discount-prefix');

            if (preset === 'custom') {
                // Show number input for custom entry
                if (inputWrapper) inputWrapper.style.display = 'flex';
                if (prefix) prefix.textContent = '%';
                if (amountInput) amountInput.focus();
            } else {
                // Use preset value
                if (inputWrapper) inputWrapper.style.display = 'none';
                if (amountInput) amountInput.value = preset;
            }
            updateFeeTableRows();
        }

        // ============================================
        // ARTWORK SERVICES FUNCTIONS
        // ============================================

        function toggleArtworkServices() {
            const content = document.getElementById('artwork-content');
            const chevron = document.getElementById('artwork-chevron');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function toggleArtCharge() {
            const toggle = document.getElementById('art-charge-toggle');
            const input = document.getElementById('art-charge');
            const wrapper = document.getElementById('art-charge-wrapper');

            if (toggle.checked) {
                input.disabled = false;
                wrapper.style.opacity = '1';
                if (parseFloat(input.value) === 0) {
                    input.value = '50.00';
                }
            } else {
                input.disabled = true;
                wrapper.style.opacity = '0.4';
                input.value = '0';
            }
            updateArtworkCharges();
        }

        function updateArtworkCharges() {
            const artCharge = parseFloat(document.getElementById('art-charge')?.value || 0);
            const designHours = parseFloat(document.getElementById('graphic-design-hours')?.value || 0);
            const designTotal = designHours * 75;

            // Update graphic design total display
            const designTotalEl = document.getElementById('graphic-design-total');
            if (designTotalEl) {
                designTotalEl.textContent = designTotal.toFixed(2);
            }

            // Update artwork badge
            const badge = document.getElementById('artwork-badge');
            const totalArtwork = artCharge + designTotal;
            if (totalArtwork > 0) {
                badge.textContent = '+$' + totalArtwork.toFixed(2);
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // Update table rows
            updateFeeTableRows();

            // Recalculate tax
            updateTaxCalculation();
        }

        function updateFeeTableRows() {
            // Art charge row
            const artChargeRow = document.getElementById('art-charge-row');
            const artChargeToggle = document.getElementById('art-charge-toggle');
            const artCharge = parseFloat(document.getElementById('art-charge')?.value || 0);
            if (artChargeRow) {
                if (artChargeToggle?.checked && artCharge > 0) {
                    artChargeRow.style.display = 'table-row';
                    document.getElementById('art-charge-unit').textContent = '$' + artCharge.toFixed(2);
                    document.getElementById('art-charge-total').textContent = '$' + artCharge.toFixed(2);
                } else {
                    artChargeRow.style.display = 'none';
                }
            }

            // Graphic design row
            const graphicDesignRow = document.getElementById('graphic-design-row');
            const designHours = parseFloat(document.getElementById('graphic-design-hours')?.value || 0);
            const designTotal = designHours * 75;
            if (graphicDesignRow) {
                if (designHours > 0) {
                    graphicDesignRow.style.display = 'table-row';
                    document.getElementById('design-hours-label').textContent = designHours;
                    document.getElementById('graphic-design-unit').textContent = '$' + designTotal.toFixed(2);
                    document.getElementById('graphic-design-total-row').textContent = '$' + designTotal.toFixed(2);
                } else {
                    graphicDesignRow.style.display = 'none';
                }
            }

            // Rush fee row
            const rushFeeRow = document.getElementById('rush-fee-row');
            const rushFee = parseFloat(document.getElementById('rush-fee')?.value || 0);
            if (rushFeeRow) {
                if (rushFee > 0) {
                    rushFeeRow.style.display = 'table-row';
                    document.getElementById('rush-fee-unit').textContent = '$' + rushFee.toFixed(2);
                    document.getElementById('rush-fee-total').textContent = '$' + rushFee.toFixed(2);
                } else {
                    rushFeeRow.style.display = 'none';
                }
            }

            // Discount row
            const discountRow = document.getElementById('discount-row');
            const discountAmount = parseFloat(document.getElementById('discount-amount')?.value || 0);
            const discountType = document.getElementById('discount-type')?.value || 'fixed';
            const discountReason = document.getElementById('discount-reason')?.value || '';
            if (discountRow) {
                if (discountAmount > 0) {
                    discountRow.style.display = 'table-row';
                    let actualDiscount = discountAmount;
                    if (discountType === 'percent') {
                        // Calculate discountable subtotal (products + additional services)
                        const productsSubtotal = parseFloat(document.getElementById('subtotal')?.textContent?.replace(/[$,]/g, '') || 0);
                        const artCharge = document.getElementById('art-charge-toggle')?.checked
                            ? parseFloat(document.getElementById('art-charge')?.value || 0) : 0;
                        const designFee = parseFloat(document.getElementById('graphic-design-hours')?.value || 0) * 75;
                        const rushFee = parseFloat(document.getElementById('rush-fee')?.value || 0);
                        const ltmFee = document.getElementById('ltm-fee-row')?.style.display !== 'none'
                            ? parseFloat(document.getElementById('ltm-row-total')?.textContent?.replace(/[$,]/g, '') || 0) : 0;

                        const discountableSubtotal = productsSubtotal + artCharge + designFee + rushFee + ltmFee;
                        actualDiscount = discountableSubtotal * (discountAmount / 100);
                    }
                    const reasonLabel = document.getElementById('discount-reason-label');
                    if (reasonLabel) {
                        let labelParts = [];
                        if (discountType === 'percent') {
                            labelParts.push(`${discountAmount}%`);
                        }
                        if (discountReason) {
                            labelParts.push(discountReason);
                        }
                        reasonLabel.textContent = labelParts.length > 0 ? `(${labelParts.join(' - ')})` : '';
                    }
                    document.getElementById('discount-unit').textContent = '-$' + actualDiscount.toFixed(2);
                    document.getElementById('discount-total').textContent = '-$' + actualDiscount.toFixed(2);
                } else {
                    discountRow.style.display = 'none';
                }
            }
        }

        function toggleSaveShare() {
            const content = document.getElementById('save-share-content');
            const chevron = document.getElementById('save-share-chevron');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // ============================================
        // New Quote Functionality (UX Improvement)
        // ============================================

        /**
         * Wrapper function for header button - calls class method
         */
        function confirmNewQuote() {
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.confirmNewQuote();
            }
        }

        // ============================================================
        // ROW-BASED INPUT FUNCTIONS (Match other quote builders)
        // ============================================================

        // Use centralized config (fallback to hardcoded URL for backwards compatibility)
        const API_BASE = window.APP_CONFIG?.API?.BASE_URL || 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com';
        // REMOVED: let rowCounter = 0; - now using dtfQuoteBuilder.getNextRowId() for all rows
        // This prevents ID collisions between parent and child rows
        const productCache = {};

        // Child row tracking (like DTG/Embroidery pattern)
        // Using var so it's accessible globally for dtf-quote-builder.js class
        var childRowMap = {};  // { parentRowId: { '2XL': childRowId, '3XL': childRowId } }
        window.childRowMap = childRowMap;  // Expose to JS class

        // Use shared ExtendedSizesConfig module (2026 consolidation)
        // REQUIRED - no fallback. Shows error if module not loaded.
        if (!window.ExtendedSizesConfig) {
            console.error('❌ ExtendedSizesConfig module not loaded! Check script includes.');
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #c00;">
                    <h2>Configuration Error</h2>
                    <p>Extended sizes module failed to load. Please refresh the page.</p>
                    <p style="font-size: 12px; color: #666;">If this persists, contact support.</p>
                </div>
            `;
            throw new Error('ExtendedSizesConfig module required but not loaded');
        }
        // SIZE_TO_SUFFIX and EXTENDED_SIZE_ORDER are now accessed via
        // window.ExtendedSizesConfig.* to avoid duplicate const declarations
        // (extended-sizes-config.js declares them at global scope)

        /**
         * Add a new empty row for user to type style number
         * Matches pattern from DTG/Embroidery/Screen Print quote builders
         */
        function addNewRow() {
            const tbody = document.getElementById('product-tbody');
            // Use shared counter from JS class to prevent ID collisions with child rows
            const rowId = dtfQuoteBuilder.getNextRowId();

            // Hide empty state message when adding first row
            const emptyStateRow = document.getElementById('empty-state-row');
            if (emptyStateRow) emptyStateRow.style.display = 'none';

            const row = document.createElement('tr');
            row.id = `row-${rowId}`;
            row.className = 'new-row';
            row.dataset.rowId = rowId;
            row.dataset.productId = rowId;  // Match what updatePricing() expects

            row.innerHTML = `
                <td>
                    <input type="text" class="cell-input style-input"
                           placeholder="Style #"
                           data-field="style"
                           onchange="onStyleChange(this, ${rowId})"
                           onkeydown="handleCellKeydown(event, this)">
                </td>
                <td class="thumbnail-col">
                    <div class="product-thumbnail no-image" id="thumb-${rowId}"
                         title="Select a color to see product image"
                         style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;"></div>
                </td>
                <td class="desc-cell">
                    <div class="desc-row">
                        <input type="text" class="cell-input desc-input"
                               placeholder="(auto)"
                               data-field="description"
                               readonly>
                    </div>
                    <div class="pricing-breakdown" id="breakdown-${rowId}"></div>
                </td>
                <td>
                    <div class="color-picker-wrapper" data-row-id="${rowId}">
                        <div class="color-picker-selected disabled" onclick="toggleColorPicker(${rowId})" tabindex="0" onkeydown="handleColorPickerKeydown(event, ${rowId})">
                            <span class="color-swatch empty"></span>
                            <span class="color-name placeholder">Select color...</span>
                            <i class="fas fa-chevron-down picker-arrow"></i>
                        </div>
                        <div class="color-picker-dropdown hidden" id="color-dropdown-${rowId}"></div>
                    </div>
                </td>
                <td><input type="number" class="cell-input size-input" data-size="S" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled aria-label="Quantity for size Small"></td>
                <td><input type="number" class="cell-input size-input" data-size="M" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled aria-label="Quantity for size Medium"></td>
                <td><input type="number" class="cell-input size-input" data-size="L" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled aria-label="Quantity for size Large"></td>
                <td><input type="number" class="cell-input size-input" data-size="XL" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled aria-label="Quantity for size Extra Large"></td>
                <td><input type="number" class="cell-input size-input" data-size="2XL" min="0" value="" placeholder="0" onchange="onSizeChange(${rowId})" onkeydown="handleCellKeydown(event, this)" disabled aria-label="Quantity for size 2XL"></td>
                <td><input type="text" class="cell-input size-input xxxl-picker-btn" data-size="3XL" value="" placeholder="+" readonly onclick="openExtendedSizePopup(${rowId})" onkeydown="if(event.key==='Enter'){openExtendedSizePopup(${rowId})}" disabled title="Click to add extended sizes (3XL, 4XL, 5XL, XS, etc.)" aria-label="Open extended sizes picker for 3XL and larger"></td>
                <td class="cell-qty" id="row-qty-${rowId}">0</td>
                <td class="cell-price" id="row-price-${rowId}">-</td>
                <td class="cell-total" id="row-total-${rowId}">-</td>
                <td class="cell-actions">
                    <button class="btn-delete-row" onclick="deleteRow(${rowId})" title="Delete row" aria-label="Delete product row">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);

            // Focus on the style input
            setTimeout(() => {
                row.querySelector('.style-input').focus();
            }, 50);

            // Remove the "new-row" highlight after a moment
            setTimeout(() => {
                row.classList.remove('new-row');
            }, 1000);
        }
        // Expose to window for JS class access
        window.addNewRow = addNewRow;

        /**
         * Handle style number change - fetch product data
         */
        async function onStyleChange(input, rowId) {
            const styleNumber = input.value.trim().toUpperCase();
            if (!styleNumber) return;

            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;

            // Skip if this is a child row (child rows don't have editable style/description inputs)
            if (row.classList.contains('child-row')) return;

            const descInput = row.querySelector('[data-field="description"]');
            const pickerSelected = row.querySelector('.color-picker-selected');
            const pickerDropdown = row.querySelector('.color-picker-dropdown');

            try {
                // Fetch product details, colors, AND pricing bundle
                // NOTE: Use method=BLANK (not DTF) to get sellingPriceDisplayAddOns for size upcharges
                // DTF pricing-bundle returns empty sellingPriceDisplayAddOns because garment data is separate
                // NOTE: Changed to /api/product-colors (same as DTG/Screen Print/Embroidery) which returns MAIN_IMAGE_URL
                const [detailsResponse, colorsResponse, blankBundleResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/product-details?styleNumber=${styleNumber}`),
                    fetch(`${API_BASE}/api/product-colors?styleNumber=${styleNumber}`),
                    fetch(`${API_BASE}/api/pricing-bundle?method=BLANK&styleNumber=${styleNumber}`)
                ]);

                const details = await detailsResponse.json();
                const colorsData = await colorsResponse.json();
                const blankBundle = await blankBundleResponse.json();

                // product-colors returns { colors: [...] } wrapper
                const colors = colorsData.colors || [];

                const firstDetail = Array.isArray(details) ? details[0] : details;

                if (firstDetail) {
                    // Clean product title
                    const cleanTitle = cleanProductTitle(firstDetail.PRODUCT_TITLE, styleNumber);
                    if (descInput) descInput.value = cleanTitle || styleNumber;

                    // Store data on row
                    row.dataset.style = styleNumber;
                    row.dataset.productName = cleanTitle || styleNumber;
                    row.dataset.baseCost = firstDetail.CASE_PRICE || 0;
                    // Store sizeUpcharges from BLANK bundle (has actual upcharge data)
                    // sellingPriceDisplayAddOns format: { "2XL": 2.00, "3XL": 3.00, "4XL": 4.00, ... }
                    const upcharges = blankBundle.sellingPriceDisplayAddOns || {};
                    row.dataset.sizeUpcharges = JSON.stringify(upcharges);
                    console.log(`[DTF] Loaded upcharges for ${styleNumber}:`, upcharges);

                    // Populate color picker (now includes MAIN_IMAGE_URL from product-colors API)
                    if (colors && colors.length > 0) {
                        pickerDropdown.innerHTML = colors.map(c => `
                            <div class="color-picker-option"
                                 data-color-name="${escapeHtml(c.COLOR_NAME)}"
                                 data-catalog-color="${escapeHtml(c.CATALOG_COLOR || c.COLOR_NAME)}"
                                 data-swatch-url="${escapeHtml(c.COLOR_SQUARE_IMAGE || '')}"
                                 data-hex="${escapeHtml(c.HEX_CODE || '#ccc')}"
                                 data-image-url="${escapeHtml(c.MAIN_IMAGE_URL || c.FRONT_MODEL || c.FRONT_FLAT || '')}"
                                 onclick="selectColor(${rowId}, this)">
                                <span class="color-swatch" style="${getSwatchStyle(c)}"></span>
                                <span class="color-name">${escapeHtml(c.COLOR_NAME)}</span>
                            </div>
                        `).join('');

                        pickerSelected.classList.remove('disabled');
                        row.dataset.colors = JSON.stringify(colors);
                    }
                } else {
                    if (descInput) descInput.value = 'Not found';
                    showToast(`Style ${styleNumber} not found`, 'error');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showToast('Error loading product', 'error');
            }
        }
        // Expose to window for JS class access
        window.onStyleChange = onStyleChange;

        /**
         * Handle keyboard navigation in cells
         */
        function handleCellKeydown(event, input) {
            const row = input.closest('tr');
            const cells = Array.from(row.querySelectorAll('input:not([readonly]):not(:disabled)'));
            const currentIndex = cells.indexOf(input);

            if (event.key === 'Tab' && !event.shiftKey) {
                // Tab to next cell
                if (currentIndex === cells.length - 1) {
                    // Last cell in row - add new row
                    event.preventDefault();
                    addNewRow();
                }
            } else if (event.key === 'Enter') {
                event.preventDefault();
                const tbody = document.getElementById('product-tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const currentRowIndex = rows.indexOf(row);

                if (currentRowIndex === rows.length - 1) {
                    addNewRow();
                } else {
                    // Focus same column in next row
                    const nextRow = rows[currentRowIndex + 1];
                    const nextCells = Array.from(nextRow.querySelectorAll('input:not([readonly]):not(:disabled)'));
                    if (nextCells[currentIndex]) {
                        nextCells[currentIndex].focus();
                    }
                }
            }
        }

        /**
         * Handle size input changes
         */
        function onSizeChange(rowId) {
            console.log(`[DEBUG onSizeChange] Called for row ${rowId}`);
            const row = document.getElementById(`row-${rowId}`);
            if (!row) {
                console.log(`[DEBUG onSizeChange] Row not found: row-${rowId}`);
                return;
            }

            // Skip if this is a child row (child rows use onChildSizeChange)
            if (row.classList.contains('child-row')) {
                console.log(`[DEBUG onSizeChange] Skipping child row ${rowId}`);
                if (dtfQuoteBuilder) dtfQuoteBuilder.recalculatePricing();
                return;
            }

            // Handle 2XL - auto-create child row when quantity entered
            const xxlInput = row.querySelector('[data-size="2XL"]');
            console.log(`[DEBUG onSizeChange] 2XL input:`, xxlInput ? `value=${xxlInput.value}, disabled=${xxlInput.disabled}` : 'not found');
            if (xxlInput && !xxlInput.disabled) {
                const qty = parseInt(xxlInput.value) || 0;
                const existingChildId = childRowMap[rowId]?.['2XL'];
                console.log(`[DEBUG onSizeChange] 2XL qty=${qty}, existingChildId=${existingChildId}`);

                if (qty > 0 && !existingChildId) {
                    // CREATE CHILD ROW for 2XL
                    console.log(`[DEBUG onSizeChange] Creating child row for 2XL qty=${qty}`);
                    createChildRow(rowId, '2XL', qty);
                    // Disable parent's 2XL input and CLEAR the value
                    xxlInput.disabled = true;
                    xxlInput.style.background = '#f5f5f5';
                    xxlInput.style.color = '#999';
                    xxlInput.value = '';  // Clear value so grayed input shows empty
                } else if (qty > 0 && existingChildId) {
                    // Update existing child row
                    const childRow = document.getElementById(`row-${existingChildId}`);
                    if (childRow) {
                        const childInput = childRow.querySelector('.extended-size-qty');
                        if (childInput) childInput.value = qty;
                        document.getElementById(`row-qty-${existingChildId}`).textContent = qty;
                    }
                }
            }

            // Calculate total quantity from standard sizes (S, M, L, XL)
            let total = 0;
            row.querySelectorAll('.size-input:not(.xxxl-picker-btn):not(:disabled)').forEach(input => {
                const size = input.dataset.size;
                // Skip 2XL - it's handled separately via child rows
                if (size !== '2XL') {
                    total += parseInt(input.value) || 0;
                }
            });

            // Add quantities from child rows
            const childRows = document.querySelectorAll(`tr[data-parent-row-id="${rowId}"]`);
            childRows.forEach(childRow => {
                const qtyDisplay = childRow.querySelector('.cell-qty');
                total += parseInt(qtyDisplay?.textContent) || 0;
            });

            // Update quantity display
            const qtyCell = document.getElementById(`row-qty-${rowId}`);
            if (qtyCell) qtyCell.textContent = total;

            // Trigger pricing recalculation via dtfQuoteBuilder
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.updatePricingFromRow(rowId, row);
            }
        }

        /**
         * Select a color from the picker (parent row)
         */
        function selectColor(rowId, optionEl) {
            const row = document.getElementById(`row-${rowId}`);
            const colorName = optionEl.dataset.colorName;
            const catalogColor = optionEl.dataset.catalogColor;
            const swatchUrl = optionEl.dataset.swatchUrl || '';
            const hex = optionEl.dataset.hex || '#ccc';
            const imageUrl = optionEl.dataset.imageUrl || '';
            const style = row.dataset.style;

            // Update display
            const pickerSelected = row.querySelector('.color-picker-selected');
            const swatch = pickerSelected.querySelector('.color-swatch');
            const nameSpan = pickerSelected.querySelector('.color-name');

            if (swatchUrl) {
                swatch.style.backgroundImage = `url('${swatchUrl}')`;
                swatch.style.backgroundColor = '';
                swatch.style.backgroundSize = 'cover';
            } else {
                swatch.style.backgroundImage = '';
                swatch.style.backgroundColor = hex;
            }
            swatch.classList.remove('empty');
            nameSpan.textContent = colorName;
            nameSpan.classList.remove('placeholder');

            // Store data on row
            row.dataset.color = colorName;
            row.dataset.catalogColor = catalogColor;
            row.dataset.swatchUrl = swatchUrl;
            row.dataset.hex = hex;
            row.dataset.imageUrl = imageUrl;

            // Update product thumbnail
            updateProductThumbnail(rowId, imageUrl, row.dataset.productName, style, colorName);

            // Close dropdown
            row.querySelector('.color-picker-dropdown').classList.add('hidden');

            // Cascade color to child rows (unless they have manually set colors)
            cascadeColorToChildRows(rowId, colorName, catalogColor, swatchUrl, hex);

            // Enable size inputs
            row.querySelectorAll('.size-input').forEach(input => input.disabled = false);

            // Focus first size
            const firstSize = row.querySelector('.size-input:not(.xxxl-picker-btn)');
            if (firstSize) firstSize.focus();
        }

        /**
         * Toggle color picker dropdown
         */
        function toggleColorPicker(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const dropdown = row.querySelector('.color-picker-dropdown');
            const selected = row.querySelector('.color-picker-selected');

            if (selected.classList.contains('disabled')) return;

            // Close all other dropdowns
            document.querySelectorAll('.color-picker-dropdown').forEach(d => {
                if (d !== dropdown) d.classList.add('hidden');
            });

            dropdown.classList.toggle('hidden');
        }

        /**
         * Handle keyboard events on color picker
         */
        function handleColorPickerKeydown(event, rowId) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleColorPicker(rowId);
            } else if (event.key === 'Escape') {
                const row = document.getElementById(`row-${rowId}`);
                row.querySelector('.color-picker-dropdown').classList.add('hidden');
            }
        }

        /**
         * Delete a row
         */
        function deleteRow(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (row) {
                // Also delete any child rows
                const childRows = document.querySelectorAll(`tr[data-parent-row-id="${rowId}"]`);
                childRows.forEach(childRow => {
                    const childId = parseInt(childRow.dataset.rowId);
                    childRow.remove();
                    if (dtfQuoteBuilder) {
                        dtfQuoteBuilder.removeProduct(childId);
                    }
                });
                // Clear child row tracking
                delete childRowMap[rowId];

                row.remove();
                if (dtfQuoteBuilder) {
                    dtfQuoteBuilder.removeProduct(rowId);
                    dtfQuoteBuilder.recalculatePricing();
                }
            }
        }

        // ============================================================
        // CHILD ROW FUNCTIONS (Extended Sizes - Like Embroidery/DTG)
        // ============================================================

        /**
         * Create a child row for an extended size (XXL, 3XL, 4XL, etc.)
         * @param {number} parentRowId - ID of the parent row
         * @param {string} size - Size name (XXL, 3XL, 4XL, 5XL, 6XL, XS)
         * @param {number} qty - Quantity for this size
         */
        function createChildRow(parentRowId, size, qty) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow) {
                console.error('[DTF] Cannot create child row: parent not found', parentRowId);
                return null;
            }

            // Use shared counter from JS class to prevent ID collisions with parent rows
            const childRowId = dtfQuoteBuilder.getNextRowId();
            const baseStyle = parentRow.dataset.style || '';
            const suffix = window.ExtendedSizesConfig.SIZE_TO_SUFFIX[size] || '';
            const partNumber = baseStyle + suffix;  // e.g., PC61_2X

            // Get parent's color info
            const parentColor = parentRow.dataset.color || '';
            const parentCatalogColor = parentRow.dataset.catalogColor || '';
            const parentSwatchUrl = parentRow.dataset.swatchUrl || '';
            const parentHex = parentRow.dataset.hex || '#ccc';
            const parentColors = parentRow.dataset.colors ? JSON.parse(parentRow.dataset.colors) : [];

            console.log(`[DEBUG createChildRow] Reading from parent: color="${parentColor}", swatchUrl="${parentSwatchUrl || '(none)'}", colors=${parentColors.length} available`);

            // Build color options HTML for child row picker
            const colorOptionsHtml = parentColors.map(c =>
                `<div class="color-picker-option ${c.COLOR_NAME === parentColor ? 'selected' : ''}"
                     data-color-name="${escapeHtml(c.COLOR_NAME)}"
                     data-catalog-color="${escapeHtml(c.CATALOG_COLOR || c.COLOR_NAME)}"
                     data-swatch-url="${escapeHtml(c.COLOR_SQUARE_IMAGE || '')}"
                     data-hex="${escapeHtml(c.HEX_CODE || '#ccc')}"
                     onclick="selectChildColor(${childRowId}, ${parentRowId}, this)">
                    <span class="color-swatch" style="${getSwatchStyle(c)}"></span>
                    <span class="color-name">${escapeHtml(c.COLOR_NAME)}</span>
                </div>`
            ).join('');

            // Build current color display style
            const currentSwatchStyle = parentSwatchUrl
                ? `background-image: url('${parentSwatchUrl}'); background-size: cover; background-position: center;`
                : `background-color: ${parentHex};`;

            const childRow = document.createElement('tr');
            childRow.id = `row-${childRowId}`;
            childRow.className = 'child-row';
            childRow.dataset.rowId = childRowId;
            childRow.dataset.productId = childRowId;
            childRow.dataset.parentRowId = parentRowId;
            childRow.dataset.extendedSize = size;
            childRow.dataset.style = partNumber;
            childRow.dataset.baseStyle = baseStyle;
            childRow.dataset.baseCost = parentRow.dataset.baseCost || '0';
            childRow.dataset.sizeUpcharges = parentRow.dataset.sizeUpcharges || '{}';
            childRow.dataset.color = parentColor;
            childRow.dataset.catalogColor = parentCatalogColor;
            childRow.dataset.swatchUrl = parentSwatchUrl;
            childRow.dataset.hex = parentHex;
            childRow.dataset.productName = parentRow.dataset.productName || '';
            childRow.dataset.colorManuallySet = 'false';  // Track if user manually changed color

            const displaySize = size === 'XXXL' ? '3XL' : size;  // 2XL is already correct
            const productName = parentRow.dataset.productName || '';

            // Determine which column gets the qty (matching DTG/Embroidery pattern)
            // 2XL/XXL goes in Size05 column, other extended sizes go in Size06 column
            const SIZE05_SIZES = ['2XL', 'XXL'];  // Both map to same suffix
            const isSize05 = SIZE05_SIZES.includes(size);
            const isSize06 = !isSize05;

            childRow.innerHTML = `
                <td>
                    <span class="style-display">${escapeHtml(partNumber)}</span>
                </td>
                <td class="thumbnail-col">
                    <div class="product-thumbnail" id="thumb-${childRowId}"
                         style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                        <img src="${parentRow.dataset.imageUrl || ''}"
                             alt="${escapeHtml(productName)}"
                             style="max-width: 100%; max-height: 100%; object-fit: contain;"
                             onerror="this.parentElement.classList.add('no-image'); this.style.display='none';">
                    </div>
                </td>
                <td class="desc-cell">
                    <span class="desc-display">${escapeHtml(productName)} - ${displaySize}</span>
                </td>
                <td>
                    <div class="color-picker-wrapper child-color-picker" data-row-id="${childRowId}">
                        <div class="color-picker-selected" onclick="toggleColorPicker(${childRowId})" tabindex="0" onkeydown="handleColorPickerKeydown(event, ${childRowId})">
                            <span class="color-swatch" style="${currentSwatchStyle}"></span>
                            <span class="color-name">${escapeHtml(parentColor)}</span>
                            <i class="fas fa-chevron-down picker-arrow"></i>
                        </div>
                        <div class="color-picker-dropdown hidden" id="color-dropdown-${childRowId}">
                            ${colorOptionsHtml}
                        </div>
                    </div>
                </td>
                <td><input type="number" class="cell-input size-input" disabled style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" disabled style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" disabled style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input" disabled style="background: #f5f5f5;"></td>
                <td><input type="number" class="cell-input size-input extended-size-qty" data-size="2XL"
                           ${isSize05 ? `value="${qty}" min="0" placeholder="${qty}" onchange="onChildSizeChange(${childRowId}, ${parentRowId}, '2XL')" onkeydown="handleCellKeydown(event, this)"` : 'disabled style="background: #f5f5f5;"'}></td>
                <td><input type="number" class="cell-input size-input extended-size-qty" data-size="${size}"
                           ${isSize06 ? `value="${qty}" min="0" placeholder="${qty}" onchange="onChildSizeChange(${childRowId}, ${parentRowId}, '${size}')" onkeydown="handleCellKeydown(event, this)"` : 'disabled style="background: #f5f5f5;"'}></td>
                <td class="cell-qty" id="row-qty-${childRowId}">${qty}</td>
                <td class="cell-price" id="row-price-${childRowId}">-</td>
                <td class="cell-total" id="row-total-${childRowId}">-</td>
                <td class="cell-actions">
                    <button class="btn-delete-row" onclick="removeChildRow(${parentRowId}, '${size}')" title="Remove ${displaySize}" aria-label="Remove extended size ${displaySize}">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            // Insert in correct position (maintain size order)
            const existingChildren = Array.from(
                document.querySelectorAll(`tr[data-parent-row-id="${parentRowId}"]`)
            );
            // Normalize XXXL to 3XL for sorting lookup (XXXL is internal alias not in EXTENDED_SIZE_ORDER)
            const normalizedSize = size === 'XXXL' ? '3XL' : size;
            const newSizeIndex = window.ExtendedSizesConfig.EXTENDED_SIZE_ORDER.indexOf(normalizedSize);
            let insertAfter = parentRow;

            for (const existingChild of existingChildren) {
                const existingSize = existingChild.dataset.extendedSize;
                // Normalize existing size too for consistent comparison
                const normalizedExisting = existingSize === 'XXXL' ? '3XL' : existingSize;
                const existingSizeIndex = window.ExtendedSizesConfig.EXTENDED_SIZE_ORDER.indexOf(normalizedExisting);
                if (existingSizeIndex < newSizeIndex) {
                    insertAfter = existingChild;
                }
            }

            insertAfter.after(childRow);

            // Track in childRowMap
            if (!childRowMap[parentRowId]) childRowMap[parentRowId] = {};
            childRowMap[parentRowId][size] = childRowId;

            console.log(`[DTF] Created child row ${childRowId} for ${baseStyle} ${size} qty=${qty}`);

            // Trigger pricing recalculation
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.updatePricingFromRow(childRowId, childRow);
            }

            return childRowId;
        }

        /**
         * Remove a child row
         * @param {number} parentRowId - ID of the parent row
         * @param {string} size - Size to remove (XXL, 3XL, etc.)
         */
        function removeChildRow(parentRowId, size) {
            const childRowId = childRowMap[parentRowId]?.[size];
            if (childRowId) {
                const childRow = document.getElementById(`row-${childRowId}`);
                if (childRow) childRow.remove();
                delete childRowMap[parentRowId][size];

                // If removing XXL, re-enable parent's XXL input
                if (size === 'XXL' || size === '2XL') {
                    const parentRow = document.getElementById(`row-${parentRowId}`);
                    if (parentRow) {
                        const xxlInput = parentRow.querySelector('[data-size="2XL"]');
                        if (xxlInput) {
                            xxlInput.disabled = false;
                            xxlInput.value = '';
                            xxlInput.style.background = '';
                            xxlInput.style.color = '';
                        }
                    }
                }

                // Update parent's XXXL button display
                updateExtendedSizeDisplay(parentRowId);

                // Recalculate pricing
                if (dtfQuoteBuilder) {
                    dtfQuoteBuilder.removeProduct(childRowId);
                    dtfQuoteBuilder.recalculatePricing();
                }

                console.log(`[DTF] Removed child row ${childRowId} for size ${size}`);
            }
        }

        /**
         * Handle size change in a child row
         */
        function onChildSizeChange(childRowId, parentRowId, size) {
            const childRow = document.getElementById(`row-${childRowId}`);
            if (!childRow) return;

            const input = childRow.querySelector('.extended-size-qty');
            const qty = parseInt(input?.value) || 0;

            // Update qty display
            const qtyCell = document.getElementById(`row-qty-${childRowId}`);
            if (qtyCell) qtyCell.textContent = qty;

            // If quantity is 0, remove the child row
            if (qty === 0) {
                removeChildRow(parentRowId, size);
                return;
            }

            // Update extended size display on parent
            updateExtendedSizeDisplay(parentRowId);

            // Trigger pricing recalculation
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.updatePricingFromRow(childRowId, childRow);
            }
        }

        /**
         * Update the parent row's XXXL button display to show count of extended sizes
         */
        function updateExtendedSizeDisplay(parentRowId) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow) return;

            const xxxlBtn = parentRow.querySelector('.xxxl-picker-btn');
            if (!xxxlBtn) return;

            // Count total extended size quantities from child rows
            const childRows = document.querySelectorAll(`tr[data-parent-row-id="${parentRowId}"]`);
            let totalExtQty = 0;
            childRows.forEach(childRow => {
                // Skip XXL child rows for this count (they have their own column)
                const size = childRow.dataset.extendedSize;
                if (size !== 'XXL' && size !== '2XL') {
                    const qtyDisplay = childRow.querySelector('.cell-qty');
                    totalExtQty += parseInt(qtyDisplay?.textContent) || 0;
                }
            });

            // Update display
            if (totalExtQty > 0) {
                xxxlBtn.value = totalExtQty;
                xxxlBtn.placeholder = '';
            } else {
                xxxlBtn.value = '';
                xxxlBtn.placeholder = '+';
            }
        }

        /**
         * Get the current quantity for an extended size
         * Checks child rows first, falls back to parent row input
         * This fixes the "can't add extended sizes after the fact" bug
         * @param {number} parentRowId - ID of the parent row
         * @param {string} size - Size name (XS, XXL, 3XL, 4XL, 5XL, 6XL)
         */
        function getExtendedSizeQty(parentRowId, size) {
            // Normalize size aliases
            const normalizedSize = size === 'XXXL' ? '3XL' : size;

            // DEBUG: Log what we're looking for
            console.log(`[DEBUG getExtendedSizeQty] parentRowId=${parentRowId}, size=${size}, normalized=${normalizedSize}`);

            // Check if there's a child row for this size
            if (childRowMap[parentRowId] && childRowMap[parentRowId][normalizedSize]) {
                const childRowId = childRowMap[parentRowId][normalizedSize];
                const childRow = document.getElementById(`row-${childRowId}`);
                if (childRow) {
                    const qtyCell = childRow.querySelector('.cell-qty');
                    if (qtyCell) {
                        const qty = parseInt(qtyCell.textContent) || 0;
                        console.log(`[DEBUG getExtendedSizeQty] Found child row ${childRowId}, qty=${qty}`);
                        return qty;
                    }
                }
            }

            // Fallback: check parent row's input for this size (if not yet converted to child row)
            // Note: 3XL, 4XL, 5XL, 6XL have NO parent input - they only exist in popup/child rows
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (parentRow) {
                // Map size to input data-size attribute (only XXL/2XL has parent input)
                let inputSize = normalizedSize;
                if (normalizedSize === '2XL') inputSize = '2XL';
                // 3XL+ only exist in popup/child rows, no parent input to check

                const sizeInput = parentRow.querySelector(`[data-size="${inputSize}"]`);
                console.log(`[DEBUG getExtendedSizeQty] Checking parent input [data-size="${inputSize}"], found=${!!sizeInput}, disabled=${sizeInput?.disabled}, value=${sizeInput?.value}`);
                if (sizeInput && !sizeInput.disabled && !sizeInput.classList.contains('xxxl-picker-btn')) {
                    const val = parseInt(sizeInput.value) || 0;
                    if (val > 0) {
                        console.log(`[DEBUG getExtendedSizeQty] Using parent input value=${val}`);
                        return val;
                    }
                }
            }

            console.log(`[DEBUG getExtendedSizeQty] Returning 0 (no value found)`);
            return 0;
        }
        // Expose to global scope for JS class to use
        window.getExtendedSizeQty = getExtendedSizeQty;

        /**
         * Select a color for a child row (called from child row color picker)
         * @param {number} childRowId - ID of the child row
         * @param {number} parentRowId - ID of the parent row
         * @param {Element} optionEl - The clicked option element
         */
        function selectChildColor(childRowId, parentRowId, optionEl) {
            const childRow = document.getElementById(`row-${childRowId}`);
            if (!childRow) return;

            const colorName = optionEl.dataset.colorName;
            const catalogColor = optionEl.dataset.catalogColor;
            const swatchUrl = optionEl.dataset.swatchUrl;
            const hex = optionEl.dataset.hex || '#ccc';

            // Update child row data attributes
            childRow.dataset.color = colorName;
            childRow.dataset.catalogColor = catalogColor;
            childRow.dataset.swatchUrl = swatchUrl;
            childRow.dataset.hex = hex;
            childRow.dataset.colorManuallySet = 'true';  // Prevent cascade override

            // Update display
            const swatch = childRow.querySelector('.color-picker-selected .color-swatch');
            const nameSpan = childRow.querySelector('.color-picker-selected .color-name');

            if (swatch) {
                if (swatchUrl) {
                    swatch.style.backgroundImage = `url('${swatchUrl}')`;
                    swatch.style.backgroundColor = '';
                    swatch.style.backgroundSize = 'cover';
                    swatch.style.backgroundPosition = 'center';
                } else {
                    swatch.style.backgroundImage = '';
                    swatch.style.backgroundColor = hex;
                }
            }
            if (nameSpan) nameSpan.textContent = colorName;

            // Close dropdown
            const dropdown = childRow.querySelector('.color-picker-dropdown');
            if (dropdown) dropdown.classList.add('hidden');

            // Update visual indicator for different color
            updateChildRowColorIndicators(parentRowId);

            // Recalculate pricing
            if (dtfQuoteBuilder) {
                dtfQuoteBuilder.recalculatePricing();
            }

            console.log(`[DTF] Child row ${childRowId} color changed to ${colorName} (catalog: ${catalogColor})`);
        }

        /**
         * Cascade parent's color change to child rows (unless manually overridden)
         * @param {number} parentRowId - ID of the parent row
         * @param {string} colorName - Display color name
         * @param {string} catalogColor - Catalog color code
         * @param {string} swatchUrl - URL to color swatch image
         * @param {string} hex - Hex color code
         */
        function cascadeColorToChildRows(parentRowId, colorName, catalogColor, swatchUrl, hex) {
            if (!childRowMap[parentRowId]) return;

            Object.values(childRowMap[parentRowId]).forEach(childRowId => {
                const childRow = document.getElementById(`row-${childRowId}`);
                if (!childRow) return;

                // Skip if user manually set this child's color
                if (childRow.dataset.colorManuallySet === 'true') return;

                // Update child row color data
                childRow.dataset.color = colorName;
                childRow.dataset.catalogColor = catalogColor;
                childRow.dataset.swatchUrl = swatchUrl || '';
                childRow.dataset.hex = hex || '#ccc';

                // Update color picker display
                const swatch = childRow.querySelector('.color-picker-selected .color-swatch');
                const nameSpan = childRow.querySelector('.color-picker-selected .color-name');

                if (swatch) {
                    if (swatchUrl) {
                        swatch.style.backgroundImage = `url('${swatchUrl}')`;
                        swatch.style.backgroundColor = '';
                        swatch.style.backgroundSize = 'cover';
                        swatch.style.backgroundPosition = 'center';
                    } else {
                        swatch.style.backgroundImage = '';
                        swatch.style.backgroundColor = hex || '#ccc';
                    }
                }
                if (nameSpan) nameSpan.textContent = colorName;
            });

            // Update visual indicators
            updateChildRowColorIndicators(parentRowId);
        }

        /**
         * Update visual styling for child rows based on color match with parent
         * @param {number} parentRowId - ID of the parent row
         */
        function updateChildRowColorIndicators(parentRowId) {
            const parentRow = document.getElementById(`row-${parentRowId}`);
            if (!parentRow || !childRowMap[parentRowId]) return;

            const parentCatalogColor = parentRow.dataset.catalogColor;

            Object.values(childRowMap[parentRowId]).forEach(childRowId => {
                const childRow = document.getElementById(`row-${childRowId}`);
                if (!childRow) return;

                const childCatalogColor = childRow.dataset.catalogColor;

                // Add/remove visual indicator for different color
                if (childCatalogColor !== parentCatalogColor) {
                    childRow.classList.add('different-color');
                } else {
                    childRow.classList.remove('different-color');
                }
            });
        }

        // Helper functions
        function cleanProductTitle(title, styleNumber) {
            if (!title || !styleNumber) return title || '';
            const escapedStyle = styleNumber.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            let cleaned = title.replace(new RegExp(`^${escapedStyle}\\s*[-.]\\s*`, 'i'), '');
            cleaned = cleaned.replace(new RegExp(`[.\\s]+${escapedStyle}\\s*$`, 'i'), '');
            return cleaned.trim() || title;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function updateProductThumbnail(rowId, imageUrl, productName, styleNumber, colorName) {
            const thumbContainer = document.getElementById(`thumb-${rowId}`);
            if (!thumbContainer) return;

            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = productName || styleNumber;
                img.className = 'product-thumbnail';
                img.id = `thumb-${rowId}`;
                img.onclick = () => {
                    if (window.productThumbnailModal) {
                        productThumbnailModal.open(imageUrl, productName, styleNumber, colorName);
                    }
                };
                img.onerror = () => {
                    img.classList.add('no-image');
                    img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                };
                thumbContainer.replaceWith(img);
            }
        }

        function getSwatchStyle(color) {
            if (color.COLOR_SQUARE_IMAGE) {
                return `background-image: url('${color.COLOR_SQUARE_IMAGE}'); background-size: cover; background-position: center;`;
            }
            return `background-color: ${color.HEX_CODE || '#ccc'};`;
        }

        function showToast(message, type = 'info', duration = 3000) {
            console.log(`[${type}] ${message}`);
            // Simple alert for now - can be enhanced with a toast library
            if (type === 'error') {
                alert(message);
            }
        }

        // Note: No auto-row on page load - users add products via search box
        // The addProductRow() method handles row creation when selecting from search

    </script>

    <!-- Save Success Modal -->
    <div id="save-success-modal" class="save-modal-overlay" style="display: none;">
        <div class="save-modal-content">
            <div class="save-modal-header">
                <i class="fas fa-check-circle"></i>
                <h3>Quote Saved!</h3>
            </div>
            <div class="save-modal-body">
                <p>Quote ID: <strong id="saved-quote-id">---</strong></p>
                <p>Share this link with your customer:</p>
                <div class="url-copy-container">
                    <input type="text" id="shareable-url" class="shareable-url-input" readonly>
                    <button class="btn-copy-url" onclick="copyShareableUrl()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>
            <div class="save-modal-footer">
                <button class="btn-view-quote" onclick="window.open(document.getElementById('shareable-url').value, '_blank')">
                    <i class="fas fa-external-link-alt"></i> View Quote
                </button>
                <button class="btn-close-modal" onclick="closeSaveModal()" aria-label="Close save confirmation">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Save modal functions
        function showSaveModal(quoteId) {
            const url = `${window.location.origin}/quote/${quoteId}`;
            document.getElementById('saved-quote-id').textContent = quoteId;
            document.getElementById('shareable-url').value = url;
            document.getElementById('save-success-modal').style.display = 'flex';
        }

        function closeSaveModal() {
            document.getElementById('save-success-modal').style.display = 'none';
        }

        function copyShareableUrl() {
            const urlInput = document.getElementById('shareable-url');
            urlInput.select();
            document.execCommand('copy');

            // Visual feedback
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.style.background = '#28a745';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
            }, 2000);
        }

        // Close modal on backdrop click
        document.getElementById('save-success-modal').addEventListener('click', function(e) {
            if (e.target === this) closeSaveModal();
        });
    </script>
</body>
</html>
