<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Print Quote Builder | Northwest Custom Apparel</title>
    
    <!-- NWCA Favicon -->
    <link rel="icon" type="image/png" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Bootstrap CSS FIRST (foundation layer) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Universal Styles (override Bootstrap) -->
    <link rel="stylesheet" href="/shared_components/css/universal-header.css">
    <link rel="stylesheet" href="/shared_components/css/universal-calculator-theme.css">
    
    <!-- Base Quote Builder Styles (Screen Print inherits from embroidery) -->
    <link rel="stylesheet" href="/shared_components/css/embroidery-quote-builder.css">
    
    <!-- Screen Print Specific Styles (highest priority) -->
    <link rel="stylesheet" href="/shared_components/css/screenprint-safety-stripes.css">
    
    <!-- Custom Styles for Screen Print Quote Builder -->
    <style>
        :root {
            --primary-color: #4cb354;
            --primary-dark: #409a47;
            --primary-light: #5bc85f;
            --primary-lightest: #e8f5e9;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
        }

        body {
            background: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-title {
            color: var(--primary-color);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* Phase Navigation */
        .phase-nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .phase-step {
            flex: 1;
            text-align: center;
            position: relative;
            cursor: pointer;
        }

        .phase-step.active .step-number {
            background: var(--primary-color);
            color: white;
        }

        .phase-step.completed .step-number {
            background: var(--primary-dark);
            color: white;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .phase-step.active .step-label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .phase-connector {
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border-color);
            z-index: -1;
        }

        /* Phase Sections */
        .phase-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .phase-section.active {
            display: block;
        }

        .phase-header {
            margin-bottom: 2rem;
        }

        .phase-header h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .phase-header p {
            color: var(--text-secondary);
        }

        /* Setup Cards */
        .setup-card {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .setup-title {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Print Locations Grid */
        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .location-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .location-card.selected {
            border-color: var(--primary-color);
            background: var(--primary-lightest);
        }

        .location-card input[type="checkbox"] {
            display: none;
        }
        
        .location-card label {
            pointer-events: none; /* Prevent label from triggering events */
        }

        .location-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .location-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .location-code {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Color Selection */
        .color-selector {
            margin-top: 1rem;
        }

        .color-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .color-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .color-btn:hover {
            border-color: var(--primary-light);
        }

        .color-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Dark Garment Toggle */
        .dark-garment-section {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: 2px solid #6b7280;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .dark-garment-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Safety Stripes Section */
        .safety-stripes-section {
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8dc 100%);
            border: 2px solid #ff6b35;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            position: relative;
        }

        .safety-stripes-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .safety-label {
            color: #ff6b35;
            font-weight: 600;
            display: flex;
            align-items: center;
            position: relative;
            gap: 0.5rem;
        }

        .safety-icon {
            color: #ff6b35;
        }
        
        /* Tooltip for safety stripes */
        .info-tooltip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff6b35;
            color: white;
            font-size: 0.75rem;
            cursor: help;
            position: relative;
            margin-left: 0.25rem;
        }
        
        .info-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-weight: normal;
        }
        
        .info-tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }
        
        /* Price breakdown tooltip */
        .price-with-tooltip {
            position: relative;
            display: inline-block;
            font-weight: 600;
            color: var(--primary-color);
            cursor: help;
            border-bottom: 1px dashed var(--primary-color);
        }
        
        .price-with-tooltip .tooltip-content {
            visibility: hidden;
            background: #333;
            color: white;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            min-width: 280px;
            font-size: 0.875rem;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: pre-line;
        }
        
        .price-with-tooltip .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .price-with-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        /* Product Search */
        .search-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 1rem;
            align-items: end;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: var(--primary-lightest);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-style {
            font-weight: 600;
            color: var(--primary-color);
        }

        .suggestion-name {
            color: var(--text-primary);
            margin-left: 0.5rem;
        }

        /* Product Display */
        .product-display {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .product-info {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .product-info img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border-radius: 8px;
            background: white;
            padding: 0.5rem;
        }

        .product-details h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .product-details p {
            color: var(--text-secondary);
        }

        /* Size Matrix */
        .size-matrix {
            margin-top: 1.5rem;
        }

        .size-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1rem;
        }

        .size-input-group {
            text-align: center;
        }

        .size-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .size-quantity {
            width: 100%;
            padding: 0.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-weight: 500;
        }

        .size-quantity:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .phase-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border-color);
        }

        /* Products List */
        .products-list {
            margin-top: 2rem;
        }

        .product-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-item-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .product-item-details h4 {
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .product-item-details p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .product-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Quote Summary */
        .quote-summary {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-section {
            margin-bottom: 1.5rem;
        }

        .summary-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-label {
            color: var(--text-secondary);
        }

        .summary-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--primary-color);
        }

        .summary-total .summary-row {
            border-bottom: none;
        }

        .summary-total .summary-value {
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        /* Customer Info */
        .customer-info-section {
            margin-bottom: 2rem;
        }

        .customer-info-section h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }

        /* Success Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header.success {
            color: var(--primary-color);
        }

        .modal-header i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .quote-id-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 1rem 0;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Minimum Order Warning Styles */
        .minimum-order-warning {
            background: linear-gradient(135deg, #fff5e5 0%, #ffebe0 100%);
            border: 2px solid #ff9800;
            border-radius: 12px;
            padding: 20px 25px;
            margin: 20px 0;
            display: none;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.15);
        }

        .minimum-order-warning.show {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }

        .warning-icon {
            font-size: 2.5rem;
            color: #ff9800;
            flex-shrink: 0;
            margin-top: 5px;
        }

        .warning-content {
            flex: 1;
        }

        .warning-content h4 {
            color: #e65100;
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .warning-content p {
            color: #666;
            margin: 8px 0;
            font-size: 0.95rem;
        }

        .warning-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .warning-content li {
            color: #666;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .warning-content strong {
            color: #333;
            font-weight: 600;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alternative-calculator-links {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alternative-calculator-links a {
            display: inline-block;
            padding: 8px 16px;
            background: #4cb354;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .alternative-calculator-links a:hover {
            background: #3d8b44;
        }
    </style>
    
    <!-- Phase 1 Infrastructure - v20250911 -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-common.css?v=20250911">
    <link rel="stylesheet" href="/shared_components/css/quote-print.css?v=20250911">
    <script src="/shared_components/js/quote-builder-base.js?v=20250911"></script>
    <script src="/shared_components/js/quote-formatter.js?v=20250911"></script>
    
    <!-- Phase 2 Persistence - v20250911 -->
    <script src="/shared_components/js/quote-persistence.js?v=20250911"></script>
    <script src="/shared_components/js/quote-session.js?v=20250911"></script>
    
    <!-- Phase 3 Advanced Features - v20250911 -->
    <link rel="stylesheet" href="/shared_components/css/quote-builder-phase3.css?v=20250911">
    <script src="/shared_components/js/quote-validation.js?v=20250911"></script>
    <script src="/shared_components/js/quote-ui-feedback.js?v=20250911"></script>
    
    <!-- Verify files are loading -->
    <script>
        console.log('🔍 Screen Print Quote Builder: Loading Phase 1 Infrastructure...');
        window.addEventListener('load', function() {
            if (typeof QuoteBuilderBase === 'undefined') {
                console.error('❌ ERROR: quote-builder-base.js failed to load!');
                alert('Critical files failed to load. Please clear cache (Ctrl+Shift+F5) and refresh.');
            } else {
                console.log('✅ QuoteBuilderBase loaded successfully');
            }
            if (typeof QuoteFormatter === 'undefined') {
                console.error('❌ ERROR: quote-formatter.js failed to load!');
            } else {
                console.log('✅ QuoteFormatter loaded successfully');
            }
        });
    </script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Processing...</div>
        </div>
    </div>
    
    <!-- Auto-Save Indicator -->
    <div id="save-indicator" class="unsaved-indicator">
        <span id="save-status">Draft saved</span>
    </div>
    <!-- Professional Header with Logo and Navigation -->
    <header class="embroidery-header">
        <!-- Contact Bar -->
        <div class="header-contact-bar">
            <div class="contact-bar-content">
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>(253) 922-5793</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>sales@nwcustomapparel.com</span>
                    </div>
                </div>
                <div class="business-hours">
                    <i class="fas fa-clock"></i>
                    Monday - Friday: 8:30 AM - 5:00 PM PST
                </div>
            </div>
        </div>
        
        <!-- Main Navigation -->
        <div class="header-nav">
            <div class="nav-content">
                <!-- Logo Section -->
                <div class="logo-section">
                    <a href="/staff-dashboard.html" class="logo-link">
                        <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                             alt="Northwest Custom Apparel" 
                             class="logo-image">
                    </a>
                </div>
                
                <!-- Navigation Actions -->
                <div class="nav-actions">
                    <button class="btn-secondary header-btn" onclick="window.location.href='/staff-dashboard.html'">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Context Bar -->
        <div class="context-bar">
            <div class="context-bar-content">
                <div class="context-left">
                    <!-- Breadcrumb -->
                    <div class="breadcrumb">
                        <a href="/staff-dashboard.html">Dashboard</a>
                        <i class="fas fa-chevron-right"></i>
                        <span>Screen Print Quote Builder</span>
                    </div>
                </div>
                
                <!-- Live Status -->
                <div class="header-status">
                    <div class="status-item">
                        <span class="status-label">Quote Type:</span>
                        <span class="status-value">Screen Print</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <h1 class="page-title">
            <i class="fas fa-paint-brush"></i> Screen Print Quote Builder
        </h1>
        <p class="page-description">
            Create professional screen print quotes with multiple products, locations, and automatic tier pricing
        </p>
        
        <!-- Progress Indicator -->
        <div class="phase-nav">
            <div class="phase-step active" data-phase="1">
                <div class="step-number">1</div>
                <div class="step-label">Print Setup</div>
            </div>
            <div class="phase-step" data-phase="2">
                <div class="step-number">2</div>
                <div class="step-label">Add Products</div>
            </div>
            <div class="phase-step" data-phase="3">
                <div class="step-number">3</div>
                <div class="step-label">Review & Save Quote</div>
            </div>
        </div>
        
        <!-- Phase 1: Print Setup -->
        <section id="setup-phase" class="phase-section active">
            <div class="phase-header">
                <h2><i class="fas fa-palette"></i> Print Setup</h2>
                <p>Define your screen print specifications that will apply to all products</p>
            </div>
            
            <!-- Print Locations -->
            <div class="setup-card">
                <h3 class="setup-title">Print Locations</h3>
                
                <div class="locations-grid">
                    <div class="location-card" data-location="LC">
                        <label>
                            <input type="checkbox" name="location" value="LC">
                            <div class="location-icon"><i class="fas fa-tshirt"></i></div>
                            <div class="location-name">Left Chest</div>
                            <div class="location-code">LC</div>
                        </label>
                    </div>
                    
                    <div class="location-card" data-location="RC">
                        <label>
                            <input type="checkbox" name="location" value="RC">
                            <div class="location-icon"><i class="fas fa-tshirt"></i></div>
                            <div class="location-name">Right Chest</div>
                            <div class="location-code">RC</div>
                        </label>
                    </div>
                    
                    <div class="location-card" data-location="FF">
                        <label>
                            <input type="checkbox" name="location" value="FF">
                            <div class="location-icon"><i class="fas fa-tshirt"></i></div>
                            <div class="location-name">Full Front</div>
                            <div class="location-code">FF</div>
                        </label>
                    </div>
                    
                    <div class="location-card" data-location="FB">
                        <label>
                            <input type="checkbox" name="location" value="FB">
                            <div class="location-icon"><i class="fas fa-tshirt"></i></div>
                            <div class="location-name">Full Back</div>
                            <div class="location-code">FB</div>
                        </label>
                    </div>
                    
                    <div class="location-card" data-location="LS">
                        <label>
                            <input type="checkbox" name="location" value="LS">
                            <div class="location-icon"><i class="fas fa-tshirt"></i></div>
                            <div class="location-name">Left Sleeve</div>
                            <div class="location-code">LS</div>
                        </label>
                    </div>
                    
                    <div class="location-card" data-location="RS">
                        <label>
                            <input type="checkbox" name="location" value="RS">
                            <div class="location-icon"><i class="fas fa-tshirt"></i></div>
                            <div class="location-name">Right Sleeve</div>
                            <div class="location-code">RS</div>
                        </label>
                    </div>
                </div>
                
                <!-- Color Selection for Each Location -->
                <div id="location-colors" style="display: none;">
                    <div class="color-selector">
                        <label class="setup-title">Number of Colors per Location</label>
                        <div id="color-selections">
                            <!-- Color selections will be added dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Additional Options -->
            <div class="setup-card">
                <h3 class="setup-title">Additional Options</h3>
                
                <!-- Dark Garments -->
                <div class="dark-garment-section">
                    <div class="dark-garment-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="dark-garment-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <div>
                            <strong>Dark Garments</strong>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                Adds white underbase layer for printing on dark colored shirts (+1 color to each location)
                            </p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="phase-actions">
                <div></div>
                <button id="continue-to-products" class="btn btn-primary" disabled>
                    Continue to Products <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Phase 2: Add Products -->
        <section id="product-phase" class="phase-section">
            <div class="phase-header">
                <h2><i class="fas fa-tshirt"></i> Add Products</h2>
                <p>Search and add products with size quantities</p>
            </div>
            
            <!-- Product Search -->
            <div class="search-row">
                <div class="form-group" style="position: relative;">
                    <label for="style-search">Style Number</label>
                    <input type="text" 
                           id="style-search" 
                           placeholder="Enter style (e.g., PC54, PC61)" 
                           autocomplete="off">
                    <div id="style-suggestions" class="suggestions-dropdown" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label for="color-select">Color</label>
                    <select id="color-select" disabled>
                        <option value="">Select style first</option>
                    </select>
                </div>
                
                <button id="load-product-btn" class="btn btn-primary" disabled>
                    <i class="fas fa-search"></i> Load Product
                </button>
            </div>
            
            <!-- Product Display -->
            <div id="product-display" class="product-display" style="display: none;">
                <div class="product-info">
                    <img id="product-image" src="/images/placeholder-shirt.png" alt="Product">
                    <div class="product-details">
                        <h3 id="product-name"></h3>
                        <p id="product-description"></p>
                    </div>
                </div>
                
                <!-- Size Matrix -->
                <div class="size-matrix">
                    <h4>Enter Quantities by Size</h4>
                    <div id="size-inputs" class="size-inputs">
                        <!-- Size inputs will be added dynamically -->
                    </div>
                    
                    <div class="phase-actions" style="border-top: none; padding-top: 1rem;">
                        <div>
                            Total Quantity: <strong id="product-total-qty">0</strong>
                        </div>
                        <button id="add-to-quote-btn" class="btn btn-primary" disabled>
                            <i class="fas fa-plus"></i> Add to Quote
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Products List -->
            <div class="products-list">
                <h3>Products in Quote</h3>
                <div id="products-container">
                    <p style="color: var(--text-secondary);">No products added yet. Search and add products above.</p>
                </div>
                
                <!-- Minimum Order Warning -->
                <div id="minimum-order-warning" class="minimum-order-warning" style="display: none;">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="warning-content">
                        <h4>Screen printing requires a minimum of 24 pieces</h4>
                        <p>Current total: <span id="warning-quantity">0</span> pieces</p>
                        <p>For smaller quantities, we recommend:</p>
                        <ul>
                            <li><strong>Direct to Garment (DTG)</strong> - Best for 1-23 pieces with full-color designs</li>
                            <li><strong>Direct to Film (DTF) Transfers</strong> - Great for small batches with vibrant colors</li>
                        </ul>
                        <div class="warning-actions">
                            <a href="/dtg-quote-builder.html" class="btn btn-secondary">
                                <i class="fas fa-print"></i> Switch to DTG Calculator
                            </a>
                            <a href="/dtf-calculator.html" class="btn btn-secondary">
                                <i class="fas fa-film"></i> Switch to DTF Calculator
                            </a>
                            <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" class="btn btn-ghost">
                                Continue Anyway
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="phase-actions">
                <button id="back-to-setup" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Setup
                </button>
                <button id="continue-to-summary" class="btn btn-primary" disabled>
                    Continue to Summary <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Phase 3: Review & Save Quote -->
        <section id="summary-phase" class="phase-section">
            <div class="phase-header">
                <h2><i class="fas fa-file-invoice"></i> Review & Save Quote</h2>
                <p>Review your quote and enter customer information</p>
            </div>
            
            <!-- Minimum Order Warning (duplicated for Phase 3) -->
            <div id="summary-minimum-order-warning" class="minimum-order-warning" style="display: none;">
                <div class="warning-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="warning-content">
                    <h4>Screen printing requires a minimum of 24 pieces</h4>
                    <p>Current total: <span id="summary-warning-quantity">0</span> pieces</p>
                    <p>For smaller quantities, we recommend:</p>
                    <ul>
                        <li><strong>Direct to Garment (DTG)</strong> - Best for 1-23 pieces with full-color designs</li>
                        <li><strong>Direct to Film (DTF) Transfers</strong> - Great for small batches with vibrant colors</li>
                    </ul>
                    <div class="alternative-calculator-links">
                        <a href="/calculators/dtg-contract-calculator.html">Go to DTG Calculator</a>
                        <a href="/calculators/dtf-calculator.html">Go to DTF Calculator</a>
                    </div>
                </div>
            </div>
            
            <!-- Quote Summary -->
            <div id="quote-summary" class="quote-summary">
                <!-- Summary will be generated dynamically -->
            </div>
            
            <!-- Customer Information -->
            <div class="customer-info-section">
                <h3>Customer Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-name">Customer Name *</label>
                        <input type="text" id="customer-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-email">Email *</label>
                        <input type="email" id="customer-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-phone">Phone</label>
                        <input type="tel" id="customer-phone" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="company-name">Company Name</label>
                        <input type="text" id="company-name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="project-name">Project Name</label>
                        <input type="text" id="project-name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="sales-rep">Sales Representative *</label>
                        <select id="sales-rep" class="form-control" required>
                            <option value="sales@nwcustomapparel.com" selected>General Sales</option>
                            <option value="adriyella@nwcustomapparel.com">Adriyella</option>
                            <option value="bradley@nwcustomapparel.com">Bradley Wright</option>
                            <option value="erik@nwcustomapparel.com">Erik Mickelson</option>
                            <option value="jim@nwcustomapparel.com">Jim Mickelson</option>
                            <option value="nika@nwcustomapparel.com">Nika Lao</option>
                            <option value="ruth@nwcustomapparel.com">Ruth Nhong</option>
                            <option value="art@nwcustomapparel.com">Steve Deland</option>
                            <option value="taneisha@nwcustomapparel.com">Taneisha Clark</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="special-notes">Special Notes</label>
                    <textarea id="special-notes" rows="3" class="form-textarea"></textarea>
                </div>
                
                <!-- Save to Database Option -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="save-to-database" checked>
                        Save quote to database for future reference
                    </label>
                </div>
            </div>
            
            <div class="phase-actions">
                <button id="back-to-products" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Products
                </button>
                <div>
                    <button id="generate-quote-btn" class="btn btn-primary">
                        <i class="fas fa-file-export"></i> Generate Quote
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header success">
                <i class="fas fa-check-circle"></i>
                <h2>Quote Generated Successfully!</h2>
            </div>
            <div class="modal-body">
                <p>Your screen print quote has been created.</p>
                <div class="quote-id-display" id="modal-quote-id">SP0909-1</div>
                <p id="modal-message">Quote has been saved to the database.</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
                <button onclick="printQuote()" class="btn btn-secondary">
                    <i class="fas fa-print"></i> Print
                </button>
                <button onclick="copyQuote()" class="btn btn-secondary">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button onclick="emailQuote()" class="btn btn-secondary">
                    <i class="fas fa-envelope"></i> Email
                </button>
                <button onclick="newQuote()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Quote
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Services -->
    <script src="/shared_components/js/screenprint-quote-service.js"></script>
    <script src="/shared_components/js/screenprint-quote-products.js"></script>
    <script src="/shared_components/js/screenprint-quote-pricing.js"></script>
    <script src="/shared_components/js/screenprint-pricing-service.js"></script>
    
    <!-- Main Application Script -->
    <script>
    class ScreenPrintQuoteBuilder {
        constructor() {
            this.currentPhase = 1;
            this.printSetup = {
                locations: [],
                colorsByLocation: {},
                darkGarments: false,
                safetyStripesByLocation: {} // Track safety stripes per location
            };
            this.products = [];
            this.currentProduct = null;
            
            // Initialize services
            this.quoteService = new ScreenPrintQuoteService();
            this.productService = new ScreenPrintProductManager();
            this.pricingService = new ScreenPrintPricingCalculator();
            
            // Initialize EmailJS
            emailjs.init('4qSbDO-SQs19TbP80');
            
            this.emailConfig = {
                serviceId: 'service_1c4k67j',
                templateId: 'template_screenprint' // You'll need to get the actual template ID
            };
            
            this.initializeEventListeners();
            console.log('[ScreenPrintQuoteBuilder] Initialized');
        }
        
        initializeEventListeners() {
            // Phase navigation
            document.querySelectorAll('.phase-step').forEach(step => {
                step.addEventListener('click', (e) => {
                    const phase = parseInt(e.currentTarget.dataset.phase);
                    if (phase <= this.currentPhase) {
                        this.navigateToPhase(phase);
                    }
                });
            });
            
            // Print location selection
            document.querySelectorAll('.location-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent event bubbling
                    // Don't process if clicking on the checkbox itself
                    if (e.target.type === 'checkbox') return;
                    this.handleLocationSelection(card);
                });
            });
            
            // Dark garments toggle
            document.getElementById('dark-garment-toggle').addEventListener('change', (e) => {
                this.printSetup.darkGarments = e.target.checked;
                this.updateColorSelections();
            });
            
            // Continue buttons
            document.getElementById('continue-to-products').addEventListener('click', () => {
                if (this.validatePrintSetup()) {
                    this.navigateToPhase(2);
                }
            });
            
            document.getElementById('continue-to-summary').addEventListener('click', () => {
                if (this.products.length > 0) {
                    this.generateQuoteSummary();
                    this.navigateToPhase(3);
                }
            });
            
            // Back buttons
            document.getElementById('back-to-setup').addEventListener('click', () => {
                this.navigateToPhase(1);
            });
            
            document.getElementById('back-to-products').addEventListener('click', () => {
                this.navigateToPhase(2);
            });
            
            // Product search
            const styleSearch = document.getElementById('style-search');
            let searchTimeout;
            
            styleSearch.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const searchTerm = e.target.value.trim();
                
                if (searchTerm.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        this.searchProducts(searchTerm);
                    }, 300);
                } else {
                    document.getElementById('style-suggestions').style.display = 'none';
                }
            });
            
            // Click outside to close suggestions
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.form-group')) {
                    document.getElementById('style-suggestions').style.display = 'none';
                }
            });
            
            // Load product button
            document.getElementById('load-product-btn').addEventListener('click', () => {
                this.loadProductDetails();
            });
            
            // Add to quote button
            document.getElementById('add-to-quote-btn').addEventListener('click', () => {
                this.addProductToQuote();
            });
            
            // Generate quote button
            document.getElementById('generate-quote-btn').addEventListener('click', () => {
                this.generateQuote();
            });
        }
        
        handleLocationSelection(card) {
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            card.classList.toggle('selected', checkbox.checked);
            
            const location = card.dataset.location;
            
            if (checkbox.checked) {
                // Only add if not already in array (prevent duplicates)
                if (!this.printSetup.locations.includes(location)) {
                    this.printSetup.locations.push(location);
                }
                this.printSetup.colorsByLocation[location] = 1;
            } else {
                this.printSetup.locations = this.printSetup.locations.filter(l => l !== location);
                delete this.printSetup.colorsByLocation[location];
            }
            
            this.updateColorSelections();
            this.updateContinueButton();
        }
        
        updateColorSelections() {
            const container = document.getElementById('color-selections');
            const locationColors = document.getElementById('location-colors');
            
            // Deduplicate locations array (safety check)
            this.printSetup.locations = [...new Set(this.printSetup.locations)];
            
            if (this.printSetup.locations.length === 0) {
                locationColors.style.display = 'none';
                return;
            }
            
            locationColors.style.display = 'block';
            container.innerHTML = '';
            
            this.printSetup.locations.forEach(location => {
                const locationName = this.getLocationName(location);
                const currentColors = this.printSetup.colorsByLocation[location] || 1;
                
                const colorRow = document.createElement('div');
                colorRow.style.marginBottom = '1.5rem';
                colorRow.style.padding = '1rem';
                colorRow.style.background = '#f9f9f9';
                colorRow.style.borderRadius = '8px';
                
                const hasSafetyStripe = this.printSetup.safetyStripesByLocation[location] || false;
                
                colorRow.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; font-size: 1.1rem;">${locationName}:</span>
                        <div class="color-buttons">
                            ${[0,1,2,3,4,5,6].map(num => `
                                <button class="color-btn ${currentColors === num ? 'active' : ''}" 
                                        data-location="${location}" 
                                        data-colors="${num}">
                                    ${num} ${num === 1 ? 'Color' : 'Colors'}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    ${this.printSetup.darkGarments && currentColors > 0 ? `
                        <div style="margin: 0.5rem 0; padding: 0.5rem; background: #fff; border-left: 3px solid #6b7280; border-radius: 4px;">
                            <p style="margin: 0; font-size: 0.9rem; color: #4b5563;">
                                <i class="fas fa-info-circle" style="color: #6b7280;"></i> 
                                <strong>Dark Garment Pricing:</strong> ${currentColors} design ${currentColors === 1 ? 'color' : 'colors'} + 1 white underbase = ${currentColors + 1} colors total
                            </p>
                        </div>
                    ` : ''}
                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: linear-gradient(135deg, #fff5f0 0%, #ffe8dc 100%); border-radius: 6px; border: 1px solid #ffb088;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" 
                                   id="safety-stripe-${location}" 
                                   data-location="${location}"
                                   ${hasSafetyStripe ? 'checked' : ''}
                                   style="margin-right: 0.5rem;">
                            <span style="color: #ff6b35; font-weight: 600;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 0.25rem;"></i>
                                Safety stripe elements (+$2.00/piece)
                            </span>
                            <span class="info-tooltip" data-tooltip="Typically requires 4 colors: white base + 2 stripe colors + company logo" style="margin-left: 0.5rem;">
                                <i class="fas fa-info" style="font-size: 0.7rem;"></i>
                            </span>
                        </label>
                        <p style="margin: 0.25rem 0 0 1.5rem; font-size: 0.8rem; color: #a0522d;">
                            Add reflective safety stripes for high-visibility workwear
                        </p>
                    </div>
                `;
                
                container.appendChild(colorRow);
            });
            
            // Add event listeners to color buttons
            container.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const location = e.target.dataset.location;
                    const colors = parseInt(e.target.dataset.colors);
                    
                    // Update active state
                    e.target.parentElement.querySelectorAll('.color-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Store selection
                    this.printSetup.colorsByLocation[location] = colors;
                    
                    // If dark garments, refresh to show transparent pricing
                    if (this.printSetup.darkGarments) {
                        this.updateColorSelections();
                    }
                });
            });
            
            // Add event listeners to safety stripe checkboxes
            container.querySelectorAll('input[type="checkbox"][id^="safety-stripe-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const location = e.target.dataset.location;
                    this.printSetup.safetyStripesByLocation[location] = e.target.checked;
                    console.log(`[ScreenPrintQuoteBuilder] Safety stripe for ${location}: ${e.target.checked}`);
                });
            });
        }
        
        getLocationName(code) {
            const names = {
                'LC': 'Left Chest',
                'RC': 'Right Chest',
                'FF': 'Full Front',
                'FB': 'Full Back',
                'LS': 'Left Sleeve',
                'RS': 'Right Sleeve'
            };
            return names[code] || code;
        }
        
        updateContinueButton() {
            const continueBtn = document.getElementById('continue-to-products');
            continueBtn.disabled = this.printSetup.locations.length === 0;
        }
        
        validatePrintSetup() {
            if (this.printSetup.locations.length === 0) {
                alert('Please select at least one print location');
                return false;
            }
            return true;
        }
        
        async searchProducts(searchTerm) {
            try {
                const products = await this.productService.searchProducts(searchTerm);
                this.displaySearchSuggestions(products);
            } catch (error) {
                console.error('Search error:', error);
            }
        }
        
        displaySearchSuggestions(products) {
            const container = document.getElementById('style-suggestions');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<div class="suggestion-item">No products found</div>';
                container.style.display = 'block';
                return;
            }
            
            container.innerHTML = products.slice(0, 10).map(product => `
                <div class="suggestion-item" data-style="${product.style}">
                    <span class="suggestion-style">${product.style}</span>
                    <span class="suggestion-name">${product.title || product.productName || ''}</span>
                </div>
            `).join('');
            
            container.style.display = 'block';
            
            // Add click handlers
            container.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const style = item.dataset.style;
                    document.getElementById('style-search').value = style;
                    container.style.display = 'none';
                    this.selectProductStyle(style);
                });
            });
        }
        
        async selectProductStyle(styleNumber) {
            try {
                console.log('[selectProductStyle] Loading style:', styleNumber);
                
                // Get product details
                const productDetails = await this.productService.getProductDetails(styleNumber);
                
                console.log('[selectProductStyle] Product details:', productDetails);
                console.log('[selectProductStyle] Available colors:', productDetails?.availableColors);
                
                if (!productDetails) {
                    alert('Could not load product details');
                    return;
                }
                
                this.currentProduct = {
                    styleNumber: styleNumber,
                    details: productDetails
                };
                
                // Enable color selection
                const colorSelect = document.getElementById('color-select');
                colorSelect.disabled = false;
                colorSelect.innerHTML = '<option value="">Select a color...</option>';
                
                if (productDetails.availableColors && productDetails.availableColors.length > 0) {
                    console.log('[selectProductStyle] Adding colors to dropdown:', productDetails.availableColors.length);
                    productDetails.availableColors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color.COLOR_NAME || color;
                        option.textContent = color.COLOR_NAME || color;
                        colorSelect.appendChild(option);
                    });
                } else {
                    console.warn('[selectProductStyle] No colors available for product');
                    colorSelect.innerHTML = '<option value="">No colors available - check API response</option>';
                }
                
                // Enable load button
                document.getElementById('load-product-btn').disabled = false;
                
            } catch (error) {
                console.error('[selectProductStyle] Error loading product:', error);
                alert('Error loading product details');
            }
        }
        
        async loadProductDetails() {
            const color = document.getElementById('color-select').value;
            
            if (!color) {
                alert('Please select a color');
                return;
            }
            
            if (!this.currentProduct) {
                alert('Please select a product style first');
                return;
            }
            
            try {
                console.log('[loadProductDetails] Loading sizes for:', this.currentProduct.styleNumber, color);
                
                // Get available sizes
                const sizes = await this.productService.getAvailableSizes(
                    this.currentProduct.styleNumber, 
                    color
                );
                
                console.log('[loadProductDetails] Received sizes:', sizes);
                
                if (!sizes || sizes.length === 0) {
                    // Show warning but continue with default sizes
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'alert alert-warning';
                    warningDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 10px; margin: 10px 0; border-radius: 4px;';
                    warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> Unable to load sizes from server. Using default sizes.';
                    
                    const productDisplay = document.getElementById('product-display');
                    const existingWarning = productDisplay.querySelector('.alert-warning');
                    if (existingWarning) existingWarning.remove();
                    productDisplay.insertBefore(warningDiv, productDisplay.firstChild);
                    
                    console.warn('[loadProductDetails] No sizes returned, using defaults');
                }
                
                // Display product
                document.getElementById('product-display').style.display = 'block';
                document.getElementById('product-name').textContent = 
                    `${this.currentProduct.styleNumber} - ${this.currentProduct.details.PRODUCT_TITLE || ''}`;
                document.getElementById('product-description').textContent = 
                    `${this.currentProduct.details.BRAND_NAME || ''} | ${color}`;
                
                // Update product image
                const productImage = document.getElementById('product-image');
                if (productImage) {
                    // Find the selected color data to get color-specific image
                    const selectedColor = this.currentProduct.details.availableColors.find(c => 
                        c.COLOR_NAME === color
                    );
                    
                    // Use color-specific image if available, otherwise use generic product image
                    const imageUrl = selectedColor?.MAIN_IMAGE_URL || 
                                    selectedColor?.FRONT_MODEL || 
                                    selectedColor?.FRONT_FLAT || 
                                    this.currentProduct.details.PRODUCT_IMAGE ||
                                    '/images/placeholder-shirt.png';
                    
                    productImage.src = imageUrl;
                    productImage.onerror = () => {
                        productImage.src = '/images/placeholder-shirt.png';
                    };
                }
                
                // Create size inputs
                const sizeInputsContainer = document.getElementById('size-inputs');
                sizeInputsContainer.innerHTML = '';
                
                // Ensure we have sizes to display
                const sizesToDisplay = sizes && sizes.length > 0 ? sizes : ['S', 'M', 'L', 'XL', '2XL', '3XL'];
                console.log('[loadProductDetails] Creating size inputs for:', sizesToDisplay);
                
                sizesToDisplay.forEach(size => {
                    const sizeGroup = document.createElement('div');
                    sizeGroup.className = 'size-input-group';
                    sizeGroup.innerHTML = `
                        <label class="size-label">${size}</label>
                        <input type="number" 
                               class="size-quantity" 
                               data-size="${size}" 
                               min="0" 
                               value="0"
                               onchange="screenPrintQuoteBuilder.updateProductTotal()">
                    `;
                    sizeInputsContainer.appendChild(sizeGroup);
                });
                
                console.log('[loadProductDetails] Size inputs created:', sizeInputsContainer.children.length);
                
                // Store current product data
                this.currentProduct.color = color;
                this.currentProduct.sizes = sizesToDisplay;
                
            } catch (error) {
                console.error('[loadProductDetails] Error loading product details:', error);
                
                // Show error message to user (Erik's requirement: no silent failures)
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.style.cssText = 'background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 4px;';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> Failed to load product details. ${error.message}. Please try again or contact support.`;
                
                const productDisplay = document.getElementById('product-display');
                productDisplay.style.display = 'block';
                const existingError = productDisplay.querySelector('.alert-danger');
                if (existingError) existingError.remove();
                productDisplay.insertBefore(errorDiv, productDisplay.firstChild);
                
                // Still try to show the form with default sizes
                const sizeInputsContainer = document.getElementById('size-inputs');
                sizeInputsContainer.innerHTML = '';
                
                const defaultSizes = ['S', 'M', 'L', 'XL', '2XL', '3XL'];
                defaultSizes.forEach(size => {
                    const sizeGroup = document.createElement('div');
                    sizeGroup.className = 'size-input-group';
                    sizeGroup.innerHTML = `
                        <label class="size-label">${size}</label>
                        <input type="number" 
                               class="size-quantity" 
                               data-size="${size}" 
                               min="0" 
                               value="0"
                               onchange="screenPrintQuoteBuilder.updateProductTotal()">
                    `;
                    sizeInputsContainer.appendChild(sizeGroup);
                });
                
                this.currentProduct.color = color;
                this.currentProduct.sizes = defaultSizes;
            }
        }
        
        updateProductTotal() {
            const quantities = document.querySelectorAll('.size-quantity');
            let total = 0;
            
            quantities.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            
            document.getElementById('product-total-qty').textContent = total;
            document.getElementById('add-to-quote-btn').disabled = total === 0;
        }
        
        addProductToQuote() {
            // Collect size breakdown
            const sizeBreakdown = {};
            let totalQuantity = 0;
            
            document.querySelectorAll('.size-quantity').forEach(input => {
                const size = input.dataset.size;
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    sizeBreakdown[size] = qty;
                    totalQuantity += qty;
                }
            });
            
            if (totalQuantity === 0) {
                alert('Please enter at least one quantity');
                return;
            }
            
            // Add product
            const product = {
                styleNumber: this.currentProduct.styleNumber,
                productName: this.currentProduct.details.PRODUCT_TITLE || '',
                brand: this.currentProduct.details.BRAND_NAME || '',
                color: this.currentProduct.color,
                sizeBreakdown: sizeBreakdown,
                quantity: totalQuantity,
                locations: this.printSetup.locations
            };
            
            this.productService.addProduct(product);
            this.products = this.productService.getSelectedProducts();
            
            // Update display
            this.displayProductsList();
            
            // Reset form
            document.getElementById('style-search').value = '';
            document.getElementById('color-select').disabled = true;
            document.getElementById('color-select').innerHTML = '<option value="">Select style first</option>';
            document.getElementById('load-product-btn').disabled = true;
            document.getElementById('product-display').style.display = 'none';
            
            // Enable continue button
            document.getElementById('continue-to-summary').disabled = false;
        }
        
        displayProductsList() {
            const container = document.getElementById('products-container');
            
            if (this.products.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No products added yet. Search and add products above.</p>';
                // Hide warning when no products
                const warningElement = document.getElementById('minimum-order-warning');
                if (warningElement) {
                    warningElement.classList.remove('show');
                    warningElement.style.display = 'none';
                }
                return;
            }
            
            container.innerHTML = this.products.map((product, index) => `
                <div class="product-item">
                    <div class="product-item-info">
                        <div class="product-item-details">
                            <h4>${product.styleNumber} - ${product.productName}</h4>
                            <p>${product.color} | Quantity: ${product.quantity} | ${this.productService.formatSizeBreakdown(product.sizeBreakdown)}</p>
                        </div>
                    </div>
                    <div class="product-item-actions">
                        <button class="btn-danger" onclick="screenPrintQuoteBuilder.removeProduct(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Check minimum order after updating the product list
            this.checkMinimumOrder();
        }
        
        removeProduct(index) {
            const product = this.products[index];
            if (confirm(`Remove ${product.styleNumber} from quote?`)) {
                this.productService.removeProduct(product.id);
                this.products = this.productService.getSelectedProducts();
                this.displayProductsList();
                
                if (this.products.length === 0) {
                    document.getElementById('continue-to-summary').disabled = true;
                }
            }
        }
        
        async generateQuoteSummary() {
            try {
                // Check minimum order warning for Phase 3
                this.checkMinimumOrder();
                
                // Calculate pricing
                const pricingResult = await this.pricingService.calculateQuotePricing(
                    this.products,
                    this.printSetup
                );
                
                this.currentPricing = pricingResult;
                
                // Display summary
                const summaryContainer = document.getElementById('quote-summary');
                
                summaryContainer.innerHTML = `
                    <div class="summary-section">
                        <h3 class="summary-title">Print Setup</h3>
                        <div class="summary-row">
                            <span class="summary-label">Locations:</span>
                            <span class="summary-value">${this.printSetup.locations.map(l => this.getLocationName(l)).join(', ')}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Colors:</span>
                            <span class="summary-value">${this.formatColorDisplay()}</span>
                        </div>
                        ${this.printSetup.darkGarments ? `
                            <div class="summary-row">
                                <span class="summary-label">Dark Garments:</span>
                                <span class="summary-value">Yes (white underbase included)</span>
                            </div>
                        ` : ''}
                        ${(() => {
                            const safetyLocations = [];
                            if (this.printSetup.safetyStripesByLocation) {
                                Object.entries(this.printSetup.safetyStripesByLocation).forEach(([location, enabled]) => {
                                    if (enabled) {
                                        safetyLocations.push(this.getLocationName(location));
                                    }
                                });
                            }
                            if (safetyLocations.length > 0) {
                                return `
                                    <div class="summary-row">
                                        <span class="summary-label">Safety Stripes:</span>
                                        <span class="summary-value">${safetyLocations.join(', ')} (+$2.00/piece per location)</span>
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                    </div>
                    
                    <div class="summary-section">
                        <h3 class="summary-title">Products (${this.products.length} items, ${pricingResult.totalQuantity} pieces)</h3>
                        ${pricingResult.products.map(product => {
                            // Format product display with size breakdowns
                            let productHTML = `
                                <div class="product-summary-item">
                                    <div class="product-header">
                                        <strong>${product.styleNumber} - ${product.color}</strong>
                                    </div>
                            `;
                            
                            // Group sizes by price for cleaner display
                            const priceGroups = {};
                            Object.entries(product.pricedSizes || {}).forEach(([size, data]) => {
                                const priceKey = data.unitPrice.toFixed(2);
                                if (!priceGroups[priceKey]) {
                                    priceGroups[priceKey] = {
                                        sizes: [],
                                        unitPrice: data.unitPrice,
                                        totalQty: 0,
                                        total: 0
                                    };
                                }
                                priceGroups[priceKey].sizes.push(`${size}(${data.quantity})`);
                                priceGroups[priceKey].totalQty += data.quantity;
                                priceGroups[priceKey].total += data.lineTotal;
                            });
                            
                            // Display each price group
                            Object.values(priceGroups).forEach(group => {
                                productHTML += `
                                    <div class="summary-row" style="margin-left: 20px;">
                                        <span class="summary-label">${group.sizes.join(' ')}</span>
                                        <span class="summary-value">
                                            ${group.totalQty} pieces @ $${group.unitPrice.toFixed(2)}/ea = $${group.total.toFixed(2)}
                                        </span>
                                    </div>
                                `;
                            });
                            
                            productHTML += `</div>`;
                            return productHTML;
                        }).join('')}
                    </div>
                    
                    <div class="summary-section">
                        <h3 class="summary-title">Pricing</h3>
                        <div class="summary-row">
                            <span class="summary-label">Tier:</span>
                            <span class="summary-value">${pricingResult.pricingTier}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Products & Printing:</span>
                            <span class="summary-value">$${pricingResult.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="setup-fees-breakdown">
                            <div class="summary-row">
                                <span class="summary-label">Setup Fees (Screens):</span>
                                <span class="summary-value">$${pricingResult.setupFees.toFixed(2)}</span>
                            </div>
                            ${pricingResult.setupFeesBreakdown && pricingResult.setupFeesBreakdown.length > 0 ? `
                                <div class="setup-breakdown-details" style="margin-left: 20px; font-size: 0.9em; color: #666;">
                                    ${pricingResult.setupFeesBreakdown.map(item => `
                                        <div class="breakdown-item">
                                            ${item.location}: ${item.colors} colors${item.underbase > 0 ? ` + ${item.underbase} underbase` : ''} = ${item.totalScreens} @ $30 = $${item.subtotal.toFixed(2)}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="summary-total">
                            <div class="summary-row">
                                <span class="summary-label" style="font-size: 1.125rem;">Grand Total:</span>
                                <span class="summary-value">$${pricingResult.grandTotal.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error generating summary:', error);
                alert('Error calculating pricing. Please try again.');
            }
        }
        
        formatColorDisplay() {
            const colorDetails = [];
            
            if (this.printSetup.colorsByLocation && this.printSetup.locations) {
                this.printSetup.locations.forEach(location => {
                    const locationName = this.getLocationName(location);
                    const colorCount = this.printSetup.colorsByLocation[location] || 0;
                    
                    if (colorCount > 0) {
                        let displayText = `${locationName}: ${colorCount} ${colorCount === 1 ? 'color' : 'colors'}`;
                        
                        // Add underbase notation if dark garments
                        if (this.printSetup.darkGarments) {
                            displayText += ` (+1 underbase)`;
                        }
                        
                        colorDetails.push(displayText);
                    }
                });
            }
            
            return colorDetails.length > 0 ? colorDetails.join(', ') : 'No colors selected';
        }
        
        getTotalColors() {
            let total = 0;
            Object.values(this.printSetup.colorsByLocation).forEach(colors => {
                total += colors;
                if (this.printSetup.darkGarments) {
                    total += 1; // Add white underbase
                }
            });
            return total;
        }
        
        async generateQuote() {
            // Validate customer info
            const customerName = document.getElementById('customer-name').value.trim();
            const customerEmail = document.getElementById('customer-email').value.trim();
            const salesRep = document.getElementById('sales-rep').value;
            
            if (!customerName || !customerEmail || !salesRep) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Build quote data
            const quoteData = {
                // Customer info
                customerName: customerName,
                customerEmail: customerEmail,
                customerPhone: document.getElementById('customer-phone').value.trim(),
                companyName: document.getElementById('company-name').value.trim(),
                projectName: document.getElementById('project-name').value.trim(),
                
                // Sales info
                salesRepEmail: salesRep,
                salesRepName: this.getSalesRepName(salesRep),
                
                // Print setup
                printLocations: this.printSetup.locations,
                primaryColors: this.getTotalColors(),
                darkGarments: this.printSetup.darkGarments,
                safetyStripes: this.printSetup.safetyStripes,
                
                // Products
                items: this.products,
                totalQuantity: this.currentPricing.totalQuantity,
                
                // Pricing
                subtotal: this.currentPricing.subtotal,
                ltmFeeTotal: this.currentPricing.ltmFeeTotal,
                safetyStripesTotal: this.currentPricing.safetyStripesTotal || 0,
                setupFees: this.currentPricing.setupFees,
                grandTotal: this.currentPricing.grandTotal,
                
                // Notes
                notes: document.getElementById('special-notes').value.trim()
            };
            
            // Save to database if checked
            let quoteId = null;
            const saveToDb = document.getElementById('save-to-database').checked;
            
            if (saveToDb) {
                const saveResult = await this.quoteService.saveQuote(quoteData);
                if (saveResult.success) {
                    quoteId = saveResult.quoteID;
                    console.log('Quote saved:', quoteId);
                } else {
                    console.error('Failed to save quote:', saveResult.error);
                }
            } else {
                quoteId = this.quoteService.generateQuoteID();
            }
            
            quoteData.quoteId = quoteId;
            
            // Show success modal
            this.showSuccessModal(quoteId, saveToDb);
            
            // Store for print/copy
            this.lastQuoteData = quoteData;
        }
        
        getSalesRepName(email) {
            const reps = {
                'sales@nwcustomapparel.com': 'General Sales',
                'adriyella@nwcustomapparel.com': 'Adriyella',
                'bradley@nwcustomapparel.com': 'Bradley Wright',
                'erik@nwcustomapparel.com': 'Erik Mickelson',
                'jim@nwcustomapparel.com': 'Jim Mickelson',
                'nika@nwcustomapparel.com': 'Nika Lao',
                'ruth@nwcustomapparel.com': 'Ruth Nhong',
                'art@nwcustomapparel.com': 'Steve Deland',
                'taneisha@nwcustomapparel.com': 'Taneisha Clark'
            };
            return reps[email] || 'Sales Team';
        }
        
        showSuccessModal(quoteId, saved) {
            document.getElementById('modal-quote-id').textContent = quoteId;
            document.getElementById('modal-message').textContent = saved ? 
                'Quote has been saved to the database.' : 
                'Quote generated (not saved to database).';
            
            const modal = document.getElementById('success-modal');
            modal.classList.add('active');
        }
        
        checkMinimumOrder() {
            // Calculate total quantity across all products
            const totalQuantity = this.products.reduce((sum, product) => sum + product.quantity, 0);
            
            // Get warning elements for both phases
            const warningElement = document.getElementById('minimum-order-warning');
            const summaryWarningElement = document.getElementById('summary-minimum-order-warning');
            const quantitySpan = document.getElementById('warning-quantity');
            const summaryQuantitySpan = document.getElementById('summary-warning-quantity');
            const generateButton = document.getElementById('generate-quote-btn');
            
            if (totalQuantity > 0 && totalQuantity < 24) {
                // Show warning in Phase 2
                if (warningElement) {
                    warningElement.classList.add('show');
                    warningElement.style.display = 'flex';
                    if (quantitySpan) {
                        quantitySpan.textContent = totalQuantity;
                    }
                }
                
                // Show warning in Phase 3 (summary)
                if (summaryWarningElement) {
                    summaryWarningElement.classList.add('show');
                    summaryWarningElement.style.display = 'flex';
                    if (summaryQuantitySpan) {
                        summaryQuantitySpan.textContent = totalQuantity;
                    }
                }
                
                // Still allow generating quote but with warning visible
                if (generateButton) {
                    generateButton.disabled = false;
                }
                
                console.log(`[ScreenPrintQuoteBuilder] Minimum order warning shown. Total quantity: ${totalQuantity}`);
                return false; // Doesn't meet minimum
            } else {
                // Hide warnings in both phases
                if (warningElement) {
                    warningElement.classList.remove('show');
                    warningElement.style.display = 'none';
                }
                
                if (summaryWarningElement) {
                    summaryWarningElement.classList.remove('show');
                    summaryWarningElement.style.display = 'none';
                }
                
                // Enable generate button if we have products
                if (generateButton && this.products.length > 0) {
                    generateButton.disabled = false;
                }
                
                return true; // Meets minimum or no products
            }
        }

        navigateToPhase(phase) {
            // Hide all phases
            document.querySelectorAll('.phase-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected phase
            const phases = ['setup-phase', 'product-phase', 'summary-phase'];
            document.getElementById(phases[phase - 1]).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.phase-step').forEach(step => {
                const stepPhase = parseInt(step.dataset.phase);
                step.classList.remove('active', 'completed');
                
                if (stepPhase < phase) {
                    step.classList.add('completed');
                } else if (stepPhase === phase) {
                    step.classList.add('active');
                }
            });
            
            this.currentPhase = phase;
        }
    }
    
    // Initialize the application
    const screenPrintQuoteBuilder = new ScreenPrintQuoteBuilder();
    
    // Initialize Phase 1 Infrastructure
    let quoteBuilderBase;
    let quoteFormatter;
    
    // Initialize base classes with inline fallback when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Screen Print Quote Builder Phase 1 initializing...');
        
        // Check if external files loaded, provide fallback if not
        if (typeof QuoteBuilderBase === 'undefined') {
            console.warn('⚠️ External QuoteBuilderBase not loaded, creating inline fallback');
            
            // Inline fallback for QuoteBuilderBase
            window.QuoteBuilderBase = class {
                constructor(config) {
                    this.config = config;
                    console.log('✅ Fallback QuoteBuilderBase initialized');
                }
                showSuccess(msg) { 
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:15px 20px;border-radius:5px;z-index:10000';
                    toast.textContent = msg;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                showError(msg) { 
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#dc3545;color:white;padding:15px 20px;border-radius:5px;z-index:10000';
                    toast.textContent = msg;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                showInfo(msg) { 
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#17a2b8;color:white;padding:15px 20px;border-radius:5px;z-index:10000';
                    toast.textContent = msg;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                showLoading(show, msg) { 
                    let overlay = document.getElementById('loading-overlay-fallback');
                    if (show) {
                        if (!overlay) {
                            overlay = document.createElement('div');
                            overlay.id = 'loading-overlay-fallback';
                            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
                            overlay.innerHTML = '<div style="background:white;padding:20px;border-radius:5px"><div>' + (msg || 'Loading...') + '</div></div>';
                            document.body.appendChild(overlay);
                        }
                    } else if (overlay) {
                        overlay.remove();
                    }
                }
                markDirty() { /* Auto-save tracking */ }
                validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
                debounce(func, wait) { 
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                }
            };
        } else {
            console.log('✅ External QuoteBuilderBase loaded successfully');
        }
        
        if (typeof QuoteFormatter === 'undefined') {
            console.warn('⚠️ External QuoteFormatter not loaded, creating inline fallback');
            
            // Inline fallback for QuoteFormatter
            window.QuoteFormatter = class {
                constructor() {
                    console.log('✅ Fallback QuoteFormatter initialized');
                }
                openPrintDialog(data) {
                    const printWindow = window.open('', '_blank', 'width=800,height=600');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Quote ${data.quoteId}</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #003f7f; padding-bottom: 20px; }
                                .logo { color: #003f7f; font-size: 24px; font-weight: bold; }
                                .info-row { display: flex; justify-content: space-between; margin: 10px 0; }
                                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                th { background: #003f7f; color: white; padding: 10px; text-align: left; }
                                td { padding: 10px; border-bottom: 1px solid #ddd; }
                                .total-row { font-weight: bold; font-size: 18px; text-align: right; margin-top: 20px; }
                                @media print { button { display: none; } }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <div class="logo">NORTHWEST CUSTOM APPAREL</div>
                                <div>Since 1977 | 253-922-5793 | sales@nwcustomapparel.com</div>
                                <h2 style="color: #003f7f;">Quote #${data.quoteId}</h2>
                            </div>
                            <div class="info-row">
                                <div><strong>Customer:</strong> ${data.customerName}</div>
                                <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
                            </div>
                            <div class="info-row">
                                <div><strong>Company:</strong> ${data.companyName || 'N/A'}</div>
                                <div><strong>Project:</strong> ${data.projectName || 'N/A'}</div>
                            </div>
                            <div class="info-row">
                                <div><strong>Email:</strong> ${data.customerEmail}</div>
                                <div><strong>Phone:</strong> ${data.customerPhone}</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item Description</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(data.items || []).map(item => `
                                        <tr>
                                            <td>${item.style ? item.style + ' - ' : ''}${item.description || item.name || 'Item'}</td>
                                            <td>${item.quantity}</td>
                                            <td>$${(item.unitPrice || 0).toFixed(2)}</td>
                                            <td>$${(item.total || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <div class="total-row">
                                TOTAL: $${(data.grandTotal || 0).toFixed(2)}
                            </div>
                            <button onclick="window.print()" style="margin-top:20px;padding:10px 20px;background:#003f7f;color:white;border:none;border-radius:5px;cursor:pointer">Print Quote</button>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                }
                async copyToClipboard(data) {
                    const text = [
                        `NORTHWEST CUSTOM APPAREL - QUOTE #${data.quoteId}`,
                        `Date: ${new Date().toLocaleDateString()}`,
                        '',
                        `Customer: ${data.customerName}`,
                        `Company: ${data.companyName || 'N/A'}`,
                        `Email: ${data.customerEmail}`,
                        `Phone: ${data.customerPhone}`,
                        `Project: ${data.projectName || 'N/A'}`,
                        '',
                        'QUOTE DETAILS:',
                        '----------------------------',
                        ...(data.items || []).map(item => 
                            `${item.style ? item.style + ' - ' : ''}${item.description || item.name}: ${item.quantity} units @ $${(item.unitPrice || 0).toFixed(2)} = $${(item.total || 0).toFixed(2)}`
                        ),
                        '----------------------------',
                        `TOTAL: $${(data.grandTotal || 0).toFixed(2)}`,
                        '',
                        'Thank you for your business!',
                        'Northwest Custom Apparel | 253-922-5793'
                    ].join('\n');
                    
                    try {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } catch (e) {
                        console.error('Copy failed:', e);
                        // Fallback method
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        document.body.appendChild(textarea);
                        textarea.select();
                        const success = document.execCommand('copy');
                        document.body.removeChild(textarea);
                        return success;
                    }
                }
                openEmailClient(data) {
                    const subject = `Quote #${data.quoteId} - Northwest Custom Apparel`;
                    const body = [
                        `Dear ${data.customerName},`,
                        '',
                        `Thank you for your interest in Northwest Custom Apparel. Please find your quote details below:`,
                        '',
                        `Quote ID: ${data.quoteId}`,
                        `Total: $${(data.grandTotal || 0).toFixed(2)}`,
                        '',
                        'Quote Details:',
                        ...(data.items || []).map(item => 
                            `• ${item.style ? item.style + ' - ' : ''}${item.description || item.name}: ${item.quantity} units @ $${(item.unitPrice || 0).toFixed(2)}`
                        ),
                        '',
                        'This quote is valid for 30 days. Please contact us at 253-922-5793 with any questions.',
                        '',
                        'Best regards,',
                        'Northwest Custom Apparel Team',
                        'sales@nwcustomapparel.com',
                        '253-922-5793'
                    ].join('\n');
                    
                    window.location.href = `mailto:${data.customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                }
            };
        } else {
            console.log('✅ External QuoteFormatter loaded successfully');
        }
        
        // Initialize with either real or fallback classes
        quoteBuilderBase = new QuoteBuilderBase({
            prefix: 'SP',
            autoSaveInterval: 30000
        });
        
        // Initialize formatter
        quoteFormatter = new QuoteFormatter();
        
        // Add input event listeners for auto-save
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('change', () => quoteBuilderBase.markDirty());
            input.addEventListener('input', quoteBuilderBase.debounce(() => quoteBuilderBase.markDirty(), 500));
        });
        
        // Add phone formatting
        document.getElementById('customer-phone')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
            } else if (value.length >= 3) {
                value = `(${value.slice(0,3)}) ${value.slice(3)}`;
            }
            e.target.value = value;
            
            if (value.replace(/\D/g, '').length === 10) {
                e.target.classList.remove('is-invalid');
                e.target.classList.add('is-valid');
            } else if (value.length > 0) {
                e.target.classList.add('is-invalid');
                e.target.classList.remove('is-valid');
            }
        });
        
        // Add email validation
        document.getElementById('customer-email')?.addEventListener('blur', function(e) {
            const email = e.target.value;
            const isValid = quoteBuilderBase.validateEmail(email);
            
            if (isValid) {
                e.target.classList.remove('is-invalid');
                e.target.classList.add('is-valid');
            } else if (email.length > 0) {
                e.target.classList.add('is-invalid');
                e.target.classList.remove('is-valid');
            }
        });
    });
    
    // Global functions for buttons - Updated with Phase 1 features
    function printQuote() {
        if (!screenPrintQuoteBuilder.lastQuoteData) {
            quoteBuilderBase?.showError('No quote data available');
            return;
        }
        // Use formatter for professional print
        if (quoteFormatter) {
            quoteFormatter.openPrintDialog(screenPrintQuoteBuilder.lastQuoteData);
        } else {
            window.print(); // Fallback
        }
    }
    
    function copyQuote() {
        if (!screenPrintQuoteBuilder.lastQuoteData) {
            quoteBuilderBase?.showError('No quote data available');
            return;
        }
        
        if (quoteFormatter) {
            quoteFormatter.copyToClipboard(screenPrintQuoteBuilder.lastQuoteData).then(success => {
                if (success) {
                    quoteBuilderBase.showSuccess('Quote copied to clipboard!');
                } else {
                    quoteBuilderBase.showError('Failed to copy quote');
                }
            });
        } else {
            // Fall back to existing copyQuoteToClipboard
            copyQuoteToClipboard();
        }
    }
    
    function emailQuote() {
        if (!screenPrintQuoteBuilder.lastQuoteData) {
            quoteBuilderBase?.showError('No quote data available');
            return;
        }
        if (quoteFormatter) {
            quoteFormatter.openEmailClient(screenPrintQuoteBuilder.lastQuoteData);
        } else {
            quoteBuilderBase?.showError('Email function not available');
        }
    }
    
    function newQuote() {
        if (confirm('Start a new quote? Any unsaved changes will be lost.')) {
            localStorage.removeItem('SP_draft');
            location.reload();
        }
    }
    
    function closeModal() {
        document.getElementById('success-modal').style.display = 'none';
    }
    
    // Keep existing copyQuoteToClipboard for backward compatibility
    function copyQuoteToClipboard() {
        if (!screenPrintQuoteBuilder.lastQuoteData) return;
        
        const quoteText = `Screen Print Quote ${screenPrintQuoteBuilder.lastQuoteData.quoteId}
        
Customer: ${screenPrintQuoteBuilder.lastQuoteData.customerName}
Company: ${screenPrintQuoteBuilder.lastQuoteData.companyName || 'N/A'}

Total Quantity: ${screenPrintQuoteBuilder.lastQuoteData.totalQuantity} pieces
Grand Total: $${screenPrintQuoteBuilder.lastQuoteData.grandTotal.toFixed(2)}

This quote is valid for 30 days.`;
        
        navigator.clipboard.writeText(quoteText).then(() => {
            alert('Quote copied to clipboard!');
        });
    }
    
    function startNewQuote() {
        if (confirm('Start a new quote? This will clear all current data.')) {
            window.location.reload();
        }
    }
    
    // Testing utilities
    console.log('%c✅ Screen Print Quote Builder Loaded Successfully', 'color: #4cb354; font-size: 16px; font-weight: bold;');
    console.log('Services initialized:', {
        quoteService: !!screenPrintQuoteBuilder.quoteService,
        productService: !!screenPrintQuoteBuilder.productService,
        pricingService: !!screenPrintQuoteBuilder.pricingService
    });
    
    // Add test helpers to window for console testing
    window.SP_TEST = {
        builder: screenPrintQuoteBuilder,
        checkState: () => ({
            phase: screenPrintQuoteBuilder.currentPhase,
            locations: screenPrintQuoteBuilder.printSetup.locations,
            colors: screenPrintQuoteBuilder.printSetup.colorsByLocation,
            dark: screenPrintQuoteBuilder.printSetup.darkGarments,
            safety: screenPrintQuoteBuilder.printSetup.safetyStripes,
            products: screenPrintQuoteBuilder.products
        }),
        testSearch: async (term) => {
            const results = await screenPrintQuoteBuilder.productService.searchProducts(term);
            console.log(`Found ${results.length} products for "${term}":`, results.slice(0, 5));
            return results;
        },
        generateQuoteId: () => {
            const id = screenPrintQuoteBuilder.quoteService.generateQuoteID();
            console.log('Generated Quote ID:', id);
            return id;
        },
        selectLocations: (...codes) => {
            codes.forEach(code => {
                const card = document.querySelector(`[data-location="${code}"]`);
                if (card) card.click();
            });
            console.log('Selected locations:', screenPrintQuoteBuilder.printSetup.locations);
        },
        setToggles: (dark, safety) => {
            document.getElementById('dark-garment-toggle').checked = dark;
            document.getElementById('dark-garment-toggle').dispatchEvent(new Event('change'));
            document.getElementById('safety-stripes-toggle').checked = safety;
            document.getElementById('safety-stripes-toggle').dispatchEvent(new Event('change'));
            console.log('Toggles set:', {dark, safety});
        },
        // New debug function for testing sizes API
        testSizes: async (style, color) => {
            console.log(`Testing sizes API for ${style} in ${color}...`);
            try {
                const sizes = await screenPrintQuoteBuilder.productService.getAvailableSizes(style, color);
                console.log('✅ Sizes loaded successfully:', sizes);
                return sizes;
            } catch (error) {
                console.error('❌ Failed to load sizes:', error);
                return null;
            }
        },
        // Quick test for PC54
        testPC54: async () => {
            console.log('Running PC54 test...');
            // Step 1: Search for PC54
            await SP_TEST.testSearch('PC54');
            // Step 2: Select style
            document.getElementById('style-search').value = 'PC54';
            await screenPrintQuoteBuilder.selectProductStyle('PC54');
            // Step 3: Test sizes for common color
            const sizes = await SP_TEST.testSizes('PC54', 'Woodland Brown');
            console.log('PC54 test complete. Sizes:', sizes);
            return sizes;
        }
    };
    
    console.log('🧪 Test helpers available at window.SP_TEST');
    console.log('Try: SP_TEST.checkState() or SP_TEST.testSearch("PC54")');
    
    // Phase 2 Persistence Integration - v20250911
    // This is READ ONLY - does not interfere with pricing calculations
    console.log('🔄 Phase 2: Initializing quote persistence system...');
    console.log('ℹ️  Note: Persistence system is READ ONLY and does not affect pricing calculations');
    
    // Initialize persistence system (READ ONLY - separate from calculations)
    if (typeof QuotePersistence !== 'undefined' && typeof QuoteSession !== 'undefined') {
        try {
            // Initialize persistence
            const persistence = new QuotePersistence({
                prefix: 'SP',
                autoSave: true,
                autoSaveInterval: 30000, // 30 seconds
                debug: true
            });
            
            // Initialize session
            const session = new QuoteSession({
                prefix: 'SP',
                persistence: persistence,
                debug: true
            });
            
            // Phase 3: Initialize validation and UI feedback
            console.log('🚀 Phase 3: Initializing advanced features...');
            
            // Initialize validation system
            const validation = new QuoteValidation({
                requiredFields: ['customer-name', 'customer-email', 'sales-rep'],
                autoFormat: true,
                realTimeValidation: true
            });
            
            // Initialize UI feedback system
            const uiFeedback = new QuoteUIFeedback({
                toastDuration: 3000,
                toastPosition: 'bottom-right',
                loadingText: 'Processing...'
            });
            
            // Make UI feedback globally available
            window.validation = validation;
            window.uiFeedback = uiFeedback;
            
            // Function to collect form data (READ ONLY - doesn't affect calculations)
            function collectFormDataForSave() {
                const data = {
                    // Customer info
                    customerName: document.getElementById('customer-name')?.value || '',
                    customerEmail: document.getElementById('customer-email')?.value || '',
                    customerPhone: document.getElementById('customer-phone')?.value || '',
                    companyName: document.getElementById('company-name')?.value || '',
                    projectName: document.getElementById('project-name')?.value || '',
                    salesRep: document.getElementById('sales-rep')?.value || '',
                    specialNotes: document.getElementById('special-notes')?.value || '',
                    
                    // Current selections (just saving state, not changing calculations)
                    selectedInkColors: document.querySelector('input[name="ink-colors"]:checked')?.value || '',
                    selectedSides: document.querySelector('input[name="print-sides"]:checked')?.value || '',
                    
                    // Products (if any are loaded)
                    products: window.screenprintQuoteBuilder?.products || [],
                    
                    // Timestamp
                    lastModified: new Date().toISOString()
                };
                
                return data;
            }
            
            // Function to restore form data (just fills in fields, calculations run normally)
            function restoreFormDataFromSave(data) {
                console.log('📂 Restoring saved draft...');
                
                // Restore customer info
                if (data.customerName) document.getElementById('customer-name').value = data.customerName;
                if (data.customerEmail) document.getElementById('customer-email').value = data.customerEmail;
                if (data.customerPhone) document.getElementById('customer-phone').value = data.customerPhone;
                if (data.companyName) document.getElementById('company-name').value = data.companyName;
                if (data.projectName) document.getElementById('project-name').value = data.projectName;
                if (data.salesRep) document.getElementById('sales-rep').value = data.salesRep;
                if (data.specialNotes) document.getElementById('special-notes').value = data.specialNotes;
                
                // Restore selections (this will trigger normal calculation flow)
                if (data.selectedInkColors) {
                    const colorsRadio = document.querySelector(`input[name="ink-colors"][value="${data.selectedInkColors}"]`);
                    if (colorsRadio) {
                        colorsRadio.checked = true;
                        colorsRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
                
                if (data.selectedSides) {
                    const sidesRadio = document.querySelector(`input[name="print-sides"][value="${data.selectedSides}"]`);
                    if (sidesRadio) {
                        sidesRadio.checked = true;
                        sidesRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            }
            
            // Function to show save indicator
            function showSaveIndicator(message = 'Draft saved') {
                const indicator = document.getElementById('save-indicator');
                const status = document.getElementById('save-status');
                if (indicator && status) {
                    status.textContent = message;
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 3000);
                }
            }
            
            // Set up auto-save
            persistence.onAutoSave = function() {
                const data = collectFormDataForSave();
                if (persistence.save(data)) {
                    showSaveIndicator('Draft saved');
                    console.log('💾 Auto-save completed');
                }
            };
            
            // Mark as dirty when inputs change
            document.querySelectorAll('#customer-name, #customer-email, #customer-phone, #company-name, #project-name, #sales-rep, #special-notes').forEach(input => {
                input.addEventListener('input', () => {
                    persistence.markDirty();
                });
                input.addEventListener('change', () => {
                    persistence.markDirty();
                });
            });
            
            // Check for recovery on page load
            setTimeout(() => {
                if (session.shouldShowRecovery()) {
                    session.showRecoveryDialog(
                        (draft) => {
                            restoreFormDataFromSave(draft);
                            showSaveIndicator('Draft restored');
                        },
                        () => {
                            console.log('Starting fresh quote');
                            showSaveIndicator('Starting new quote');
                        }
                    );
                }
            }, 1000);
            
            // Store references for potential use elsewhere
            window.quotePersistence = persistence;
            window.quoteSession = session;
            
            console.log('✅ SP Persistence initialized (auto-save enabled)');
            console.log('ℹ️ Your pricing calculations remain completely unchanged');
            
        } catch (error) {
            console.warn('⚠️ Phase 2 persistence initialization failed:', error);
            console.log('💡 Quote builder will continue to work normally');
        }
    } else {
        console.warn('⚠️ Phase 2 persistence files not loaded - quote builder will work without persistence');
    }
    </script>
</body>
</html>