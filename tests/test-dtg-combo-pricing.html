<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTG Combo Pricing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4cb354;
            padding-bottom: 10px;
        }
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .location-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .location-card h3 {
            margin-top: 0;
            color: #2d5f3f;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .price-row:last-child {
            border-bottom: none;
        }
        .status {
            padding: 8px 15px;
            border-radius: 5px;
            margin: 5px 0;
            display: inline-block;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .expected-vs-actual {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison-box {
            padding: 15px;
            border-radius: 8px;
        }
        .expected {
            background: #e8f5e9;
            border: 1px solid #4caf50;
        }
        .actual {
            background: #fff3e0;
            border: 1px solid #ff9800;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .match {
            color: green;
            font-weight: bold;
        }
        .mismatch {
            color: red;
            font-weight: bold;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4cb354;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #3ea146;
        }
    </style>
</head>
<body>
    <h1>DTG Combo Pricing Test</h1>

    <div class="test-section">
        <h2>Test Configuration</h2>
        <p>This test verifies that combo location pricing matches the expected values.</p>
        <p><strong>Style:</strong> PC54</p>
        <p><strong>Base Garment Cost:</strong> $<span id="baseGarmentCost">-</span></p>
        <div id="test-status"></div>
    </div>

    <div class="test-section">
        <h2>Control Panel</h2>
        <button onclick="loadDTGPricing()">Load DTG Pricing Data</button>
        <button onclick="testComboPricing()">Test Combo Calculations</button>
        <button onclick="compareWithExpected()">Compare with Expected</button>
    </div>

    <div class="test-section">
        <h2>Expected vs Actual Prices</h2>
        <div class="expected-vs-actual">
            <div class="comparison-box expected">
                <h3>Expected Prices (from User)</h3>
                <table>
                    <tr>
                        <th>Location</th>
                        <th>24-47</th>
                        <th>48-71</th>
                        <th>72+</th>
                    </tr>
                    <tr>
                        <td>Left Chest + Full Back</td>
                        <td>$26.50</td>
                        <td>$23.00</td>
                        <td>$21.00</td>
                    </tr>
                    <tr>
                        <td>Left Chest + Jumbo Back</td>
                        <td>$28.50</td>
                        <td>$25.00</td>
                        <td>$23.00</td>
                    </tr>
                    <tr>
                        <td>Full Front + Full Back</td>
                        <td>$29.00</td>
                        <td>$24.00</td>
                        <td>$22.00</td>
                    </tr>
                    <tr>
                        <td>Jumbo Front + Jumbo Back</td>
                        <td>$33.00</td>
                        <td>$28.00</td>
                        <td>$26.00</td>
                    </tr>
                </table>
            </div>
            <div class="comparison-box actual">
                <h3>Actual Calculated Prices</h3>
                <table id="actualPricesTable">
                    <tr>
                        <th>Location</th>
                        <th>24-47</th>
                        <th>48-71</th>
                        <th>72+</th>
                    </tr>
                    <tr>
                        <td>Left Chest + Full Back</td>
                        <td id="LC_FB_24">-</td>
                        <td id="LC_FB_48">-</td>
                        <td id="LC_FB_72">-</td>
                    </tr>
                    <tr>
                        <td>Left Chest + Jumbo Back</td>
                        <td id="LC_JB_24">-</td>
                        <td id="LC_JB_48">-</td>
                        <td id="LC_JB_72">-</td>
                    </tr>
                    <tr>
                        <td>Full Front + Full Back</td>
                        <td id="FF_FB_24">-</td>
                        <td id="FF_FB_48">-</td>
                        <td id="FF_FB_72">-</td>
                    </tr>
                    <tr>
                        <td>Jumbo Front + Jumbo Back</td>
                        <td id="JF_JB_24">-</td>
                        <td id="JF_JB_48">-</td>
                        <td id="JF_JB_72">-</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>Debug Information</h2>
        <pre id="debug-info">No data loaded</pre>
    </div>

    <script>
        let pricingData = null;
        let baseGarmentCost = 0;

        // Expected values from user
        const expectedPrices = {
            'LC_FB': { '24-47': 26.50, '48-71': 23.00, '72-143': 21.00, '144-9999': 21.00 },
            'LC_JB': { '24-47': 28.50, '48-71': 25.00, '72-143': 23.00, '144-9999': 23.00 },
            'FF_FB': { '24-47': 29.00, '48-71': 24.00, '72-143': 22.00, '144-9999': 22.00 },
            'JF_JB': { '24-47': 33.00, '48-71': 28.00, '72-143': 26.00, '144-9999': 26.00 }
        };

        async function loadDTGPricing() {
            const statusEl = document.getElementById('test-status');
            statusEl.innerHTML = '<div class="status info">Loading DTG pricing data...</div>';

            try {
                // Load pricing bundle for PC54
                const response = await fetch('https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/pricing-bundle?method=DTG&styleNumber=PC54');
                const data = await response.json();

                if (!response.ok || !data) {
                    statusEl.innerHTML = '<div class="status error">Failed to load DTG pricing data</div>';
                    return;
                }

                pricingData = data;

                // Calculate base garment cost
                if (data.sizes && data.sizes.length > 0) {
                    const basePrices = data.sizes.map(s => parseFloat(s.price));
                    baseGarmentCost = Math.min(...basePrices.filter(p => p > 0));
                    document.getElementById('baseGarmentCost').textContent = baseGarmentCost.toFixed(2);
                }

                statusEl.innerHTML = '<div class="status success">DTG pricing data loaded successfully</div>';

                // Display debug info
                document.getElementById('debug-info').textContent = JSON.stringify({
                    baseGarmentCost: baseGarmentCost,
                    tiers: data.tierData || data.tiers,
                    printCosts: data.pricing?.costs?.slice(0, 5) || 'No cost data'
                }, null, 2);

            } catch (error) {
                console.error('Error loading DTG pricing:', error);
                statusEl.innerHTML = '<div class="status error">Error: ' + error.message + '</div>';
            }
        }

        function getDTGPriceForSingleLocation(locationCode, tierLabel, tier) {
            if (!pricingData || !pricingData.pricing || !pricingData.pricing.costs) {
                // Use default single location prices
                const defaults = {
                    'LC': { '24-47': 13.00, '48-71': 12.00, '72-143': 11.00 },
                    'FF': { '24-47': 15.50, '48-71': 13.00, '72-143': 12.50 },
                    'FB': { '24-47': 15.50, '48-71': 13.00, '72-143': 12.50 },
                    'JF': { '24-47': 17.50, '48-71': 15.00, '72-143': 14.50 },
                    'JB': { '24-47': 17.50, '48-71': 15.00, '72-143': 14.50 }
                };
                return defaults[locationCode]?.[tierLabel] || 13.00;
            }

            // Get decoration cost
            const costData = pricingData.pricing.costs?.find(c =>
                c.PrintLocationCode === locationCode && c.TierLabel === tierLabel
            );

            if (tier && costData) {
                const marginDenominator = tier.MarginDenominator || 0.60;
                const decorationCost = parseFloat(costData.PrintCost) || 0;
                const garmentWithMargin = baseGarmentCost / marginDenominator;
                const calculatedPrice = garmentWithMargin + decorationCost;
                return Math.ceil(calculatedPrice * 2) / 2;
            }

            return null;
        }

        function getDTGPriceForComboLocation(locationCode, tierLabel, tier) {
            if (!pricingData || !pricingData.pricing || !pricingData.pricing.costs) {
                console.warn('No pricing data available');
                return expectedPrices[locationCode]?.[tierLabel] || null;
            }

            // Split combo location code (e.g., 'LC_FB' -> ['LC', 'FB'])
            const [firstLocation, secondLocation] = locationCode.split('_');

            // Get the already-calculated price for the first location (includes margin + first print cost)
            let basePrice = getDTGPriceForSingleLocation(firstLocation, tierLabel, tier);

            // Add the raw print cost for the second location (no margin applied)
            const secondCost = pricingData.pricing.costs?.find(c =>
                c.PrintLocationCode === secondLocation && c.TierLabel === tierLabel
            );

            if (secondCost && secondCost.PrintCost) {
                basePrice += parseFloat(secondCost.PrintCost);
                // Round to nearest half dollar
                basePrice = Math.ceil(basePrice * 2) / 2;

                console.log(`Combo ${locationCode}: FirstLoc=${firstLocation}($${getDTGPriceForSingleLocation(firstLocation, tierLabel, tier)}), SecondPrintCost=$${secondCost.PrintCost}, Final=$${basePrice}`);
            }

            return basePrice || expectedPrices[locationCode]?.[tierLabel] || null;
        }

        function testComboPricing() {
            if (!pricingData) {
                alert('Please load pricing data first');
                return;
            }

            const combos = ['LC_FB', 'LC_JB', 'FF_FB', 'JF_JB'];
            const tierLabels = ['24-47', '48-71', '72-143'];

            // Get tier data
            const tiers = pricingData.tierData || pricingData.tiers;

            combos.forEach(combo => {
                tierLabels.forEach(tierLabel => {
                    const tier = tiers[tierLabel] || Object.values(tiers).find(t => t.TierLabel === tierLabel);
                    const price = getDTGPriceForComboLocation(combo, tierLabel, tier);

                    // Update display
                    const cellId = `${combo}_${tierLabel.split('-')[0]}`;
                    const cell = document.getElementById(cellId);
                    if (cell) {
                        cell.textContent = price ? `$${price.toFixed(2)}` : '-';

                        // Check if matches expected
                        const expected = expectedPrices[combo]?.[tierLabel];
                        if (expected && price) {
                            if (Math.abs(price - expected) < 0.01) {
                                cell.className = 'match';
                            } else {
                                cell.className = 'mismatch';
                            }
                        }
                    }
                });
            });
        }

        function compareWithExpected() {
            testComboPricing();

            let resultsHTML = '<h3>Comparison Results</h3>';
            let allMatch = true;

            const combos = ['LC_FB', 'LC_JB', 'FF_FB', 'JF_JB'];
            const tierLabels = ['24-47', '48-71', '72-143'];

            combos.forEach(combo => {
                tierLabels.forEach(tierLabel => {
                    const cellId = `${combo}_${tierLabel.split('-')[0]}`;
                    const actualCell = document.getElementById(cellId);
                    const actualValue = actualCell ? parseFloat(actualCell.textContent.replace('$', '')) : null;
                    const expectedValue = expectedPrices[combo]?.[tierLabel];

                    if (actualValue && expectedValue) {
                        const match = Math.abs(actualValue - expectedValue) < 0.01;
                        if (!match) {
                            allMatch = false;
                            resultsHTML += `<div class="status error">❌ ${combo} @ ${tierLabel}: Expected $${expectedValue}, Got $${actualValue}</div>`;
                        } else {
                            resultsHTML += `<div class="status success">✓ ${combo} @ ${tierLabel}: $${actualValue} matches!</div>`;
                        }
                    }
                });
            });

            if (allMatch) {
                resultsHTML = '<div class="status success">✓ All combo prices match expected values!</div>' + resultsHTML;
            } else {
                resultsHTML = '<div class="status error">❌ Some prices do not match expected values</div>' + resultsHTML;
            }

            document.getElementById('test-results').innerHTML = resultsHTML;
        }

        // Auto-load when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // loadDTGPricing();  // Uncomment to auto-load
        });
    </script>
</body>
</html>