<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Screen Print Quote Builder Tests</title>
</head>
<body>
    <h1>Screen Print Quote Builder Test Suite</h1>
    <div id="test-results"></div>
    
    <!-- Load dependencies -->
    <script src="/shared_components/js/screenprint-quote-service.js"></script>
    <script src="/shared_components/js/screenprint-quote-products.js"></script>
    <script src="/shared_components/js/screenprint-quote-pricing.js"></script>
    <script src="/shared_components/js/screenprint-pricing-service.js"></script>
    
    <script>
    // Comprehensive test suite
    async function runTests() {
        const results = document.getElementById('test-results');
        let testsPassed = 0;
        let testsFailed = 0;
        
        function logTest(name, success, message = '') {
            const color = success ? 'green' : 'red';
            const status = success ? '✅ PASSED' : '❌ FAILED';
            results.innerHTML += `<div style="margin: 10px 0; color: ${color};">
                ${status} - ${name} ${message ? `: ${message}` : ''}
            </div>`;
            if (success) testsPassed++; else testsFailed++;
        }
        
        results.innerHTML = '<h2>Running Tests...</h2>';
        
        try {
            // Test 1: Service Initialization
            console.log('Testing service initialization...');
            const quoteService = new ScreenPrintQuoteService();
            logTest('ScreenPrintQuoteService Initialization', true);
            
            const productService = new ScreenPrintProductManager();
            logTest('ScreenPrintProductManager Initialization', true);
            
            const pricingService = new ScreenPrintPricingCalculator();
            logTest('ScreenPrintPricingCalculator Initialization', true);
            
            const screenPrintService = new ScreenPrintPricingService();
            logTest('ScreenPrintPricingService Initialization', true);
            
            // Test 2: Quote ID Generation
            console.log('Testing quote ID generation...');
            const quoteId = quoteService.generateQuoteID();
            const isValidFormat = /^SP\d{4}-\d+$/.test(quoteId);
            logTest('Quote ID Generation', isValidFormat, `Generated: ${quoteId}`);
            
            // Test 3: Product Search
            console.log('Testing product search...');
            try {
                const searchResults = await productService.searchProducts('PC54');
                const hasResults = searchResults && Array.isArray(searchResults);
                logTest('Product Search', hasResults, `Found ${searchResults ? searchResults.length : 0} results`);
            } catch (error) {
                logTest('Product Search', false, error.message);
            }
            
            // Test 4: Pricing Calculation
            console.log('Testing pricing calculation...');
            const testSetup = {
                locations: ['FF'],
                colorsByLocation: {'FF': 2},
                darkGarments: false,
                safetyStripes: false
            };
            
            const testProducts = [{
                styleNumber: 'PC54',
                productName: 'Test Shirt',
                quantity: 48,
                sizeBreakdown: {'M': 24, 'L': 24}
            }];
            
            try {
                const pricing = await pricingService.calculateQuotePricing(testSetup, testProducts);
                const hasPricing = pricing && pricing.totalAmount > 0;
                logTest('Pricing Calculation', hasPricing, `Total: $${pricing ? pricing.totalAmount : 0}`);
            } catch (error) {
                logTest('Pricing Calculation', false, error.message);
            }
            
            // Test 5: Dark Garments Logic
            console.log('Testing dark garments logic...');
            const darkSetup = {...testSetup, darkGarments: true};
            try {
                const darkPricing = await pricingService.calculateQuotePricing(darkSetup, testProducts);
                const hasHigherPrice = darkPricing && darkPricing.totalAmount > 0;
                logTest('Dark Garments Pricing', hasHigherPrice, 'White underbase adds cost');
            } catch (error) {
                logTest('Dark Garments Pricing', false, error.message);
            }
            
            // Test 6: Safety Stripes Logic
            console.log('Testing safety stripes logic...');
            const safetySetup = {...testSetup, safetyStripes: true};
            try {
                const safetyPricing = await pricingService.calculateQuotePricing(safetySetup, testProducts);
                const hasSafetyPrice = safetyPricing && safetyPricing.totalAmount > 0;
                logTest('Safety Stripes Pricing', hasSafetyPrice, 'Safety stripes add $6/unit');
            } catch (error) {
                logTest('Safety Stripes Pricing', false, error.message);
            }
            
            // Test 7: Size Breakdown
            console.log('Testing size breakdown...');
            const sizeBreakdown = {'S': 10, 'M': 15, 'L': 15, 'XL': 8};
            const totalQty = Object.values(sizeBreakdown).reduce((sum, qty) => sum + qty, 0);
            logTest('Size Breakdown Calculation', totalQty === 48, `Total: ${totalQty}`);
            
            // Test 8: Multiple Locations
            console.log('Testing multiple print locations...');
            const multiLocationSetup = {
                locations: ['FF', 'FB'],
                colorsByLocation: {'FF': 2, 'FB': 1},
                darkGarments: false,
                safetyStripes: false
            };
            
            try {
                const multiPricing = await pricingService.calculateQuotePricing(multiLocationSetup, testProducts);
                const hasMultiPrice = multiPricing && multiPricing.totalAmount > 0;
                logTest('Multiple Location Pricing', hasMultiPrice, '2 locations calculated');
            } catch (error) {
                logTest('Multiple Location Pricing', false, error.message);
            }
            
            // Test 9: API Connectivity
            console.log('Testing API connectivity...');
            try {
                const response = await fetch('https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/health');
                const isHealthy = response.ok;
                logTest('API Health Check', isHealthy);
            } catch (error) {
                logTest('API Health Check', false, 'API unreachable');
            }
            
            // Test 10: Session Storage
            console.log('Testing session storage...');
            const testData = {test: 'data'};
            sessionStorage.setItem('sp_test', JSON.stringify(testData));
            const retrieved = JSON.parse(sessionStorage.getItem('sp_test'));
            const storageWorks = retrieved && retrieved.test === 'data';
            logTest('Session Storage', storageWorks);
            sessionStorage.removeItem('sp_test');
            
        } catch (error) {
            results.innerHTML += `<div style="color: red; margin: 20px 0;">
                Test suite error: ${error.message}
            </div>`;
        }
        
        // Summary
        results.innerHTML += `
            <h2 style="margin-top: 30px;">Test Summary</h2>
            <div style="font-size: 1.2em;">
                <span style="color: green;">✅ Passed: ${testsPassed}</span> | 
                <span style="color: red;">❌ Failed: ${testsFailed}</span>
            </div>
            <div style="margin-top: 10px;">
                ${testsPassed === testsPassed + testsFailed ? 
                    '<strong style="color: green;">All tests passed! ✨</strong>' : 
                    '<strong style="color: orange;">Some tests failed. Check console for details.</strong>'}
            </div>
        `;
        
        console.log('Test Results:', {passed: testsPassed, failed: testsFailed});
    }
    
    // Run tests on load
    window.onload = () => {
        console.log('Starting Screen Print Quote Builder Test Suite...');
        runTests();
    };
    </script>
</body>
</html>