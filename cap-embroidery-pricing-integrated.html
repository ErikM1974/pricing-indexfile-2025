<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cap Embroidery Pricing | Northwest Custom Apparel</title>
    
    <!-- Keep existing header styles for compatibility -->
    <link rel="stylesheet" href="/shared_components/css/shared-pricing-styles.css">
    <link rel="stylesheet" href="/shared_components/css/universal-header.css">
    
    <!-- Modern enhancements for consistent design -->
    <link rel="stylesheet" href="/shared_components/css/modern-enhancements.css">
    
    <!-- Essential styles for image gallery and color swatches -->
    <link rel="stylesheet" href="/shared_components/css/universal-image-gallery.css">
    <link rel="stylesheet" href="/shared_components/css/universal-product-display.css">
    <link rel="stylesheet" href="/shared_components/css/universal-quick-quote.css">
    <link rel="stylesheet" href="/shared_components/css/universal-pricing-grid.css">
    <!-- Removed clean-color-swatches.css - using default dp5-helper styles -->
    <link rel="stylesheet" href="/shared_components/css/enhanced-loading-animations.css">
    <!-- Cool customization styles -->
    <link rel="stylesheet" href="/shared_components/css/embroidery-customization-cool.css">
    
    <!-- Simple, clean styles without design system -->
    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            
            /* Additional variables for color swatches */
            --primary-color: var(--primary);
            --primary-light: #cce5ff;
            --background-light: var(--light);
            --border-color: var(--gray-300);
            --border-light: var(--gray-200);
            --text-color: var(--gray-900);
            --radius-sm: 4px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--gray-900);
            background-color: var(--light);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Hero Section */
        .hero-section {
            background: white;
            padding: 40px 0;
            border-bottom: 1px solid var(--gray-300);
        }
        
        .product-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }
        
        @media (max-width: 768px) {
            .product-header {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        /* Product Info */
        .product-info {
            margin-top: 20px;
        }
        
        .product-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 10px 0;
            color: var(--gray-900);
        }
        
        .product-style {
            color: var(--gray-600);
            margin: 0 0 20px 0;
        }
        
        .product-description h3 {
            font-size: 18px;
            margin: 20px 0 10px 0;
        }
        
        .product-description p {
            color: var(--gray-700);
            margin: 0;
        }
        
        /* Remove conflicting gallery styles - let the CSS files handle it */
        /* Removed gallery-placeholder styles to avoid conflicts */
        
        /* Quick Quote Calculator - Extends cart-summary from shared CSS */
        .quick-quote {
            /* Inherits styles from .cart-summary in modern-enhancements.css */
            /* Additional specific styles only */
        }
        
        .quick-quote h2 {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 5px 0;
        }
        
        .quick-quote-subtitle {
            color: var(--gray-600);
            margin: 0 0 30px 0;
        }
        
        /* Quantity Controls - Use shared styles from modern-enhancements.css */
        .quantity-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Override specific properties for this page's design */
        .quantity-btn {
            /* Inherits from modern-enhancements.css */
            width: 40px;
            height: 40px;
            font-size: 20px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-input {
            /* Inherits from modern-enhancements.css */
            width: 80px;
            text-align: center;
            font-size: 20px;
            padding: 8px;
        }
        
        .quantity-label {
            font-size: 18px;
            color: var(--gray-700);
        }
        
        /* Pricing Display */
        .pricing-display {
            background: var(--gray-100);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .unit-price {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
            transition: opacity 0.3s ease;
        }
        
        .unit-price.updating {
            opacity: 0.5;
        }
        
        .unit-label {
            font-size: 14px;
            color: var(--gray-600);
        }
        
        .total-price {
            font-size: 18px;
            color: var(--gray-900);
            margin-top: 10px;
        }
        
        /* Pricing Breakdown */
        .pricing-breakdown {
            border-top: 1px solid var(--gray-300);
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .breakdown-label {
            color: var(--gray-700);
        }
        
        .breakdown-value {
            font-weight: 500;
            color: var(--gray-900);
        }
        
        .breakdown-total {
            font-weight: 600;
            font-size: 16px;
            border-top: 1px solid var(--gray-300);
            padding-top: 8px;
            margin-top: 8px;
        }
        
        /* Quick Select Buttons */
        .quick-select {
            margin-top: 20px;
        }
        
        .quick-select-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 10px;
            display: block;
        }
        
        .quick-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .quick-select-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
        }
        
        .quick-select-btn:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }
        
        .quick-select-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Main Content Sections */
        .main-content {
            padding: 40px 0;
        }
        
        .content-section {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .content-section h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 0 0 20px 0;
        }
        
        /* Options */
        .option-group {
            margin-bottom: 25px;
        }
        
        .option-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .option-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 16px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Back Logo Details - Use shared styles from modern-enhancements.css */
        /* Removed custom styles - using .back-logo-pricing-info from shared CSS */
        
        /* Stitch Counter */
        .stitch-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stitch-counter-btn {
            width: 30px;
            height: 30px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .stitch-counter-btn:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }
        
        .stitch-counter-display {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .stitch-counter-range {
            color: var(--gray-600);
            font-size: 14px;
        }
        
        /* Pricing Table - Use shared pricing-grid styles */
        .pricing-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        .pricing-table th,
        .pricing-table td {
            padding: 12px;
            text-align: left;
        }
        
        .pricing-table th {
            background: var(--primary-gradient);
            color: white;
            font-weight: var(--font-semibold);
            padding: var(--space-md);
            text-transform: uppercase;
            font-size: var(--text-sm);
            letter-spacing: 0.05em;
        }
        
        .pricing-table td {
            background: white;
            border-bottom: 1px solid var(--neutral-100);
            transition: all var(--transition-base);
        }
        
        .pricing-table tr:hover td {
            background: var(--primary-light);
            transform: scale(1.02);
        }
        
        .pricing-table tr:last-child td {
            border-bottom: none;
        }
        
        /* CTA Section */
        .cta-section {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-top: 40px;
        }
        
        .cta-section h2 {
            font-size: 28px;
            margin: 0 0 10px 0;
        }
        
        .cta-section p {
            color: var(--gray-700);
            margin: 0 0 30px 0;
            font-size: 18px;
        }
        
        .cta-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--gray-100);
        }
        
        /* Features */
        .features {
            margin-top: 30px;
            line-height: 1.8;
        }
        
        .features p {
            margin: 5px 0;
            color: var(--gray-700);
        }
        
        /* Visual Toggle Styles for Front Logo */
        .stitch-toggle-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .stitch-toggle-option {
            flex: 1;
            max-width: 150px;
            padding: 20px;
            border: 2px solid var(--neutral-200);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stitch-toggle-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stitch-toggle-option.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 102, 204, 0.3);
        }
        
        .stitch-toggle-option.active .stitch-count-display {
            color: white;
        }
        
        .stitch-toggle-option.active .stitch-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .stitch-toggle-option.active .density-dot {
            background: white;
        }
        
        .stitch-count-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }
        
        .stitch-label {
            font-size: 14px;
            color: var(--neutral-600);
            margin-bottom: 12px;
        }
        
        .density-preview {
            display: flex;
            gap: 4px;
            justify-content: center;
        }
        
        .density-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .density-dot.empty {
            background: var(--neutral-200);
        }
        
        /* Milestones for back logo slider */
        .back-logo-slider-container .stitch-milestones {
            position: relative;
            margin-top: 20px;
            height: 40px;
            width: 100%;
        }
        
        /* Position milestones */
        .back-logo-slider-container .milestone {
            position: absolute;
            top: 0;
            transform: translateX(-50%);
            font-size: 13px;
            color: var(--neutral-600);
            text-align: center;
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* Spread milestones evenly with better spacing */
        .back-logo-slider-container .milestone:nth-child(1) { 
            left: 0%; 
            transform: translateX(0);
        }
        .back-logo-slider-container .milestone:nth-child(2) { 
            left: 30%; 
        }
        .back-logo-slider-container .milestone:nth-child(3) { 
            left: 50%; 
        }
        .back-logo-slider-container .milestone:nth-child(4) { 
            left: 70%; 
        }
        .back-logo-slider-container .milestone:nth-child(5) { 
            left: 100%; 
            transform: translateX(-100%);
        }
        
        /* Back Logo Slider Styles */
        .back-logo-slider-container {
            margin-top: 20px;
            padding: 30px 60px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 12px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .back-logo-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            outline: none;
            position: relative;
            z-index: 2;
            cursor: pointer;
            margin: 0;
        }
        
        .back-slider-track {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--neutral-200);
            border-radius: 4px;
            transform: translateY(-50%);
            z-index: 1;
        }
        
        .back-slider-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--info-color) 0%, var(--secondary-color) 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .back-logo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border: 3px solid var(--info-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .back-logo-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .back-logo-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: white;
            border: 3px solid var(--info-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .back-value-bubble {
            position: absolute;
            top: -45px;
            transform: translateX(-50%);
            background: var(--info-color);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            pointer-events: none;
            transition: left 0.3s ease;
        }
        
        .back-value-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--info-color);
        }
        
        /* Price info badge */
        .price-info-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .price-info-badge .info-text {
            color: var(--success-color);
            background: rgba(40, 167, 69, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        /* Additional color variables */
        :root {
            --neutral-200: #e5e7eb;
            --neutral-600: #4b5563;
            --secondary-color: #764ba2;
            --info-color: #17a2b8;
            --success-color: #28a745;
        }
        
        /* Savings Tip */
        .savings-tip {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
            color: #856404;
        }
        
        .savings-tip-icon {
            font-size: 18px;
        }
        
        /* LTM Warning */
        .ltm-warning {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
            color: #721c24;
        }
        
        /* Hide elements */
        .hidden {
            display: none !important;
        }
        
        /* Hidden Calculator */
        .hidden-calculator {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        
        /* Remove conflicting color swatch styles - let the CSS files handle it */
        /* Removed clean-color-grid and related styles to avoid conflicts */
        
        /* Ensure product main image displays properly */
        .product-main-image {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* Ensure proper section headers */
        .section-header {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 15px 0;
            color: var(--gray-900);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Fix button alignment in section header */
        .section-header .btn-secondary {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        /* Enhanced gallery classes compatibility */
        .image-gallery-enhanced {
            width: 100%;
            max-width: 500px;
        }
        
        .image-container-enhanced {
            position: relative;
            width: 100%;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        .image-container-enhanced img {
            width: 100%;
            height: auto;
            display: block;
            min-height: 400px;
            object-fit: contain;
            background-color: white;
        }
        
        .image-thumbnails-enhanced {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .zoom-overlay-enhanced {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .image-container-enhanced:hover .zoom-overlay-enhanced {
            opacity: 1;
        }
        
        /* Ensure proper responsive behavior */
        @media (max-width: 768px) {
            .image-container-enhanced img {
                min-height: 300px;
            }
        }
        
        /* Color Swatch Styles from Embroidery Page */
        .color-swatches-container.compact {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--background-light);
            border-radius: var(--radius-sm);
            border-top: 1px solid var(--border-light);
        }
        
        .color-swatches-container.compact .section-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-light);
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .color-swatches-container.compact .color-swatches {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-height: 350px;
            overflow-y: auto;
            padding: 10px 15px;
            gap: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--primary-light);
        }
        
        .color-swatches-container.compact .color-swatches::-webkit-scrollbar {
            width: 6px;
        }
        
        .color-swatches-container.compact .color-swatches::-webkit-scrollbar-track {
            background: var(--primary-light);
            border-radius: 10px;
        }
        
        .color-swatches-container.compact .color-swatches::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }
        
        /* Simplified Swatch Styles */
        .swatch-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 70px;
            min-height: 75px;
            margin: 5px;
            cursor: pointer;
            justify-content: flex-start;
        }

        .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            margin-bottom: 4px;
            background-size: cover;
            background-position: center;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .color-swatch:hover {
            border-color: var(--primary-color);
        }

        .color-swatch.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .color-name {
            font-size: 0.75em;
            text-align: center;
            color: var(--text-color);
            width: 100%;
            line-height: normal;
            padding: 0 2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            display: block;
        }
        
        /* Responsive adjustments for slider */
        @media (max-width: 768px) {
            .back-logo-slider-container {
                padding: 20px 30px;
            }
            
            .back-logo-slider-container .milestone {
                font-size: 11px;
            }
        }
        
        /* Responsive adjustments for swatches */
        @media (max-width: 768px) {
            .color-swatches-container.compact .color-swatches {
                max-height: 200px;
            }
        }
        
        @media (max-width: 480px) {
            .color-swatch {
                width: 35px !important;
                height: 35px !important;
            }
            
            .color-name {
                font-size: 0.65em;
            }
        }
    </style>
</head>
<body>
    <!-- Universal Header -->
    <div id="universal-header-container" data-page-type="cap-embroidery"></div>
    
    <!-- Hidden Caspio Matrix - Keep this for data source -->
    <div id="pricing-calculator" class="pricing-calculator hidden-calculator">
        <div class="loading-message">Loading pricing data...</div>
        <div id="caspio-container">
            <script type="text/javascript" src="https://c3eku948.caspio.com/dp/a0e150004ecd0739f853449c8d7f/emb"></script>
        </div>
    </div>
    
    <!-- Hidden elements for compatibility with pricing-pages.js -->
    <div style="display: none;">
        <h3 id="product-title-context" class="product-title">Product Title</h3>
        <img id="product-image-context" src="" alt="">
        <div id="product-color-context"></div>
        <div id="selected-color-swatch-context"></div>
        <div id="custom-pricing-grid">
            <table>
                <thead>
                    <tr id="pricing-header-row"></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="app">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="container">
                <div class="product-header">
                    <!-- Left Column - Product Info -->
                    <div>
                        <!-- Universal Product Display Component will render here -->
                        <div id="product-display"></div>
                    </div>
                    
                    <!-- Right Column - Quick Quote -->
                    <div>
                        <div class="quick-quote cart-summary">
                            <h2>Quick Quote Calculator</h2>
                            <p class="quick-quote-subtitle">Enter quantity for instant pricing</p>
                            
                            <!-- Quantity Input -->
                            <div class="quantity-input-group">
                                <button class="quantity-btn" id="decrease-btn" onclick="updateQuantity(-1)">−</button>
                                <input type="number" class="quantity-input" id="quantity-input" value="24" min="1" max="10000" onchange="handleQuantityChange()">
                                <button class="quantity-btn" id="increase-btn" onclick="updateQuantity(1)">+</button>
                                <span class="quantity-label">caps</span>
                            </div>
                            
                            <!-- Pricing Display -->
                            <div class="pricing-display">
                                <div class="unit-price" id="unit-price">$24.00</div>
                                <div class="unit-label">per cap</div>
                                <div class="total-price" id="total-price">Total: $744.00</div>
                            </div>
                            
                            <!-- Pricing Breakdown -->
                            <div class="pricing-breakdown" id="pricing-breakdown">
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Base cap price:</span>
                                    <span class="breakdown-value">$24.00</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Front logo (8,000 stitches):</span>
                                    <span class="breakdown-value">included</span>
                                </div>
                                <div class="breakdown-item breakdown-total">
                                    <span class="breakdown-label">Your price:</span>
                                    <span class="breakdown-value">$24.00 /cap</span>
                                </div>
                            </div>
                            
                            <!-- Savings Tip -->
                            <div class="savings-tip" id="savings-tip">
                                <span class="savings-tip-icon">💡</span>
                                <span id="savings-tip-text"></span>
                            </div>
                            
                            <!-- LTM Warning -->
                            <div class="ltm-warning" id="ltm-warning">
                                <span>⚠️</span>
                                <span id="ltm-warning-text">Orders under 24 caps include a $50 setup fee</span>
                            </div>
                            
                            <!-- Quick Select -->
                            <div class="quick-select">
                                <span class="quick-select-label">Quick select:</span>
                                <div class="quick-select-grid">
                                    <button class="quick-select-btn" onclick="setQuantity(12)">1 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(24)">2 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(36)">3 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(48)">4 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(72)">6 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(144)">12 Dozen</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <!-- Customization Options -->
                <div class="content-section">
                    <h2>✨ Customization Options</h2>
                    
                    <!-- Front Logo Stitch Count - Visual Toggle -->
                    <div class="option-card glassmorphism">
                        <div class="option-header">
                            <div class="option-title">
                                <span class="stitch-icon-animated">🪡</span>
                                <h3>Front Logo Stitch Count</h3>
                            </div>
                            <div class="price-info-badge">
                                <span class="info-text">Included in pricing</span>
                            </div>
                        </div>
                        
                        <div class="stitch-toggle-container">
                            <div class="stitch-toggle-option" data-value="5000" onclick="setFrontStitchCount(5000)">
                                <div class="stitch-count-display">5K</div>
                                <div class="stitch-label">Basic</div>
                                <div class="density-preview">
                                    <span class="density-dot"></span>
                                    <span class="density-dot"></span>
                                    <span class="density-dot empty"></span>
                                    <span class="density-dot empty"></span>
                                    <span class="density-dot empty"></span>
                                </div>
                            </div>
                            
                            <div class="stitch-toggle-option active" data-value="8000" onclick="setFrontStitchCount(8000)">
                                <div class="stitch-count-display">8K</div>
                                <div class="stitch-label">Standard</div>
                                <div class="density-preview">
                                    <span class="density-dot"></span>
                                    <span class="density-dot"></span>
                                    <span class="density-dot"></span>
                                    <span class="density-dot empty"></span>
                                    <span class="density-dot empty"></span>
                                </div>
                            </div>
                            
                            <div class="stitch-toggle-option" data-value="10000" onclick="setFrontStitchCount(10000)">
                                <div class="stitch-count-display">10K</div>
                                <div class="stitch-label">Detailed</div>
                                <div class="density-preview">
                                    <span class="density-dot"></span>
                                    <span class="density-dot"></span>
                                    <span class="density-dot"></span>
                                    <span class="density-dot"></span>
                                    <span class="density-dot empty"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden select to maintain compatibility -->
                        <select id="stitch-count" style="display: none;" onchange="handleStitchCountChange()">
                            <option value="5000">5,000 stitches</option>
                            <option value="8000" selected>8,000 stitches (Standard)</option>
                            <option value="10000">10,000 stitches</option>
                        </select>
                    </div>
                    
                    <!-- Back Logo - Cool Version -->
                    <div class="option-card glassmorphism">
                        <div class="option-header">
                            <div class="option-title">
                                <span class="logo-icon">🎯</span>
                                <h3>Back Logo</h3>
                            </div>
                            <div class="price-badge" id="back-logo-price-badge">
                                <span class="extra-cost">+$5.00</span>
                            </div>
                        </div>
                        
                        <div class="back-logo-option">
                            <input type="checkbox" id="back-logo-checkbox" onchange="toggleBackLogo()">
                            <label for="back-logo-checkbox" class="checkbox-label">Add embroidered back logo</label>
                        </div>
                        
                        <div class="back-logo-pricing-info" id="back-logo-details" style="display: none;">
                            <div class="back-logo-slider-container">
                                <div style="position: relative; padding: 30px 0 10px;">
                                    <input type="range" 
                                           class="back-logo-slider" 
                                           id="back-logo-slider"
                                           min="5000" 
                                           max="15000" 
                                           step="1000"
                                           value="5000"
                                           oninput="updateBackLogoFromSlider(this.value)">
                                    <div class="back-slider-track">
                                        <div class="back-slider-fill" id="back-slider-fill"></div>
                                    </div>
                                    <div class="back-value-bubble" id="back-value-bubble">
                                        <span class="bubble-value">5,000</span>
                                        <span class="bubble-unit">stitches</span>
                                    </div>
                                </div>
                                
                                <div class="stitch-milestones">
                                    <div class="milestone">5K</div>
                                    <div class="milestone">8K</div>
                                    <div class="milestone">10K</div>
                                    <div class="milestone">12K</div>
                                    <div class="milestone">15K</div>
                                </div>
                            </div>
                            
                            <div id="back-logo-price-display" style="margin-top: 20px; text-align: center; font-weight: 600;">
                                Additional Cost: $5.00 per cap
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pricing Table -->
                <div class="content-section" id="pricing-details">
                    <h2>Pricing by Quantity</h2>
                    <p style="color: var(--gray-600); margin-bottom: 20px;">Volume discounts automatically applied • <span id="pricing-stitch-count-display">8,000 stitch pricing shown</span></p>
                    
                    <!-- Universal Pricing Grid Component with shared styles -->
                    <div id="pricing-grid-container" class="pricing-grid-wrapper">
                        <!-- Universal pricing grid will be initialized here -->
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 14px; color: var(--gray-600);">
                        <strong>Note:</strong> Prices shown include embroidered logo on front. Back logo and stitch count upgrades are additional.
                    </p>
                </div>
                
                <!-- CTA Section -->
                <div class="cta-section">
                    <h2>Ready for Your Quote?</h2>
                    <p>Contact us with your quantity and customization details for a personalized quote.</p>
                    
                    <div class="cta-buttons">
                        <button class="btn btn-primary" onclick="window.location.href='tel:253-922-5793'">
                            📞 Call for Quote: 253-922-5793
                        </button>
                        
                        <button class="btn btn-secondary" onclick="window.location.href='mailto:sales@nwcustomapparel.com?subject=Cap Embroidery Quote Request'">
                            ✉️ Email Quote Request
                        </button>
                    </div>
                    
                    <div class="features">
                        <p>💚 <strong>Why Choose Northwest Custom Apparel?</strong></p>
                        <p>Family Owned and Operated Since 1977 • Milton, WA • Quality embroidery</p>
                        <p>📍 2025 Freeman Road East Milton, WA 98354</p>
                        <p>📱 You can text us at 253-922-5793</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keep existing header functionality -->
    <script src="/shared_components/js/header-button-functions.js"></script>
    
    <!-- JavaScript Files from Original Page -->
    <!-- Base Layer - Core dependencies -->
    <script src="/shared_components/js/debug-config.js"></script>
    <script src="/shared_components/js/nwca-namespace.js"></script>
    <script src="/shared_components/js/constants.js"></script>
    <script src="/shared_components/js/app-config.js"></script>
    <script src="/shared_components/js/utils.js"></script>
    
    <!-- Data Layer - Pricing system -->
    <script src="/shared_components/js/pricing-matrix-api.js"></script>
    <script src="/shared_components/js/pricing-matrix-capture.js"></script>
    <script src="/shared_components/js/pricing-calculator.js"></script>
    <script src="/shared_components/js/dp5-helper.js"></script>
    
    <!-- UI Components -->
    <script src="/shared_components/js/ui-components.js"></script>
    <script src="/shared_components/js/pricing-pages.js"></script>
    <script src="/shared_components/js/universal-image-gallery.js"></script>
    
    <!-- Cap Embroidery Specific -->
    <script src="/shared_components/js/cap-embroidery-controller-v2.js"></script>
    <!-- Removed clean-color-adapter.js - dp5-helper already handles color swatches -->
    <!-- IMPORTANT: NOT including cap-embroidery-ltm-fix.js as it has the $18 bug -->
    
    <!-- Universal Header Component -->
    <script src="/shared_components/js/universal-header-component.js"></script>
    
    <!-- Universal Product Display Component -->
    <script src="/shared_components/js/universal-product-display.js"></script>
    
    <!-- Universal Pricing Grid Component -->
    <script src="/shared_components/js/universal-pricing-grid.js"></script>
    
    <!-- Beta Analytics and Feedback -->
    <script src="/beta-analytics-tracker.js" defer></script>
    <script src="/beta-feedback-widget.js" defer></script>

    <!-- Main Implementation -->
    <script>
        // Add missing function for embellishment type detection
        window.getEmbellishmentTypeFromUrl = function() {
            return 'cap-embroidery';
        };
        
        // Cap Embroidery Pricing Logic
        const state = {
            quantity: 24,
            basePrice: 0,
            unitPrice: 0,
            totalPrice: 0,
            frontLogoStitches: 8000,
            backLogoEnabled: false,
            backLogoStitches: 5000,
            backLogoPrice: 5,
            selectedColor: '',
            styleNumber: '',
            productTitle: '',
            pricingData: null,
            pricingTiers: [], // Will be populated from Caspio
            isUpdatingStitchCount: false // Add flag to prevent loops
        };
        
        // Parse URL parameters and set global variables IMMEDIATELY
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            state.styleNumber = urlParams.get('StyleNumber') || 'NE1000';
            state.selectedColor = urlParams.get('COLOR') || 'Cyber Green';
            
            // Set global variables BEFORE any scripts run
            window.selectedStyleNumber = state.styleNumber;
            window.selectedCatalogColor = state.selectedColor;
            
            console.log('[Cap Embroidery] Initialized with:', {
                styleNumber: state.styleNumber,
                color: state.selectedColor
            });
        })();
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // IMPORTANT: Initialize pricing-pages.js functionality first
            // This will handle product data loading, color swatches, and image gallery
            if (window.PricingPageUI && typeof window.PricingPageUI.init === 'function') {
                window.PricingPageUI.init();
            }
            
            // Initialize Universal Product Display immediately
            let productDisplay = new UniversalProductDisplay({
                containerId: 'product-display',
                pageType: 'cap-embroidery',
                showBackButton: true,
                showInfoBox: true,
                showSelectedColor: true,
                sticky: false,
                infoBoxContent: 'Pricing includes an 8,000 stitch embroidered logo on front.'
            });
            
            // Initialize Universal Pricing Grid
            let pricingGrid = new UniversalPricingGrid({
                containerId: 'pricing-grid-container',
                showInventory: false, // Cap embroidery doesn't show inventory
                loadingAnimation: true,
                showColorIndicator: true,
                showSizes: false // Cap embroidery uses OSFA
            });
            
            // Make it globally accessible
            window.pricingGrid = pricingGrid;
            
            // Initialize visual toggle buttons  
            initializeVisualToggles();
            
            // Initialize back logo slider
            const backSlider = document.getElementById('back-logo-slider');
            if (backSlider) {
                updateBackLogoSliderVisuals();
            }
            
            // Initialize with default pricing data immediately
            const initialPricingData = {
                headers: ['Quantity', 'OSFA'],
                prices: {
                    'OSFA': {
                        '24-47': '24.00',
                        '48-71': '23.00',
                        '72-99+': '21.00'
                    }
                },
                tierData: {
                    '24-47': { MinQuantity: 24, MaxQuantity: 47 },
                    '48-71': { MinQuantity: 48, MaxQuantity: 71 },
                    '72-99+': { MinQuantity: 72 }
                },
                styleNumber: state.styleNumber,
                color: state.selectedColor,
                embellishmentType: 'cap-embroidery',
                stitchCount: state.frontLogoStitches
            };
            
            // Add alias for compatibility
            initialPricingData.tiers = initialPricingData.tierData;
            
            // Dispatch initial pricing data
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('pricingDataLoaded', {
                    detail: initialPricingData
                }));
            }, 500);
            
            // Update product info
            updateProductInfo();
            
            // Don't calculate pricing with fallback values immediately
            // Wait for real data from Caspio
            console.log('[Cap Embroidery] Waiting for Caspio data before calculating initial pricing...');
            
            // Populate initial pricing table
            populateInitialPricingTable();
            
            // Note: Caspio data will be loaded by pricing-pages.js
            // loadCaspioData();
            
            // Try to extract pricing from existing table after a short delay
            setTimeout(() => {
                console.log('[Cap Embroidery] Checking for existing pricing table data');
                extractPricingFromTable();
                if (state.pricingTiers.length > 0) {
                    console.log('[Cap Embroidery] Extracted pricing tiers, updating all displays');
                    updatePricing();
                    updatePricingDisplay();
                    updateBreakdown();
                }
            }, 1000);
            
            // Add hidden increment arrow buttons for cap-embroidery-controller-v2.js compatibility
            const hiddenArrows = document.createElement('div');
            hiddenArrows.style.display = 'none';
            hiddenArrows.innerHTML = `
                <button id="stitch-increment-arrow" style="display: none;"></button>
                <button id="stitch-decrement-arrow" style="display: none;"></button>
            `;
            document.body.appendChild(hiddenArrows);
            
            // Also check again after a longer delay in case Caspio loads slowly
            setTimeout(() => {
                if (state.pricingTiers.length === 0) {
                    console.log('[Cap Embroidery] Re-checking for pricing data...');
                    extractPricingFromTable();
                    if (state.pricingTiers.length > 0) {
                        console.log('[Cap Embroidery] Found pricing data on second check');
                        updatePricing();
                        updatePricingDisplay();
                        updateBreakdown();
                    }
                }
            }, 2500);
            
            // Add client-stitch-count-select ID for compatibility
            const stitchSelect = document.getElementById('stitch-count');
            if (stitchSelect) {
                // Add the ID that other scripts look for without removing the original
                stitchSelect.setAttribute('data-client-id', 'client-stitch-count-select');
                
                // Create a reference so other scripts can find it
                const stitchCountAlias = document.getElementById('client-stitch-count-select');
                if (!stitchCountAlias) {
                    window.document.getElementById = (function(originalGetElementById) {
                        return function(id) {
                            if (id === 'client-stitch-count-select') {
                                return document.querySelector('#stitch-count');
                            }
                            return originalGetElementById.call(this, id);
                        };
                    })(window.document.getElementById);
                }
            }
            
            // Listen for color selection events from pricing-pages.js/clean-color-adapter
            document.addEventListener('colorChanged', function(event) {
                if (event.detail && event.detail.COLOR_NAME) {
                    state.selectedColor = event.detail.COLOR_NAME;
                    console.log('[Cap Embroidery] Color changed to:', state.selectedColor);
                    // Pricing recalculation will be triggered by other scripts
                    
                    // Update the pricing grid with the new color
                    if (pricingGrid) {
                        pricingGrid.updateSelectedColor(event.detail.COLOR_NAME, event.detail);
                    }
                }
            });
            
            // Listen for pricing data updates
            window.addEventListener('pricingDataLoaded', function(event) {
                console.log('[Cap Embroidery] Pricing data loaded event received', event.detail);
                
                // Skip if this event came from stitch count update to prevent loops
                if (event.detail && event.detail._fromStitchCountUpdate) {
                    console.log('[Cap Embroidery] Skipping pricing data update - event from stitch count update');
                    return;
                }
                
                // Extract pricing tiers from event
                if (event.detail && event.detail.prices) {
                    extractPricingTiers(event.detail);
                }
                
                // Update pricing with real data
                updatePricing();
                updatePricingDisplay();
                updateBreakdown();
                
                // Check if we need to add the 24-47 tier
                setTimeout(function() {
                    fixPricingTable();
                    // Extract pricing again after fixing table
                    extractPricingFromTable();
                    if (state.pricingTiers.length > 0) {
                        updatePricing();
                        updatePricingDisplay();
                        updateBreakdown();
                        
                        // Only update pricing for stitch count if not already updating
                        if (!state.isUpdatingStitchCount) {
                            updatePricingForStitchCount();
                        }
                    }
                }, 500);
            });
            
            // Listen for cap embroidery master data
            window.addEventListener('caspioCapPricingCalculated', function(event) {
                console.log('[Cap Embroidery] Cap embroidery master data received', event.detail);
                if (event.detail && event.detail.masterData) {
                    window.capEmbroideryMasterData = event.detail.masterData;
                    console.log('[Cap Embroidery] Master data structure:', window.capEmbroideryMasterData);
                    
                    // Update pricing with new stitch count data
                    if (window.capEmbroideryMasterData.allPriceProfiles) {
                        console.log('[Cap Embroidery] Available stitch count profiles:', Object.keys(window.capEmbroideryMasterData.allPriceProfiles));
                        updatePricingForStitchCount();
                    }
                }
            });
            
            // Also listen for the cap embroidery pricing event from the controller
            window.addEventListener('capEmbroideryPricingUpdated', function(event) {
                console.log('[Cap Embroidery] Cap embroidery pricing updated event received', event.detail);
                if (event.detail && event.detail.prices) {
                    // Extract and update pricing tiers
                    extractPricingTiers(event.detail);
                    updatePricingForStitchCount();
                }
            });
            
            // Also listen for the pricing table to be updated
            const pricingTableElement = document.getElementById('custom-pricing-grid');
            if (pricingTableElement) {
                const observer = new MutationObserver(function(mutations) {
                    console.log('[Cap Embroidery] Pricing table was modified');
                    
                    // Check if the table has data
                    const tbody = pricingTableElement.querySelector('tbody');
                    if (tbody && tbody.querySelectorAll('tr').length > 0) {
                        console.log('[Cap Embroidery] Pricing table has data, extracting prices');
                        setTimeout(() => {
                            extractPricingFromTable();
                            updatePricing();
                            updatePricingDisplay();
                            updateBreakdown();
                        }, 100);
                    }
                });
                observer.observe(pricingTableElement, { childList: true, subtree: true });
            }
            
            // Initialize cap embroidery controller if available
            if (window.NWCA && window.NWCA.controllers && window.NWCA.controllers.capEmbroidery) {
                console.log('[Cap Embroidery] Cap embroidery controller found, setting global reference');
                window.capEmbroideryController = window.NWCA.controllers.capEmbroidery;
                
                // Initialize the controller if it has an init method
                if (window.capEmbroideryController.initialize) {
                    console.log('[Cap Embroidery] Initializing cap embroidery controller');
                    window.capEmbroideryController.initialize();
                }
            } else {
                console.log('[Cap Embroidery] Cap embroidery controller not found in NWCA namespace');
            }
            
            // Add event listener for stitch count changes
            const stitchCountSelect = document.getElementById('stitch-count');
            if (stitchCountSelect) {
                console.log('[Cap Embroidery] Adding stitch count change listener');
                stitchCountSelect.addEventListener('change', function(e) {
                    console.log('[Cap Embroidery] Stitch count changed via event listener to:', e.target.value);
                    
                    // Wait a bit for Caspio data if not loaded yet
                    if (!window.capEmbroideryMasterData || !window.capEmbroideryMasterData.allPriceProfiles) {
                        console.log('[Cap Embroidery] Waiting for Caspio master data...');
                        setTimeout(() => {
                            handleStitchCountChange();
                        }, 500);
                    } else {
                        handleStitchCountChange();
                    }
                });
            } else {
                console.error('[Cap Embroidery] Stitch count select element not found!');
            }
        });
        
        // Extract pricing tiers from Caspio data
        function extractPricingTiers(pricingData) {
            console.log('[Cap Embroidery] Extracting pricing tiers from:', pricingData);
            
            // Reset tiers
            state.pricingTiers = [];
            
            // Check if we have cap embroidery master data with stitch count profiles
            if (window.capEmbroideryMasterData && window.capEmbroideryMasterData.allPriceProfiles) {
                const stitchCountEl = document.getElementById('stitch-count');
                const currentStitchCount = stitchCountEl ? stitchCountEl.value : state.frontLogoStitches.toString();
                const stitchCountProfile = window.capEmbroideryMasterData.allPriceProfiles[currentStitchCount];
                
                if (stitchCountProfile && stitchCountProfile.OSFA) {
                    console.log('[Cap Embroidery] Using stitch count specific pricing for', currentStitchCount);
                    const osfaPrices = stitchCountProfile.OSFA;
                    
                    // Convert to our tier format
                    for (const [tierKey, price] of Object.entries(osfaPrices)) {
                        if (tierKey.includes('24-47')) {
                            state.pricingTiers.push({ min: 24, max: 47, price: parseFloat(price) });
                        } else if (tierKey.includes('48-71')) {
                            state.pricingTiers.push({ min: 48, max: 71, price: parseFloat(price) });
                        } else if (tierKey.includes('72') || tierKey.includes('72+')) {
                            state.pricingTiers.push({ min: 72, max: 99999, price: parseFloat(price) });
                        }
                    }
                }
            }
            
            // Fallback to general pricing if no stitch count specific data
            if (state.pricingTiers.length === 0 && pricingData.prices && pricingData.prices.OSFA) {
                const osfaPrices = pricingData.prices.OSFA;
                
                // Convert to our tier format
                for (const [tierKey, price] of Object.entries(osfaPrices)) {
                    if (tierKey.includes('24-47')) {
                        state.pricingTiers.push({ min: 24, max: 47, price: parseFloat(price) });
                    } else if (tierKey.includes('48-71')) {
                        state.pricingTiers.push({ min: 48, max: 71, price: parseFloat(price) });
                    } else if (tierKey.includes('72') || tierKey.includes('72+')) {
                        state.pricingTiers.push({ min: 72, max: 99999, price: parseFloat(price) });
                    }
                }
            }
            
            // Sort by min quantity
            state.pricingTiers.sort((a, b) => a.min - b.min);
            
            console.log('[Cap Embroidery] Extracted pricing tiers:', state.pricingTiers);
            
            // Store in global for other scripts
            state.pricingData = pricingData;
            window.nwcaPricingData = pricingData;
        }
        
        // Load Caspio pricing data
        function loadCaspioData() {
            const container = document.getElementById('caspio-embed-container');
            if (!container) return;
            
            // Clear any existing iframe
            container.innerHTML = '';
            
            // Create the iframe URL with the style parameter
            const caspioSrc = `https://c3eku948.caspio.com/dp/a0e15000c5d8e1f2e9e94c3c9a5a/emb?StyleNumber=${encodeURIComponent(state.styleNumber)}`;
            
            // Create iframe
            const iframe = document.createElement('iframe');
            iframe.src = caspioSrc;
            iframe.style.width = '100%';
            iframe.style.height = '500px';
            iframe.style.border = 'none';
            iframe.style.position = 'absolute';
            iframe.style.left = '-9999px';
            
            container.appendChild(iframe);
            console.log('[Cap Embroidery] Loading Caspio data for style:', state.styleNumber);
        }
        
        function updateProductInfo() {
            // Update product title
            const titles = {
                'NE1000': 'New Era - Structured Stretch Cotton Cap',
                'C112': 'Port & Company - Snapback Trucker Cap',
                'PC800': 'Port & Company - Unstructured Sandwich Bill Cap'
            };
            
            state.productTitle = titles[state.styleNumber] || state.styleNumber;
            
            // Update UI - check if elements exist before updating
            const productTitleEl = document.getElementById('product-title');
            if (productTitleEl) productTitleEl.textContent = state.productTitle;
            
            const productStyleEl = document.getElementById('product-style-context');
            if (productStyleEl) productStyleEl.textContent = state.styleNumber;
            
            const currentProductEl = document.getElementById('current-product-context');
            if (currentProductEl) currentProductEl.textContent = state.productTitle;
            
            const breadcrumbEl = document.getElementById('breadcrumb-product');
            if (breadcrumbEl) breadcrumbEl.textContent = state.styleNumber;
            
            // Also update the hidden title context that pricing-pages.js looks for
            const titleContext = document.getElementById('product-title-context');
            if (titleContext) {
                titleContext.textContent = state.productTitle;
            }
            
            // Update back to product link
            const backLink = document.getElementById('back-to-product');
            const breadcrumbLink = document.getElementById('breadcrumb-product-link');
            const productUrl = `/product?StyleNumber=${state.styleNumber}&COLOR=${encodeURIComponent(state.selectedColor)}`;
            
            if (backLink) backLink.href = productUrl;
            if (breadcrumbLink) breadcrumbLink.href = productUrl;
            
            // Note: Product image and color swatches will be handled by pricing-pages.js
        }
        
        function updateQuantity(delta) {
            const newQty = state.quantity + delta;
            if (newQty >= 1 && newQty <= 10000) {
                state.quantity = newQty;
                document.getElementById('quantity-input').value = newQty;
                updatePricing();
            }
        }
        
        function handleQuantityChange() {
            const input = document.getElementById('quantity-input');
            const qty = parseInt(input.value) || 1;
            
            if (qty < 1) {
                state.quantity = 1;
                input.value = 1;
            } else if (qty > 10000) {
                state.quantity = 10000;
                input.value = 10000;
            } else {
                state.quantity = qty;
            }
            
            updatePricing();
        }
        
        function setQuantity(qty) {
            state.quantity = qty;
            document.getElementById('quantity-input').value = qty;
            updatePricing();
            
            // Update active button
            document.querySelectorAll('.quick-select-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Function to update front stitch count from visual toggles
        window.setFrontStitchCount = function(value) {
            // Update hidden select
            const select = document.getElementById('stitch-count');
            if (select) {
                select.value = value;
                
                // Update visual toggles
                document.querySelectorAll('.stitch-toggle-option').forEach(option => {
                    if (parseInt(option.dataset.value) === value) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
                
                // Trigger the existing handler
                handleStitchCountChange();
            }
        }
        
        // Handle stitch count change (make it global)
        window.handleStitchCountChange = function() {
            const stitchCountEl = document.getElementById('stitch-count');
            if (!stitchCountEl) {
                console.error('[Cap Embroidery] Stitch count element not found');
                return;
            }
            
            const stitchCount = stitchCountEl.value;
            state.frontLogoStitches = parseInt(stitchCount);
            
            console.log('[Cap Embroidery] Stitch count changed to:', stitchCount);
            console.log('[Cap Embroidery] Current state:', {
                hasController: !!window.capEmbroideryController,
                hasMasterData: !!window.capEmbroideryMasterData,
                hasProfiles: !!(window.capEmbroideryMasterData && window.capEmbroideryMasterData.allPriceProfiles),
                pricingTiers: state.pricingTiers
            });
            
            // Update pricing based on new stitch count
            updatePricingForStitchCount();
            
            // Force immediate update of quick quote calculator
            updatePricing();
            updatePricingDisplay();
            updateBreakdown();
            
            // Also update the displayed stitch count in the breakdown
            const heroStitchEl = document.getElementById('hero-stitch-count');
            if (heroStitchEl) {
                heroStitchEl.textContent = state.frontLogoStitches.toLocaleString();
            }
            
            // Try to trigger cap controller calculation if available
            if (window.capEmbroideryController && window.capEmbroideryController.calculatePricing) {
                console.log('[Cap Embroidery] Triggering cap controller pricing calculation');
                window.capEmbroideryController.calculatePricing();
            }
        }
        
        // Update pricing when stitch count changes
        function updatePricingForStitchCount() {
            console.log('[Cap Embroidery] updatePricingForStitchCount called');
            
            // Set flag to prevent loops
            state.isUpdatingStitchCount = true;
            
            console.log('[Cap Embroidery] Current pricing data:', {
                hasMasterData: !!window.capEmbroideryMasterData,
                hasAllPriceProfiles: !!(window.capEmbroideryMasterData && window.capEmbroideryMasterData.allPriceProfiles),
                currentStitchCount: state.frontLogoStitches
            });
            
            // If we have master data with stitch count profiles, update pricing tiers
            if (window.capEmbroideryMasterData && window.capEmbroideryMasterData.allPriceProfiles) {
                const currentStitchCount = state.frontLogoStitches.toString();
                const stitchCountProfile = window.capEmbroideryMasterData.allPriceProfiles[currentStitchCount];
                
                if (stitchCountProfile) {
                    console.log('[Cap Embroidery] Found pricing profile for stitch count:', currentStitchCount);
                    console.log('[Cap Embroidery] Stitch count profile data:', stitchCountProfile);
                    
                    // Update pricing tiers with stitch count specific data
                    state.pricingTiers = [];
                    
                    if (stitchCountProfile.OSFA) {
                        const osfaPrices = stitchCountProfile.OSFA;
                        
                        for (const [tierKey, price] of Object.entries(osfaPrices)) {
                            if (tierKey.includes('24-47')) {
                                state.pricingTiers.push({ min: 24, max: 47, price: parseFloat(price) });
                            } else if (tierKey.includes('48-71')) {
                                state.pricingTiers.push({ min: 48, max: 71, price: parseFloat(price) });
                            } else if (tierKey.includes('72') || tierKey.includes('72+')) {
                                state.pricingTiers.push({ min: 72, max: 99999, price: parseFloat(price) });
                            }
                        }
                        
                        state.pricingTiers.sort((a, b) => a.min - b.min);
                        console.log('[Cap Embroidery] Updated pricing tiers for stitch count:', state.pricingTiers);
                    }
                } else {
                    console.log('[Cap Embroidery] No pricing profile found for stitch count:', currentStitchCount);
                    console.log('[Cap Embroidery] Available stitch count profiles:', Object.keys(window.capEmbroideryMasterData.allPriceProfiles));
                }
            } else {
                console.log('[Cap Embroidery] No master data available yet');
                
                // Try to trigger data loading if not available
                if (typeof window.capEmbroideryController !== 'undefined' && window.capEmbroideryController.calculatePricing) {
                    console.log('[Cap Embroidery] Attempting to trigger pricing calculation through controller');
                    window.capEmbroideryController.calculatePricing();
                }
            }
            
            // Update all pricing displays
            updatePricing();
            
            // Update the pricing table
            updatePricingTable();
            
            // Update the stitch count display in pricing section
            const stitchDisplay = document.getElementById('pricing-stitch-count-display');
            if (stitchDisplay) {
                stitchDisplay.textContent = `${state.frontLogoStitches.toLocaleString()} stitch pricing shown`;
            }
            
            // Force pricing recalculation with new tiers
            if (state.pricingTiers.length > 0) {
                console.log('[Cap Embroidery] Forcing pricing update with new tiers');
                updatePricing();
                updatePricingDisplay();
                updateBreakdown();
            }
            
            // Dispatch event for other components
            window.dispatchEvent(new CustomEvent('pricingDataUpdated', {
                detail: { stitchCount: state.frontLogoStitches }
            }));
            
            // Also dispatch pricingDataLoaded event for Universal Pricing Grid
            // Convert cap embroidery data to Universal Pricing Grid format
            if (state.pricingTiers.length > 0) {
                const gridData = {
                    headers: ['Quantity', 'OSFA'],
                    prices: {
                        'OSFA': {}
                    },
                    styleNumber: state.styleNumber,
                    color: state.selectedColor,
                    embellishmentType: 'cap-embroidery',
                    stitchCount: state.frontLogoStitches, // Pass the current stitch count
                    _dp5Processed: true, // Mark as processed to prevent dp5-helper from re-processing
                    _fromStitchCountUpdate: true // Additional flag to identify source
                };
                
                // Convert pricing tiers to the expected format
                const tierData = {};
                state.pricingTiers.forEach(tier => {
                    let rangeKey;
                    if (tier.min === 72 && tier.max === 99999) {
                        rangeKey = '72-99+';
                    } else {
                        rangeKey = `${tier.min}-${tier.max}`;
                    }
                    gridData.prices.OSFA[rangeKey] = tier.price.toFixed(2);
                    
                    // Add tier data in object format as expected by UniversalPricingGrid
                    tierData[rangeKey] = {
                        MinQuantity: tier.min,
                        MaxQuantity: tier.max === 99999 ? undefined : tier.max
                    };
                });
                
                // Add tierData and tiers (alias) to the event detail
                gridData.tierData = tierData;
                gridData.tiers = tierData; // Some components check for 'tiers' instead of 'tierData'
                
                window.dispatchEvent(new CustomEvent('pricingDataLoaded', {
                    detail: gridData
                }));
            }
            
            // Clear flag after a short delay
            setTimeout(() => {
                state.isUpdatingStitchCount = false;
            }, 100);
        }
        
        // Extract pricing from the displayed table
        function extractPricingFromTable() {
            const tbody = document.querySelector('#custom-pricing-grid tbody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            const newTiers = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const range = cells[0].textContent.trim();
                    
                    // Get the first price column (could be OSFA or S/M)
                    let priceText = cells[1].textContent.trim();
                    
                    // If the table has size columns (S/M, M/L, L/XL), use the first one
                    if (cells.length > 2 && priceText.includes('$')) {
                        priceText = cells[1].textContent.trim();
                    } else if (cells.length > 2) {
                        // Skip header rows
                        return;
                    }
                    
                    const price = parseFloat(priceText.replace('$', ''));
                    
                    if (!isNaN(price)) {
                        if (range.includes('24-47')) {
                            newTiers.push({ min: 24, max: 47, price: price });
                        } else if (range.includes('48-71')) {
                            newTiers.push({ min: 48, max: 71, price: price });
                        } else if (range.includes('72')) {
                            newTiers.push({ min: 72, max: 99999, price: price });
                        }
                    }
                }
            });
            
            if (newTiers.length > 0) {
                state.pricingTiers = newTiers;
                console.log('[Cap Embroidery] Extracted pricing tiers from table:', state.pricingTiers);
            }
        }
        
        // Update the pricing table with new data
        function updatePricingTable() {
            if (!window.capEmbroideryMasterData || !window.capEmbroideryMasterData.allPriceProfiles) {
                console.log('[Cap Embroidery] No master data available for pricing table update');
                return;
            }
            
            const currentStitchCount = state.frontLogoStitches.toString();
            const stitchCountProfile = window.capEmbroideryMasterData.allPriceProfiles[currentStitchCount];
            
            if (!stitchCountProfile) {
                console.log('[Cap Embroidery] No pricing profile for stitch count:', currentStitchCount);
                return;
            }
            
            const tbody = document.querySelector('#custom-pricing-grid tbody');
            if (!tbody) return;
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            // Add rows for each tier
            const tiers = [
                { range: '24-47', key: '24-47' },
                { range: '48-71', key: '48-71' },
                { range: '72+', key: '72+' }
            ];
            
            tiers.forEach(tier => {
                const row = document.createElement('tr');
                const rangeCell = document.createElement('td');
                rangeCell.textContent = tier.range;
                row.appendChild(rangeCell);
                
                // Add price cell for OSFA
                const priceCell = document.createElement('td');
                if (stitchCountProfile.OSFA && stitchCountProfile.OSFA[tier.key]) {
                    const price = parseFloat(stitchCountProfile.OSFA[tier.key]);
                    priceCell.innerHTML = `<strong>$${price.toFixed(2)}</strong>`;
                } else {
                    priceCell.textContent = '-';
                }
                row.appendChild(priceCell);
                
                tbody.appendChild(row);
            });
            
            console.log('[Cap Embroidery] Pricing table updated for stitch count:', currentStitchCount);
            
            // Extract the pricing from the table we just created
            extractPricingFromTable();
        }
        
        function updatePricing() {
            console.log('[Cap Embroidery] updatePricing called with quantity:', state.quantity);
            console.log('[Cap Embroidery] Current pricing tiers:', state.pricingTiers);
            
            // Update the pricing grid tier highlighting
            if (window.pricingGrid) {
                window.pricingGrid.highlightActiveTier(state.quantity);
            }
            
            // Get base price from tier
            let tier = null;
            
            // If we have Caspio data, use it
            if (state.pricingTiers.length > 0) {
                tier = state.pricingTiers.find(t => state.quantity >= t.min && state.quantity <= t.max);
                if (!tier) {
                    // For quantities below the first tier, use the first tier's price
                    if (state.quantity < state.pricingTiers[0].min) {
                        tier = state.pricingTiers[0];
                        console.log('[Cap Embroidery] Using first tier price for small quantity');
                    } else if (state.quantity >= 72) {
                        // Use last tier for 72+
                        tier = state.pricingTiers[state.pricingTiers.length - 1];
                    }
                }
                console.log('[Cap Embroidery] Found tier for quantity', state.quantity, ':', tier);
            }
            
            // Fallback pricing if no Caspio data yet
            if (!tier) {
                if (state.quantity >= 72) {
                    state.basePrice = 21;
                } else if (state.quantity >= 48) {
                    state.basePrice = 23;
                } else {
                    state.basePrice = 24;
                }
                console.log('[Cap Embroidery] Using fallback pricing:', state.basePrice);
            } else {
                state.basePrice = tier.price;
                console.log('[Cap Embroidery] Using tier pricing:', state.basePrice);
            }
            
            // Calculate additional costs
            let additionalCosts = 0;
            
            // Front logo stitch count is already included in the base price from Caspio
            // No additional charge needed for front logo
            
            // Back logo cost ($1 per 1,000 stitches)
            if (state.backLogoEnabled) {
                state.backLogoPrice = Math.ceil(state.backLogoStitches / 1000);
                additionalCosts += state.backLogoPrice;
            }
            
            // Calculate LTM fee if under 24
            let ltmFeePerUnit = 0;
            if (state.quantity < 24) {
                ltmFeePerUnit = 50 / state.quantity;
            }
            
            // Calculate final prices
            state.unitPrice = state.basePrice + additionalCosts + ltmFeePerUnit;
            state.totalPrice = state.unitPrice * state.quantity;
            
            // Update UI
            updatePricingDisplay();
            updateBreakdown();
            updateSavingsTip();
            updateLTMWarning();
        }
        
        function updatePricingDisplay() {
            const unitPriceEl = document.getElementById('unit-price');
            const totalPriceEl = document.getElementById('total-price');
            
            // Add updating class for visual feedback
            unitPriceEl.classList.add('updating');
            
            // Update prices
            unitPriceEl.textContent = `$${state.unitPrice.toFixed(2)}`;
            totalPriceEl.textContent = `Total: $${state.totalPrice.toFixed(2)}`;
            
            // Remove updating class after animation
            setTimeout(() => {
                unitPriceEl.classList.remove('updating');
            }, 300);
        }
        
        function updateBreakdown() {
            const breakdown = document.getElementById('pricing-breakdown');
            let html = '';
            
            // Base cap price
            html += `
                <div class="breakdown-item">
                    <span class="breakdown-label">Base cap price:</span>
                    <span class="breakdown-value">$${state.basePrice.toFixed(2)}</span>
                </div>
            `;
            
            // Front logo - price is included in base price from Caspio
            html += `
                <div class="breakdown-item">
                    <span class="breakdown-label">Front logo (${state.frontLogoStitches.toLocaleString()} stitches):</span>
                    <span class="breakdown-value">included</span>
                </div>
            `;
            
            // Back logo if enabled
            if (state.backLogoEnabled) {
                html += `
                    <div class="breakdown-item">
                        <span class="breakdown-label">Back logo (${state.backLogoStitches.toLocaleString()} stitches):</span>
                        <span class="breakdown-value">+$${state.backLogoPrice.toFixed(2)}</span>
                    </div>
                `;
            }
            
            // LTM fee if applicable
            if (state.quantity < 24) {
                html += `
                    <div class="breakdown-item">
                        <span class="breakdown-label">Setup fee (< 24 caps):</span>
                        <span class="breakdown-value">+$${(50/state.quantity).toFixed(2)}</span>
                    </div>
                `;
            }
            
            // Total
            html += `
                <div class="breakdown-item breakdown-total">
                    <span class="breakdown-label">Your price:</span>
                    <span class="breakdown-value">$${state.unitPrice.toFixed(2)} /cap</span>
                </div>
            `;
            
            breakdown.innerHTML = html;
        }
        
        function updateSavingsTip() {
            const savingsTip = document.getElementById('savings-tip');
            const tipText = document.getElementById('savings-tip-text');
            
            // Find current tier
            let currentTierIndex = -1;
            if (state.pricingTiers.length > 0) {
                currentTierIndex = state.pricingTiers.findIndex(t => 
                    state.quantity >= t.min && state.quantity <= t.max
                );
            }
            
            if (currentTierIndex > 0) {
                const nextTier = state.pricingTiers[currentTierIndex - 1];
                const capsNeeded = nextTier.min - state.quantity;
                
                if (capsNeeded > 0 && capsNeeded <= 20) {
                    const currentTotal = state.unitPrice * state.quantity;
                    const newUnitPrice = nextTier.price + (state.unitPrice - state.basePrice);
                    const newTotal = newUnitPrice * nextTier.min;
                    const savings = (state.unitPrice * nextTier.min) - newTotal;
                    
                    tipText.textContent = `Add ${capsNeeded} more caps to save $${Math.abs(savings).toFixed(2)} total!`;
                    savingsTip.style.display = 'flex';
                } else {
                    savingsTip.style.display = 'none';
                }
            } else {
                savingsTip.style.display = 'none';
            }
        }
        
        function updateLTMWarning() {
            const ltmWarning = document.getElementById('ltm-warning');
            if (state.quantity < 24) {
                ltmWarning.style.display = 'flex';
                const perCap = (50 / state.quantity).toFixed(2);
                document.getElementById('ltm-warning-text').textContent = 
                    `Orders under 24 caps include a $50 setup fee (+$${perCap}/cap)`;
            } else {
                ltmWarning.style.display = 'none';
            }
        }
        
        function toggleBackLogo() {
            const checkbox = document.getElementById('back-logo-checkbox');
            const details = document.getElementById('back-logo-details');
            
            state.backLogoEnabled = checkbox.checked;
            
            // Use display style instead of active class for modern-enhancements.css
            if (checkbox.checked) {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
            
            updatePricing();
        }
        
        // Update back logo from slider
        window.updateBackLogoFromSlider = function(value) {
            state.backLogoStitches = parseInt(value);
            
            // Update bubble
            const bubble = document.getElementById('back-value-bubble');
            if (bubble) {
                bubble.querySelector('.bubble-value').textContent = value.toLocaleString();
            }
            
            // Update slider visuals
            updateBackLogoSliderVisuals();
            
            // Update price display
            const price = Math.ceil(state.backLogoStitches / 1000);
            document.getElementById('back-logo-price-display').innerHTML = 
                `Additional Cost: <span style="color: var(--info-color);">$${price.toFixed(2)}</span> per cap`;
            
            // Update pricing if back logo is enabled
            if (state.backLogoEnabled) {
                updatePricing();
            }
        }
        
        function updateBackLogoSliderVisuals() {
            const slider = document.getElementById('back-logo-slider');
            const fill = document.getElementById('back-slider-fill');
            const bubble = document.getElementById('back-value-bubble');
            
            if (slider && fill && bubble) {
                const percent = (slider.value - slider.min) / (slider.max - slider.min);
                fill.style.width = `${percent * 100}%`;
                bubble.style.left = `${percent * 100}%`;
            }
        }
        
        function updateBackLogoStitches(delta) {
            const newValue = state.backLogoStitches + delta;
            
            if (newValue >= 5000 && newValue <= 15000) {
                state.backLogoStitches = newValue;
                
                // Update slider
                const slider = document.getElementById('back-logo-slider');
                if (slider) {
                    slider.value = newValue;
                    updateBackLogoFromSlider(newValue);
                }
            }
        }
        
        
        // Initialize visual toggle buttons
        function initializeVisualToggles() {
            // Set the default active toggle (8000 stitches)
            const defaultValue = 8000;
            document.querySelectorAll('.stitch-toggle-option').forEach(option => {
                if (parseInt(option.dataset.value) === defaultValue) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }
        
        // Populate initial pricing table with fallback data
        function populateInitialPricingTable() {
            const tbody = document.querySelector('#custom-pricing-grid tbody');
            if (!tbody) return;
            
            // Clear any existing rows
            tbody.innerHTML = '';
            
            // Add header row if needed
            const thead = document.querySelector('#custom-pricing-grid thead');
            if (thead) {
                const headerRow = document.getElementById('pricing-header-row');
                if (headerRow) {
                    headerRow.innerHTML = '<th>Quantity</th><th>OSFA</th>';
                }
            }
            
            // Add default pricing rows
            const defaultTiers = [
                { range: '24-47', price: 24 },
                { range: '48-71', price: 23 },
                { range: '72+', price: 21 }
            ];
            
            defaultTiers.forEach(tier => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tier.range}</td>
                    <td><strong>$${tier.price.toFixed(2)}</strong></td>
                `;
                tbody.appendChild(row);
            });
            
            console.log('[Cap Embroidery] Initial pricing table populated with default values');
        }
        
        // Fix pricing table to show 24-47 tier
        function fixPricingTable() {
            const tbody = document.querySelector('#custom-pricing-grid tbody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            if (rows.length === 0) return;
            
            // Check if first row is 48-71
            const firstRow = rows[0];
            const firstCell = firstRow.querySelector('td');
            if (firstCell && firstCell.textContent.includes('48-71')) {
                console.log('[Cap Embroidery] Adding missing 24-47 tier');
                
                // Create new row for 24-47
                const newRow = document.createElement('tr');
                const cells = firstRow.querySelectorAll('td');
                
                cells.forEach((cell, index) => {
                    const newCell = document.createElement('td');
                    if (index === 0) {
                        newCell.textContent = '24-47';
                    } else {
                        // Use the price from our pricing tiers if available
                        const tier24 = state.pricingTiers.find(t => t.min === 24);
                        const price = tier24 ? tier24.price : 24;
                        newCell.innerHTML = `<strong>$${price}</strong>`;
                    }
                    newRow.appendChild(newCell);
                });
                
                // Insert at beginning
                tbody.insertBefore(newRow, firstRow);
            }
        }
    </script>
</body>
</html>