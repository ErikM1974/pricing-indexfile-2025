<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cap Embroidery Pricing | Northwest Custom Apparel</title>
    
    <!-- Keep existing header styles for compatibility -->
    <link rel="stylesheet" href="/shared_components/css/universal-header.css">
    
    <!-- Simple, clean styles without design system -->
    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--gray-900);
            background-color: var(--light);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Hero Section */
        .hero-section {
            background: white;
            padding: 40px 0;
            border-bottom: 1px solid var(--gray-300);
        }
        
        .product-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }
        
        @media (max-width: 768px) {
            .product-header {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        /* Product Info */
        .product-info {
            margin-top: 20px;
        }
        
        .product-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 10px 0;
            color: var(--gray-900);
        }
        
        .product-style {
            color: var(--gray-600);
            margin: 0 0 20px 0;
        }
        
        .product-description h3 {
            font-size: 18px;
            margin: 20px 0 10px 0;
        }
        
        .product-description p {
            color: var(--gray-700);
            margin: 0;
        }
        
        /* Image Gallery */
        .gallery-placeholder {
            width: 100%;
            height: 400px;
            background: var(--gray-200);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .gallery-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-placeholder p {
            color: var(--gray-600);
            font-size: 18px;
            margin: 0;
        }
        
        /* Quick Quote Calculator */
        .quick-quote {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .quick-quote h2 {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 5px 0;
        }
        
        .quick-quote-subtitle {
            color: var(--gray-600);
            margin: 0 0 30px 0;
        }
        
        /* Quantity Controls */
        .quantity-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            transition: background-color 0.2s;
        }
        
        .quantity-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }
        
        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 80px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            padding: 8px;
            border: 2px solid var(--gray-300);
            border-radius: 4px;
        }
        
        .quantity-label {
            font-size: 18px;
            color: var(--gray-700);
        }
        
        /* Pricing Display */
        .pricing-display {
            background: var(--gray-100);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .unit-price {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }
        
        .unit-label {
            font-size: 14px;
            color: var(--gray-600);
        }
        
        .total-price {
            font-size: 18px;
            color: var(--gray-900);
            margin-top: 10px;
        }
        
        /* Pricing Breakdown */
        .pricing-breakdown {
            border-top: 1px solid var(--gray-300);
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .breakdown-label {
            color: var(--gray-700);
        }
        
        .breakdown-value {
            font-weight: 500;
            color: var(--gray-900);
        }
        
        .breakdown-total {
            font-weight: 600;
            font-size: 16px;
            border-top: 1px solid var(--gray-300);
            padding-top: 8px;
            margin-top: 8px;
        }
        
        /* Quick Select Buttons */
        .quick-select {
            margin-top: 20px;
        }
        
        .quick-select-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 10px;
            display: block;
        }
        
        .quick-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .quick-select-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
        }
        
        .quick-select-btn:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }
        
        .quick-select-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Main Content Sections */
        .main-content {
            padding: 40px 0;
        }
        
        .content-section {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .content-section h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 0 0 20px 0;
        }
        
        /* Options */
        .option-group {
            margin-bottom: 25px;
        }
        
        .option-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .option-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 16px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Back Logo Details */
        .back-logo-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--gray-100);
            border-radius: 4px;
        }
        
        .back-logo-details.active {
            display: block;
        }
        
        /* Stitch Counter */
        .stitch-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stitch-counter-btn {
            width: 30px;
            height: 30px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .stitch-counter-btn:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }
        
        .stitch-counter-display {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .stitch-counter-range {
            color: var(--gray-600);
            font-size: 14px;
        }
        
        /* Pricing Table */
        .pricing-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .pricing-table th,
        .pricing-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .pricing-table th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .pricing-table tr:hover {
            background: var(--gray-50);
        }
        
        /* CTA Section */
        .cta-section {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-top: 40px;
        }
        
        .cta-section h2 {
            font-size: 28px;
            margin: 0 0 10px 0;
        }
        
        .cta-section p {
            color: var(--gray-700);
            margin: 0 0 30px 0;
            font-size: 18px;
        }
        
        .cta-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--gray-100);
        }
        
        /* Features */
        .features {
            margin-top: 30px;
            line-height: 1.8;
        }
        
        .features p {
            margin: 5px 0;
            color: var(--gray-700);
        }
        
        /* Savings Tip */
        .savings-tip {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
            color: #856404;
        }
        
        .savings-tip-icon {
            font-size: 18px;
        }
        
        /* Hide elements */
        .hidden {
            display: none !important;
        }
        
        /* Hidden Calculator */
        .hidden-calculator {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        
        /* Clean Color Grid */
        .clean-color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .clean-color-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
        }
        
        .clean-swatch-item {
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .clean-swatch-item:hover {
            transform: scale(1.05);
        }
        
        .clean-swatch-item.active .clean-swatch-box {
            box-shadow: 0 0 0 3px var(--primary);
        }
        
        .clean-swatch-box {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--gray-300);
            transition: all 0.2s;
            background: var(--gray-100);
        }
        
        .clean-swatch-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .clean-swatch-name {
            font-size: 12px;
            margin-top: 6px;
            color: var(--gray-700);
            line-height: 1.2;
        }
        
        /* Selected Color Display */
        .selected-color-display {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--gray-100);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .selected-color-swatch {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px solid var(--gray-300);
            overflow: hidden;
        }
        
        .selected-color-swatch img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .selected-color-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: var(--gray-900);
        }
        
        .selected-color-info p {
            margin: 0;
            color: var(--gray-600);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Universal Navigation Header -->
    <header class="universal-header">
        <div class="header-top-bar">
            <div class="header-top-bar-content">
                <div class="contact-info">
                    <span>📞 253-922-5793</span>
                    <span>✉️ sales@nwcustomapparel.com</span>
                    <span>🕒 9AM-5PM</span>
                </div>
            </div>
        </div>
        
        <div class="header-main">
            <div class="header-main-content">
                <div class="header-brand">
                    <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20White%20Text.png?ver=1" alt="NW Custom Apparel Logo" class="header-logo-img">
                </div>
                
                <div class="header-nav-hub">
                    <a id="back-to-product" href="#" class="back-to-product">
                        <span class="back-icon">←</span> 
                        <span>Back to Product</span>
                    </a>
                    
                    <div class="page-context">
                        <div class="page-context-title">Cap Embroidery Pricing</div>
                        <div class="page-context-subtitle" id="current-product-context">Select a product to get started</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="header-breadcrumb">
            <div class="header-breadcrumb-content">
                <nav class="header-breadcrumb-nav">
                    <a href="/" class="breadcrumb-link">Home</a>
                    <span class="breadcrumb-separator">›</span>
                    <span>Products</span>
                    <span class="breadcrumb-separator">›</span>
                    <a id="breadcrumb-product-link" href="#" class="breadcrumb-link">
                        <span id="breadcrumb-product">Product</span>
                    </a>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-current">Cap Embroidery Pricing</span>
                </nav>
            </div>
        </div>
    </header>

    <!-- Hidden Caspio Matrix - Keep this for data source -->
    <div id="pricing-calculator" class="pricing-calculator hidden-calculator">
        <div class="loading-message">Loading pricing data...</div>
        <!-- Caspio Deploy Script - This connects to your database -->
        <div id="caspio-embed-container"></div>
    </div>

    <div id="app">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="container">
                <div class="product-header">
                    <!-- Left Column - Product Info -->
                    <div>
                        <div class="gallery-placeholder">
                            <img id="product-image" src="" alt="Product Image" style="display: none;">
                            <p id="image-placeholder">Product Image Gallery</p>
                        </div>
                        
                        <div class="product-info">
                            <h1 class="product-title" id="product-title">Product Title</h1>
                            <p class="product-style">Style: <strong id="product-style-context"></strong></p>
                            <!-- Hidden element for pricing-pages.js -->
                            <div style="display: none;">
                                <h3 id="product-title-context" class="product-title">Product Title</h3>
                            </div>
                            <div class="product-description">
                                <h3>What's Included</h3>
                                <p>Pricing includes an 8,000 stitch embroidered logo on one location.</p>
                            </div>
                            
                            <!-- Color Selection -->
                            <div class="color-selection" style="margin-top: 30px;">
                                <h3>Select Color</h3>
                                
                                <!-- Selected Color Display -->
                                <div class="selected-color-display">
                                    <div id="selected-color-swatch" class="selected-color-swatch">
                                        <!-- Color image will go here -->
                                    </div>
                                    <div class="selected-color-info">
                                        <h3 id="selected-color-name">Select a Color</h3>
                                        <p>Choose from available colors below</p>
                                    </div>
                                </div>
                                
                                <!-- Color Swatches Grid -->
                                <div id="color-swatches" class="clean-color-grid">
                                    <!-- Color swatches will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column - Quick Quote -->
                    <div>
                        <div class="quick-quote">
                            <h2>Quick Quote Calculator</h2>
                            <p class="quick-quote-subtitle">Enter quantity for instant pricing</p>
                            
                            <!-- Quantity Input -->
                            <div class="quantity-input-group">
                                <button class="quantity-btn" id="decrease-btn" onclick="updateQuantity(-1)">−</button>
                                <input type="number" class="quantity-input" id="quantity-input" value="31" min="1" max="10000" onchange="handleQuantityChange()">
                                <button class="quantity-btn" id="increase-btn" onclick="updateQuantity(1)">+</button>
                                <span class="quantity-label">caps</span>
                            </div>
                            
                            <!-- Pricing Display -->
                            <div class="pricing-display">
                                <div class="unit-price" id="unit-price">$24.00</div>
                                <div class="unit-label">per cap</div>
                                <div class="total-price" id="total-price">Total: $744.00</div>
                            </div>
                            
                            <!-- Pricing Breakdown -->
                            <div class="pricing-breakdown" id="pricing-breakdown">
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Base cap price:</span>
                                    <span class="breakdown-value">$24.00</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="breakdown-label">Front logo (8,000 stitches):</span>
                                    <span class="breakdown-value">included</span>
                                </div>
                                <div class="breakdown-item breakdown-total">
                                    <span class="breakdown-label">Your price:</span>
                                    <span class="breakdown-value">$24.00 /cap</span>
                                </div>
                            </div>
                            
                            <!-- Savings Tip -->
                            <div class="savings-tip" id="savings-tip">
                                <span class="savings-tip-icon">💡</span>
                                <span id="savings-tip-text"></span>
                            </div>
                            
                            <!-- Quick Select -->
                            <div class="quick-select">
                                <span class="quick-select-label">Quick select:</span>
                                <div class="quick-select-grid">
                                    <button class="quick-select-btn" onclick="setQuantity(12)">1 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(24)">2 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(36)">3 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(48)">4 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(72)">6 Dozen</button>
                                    <button class="quick-select-btn" onclick="setQuantity(144)">12 Dozen</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <!-- Customization Options -->
                <div class="content-section">
                    <h2>Customization Options</h2>
                    
                    <div class="option-group">
                        <label for="stitch-count">Front Logo Stitch Count</label>
                        <select id="stitch-count" class="option-select" onchange="updatePricing()">
                            <option value="8000" selected>8,000 stitches (Standard)</option>
                            <option value="10000">10,000 stitches (+$1.00)</option>
                            <option value="15000">15,000 stitches (+$2.00)</option>
                        </select>
                    </div>
                    
                    <div class="option-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="back-logo-checkbox" onchange="toggleBackLogo()">
                            Add embroidered back logo (+$5.00 per cap)
                        </label>
                        
                        <div class="back-logo-details" id="back-logo-details">
                            <label>Back Logo Stitch Count:</label>
                            <div class="stitch-counter">
                                <button class="stitch-counter-btn" onclick="updateBackLogoStitches(-1000)">−</button>
                                <span class="stitch-counter-display" id="back-logo-stitches">5,000</span>
                                <button class="stitch-counter-btn" onclick="updateBackLogoStitches(1000)">+</button>
                                <span class="stitch-counter-range">(5K-15K)</span>
                            </div>
                            <div style="margin-top: 10px; font-weight: 500;">
                                Additional Cost: $5.00 per cap
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pricing Table -->
                <div class="content-section" id="pricing-details">
                    <h2>Pricing by Quantity</h2>
                    <p style="color: var(--gray-600); margin-bottom: 20px;">Volume discounts automatically applied</p>
                    
                    <div class="pricing-table-container">
                        <table id="custom-pricing-grid" class="pricing-table">
                            <thead>
                                <tr id="pricing-header-row" class="pricing-table-header">
                                    <th>Quantity Range</th>
                                    <!-- Size headers will be dynamically populated -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Pricing data will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 14px; color: var(--gray-600);">
                        <strong>Note:</strong> Prices shown include embroidered logo on front. Back logo and stitch count upgrades are additional.
                    </p>
                </div>
                
                <!-- CTA Section -->
                <div class="cta-section">
                    <h2>Ready for Your Quote?</h2>
                    <p>Contact us with your quantity and customization details for a personalized quote.</p>
                    
                    <div class="cta-buttons">
                        <button class="btn btn-primary" onclick="window.location.href='tel:253-922-5793'">
                            📞 Call for Quote: 253-922-5793
                        </button>
                        
                        <button class="btn btn-secondary" onclick="window.location.href='mailto:sales@nwcustomapparel.com?subject=Cap Embroidery Quote Request'">
                            ✉️ Email Quote Request
                        </button>
                    </div>
                    
                    <div class="features">
                        <p>💚 <strong>Why Choose Northwest Custom Apparel?</strong></p>
                        <p>Family Owned and Operated Since 1977 • Milton, WA • Quality embroidery</p>
                        <p>📍 2025 Freeman Road East Milton, WA 98354</p>
                        <p>📱 You can text us at 253-922-5793</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keep existing header functionality -->
    <script src="/shared_components/js/header-button-functions.js"></script>
    
    <!-- Beta Analytics and Feedback -->
    <script src="/beta-analytics-tracker.js"></script>
    <script src="/beta-feedback-widget.js"></script>
    
    <!-- JavaScript Files from Original Page -->
    <!-- Base Layer - Core dependencies -->
    <script src="/shared_components/js/debug-config.js"></script>
    <script src="/shared_components/js/nwca-namespace.js"></script>
    <script src="/shared_components/js/constants.js"></script>
    <script src="/shared_components/js/app-config.js"></script>
    <script src="/shared_components/js/utils.js"></script>
    
    <!-- Data Layer - Pricing system -->
    <script src="/shared_components/js/pricing-matrix-api.js"></script>
    <script src="/shared_components/js/pricing-matrix-capture.js"></script>
    <script src="/shared_components/js/pricing-calculator.js"></script>
    <script src="/shared_components/js/dp5-helper.js"></script>
    
    <!-- UI Components -->
    <script src="/shared_components/js/ui-components.js"></script>
    <script src="/shared_components/js/pricing-pages.js"></script>
    
    <!-- Cap Embroidery Specific -->
    <script src="/shared_components/js/cap-embroidery-controller-v2.js"></script>
    <script src="/shared_components/js/clean-color-adapter.js"></script>
    <script src="/shared_components/js/cap-embroidery-ltm-fix.js"></script>

    <!-- Simple, working JavaScript with Caspio integration -->
    <script>
        // Cap Embroidery Pricing Logic
        const state = {
            quantity: 31,
            basePrice: 0,
            unitPrice: 0,
            totalPrice: 0,
            frontLogoStitches: 8000,
            backLogoEnabled: false,
            backLogoStitches: 5000,
            backLogoPrice: 5,
            selectedColor: '',
            styleNumber: '',
            productTitle: ''
        };
        
        // Pricing tiers for NE1000
        const pricingTiers = [
            { min: 24, max: 47, price: 24 },
            { min: 48, max: 71, price: 23 },
            { min: 72, max: Infinity, price: 21 }
        ];
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            state.styleNumber = urlParams.get('StyleNumber') || 'NE1000';
            state.selectedColor = urlParams.get('COLOR') || 'Cyber Green';
            
            // Update product info
            updateProductInfo();
            
            // Initial pricing calculation
            updatePricing();
            
            // Listen for color selection events from DP5/clean-color-adapter
            document.addEventListener('colorSelected', function(event) {
                if (event.detail && event.detail.colorName) {
                    state.selectedColor = event.detail.colorName;
                    updateProductInfo();
                    updateSelectedColorDisplay(event.detail.colorName, event.detail.colorImage);
                }
            });
            
            // Listen for pricing data updates
            window.addEventListener('pricingDataLoaded', function(event) {
                console.log('[Beta Page] Pricing data loaded event received', event.detail);
                
                // Check if we need to add the 24-47 tier
                setTimeout(function() {
                    fixPricingTable();
                }, 500);
            });
            
            // Also listen for the pricing table to be updated
            const pricingGrid = document.getElementById('custom-pricing-grid');
            if (pricingGrid) {
                const observer = new MutationObserver(function() {
                    fixPricingTable();
                });
                observer.observe(pricingGrid, { childList: true, subtree: true });
            }
            
            // Set global variables that the controllers expect
            window.selectedStyleNumber = state.styleNumber;
            window.selectedCatalogColor = state.selectedColor;
            
            // Initialize cap embroidery controller if available
            if (window.capEmbroideryController) {
                console.log('[Beta Page] Cap embroidery controller found, initializing...');
            }
            
            // Load Caspio data via iframe
            loadCaspioData();
        });
        
        // Load Caspio pricing data
        function loadCaspioData() {
            const container = document.getElementById('caspio-embed-container');
            if (!container) return;
            
            // Create the iframe URL with the style parameter
            const caspioSrc = `https://c3eku948.caspio.com/dp/a0e15000c5d8e1f2e9e94c3c9a5a/emb?StyleNumber=${encodeURIComponent(state.styleNumber)}`;
            
            // Create iframe
            const iframe = document.createElement('iframe');
            iframe.src = caspioSrc;
            iframe.style.width = '100%';
            iframe.style.height = '500px';
            iframe.style.border = 'none';
            iframe.style.position = 'absolute';
            iframe.style.left = '-9999px';
            
            container.appendChild(iframe);
            console.log('[Beta Page] Loading Caspio data for style:', state.styleNumber);
        }
        
        function updateProductInfo() {
            // Update product title
            const titles = {
                'NE1000': 'New Era - Structured Stretch Cotton Cap',
                'C112': 'Port & Company - Snapback Trucker Cap',
                'PC800': 'Port & Company - Unstructured Sandwich Bill Cap'
            };
            
            state.productTitle = titles[state.styleNumber] || state.styleNumber;
            
            // Update UI
            document.getElementById('product-title').textContent = state.productTitle;
            document.getElementById('product-style-context').textContent = state.styleNumber;
            
            // Also update the hidden title context that pricing-pages.js looks for
            const titleContext = document.getElementById('product-title-context');
            if (titleContext) {
                titleContext.textContent = state.productTitle;
            }
            document.getElementById('current-product-context').textContent = state.productTitle;
            document.getElementById('breadcrumb-product').textContent = state.styleNumber;
            
            // Update product image
            const imageUrl = `https://www.companycasuals.com/mmCOMPANYCASUALS/Images/${state.styleNumber}/${state.selectedColor.replace(/\s+/g, '_')}.jpg`;
            const productImage = document.getElementById('product-image');
            const placeholder = document.getElementById('image-placeholder');
            
            productImage.src = imageUrl;
            productImage.onload = function() {
                productImage.style.display = 'block';
                placeholder.style.display = 'none';
            };
            productImage.onerror = function() {
                productImage.style.display = 'none';
                placeholder.style.display = 'block';
            };
            
            // Update back to product link
            const backLink = document.getElementById('back-to-product');
            const breadcrumbLink = document.getElementById('breadcrumb-product-link');
            const productUrl = `/product?StyleNumber=${state.styleNumber}&COLOR=${encodeURIComponent(state.selectedColor)}`;
            
            backLink.href = productUrl;
            breadcrumbLink.href = productUrl;
        }
        
        function updateQuantity(delta) {
            const newQty = state.quantity + delta;
            if (newQty >= 1 && newQty <= 10000) {
                state.quantity = newQty;
                document.getElementById('quantity-input').value = newQty;
                updatePricing();
            }
        }
        
        function handleQuantityChange() {
            const input = document.getElementById('quantity-input');
            const qty = parseInt(input.value) || 1;
            
            if (qty < 1) {
                state.quantity = 1;
                input.value = 1;
            } else if (qty > 10000) {
                state.quantity = 10000;
                input.value = 10000;
            } else {
                state.quantity = qty;
            }
            
            updatePricing();
        }
        
        function setQuantity(qty) {
            state.quantity = qty;
            document.getElementById('quantity-input').value = qty;
            updatePricing();
            
            // Update active button
            document.querySelectorAll('.quick-select-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function updatePricing() {
            // Get base price from tier
            const tier = pricingTiers.find(t => state.quantity >= t.min && state.quantity <= t.max);
            state.basePrice = tier ? tier.price : pricingTiers[pricingTiers.length - 1].price;
            
            // Calculate additional costs
            let additionalCosts = 0;
            
            // Front logo stitch count upcharge
            const stitchCount = parseInt(document.getElementById('stitch-count').value);
            state.frontLogoStitches = stitchCount;
            
            if (stitchCount === 10000) {
                additionalCosts += 1;
            } else if (stitchCount === 15000) {
                additionalCosts += 2;
            }
            
            // Back logo cost
            if (state.backLogoEnabled) {
                additionalCosts += state.backLogoPrice;
            }
            
            // Calculate final prices
            state.unitPrice = state.basePrice + additionalCosts;
            state.totalPrice = state.unitPrice * state.quantity;
            
            // Update UI
            updatePricingDisplay();
            updateBreakdown();
            updateSavingsTip();
        }
        
        function updatePricingDisplay() {
            document.getElementById('unit-price').textContent = `$${state.unitPrice.toFixed(2)}`;
            document.getElementById('total-price').textContent = `Total: $${state.totalPrice.toFixed(2)}`;
        }
        
        function updateBreakdown() {
            const breakdown = document.getElementById('pricing-breakdown');
            let html = '';
            
            // Base cap price
            html += `
                <div class="breakdown-item">
                    <span class="breakdown-label">Base cap price:</span>
                    <span class="breakdown-value">$${state.basePrice.toFixed(2)}</span>
                </div>
            `;
            
            // Front logo
            let frontLogoText = 'included';
            if (state.frontLogoStitches === 10000) {
                frontLogoText = '+$1.00';
            } else if (state.frontLogoStitches === 15000) {
                frontLogoText = '+$2.00';
            }
            
            html += `
                <div class="breakdown-item">
                    <span class="breakdown-label">Front logo (${state.frontLogoStitches.toLocaleString()} stitches):</span>
                    <span class="breakdown-value">${frontLogoText}</span>
                </div>
            `;
            
            // Back logo if enabled
            if (state.backLogoEnabled) {
                html += `
                    <div class="breakdown-item">
                        <span class="breakdown-label">Back logo (${state.backLogoStitches.toLocaleString()} stitches):</span>
                        <span class="breakdown-value">+$${state.backLogoPrice.toFixed(2)}</span>
                    </div>
                `;
            }
            
            // Total
            html += `
                <div class="breakdown-item breakdown-total">
                    <span class="breakdown-label">Your price:</span>
                    <span class="breakdown-value">$${state.unitPrice.toFixed(2)} /cap</span>
                </div>
            `;
            
            breakdown.innerHTML = html;
        }
        
        function updateSavingsTip() {
            const savingsTip = document.getElementById('savings-tip');
            const tipText = document.getElementById('savings-tip-text');
            
            // Find current tier
            const currentTierIndex = pricingTiers.findIndex(t => 
                state.quantity >= t.min && state.quantity <= t.max
            );
            
            if (currentTierIndex > 0) {
                const nextTier = pricingTiers[currentTierIndex - 1];
                const capsNeeded = nextTier.min - state.quantity;
                
                if (capsNeeded > 0 && capsNeeded <= 20) {
                    const savings = (state.unitPrice - (nextTier.price + (state.unitPrice - state.basePrice))) * nextTier.min;
                    
                    tipText.textContent = `Add ${capsNeeded} more caps to save $${Math.abs(savings).toFixed(2)} total!`;
                    savingsTip.style.display = 'flex';
                } else {
                    savingsTip.style.display = 'none';
                }
            } else {
                savingsTip.style.display = 'none';
            }
        }
        
        function toggleBackLogo() {
            const checkbox = document.getElementById('back-logo-checkbox');
            const details = document.getElementById('back-logo-details');
            
            state.backLogoEnabled = checkbox.checked;
            
            if (checkbox.checked) {
                details.classList.add('active');
            } else {
                details.classList.remove('active');
            }
            
            updatePricing();
        }
        
        function updateBackLogoStitches(delta) {
            const newValue = state.backLogoStitches + delta;
            
            if (newValue >= 5000 && newValue <= 15000) {
                state.backLogoStitches = newValue;
                document.getElementById('back-logo-stitches').textContent = newValue.toLocaleString();
            }
        }
        
        // Fix pricing table to show 24-47 tier
        function fixPricingTable() {
            const tbody = document.querySelector('#custom-pricing-grid tbody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            if (rows.length === 0) return;
            
            // Check if first row is 48-71
            const firstRow = rows[0];
            const firstCell = firstRow.querySelector('td');
            if (firstCell && firstCell.textContent.includes('48-71')) {
                console.log('[Beta Page] Adding missing 24-47 tier');
                
                // Create new row for 24-47
                const newRow = document.createElement('tr');
                const cells = firstRow.querySelectorAll('td');
                
                cells.forEach((cell, index) => {
                    const newCell = document.createElement('td');
                    if (index === 0) {
                        newCell.textContent = '24-47';
                    } else {
                        // For cap embroidery, 24-47 should be $24
                        newCell.innerHTML = '<strong>$24</strong>';
                    }
                    newRow.appendChild(newCell);
                });
                
                // Insert at beginning
                tbody.insertBefore(newRow, firstRow);
            }
        }
        
        // Update selected color display
        function updateSelectedColorDisplay(colorName, colorImage) {
            const nameElement = document.getElementById('selected-color-name');
            const swatchElement = document.getElementById('selected-color-swatch');
            
            if (nameElement) {
                nameElement.textContent = colorName || 'Select a Color';
            }
            
            if (swatchElement && colorImage) {
                swatchElement.innerHTML = `<img src="${colorImage}" alt="${colorName}">`;
            }
        }
    </script>
</body>
</html>