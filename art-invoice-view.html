<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>View Invoice - Northwest Custom Apparel</title>
    <link rel="icon" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Art Invoice Service V2 -->
    <script src="calculators/art-invoice-service-v2.js?v=2.1"></script>
    
    <!-- Shared Art Invoice Styles -->
    <link rel="stylesheet" href="css/art-invoice-shared.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                     alt="Northwest Custom Apparel" class="logo">
                <nav class="breadcrumb">
                    <a href="/staff-dashboard.html">Staff Dashboard</a>
                    <span>/</span>
                    <a href="/art-invoices-dashboard.html">Art Invoices</a>
                    <span>/</span>
                    <span id="breadcrumbInvoiceId">View Invoice</span>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Loading State -->
        <div id="loadingContainer" class="loading-container">
            <div class="loading"></div>
        </div>

        <!-- Action Bar -->
        <div id="actionBar" class="action-bar" style="display: none;">
            <div class="action-group">
                <button class="btn btn-secondary" onclick="window.location.href='/art-invoices-dashboard.html'">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </button>
            </div>
            
            <div id="statusBadgeContainer"></div>
            
            <div class="action-group">
                <button class="btn btn-secondary" onclick="window.print()">
                    <i class="fas fa-print"></i>
                    Print
                </button>
                <button id="emailBtn" class="btn btn-primary" onclick="sendInvoiceEmail()">
                    <i class="fas fa-paper-plane"></i>
                    Send Email
                </button>
                <button id="voidBtn" class="btn btn-danger" onclick="voidCurrentInvoice()" style="display: none;">
                    <i class="fas fa-ban"></i>
                    Void Invoice
                </button>
            </div>
        </div>

        <!-- Invoice Content -->
        <div id="invoiceContent" style="display: none;">
            <div class="invoice-container">
                <!-- Invoice Header -->
                <div class="invoice-header">
                    <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" 
                         alt="Northwest Custom Apparel" class="invoice-logo">
                    <div class="invoice-title">
                        <h1>ART INVOICE</h1>
                        <p><strong>Invoice ID:</strong> <span id="invoiceId"></span></p>
                        <p><strong>Date:</strong> <span id="invoiceDate"></span></p>
                        <p><strong>Due Date:</strong> <span id="dueDate"></span></p>
                    </div>
                </div>

                <!-- Invoice Details -->
                <div class="invoice-details">
                    <div class="invoice-section">
                        <h3>Bill To</h3>
                        <p><strong id="salesRepName"></strong></p>
                        <p id="salesRepEmail"></p>
                        <p>Northwest Custom Apparel</p>
                        <p>2025 Freeman Road East</p>
                        <p>Milton, WA 98354</p>
                    </div>
                    
                    <div class="invoice-section">
                        <h3>Customer</h3>
                        <p><strong id="customerName"></strong></p>
                        <p id="customerCompany"></p>
                        <p id="customerEmail"></p>
                    </div>
                </div>

                <!-- Project Info -->
                <div class="invoice-section" style="margin-bottom: 2rem;">
                    <h3>Project Details</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <p><strong>Project:</strong> <span id="projectName"></span></p>
                            <p><strong>Type:</strong> <span id="projectType"></span></p>
                            <p><strong>Complexity:</strong> <span id="complexity"></span></p>
                        </div>
                        <div>
                            <p><strong>Request Date:</strong> <span id="requestDate"></span></p>
                            <p><strong>Completion Date:</strong> <span id="completionDate"></span></p>
                            <p><strong>Artist:</strong> <span id="artistName"></span></p>
                        </div>
                    </div>
                    <div id="artworkDescriptionContainer" style="margin-top: 1rem; display: none;">
                        <p><strong>Description:</strong></p>
                        <p id="artworkDescription"></p>
                    </div>
                </div>

                <!-- Invoice Table -->
                <table class="invoice-table" id="invoiceTable">
                    <thead>
                        <tr id="tableHeader">
                            <th>Description</th>
                            <th class="text-right">Hours/Qty</th>
                            <th class="text-right">Rate</th>
                            <th class="text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody">
                        <!-- Table rows will be populated here -->
                    </tbody>
                </table>

                <!-- Invoice Totals -->
                <div class="invoice-totals">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotalAmount">$0.00</span>
                    </div>
                    <div id="additionalFeesRow" class="total-row" style="display: none;">
                        <span>Additional Fees:</span>
                        <span id="additionalFeesAmount">$0.00</span>
                    </div>
                    <div id="taxRow" class="total-row" style="display: none;">
                        <span>WA State Sales Tax (10.20%):</span>
                        <span id="taxAmount">$0.00</span>
                    </div>
                    <div id="taxExemptRow" class="total-row" style="display: none;">
                        <span>Sales Tax:</span>
                        <span>Tax Exempt</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total Due:</span>
                        <span id="grandTotalAmount">$0.00</span>
                    </div>
                </div>

                <!-- Spec Art Info Section -->
                <div id="specArtSection" class="invoice-section" style="margin-bottom: 2rem; display: none;">
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 1rem 0; color: #856404;">
                            <i class="fas fa-gift"></i>
                            Spec Artwork Information
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <p style="margin: 0.25rem 0;"><strong>Purpose:</strong> <span id="specArtPurpose"></span></p>
                                <p style="margin: 0.25rem 0;"><strong>Credit Applied:</strong> <span id="creditApplied"></span></p>
                            </div>
                            <div>
                                <p style="margin: 0.25rem 0; color: #856404; font-style: italic;">
                                    This artwork was provided as complimentary spec work to support sales efforts.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Artwork Section -->
                <div id="artworkSection" class="artwork-section" style="display: none;">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Notes Section -->
                <div id="notesSection" class="notes-section" style="display: none;">
                    <h3>Notes</h3>
                    <p id="customerNotes"></p>
                </div>

                <!-- Payment Section -->
                <div id="paymentSection" class="payment-section" style="display: none;">
                    <h3>Payment Information</h3>
                    <div class="payment-info">
                        <div class="payment-item">
                            <p><strong>Payment Method:</strong> <span id="paymentMethod"></span></p>
                            <p><strong>Payment Date:</strong> <span id="paymentDate"></span></p>
                        </div>
                        <div class="payment-item">
                            <p><strong>Reference:</strong> <span id="paymentReference"></span></p>
                            <p><strong>Amount Paid:</strong> <span id="paymentAmount"></span></p>
                        </div>
                        <div class="payment-item">
                            <p><strong>Balance Due:</strong> <span id="balanceDue"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-secondary); font-size: 0.875rem;">
                    <p>Payment due within 30 days</p>
                    <p>Please reference Invoice ID: <strong id="footerInvoiceId"></strong> with payment</p>
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                    <p><strong>Northwest Custom Apparel</strong></p>
                    <p>Family Owned & Operated Since 1977</p>
                    <p>Phone: 253-922-5793 | Email: sales@nwcustomapparel.com</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize
        let invoiceService;
        let currentInvoice = null;
        let invoiceId = null;
        let currentArtRequest = null;

        // Artwork Helper Functions
        function hasArtwork(cdnLink) {
            return cdnLink && cdnLink.includes('/Artwork/') && cdnLink !== 'https://cdn.caspio.com/A0E15000';
        }

        // Parse service items from Notes field (for backward compatibility)
        function parseServiceItemsFromNotes(notes) {
            if (!notes || !notes.includes('--- Service Items ---')) {
                return null;
            }

            const serviceItems = [];
            const lines = notes.split('\n');
            let inServiceSection = false;

            for (const line of lines) {
                const trimmed = line.trim();
                
                if (trimmed === '--- Service Items ---') {
                    inServiceSection = true;
                    continue;
                }
                
                if (inServiceSection && trimmed.startsWith('Summary:')) {
                    break; // End of service items section
                }
                
                if (inServiceSection && trimmed.match(/^\d+\.\s+([A-Z]+-[A-Z0-9]+):/)) {
                    // Parse line like: "1. GRT-50: Logo mockup description"
                    const match = trimmed.match(/^\d+\.\s+([A-Z]+-[A-Z0-9]+):\s*(.+)/);
                    if (match) {
                        const code = match[1];
                        const description = match[2];
                        
                        // Look for the next line with quantity and amount
                        const nextLineIndex = lines.indexOf(line) + 1;
                        if (nextLineIndex < lines.length) {
                            const nextLine = lines[nextLineIndex].trim();
                            const amountMatch = nextLine.match(/Amount:\s*\$([0-9,]+\.?[0-9]*)/);
                            const quantityMatch = nextLine.match(/Quantity:\s*([0-9]+)/);
                            
                            if (amountMatch) {
                                serviceItems.push({
                                    code: code,
                                    description: description,
                                    quantity: quantityMatch ? parseInt(quantityMatch[1]) : 1,
                                    amount: parseFloat(amountMatch[1].replace(',', ''))
                                });
                            }
                        }
                    }
                }
            }

            return serviceItems.length > 0 ? serviceItems : null;
        }

        function displayInvoiceArtwork(artRequest) {
            const artworkSection = document.getElementById('artworkSection');
            if (!artRequest) {
                artworkSection.style.display = 'none';
                return;
            }

            const cdnFields = [
                { field: 'CDN_Link', label: 'Artwork 1' },
                { field: 'CDN_Link_Two', label: 'Artwork 2' },
                { field: 'CDN_Link_Three', label: 'Artwork 3' },
                { field: 'CDN_Link_Four', label: 'Artwork 4' }
            ];
            
            let artworkHTML = '<h3>Associated Artwork</h3>';
            artworkHTML += '<div class="artwork-grid">';
            
            let hasAnyArtwork = false;
            
            cdnFields.forEach(({ field, label }) => {
                if (hasArtwork(artRequest[field])) {
                    hasAnyArtwork = true;
                    artworkHTML += `
                        <div class="artwork-item" onclick="showArtworkModal('${artRequest[field]}', '${label}')">
                            <img src="${artRequest[field]}" alt="${label}" 
                                 onerror="this.parentElement.style.display='none'">
                            <label>${label}</label>
                        </div>
                    `;
                }
            });
            
            if (!hasAnyArtwork) {
                artworkHTML += '<p class="no-artwork">No artwork files available for this design.</p>';
            }
            
            artworkHTML += '</div>';
            
            artworkSection.innerHTML = artworkHTML;
            artworkSection.style.display = 'block';
        }

        function showArtworkModal(imageUrl, label) {
            let modal = document.getElementById('artworkModal');
            if (!modal) {
                modal = createArtworkModal();
            }
            
            const modalImage = modal.querySelector('.modal-artwork-image');
            const downloadBtn = modal.querySelector('.artwork-modal-download');
            
            modalImage.src = imageUrl;
            downloadBtn.onclick = () => downloadArtwork(imageUrl, label);
            
            modal.classList.add('active');
        }

        function createArtworkModal() {
            const modal = document.createElement('div');
            modal.id = 'artworkModal';
            modal.className = 'artwork-modal';
            modal.innerHTML = `
                <div class="artwork-modal-content">
                    <button class="artwork-modal-close" onclick="closeArtworkModal()">×</button>
                    <img class="modal-artwork-image" src="" alt="Artwork">
                    <button class="artwork-modal-download">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeArtworkModal();
                }
            });
            
            return modal;
        }

        function closeArtworkModal() {
            const modal = document.getElementById('artworkModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function downloadArtwork(imageUrl, label) {
            const link = document.createElement('a');
            link.href = imageUrl;
            const idDesign = currentInvoice.ArtRequestID || 'Unknown';
            link.download = `Design_${idDesign}_${label.replace(' ', '_')}.png`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            invoiceService = new ArtInvoiceServiceV2();
            
            // Initialize EmailJS
            emailjs.init('4qSbDO-SQs19TbP80');
            
            // Get invoice ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            invoiceId = urlParams.get('id');
            
            if (!invoiceId) {
                showError('No invoice ID provided');
                return;
            }
            
            // Load invoice
            await loadInvoice();
        });
        
        // Load Invoice
        async function loadInvoice() {
            try {
                // Fetch invoice data
                const invoices = await invoiceService.getInvoices({ invoiceID: invoiceId });
                
                if (!invoices || invoices.length === 0) {
                    showError('Invoice not found');
                    return;
                }
                
                currentInvoice = invoices[0];
                displayInvoice();
                
                // Load art request data if available
                if (currentInvoice.ArtRequestID) {
                    try {
                        const artRequests = await invoiceService.getArtRequests({ 
                            id_design: currentInvoice.ArtRequestID,
                            limit: 1 
                        });
                        if (artRequests && artRequests.length > 0) {
                            currentArtRequest = artRequests[0];
                            displayInvoiceArtwork(currentArtRequest);
                        }
                    } catch (error) {
                        console.error('Error loading art request:', error);
                    }
                }
                
                // Hide loading, show content
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('actionBar').style.display = 'flex';
                document.getElementById('invoiceContent').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading invoice:', error);
                showError('Error loading invoice');
            }
        }
        
        // Display Invoice
        function displayInvoice() {
            // Update breadcrumb
            document.getElementById('breadcrumbInvoiceId').textContent = currentInvoice.InvoiceID;
            
            // Status badge
            const statusBadge = `
                <span class="status-badge ${currentInvoice.Status.toLowerCase().replace(' ', '-')}">
                    ${getStatusIcon(currentInvoice.Status)}
                    ${currentInvoice.Status}
                </span>
            `;
            document.getElementById('statusBadgeContainer').innerHTML = statusBadge;
            
            // Invoice header
            document.getElementById('invoiceId').textContent = currentInvoice.InvoiceID;
            document.getElementById('invoiceDate').textContent = formatDate(currentInvoice.InvoiceDate);
            document.getElementById('dueDate').textContent = formatDate(currentInvoice.DueDate);
            document.getElementById('footerInvoiceId').textContent = currentInvoice.InvoiceID;
            
            // Bill to (Sales Rep)
            document.getElementById('salesRepName').textContent = currentInvoice.SalesRepName || 'Sales Representative';
            document.getElementById('salesRepEmail').textContent = currentInvoice.SalesRepEmail || '';
            
            // Customer info
            document.getElementById('customerName').textContent = currentInvoice.CustomerName || 'Unknown Customer';
            document.getElementById('customerCompany').textContent = currentInvoice.CustomerCompany || '';
            document.getElementById('customerEmail').textContent = currentInvoice.CustomerEmail || '';
            
            // Project details
            document.getElementById('projectName').textContent = currentInvoice.ProjectName || 'N/A';
            document.getElementById('projectType').textContent = currentInvoice.ProjectType || 'N/A';
            document.getElementById('complexity').textContent = currentInvoice.Complexity || 'Standard';
            document.getElementById('requestDate').textContent = formatDate(currentInvoice.OriginalRequestDate);
            document.getElementById('completionDate').textContent = formatDate(currentInvoice.CompletionDate);
            document.getElementById('artistName').textContent = currentInvoice.ArtistName || 'N/A';
            
            // Artwork description
            if (currentInvoice.ArtworkDescription) {
                document.getElementById('artworkDescriptionContainer').style.display = 'block';
                document.getElementById('artworkDescription').textContent = currentInvoice.ArtworkDescription;
            }
            
            // Build invoice table
            const tbody = document.getElementById('invoiceTableBody');
            const tableHeader = document.getElementById('tableHeader');
            tbody.innerHTML = '';
            
            // Check if this invoice uses service codes
            if (currentInvoice.ServiceItems && currentInvoice.ServiceItems !== 'null' && currentInvoice.ServiceItems !== '') {
                try {
                    // Parse service items from JSON
                    const serviceItems = JSON.parse(currentInvoice.ServiceItems);
                    
                    // Update table headers for service code display
                    tableHeader.innerHTML = `
                        <th>Description</th>
                        <th class="text-right">Service Code</th>
                        <th class="text-right">Qty</th>
                        <th class="text-right">Amount</th>
                    `;
                    
                    // Display each service item
                    serviceItems.forEach(item => {
                        const quantity = item.quantity || 1;
                        const rate = item.rate || item.amount;
                        const total = item.amount || (rate * quantity);
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${item.description || 'Art Services'}</td>
                                <td class="text-right">${item.code}</td>
                                <td class="text-right">${quantity}</td>
                                <td class="text-right">$${total.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                } catch (e) {
                    console.error('Error parsing service items:', e);
                    console.log('ServiceItems data:', currentInvoice.ServiceItems);
                    // Fall back to subtotal display
                    displaySubtotalOnly();
                }
            } else {
                // Try to parse service items from Notes field (for existing invoices)
                const serviceItemsFromNotes = parseServiceItemsFromNotes(currentInvoice.Notes);
                
                if (serviceItemsFromNotes && serviceItemsFromNotes.length > 0) {
                    // Update table headers for service code display
                    tableHeader.innerHTML = `
                        <th>Description</th>
                        <th class="text-right">Service Code</th>
                        <th class="text-right">Qty</th>
                        <th class="text-right">Amount</th>
                    `;
                    
                    // Display each service item from notes
                    serviceItemsFromNotes.forEach(item => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${item.description || 'Art Services'}</td>
                                <td class="text-right">${item.code}</td>
                                <td class="text-right">${item.quantity || 1}</td>
                                <td class="text-right">$${(item.amount || 0).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                } else {
                    // If no service items anywhere, show the subtotal
                    displaySubtotalOnly();
                }
            }
            
            function displaySubtotalOnly() {
                // Update headers for simple display
                tableHeader.innerHTML = `
                    <th>Description</th>
                    <th class="text-right">Service Code</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Amount</th>
                `;
                
                // Display subtotal as single line item
                const subtotal = parseFloat(currentInvoice.SubtotalAmount || 0);
                const projectType = currentInvoice.ProjectType || 'Design';
                
                // Check for ServiceCodes field - this contains comma-separated codes like "GRT-50,GRT-25"
                let serviceCodeDisplay = '-';
                if (currentInvoice.ServiceCodes && currentInvoice.ServiceCodes.trim() !== '') {
                    serviceCodeDisplay = currentInvoice.ServiceCodes;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>Art Services - ${projectType}</td>
                        <td class="text-right">${serviceCodeDisplay}</td>
                        <td class="text-right">1</td>
                        <td class="text-right">$${subtotal.toFixed(2)}</td>
                    </tr>
                `;
            }
            
            // Totals
            const subtotal = parseFloat(currentInvoice.SubtotalAmount || 0);
            document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            
            const rushFee = parseFloat(currentInvoice.RushFee || 0);
            const revisionFee = parseFloat(currentInvoice.RevisionFee || 0);
            const otherFees = parseFloat(currentInvoice.OtherFees || 0);
            const additionalFees = rushFee + revisionFee + otherFees;
            if (additionalFees > 0) {
                document.getElementById('additionalFeesRow').style.display = 'flex';
                document.getElementById('additionalFeesAmount').textContent = `$${additionalFees.toFixed(2)}`;
            }
            
            // Sales tax display
            const taxAmount = parseFloat(currentInvoice.TaxAmount || 0);
            const invoiceContainer = document.querySelector('.invoice-container');
            
            if (taxAmount > 0) {
                document.getElementById('taxRow').style.display = 'flex';
                document.getElementById('taxAmount').textContent = `$${taxAmount.toFixed(2)}`;
                document.getElementById('taxExemptRow').style.display = 'none';
                // Add class for print CSS
                invoiceContainer.classList.remove('tax-exempt');
                invoiceContainer.classList.add('has-tax');
            } else {
                document.getElementById('taxRow').style.display = 'none';
                document.getElementById('taxExemptRow').style.display = 'flex';
                // Add class for print CSS
                invoiceContainer.classList.remove('has-tax');
                invoiceContainer.classList.add('tax-exempt');
            }
            
            const grandTotal = parseFloat(currentInvoice.GrandTotal || 0);
            document.getElementById('grandTotalAmount').textContent = `$${grandTotal.toFixed(2)}`;
            
            // Notes
            if (currentInvoice.CustomerNotes) {
                document.getElementById('notesSection').style.display = 'block';
                document.getElementById('customerNotes').textContent = currentInvoice.CustomerNotes;
            }
            
            // Payment information
            if (currentInvoice.PaymentAmount && currentInvoice.PaymentAmount > 0) {
                document.getElementById('paymentSection').style.display = 'block';
                document.getElementById('paymentMethod').textContent = currentInvoice.PaymentMethod || 'N/A';
                document.getElementById('paymentDate').textContent = formatDate(currentInvoice.PaymentDate);
                document.getElementById('paymentReference').textContent = currentInvoice.PaymentReference || 'N/A';
                document.getElementById('paymentAmount').textContent = `$${parseFloat(currentInvoice.PaymentAmount).toFixed(2)}`;
                document.getElementById('balanceDue').textContent = `$${parseFloat(currentInvoice.BalanceDue || 0).toFixed(2)}`;
            }
            
            // Spec Art Information
            if (currentInvoice.IsSpecArtwork === true || currentInvoice.IsSpecArtwork === 'true') {
                document.getElementById('specArtSection').style.display = 'block';
                document.getElementById('specArtPurpose').textContent = currentInvoice.SpecArtPurpose || 'Sales support';
                
                const creditApplied = parseFloat(currentInvoice.CreditApplied || 0);
                if (creditApplied > 0) {
                    document.getElementById('creditApplied').textContent = `$${creditApplied.toFixed(2)}`;
                } else {
                    document.getElementById('creditApplied').textContent = 'Complimentary';
                }
            } else {
                document.getElementById('specArtSection').style.display = 'none';
            }
            
            // Update email button visibility
            if (currentInvoice.Status === 'Draft') {
                document.getElementById('emailBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Send Invoice';
            } else {
                document.getElementById('emailBtn').innerHTML = '<i class="fas fa-envelope"></i> Resend Invoice';
            }
            
            // Update void button visibility - only show for appropriate statuses
            const voidBtn = document.getElementById('voidBtn');
            const canVoid = currentInvoice.Status && 
                           currentInvoice.Status !== 'Voided' && 
                           currentInvoice.Status !== 'Cancelled' &&
                           !currentInvoice.IsDeleted;
            
            if (canVoid) {
                voidBtn.style.display = 'inline-flex';
            } else {
                voidBtn.style.display = 'none';
            }
        }
        
        // Send Invoice Email
        async function sendInvoiceEmail() {
            if (!currentInvoice) return;
            
            if (!confirm(`Send invoice to ${currentInvoice.SalesRepName || 'Sales Rep'}?`)) {
                return;
            }
            
            // Prepare email data
            const emailData = {
                // System fields
                to_email: currentInvoice.SalesRepEmail,
                reply_to: currentInvoice.ArtistEmail || 'art@nwcustomapparel.com',
                from_name: 'Northwest Custom Apparel Art Department',
                
                // Invoice details
                invoice_id: currentInvoice.InvoiceID,
                invoice_date: formatDate(currentInvoice.InvoiceDate),
                due_date: formatDate(currentInvoice.DueDate),
                
                // Recipient info
                sales_rep_name: currentInvoice.SalesRepName || 'Sales Representative',
                sales_rep_email: currentInvoice.SalesRepEmail || '',
                
                // Customer info
                customer_name: currentInvoice.CustomerName || 'Unknown Customer',
                customer_company: currentInvoice.CustomerCompany || 'Not Provided',
                
                // Project details
                project_name: currentInvoice.ProjectName || 'N/A',
                project_type: currentInvoice.ProjectType || 'N/A',
                artwork_description: currentInvoice.ArtworkDescription || 'See attached invoice for details',
                
                // Time and billing - handle both service codes and hourly
                time_spent: (currentInvoice.TimeSpent || 0).toFixed(2),
                hourly_rate: (currentInvoice.HourlyRate || 0).toFixed(2),
                subtotal: (currentInvoice.SubtotalAmount || 0).toFixed(2),
                
                // Service items for new billing method
                service_items_html: '',
                
                // Additional fees
                rush_fee: (currentInvoice.RushFee || 0).toFixed(2),
                revision_fee: (currentInvoice.RevisionFee || 0).toFixed(2),
                other_fees: (currentInvoice.OtherFees || 0).toFixed(2),
                
                // Totals
                grand_total: (currentInvoice.GrandTotal || 0).toFixed(2),
                
                // Notes
                notes: currentInvoice.CustomerNotes || 'No additional notes',
                
                // Company info
                company_phone: '253-922-5793',
                company_year: '1977'
            };
            
            // Build service items HTML if using service codes
            if (currentInvoice.ServiceItems) {
                try {
                    const serviceItems = JSON.parse(currentInvoice.ServiceItems);
                    let itemsHtml = `
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Description</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Service Code</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    serviceItems.forEach(item => {
                        itemsHtml += `
                            <tr>
                                <td style="padding: 10px; border: 1px solid #e5e7eb;">${item.description}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">${item.code}</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">$${item.amount.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    itemsHtml += `
                            </tbody>
                        </table>
                    `;
                    
                    emailData.service_items_html = itemsHtml;
                } catch (e) {
                    console.error('Error building service items HTML:', e);
                }
            }
            
            try {
                // Show loading
                document.getElementById('emailBtn').disabled = true;
                document.getElementById('emailBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                
                // Send email using EmailJS
                await emailjs.send(
                    'service_1c4k67j',
                    'ArtInvoice', // Using the template ID you created
                    emailData
                );
                
                // Update invoice status if it was a draft
                if (currentInvoice.Status === 'Draft') {
                    await invoiceService.markInvoiceAsSent(currentInvoice.InvoiceID, currentInvoice.SalesRepEmail);
                }
                
                alert('Invoice sent successfully!');
                
                // Reload to show updated status
                window.location.reload();
                
            } catch (error) {
                console.error('Error sending email:', error);
                alert('Failed to send invoice. Please try again.');
                
                // Reset button
                document.getElementById('emailBtn').disabled = false;
                if (currentInvoice.Status === 'Draft') {
                    document.getElementById('emailBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Send Invoice';
                } else {
                    document.getElementById('emailBtn').innerHTML = '<i class="fas fa-envelope"></i> Resend Invoice';
                }
            }
        }
        
        // Show Error
        function showError(message) {
            document.getElementById('loadingContainer').innerHTML = `
                <div style="text-align: center; color: var(--error-text);">
                    <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>${message}</p>
                    <button class="btn btn-secondary" onclick="window.history.back()" style="margin-top: 1rem;">
                        <i class="fas fa-arrow-left"></i>
                        Go Back
                    </button>
                </div>
            `;
        }
        
        // Format Date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        // Get Status Icon
        function getStatusIcon(status) {
            const icons = {
                'Draft': '<i class="fas fa-file"></i>',
                'Sent': '<i class="fas fa-paper-plane"></i>',
                'Paid': '<i class="fas fa-check-circle"></i>',
                'Partial': '<i class="fas fa-coins"></i>',
                'Overdue': '<i class="fas fa-exclamation-triangle"></i>',
                'Voided': '<i class="fas fa-ban"></i>'
            };
            return icons[status] || '<i class="fas fa-circle"></i>';
        }
        
        // Void Current Invoice
        async function voidCurrentInvoice() {
            if (!currentInvoice) {
                alert('No invoice loaded to void.');
                return;
            }
            
            // Confirm the action
            const confirmMessage = `Are you sure you want to void invoice ${currentInvoice.InvoiceID}?\n\nThis action cannot be undone and will:\n- Mark the invoice as voided\n- Allow a new invoice to be created for the same art request\n- Update the art request status\n\nClick OK to proceed or Cancel to abort.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Prompt for reason
            const reason = prompt('Please provide a reason for voiding this invoice (optional):') || 'No reason provided';
            
            try {
                // Show loading state
                const voidBtn = document.getElementById('voidBtn');
                const originalText = voidBtn.innerHTML;
                voidBtn.disabled = true;
                voidBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Voiding...';
                
                // Call the void function from the service
                const result = await invoiceService.voidInvoice(currentInvoice.PK_ID, 'User', reason);
                
                if (result.success) {
                    alert(`Invoice ${currentInvoice.InvoiceID} has been successfully voided.`);
                    
                    // Redirect back to dashboard or reload to show voided status
                    window.location.href = '/art-invoices-dashboard.html';
                } else {
                    throw new Error(result.error || 'Failed to void invoice');
                }
                
            } catch (error) {
                console.error('Error voiding invoice:', error);
                alert('Failed to void invoice: ' + error.message);
                
                // Reset button
                const voidBtn = document.getElementById('voidBtn');
                voidBtn.disabled = false;
                voidBtn.innerHTML = '<i class="fas fa-ban"></i> Void Invoice';
            }
        }
    </script>
</body>
</html>