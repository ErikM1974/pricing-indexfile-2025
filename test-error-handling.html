<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Error Handling - Embroidery Quote Pricing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #4cb354;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 0;
        }
        button {
            background: #4cb354;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #409a47;
        }
        button.danger {
            background: #dc2626;
        }
        button.danger:hover {
            background: #b91c1c;
        }
        button.warning {
            background: #f59e0b;
        }
        button.warning:hover {
            background: #d97706;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üß™ Error Handling Test Suite</h1>
    
    <div class="test-section">
        <h2>API Failure Simulations</h2>
        <p>Test how the system handles different types of API failures:</p>
        
        <button onclick="testMainPricingFailure()" class="danger">
            Simulate Main Pricing Failure
        </button>
        <button onclick="testALPricingFailure()" class="warning">
            Simulate AL Pricing Failure
        </button>
        <button onclick="testPartialFailure()" class="warning">
            Simulate Partial Data Failure
        </button>
        <button onclick="clearAllWarnings()">
            Clear All Warnings
        </button>
        <button onclick="resetAndReload()">
            Reset & Reload Page
        </button>
    </div>
    
    <div class="test-section">
        <h2>Test Calculations</h2>
        <button onclick="testNormalCalculation()">
            Test Normal Calculation
        </button>
        <button onclick="testCalculationWithAL()">
            Test Calculation with Additional Logo
        </button>
        <button onclick="testCalculationAfterError()">
            Test Calculation After API Error
        </button>
    </div>
    
    <div class="test-section">
        <h2>Button State Testing</h2>
        <button type="submit" id="testSubmitBtn">Test Submit Button</button>
        <button id="testSaveBtn">Test Save Button</button>
        <button id="testQuoteBtn" class="create-quote-btn">Create Quote</button>
        <button class="btn-primary">Primary Button</button>
    </div>
    
    <div class="test-section">
        <h2>API Status</h2>
        <div id="apiStatus"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script src="/shared_components/js/embroidery-quote-pricing.js"></script>
    <script>
        let calculator;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            calculator = new EmbroideryPricingCalculator();
            await updateAPIStatus();
        });
        
        async function updateAPIStatus() {
            const statusDiv = document.getElementById('apiStatus');
            
            if (!calculator) {
                statusDiv.innerHTML = '<div class="status error">Calculator not initialized</div>';
                return;
            }
            
            const status = calculator.apiStatus || {
                isHealthy: false,
                mainPricing: false,
                alPricing: false,
                configuration: false,
                criticalFailures: ['Not initialized']
            };
            
            statusDiv.innerHTML = `
                <table style="width: 100%;">
                    <tr>
                        <th style="text-align: left;">Component</th>
                        <th style="text-align: left;">Status</th>
                    </tr>
                    <tr>
                        <td>Overall Health</td>
                        <td>${status.isHealthy ? '‚úÖ Healthy' : '‚ùå Unhealthy'}</td>
                    </tr>
                    <tr>
                        <td>Main Pricing API</td>
                        <td>${status.mainPricing ? '‚úÖ Connected' : '‚ùå Failed'}</td>
                    </tr>
                    <tr>
                        <td>AL Pricing API</td>
                        <td>${status.alPricing ? '‚úÖ Connected' : '‚ö†Ô∏è Unavailable'}</td>
                    </tr>
                    <tr>
                        <td>Configuration</td>
                        <td>${status.configuration ? '‚úÖ Loaded' : '‚ùå Missing'}</td>
                    </tr>
                </table>
                ${status.criticalFailures.length > 0 ? `
                    <div class="status error" style="margin-top: 10px;">
                        <strong>Critical Failures:</strong><br>
                        ${status.criticalFailures.join('<br>')}
                    </div>
                ` : ''}
            `;
        }
        
        function testMainPricingFailure() {
            // Simulate main pricing failure
            if (!calculator) {
                calculator = new EmbroideryPricingCalculator();
            }
            
            calculator.apiError = true;
            calculator.apiStatus.mainPricing = false;
            calculator.apiStatus.isHealthy = false;
            calculator.apiStatus.criticalFailures.push('Main pricing API connection failed (simulated)');
            
            calculator.showAPIWarning(
                'CRITICAL ERROR: Unable to load pricing configuration from server. ' +
                'The quote calculator cannot function without pricing data. ' +
                'DO NOT attempt to create quotes. ' +
                'Please contact IT support immediately.',
                'main-pricing'
            );
            
            updateAPIStatus();
            
            document.getElementById('results').innerHTML = 
                '<div class="status error">Main pricing failure simulated - check for warning banner and disabled buttons</div>';
        }
        
        function testALPricingFailure() {
            if (!calculator) {
                calculator = new EmbroideryPricingCalculator();
            }
            
            calculator.alTiers = {};
            calculator.apiStatus.alPricing = false;
            calculator.apiStatus.criticalFailures.push('AL pricing unavailable (simulated)');
            
            calculator.showAPIWarning(
                'Additional Logo pricing is unavailable. ' +
                'AL quotes cannot be calculated at this time. ' +
                'Please contact IT support immediately.',
                'al-pricing'
            );
            
            updateAPIStatus();
            
            document.getElementById('results').innerHTML = 
                '<div class="status error">AL pricing failure simulated - buttons should be conditionally disabled</div>';
        }
        
        function testPartialFailure() {
            if (!calculator) {
                calculator = new EmbroideryPricingCalculator();
            }
            
            calculator.showAPIWarning(
                'Warning: Some pricing data is unavailable. Double-check all quotes for accuracy.',
                'partial'
            );
            
            updateAPIStatus();
            
            document.getElementById('results').innerHTML = 
                '<div class="status error">Partial failure simulated - warning shown but quotes may still work</div>';
        }
        
        async function testNormalCalculation() {
            const resultsDiv = document.getElementById('results');
            
            if (!calculator) {
                resultsDiv.innerHTML = '<div class="status error">Calculator not initialized</div>';
                return;
            }
            
            const testData = {
                products: [{
                    style: 'PC54',
                    totalQuantity: 48,
                    sizes: { S: 12, M: 12, L: 12, XL: 12 }
                }],
                logos: [{
                    id: 1,
                    position: 'Left Chest',
                    stitchCount: 8000,
                    isPrimary: true
                }]
            };
            
            try {
                const result = await calculator.calculatePricing(testData.products, testData.logos);
                
                if (result.success === false) {
                    resultsDiv.innerHTML = `
                        <div class="status error">
                            <strong>Calculation Failed:</strong><br>
                            ${result.message || result.error}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="status success">
                            <strong>Calculation Successful!</strong><br>
                            Tier: ${result.tier}<br>
                            Total Quantity: ${result.totalQuantity}<br>
                            Grand Total: $${result.grandTotal.toFixed(2)}
                        </div>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function testCalculationWithAL() {
            const resultsDiv = document.getElementById('results');
            
            if (!calculator) {
                resultsDiv.innerHTML = '<div class="status error">Calculator not initialized</div>';
                return;
            }
            
            const testData = {
                products: [{
                    style: 'PC54',
                    totalQuantity: 48,
                    sizes: { S: 12, M: 12, L: 12, XL: 12 },
                    logoAssignments: {
                        additional: [{
                            logoId: 2,
                            quantity: 24
                        }]
                    }
                }],
                logos: [
                    {
                        id: 1,
                        position: 'Left Chest',
                        stitchCount: 8000,
                        isPrimary: true
                    },
                    {
                        id: 2,
                        position: 'Right Chest',
                        stitchCount: 9000,
                        isPrimary: false
                    }
                ]
            };
            
            try {
                const result = await calculator.calculatePricing(testData.products, testData.logos);
                
                if (result.success === false) {
                    resultsDiv.innerHTML = `
                        <div class="status error">
                            <strong>AL Calculation Failed:</strong><br>
                            ${result.message || result.error}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="status success">
                            <strong>AL Calculation Successful!</strong><br>
                            Additional Services: ${result.additionalServices.length}<br>
                            Grand Total: $${result.grandTotal.toFixed(2)}
                        </div>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function testCalculationAfterError() {
            // First simulate an error
            testMainPricingFailure();
            
            // Wait a bit for the error to be set
            setTimeout(() => {
                testNormalCalculation();
            }, 100);
        }
        
        function clearAllWarnings() {
            const warnings = document.querySelectorAll('#pricing-api-warning, .api-warning-banner');
            warnings.forEach(w => w.remove());
            
            // Re-enable buttons
            const buttons = document.querySelectorAll('button[disabled]');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.title = '';
                if (btn.dataset.originalText) {
                    btn.textContent = btn.dataset.originalText;
                    delete btn.dataset.originalText;
                }
            });
            
            document.getElementById('results').innerHTML = 
                '<div class="status success">All warnings cleared and buttons re-enabled</div>';
        }
        
        function resetAndReload() {
            sessionStorage.clear();
            location.reload();
        }
    </script>
</body>
</html>