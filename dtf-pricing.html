<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTF Transfer Pricing | NWCA</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Existing styles -->
    <link rel="stylesheet" href="/shared_components/css/shared-pricing-styles.css">
    <link rel="stylesheet" href="/shared_components/css/modern-enhancements.css">
    <link rel="stylesheet" href="/shared_components/css/quote-system.css">
    <link rel="stylesheet" href="/shared_components/css/universal-header.css">
    <link rel="stylesheet" href="/shared_components/css/universal-product-display.css">
    <link rel="stylesheet" href="/shared_components/css/universal-image-gallery.css">
    
    <!-- DTF Calculator CSS -->
    <link rel="stylesheet" href="/shared_components/css/dtf-calculator.css">
    
    <!-- jsPDF Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Page layout styles */
        .product-page-columns-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-context-column {
            flex: 0 0 350px;
            min-width: 0;
        }
        
        .product-interactive-column {
            flex: 1;
            min-width: 0;
        }
        
        /* Hide old calculator sections */
        #add-to-cart-section {
            display: none;
        }
        
        /* Page header styles */
        .page-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .page-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        @media (max-width: 992px) {
            .product-page-columns-container {
                flex-direction: column;
            }
            
            .product-context-column {
                flex: 1;
                max-width: 100%;
            }
            
            .page-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Universal Header -->
    <universal-header></universal-header>
    
    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <h1>DTF Transfer Pricing Calculator</h1>
            <p>Calculate pricing for Direct-to-Film transfers with multiple locations</p>
        </div>
    </div>
    
    <!-- Main Content Container -->
    <div class="container">
        <div class="product-page-columns-container">
            <!-- Left Column: Product Context -->
            <div class="product-context-column">
                <!-- Universal Product Display Component will render here -->
                <div id="product-display"></div>
            </div>

            <!-- Right Column: DTF Calculator -->
            <div class="product-interactive-column">
                <!-- DTF Calculator Container -->
                <div id="dtf-calculator-container">
                    <div class="dtf-calculator-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading calculator...</span>
                    </div>
                </div>
                
                <!-- Quote System Integration (hidden but available for future use) -->
                <div id="add-to-cart-section" style="display: none;">
                    <!-- Quote system placeholder -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Existing JavaScript Files -->
    <script src="/shared_components/js/app-config.js"></script>
    <script src="/shared_components/js/utils.js"></script>
    <script src="/shared_components/js/pricing-pages.js"></script>
    <script src="/shared_components/js/pricing-matrix-capture.js"></script>
    <script src="/shared_components/js/pricing-matrix-api.js"></script>
    <script src="/shared_components/js/dp5-helper.js"></script>
    <script src="/product-url-handler.js"></script>
    
    <!-- DTF Calculator V2 Scripts -->
    <script src="/shared_components/js/dtf-config.js"></script>
    <script src="/shared_components/js/dtf-pricing-calculator.js"></script>
    <script src="/shared_components/js/dtf-adapter.js"></script>
    <script src="/shared_components/js/dtf-integration.js"></script>
    
    <!-- Universal Components -->
    <script src="/shared_components/js/universal-header-component.js"></script>
    <script src="/shared_components/js/universal-product-display.js"></script>
    <script src="/shared_components/js/universal-image-gallery.js"></script>
    
    <!-- DTF Page Initialization -->
    <script>
        // Initialize DTF page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DTF] Page initialized with V2 calculator');
            
            // Initialize product context from URL parameters
            if (window.initializeProductFromURL) {
                window.initializeProductFromURL();
            }
            
            // Initialize Universal Product Display
            let productDisplay = new UniversalProductDisplay({
                containerId: 'product-display',
                pageType: 'dtf',
                showBackButton: true,
                showInfoBox: true,
                showSelectedColor: true,
                sticky: false,
                infoBoxContent: 'DTF Transfer Printing: Vibrant, full-color designs with excellent durability and stretch. Perfect for both light and dark garments.'
            });
            
            // Store reference globally for debugging
            window.productDisplay = productDisplay;
            
            // Handle calculator ready state
            setTimeout(function() {
                const loadingDiv = document.querySelector('.dtf-calculator-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }, 100);
            
            // Listen for product data updates
            window.addEventListener('productDataUpdated', function(event) {
                console.log('[DTF] Product data updated:', event.detail);
                
                // Extract pricing data
                const productData = event.detail;
                const pricingData = {
                    garmentCost: productData.price || productData.basePrice || productData.garmentPrice || 0,
                    quantity: productData.quantity || 24,
                    productInfo: {
                        name: productData.name || productData.productName || productData.title,
                        sku: productData.sku || productData.styleNumber,
                        image: productData.imageUrl || productData.image
                    }
                };
                
                // Update DTF calculator via adapter
                if (window.DTFAdapter) {
                    window.DTFAdapter.updateData(pricingData);
                }
            });
            
            // Listen for pricing data loaded event (from DTG/pricing system)
            window.addEventListener('pricingDataLoaded', async function(event) {
                console.log('[DTF] Pricing data loaded:', event.detail);
                
                // Check if this is fallback pricing data
                if (event.detail && event.detail.isFallback) {
                    console.log('[DTF] Detected fallback pricing - fetching real garment costs from API');
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const styleNumber = event.detail.styleNumber || urlParams.get('StyleNumber');
                    if (styleNumber && window.DTFAdapter) {
                        const realCost = await window.DTFAdapter.fetchAndSetGarmentCost(styleNumber);
                        if (realCost !== null) {
                            console.log('[DTF] Successfully fetched real garment cost:', realCost);
                            return; // Exit early, we've set the real cost
                        }
                    }
                }
                
                if (event.detail && event.detail.prices) {
                    // Extract base garment price from first tier, first size group
                    // For DTF, we need the garment-only price (0 colors/locations)
                    let garmentPrice = 0;
                    
                    // Try to get price from first size group and first tier
                    const sizeGroups = Object.keys(event.detail.prices);
                    if (sizeGroups.length > 0) {
                        const firstSizeGroup = sizeGroups[0];
                        const tierPrices = event.detail.prices[firstSizeGroup];
                        const firstTier = Object.keys(tierPrices)[0];
                        if (firstTier && tierPrices[firstTier]) {
                            garmentPrice = tierPrices[firstTier];
                        }
                    }
                    
                    const pricingData = {
                        garmentCost: garmentPrice,
                        quantity: 24, // Default quantity
                        productInfo: {
                            name: event.detail.productTitle,
                            sku: event.detail.styleNumber,
                            color: event.detail.color
                        }
                    };
                    
                    if (window.DTFAdapter) {
                        window.DTFAdapter.updateData(pricingData);
                    }
                }
            });
            
            // Listen for pricing matrix API events
            window.addEventListener('pricingMatrixDataAvailable', function(event) {
                console.log('[DTF] Pricing matrix data available:', event.detail);
                
                // Try to get garment price from the pricing matrix
                if (event.detail && event.detail.data) {
                    // Look for the base garment price (usually first row or "0" colors)
                    let garmentPrice = 0;
                    
                    // Check if data has a structure like DTG or screen print
                    if (event.detail.data.primaryLocationPricing && event.detail.data.primaryLocationPricing["0"]) {
                        // Screen print style data structure
                        const zeroColorPricing = event.detail.data.primaryLocationPricing["0"];
                        if (zeroColorPricing.tiers && zeroColorPricing.tiers.length > 0) {
                            const firstTier = zeroColorPricing.tiers[0];
                            const sizes = Object.keys(firstTier.prices || {});
                            if (sizes.length > 0) {
                                garmentPrice = firstTier.prices[sizes[0]];
                            }
                        }
                    } else if (event.detail.data.rows) {
                        // Table-based structure
                        const rows = event.detail.data.rows;
                        if (rows.length > 0 && rows[0].cells && rows[0].cells.length > 1) {
                            // Try to parse the first price cell
                            const priceText = rows[0].cells[1];
                            const price = parseFloat(priceText.replace(/[$,]/g, ''));
                            if (!isNaN(price)) {
                                garmentPrice = price;
                            }
                        }
                    }
                    
                    if (garmentPrice > 0) {
                        const pricingData = {
                            garmentCost: garmentPrice,
                            quantity: 24,
                            productInfo: {
                                name: event.detail.productTitle || window.selectedColorName,
                                sku: event.detail.styleNumber || urlParams.get('StyleNumber')
                            }
                        };
                        
                        console.log('[DTF] Sending garment price from matrix:', pricingData);
                        if (window.DTFAdapter) {
                            window.DTFAdapter.updateData(pricingData);
                        }
                    }
                }
            });
            
            // Also listen for pricing matrix data (legacy support)
            window.addEventListener('pricingMatrixDataReceived', function(event) {
                console.log('[DTF] Pricing matrix data received:', event.detail);
                
                if (event.detail && event.detail.price) {
                    const pricingData = {
                        garmentCost: event.detail.price,
                        quantity: event.detail.quantity || 24
                    };
                    
                    if (window.DTFAdapter) {
                        window.DTFAdapter.updateData(pricingData);
                    }
                }
            });
            
            // Check for initial URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const initialData = {};
            let hasData = false;
            
            // Map common parameter names
            const garmentCost = urlParams.get('price') || urlParams.get('garmentCost') || urlParams.get('cost');
            const quantity = urlParams.get('quantity') || urlParams.get('qty');
            const productName = urlParams.get('productName') || urlParams.get('name');
            const sku = urlParams.get('sku');
            
            if (garmentCost) {
                initialData.garmentCost = parseFloat(garmentCost);
                hasData = true;
            }
            
            if (quantity) {
                initialData.quantity = parseInt(quantity);
                hasData = true;
            }
            
            if (productName || sku) {
                initialData.productInfo = {
                    name: productName,
                    sku: sku
                };
                hasData = true;
            }
            
            // Send initial data if available
            if (hasData && window.DTFAdapter) {
                console.log('[DTF] Sending initial URL data:', initialData);
                window.DTFAdapter.updateData(initialData);
            }
            
            // Dispatch event to signal DTF page is ready
            window.dispatchEvent(new CustomEvent('dtfPageReady', {
                detail: {
                    embellishmentType: 'dtf',
                    calculatorVersion: 'v2',
                    useQuoteSystem: false
                }
            }));
            
            // Try to fetch pricing data if not received after a delay
            setTimeout(function() {
                if (!window.DTFAdapter || !window.DTFAdapter.getData || window.DTFAdapter.getData().garmentCost === 0) {
                    console.log('[DTF] No pricing data received, attempting to fetch...');
                    
                    // Try to trigger pricing data load
                    if (window.PricingMatrixAPI && window.PricingMatrixAPI.fetchPricingData) {
                        const styleNumber = urlParams.get('StyleNumber');
                        const color = urlParams.get('COLOR') || urlParams.get('color');
                        
                        if (styleNumber) {
                            console.log('[DTF] Requesting pricing data for:', styleNumber, color);
                            window.PricingMatrixAPI.fetchPricingData(styleNumber, 'dtf', color);
                        }
                    }
                    
                    // Also try to get data from the pricing matrix if it exists
                    if (window.PricingMatrix && window.PricingMatrix.data) {
                        console.log('[DTF] Found existing pricing matrix data:', window.PricingMatrix.data);
                        // Dispatch event with the data
                        window.dispatchEvent(new CustomEvent('pricingMatrixDataAvailable', {
                            detail: {
                                data: window.PricingMatrix.data,
                                styleNumber: urlParams.get('StyleNumber')
                            }
                        }));
                    }
                }
            }, 2000); // Wait 2 seconds for normal data flow
        });
        
        // Handle messages from parent window (iframe scenarios)
        window.addEventListener('message', function(event) {
            // Ignore React DevTools messages
            if (event.data && event.data.source === 'react-devtools-content-script') {
                return;
            }
            
            console.log('[DTF] Received postMessage:', event.data);
            
            // Handle DTF-specific pricing data
            if (event.data && event.data.type === 'dtfPricingData') {
                console.log('[DTF] Received DTF pricing data:', event.data);
                if (window.DTFAdapter) {
                    window.DTFAdapter.updateData(event.data.data);
                }
            }
            
            // Handle Caspio pricing data
            if (event.data && (event.data.type === 'caspioPricingData' || event.data.type === 'caspioDataReady')) {
                console.log('[DTF] Received Caspio pricing data:', event.data);
                const pricingData = {
                    garmentCost: event.data.price || event.data.garmentPrice || event.data.basePrice || 0,
                    quantity: event.data.quantity || 24,
                    productInfo: {
                        name: event.data.productName || event.data.name,
                        sku: event.data.sku || event.data.styleNumber
                    }
                };
                
                if (window.DTFAdapter && pricingData.garmentCost > 0) {
                    window.DTFAdapter.updateData(pricingData);
                }
            }
        });
    </script>
</body>
</html>