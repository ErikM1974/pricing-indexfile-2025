<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Cart - Northwest Custom Apparel</title>
    <link rel="icon" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- EmailJS for sample request notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Sample Order Service for ShopWorks Integration -->
    <script src="../shared_components/js/sample-order-service.js"></script>

    <style>
        :root {
            --primary-color: #4cb354;
            --primary-dark: #409a47;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 2px solid var(--primary-color);
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .company-logo {
            height: 50px;
        }

        .contact-info {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .contact-info a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .contact-info a:hover {
            color: var(--primary-color);
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .cart-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 100px 1fr auto;
            gap: 1.5rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .item-details h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .item-details .item-style {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .item-details .item-color {
            display: inline-block;
            background: var(--bg-color);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .item-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .size-badge {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .item-remove {
            color: #ef4444;
            cursor: pointer;
            font-size: 1.25rem;
            transition: opacity 0.2s;
        }

        .item-remove:hover {
            opacity: 0.7;
        }

        .empty-cart {
            text-align: center;
            padding: 3rem 0;
            color: var(--text-secondary);
        }

        .empty-cart i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .form-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }

        .form-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group label .required {
            color: #ef4444;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .success-message {
            background: white;
            border-radius: 12px;
            padding: 3rem;
            box-shadow: var(--shadow-md);
            text-align: center;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .success-message i {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .success-message h2 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .success-message p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* File Input Styling */
        .form-group input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .form-group input[type="file"]:hover {
            border-color: var(--primary-color);
            background: white;
        }

        .form-group input[type="file"]:focus {
            outline: none;
            border-color: var(--primary-color);
            border-style: solid;
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }

            .contact-info {
                flex-direction: column;
                gap: 0.5rem;
            }

            .cart-item {
                grid-template-columns: 80px 1fr;
                gap: 1rem;
            }

            .item-remove {
                grid-column: 2;
                text-align: right;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* ==============================================
           BILLING/SHIPPING ADDRESS STYLING
           ============================================== */

        /* Same as billing checkbox container */
        .same-as-billing-container {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            cursor: pointer;
            font-size: 1rem;
            margin: 0;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin: 0;
        }

        .checkbox-label span {
            user-select: none;
        }

        /* Smooth transition for shipping section */
        .shipping-address-section {
            transition: opacity 0.3s ease, max-height 0.3s ease;
            overflow: hidden;
        }

        .shipping-address-section[style*="display: none"] {
            opacity: 0;
            max-height: 0;
        }

        /* Section headers styling */
        .form-section h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary, #333);
        }

        .form-section h2 i {
            color: var(--primary-color, #2d5f3f);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/top-sellers-showcase.html">
                <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" alt="Northwest Custom Apparel" class="company-logo">
            </a>
            <div class="contact-info">
                <a href="tel:253-922-5793">
                    <i class="fas fa-phone"></i>
                    253-922-5793
                </a>
                <a href="mailto:sales@nwcustomapparel.com">
                    <i class="fas fa-envelope"></i>
                    sales@nwcustomapparel.com
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Cart Section -->
        <div id="cartContainer">
            <h1 class="page-title">Your Sample Cart</h1>
            <p class="page-subtitle">Review your selected samples and complete the form below to submit your request.</p>

            <div class="cart-section">
                <div id="cartItems">
                    <!-- Cart items will be populated here -->
                </div>
            </div>

            <!-- Contact Form -->
            <div class="form-section" id="contactForm">
                <h2><i class="fas fa-user"></i> Contact Information</h2>
                <form id="sampleRequestForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>
                                First Name <span class="required">*</span>
                            </label>
                            <input type="text" name="firstName" required>
                        </div>

                        <div class="form-group">
                            <label>
                                Last Name <span class="required">*</span>
                            </label>
                            <input type="text" name="lastName" required>
                        </div>

                        <div class="form-group">
                            <label>
                                Email <span class="required">*</span>
                            </label>
                            <input type="email" name="email" required>
                        </div>

                        <div class="form-group">
                            <label>
                                Phone <span class="required">*</span>
                            </label>
                            <input type="tel" name="phone" required>
                        </div>

                        <div class="form-group">
                            <label>
                                Company
                            </label>
                            <input type="text" name="company">
                        </div>

                        <div class="form-group">
                            <label>
                                Sales Representative
                            </label>
                            <select name="salesRep" id="salesRep">
                                <option value="House" selected>House (No Specific Rep)</option>
                                <option value="Nika Lao">Nika Lao</option>
                                <option value="Taneisha Clark">Taneisha Clark</option>
                                <option value="Ruth Nhong">Ruth Nhong</option>
                                <option value="Erik Mickelson">Erik Mickelson</option>
                            </select>
                        </div>

                        <!-- BILLING ADDRESS SECTION -->
                        <h2 style="margin-top: 2rem;"><i class="fas fa-credit-card"></i> Billing Address</h2>

                        <div class="form-group">
                            <label>
                                Street Address <span class="required">*</span>
                            </label>
                            <input type="text" name="billing_address1" id="billing-address1" required placeholder="123 Main St">
                        </div>

                        <div class="form-group">
                            <label>
                                Apt/Suite
                            </label>
                            <input type="text" name="billing_address2" id="billing-address2" placeholder="Apt 4B">
                        </div>

                        <div class="form-group">
                            <label>
                                City <span class="required">*</span>
                            </label>
                            <input type="text" name="billing_city" id="billing-city" required>
                        </div>

                        <div class="form-group">
                            <label>
                                State <span class="required">*</span>
                            </label>
                            <input type="text" name="billing_state" id="billing-state" required placeholder="WA" maxlength="2" pattern="[A-Z]{2}" style="text-transform: uppercase;">
                        </div>

                        <div class="form-group">
                            <label>
                                ZIP Code <span class="required">*</span>
                            </label>
                            <input type="text" name="billing_zip" id="billing-zip" required placeholder="98101" pattern="\d{5}" maxlength="5">
                        </div>

                        <!-- SAME AS BILLING CHECKBOX -->
                        <div class="form-group full-width same-as-billing-container">
                            <label class="checkbox-label">
                                <input type="checkbox" id="same-as-billing" checked>
                                <span>Ship to the same address</span>
                            </label>
                        </div>

                        <!-- SHIPPING ADDRESS SECTION (hidden by default) -->
                        <div id="shipping-section" class="shipping-address-section" style="display: none;">
                            <h2><i class="fas fa-shipping-fast"></i> Shipping Address</h2>

                            <div class="form-group">
                                <label>
                                    Street Address
                                </label>
                                <input type="text" name="shipping_address1" id="shipping-address1" placeholder="123 Main St">
                            </div>

                            <div class="form-group">
                                <label>
                                    Apt/Suite
                                </label>
                                <input type="text" name="shipping_address2" id="shipping-address2" placeholder="Apt 4B">
                            </div>

                            <div class="form-group">
                                <label>
                                    City
                                </label>
                                <input type="text" name="shipping_city" id="shipping-city">
                            </div>

                            <div class="form-group">
                                <label>
                                    State
                                </label>
                                <input type="text" name="shipping_state" id="shipping-state" placeholder="WA" maxlength="2" pattern="[A-Z]{2}" style="text-transform: uppercase;">
                            </div>

                            <div class="form-group">
                                <label>
                                    ZIP Code
                                </label>
                                <input type="text" name="shipping_zip" id="shipping-zip" placeholder="98101" pattern="\d{5}" maxlength="5">
                            </div>
                        </div>

                        <!-- Shipping Method: Hidden field defaulting to UPS Ground -->
                        <input type="hidden" name="shippingMethod" value="UPS Ground">
                        <div class="form-group full-width">
                            <label>
                                Additional Notes
                            </label>
                            <textarea name="notes" placeholder="Any specific requirements or questions..."></textarea>
                        </div>

                        <!-- Logo Upload Section -->
                        <div class="form-group full-width">
                            <label>
                                Upload Logo/Artwork
                                <span style="color: var(--text-secondary); font-weight: normal;">(Optional - AI, PDF, PNG, JPG)</span>
                            </label>
                            <input
                                type="file"
                                id="logoUpload"
                                name="logoUpload"
                                accept=".ai,.pdf,.png,.jpg,.jpeg,.eps,.psd,.svg"
                                style="padding: 0.5rem;">
                            <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary);">
                                Upload your company logo or artwork design (if available)
                            </small>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            Submit Sample Request
                        </button>
                        <a href="/top-sellers-showcase.html" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            Continue Shopping
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <i class="fas fa-check-circle"></i>
            <h2>Sample Request Submitted!</h2>
            <p>Thank you for your request. We'll process your samples and be in touch shortly.</p>
            <p><strong>Confirmation ID:</strong> <span id="confirmationId"></span></p>
            <div class="button-group" style="justify-content: center;">
                <a href="/top-sellers-showcase.html" class="btn btn-primary">
                    <i class="fas fa-home"></i>
                    Back to Top Sellers
                </a>
            </div>
        </div>
    </div>

    <script>
        // Initialize EmailJS
        emailjs.init('4qSbDO-SQs19TbP80');

        // Initialize Sample Order Service
        const sampleOrderService = new SampleOrderService();
        window.sampleOrderService = sampleOrderService;
        console.log('[Sample Cart] Service initialized');

        // ==============================================
        // SIZE SORTING UTILITY
        // ==============================================

        /**
         * Sort sizes in natural order: Youth ‚Üí Standard ‚Üí Tall ‚Üí Oversized
         * @param {Object} sizes - Object with size as key and quantity as value
         * @returns {Array} - Sorted array of size keys
         */
        function sortSizesByOrder(sizes) {
            const order = [
                'YXS', 'YS', 'YM', 'YL', 'YXL',          // Youth
                'XS', 'S', 'M', 'L', 'XL',                // Standard
                'MT', 'LT', 'XLT',                        // Tall (medium/large/XL)
                '2XL', '2XLT',                            // 2X and 2X Tall
                '3XL', '3XLT',                            // 3X and 3X Tall
                '4XL', '5XL', '6XL',                      // Extra oversized
                'OSFA'                                    // One size
            ];

            return Object.keys(sizes)
                .filter(size => sizes[size] > 0)
                .sort((a, b) => {
                    const indexA = order.indexOf(a);
                    const indexB = order.indexOf(b);
                    if (indexA === -1) return 1;         // Unknown sizes go to end
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
        }

        // ==============================================
        // DEBUG UTILITIES - Sample Cart & Checkout
        // ==============================================
        window.CART_DEBUG = {
            enabled: true,

            // Log cart load from sessionStorage
            logCartLoad: function(cart) {
                if (!this.enabled) return;
                console.group('üì• [Cart Load] From SessionStorage');
                console.log('Items Count:', cart.length);
                console.table(cart.map((item, i) => ({
                    Index: i,
                    Style: item.style,
                    Name: item.name,
                    Color: item.color,
                    Sizes: Object.entries(item.sizes).map(([s,q]) => `${s}:${q}`).join(', '),
                    Type: item.sampleType || 'free'
                })));
                console.groupEnd();
            },

            // Log form data before submission
            logFormSubmission: function(customerData, samplesForService) {
                if (!this.enabled) return;
                console.group('üì§ [Form Submit] Order Data');
                console.log('Customer Data:', JSON.stringify(customerData, null, 2));
                console.log('Samples for Service:', JSON.stringify(samplesForService, null, 2));
                console.log('Total Items:', samplesForService.length);
                console.groupEnd();
            },

            // Log API request
            logAPIRequest: function(endpoint, payload) {
                if (!this.enabled) return;
                console.group('üåê [API Request] ManageOrders PUSH');
                console.log('Endpoint:', endpoint);
                console.log('Payload:', JSON.stringify(payload, null, 2));
                console.log('Timestamp:', new Date().toISOString());
                console.groupEnd();
            },

            // Log API response
            logAPIResponse: function(response, data) {
                if (!this.enabled) return;
                console.group('‚úÖ [API Response] ManageOrders');
                console.log('Status:', response.status, response.statusText);
                console.log('Data:', JSON.stringify(data, null, 2));
                console.groupEnd();
            }
        };

        // Helper function to safely read cart from storage
        function getCartSamples() {
            try {
                const stored = sessionStorage.getItem('sampleCart');
                if (!stored) return [];

                const parsed = JSON.parse(stored);

                // Handle both old (array) and new (nested) formats
                if (Array.isArray(parsed)) {
                    return parsed; // Old format
                } else if (parsed && parsed.samples && Array.isArray(parsed.samples)) {
                    return parsed.samples; // New format
                } else {
                    console.warn('[Cart] Unrecognized cart format');
                    return [];
                }
            } catch (e) {
                console.error('[Cart] Error parsing cart:', e);
                return [];
            }
        }

        // Migrate old cart items to include upcharges (backward compatibility)
        async function migrateCartUpcharges(cart) {
            if (!cart || cart.length === 0) return cart;

            console.group('üîÑ [Cart Migration] Checking for missing upcharges');

            let updated = false;
            const apiBase = 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com';

            for (let i = 0; i < cart.length; i++) {
                const item = cart[i];

                // Check if upcharges field is missing
                if (!item.upcharges || Object.keys(item.upcharges).length === 0) {
                    console.log(`üì¶ [Migration] Fetching upcharges for ${item.style} (missing upcharges field)`);

                    try {
                        const response = await fetch(`${apiBase}/api/pricing-bundle?method=BLANK&styleNumber=${item.style}`);

                        if (response.ok) {
                            const data = await response.json();
                            const upcharges = data.sellingPriceDisplayAddOns || {};

                            // Add upcharges to item
                            cart[i].upcharges = upcharges;
                            updated = true;

                            console.log(`‚úÖ [Migration] Added upcharges for ${item.style}:`, upcharges);
                        } else {
                            console.warn(`‚ö†Ô∏è [Migration] API failed for ${item.style}:`, response.status);
                            // Add empty upcharges object to prevent repeated attempts
                            cart[i].upcharges = {};
                        }
                    } catch (error) {
                        console.error(`‚ùå [Migration] Error fetching upcharges for ${item.style}:`, error);
                        // Add empty upcharges object to prevent repeated attempts
                        cart[i].upcharges = {};
                    }
                } else {
                    console.log(`‚úì [Migration] ${item.style} already has upcharges, skipping`);
                }
            }

            console.log(`üìä [Migration] Summary: ${updated ? 'Cart updated' : 'No updates needed'}`);
            console.groupEnd();

            // If we updated any items, save the migrated cart back to sessionStorage
            if (updated) {
                const cartData = {
                    samples: cart,
                    timestamp: new Date().toISOString()
                };
                sessionStorage.setItem('sampleCart', JSON.stringify(cartData));
                console.log('üíæ [Migration] Saved migrated cart to sessionStorage');
            }

            return cart;
        }

        // Load and display cart items
        async function loadCart() {
            let cart = getCartSamples();

            // Migrate old cart items to include upcharges (backward compatibility)
            cart = await migrateCartUpcharges(cart);

            // DEBUG: Log cart load
            if (window.CART_DEBUG) {
                window.CART_DEBUG.logCartLoad(cart);
            }

            const container = document.getElementById('cartItems');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Your sample cart is empty</h3>
                        <p>Add some samples from our Top Sellers page!</p>
                        <a href="/top-sellers-showcase.html" class="btn btn-primary" style="margin-top: 1rem;">
                            Browse Products
                        </a>
                    </div>
                `;
                // Hide contact form
                document.getElementById('contactForm').style.display = 'none';
                return;
            }

            // Display cart items
            container.innerHTML = cart.map((item, index) => {
                // Get upcharges for this product (from API when added to cart)
                const upcharges = item.upcharges || {};
                const basePrice = parseFloat(item.price) || 0;

                // Sort sizes in natural order
                const sortedSizes = sortSizesByOrder(item.sizes);

                // Calculate total with size-specific pricing
                let itemTotal = 0;
                const sizesDisplay = sortedSizes
                    .map(size => {
                        const qty = item.sizes[size];
                        const upcharge = upcharges[size] || 0;
                        const sizePrice = basePrice + upcharge;
                        itemTotal += qty * sizePrice;
                        return `<span class="size-badge">${size} (${qty})</span>`;
                    })
                    .join('');

                const totalQty = Object.values(item.sizes).reduce((sum, qty) => sum + qty, 0);

                return `
                    <div class="cart-item" data-index="${index}">
                        <img src="${item.imageUrl || 'https://via.placeholder.com/100'}" alt="${item.name}" class="item-image">
                        <div class="item-details">
                            <h3>${item.name}</h3>
                            <div class="item-style">Style: ${item.style}</div>
                            <div class="item-color">Color: ${item.color}</div>
                            <div class="item-sizes">Sizes: ${sizesDisplay}</div>
                            <div class="item-price" style="margin-top: 0.5rem; font-weight: 600; color: var(--primary-color);">
                                ${totalQty} ${totalQty === 1 ? 'item' : 'items'} = $${itemTotal.toFixed(2)}
                            </div>
                        </div>
                        <div class="item-remove" onclick="removeItem(${index})">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Remove item from cart
        function removeItem(index) {
            const cart = getCartSamples();
            cart.splice(index, 1);

            // Save with nested structure
            const cartData = {
                samples: cart,
                timestamp: new Date().toISOString()
            };
            sessionStorage.setItem('sampleCart', JSON.stringify(cartData));
            loadCart();
        }

        // ==============================================
        // BILLING/SHIPPING ADDRESS MANAGEMENT
        // ==============================================

        // Copy billing address to shipping address
        function copyBillingToShipping() {
            const fields = ['address1', 'address2', 'city', 'state', 'zip'];
            fields.forEach(field => {
                const billingValue = document.getElementById(`billing-${field}`).value;
                document.getElementById(`shipping-${field}`).value = billingValue;
            });
            console.log('[Address] Copied billing to shipping');
        }

        // Toggle shipping section visibility
        document.getElementById('same-as-billing').addEventListener('change', function() {
            const shippingSection = document.getElementById('shipping-section');

            if (this.checked) {
                // Hide shipping section and copy billing data
                shippingSection.style.display = 'none';
                copyBillingToShipping();
                console.log('[Address] Shipping address hidden (same as billing)');
            } else {
                // Show shipping section
                shippingSection.style.display = 'block';
                console.log('[Address] Shipping address shown (different from billing)');
            }
        });

        // Auto-copy billing to shipping as user types (if checkbox is checked)
        ['address1', 'address2', 'city', 'state', 'zip'].forEach(field => {
            document.getElementById(`billing-${field}`).addEventListener('blur', function() {
                if (document.getElementById('same-as-billing').checked) {
                    copyBillingToShipping();
                }
            });
        });

        // Helper function to convert file to base64
        async function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => {
                    console.error('[Sample Cart] File read error:', error);
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }

        // Handle form submission
        document.getElementById('sampleRequestForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Ensure shipping fields are populated before submission
            const sameAsBilling = document.getElementById('same-as-billing').checked;
            if (sameAsBilling) {
                copyBillingToShipping();
            }

            const formData = new FormData(e.target);
            const cart = getCartSamples();
            // Get customer data from form (no splitting needed - separate fields now)
            const firstName = formData.get('firstName').trim();
            const lastName = formData.get('lastName').trim();

            // Prepare customer data for ShopWorks (with separate billing & shipping)
            const customerData = {
                firstName: firstName,
                lastName: lastName,
                email: formData.get('email'),
                phone: formData.get('phone'),
                company: formData.get('company') || '',
                salesRep: formData.get('salesRep') || 'House',

                // Billing address
                billing_address1: formData.get('billing_address1'),
                billing_address2: formData.get('billing_address2') || '',
                billing_city: formData.get('billing_city'),
                billing_state: formData.get('billing_state').toUpperCase(),
                billing_zip: formData.get('billing_zip'),

                // Shipping address
                shipping_address1: formData.get('shipping_address1'),
                shipping_address2: formData.get('shipping_address2') || '',
                shipping_city: formData.get('shipping_city'),
                shipping_state: formData.get('shipping_state').toUpperCase(),
                shipping_zip: formData.get('shipping_zip'),

                shippingMethod: formData.get('shippingMethod') || 'UPS Ground',
                notes: formData.get('notes') || ''
            };

            // Pass samples with sizes object intact (service will expand into line items)
            const samplesForService = cart.map(item => ({
                style: item.style,
                name: item.name,
                color: item.color,
                catalogColor: item.catalogColor,
                sizes: item.sizes,  // Keep as object {S: 1, M: 2, L: 1} or {OSFA: 1}
                price: item.price || 0,  // Use 0 not 0.01 for consistency
                type: item.sampleType || 'free',
                upcharges: item.upcharges || {}  // Size-specific upcharges from API
            }));

            console.log('[Sample Cart] Submitting order with:', {
                customer: customerData,
                sampleCount: samplesForService.length
            });

            // DEBUG: Log form submission
            if (window.CART_DEBUG) {
                window.CART_DEBUG.logFormSubmission(customerData, samplesForService);
            }

            // Disable submit button
            const submitBtn = e.target.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            try {
                let shopWorksOrderNumber = null;

                // Handle logo file upload (if provided)
                let logoFile = null;
                const logoInput = document.getElementById('logoUpload');
                if (logoInput.files && logoInput.files[0]) {
                    const file = logoInput.files[0];
                    console.log('[Sample Cart] Processing logo file:', file.name, file.type, file.size);

                    try {
                        const base64Data = await convertFileToBase64(file);
                        logoFile = {
                            fileName: file.name,
                            fileData: base64Data,
                            category: 'reference',  // CHANGED: Sample orders ship BLANK (no decoration)
                            description: 'Customer reference logo (samples ship BLANK)'
                        };
                        console.log('[Sample Cart] ‚úÖ Logo file converted to base64 (reference only)');
                    } catch (error) {
                        console.error('[Sample Cart] ‚ùå Failed to convert logo file:', error);
                        // Continue without logo - don't block order submission
                    }
                }

                // Send to ShopWorks
                if (window.sampleOrderService) {
                    const result = await window.sampleOrderService.submitSampleOrder(
                        customerData,
                        samplesForService,
                        logoFile
                    );

                    if (!result.success) {
                        throw new Error(`ShopWorks submission failed: ${result.error || result.message}`);
                    }

                    shopWorksOrderNumber = result.orderNumber;
                    console.log('[Sample Cart] ‚úÖ Order created in ShopWorks:', shopWorksOrderNumber);
                }

                // Send email notification (using simple template for now)
                const emailData = {
                    to_name: 'Northwest Custom Apparel',
                    from_name: `${firstName} ${lastName}`,
                    from_email: customerData.email,
                    from_phone: customerData.phone,
                    from_company: customerData.company,
                    message: customerData.notes,
                    order_number: shopWorksOrderNumber || 'PENDING',
                    samples: cart.map(item => {
                        const sizes = Object.entries(item.sizes)
                            .filter(([s, q]) => q > 0)
                            .map(([s, q]) => `${s} (${q})`)
                            .join(', ');
                        return `${item.name} (${item.style}) - ${item.color} - Sizes: ${sizes}`;
                    }).join('\n')
                };

                // Try to send email (don't fail if this errors)
                try {
                    await emailjs.send('service_1c4k67j', 'template_sample_request', emailData);
                    console.log('[Sample Cart] ‚úÖ Email notification sent');
                } catch (emailError) {
                    console.warn('[Sample Cart] ‚ö†Ô∏è Email failed but order was created:', emailError);
                }

                // Clear cart
                sessionStorage.removeItem('sampleCart');

                // Show success message
                document.getElementById('cartContainer').style.display = 'none';
                document.getElementById('confirmationId').textContent = shopWorksOrderNumber || 'SR-' + Date.now().toString().slice(-6);
                document.getElementById('successMessage').classList.add('show');

            } catch (error) {
                console.error('[Sample Cart] ‚ùå Error submitting order:', error);
                alert('There was an error submitting your order. Please try again or call us at 253-922-5793.\n\nError: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Sample Request';
            }
        });

        // Load cart on page load
        loadCart();
    </script>
</body>
</html>
