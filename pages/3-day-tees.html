<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Fast 3-Day Turnaround Service - Custom DTG printed t-shirts with guaranteed 72-hour delivery">
    <meta name="robots" content="index, follow">

    <title>3-Day Tees - Fast Turnaround Service | Northwest Custom Apparel</title>
    <link rel="icon" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Stripe.js SDK -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Shared Components -->
    <script src="../shared_components/js/dtg-pricing-service.js"></script>
    <script src="../shared_components/js/sample-inventory-service.js"></script>
    <script src="../shared_components/js/three-day-tees-order-service.js"></script>

    <style>
        :root {
            --primary-color: #ff6b35;
            --primary-dark: #e55a2b;
            --primary-light: #ff7d4f;
            --accent-color: #004e89;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 3px solid var(--primary-color);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            height: 50px;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .logo-text .service-name {
            font-size: 0.875rem;
            color: var(--primary-color);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .contact-cta {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .contact-cta .phone {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Hero Banner */
        .hero-banner {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            border-radius: 12px;
            margin: 2rem auto;
            max-width: 1200px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .hero-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.03) 10px,
                rgba(255, 255, 255, 0.03) 20px
            );
            pointer-events: none;
        }

        .hero-banner h2 {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .hero-banner .subtitle {
            font-size: 1.25rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .hero-banner .features {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .hero-banner .feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .hero-banner .feature i {
            font-size: 1.5rem;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2.5rem;
            margin-bottom: 2rem;
            align-items: start;
        }

        @media (max-width: 768px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card h3 {
            font-size: 1.375rem;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
            font-weight: 700;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--bg-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 1.375rem;
            background: var(--primary-color);
            border-radius: 2px;
        }

        /* Product Display */
        .product-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .product-image {
            width: 100%;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .product-image:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* Color Selector */
        .color-selector {
            margin-bottom: 1.5rem;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .color-option {
            position: relative;
            border: 3px solid transparent;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--card-bg);
        }

        .color-option:hover {
            border-color: var(--border-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .color-option.selected {
            border-color: var(--primary-color);
            background: #fef3f0;
        }

        .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
            border: 2px solid var(--border-color);
        }

        .color-name {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stock-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stock-badge.in-stock {
            background: #d1fae5;
            color: #065f46;
        }

        .stock-badge.low-stock {
            background: #fed7aa;
            color: #92400e;
        }

        .stock-badge.out-of-stock {
            background: #fee2e2;
            color: #991b1b;
        }

        .stock-badge.loading {
            background: #e0f2fe;
            color: #075985;
        }

        .stock-badge.loading i {
            margin-right: 0.25rem;
        }

        /* Size-Specific Stock Badges */
        .size-stock-badge {
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 0.25rem;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            text-align: center;
        }

        .size-stock-badge.adequate {
            background: #d1fae5;
            color: #065f46;
        }

        .size-stock-badge.low {
            background: #fed7aa;
            color: #92400e;
        }

        .size-stock-badge.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .size-stock-badge.out {
            background: #e5e7eb;
            color: #6b7280;
        }

        /* Location Selector */
        .location-selector {
            margin-bottom: 1.5rem;
        }

        .location-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .location-option {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .location-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .location-option.selected {
            border-color: var(--primary-color);
            background: #fef3f0;
        }

        .location-option i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .location-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .location-price {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Size Breakdown */
        .size-breakdown {
            margin-bottom: 1.5rem;
        }

        .size-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .size-input-group {
            display: flex;
            flex-direction: column;
        }

        .size-input-group label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .size-input-group input {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            text-align: center;
            transition: all 0.3s;
        }

        .size-input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .size-price {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            text-align: center;
        }

        /* Size Stock Indicator */
        .size-stock-indicator {
            display: block;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            text-align: center;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .size-stock-indicator.in-stock {
            color: #10b981;
            background: #ecfdf5;
        }

        .size-stock-indicator.low-stock {
            color: #f59e0b;
            background: #fffbeb;
        }

        .size-stock-indicator.out-of-stock {
            color: #ef4444;
            background: #fef2f2;
        }

        /* Pricing Display */
        .pricing-summary {
            background: linear-gradient(135deg, #fef3f0, #fff);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--primary-color);
        }

        .pricing-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .pricing-row:last-child {
            border-bottom: none;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 0.5rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border-color);
        }

        .pricing-label {
            color: var(--text-secondary);
        }

        .pricing-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* File Upload */
        .file-upload {
            margin-bottom: 1.5rem;
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .upload-zone:hover {
            border-color: var(--primary-color);
            background: #fef3f0;
        }

        .upload-zone i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .upload-zone p {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .file-list {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-color);
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .file-item .file-name {
            font-weight: 500;
        }

        .file-item .file-size {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .file-item button {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-item button:hover {
            background: #dc2626;
        }

        /* Form Fields */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 1rem 2rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--accent-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #003d6e;
            transform: translateY(-2px);
        }

        .btn-full {
            width: 100%;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 500px;
            text-align: center;
        }

        .modal-content i {
            font-size: 4rem;
            color: var(--success-color);
            margin-bottom: 1rem;
        }

        .modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal-content p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }

        .order-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 1rem 0;
        }

        /* Timeline Steps */
        .timeline-steps {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .timeline-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 0.75rem;
            background: white;
            border-left: 3px solid var(--primary-color);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .timeline-step:hover {
            background: var(--bg-light);
            transform: translateX(5px);
        }

        .timeline-step i {
            font-size: 1.5rem;
            min-width: 24px;
            margin-top: 2px;
        }

        .timeline-step span {
            flex: 1;
            line-height: 1.4;
        }

        .timeline-step small {
            color: var(--text-secondary);
            display: block;
            margin-top: 0.25rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: var(--success-color);
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast.warning .toast-icon {
            color: #f59e0b;
        }

        .toast.info .toast-icon {
            color: #3b82f6;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            font-size: 1.25rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .product-grid {
                grid-template-columns: 1fr;
            }

            .location-grid {
                grid-template-columns: 1fr;
            }

            .size-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .color-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .hero-banner h2 {
                font-size: 1.5rem;
            }

            .hero-banner .features {
                flex-direction: column;
                gap: 1rem;
            }

            .toast-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }

        @media (max-width: 375px) {
            .container {
                padding: 1rem;
            }

            .card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Payment Modal (Stripe) -->
    <div class="modal" id="paymentModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;">Complete Payment</h3>
                <button onclick="closePaymentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Order Summary -->
            <div style="background: var(--bg-color); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin-top: 0; color: var(--text-primary);">Order Summary</h4>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Subtotal:</span>
                    <span id="paymentSubtotal">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Rush Fee (25%):</span>
                    <span id="paymentRushFee">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Sales Tax (10.1%):</span>
                    <span id="paymentTax">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; border-top: 2px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.5rem;">
                    <span>Total:</span>
                    <span id="paymentTotal" style="color: var(--primary-color);">$0.00</span>
                </div>
            </div>

            <!-- Stripe Card Element -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                    Card Information
                </label>
                <div id="card-element" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: white;">
                    <!-- Stripe Elements will be inserted here -->
                </div>
                <div id="card-errors" role="alert" style="color: var(--danger-color); font-size: 0.875rem; margin-top: 0.5rem;"></div>
            </div>

            <!-- Payment Button -->
            <button id="payButton" class="btn btn-primary btn-full" style="margin-bottom: 0.5rem;">
                <i class="fas fa-lock"></i> Pay <span id="payButtonAmount">$0.00</span>
            </button>
            <button onclick="closePaymentModal()" class="btn btn-secondary btn-full">
                Cancel
            </button>

            <!-- Security Badge -->
            <div style="text-align: center; margin-top: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
                <i class="fas fa-shield-alt" style="color: var(--success-color);"></i>
                Secure payment powered by Stripe
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <i class="fas fa-check-circle"></i>
            <h3>Order Submitted Successfully!</h3>
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Your 3-Day Tees rush order has been submitted.</p>
            <div class="order-number" id="orderNumber" style="font-size: 1.3rem; font-weight: bold; color: var(--primary-color); margin: 1rem 0;"></div>

            <!-- Estimated Delivery -->
            <div style="background: var(--bg-light); padding: 1rem; border-radius: 6px; margin: 1.5rem 0;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <i class="fas fa-calendar-check" style="color: var(--success-color);"></i>
                    <strong>Estimated Delivery:</strong>
                    <span id="estimatedDelivery" style="color: var(--primary-color); font-weight: bold;"></span>
                </div>
            </div>

            <!-- Next Steps Timeline -->
            <div style="text-align: left; margin: 1.5rem 0; padding: 0 1rem;">
                <h4 style="text-align: center; margin-bottom: 1rem; color: var(--text-primary);">What Happens Next:</h4>
                <div class="timeline-steps">
                    <div class="timeline-step">
                        <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                        <span><strong>Confirmation Email Sent</strong><br><small>Check your inbox for order details</small></span>
                    </div>
                    <div class="timeline-step">
                        <i class="fas fa-palette" style="color: var(--primary-color);"></i>
                        <span><strong>Artwork Review (Today)</strong><br><small>Our team will contact you to approve artwork</small></span>
                    </div>
                    <div class="timeline-step">
                        <i class="fas fa-print" style="color: var(--primary-color);"></i>
                        <span><strong>Production Begins (Day 1)</strong><br><small>DTG printing starts after artwork approval</small></span>
                    </div>
                    <div class="timeline-step">
                        <i class="fas fa-shipping-fast" style="color: var(--primary-color);"></i>
                        <span><strong>Ships Within 72 Hours</strong><br><small>Guaranteed delivery in 3 business days</small></span>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 1rem;">
                Questions? Call us at <strong style="color: var(--primary-color);">253-922-5793</strong>
            </p>

            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 1rem;">Start New Order</button>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo-section">
                <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1" alt="Northwest Custom Apparel" class="logo">
                <div class="logo-text">
                    <h1>Northwest Custom Apparel</h1>
                    <div class="service-name">3-Day Tees - Fast Turnaround</div>
                </div>
            </div>
            <div class="contact-cta">
                <span class="phone"><i class="fas fa-phone"></i> 253-922-5793</span>
            </div>
        </div>
    </header>

    <!-- Hero Banner -->
    <div class="hero-banner">
        <h2>âš¡ 3-Day Rush Service</h2>
        <p class="subtitle">Custom DTG printed t-shirts delivered in just 72 hours</p>
        <div class="features">
            <div class="feature">
                <i class="fas fa-shipping-fast"></i>
                <span>Ships in 3 Days</span>
            </div>
            <div class="feature">
                <i class="fas fa-check-circle"></i>
                <span>Guaranteed Quality</span>
            </div>
            <div class="feature">
                <i class="fas fa-palette"></i>
                <span>Full Color DTG</span>
            </div>
            <div class="feature">
                <i class="fas fa-star"></i>
                <span>Premium PC54</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="product-grid">
            <!-- Left Column: Product Configuration -->
            <div>
                <div class="card">
                    <h3>1. Select Product</h3>
                    <div class="product-info">
                        <p><strong>Port & Company PC54</strong></p>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;">Premium 100% cotton tee, perfect for DTG printing</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3>2. Choose Color</h3>
                    <div class="color-selector">
                        <div class="color-grid" id="colorGrid">
                            <!-- Colors populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Product Images Preview -->
                <div class="card" style="margin-top: 1rem;">
                    <h3>Product Preview</h3>
                    <div id="productImages" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; min-height: 200px;">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-tshirt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p style="font-size: 0.875rem;">Select a color to see product images</p>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3>3. Print Location</h3>
                    <div class="location-selector">
                        <div class="location-grid" id="locationGrid">
                            <!-- Locations populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3>4. Size Breakdown (Multi-Color)</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Enter quantity for each size per color (minimum 12 total pieces across all colors)</p>
                    <div class="size-breakdown">
                        <!-- Selected colors with per-color size grids -->
                        <div id="selectedColorsContainer">
                            <!-- Per-color size grids populated by JavaScript -->
                        </div>

                        <!-- Grand Total -->
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-color); border-radius: 6px; border: 2px solid var(--primary-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 700; font-size: 1.125rem;">Grand Total (All Colors):</span>
                                <span id="totalQuantity" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">0 pieces</span>
                            </div>
                            <div id="ltmWarning" style="margin-top: 0.5rem; color: var(--warning-color); font-size: 0.875rem; display: none;">
                                <i class="fas fa-exclamation-triangle"></i> Orders under 12 pieces include a $75 LTM fee
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3>5. Upload Artwork</h3>
                    <div class="file-upload">
                        <div class="upload-zone" id="uploadZone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p style="font-weight: 600; margin-bottom: 0.5rem;">Click or Drag Files Here</p>
                            <p style="font-size: 0.875rem;">Accepted: AI, EPS, PDF, PNG, JPG, TIFF, PSD (max 20MB)</p>
                        </div>
                        <input type="file" id="fileInput" style="display: none;" multiple accept=".ai,.eps,.pdf,.png,.jpg,.jpeg,.tiff,.tif,.psd">
                        <div class="file-list" id="fileList"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary & Checkout -->
            <div>
                <div class="card">
                    <h3>Order Summary</h3>
                    <div class="pricing-summary">
                        <div class="pricing-row">
                            <span class="pricing-label">Subtotal:</span>
                            <span class="pricing-value" id="subtotal">$0.00</span>
                        </div>
                        <div class="pricing-row" id="ltmFeeRow" style="display: none;">
                            <span class="pricing-label">LTM Fee:</span>
                            <span class="pricing-value" id="ltmFee">$0.00</span>
                        </div>
                        <div class="pricing-row">
                            <span class="pricing-label">Sales Tax (10.1%):</span>
                            <span class="pricing-value" id="salesTax">$0.00</span>
                        </div>
                        <div class="pricing-row">
                            <span class="pricing-label">Shipping (UPS Ground):</span>
                            <span class="pricing-value">$30.00</span>
                        </div>
                        <div class="pricing-row">
                            <span>Grand Total:</span>
                            <span id="grandTotal">$0.00</span>
                        </div>
                    </div>

                    <div style="background: #fff7ed; border: 2px solid var(--warning-color); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                        <p style="color: #92400e; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-info-circle"></i> Rush Service Terms
                        </p>
                        <p style="color: #92400e; font-size: 0.875rem;">
                            Orders ship within 72 hours from artwork approval. 25% rush fee included in pricing. Minimum 12 pieces required (or $75 LTM fee applies).
                        </p>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3>Contact Information</h3>
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone *</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="company">Company Name</label>
                        <input type="text" id="company">
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3>Shipping Address</h3>
                    <div class="form-group">
                        <label for="address1">Street Address *</label>
                        <input type="text" id="address1" required>
                    </div>
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" required>
                    </div>
                    <div class="form-group">
                        <label for="state">State *</label>
                        <input type="text" id="state" required maxlength="2" placeholder="WA">
                    </div>
                    <div class="form-group">
                        <label for="zip">ZIP Code *</label>
                        <input type="text" id="zip" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Special Instructions</label>
                        <textarea id="notes" placeholder="Any special requirements or notes..."></textarea>
                    </div>
                </div>

                <button class="btn btn-primary btn-full" id="submitOrder" style="margin-top: 1rem;">
                    <i class="fas fa-bolt"></i> Submit 3-Day Rush Order
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize EmailJS
        emailjs.init('4qSbDO-SQs19TbP80');

        // Initialize Stripe (will be set after loading config)
        let stripe = null;
        let cardElement = null;
        let paymentIntentClientSecret = null;
        let isProcessingPayment = false;  // Flag to prevent duplicate payment processing

        // Load Stripe publishable key from server and initialize
        async function initializeStripe() {
            try {
                const response = await fetch('/api/stripe-config');
                const { publishableKey } = await response.json();
                stripe = Stripe(publishableKey);

                // Create Stripe Elements
                const elements = stripe.elements();
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#1f2937',
                            fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                            '::placeholder': {
                                color: '#9ca3af'
                            }
                        },
                        invalid: {
                            color: '#ef4444'
                        }
                    }
                });

                // Mount card element when payment modal is shown
                // (We'll mount it when the modal opens)
            } catch (error) {
                console.error('[Stripe] Failed to initialize:', error);
                showToast('Payment system initialization failed. Please refresh the page.', 'error');
            }
        }

        // Call initialize on page load
        initializeStripe();

        // Toast Notification System
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // Icon based on type
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            // Title based on type
            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Information'
            };

            toast.innerHTML = `
                <i class="fas ${icons[type]} toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            return toast;
        }

        // State - MULTI-COLOR SUPPORT
        const state = {
            selectedColors: [],           // Array of catalog colors (multi-color support)
            colorConfigs: {},             // Object keyed by catalogColor with per-color state
                                         // Structure: { 'Jet Black': { displayColor, catalogColor, sizeBreakdown, totalQuantity, images }, ... }
            selectedLocation: null,
            pricingData: null,
            uploadedFiles: [],
            inventoryCache: {},           // Cache inventory API responses to prevent rate limiting
            colors: [
                { name: 'Jet Black', catalogColor: 'Jet Black', hex: '#000000' },
                { name: 'White', catalogColor: 'White', hex: '#FFFFFF' },
                { name: 'Navy', catalogColor: 'Navy', hex: '#001f3f' },
                { name: 'Athletic Heather', catalogColor: 'Ath Heather', hex: '#9ca3af' },
                { name: 'Dark Heather Grey', catalogColor: 'Dk Hthr Grey', hex: '#6b7280' }
            ],
            locations: [
                { code: 'LC', name: 'Left Chest', icon: 'fa-tshirt' },
                { code: 'FF', name: 'Full Front', icon: 'fa-tshirt' },
                { code: 'FB', name: 'Full Back', icon: 'fa-tshirt' }
            ],
            sizes: ['S', 'M', 'L', 'XL', '2XL', '3XL']
        };

        // Initialize services
        const pricingService = new DTGPricingService();
        const inventoryService = new SampleInventoryService();
        const orderService = new ThreeDayTeesOrderService();

        // Load available colors from API
        async function loadAvailableColors() {
            try {
                const response = await fetch('https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/product-details?styleNumber=PC54');
                const products = await response.json();

                // Deduplicate by CATALOG_COLOR and filter to desired colors
                // Match exact color names from ShopWorks inventory
                const desiredColors = [
                    'Jet Black',                        // Black (exact match from inventory)
                    'White',                            // White (exact match from inventory)
                    'Navy',                             // Navy (exact match from inventory)
                    'Ath Heather',                      // Athletic Heather (exact match from inventory)
                    'Dk Hthr Grey'                      // Dark Heather Grey (exact match from inventory)
                ];
                const uniqueColors = [...new Map(
                    products.map(p => [p.CATALOG_COLOR, p])
                ).values()];

                const apiColors = uniqueColors
                    .filter(p => desiredColors.includes(p.CATALOG_COLOR))
                    .map(p => ({
                        name: p.COLOR_NAME || p.CATALOG_COLOR,
                        catalogColor: p.CATALOG_COLOR,
                        hex: getHexForColor(p.CATALOG_COLOR), // Fallback hex
                        swatchImage: p.COLOR_SQUARE_IMAGE,
                        frontModel: p.FRONT_MODEL,
                        backModel: p.BACK_MODEL,
                        frontFlat: p.FRONT_FLAT || p.PRODUCT_IMAGE
                    }));

                console.log('[3-Day Tees] Loaded colors from API:', apiColors);
                return apiColors.length > 0 ? apiColors : state.colors; // Fallback to hardcoded if API fails
            } catch (error) {
                console.error('[3-Day Tees] Error loading colors from API:', error);
                return state.colors; // Fallback to hardcoded colors
            }
        }

        // Fallback hex colors for color swatches
        function getHexForColor(catalogColor) {
            const hexMap = {
                // Exact color names from ShopWorks inventory
                'Jet Black': '#000000',
                'White': '#FFFFFF',
                'Navy': '#001f3f',
                'Ath Heather': '#9ca3af',
                'Dk Hthr Grey': '#6b7280'
            };
            return hexMap[catalogColor] || '#cccccc';
        }

        // Load pricing data on page load
        async function init() {
            try {
                showLoading(true);

                // Fetch DTG pricing bundle
                const response = await fetch('https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/pricing-bundle?method=DTG&styleNumber=PC54');
                state.pricingData = await response.json();

                console.log('[3-Day Tees] Pricing data loaded:', state.pricingData);

                // Load colors from API
                state.colors = await loadAvailableColors();

                // Render UI
                renderColors();
                renderLocations();

                showLoading(false);
            } catch (error) {
                console.error('[3-Day Tees] Initialization error:', error);
                showToast('Failed to load pricing data. Please refresh the page or call 253-922-5793.', 'error', 0);  // 0 = don't auto-hide
                showLoading(false);
            }
        }

        // Render color selector - MULTI-COLOR SUPPORT
        function renderColors() {
            const grid = document.getElementById('colorGrid');
            grid.innerHTML = state.colors.map(color => {
                // Use swatch image if available, otherwise use hex color
                const swatchStyle = color.swatchImage
                    ? `background-image: url('${color.swatchImage}'); background-size: cover; background-position: center;`
                    : `background: ${color.hex};`;
                const whiteBorder = color.name === 'White' ? 'border: 2px solid #ccc;' : '';

                // Check if color is already selected
                const isSelected = state.selectedColors.includes(color.catalogColor);
                const selectedClass = isSelected ? 'selected' : '';
                const buttonText = isSelected ? 'âœ“ Added' : 'Add Color';
                const buttonClass = isSelected ? 'btn-secondary' : 'btn-primary';

                return `
                    <div class="color-option ${selectedClass}">
                        <div class="color-swatch" style="${swatchStyle} ${whiteBorder}"></div>
                        <div class="color-name">${color.name}</div>
                        <div class="stock-badge" id="stock-${color.catalogColor}">Loading...</div>
                        <button class="btn ${buttonClass}" style="margin-top: 8px; font-size: 0.875rem; padding: 6px 12px;"
                                onclick="toggleColor('${color.catalogColor}', event)">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');

            // Populate badges after DOM is updated (deferred by one tick)
            // This ensures badge elements exist before updateInventoryBadge() tries to find them
            setTimeout(() => {
                state.colors.forEach(color => {
                    const cached = state.inventoryCache[color.catalogColor];
                    if (cached) {
                        // Update badge from cache
                        updateInventoryBadge(color.catalogColor, cached.total);
                    } else {
                        // Only fetch from API if not cached (initial load)
                        loadInventory(color.catalogColor);
                    }
                });
            }, 0);
        }

        // Helper function to update inventory badge display
        function updateInventoryBadge(catalogColor, total) {
            const badgeId = `stock-${catalogColor}`;
            const badge = document.getElementById(badgeId);

            if (!badge) {
                console.error(`[3-Day Tees] Badge not found for ${catalogColor}`);
                return;
            }

            // Adjusted thresholds for local warehouse inventory
            if (total > 25) {
                badge.className = 'stock-badge in-stock';
                badge.textContent = 'In Stock';
            } else if (total > 0) {
                badge.className = 'stock-badge low-stock';
                badge.textContent = 'Low Stock';
            } else {
                badge.className = 'stock-badge out-of-stock';
                badge.textContent = 'Out of Stock';
            }
        }

        // Load inventory for a color from local warehouse (ManageOrders)
        async function loadInventory(catalogColor) {
            try {
                // Check cache first to avoid rate limiting
                if (state.inventoryCache[catalogColor]) {
                    console.log(`[3-Day Tees] Using cached inventory for ${catalogColor}`);
                    const cached = state.inventoryCache[catalogColor];
                    updateInventoryBadge(catalogColor, cached.total);
                    return;
                }

                // Show loading state on badge
                const badgeId = `stock-${catalogColor}`;
                const badge = document.getElementById(badgeId);
                if (badge) {
                    badge.className = 'stock-badge loading';
                    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
                }

                // DEBUG: Log the API URLs being called
                const apiBase = 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/manageorders/inventorylevels';
                const url1 = `${apiBase}?PartNumber=PC54&Color=${encodeURIComponent(catalogColor)}`;
                const url2 = `${apiBase}?PartNumber=PC54_2X&Color=${encodeURIComponent(catalogColor)}`;
                const url3 = `${apiBase}?PartNumber=PC54_3X&Color=${encodeURIComponent(catalogColor)}`;

                console.log(`[DEBUG] Loading inventory for color: "${catalogColor}"`);
                console.log(`[DEBUG] API URLs:`, { url1, url2, url3 });

                // Query all 3 SKUs in parallel (PC54, PC54_2X, PC54_3X)
                // catalogColor is already in correct format for ManageOrders API (e.g., "Ath Heather", "Dk Hthr Grey")
                const [standardRes, twoXLRes, threeXLRes] = await Promise.all([
                    fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/manageorders/inventorylevels?PartNumber=PC54&Color=${encodeURIComponent(catalogColor)}`),
                    fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/manageorders/inventorylevels?PartNumber=PC54_2X&Color=${encodeURIComponent(catalogColor)}`),
                    fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/manageorders/inventorylevels?PartNumber=PC54_3X&Color=${encodeURIComponent(catalogColor)}`)
                ]);

                // DEBUG: Log HTTP status codes
                console.log(`[DEBUG] HTTP Responses:`, {
                    PC54: { status: standardRes.status, ok: standardRes.ok },
                    PC54_2X: { status: twoXLRes.status, ok: twoXLRes.ok },
                    PC54_3X: { status: threeXLRes.status, ok: threeXLRes.ok }
                });

                // Parse all responses
                const standardData = await standardRes.json();
                const twoXLData = await twoXLRes.json();
                const threeXLData = await threeXLRes.json();

                // DEBUG: Log parsed data
                console.log(`[DEBUG] Parsed API Data:`, {
                    PC54: standardData,
                    PC54_2X: twoXLData,
                    PC54_3X: threeXLData
                });

                // DEBUG: Show what we got from each API call
                console.log(`[DEBUG INVENTORY] ${catalogColor} - Raw response data:`, {
                    PC54_result_length: standardData.result?.length,
                    PC54_has_Size01: standardData.result?.[0]?.Size01,
                    PC54_has_Size02: standardData.result?.[0]?.Size02,
                    PC54_has_Size03: standardData.result?.[0]?.Size03,
                    PC54_has_Size04: standardData.result?.[0]?.Size04,
                    PC54_2X_result_length: twoXLData.result?.length,
                    PC54_2X_has_Size05: twoXLData.result?.[0]?.Size05,
                    PC54_3X_result_length: threeXLData.result?.length,
                    PC54_3X_has_Size06: threeXLData.result?.[0]?.Size06
                });

                let total = 0;

                // PC54: Size01=S, Size02=M, Size03=L, Size04=XL
                if (standardData.result && standardData.result.length > 0) {
                    const inventory = standardData.result[0];
                    total += (inventory.Size01 || 0) + (inventory.Size02 || 0) +
                            (inventory.Size03 || 0) + (inventory.Size04 || 0);
                }

                // PC54_2X: Size05=2XL
                if (twoXLData.result && twoXLData.result.length > 0) {
                    total += twoXLData.result[0].Size05 || 0;
                }

                // PC54_3X: Size06=3XL
                if (threeXLData.result && threeXLData.result.length > 0) {
                    total += threeXLData.result[0].Size06 || 0;
                }

                console.log(`[DEBUG INVENTORY] ${catalogColor} - CALCULATED TOTAL: ${total} units`);
                console.log(`[DEBUG INVENTORY] ${catalogColor} - Badge decision: ${total > 25 ? 'IN STOCK' : total > 0 ? 'LOW STOCK' : 'OUT OF STOCK'}`);

                // Store in cache to prevent rate limiting on subsequent calls
                state.inventoryCache[catalogColor] = {
                    total: total,
                    standardData: standardData,
                    twoXLData: twoXLData,
                    threeXLData: threeXLData,
                    timestamp: Date.now()
                };
                console.log(`[3-Day Tees] Cached inventory for ${catalogColor}`);

                // Update badge using helper function
                updateInventoryBadge(catalogColor, total);

                console.log(`[3-Day Tees] Multi-SKU inventory for ${catalogColor}:`, {
                    PC54: standardData.result?.[0] || 'No data',
                    PC54_2X: twoXLData.result?.[0] || 'No data',
                    PC54_3X: threeXLData.result?.[0] || 'No data',
                    total: total
                });
            } catch (error) {
                console.error('[3-Day Tees] Multi-SKU inventory load error:', catalogColor, error);
                const badge = document.getElementById(`stock-${catalogColor.replace(/\s+/g, '-')}`);

                // Differentiate between network errors and API errors
                if (error.message.includes('fetch') || error.message.includes('network') || !navigator.onLine) {
                    badge.className = 'stock-badge';
                    badge.textContent = 'Network Error';
                    badge.title = 'Unable to connect to inventory system. Please check your internet connection and try again.';
                    showToast('Unable to check inventory. Please check your internet connection and try again.', 'error');
                } else if (error.name === 'SyntaxError') {
                    // JSON parse error - API returned invalid data
                    badge.className = 'stock-badge';
                    badge.textContent = 'API Error';
                    badge.title = 'Inventory system returned invalid data. Please try again or contact support.';
                    showToast('Inventory system error. Please try again or call 253-922-5793 for assistance.', 'error');
                } else {
                    // Generic error
                    badge.className = 'stock-badge';
                    badge.textContent = 'Check Stock';
                    badge.title = 'Unable to load inventory. Click the color card to try again.';
                    showToast(`Unable to load inventory for ${catalogColor}. Please try again.`, 'warning');
                }
            }
        }

        // Load size-specific inventory for selected color from local warehouse
        async function loadSizeInventory(catalogColor) {
            try {
                // Check cache first to avoid rate limiting
                let standardData, twoXLData, threeXLData;

                if (state.inventoryCache[catalogColor]) {
                    console.log(`[3-Day Tees] Using cached size inventory for ${catalogColor}`);
                    const cached = state.inventoryCache[catalogColor];

                    // Use cached data (property names match cache structure)
                    standardData = cached.standardData || { result: [] };
                    twoXLData = cached.twoXLData || { result: [] };
                    threeXLData = cached.threeXLData || { result: [] };
                } else {
                    // Query all 3 SKUs in parallel (PC54, PC54_2X, PC54_3X)
                    // catalogColor is already in correct format for ManageOrders API (e.g., "Ath Heather", "Dk Hthr Grey")
                    const [standardRes, twoXLRes, threeXLRes] = await Promise.all([
                        fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/manageorders/inventorylevels?PartNumber=PC54&Color=${encodeURIComponent(catalogColor)}`),
                        fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/manageorders/inventorylevels?PartNumber=PC54_2X&Color=${encodeURIComponent(catalogColor)}`),
                        fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/manageorders/inventorylevels?PartNumber=PC54_3X&Color=${encodeURIComponent(catalogColor)}`)
                    ]);

                    // Parse all responses
                    standardData = await standardRes.json();
                    twoXLData = await twoXLRes.json();
                    threeXLData = await threeXLRes.json();
                }

                // Build inventory by size
                const sizeInventory = {};

                // PC54: Size01=S, Size02=M, Size03=L, Size04=XL
                if (standardData.result && standardData.result.length > 0) {
                    const inventory = standardData.result[0];
                    sizeInventory['S'] = inventory.Size01 || 0;
                    sizeInventory['M'] = inventory.Size02 || 0;
                    sizeInventory['L'] = inventory.Size03 || 0;
                    sizeInventory['XL'] = inventory.Size04 || 0;
                } else {
                    // No standard sizes found
                    sizeInventory['S'] = 0;
                    sizeInventory['M'] = 0;
                    sizeInventory['L'] = 0;
                    sizeInventory['XL'] = 0;
                }

                // PC54_2X: Size05=2XL
                if (twoXLData.result && twoXLData.result.length > 0) {
                    sizeInventory['2XL'] = twoXLData.result[0].Size05 || 0;
                } else {
                    sizeInventory['2XL'] = 0;
                }

                // PC54_3X: Size06=3XL
                if (threeXLData.result && threeXLData.result.length > 0) {
                    sizeInventory['3XL'] = threeXLData.result[0].Size06 || 0;
                } else {
                    sizeInventory['3XL'] = 0;
                }

                // Update each size input with max constraint and enforcement
                state.sizes.forEach(size => {
                    const stock = sizeInventory[size] || 0;
                    const input = document.getElementById(`qty-${catalogColor}-${size}`);
                    const stockIndicator = document.getElementById(`stock-qty-${catalogColor}-${size}`);

                    if (input) {
                        if (stock === 0) {
                            // Out of stock: disable input
                            input.disabled = true;
                            input.value = 0;
                            input.max = 0;

                            // Update stock indicator
                            if (stockIndicator) {
                                stockIndicator.textContent = '0 units';
                                stockIndicator.className = 'size-stock-indicator out-of-stock';
                            }
                        } else {
                            // In stock: set max and add enforcement
                            input.disabled = false;
                            input.max = stock;

                            // Update stock indicator
                            if (stockIndicator) {
                                stockIndicator.textContent = `Available: ${stock}`;
                                if (stock <= 10) {
                                    stockIndicator.className = 'size-stock-indicator low-stock';
                                } else {
                                    stockIndicator.className = 'size-stock-indicator in-stock';
                                }
                            }

                            // Add input event listener to enforce max constraint
                            // Remove existing listener to avoid duplicates
                            input.removeEventListener('input', input._inventoryEnforcer);

                            // Create new enforcer function
                            input._inventoryEnforcer = function() {
                                const maxStock = parseInt(this.max);
                                const currentValue = parseInt(this.value) || 0;

                                if (currentValue > maxStock) {
                                    showToast(
                                        `Only ${maxStock} units of size ${size} available in ${catalogColor}. Your quantity has been adjusted to ${maxStock}.`,
                                        'warning',
                                        7000
                                    );
                                    this.value = maxStock;
                                    // Trigger the onchange handler to update pricing
                                    updateSizeQuantity(catalogColor, size, maxStock);
                                }
                            };

                            // Attach the enforcer
                            input.addEventListener('input', input._inventoryEnforcer);
                        }
                    }
                });

                console.log(`[3-Day Tees] Multi-SKU size inventory for ${catalogColor}:`, {
                    sizes: sizeInventory,
                    PC54: standardData.result?.[0] || 'No data',
                    PC54_2X: twoXLData.result?.[0] || 'No data',
                    PC54_3X: threeXLData.result?.[0] || 'No data'
                });
            } catch (error) {
                console.error('[3-Day Tees] Size inventory load error:', catalogColor, error);

                // Provide specific error feedback
                let errorMessage = 'Unable to load size-specific inventory.';

                if (error.message.includes('fetch') || error.message.includes('network') || !navigator.onLine) {
                    errorMessage = 'Network error: Unable to connect to inventory system. Please check your internet connection and try again.';
                } else if (error.name === 'SyntaxError') {
                    errorMessage = 'API error: Inventory system returned invalid data. Please try again or contact support.';
                }

                // Disable all size inputs for this color as a safety measure
                state.sizes.forEach(size => {
                    const input = document.getElementById(`qty-${catalogColor}-${size}`);
                    if (input) {
                        input.disabled = true;
                        input.value = 0;
                        input.title = errorMessage;
                    }
                });

                console.warn(`[3-Day Tees] ${errorMessage}`);
            }
        }

        // Toggle color selection - MULTI-COLOR SUPPORT
        function toggleColor(catalogColor, event) {
            event.stopPropagation(); // Prevent bubbling

            const colorData = state.colors.find(c => c.catalogColor === catalogColor);
            if (!colorData) return;

            // Check if color is already selected
            const index = state.selectedColors.indexOf(catalogColor);

            if (index === -1) {
                // Add color
                state.selectedColors.push(catalogColor);

                // Initialize colorConfig for this color
                state.colorConfigs[catalogColor] = {
                    displayColor: colorData.name,
                    catalogColor: catalogColor,
                    sizeBreakdown: {},
                    totalQuantity: 0,
                    images: {
                        frontModel: colorData.frontModel || null,
                        backModel: colorData.backModel || null,
                        frontFlat: colorData.frontFlat || null
                    }
                };

                // Initialize size breakdown with 0 quantity
                state.sizes.forEach(size => {
                    state.colorConfigs[catalogColor].sizeBreakdown[size] = {
                        quantity: 0,
                        unitPrice: 0
                    };
                });

                console.log('[3-Day Tees] Color added:', catalogColor);

                // Inventory will be loaded by renderColors() below (prevents race condition)
            } else {
                // Remove color
                state.selectedColors.splice(index, 1);
                delete state.colorConfigs[catalogColor];

                console.log('[3-Day Tees] Color removed:', catalogColor);
            }

            // Update UI
            renderColors();
            renderSelectedColors();
            updateProductImages();
            recalculateAllPricing();

            // Load size-specific inventory for this color (if it was just added)
            if (state.selectedColors.includes(catalogColor)) {
                requestAnimationFrame(() => loadSizeInventory(catalogColor));
            }
        }

        // Update product images based on selected colors
        function updateProductImages() {
            const container = document.getElementById('productImages');
            if (!container) return;

            if (state.selectedColors.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary); grid-column: 1 / -1;">
                        <i class="fas fa-tshirt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p style="font-size: 0.875rem;">Select a color to see product images</p>
                    </div>
                `;
                return;
            }

            // Show images for all selected colors
            const imageHTML = state.selectedColors.map(catalogColor => {
                const config = state.colorConfigs[catalogColor];
                const colorData = state.colors.find(c => c.catalogColor === catalogColor);

                const images = [];

                // Front Model
                if (config.images.frontModel) {
                    images.push(`
                        <div style="text-align: center;">
                            <img src="${config.images.frontModel}" alt="${config.displayColor} - Front"
                                 class="product-image" style="width: 100%; border-radius: 8px; border: 2px solid var(--border-color);">
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">${config.displayColor} - Front</p>
                        </div>
                    `);
                }

                // Back Model
                if (config.images.backModel) {
                    images.push(`
                        <div style="text-align: center;">
                            <img src="${config.images.backModel}" alt="${config.displayColor} - Back"
                                 class="product-image" style="width: 100%; border-radius: 8px; border: 2px solid var(--border-color);">
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">${config.displayColor} - Back</p>
                        </div>
                    `);
                }

                // Front Flat
                if (config.images.frontFlat) {
                    images.push(`
                        <div style="text-align: center;">
                            <img src="${config.images.frontFlat}" alt="${config.displayColor} - Flat"
                                 class="product-image" style="width: 100%; border-radius: 8px; border: 2px solid var(--border-color);">
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">${config.displayColor} - Flat</p>
                        </div>
                    `);
                }

                // If no images available, show placeholder
                if (images.length === 0) {
                    return `
                        <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                            <i class="fas fa-tshirt" style="font-size: 2rem; opacity: 0.3;"></i>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">${config.displayColor}</p>
                            <p style="font-size: 0.75rem;">Images not available</p>
                        </div>
                    `;
                }

                return images.join('');
            }).join('');

            container.innerHTML = imageHTML;
            console.log('[3-Day Tees] Product images updated for colors:', state.selectedColors);
        }

        // Render selected colors list with size grids
        function renderSelectedColors() {
            const container = document.getElementById('selectedColorsContainer');
            if (!container) return;

            if (state.selectedColors.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <p>No colors selected yet. Click "Add Color" above to get started.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.selectedColors.map(catalogColor => {
                const config = state.colorConfigs[catalogColor];
                const colorData = state.colors.find(c => c.catalogColor === catalogColor);

                return `
                    <div class="color-section" id="color-section-${catalogColor}" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="color-swatch" style="background: ${colorData.hex}; width: 32px; height: 32px; border-radius: 4px; ${colorData.name === 'White' ? 'border: 2px solid #ccc;' : ''}"></div>
                                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">${config.displayColor}</h3>
                            </div>
                            <button class="btn btn-danger" onclick="removeColor('${catalogColor}')" style="padding: 6px 12px; font-size: 0.875rem;">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>

                        <!-- Size Grid for this color -->
                        <div class="size-grid" id="size-grid-${catalogColor}">
                            ${state.sizes.map(size => `
                                <div class="size-input-group">
                                    <label class="size-label">${size}</label>
                                    <input type="number"
                                           id="qty-${catalogColor}-${size}"
                                           class="size-input"
                                           min="0"
                                           value="0"
                                           onchange="updateSizeQuantity('${catalogColor}', '${size}', this.value)">
                                    <span id="stock-qty-${catalogColor}-${size}" class="size-stock-indicator">Checking...</span>
                                    <div class="size-price" id="price-${catalogColor}-${size}">$0.00</div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Color Total -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: right; font-weight: 600;">
                            <span style="color: var(--text-secondary);">Total for ${config.displayColor}:</span>
                            <span id="total-${catalogColor}" style="margin-left: 1rem; font-size: 1.25rem; color: var(--primary-color);">0 pieces</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Load size-specific inventory for all selected colors
            state.selectedColors.forEach(catalogColor => {
                requestAnimationFrame(() => loadSizeInventory(catalogColor));
            });
        }

        // Remove color from selection
        function removeColor(catalogColor) {
            const index = state.selectedColors.indexOf(catalogColor);
            if (index !== -1) {
                state.selectedColors.splice(index, 1);
                delete state.colorConfigs[catalogColor];

                console.log('[3-Day Tees] Color removed:', catalogColor);

                // Update UI
                renderColors();
                renderSelectedColors();
                recalculateAllPricing();
            }
        }

        // Update size quantity for a specific color
        function updateSizeQuantity(catalogColor, size, value) {
            const quantity = parseInt(value) || 0;

            if (!state.colorConfigs[catalogColor]) return;

            // Update quantity
            state.colorConfigs[catalogColor].sizeBreakdown[size].quantity = quantity;

            // Recalculate pricing for all colors (combined quantity pricing)
            recalculateAllPricing();
        }

        // Recalculate pricing for all colors - CRITICAL: Uses COMBINED quantity for tier
        function recalculateAllPricing() {
            if (!state.pricingData || !state.selectedLocation || state.selectedColors.length === 0) {
                return;
            }

            // Step 1: Calculate grand total quantity across ALL colors
            let grandTotalQuantity = 0;
            state.selectedColors.forEach(catalogColor => {
                const config = state.colorConfigs[catalogColor];
                config.totalQuantity = Object.values(config.sizeBreakdown)
                    .reduce((sum, s) => sum + s.quantity, 0);
                grandTotalQuantity += config.totalQuantity;
            });

            console.log('[3-Day Tees] Recalculating pricing with combined quantity:', grandTotalQuantity);

            // Step 2: Calculate prices using COMBINED quantity for ALL colors
            let grandSubtotal = 0;

            state.selectedColors.forEach(catalogColor => {
                const config = state.colorConfigs[catalogColor];
                let colorSubtotal = 0;

                // Calculate unit price for each size using COMBINED quantity
                state.sizes.forEach(size => {
                    const sizeData = config.sizeBreakdown[size];
                    const qty = sizeData.quantity;

                    if (qty > 0) {
                        // Use COMBINED grandTotalQuantity for tier determination
                        const unitPrice = calculatePrice(grandTotalQuantity, state.selectedLocation, size);
                        sizeData.unitPrice = unitPrice;

                        // Update price display
                        const priceEl = document.getElementById(`price-${catalogColor}-${size}`);
                        if (priceEl) {
                            priceEl.textContent = `$${unitPrice.toFixed(2)}`;
                        }

                        colorSubtotal += qty * unitPrice;
                    }
                });

                // Update per-color total
                const totalEl = document.getElementById(`total-${catalogColor}`);
                if (totalEl) {
                    totalEl.textContent = `${config.totalQuantity} pieces`;
                }

                grandSubtotal += colorSubtotal;
            });

            // Step 3: Update grand total display
            document.getElementById('totalQuantity').textContent = `${grandTotalQuantity} pieces`;

            // Step 4: Show/hide LTM warning
            const ltmWarning = document.getElementById('ltmWarning');
            if (ltmWarning) {
                if (grandTotalQuantity > 0 && grandTotalQuantity < 12) {
                    ltmWarning.style.display = 'block';
                } else {
                    ltmWarning.style.display = 'none';
                }
            }

            // Step 5: Calculate and update order summary
            const ltmFee = grandTotalQuantity < 12 ? 75 : 0;
            const salesTax = (grandSubtotal + ltmFee) * 0.101;
            const shipping = 30;
            const grandTotal = grandSubtotal + ltmFee + salesTax + shipping;

            // Update order summary displays
            const subtotalEl = document.getElementById('subtotal');
            const salesTaxEl = document.getElementById('salesTax');
            const grandTotalEl = document.getElementById('grandTotal');
            const ltmFeeEl = document.getElementById('ltmFee');
            const ltmRowEl = document.getElementById('ltmFeeRow');

            if (subtotalEl) subtotalEl.textContent = `$${grandSubtotal.toFixed(2)}`;
            if (salesTaxEl) salesTaxEl.textContent = `$${salesTax.toFixed(2)}`;
            if (grandTotalEl) grandTotalEl.textContent = `$${grandTotal.toFixed(2)}`;

            if (ltmFee > 0 && ltmFeeEl && ltmRowEl) {
                ltmRowEl.style.display = 'flex';
                ltmFeeEl.textContent = `$${ltmFee.toFixed(2)}`;
            } else if (ltmRowEl) {
                ltmRowEl.style.display = 'none';
            }

            console.log('[3-Day Tees] Pricing recalculated:', {
                grandTotalQuantity,
                subtotal: grandSubtotal.toFixed(2),
                ltmFee: ltmFee.toFixed(2),
                salesTax: salesTax.toFixed(2),
                shipping: shipping.toFixed(2),
                grandTotal: grandTotal.toFixed(2)
            });
        }

        // Render locations
        function renderLocations() {
            const grid = document.getElementById('locationGrid');
            grid.innerHTML = state.locations.map(loc => `
                <div class="location-option" onclick="selectLocation('${loc.code}')">
                    <i class="fas ${loc.icon}"></i>
                    <div class="location-name">${loc.name}</div>
                    <div class="location-price" id="price-${loc.code}">Select quantity</div>
                </div>
            `).join('');
        }

        // Select location
        function selectLocation(code) {
            state.selectedLocation = code;

            // Update UI
            document.querySelectorAll('.location-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            console.log('[3-Day Tees] Location selected:', code);
            recalculateAllPricing();
        }

        // Calculate price (7-step formula + 25% rush fee)
        function calculatePrice(quantity, location, size) {
            if (!state.pricingData || !location || quantity === 0) return 0;

            // Find tier
            const tier = state.pricingData.tiersR.find(t =>
                quantity >= t.MinQuantity && quantity <= t.MaxQuantity
            ) || state.pricingData.tiersR[0];

            // Step 1: Base garment cost
            const baseCost = Math.min(...state.pricingData.sizes
                .map(s => parseFloat(s.price))
                .filter(p => p > 0)
            );

            // Step 2: Marked up garment
            const markedUpGarment = baseCost / tier.MarginDenominator;

            // Step 3: Print cost
            const printCost = state.pricingData.allDtgCostsR.find(c =>
                c.PrintLocationCode === location && c.TierLabel === tier.TierLabel
            )?.PrintCost || 0;

            // Step 4: Base DTG price
            const baseDTGPrice = markedUpGarment + printCost;

            // Step 5: Round base
            const roundedBase = Math.ceil(baseDTGPrice * 2) / 2;

            // Step 6: Apply 25% rush fee
            const rushFee = roundedBase * 0.25;
            const priceWithRush = roundedBase + rushFee;

            // Step 7: Final rounding
            const finalPrice = Math.ceil(priceWithRush * 2) / 2;

            // Step 8: Add size upcharge (API uses 'sellingPriceDisplayAddOns' not 'upcharges')
            const upcharge = (state.pricingData.sellingPriceDisplayAddOns || {})[size] || 0;

            return finalPrice + upcharge;
        }

        // File upload handling
        document.getElementById('uploadZone').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.size > 20 * 1024 * 1024) {
                    showToast(
                        `File "${file.name}" is too large. Maximum file size is 20MB.`,
                        'error',
                        8000
                    );
                    return;
                }
                state.uploadedFiles.push(file);
            });
            renderFileList();
        });

        function renderFileList() {
            const list = document.getElementById('fileList');
            if (state.uploadedFiles.length === 0) {
                list.innerHTML = '';
                return;
            }

            list.innerHTML = state.uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${(file.size / 1024).toFixed(1)} KB</div>
                    </div>
                    <button onclick="removeFile(${index})">Remove</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            state.uploadedFiles.splice(index, 1);
            renderFileList();
        }

        // Payment Modal Functions
        function showPaymentModal(orderTotal) {
            // Calculate pricing breakdown
            const subtotal = orderTotal.subtotal || 0;
            const rushFee = orderTotal.rushFee || 0;
            const tax = orderTotal.tax || 0;
            const total = orderTotal.total || 0;

            // Update payment modal with amounts
            document.getElementById('paymentSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('paymentRushFee').textContent = `$${rushFee.toFixed(2)}`;
            document.getElementById('paymentTax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('paymentTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('payButtonAmount').textContent = `$${total.toFixed(2)}`;

            // Mount Stripe card element if not already mounted
            if (cardElement && !cardElement._parent) {
                cardElement.mount('#card-element');

                // Handle real-time validation errors
                cardElement.on('change', (event) => {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
            }

            // Show modal
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            // Clear errors
            document.getElementById('card-errors').textContent = '';
        }

        /**
         * Restore Pay button to its original enabled state
         * Used when payment fails and user needs to retry
         */
        function restorePayButton() {
            const payButton = document.getElementById('payButton');
            payButton.disabled = false;
            payButton.innerHTML = 'Pay Now';
        }

        /**
         * Get user-friendly error message for Stripe error
         */
        function getStripeErrorMessage(error) {
            console.error('[Payment] Stripe error:', error);

            // CRITICAL: Check decline_code FIRST (more specific than error.code)
            // This is essential for security-sensitive errors like lost/stolen cards
            if (error.decline_code) {
                const declineMessages = {
                    // SECURITY: Lost/stolen cards - NO RETRY
                    'lost_card': 'This card has been reported lost. Please use a different card.\n\nIf you need assistance, please call us at 253-922-5793.',
                    'stolen_card': 'This card has been reported stolen. Please use a different card.\n\nIf you need assistance, please call us at 253-922-5793.',

                    // FINANCIAL: Insufficient funds
                    'insufficient_funds': 'Insufficient funds. Please try a different card or add funds to your account.',

                    // Bank decline reasons
                    'do_not_honor': 'Your bank declined this transaction. Please contact your bank or try a different card.',
                    'fraudulent': 'This transaction was flagged as potentially fraudulent. Please contact your bank.',
                    'generic_decline': 'Your card was declined. Please contact your bank for more information.',
                    'invalid_account': 'The card account is invalid. Please check your card details or use a different card.',
                    'new_account_information_available': 'Your card information may be outdated. Please check with your bank.',
                    'no_action_taken': 'Your bank did not approve this payment. Please try a different card or contact your bank.',
                    'not_permitted': 'This type of transaction is not permitted on your card. Please try a different card.',
                    'pickup_card': 'This card cannot be used. Please contact your bank or use a different card.',
                    'restricted_card': 'This card has restrictions. Please contact your bank or use a different card.',
                    'revocation_of_all_authorizations': 'All authorizations have been revoked for this card. Please use a different card.',
                    'revocation_of_authorization': 'Authorization was revoked for this card. Please use a different card.',
                    'security_violation': 'Security violation detected. Please contact your bank.',
                    'service_not_allowed': 'This service is not allowed on your card. Please try a different card.',
                    'stop_payment_order': 'A stop payment order exists for this card. Please contact your bank.',
                    'testmode_decline': 'Test card declined. Please use a real card number.',
                    'transaction_not_allowed': 'This transaction is not allowed. Please try a different card or contact your bank.',
                    'try_again_later': 'Temporary issue with your bank. Please try again in a few moments.',
                    'withdrawal_count_limit_exceeded': 'You have exceeded your card\'s transaction limit. Please try again later or use a different card.'
                };

                if (declineMessages[error.decline_code]) {
                    return {
                        message: declineMessages[error.decline_code],
                        code: error.decline_code,
                        canRetry: !['lost_card', 'stolen_card'].includes(error.decline_code) // SECURITY: No retry for lost/stolen
                    };
                }
            }

            // Then check generic error codes
            const errorMessages = {
                // Card errors
                'card_declined': 'Your card was declined. Please try a different payment method or contact your bank.',
                'insufficient_funds': 'Insufficient funds. Please try a different card or add funds to your account.',
                'expired_card': 'Your card has expired. Please check the expiration date or use a different card.',
                'incorrect_cvc': 'Incorrect security code (CVC). Please check the 3-digit code on the back of your card.',
                'incorrect_number': 'Invalid card number. Please check your card number and try again.',
                'invalid_expiry_month': 'Invalid expiration month. Please check your card\'s expiration date.',
                'invalid_expiry_year': 'Invalid expiration year. Please check your card\'s expiration date.',
                'invalid_cvc': 'Invalid security code. Please enter the 3-digit CVC from your card.',
                'invalid_number': 'Your card number is invalid.',

                // Processing errors
                'processing_error': 'Error processing your payment. Please try again in a moment.',
                'rate_limit': 'Too many payment attempts. Please wait a moment before trying again.',

                // Authentication errors
                'authentication_required': 'Your bank requires additional authentication. Please complete the verification step.',
                'approve_with_id': 'Your payment requires approval. Please contact your bank to authorize this transaction.',

                // Network/system errors
                'api_connection_error': 'Connection error. Please check your internet connection and try again.',
                'api_error': 'Payment system error. Please try again or contact support at 253-922-5793.',

                // Generic decline
                'generic_decline': 'Your card was declined. Please contact your bank or try a different card.'
            };

            // Get specific error message based on error.code
            if (error.code && errorMessages[error.code]) {
                return {
                    message: errorMessages[error.code],
                    code: error.code,
                    canRetry: true // Generic errors can be retried
                };
            }

            // Default error message
            return {
                message: error.message || 'Payment failed. Please check your card details and try again, or contact support at 253-922-5793.',
                code: error.code || 'unknown',
                canRetry: true
            };
        }

        async function processPayment() {
            // Check if payment is already being processed
            if (isProcessingPayment) {
                console.log('[Payment] Already processing payment, ignoring duplicate request');
                return null;
            }

            if (!stripe || !cardElement) {
                showToast('Payment system not ready. Please refresh the page.', 'error');
                return null;
            }

            // Set flag to prevent duplicate processing
            isProcessingPayment = true;

            try {
                showLoading(true);

                // Calculate order total
                const orderTotal = calculateOrderTotal();

                // Create payment intent on server
                const response = await fetch('/api/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: Math.round(orderTotal.total * 100), // Convert to cents
                        currency: 'usd'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('[Payment] Server error:', errorData);
                    throw new Error(errorData.error || 'Failed to create payment intent');
                }

                const { clientSecret } = await response.json();
                paymentIntentClientSecret = clientSecret;

                // Confirm card payment
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
                            email: document.getElementById('email').value
                        }
                    }
                });

                showLoading(false);

                if (error) {
                    // Payment failed - get user-friendly error message
                    const errorInfo = getStripeErrorMessage(error);
                    console.error('[Payment] Payment failed:', errorInfo.code, errorInfo.message);

                    // Show error to user with longer display time for important messages
                    const displayTime = errorInfo.canRetry ? 10000 : 15000;
                    showToast(errorInfo.message, 'error', displayTime);

                    // Log for debugging
                    console.error('[Payment] Full error details:', {
                        code: error.code,
                        decline_code: error.decline_code,
                        type: error.type,
                        message: error.message,
                        canRetry: errorInfo.canRetry
                    });

                    return null;
                } else if (paymentIntent.status === 'succeeded') {
                    // Payment succeeded
                    console.log('[Payment] Payment succeeded:', paymentIntent.id);
                    return paymentIntent.id; // Return payment ID
                } else if (paymentIntent.status === 'requires_action') {
                    // 3D Secure or other authentication required
                    console.log('[Payment] Additional authentication required');
                    showToast('Additional authentication required. Please complete the verification step.', 'warning', 8000);
                    return null;
                } else if (paymentIntent.status === 'requires_payment_method') {
                    // Payment method failed, need new one
                    console.log('[Payment] Payment method failed, needs replacement');
                    showToast('Payment method failed. Please try a different card.', 'error', 10000);
                    return null;
                } else {
                    // Other unexpected status
                    console.warn('[Payment] Unexpected payment status:', paymentIntent.status);
                    showToast('Payment status uncertain. Please contact support at 253-922-5793.', 'warning', 12000);
                    return null;
                }

            } catch (error) {
                showLoading(false);
                console.error('[Payment] Unexpected error:', error);

                // Check if network error
                if (error.message === 'Failed to fetch' || error.message.includes('network')) {
                    showToast('Network error. Please check your internet connection and try again.', 'error', 10000);
                } else if (error.message.includes('payment intent')) {
                    showToast('Payment system error. Please try again or contact support at 253-922-5793.', 'error', 12000);
                } else {
                    showToast('Unexpected error processing payment. Please try again or contact support at 253-922-5793.', 'error', 12000);
                }

                return null;
            } finally {
                // Always reset the processing flag
                isProcessingPayment = false;
            }
        }

        function calculateOrderTotal() {
            // Calculate total quantity across all colors
            let grandTotalQuantity = 0;
            state.selectedColors.forEach(catalogColor => {
                const config = state.colorConfigs[catalogColor];
                const qty = Object.values(config.sizeBreakdown).reduce((sum, s) => sum + s.quantity, 0);
                grandTotalQuantity += qty;
            });

            // Get pricing data directly (not nested under .pricing)
            const pricingData = state.pricingData || {};

            console.log('[Payment] Looking for tier for quantity:', grandTotalQuantity);
            console.log('[Payment] Available tiers:', (pricingData.tiersR || []).map(t => {
                return `${t.TierLabel}: ${t.MinQuantity}-${t.MaxQuantity}`;
            }));

            // Find tier for quantity - Handle LTM (Less Than Minimum) case
            let tier = (pricingData.tiersR || []).find(t =>
                grandTotalQuantity >= t.MinQuantity && grandTotalQuantity <= t.MaxQuantity
            );

            // If no tier found and quantity is under 24, use the 24-47 tier (lowest tier)
            if (!tier && grandTotalQuantity < 24) {
                const lowestTier = (pricingData.tiersR || []).sort((a, b) => a.MinQuantity - b.MinQuantity)[0];
                if (lowestTier) {
                    console.log('[Payment] Quantity under minimum, using lowest tier:', lowestTier.TierLabel);
                    tier = lowestTier;
                }
            }

            if (!tier) {
                console.error('[Payment] No tier found for quantity:', grandTotalQuantity);
                console.error('[Payment] Available tiers:', pricingData.tiersR);
                return { subtotal: 0, rushFee: 0, tax: 0, total: 0 };
            }

            console.log('[Payment] Using tier:', tier.TierLabel, `(${tier.MinQuantity}-${tier.MaxQuantity})`);


            // Calculate base cost per piece
            const baseCost = Math.min(...(pricingData.sizes || []).map(s => parseFloat(s.price)).filter(p => p > 0));
            const markedUp = baseCost / tier.MarginDenominator;

            // Get print cost for location
            const printCost = (pricingData.allDtgCostsR || []).find(c =>
                c.PrintLocationCode === state.selectedLocation &&
                c.TierLabel === tier.TierLabel
            )?.PrintCost || 0;

            // Calculate base price per piece
            const basePrice = markedUp + printCost;
            const roundedBase = Math.ceil(basePrice * 2) / 2;

            // Calculate subtotal with size upcharges
            let subtotal = 0;
            state.selectedColors.forEach(catalogColor => {
                const config = state.colorConfigs[catalogColor];
                Object.entries(config.sizeBreakdown).forEach(([size, sizeData]) => {
                    const upcharge = (pricingData.sellingPriceDisplayAddOns || {})[size] || 0;
                    const pricePerPiece = roundedBase + upcharge;
                    subtotal += pricePerPiece * sizeData.quantity;
                });
            });

            // Apply 25% rush fee
            const rushFee = subtotal * 0.25;
            const subtotalWithRush = subtotal + rushFee;

            // Apply 10.1% sales tax
            const tax = subtotalWithRush * 0.101;
            const total = subtotalWithRush + tax;

            return {
                subtotal: subtotal,
                rushFee: rushFee,
                tax: tax,
                total: total
            };
        }

        // Payment button handler
        document.addEventListener('DOMContentLoaded', () => {
            const payButton = document.getElementById('payButton');
            if (payButton) {
                payButton.addEventListener('click', async () => {
                    // Disable button during processing
                    payButton.disabled = true;
                    payButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                    // Process payment
                    const paymentId = await processPayment();

                    if (paymentId) {
                        // Close payment modal
                        closePaymentModal();

                        // Submit order with payment ID
                        await submitOrderWithPayment(paymentId);
                    } else {
                        // Re-enable button on failure
                        payButton.disabled = false;
                        const total = calculateOrderTotal().total;
                        payButton.innerHTML = `<i class="fas fa-lock"></i> Pay $${total.toFixed(2)}`;
                    }
                });
            }
        });

        // Submit order with payment ID
        async function submitOrderWithPayment(paymentId) {
            try {
                showLoading(true);

                // Collect customer data
                const customerData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    company: document.getElementById('company').value || '',
                    address1: document.getElementById('address1').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value,
                    notes: document.getElementById('notes').value || ''
                };

                // Collect order settings
                const orderSettings = {
                    printLocationCode: state.selectedLocation,
                    printLocationName: state.locations.find(l => l.code === state.selectedLocation).name,
                    uploadedFiles: state.uploadedFiles,
                    paymentId: paymentId  // Include payment ID
                };

                console.log('[3-Day Tees] Submitting order with payment ID:', paymentId);

                // Submit order using ThreeDayTeesOrderService
                const result = await orderService.submitOrder(
                    customerData,
                    state.colorConfigs,
                    orderSettings
                );

                showLoading(false);

                if (result.success) {
                    // Show success message
                    document.getElementById('orderNumber').textContent = `Order #${result.orderNumber}`;

                    // Calculate and display estimated delivery date (3 business days)
                    const estimatedDeliveryDate = calculateDeliveryDate(3);
                    document.getElementById('estimatedDelivery').textContent = estimatedDeliveryDate;

                    // Show warning if API failed but saved to database
                    if (result.warning) {
                        const successText = document.querySelector('#successModal p');
                        if (successText) {
                            successText.innerHTML += `<br><br><strong>Note:</strong> ${result.warning}`;
                        }
                    }

                    document.getElementById('successModal').classList.add('active');
                } else {
                    // Show error with toast
                    showToast(
                        `Order submission failed: ${result.error}. Payment was processed successfully (ID: ${paymentId}). Please call 253-922-5793 for assistance.`,
                        'error',
                        15000  // 15 seconds for errors
                    );
                }

            } catch (error) {
                showLoading(false);
                console.error('[Order] Error:', error);
                showToast(
                    `Order submission error. Payment was processed (ID: ${paymentId}). Please call 253-922-5793 immediately.`,
                    'error',
                    15000
                );
            }
        }

        // DUPLICATE EVENT LISTENER REMOVED - Pay button listener is now only attached in DOMContentLoaded
        // This duplicate was causing race conditions and "in-flight confirmCardPayment" errors
        // The correct listener is at lines 2581-2606 inside DOMContentLoaded

        // Submit order - MULTI-COLOR SUPPORT
        document.getElementById('submitOrder').addEventListener('click', async () => {
            // Validate multi-color selections
            if (state.selectedColors.length === 0) {
                showToast('Please select at least one color to continue', 'warning');
                return;
            }

            if (!state.selectedLocation) {
                showToast('Please select a print location', 'warning');
                return;
            }

            // Calculate total quantity across all colors
            let grandTotalQuantity = 0;
            state.selectedColors.forEach(catalogColor => {
                const config = state.colorConfigs[catalogColor];
                config.totalQuantity = Object.values(config.sizeBreakdown)
                    .reduce((sum, s) => sum + s.quantity, 0);
                grandTotalQuantity += config.totalQuantity;
            });

            if (grandTotalQuantity === 0) {
                showToast('Please enter quantities for at least one size', 'warning');
                return;
            }

            if (!document.getElementById('firstName').value || !document.getElementById('lastName').value) {
                showToast('Please fill in your first and last name', 'warning');
                return;
            }

            if (!document.getElementById('email').value) {
                showToast('Please provide your email address', 'warning');
                return;
            }

            if (!document.getElementById('address1').value || !document.getElementById('city').value || !document.getElementById('state').value || !document.getElementById('zip').value) {
                showToast('Please fill in all required shipping address fields', 'warning');
                return;
            }

            if (state.uploadedFiles.length === 0) {
                if (!confirm('No artwork files uploaded. Continue anyway? (Not recommended)')) {
                    return;
                }
            }

            // Validation passed - show payment modal
            console.log('[3-Day Tees] Validation passed, showing payment modal...');
            console.log('[3-Day Tees] Colors:', state.selectedColors);
            console.log('[3-Day Tees] Total quantity:', grandTotalQuantity);

            // Calculate order total
            const orderTotal = calculateOrderTotal();
            console.log('[3-Day Tees] Order total:', orderTotal);

            // Show payment modal (Pay button will handle order submission)
            showPaymentModal(orderTotal);
        });

        // NOTE: Order number generation and email sending now handled by ThreeDayTeesOrderService

        // Calculate delivery date (business days)
        function calculateDeliveryDate(businessDays) {
            const today = new Date();
            let daysAdded = 0;
            let currentDate = new Date(today);

            while (daysAdded < businessDays) {
                currentDate.setDate(currentDate.getDate() + 1);
                // Skip weekends (0 = Sunday, 6 = Saturday)
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    daysAdded++;
                }
            }

            // Format: "Monday, January 15, 2025"
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return currentDate.toLocaleDateString('en-US', options);
        }

        // Loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
