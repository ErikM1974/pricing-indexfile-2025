<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Stitch Count Pricing Update</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        iframe {
            width: 100%;
            height: 800px;
            border: 2px solid #333;
            margin-top: 20px;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .pricing-display {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Stitch Count Pricing Update Test</h1>
    
    <div class="test-section">
        <h2>Test Instructions</h2>
        <ol>
            <li>The beta page will load below with default 8,000 stitch pricing ($24 for qty 24-47)</li>
            <li>Click the test buttons to simulate changing stitch count</li>
            <li>Watch the Quick Quote Calculator price update immediately</li>
            <li>Check the pricing table to see if it shows different prices</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h2>Simulated Master Data</h2>
        <div class="info">This test will inject sample pricing data to simulate Caspio response</div>
        <pre id="master-data-display"></pre>
    </div>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <div class="test-controls">
            <button onclick="injectMasterData()">1. Inject Master Data</button>
            <button onclick="changeStitchCount('5000')">2. Change to 5,000 stitches</button>
            <button onclick="changeStitchCount('8000')">3. Change to 8,000 stitches</button>
            <button onclick="changeStitchCount('10000')">4. Change to 10,000 stitches</button>
            <button onclick="checkPricing()">5. Check Current Pricing</button>
        </div>
        
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Beta Page (Interactive)</h2>
        <iframe id="beta-frame" src="/cap-embroidery-pricing-integrated.html?StyleNumber=C112&COLOR=Black"></iframe>
    </div>
    
    <script>
        // Sample master data structure
        const sampleMasterData = {
            allPriceProfiles: {
                "5000": {
                    "OSFA": {
                        "24-47": "22.00",
                        "48-71": "21.00",
                        "72+": "19.00"
                    }
                },
                "8000": {
                    "OSFA": {
                        "24-47": "24.00",
                        "48-71": "23.00",
                        "72+": "21.00"
                    }
                },
                "10000": {
                    "OSFA": {
                        "24-47": "26.00",
                        "48-71": "25.00",
                        "72+": "23.00"
                    }
                }
            }
        };
        
        // Display the master data
        document.getElementById('master-data-display').textContent = JSON.stringify(sampleMasterData, null, 2);
        
        function getIframeWindow() {
            return document.getElementById('beta-frame').contentWindow;
        }
        
        function injectMasterData() {
            const iframe = getIframeWindow();
            
            // Inject the master data
            iframe.capEmbroideryMasterData = sampleMasterData;
            
            // Trigger the event that the page is listening for
            iframe.dispatchEvent(new CustomEvent('caspioCapPricingCalculated', {
                detail: { masterData: sampleMasterData }
            }));
            
            showResult('Master data injected successfully! Different stitch counts should now show different prices.', 'success');
        }
        
        function changeStitchCount(stitchCount) {
            const iframe = getIframeWindow();
            const select = iframe.document.getElementById('stitch-count') || iframe.document.getElementById('client-stitch-count-select');
            
            if (select) {
                select.value = stitchCount;
                select.dispatchEvent(new Event('change'));
                
                // Check the pricing after a short delay
                setTimeout(() => {
                    checkPricing();
                }, 500);
                
                showResult(`Changed stitch count to ${stitchCount}`, 'info');
            } else {
                showResult('Could not find stitch count selector!', 'error');
            }
        }
        
        function checkPricing() {
            const iframe = getIframeWindow();
            
            // Get current values
            const unitPrice = iframe.document.getElementById('unit-price')?.textContent || 'Not found';
            const totalPrice = iframe.document.getElementById('total-price')?.textContent || 'Not found';
            const stitchCount = iframe.document.getElementById('stitch-count')?.value || 'Not found';
            const quantity = iframe.document.getElementById('quantity-input')?.value || 'Not found';
            
            // Get pricing table first row
            const firstPriceCell = iframe.document.querySelector('#custom-pricing-grid tbody tr:first-child td:nth-child(2)')?.textContent || 'Not found';
            
            const results = `
                <div class="pricing-display">Current Pricing Check:</div>
                <div class="info">
                    <strong>Stitch Count:</strong> ${stitchCount}<br>
                    <strong>Quantity:</strong> ${quantity}<br>
                    <strong>Unit Price:</strong> ${unitPrice}<br>
                    <strong>Total Price:</strong> ${totalPrice}<br>
                    <strong>24-47 Table Price:</strong> ${firstPriceCell}
                </div>
            `;
            
            showResult(results, 'none');
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = type !== 'none' ? `status ${type}` : '';
            div.innerHTML = message;
            resultDiv.appendChild(div);
            
            // Auto-remove after 10 seconds (except for pricing checks)
            if (type !== 'none') {
                setTimeout(() => {
                    div.remove();
                }, 10000);
            }
        }
        
        // Wait for iframe to load
        document.getElementById('beta-frame').onload = function() {
            showResult('Beta page loaded! Click "Inject Master Data" to begin testing.', 'info');
        };
    </script>
</body>
</html>