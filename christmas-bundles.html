<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Gift Box Builder - Northwest Custom Apparel</title>
    <link rel="icon" href="https://cdn.caspio.com/A0E15000/Safety%20Stripes/NWCA%20Favicon%20for%20TEAMNWCA.com.png?ver=1" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e8f5e9 100%);
            min-height: 100vh;
            position: relative;
        }

        /* Subtle Pricing Info Bar */
        .pricing-info-bar {
            background: white;
            margin: 15px auto;
            max-width: 800px;
            border-radius: 8px;
            border: 1px solid #d4d4d4;
            border-left: 4px solid #2e7d32;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .pricing-bar-toggle {
            padding: 14px 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            color: #2e7d32;
            transition: background 0.2s ease;
        }

        .pricing-bar-toggle:hover {
            background: #f8faf8;
        }

        .pricing-bar-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .pricing-arrow {
            position: absolute;
            right: 20px;
            transition: transform 0.3s ease;
            color: #2e7d32;
        }

        .pricing-info-bar.expanded .pricing-arrow {
            transform: rotate(90deg);
        }

        .pricing-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .pricing-info-bar.expanded .pricing-details {
            max-height: 150px;
        }

        .pricing-simple {
            padding: 20px;
            text-align: center;
        }

        .pricing-row {
            margin-bottom: 10px;
            color: #333;
            font-size: 15px;
            font-weight: 500;
        }

        .pricing-includes {
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
        }

        .pricing-volume {
            color: #2e7d32;
            font-size: 13px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .pricing-info-bar {
                margin: 10px;
                font-size: 13px;
            }

            .pricing-row {
                font-size: 13px;
            }

            .pricing-includes {
                font-size: 12px;
            }
        }

        /* Snow animation */
        .snow-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }

        .snowflake {
            position: absolute;
            top: -10px;
            color: white;
            font-size: 1em;
            animation: fall linear infinite;
        }

        @keyframes fall {
            from {
                transform: translateY(-100vh);
            }
            to {
                transform: translateY(100vh);
            }
        }

        /* Contact Bar */
        .contact-bar {
            background: #1a472a;
            color: white;
            padding: 8px 0;
            font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .contact-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contact-item i {
            color: #4caf50;
        }

        .contact-item a {
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }

        .contact-item a:hover {
            color: #4caf50;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a472a 0%, #2e7d32 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            z-index: 10;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }

        .header-logo {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }

        .header-logo img {
            height: 60px;
            width: auto;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 18px;
            opacity: 0.95;
            font-weight: 400;
        }

        .christmas-icons {
            font-size: 28px;
            margin: 0 15px;
            animation: bounce 2s infinite;
        }

        /* Deadline Banner */
        .deadline-banner {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #1a472a;
            padding: 15px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(255,152,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .deadline-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .deadline-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .deadline-icon {
            font-size: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .deadline-text {
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .deadline-date {
            color: #dc2626;
            font-weight: 700;
            font-size: 20px;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Progress Bar */
        .progress-container {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: -1;
        }

        .step.active::after,
        .step.completed::after {
            background: #4caf50;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background: #4caf50;
            color: white;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.2);
        }

        .step.completed .step-number {
            background: #4caf50;
            color: white;
        }

        .step-title {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .step.active .step-title {
            color: #1a472a;
            font-weight: 600;
        }

        /* Clickable step indicators */
        .step.completed,
        .step.active {
            cursor: pointer;
        }

        .step.completed:hover .step-number,
        .step.active:hover .step-number {
            transform: scale(1.1);
            box-shadow: 0 0 0 6px rgba(76, 175, 80, 0.3);
        }

        .step:not(.completed):not(.active) {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .step:not(.completed):not(.active) .step-number {
            background: #e0e0e0;
        }

        /* Main Container */
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
            gap: 30px;
            position: relative;
            z-index: 10;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            min-width: 0;
        }

        /* Section */
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: none;
        }

        .section.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            margin-bottom: 25px;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 15px;
        }

        .section-title {
            font-size: 24px;
            color: #1a472a;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-subtitle {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Product Card */
        .product-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .product-card {
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: #81c784;
            background: #f8fdf9;
        }

        .product-card.selected {
            border: 3px solid #4caf50;
            background: #f1f8f4;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        .product-card.selected:hover {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .product-image .placeholder {
            color: #999;
            font-size: 48px;
        }

        .selected-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4caf50;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: none;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.3s ease;
        }

        .product-card.selected .selected-badge {
            display: flex;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }

        .product-info {
            padding: 15px;
        }

        .product-style {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-name {
            font-size: 16px;
            color: #333;
            font-weight: 600;
            margin: 5px 0;
            line-height: 1.3;
        }

        .product-price {
            font-size: 18px;
            margin: 10px 0 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .retail-value {
            color: #999;
            text-decoration: line-through;
            font-size: 16px;
            font-weight: 400;
        }

        .free-badge {
            color: #4caf50;
            font-weight: 700;
            font-size: 20px;
        }

        /* Value Summary Banner */
        .value-summary-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #d1ecf1 100%);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .value-summary-content {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .value-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 20px;
        }

        .value-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .value-amount {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .value-item.highlight .value-amount {
            color: #28a745;
            font-size: 28px;
        }

        .value-item.savings .value-amount {
            color: #dc3545;
            font-size: 28px;
        }

        .value-amount.free {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Error Highlighting */
        .missing-selection {
            border: 2px solid #f44336 !important;
            background: #ffebee !important;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Bottom padding fix for Mehar */
        .section:last-child {
            margin-bottom: 50px;
        }

        /* Disabled button styling */
        .disabled-btn {
            background: #e0e0e0 !important;
            color: #999 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .disabled-btn:hover {
            background: #e0e0e0 !important;
            transform: none !important;
        }

        /* Loading Overlay Styles */
        .submission-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .submission-overlay.active {
            display: flex;
        }

        .submission-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .submission-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #c41e3a;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        .submission-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .submission-message {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 20px;
            min-height: 24px;
        }

        .submission-steps {
            text-align: left;
            margin-top: 20px;
        }

        .submission-step {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: #9ca3af;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .submission-step.active {
            color: #c41e3a;
            font-weight: 500;
        }

        .submission-step.complete {
            color: #10b981;
        }

        .submission-step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid currentColor;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .submission-step.complete .submission-step-icon {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .submission-step.active .submission-step-icon {
            background: #c41e3a;
            border-color: #c41e3a;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Processing state for submit button */
        .submit-btn.processing {
            background: linear-gradient(135deg, #c41e3a, #dc3545) !important;
            opacity: 0.9;
            cursor: wait !important;
            animation: subtlePulse 2s infinite;
        }

        @keyframes subtlePulse {
            0%, 100% {
                opacity: 0.9;
            }
            50% {
                opacity: 1;
            }
        }

        /* Required field indicator */
        .required-indicator {
            color: #dc2626;
            font-weight: 700;
            margin-left: 3px;
        }

        .product-description {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 15px;
            max-height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Size and Color Selection */
        .selection-group {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .selection-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .size-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 8px;
        }

        .size-btn {
            padding: 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .size-btn:hover {
            border-color: #4caf50;
        }

        .size-btn.selected {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .color-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-swatch {
            display: inline-block;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 2px;
        }

        .color-swatch:hover {
            transform: translateY(-3px);
        }

        .swatch-image {
            width: 48px;
            height: 48px;
            margin: 0 auto 4px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .color-swatch.selected .swatch-image {
            border-color: #4caf50;
            border-width: 3px;
            box-shadow: 0 0 0 4px rgba(76, 179, 84, 0.15);
        }

        .color-swatch:hover .swatch-image {
            border-color: #999;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        .swatch-name {
            font-size: 11px;
            color: #555;
            line-height: 1.2;
            font-weight: 500;
            max-width: 60px;
            margin: 0 auto;
            display: none; /* Hide by default, show on hover */
        }

        .color-swatch:hover .swatch-name,
        .color-swatch.selected .swatch-name {
            display: block;
        }

        /* Select Button */
        .select-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .select-btn:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .select-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }


        .select-btn.selected {
            background: linear-gradient(135deg, #388e3c, #2e7d32);
        }

        .select-btn.selected:hover {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
        }

        /* Logo Upload Section */
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .upload-icon {
            font-size: 48px;
            color: #999;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #999;
        }

        .logo-preview {
            margin-top: 20px;
            display: none;
        }

        .logo-preview.active {
            display: block;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Shipping Form */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-label .required {
            color: #dc3545;
        }

        .form-input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Delivery Options */
        .delivery-options {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .delivery-option {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delivery-option:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .delivery-option input[type="radio"] {
            margin-right: 0.75rem;
        }

        .delivery-option input[type="radio"]:checked + .option-content {
            color: #10b981;
            font-weight: 600;
        }

        .delivery-option input[type="radio"]:checked ~ * {
            color: #10b981;
        }

        .option-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .option-content i {
            font-size: 1.25rem;
        }

        /* Pickup Info Box */
        .pickup-info-box {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .pickup-info-box h4 {
            color: #065f46;
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .pickup-info-box p {
            margin-bottom: 0.75rem;
            color: #374151;
        }

        .info-note {
            background: #dcfce7;
            padding: 0.75rem;
            border-radius: 6px;
            display: flex;
            align-items: start;
            gap: 0.5rem;
        }

        .info-note i {
            color: #10b981;
            margin-top: 0.125rem;
        }

        /* Checkbox Label */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .checkbox-label input[type="checkbox"] {
            width: 1.125rem;
            height: 1.125rem;
            cursor: pointer;
        }

        /* Order Summary Sidebar */
        .order-summary {
            width: 380px;
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid #e8f5e9;
        }

        /* New Confirmation Page Styles */
        .confirmation-container {
            display: flex;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .confirmation-main {
            flex: 1;
            min-width: 0;
        }

        .confirmation-sidebar {
            width: 380px;
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .confirmation-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .confirmation-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f3f4f6;
        }

        .product-item-card {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
        }

        .product-item-card:hover {
            background: #f3f4f6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .product-item-image {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .product-item-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .product-item-details {
            flex: 1;
            min-width: 0;
        }

        .product-item-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product-item-meta {
            font-size: 13px;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .product-item-meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .review-color-swatch {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #d1d5db;
            display: inline-block;
            vertical-align: middle;
        }

        .product-item-price {
            text-align: right;
            flex-shrink: 0;
        }

        .retail-price {
            font-size: 12px;
            color: #9ca3af;
            text-decoration: line-through;
        }

        .free-tag {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
        }

        .summary-total-card {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            border: 2px solid #0284c7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .summary-row:last-child {
            margin-bottom: 0;
            padding-top: 12px;
            border-top: 2px solid #0284c7;
            font-size: 18px;
            font-weight: 700;
        }

        .summary-label {
            color: #475569;
        }

        .summary-value {
            font-weight: 600;
            color: #1f2937;
        }

        .summary-value.free {
            color: #10b981;
            font-size: 20px;
        }

        .summary-value.savings {
            color: #dc2626;
        }


        .customization-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .customization-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .customization-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .customization-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 600;
        }

        .logo-preview-container {
            grid-column: span 2;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #d1d5db;
        }

        .logo-preview-image {
            max-width: 200px;
            max-height: 150px;
            margin: 10px auto;
            display: block;
        }

        .delivery-info-compact {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .delivery-info-item {
            flex: 1;
            min-width: 200px;
        }

        .delivery-info-icon {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .delivery-info-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 600;
            margin-left: 24px;
        }

        @media (max-width: 1024px) {
            .confirmation-container {
                flex-direction: column;
            }

            .confirmation-sidebar {
                width: 100%;
                position: relative;
                top: 0;
            }

            .customization-grid {
                grid-template-columns: 1fr;
            }

            .logo-preview-container {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .product-item-card {
                flex-direction: column;
                text-align: center;
            }

            .product-item-image {
                width: 100px;
                height: 100px;
                margin: 0 auto;
            }

            .product-item-price {
                text-align: center;
                margin-top: 10px;
            }

            .delivery-info-compact {
                flex-direction: column;
                gap: 15px;
            }
        }

        .summary-header {
            font-size: 20px;
            font-weight: 700;
            color: #1a472a;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8f5e9;
        }

        .summary-items {
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .summary-item-image {
            width: 60px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #999;
            overflow: hidden;
            position: relative;
        }

        .summary-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .summary-item-image .image-fallback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #999;
            display: none;
        }

        .summary-item-image.fallback-active img {
            display: none;
        }

        .summary-item-image.fallback-active .image-fallback {
            display: block;
        }

        .summary-item-details {
            flex: 1;
        }

        .summary-item-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .summary-item-specs {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .summary-item-remove {
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }

        .summary-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .summary-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .summary-total {
            padding-top: 20px;
            border-top: 2px solid #e8f5e9;
            margin-top: 20px;
        }

        .summary-note {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .summary-note-icon {
            color: #4caf50;
            margin-right: 8px;
        }

        .summary-note-text {
            font-size: 14px;
            color: #2e7d32;
            font-weight: 500;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #c41e3a, #dc3545);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            /* Mobile touch optimizations */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #a01729, #c41e3a);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: wait;
            transform: none;
        }

        /* Navigation Buttons - Sticky at bottom */
        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(to top, rgba(255,255,255,1) 80%, rgba(255,255,255,0.95) 100%);
            border-top: 2px solid #4caf50;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 999;
        }

        /* Add padding to bottom of content to account for fixed navigation */
        .step-content {
            padding-bottom: 120px;
        }

        .nav-btn {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            border-color: #4caf50;
            color: #4caf50;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border: none;
            /* Make Continue button larger and more prominent */
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 700;
        }

        .nav-btn.primary:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        /* Pulsing animation for enabled Continue button */
        .nav-btn.primary:not(:disabled) {
            animation: pulse 2s infinite;
        }

        /* Enhanced Submit Order button */
        .submit-order-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            animation: pulse-orange 2s infinite !important;
        }

        .submit-order-btn:hover {
            background: linear-gradient(135deg, #f57c00, #e65100) !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.5) !important;
        }

        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 152, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        /* Remove floating continue button since we now have sticky navigation */
        .floating-continue-btn {
            display: none !important;
        }

        .floating-continue-btn:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(76, 175, 80, 0.5);
        }

        .floating-continue-btn.show {
            display: flex;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Helper Text */
        .selection-helper {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 16px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
            animation: slideDown 0.5s ease;
        }

        /* Visual Scroll Indicator */
        .scroll-indicator {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            z-index: 998;
            animation: bounce 2s infinite;
        }

        .scroll-indicator.show {
            display: flex;
        }

        .scroll-indicator-text {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .scroll-indicator-arrow {
            color: #4caf50;
            font-size: 24px;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            40% {
                transform: translateX(-50%) translateY(-10px);
            }
            60% {
                transform: translateX(-50%) translateY(-5px);
            }
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .selection-helper.show {
            display: flex;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px) translateY(-50%);
                opacity: 0;
            }
            to {
                transform: translateX(0) translateY(-50%);
                opacity: 1;
            }
        }

        /* Success Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            text-align: center;
            animation: slideUp 0.3s ease;
            position: relative;
        }

        /* Close button for modal */
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            background: #f3f4f6;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .modal-close-btn:hover {
            background: #e5e7eb;
            transform: scale(1.1);
        }

        .modal-close-btn i {
            font-size: 16px;
            color: #6b7280;
        }

        /* Mobile optimizations for modal */
        @media (max-width: 768px) {
            .modal-content {
                padding: 30px 20px;
                max-height: 90vh;
                width: 95%;
                margin: 20px;
            }

            .success-title {
                font-size: 20px !important;
            }

            .reference-number {
                font-size: 24px !important;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .success-icon {
            font-size: 72px;
            color: #4caf50;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 28px;
            color: #1a472a;
            margin-bottom: 10px;
        }

        .success-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .success-reference {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .reference-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .reference-number {
            font-size: 24px;
            font-weight: 700;
            color: #1a472a;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }

            .order-summary {
                width: 100%;
                position: static;
                margin-top: 30px;
            }

            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
        }

        @media (max-width: 768px) {
            /* Contact Bar Mobile */
            .contact-bar-content {
                flex-direction: column;
                gap: 8px;
                padding: 8px 15px;
            }

            .contact-item {
                font-size: 13px;
            }

            /* Header Mobile */
            .header-content {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .header-logo img {
                height: 50px;
            }

            .header h1 {
                font-size: 24px;
            }

            .header .subtitle {
                font-size: 16px;
            }

            /* Deadline Banner Mobile */
            .deadline-banner {
                padding: 12px 15px;
            }

            .deadline-content {
                flex-direction: column;
                gap: 8px;
            }

            .deadline-text {
                font-size: 14px;
            }

            .deadline-date {
                font-size: 16px;
                display: block;
                margin: 5px 0;
            }

            .progress-steps {
                overflow-x: auto;
                padding-bottom: 10px;
            }

            .step-title {
                font-size: 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }

            .product-card {
                border-radius: 8px;
            }

            .product-image {
                height: 150px;
            }

            .product-info {
                padding: 12px;
            }

            .product-name {
                font-size: 14px;
            }

            .navigation {
                flex-direction: column;
                gap: 10px;
            }

            .nav-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Christmas Decorations */
        .holly {
            color: #c41e3a;
            animation: sway 3s ease-in-out infinite;
        }

        @keyframes sway {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }

        /* Image Zoom Modal */
        .image-zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            cursor: zoom-out;
        }

        .image-zoom-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .zoom-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .zoom-close {
            position: absolute;
            top: 20px;
            right: 40px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            transition: all 0.2s;
        }

        .zoom-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .product-image {
            cursor: zoom-in;
        }

        /* Glove Selection Styles */
        .product-single-view {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .glove-product-card {
            display: flex;
            gap: 30px;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
        }

        .glove-product-image {
            flex: 0 0 400px;
        }

        .glove-product-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .glove-product-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .glove-product-description {
            font-size: 16px;
            color: #666;
            margin: 0;
        }

        .glove-color-display {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .glove-product-card {
                flex-direction: column;
            }

            .glove-product-image {
                flex: none;
                width: 100%;
            }

            /* Review page mobile styles */
            #reviewItems {
                grid-template-columns: 1fr !important;
            }

            #reviewCustomization > div {
                grid-template-columns: 1fr !important;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons button {
                width: 100%;
            }

            #submitBtn {
                font-size: 18px !important;
                padding: 15px 30px !important;
            }
        }

        /* Step 6 Delivery Information Styles */
        #step6 .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        #step6 .form-grid.full {
            grid-template-columns: 1fr;
        }

        /* Delivery Options Styles */
        .delivery-options {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .delivery-option {
            flex: 1;
            cursor: pointer;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }

        .delivery-option:hover {
            border-color: #c41e3a;
            background: #fef2f2;
        }

        .delivery-option input[type="radio"] {
            display: none;
        }

        .delivery-option input[type="radio"]:checked + .option-content {
            color: #c41e3a;
        }

        .delivery-option input[type="radio"]:checked ~ .option-content i {
            color: #c41e3a;
        }

        .delivery-option input[type="radio"]:checked + * {
            font-weight: 600;
        }

        .delivery-option:has(input[type="radio"]:checked) {
            border-color: #c41e3a;
            background: #fef2f2;
        }

        .option-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .option-content i {
            font-size: 24px;
            color: #666;
            transition: color 0.3s ease;
        }

        /* Pickup Info Box */
        .pickup-info {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .pickup-info h3 {
            color: #28a745;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .pickup-info .info-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .pickup-info .info-item i {
            color: #28a745;
            width: 20px;
        }

        .pickup-info .hours {
            font-weight: 600;
            color: #333;
            margin-top: 10px;
        }

        #shippingFields {
            margin-top: 20px;
        }

        #pickupInfo {
            display: none;
        }

        /* Custom Date Picker Styles */
        .date-input-wrapper {
            position: relative;
        }

        .date-validation-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .date-validation-message.show {
            display: block;
        }

        /* Enhanced date input styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            font-size: 16px;
        }

        /* Custom calendar overlay */
        .custom-calendar {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 320px;
        }

        .custom-calendar.show {
            display: block;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px 10px;
            color: #4caf50;
            transition: background 0.2s;
        }

        .calendar-nav:hover {
            background: #f0f0f0;
            border-radius: 4px;
        }

        .calendar-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .calendar-month-year {
            font-weight: 600;
            font-size: 16px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            padding: 8px;
            color: #666;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        .calendar-day:hover:not(.disabled):not(.selected) {
            background: #f0fff0;
            border-color: #4caf50;
        }

        .calendar-day.selected {
            background: #4caf50;
            color: white;
            font-weight: 600;
        }

        .calendar-day.today {
            border: 2px solid #4caf50;
            font-weight: 600;
        }

        .calendar-day.disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
            position: relative;
        }

        .calendar-day.weekend {
            background: #fef2f2;
            color: #dc2626;
        }

        .calendar-day.weekend.disabled {
            background: #f5f5f5;
            color: #ccc;
        }

        .calendar-day.buffer-period {
            background: #fffbeb;
            color: #d97706;
            cursor: not-allowed;
        }

        .calendar-day.other-month {
            color: #ddd;
        }

        .calendar-legend {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 12px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border: 1px solid #ddd;
            margin-right: 5px;
            border-radius: 2px;
        }

        .legend-color.available {
            background: white;
        }

        .legend-color.unavailable {
            background: #f5f5f5;
        }

        .legend-color.weekend {
            background: #fef2f2;
        }

        .legend-color.buffer {
            background: #fffbeb;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay for Submission -->
    <div id="submissionOverlay" class="submission-overlay">
        <div class="submission-modal">
            <div class="submission-spinner"></div>
            <h2 class="submission-title">Processing Your Order</h2>
            <p class="submission-message">Please wait while we create your gift box...</p>

            <div class="submission-steps">
                <div class="submission-step" data-step="validate">
                    <div class="submission-step-icon">1</div>
                    <span>Validating order details</span>
                </div>
                <div class="submission-step" data-step="logo">
                    <div class="submission-step-icon">2</div>
                    <span>Uploading your logo</span>
                </div>
                <div class="submission-step" data-step="quote">
                    <div class="submission-step-icon">3</div>
                    <span>Creating your quote</span>
                </div>
                <div class="submission-step" data-step="email">
                    <div class="submission-step-icon">4</div>
                    <span>Sending confirmation email</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Continue Button -->
    <button class="floating-continue-btn" id="floatingContinue" onclick="clickActiveContinueButton()">
        Continue to Next Step
        <i class="fas fa-arrow-right"></i>
    </button>

    <!-- Helper Text -->
    <div class="selection-helper" id="selectionHelper">
        <i class="fas fa-check-circle"></i>
        <span>Product selected! Continue button is at the bottom</span>
    </div>

    <!-- Scroll Indicator -->
    <div class="scroll-indicator" id="scrollIndicator">
        <div class="scroll-indicator-text">Continue button below</div>
        <div class="scroll-indicator-arrow">
            <i class="fas fa-chevron-down"></i>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div class="image-zoom-modal" id="imageZoomModal">
        <button class="zoom-close" onclick="closeZoomModal()">×</button>
        <div class="zoom-content">
            <img class="zoom-image" id="zoomImage" alt="Zoomed product image">
        </div>
    </div>

    <!-- Snow Effect -->
    <div class="snow-overlay" id="snowOverlay"></div>

    <!-- Header -->
    <!-- Contact Bar -->
    <div class="contact-bar">
        <div class="contact-bar-content">
            <div class="contact-item">
                <i class="fas fa-phone"></i>
                <a href="tel:253-922-5793">253-922-5793</a>
            </div>
            <div class="contact-item">
                <i class="fas fa-envelope"></i>
                <a href="mailto:sales@nwcustomapparel.com">sales@nwcustomapparel.com</a>
            </div>
        </div>
    </div>

    <!-- Header with Logo -->
    <div class="header">
        <div class="header-content">
            <div class="header-logo">
                <img src="https://cdn.caspio.com/A0E15000/Safety%20Stripes/web%20northwest%20custom%20apparel%20logo.png?ver=1"
                     alt="Northwest Custom Apparel">
            </div>
            <div class="header-text">
                <h1>
                    <span class="christmas-icons">🎄</span>
                    Christmas Gift Box Builder
                    <span class="christmas-icons">🎁</span>
                </h1>
                <p class="subtitle">Create your custom holiday gift box - FREE with logo embroidery!</p>
            </div>
        </div>
    </div>

    <!-- Deadline Banner -->
    <div class="deadline-banner">
        <div class="deadline-content">
            <span class="deadline-icon">⏰</span>
            <span class="deadline-text">
                Special Free Bundle Deal Ends
                <span class="deadline-date">OCTOBER 1ST, 2025</span>
                - Place Your Bundle Order Today!
            </span>
            <span class="deadline-icon">🎁</span>
        </div>
    </div>

    <!-- Dynamic Value Summary Banner -->
    <div class="value-summary-banner" id="valueSummaryBanner" style="display: none;">
        <div class="value-summary-content">
            <div class="value-item">
                <span class="value-label">Gift Box Value:</span>
                <span class="value-amount" id="totalValueAmount">$0</span>
            </div>
            <div class="value-item highlight">
                <span class="value-label">Your Cost:</span>
                <span class="value-amount free">FREE!</span>
            </div>
            <div class="value-item savings">
                <span class="value-label">You Save:</span>
                <span class="value-amount" id="totalSavingsAmount">$0</span>
            </div>
        </div>
    </div>

    <!-- Subtle Pricing Info Bar -->
    <div class="pricing-info-bar collapsed" id="pricingInfoBar">
        <div class="pricing-bar-toggle" onclick="togglePricing()">
            <span class="pricing-bar-text">
                🎄 Christmas Bundle Pricing 2025
            </span>
            <i class="fas fa-chevron-right pricing-arrow" id="pricingArrow"></i>
        </div>
        <div class="pricing-details" id="pricingDetails">
            <div class="pricing-simple">
                <div class="pricing-row">
                    <strong>Rain Defender:</strong> $213 &nbsp;|&nbsp;
                    <strong>Detroit:</strong> $258 &nbsp;|&nbsp;
                    <strong>Storm Defender:</strong> $295
                </div>
                <div class="pricing-includes">
                    Each bundle includes: Jacket • Hoodie • Beanie • Gloves • Gift Box with custom embroidery
                </div>
                <div class="pricing-volume">
                    Volume pricing available for 8+ bundles
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="step active" data-step="1" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <div class="step-title">Select Jacket</div>
            </div>
            <div class="step" data-step="2" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <div class="step-title">Select Hoodie</div>
            </div>
            <div class="step" data-step="3" onclick="goToStep(3)">
                <div class="step-number">3</div>
                <div class="step-title">Select Beanie</div>
            </div>
            <div class="step" data-step="4" onclick="goToStep(4)">
                <div class="step-number">4</div>
                <div class="step-title">Select Gloves</div>
            </div>
            <div class="step" data-step="5" onclick="goToStep(5)">
                <div class="step-number">5</div>
                <div class="step-title">Customize</div>
            </div>
            <div class="step" data-step="6" onclick="goToStep(6)">
                <div class="step-number">6</div>
                <div class="step-title">Delivery Info</div>
            </div>
            <div class="step" data-step="7" onclick="goToStep(7)">
                <div class="step-number">7</div>
                <div class="step-title">Review</div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Content Area -->
        <div class="content-area">
            <!-- Step 1: Select Jacket -->
            <div class="section active" id="step1">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-tshirt"></i>
                        Choose Your Jacket
                    </h2>
                    <p class="section-subtitle">Select from our premium Carhartt jacket collection</p>
                </div>

                <div class="product-grid" id="jacketGrid">
                    <!-- Jacket products will be dynamically inserted here -->
                </div>

                <div class="navigation">
                    <button class="nav-btn primary" onclick="nextStep()" id="jacketNext" disabled>
                        Continue
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Select Hoodie -->
            <div class="section" id="step2">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-hoodie"></i>
                        Choose Your Hoodie
                    </h2>
                    <p class="section-subtitle">Select from our comfortable hoodie collection</p>
                </div>

                <div class="product-grid" id="hoodieGrid">
                    <!-- Hoodie products will be dynamically inserted here -->
                </div>

                <div class="navigation">
                    <button class="nav-btn" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    <button class="nav-btn primary" onclick="nextStep()" id="hoodieNext" disabled>
                        Continue
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Select Beanie -->
            <div class="section" id="step3">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-hat-winter"></i>
                        Choose Your Beanie
                    </h2>
                    <p class="section-subtitle">Select your winter beanie</p>
                </div>

                <div class="product-grid" id="beanieGrid">
                    <!-- Beanie products will be dynamically inserted here -->
                </div>

                <div class="navigation">
                    <button class="nav-btn" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    <button class="nav-btn primary" onclick="nextStep()" id="beanieNext" disabled>
                        Continue
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Select Gloves -->
            <div class="section" id="step4">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-mitten"></i>
                        Choose Your Gloves
                    </h2>
                    <p class="section-subtitle">Select from our premium Carhartt work gloves</p>
                </div>

                <div class="product-grid" id="glovesGrid">
                    <!-- Gloves products will be dynamically inserted here -->
                </div>

                <div class="navigation">
                    <button class="nav-btn" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    <button class="nav-btn primary" onclick="nextStep()" id="glovesNext" disabled>
                        Continue
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 5: Customize -->
            <div class="section" id="step5">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-palette"></i>
                        Customize Your Gift Box
                    </h2>
                    <p class="section-subtitle">Upload Your Official Company or Organization Logo</p>
                    <p style="color: #dc2626; font-size: 14px; margin-top: 5px; font-style: italic;">
                        This program is exclusively for businesses ordering employee gifts. Personal logos/designs are not accepted.
                    </p>
                </div>

                <div class="upload-area" id="uploadArea" onclick="document.getElementById('logoFile').click()">
                    <input type="file" id="logoFile" accept="image/*,.pdf" style="display: none;" onchange="handleLogoUpload(event)">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Click to upload your company logo</div>
                    <div class="upload-hint">Official business logos only (JPG, PNG, PDF)</div>
                </div>

                <div class="logo-preview" id="logoPreview">
                    <img src="" alt="Logo Preview" class="preview-image" id="previewImage">
                </div>

                <div class="form-row" style="margin-top: 30px;">
                    <div class="form-group">
                        <label class="form-label">Jacket Embroidery Location</label>
                        <select class="form-input" id="jacketEmbLocation">
                            <option value="right-chest" selected>Right Chest (Best for Carhartt)</option>
                            <option value="left-chest">Left Chest (Depends on location of Carhartt Logo and size of your logo)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hoodie Embroidery Location</label>
                        <select class="form-input" id="hoodieEmbLocation">
                            <option value="left-chest" selected>Left Chest (Standard)</option>
                            <option value="right-chest">Right Chest</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Thread Colors (Optional)</label>
                        <input type="text" class="form-input" id="threadColors" placeholder="e.g., Red, White, Blue">
                    </div>
                    <div class="form-group">
                        <div class="form-label" style="color: #666; font-size: 14px;">
                            <i class="fas fa-info-circle"></i>
                            Note: Beanies will have front center embroidery<br>
                            <i class="fas fa-info-circle"></i>
                            Note: Gloves do not receive embroidery
                        </div>
                    </div>
                </div>

                <div class="form-group full">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-input form-textarea" id="specialInstructions" placeholder="Any special requests or notes about your gift box..."></textarea>
                </div>

                <div class="navigation">
                    <button class="nav-btn" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    <button class="nav-btn primary" onclick="nextStep()">
                        Continue
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 6: Delivery Information -->
            <div class="section" id="step6">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-shipping-fast"></i>
                        Delivery Information
                    </h2>
                    <p class="section-subtitle">Tell us where to send your free gift box</p>
                </div>

                <form id="deliveryForm" onsubmit="return false;" autocomplete="off">
                    <!-- Contact Information -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name <span class="required">*</span></label>
                            <input type="text" class="form-input" id="firstName" autocomplete="off" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name <span class="required">*</span></label>
                            <input type="text" class="form-input" id="lastName" autocomplete="off" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Company Name <span class="required">*</span></label>
                            <input type="text" class="form-input" id="companyName" autocomplete="off" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address <span class="required">*</span></label>
                            <input type="email" class="form-input" id="email" autocomplete="off" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number <span class="required">*</span></label>
                            <input type="tel" class="form-input" id="phone"
                                   placeholder="(555) 123-4567"
                                   maxlength="14"
                                   pattern="\([0-9]{3}\) [0-9]{3}-[0-9]{4}"
                                   autocomplete="off"
                                   required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Delivery Date</label>
                            <div class="date-input-wrapper">
                                <input type="date" class="form-input" id="deliveryDate" autocomplete="off" readonly onclick="openCustomCalendar()">
                                <div class="custom-calendar" id="customCalendar"></div>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Minimum 2 weeks production time required (excludes weekends)
                            </small>
                            <div class="date-validation-message" id="dateValidationMessage"></div>
                        </div>
                    </div>

                    <!-- Delivery Method Selection -->
                    <div class="form-group full">
                        <label class="form-label">Delivery Method <span class="required">*</span></label>
                        <div class="delivery-options">
                            <label class="delivery-option">
                                <input type="radio" name="deliveryMethod" value="Ship" checked onchange="toggleDeliveryFields()">
                                <span class="option-content">
                                    <i class="fas fa-shipping-fast"></i>
                                    <span>Ship to Address</span>
                                </span>
                            </label>
                            <label class="delivery-option">
                                <input type="radio" name="deliveryMethod" value="Pickup" onchange="toggleDeliveryFields()">
                                <span class="option-content">
                                    <i class="fas fa-warehouse"></i>
                                    <span>Factory Pickup</span>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Factory Pickup Information -->
                    <div id="pickupInfo" class="pickup-info-box" style="display: none;">
                        <h4><i class="fas fa-map-marker-alt"></i> Pickup Location</h4>
                        <p><strong>Northwest Custom Apparel</strong><br>
                        2025 Freeman Road East<br>
                        Milton, WA 98354</p>
                        <p><i class="fas fa-clock"></i> <strong>Pickup Hours:</strong><br>
                        Monday - Friday: 8:30 AM - 4:45 PM</p>
                        <p class="info-note">
                            <i class="fas fa-info-circle"></i>
                            You'll receive an email when your gift box is ready for pickup.
                        </p>
                    </div>

                    <!-- Shipping Address Fields -->
                    <div id="shippingFields">
                        <div class="form-group full">
                            <label class="form-label">Shipping Address <span class="required">*</span></label>
                            <input type="text" class="form-input" id="address1" placeholder="Street Address" autocomplete="off" required>
                        </div>

                        <div class="form-group full">
                            <input type="text" class="form-input" id="address2" placeholder="Apartment, suite, etc. (Optional)" autocomplete="off">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">City <span class="required">*</span></label>
                                <input type="text" class="form-input" id="city" autocomplete="off" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">State <span class="required">*</span></label>
                                <select class="form-input" id="state" autocomplete="off" required>
                                    <option value="">Select State</option>
                                    <option value="WA">Washington</option>
                                    <option value="OR">Oregon</option>
                                    <option value="CA">California</option>
                                    <option value="ID">Idaho</option>
                                    <option value="MT">Montana</option>
                                    <option value="NV">Nevada</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="UT">Utah</option>
                                    <option value="CO">Colorado</option>
                                    <option value="WY">Wyoming</option>
                                    <!-- Add more states as needed -->
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ZIP Code <span class="required">*</span></label>
                                <input type="text" class="form-input" id="zipCode" pattern="[0-9]{5}" autocomplete="off" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rush Order</label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="rushOrder">
                                    <span>This is a rush order (expedited processing)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Removed Gift Message and Employee Names fields as per feedback -->
                </form>

                <div class="navigation">
                    <button class="nav-btn" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    <button id="reviewBtn" class="nav-btn nav-btn-primary" onclick="nextStep()" style="background: linear-gradient(135deg, #16a34a, #059669); padding: 20px 40px; font-size: 20px; font-weight: 700;">
                        Review Order
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 7: Review & Confirm -->
            <div class="section" id="step7">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-clipboard-check"></i>
                        Review Your Christmas Bundle Order
                    </h2>
                    <p class="section-subtitle">Please review all details before submitting</p>
                </div>

                <!-- New Two-Column Layout -->
                <div class="confirmation-container">
                    <!-- Main Content Column -->
                    <div class="confirmation-main">
                        <!-- Selected Items Card -->
                        <div class="confirmation-card">
                            <h3 class="confirmation-card-title">
                                <i class="fas fa-gift" style="color: #10b981;"></i>
                                Your Gift Box Items
                            </h3>
                            <div id="reviewItems">
                                <!-- Product cards will be populated here -->
                            </div>
                        </div>

                        <!-- Customization Card -->
                        <div class="confirmation-card">
                            <h3 class="confirmation-card-title">
                                <i class="fas fa-palette" style="color: #0284c7;"></i>
                                Customization Details
                            </h3>
                            <div id="reviewCustomization">
                                <!-- Customization grid will be populated here -->
                            </div>
                        </div>

                        <!-- Delivery Information Card -->
                        <div class="confirmation-card">
                            <h3 class="confirmation-card-title">
                                <i class="fas fa-truck" style="color: #dc2626;"></i>
                                Delivery Information
                            </h3>
                            <div id="reviewDelivery">
                                <!-- Delivery info will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Sticky Sidebar -->
                    <div class="confirmation-sidebar">
                        <!-- Order Summary Card -->
                        <div class="summary-total-card">
                            <h4 style="color: #075985; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">
                                <i class="fas fa-tags"></i> Order Summary
                            </h4>
                            <div class="summary-row">
                                <span class="summary-label">Retail Value:</span>
                                <span class="summary-value" id="orderSummaryRetailValue">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label">Your Price:</span>
                                <span class="summary-value free">FREE</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label" style="font-weight: 700;">You Save:</span>
                                <span class="summary-value savings" id="orderSummarySavings">$0.00</span>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button id="submitBtn" class="submit-btn" style="width: 100%; font-size: 18px; padding: 16px; background: linear-gradient(135deg, #16a34a, #15803d);">
                            <i class="fas fa-paper-plane"></i> Submit Order
                        </button>

                        <!-- Previous Button -->
                        <button class="nav-btn" onclick="previousStep()" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-arrow-left"></i> Previous Step
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="order-summary">
            <div class="summary-card">
                <h3 class="summary-header">
                    <i class="fas fa-gift holly"></i> Your Gift Box
                </h3>

                <div class="summary-note">
                    <i class="fas fa-info-circle summary-note-icon"></i>
                    <span class="summary-note-text">This is a FREE promotional gift box!</span>
                </div>

                <div class="summary-items" id="summaryItems">
                    <div class="summary-empty">
                        <div class="summary-empty-icon">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <div>Start building your gift box</div>
                    </div>
                </div>

                <!-- Removed confusing Request Gift Box button that did nothing -->
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content">
            <!-- Close button -->
            <button class="modal-close-btn" onclick="closeModal()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>

            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="success-title">🎉 Order Submitted!</h2>
            <p class="success-message">
                Your FREE Christmas gift box has been confirmed!
            </p>

            <!-- Reference Number - Most prominent -->
            <div class="success-reference">
                <div class="reference-label">Your Order Number</div>
                <div class="reference-number" id="referenceNumber">XMAS1225-001</div>
            </div>

            <!-- Simplified order summary -->
            <div id="orderConfirmationDetails" style="margin: 20px 0; padding: 15px; background: #f9fafb; border-radius: 8px;">
                <!-- Simplified details will go here -->
            </div>

            <!-- Email reminder -->
            <p style="color: #6b7280; font-size: 14px; margin: 15px 0;">
                <i class="fas fa-envelope"></i> Check your email for full order details
            </p>

            <!-- Done button -->
            <button class="nav-btn primary" onclick="closeModal()" style="width: 100%; font-size: 16px; padding: 14px;">
                <i class="fas fa-check"></i> Done
            </button>
        </div>
    </div>

    <!-- Include EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            // Initialize EmailJS with your public key
            emailjs.init("4qSbDO-SQs19TbP80");
        })();

        // Send confirmation email function
        async function sendConfirmationEmail(quoteData, quoteID) {
            try {
                // Format items for email - simplified for Outlook compatibility (NO PRICES)
                const formatItem = (item, type) => {
                    if (!item) return 'Not selected';
                    // Extract the actual values from the selectedItems structure
                    const productName = (item.name || item.style || 'Item').replace(/[^\w\s-]/g, '');
                    const color = (item.selectedColor || 'No color').replace(/[^\w\s-]/g, '');
                    const size = item.selectedSize || 'No size';
                    // Return WITHOUT price since this is a free gift
                    return `${productName}, Color: ${color}, Size: ${size}`;
                };

                // Calculate totals
                const subtotal = calculateTotalPrice() - (RETAIL_PRICES.shipping || 25);
                const total = calculateTotalPrice();

                // Get thread colors from form - clean for email
                const threadColor1 = (document.getElementById('threadColor1')?.value || '').replace(/[^\w\s-]/g, '');
                const threadColor2 = (document.getElementById('threadColor2')?.value || '').replace(/[^\w\s-]/g, '');
                const threadColor3 = (document.getElementById('threadColor3')?.value || '').replace(/[^\w\s-]/g, '');

                // Format embroidery locations - simplified
                const jacketEmbLocation = (quoteData.jacketEmbLocation || document.getElementById('jacketEmbLocation')?.value || 'Standard').replace(/[^\w\s-]/g, '');
                const hoodieEmbLocation = (quoteData.hoodieEmbLocation || document.getElementById('hoodieEmbLocation')?.value || 'Standard').replace(/[^\w\s-]/g, '');
                const embroideryLocation = `Jacket Location: ${jacketEmbLocation} | Hoodie Location: ${hoodieEmbLocation}`;

                // Get custom text - sanitized
                const customText = (document.getElementById('customText')?.value || '').replace(/[<>]/g, '');

                // Sanitize helper function for names and text fields
                const sanitizeText = (text) => {
                    if (!text) return '';
                    return String(text).replace(/[<>\"'&]/g, '').trim();
                };

                // Prepare email template parameters - simplified for Outlook
                const emailParams = {
                    // Customer information - sanitized
                    to_email: sanitizeText(quoteData.email) || 'noreply@nwcustomapparel.com',
                    customer_name: sanitizeText(`${quoteData.firstName || ''} ${quoteData.lastName || ''}`).trim() || 'Customer',
                    company_name: sanitizeText(quoteData.company) || 'Not Provided',

                    // Quote details
                    quote_number: quoteID || 'PENDING',
                    quote_date: new Date().toLocaleDateString('en-US'),

                    // Bundle items
                    jacket_details: formatItem(selectedItems.jacket, 'Jacket'),
                    hoodie_details: formatItem(selectedItems.hoodie, 'Hoodie'),
                    beanie_details: formatItem(selectedItems.beanie, 'Beanie'),
                    gloves_details: formatItem(selectedItems.gloves, 'Gloves'),

                    // Customization details - plain text
                    thread_color_1: threadColor1 || 'Not selected',
                    thread_color_2: threadColor2 || 'Not selected',
                    thread_color_3: threadColor3 || 'Not selected',
                    embroidery_location: embroideryLocation,
                    custom_text: sanitizeText(customText) || 'None',
                    logo_upload: quoteData.imageUpload ? 'Logo uploaded' : 'No logo',

                    // Contact information - sanitized
                    phone: sanitizeText(quoteData.phone) || 'Not Provided',
                    email: sanitizeText(quoteData.email) || 'Not Provided',

                    // Delivery information - clean format
                    delivery_type: quoteData.deliveryMethod || 'Pickup',
                    delivery_date: quoteData.dueDate || 'To Be Determined',
                    address_1: sanitizeText(quoteData.shippingAddress) || 'Not Provided',
                    address_2: '',
                    city: sanitizeText(quoteData.shippingCity) || '',
                    state: sanitizeText(quoteData.shippingState) || '',
                    zip: sanitizeText(quoteData.shippingZip) || '',

                    // Pricing - plain numbers for Outlook
                    subtotal: String(subtotal.toFixed(2)),
                    shipping: String((RETAIL_PRICES.shipping || 25).toFixed(2)),
                    gift_box: String((RETAIL_PRICES.giftBox || 9).toFixed(2)),
                    total: String(total.toFixed(2)),

                    // Additional fields - sanitized
                    special_instructions: sanitizeText(quoteData.specialInstructions || document.getElementById('specialInstructions')?.value) || 'None',
                    quantity: String(calculateTotalQuantity()),

                    // Default values to prevent corruption - always provide safe strings
                    reply_to: sanitizeText(quoteData.email) || 'noreply@nwcustomapparel.com',
                    from_name: 'Northwest Custom Apparel',
                    company_phone: '253-922-5793',
                    company_year: '1977',

                    // Add safe defaults for any fields the template might use
                    sales_rep: 'Sales Team',
                    valid_days: '30'
                };

                // Send email using EmailJS
                const response = await emailjs.send(
                    'service_1c4k67j',  // Service ID
                    'template_v80ysfp',  // Template ID for Xmas Bundle
                    emailParams
                );

                console.log('Email sent successfully:', response);
                return { success: true, response };

            } catch (error) {
                console.error('Failed to send confirmation email:', error);
                // Don't throw error to prevent blocking order submission
                return { success: false, error: error.toString() };
            }
        }
    </script>

    <!-- Include Product Search Service -->
    <script src="product-search-service.js"></script>

    <!-- Include Quote Service -->
    <!-- <script src="calculators/christmas-bundle-service.js"></script> --> <!-- Removed to fix duplicate class declaration -->

    <script>
        // Console safety wrapper for mobile devices (especially iOS Safari)
        // This prevents JavaScript from breaking when console.log is called without dev tools open
        (function() {
            if (!window.console) {
                window.console = {};
            }
            // Store original functions if they exist
            const originalConsole = {
                log: window.console.log || function() {},
                warn: window.console.warn || function() {},
                error: window.console.error || function() {},
                info: window.console.info || function() {},
                debug: window.console.debug || function() {}
            };

            // Wrap console methods to prevent errors on mobile
            ['log', 'warn', 'error', 'info', 'debug'].forEach(function(method) {
                window.console[method] = function() {
                    try {
                        // Only call original if it exists and we're in a safe environment
                        if (originalConsole[method] && typeof originalConsole[method] === 'function') {
                            originalConsole[method].apply(console, arguments);
                        }
                    } catch (e) {
                        // Silently fail on mobile if console is not available
                    }
                };
            });
        })();

        // Mobile Debug Helper - Creates visible debug output on mobile devices
        window.mobileDebug = {
            enabled: false,
            logs: [],
            maxLogs: 50,

            init: function() {
                // Create debug panel if it doesn't exist
                if (!document.getElementById('mobileDebugPanel')) {
                    const panel = document.createElement('div');
                    panel.id = 'mobileDebugPanel';
                    panel.style.cssText = `
                        position: fixed;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        max-height: 200px;
                        overflow-y: auto;
                        background: rgba(0, 0, 0, 0.9);
                        color: #0f0;
                        font-family: monospace;
                        font-size: 10px;
                        padding: 10px;
                        z-index: 99999;
                        display: none;
                        border-top: 2px solid #0f0;
                    `;
                    document.body.appendChild(panel);
                }
            },

            log: function(message, type = 'log') {
                if (!this.enabled) return;

                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;

                this.logs.push(logEntry);
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }

                const panel = document.getElementById('mobileDebugPanel');
                if (panel) {
                    panel.style.display = 'block';
                    panel.innerHTML = this.logs.join('<br>');
                    panel.scrollTop = panel.scrollHeight;
                }

                // Also log to console
                console[type](message);
            },

            error: function(message) {
                this.log(message, 'error');
            },

            warn: function(message) {
                this.log(message, 'warn');
            },

            clear: function() {
                this.logs = [];
                const panel = document.getElementById('mobileDebugPanel');
                if (panel) {
                    panel.innerHTML = '';
                }
            },

            toggle: function() {
                this.enabled = !this.enabled;
                const panel = document.getElementById('mobileDebugPanel');
                if (panel) {
                    panel.style.display = this.enabled ? 'block' : 'none';
                }
                if (this.enabled) {
                    this.log('Mobile debug enabled');
                }
            }
        };

        // Initialize mobile debug on page load (disabled by default)
        if (window.location.search.includes('debug=true')) {
            window.mobileDebug.init();
            window.mobileDebug.enabled = true;
            window.mobileDebug.log('Mobile debug mode activated');
        }

        // API Configuration
        const API_BASE = 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api';

        // Product Data (will be populated from API)
        const products = {
            jackets: [],
            hoodies: [],
            beanies: [],
            gloves: []
        };

        // Retail pricing structure for value display
        const RETAIL_PRICES = {
            jackets: {
                'CT100617': 92,  // Rain Defender
                'CT103828': 137, // Detroit (Duck Detroit Jacket)
                'CT104670': 174  // Storm Defender (Shoreline Jacket)
            },
            hoodies: 58,
            beanies: 35,
            gloves: 19,
            giftBox: 9,
            shipping: 25
        };

        // Cache for size upcharges from API
        const sizeUpchargeCache = {};

        // Product style numbers to fetch
        const PRODUCT_STYLES = {
            jackets: ['CT104670', 'CT100617', 'CT103828'],
            hoodies: ['CTK121', 'F281'],
            beanies: ['CT104597'],
            gloves: ['CTGD0794']
        };

        // State Management
        let currentStep = 1;
        let highestStepReached = 1;  // Track the furthest step user has reached
        let lastStepNavigationTime = 0;  // Track last navigation to prevent rapid advancement
        let userHasInteracted = false;  // Track if user has actually interacted with the page
        let selectedItems = {
            jacket: null,
            hoodie: null,
            beanie: null,
            gloves: null,
            logo: null,
            customization: {},
            delivery: {}
        };

        // Image Zoom Modal Functions
        function openZoomModal(imageSrc) {
            const modal = document.getElementById('imageZoomModal');
            const zoomImage = document.getElementById('zoomImage');

            zoomImage.src = imageSrc;
            modal.classList.add('active');

            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeZoomModal() {
            const modal = document.getElementById('imageZoomModal');
            modal.classList.remove('active');

            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Close modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeZoomModal();
            }
        });

        // Fetch size upcharges from API
        async function fetchSizeUpcharges(styleNumber) {
            // Check cache first
            if (sizeUpchargeCache[styleNumber]) {
                console.log(`[Size Upcharges] Using cached data for ${styleNumber}`);
                return sizeUpchargeCache[styleNumber];
            }

            try {
                const response = await fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/size-pricing?styleNumber=${styleNumber}`);

                if (!response.ok) {
                    console.warn(`[Size Upcharges] Failed to fetch for ${styleNumber}:`, response.status);
                    return null;
                }

                const data = await response.json();

                if (data && data.length > 0) {
                    // Extract upcharges from first color (all colors have same upcharges)
                    const upcharges = data[0].sizeUpcharges || {};
                    console.log(`[Size Upcharges] Fetched for ${styleNumber}:`, upcharges);

                    // Cache the result
                    sizeUpchargeCache[styleNumber] = upcharges;
                    return upcharges;
                }

                return null;
            } catch (error) {
                console.error(`[Size Upcharges] Error fetching for ${styleNumber}:`, error);
                return null;
            }
        }

        // Calculate value including size upcharges
        function calculateItemValue(styleNumber, size, basePrice) {
            const upcharges = sizeUpchargeCache[styleNumber] || {};
            const upcharge = upcharges[size] || 0;
            return basePrice + upcharge;
        }

        // Show error banner for API failures
        function showErrorBanner(message) {
            const existingBanner = document.querySelector('.error-banner');
            if (existingBanner) {
                existingBanner.remove();
            }

            const banner = document.createElement('div');
            banner.className = 'error-banner';
            banner.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #ef4444;
                color: white;
                padding: 15px 30px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 10000;
                font-weight: 500;
                animation: slideDown 0.3s ease-out;
            `;
            banner.textContent = message;

            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(banner);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                banner.remove();
            }, 5000);
        }

        // Floating Continue Button Functions
        function showFloatingContinue() {
            const floatingBtn = document.getElementById('floatingContinue');
            floatingBtn.classList.add('show');
        }

        function hideFloatingContinue() {
            const floatingBtn = document.getElementById('floatingContinue');
            floatingBtn.classList.remove('show');
        }

        function clickActiveContinueButton() {
            // Find and click the active step's Continue button
            const activeStep = document.querySelector('.step-content:not([style*="display: none"])');
            if (activeStep) {
                const continueBtn = activeStep.querySelector('.nav-btn.primary');
                if (continueBtn && !continueBtn.disabled) {
                    continueBtn.click();
                }
            }
        }

        function showSelectionHelper() {
            const helper = document.getElementById('selectionHelper');
            helper.classList.add('show');

            // Hide after 3 seconds
            setTimeout(() => {
                helper.classList.remove('show');
            }, 3000);
        }

        // Initialize
        // Christmas Bundle Quote Service
        class ChristmasBundleQuoteService {
            constructor() {
                this.apiBase = 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com';
            }

            generateQuoteID() {
                const date = new Date();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const sequence = Math.floor(Math.random() * 100) + 1;
                return `XMAS${month}${day}-${sequence}`;
            }

            async submitQuote(quoteData) {
                const quoteID = this.generateQuoteID();
                const sessionID = `xmas_sess_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                // Create quote session
                const expiresAtDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
                const formattedExpiresAt = expiresAtDate.toISOString().replace(/\.\d{3}Z$/, '');

                const sessionData = {
                    QuoteID: quoteID,
                    SessionID: sessionID,
                    Status: 'Sample Request',
                    CustomerName: `${quoteData.firstName} ${quoteData.lastName}`,
                    CompanyName: quoteData.company,
                    CustomerEmail: quoteData.email,
                    Phone: quoteData.phone,
                    TotalQuantity: quoteData.totalQuantity || 1,
                    SubtotalAmount: quoteData.totalPrice || 0,
                    LTMFeeTotal: 0,
                    TotalAmount: quoteData.totalPrice || 0,
                    ExpiresAt: formattedExpiresAt,
                    Notes: 'Christmas Gift Box Bundle Order'
                };

                try {
                    // Create session with 10-second timeout
                    const sessionController = new AbortController();
                    const sessionTimeoutId = setTimeout(() => sessionController.abort(), 10000);

                    const sessionResponse = await fetch(`${this.apiBase}/api/quote_sessions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sessionData),
                        signal: sessionController.signal
                    });

                    clearTimeout(sessionTimeoutId);

                    if (!sessionResponse.ok) {
                        console.error('Session creation failed:', sessionResponse.statusText);
                    }

                    // Create bundle configuration JSON with color information
                    const bundleConfig = {
                        jacket: quoteData.jacketStyle ? `${quoteData.jacketStyle} - ${quoteData.jacketSize || 'N/A'} - ${quoteData.jacketColor || 'N/A'}` : '',
                        hoodie: quoteData.hoodieStyle ? `${quoteData.hoodieStyle} - ${quoteData.hoodieSize || 'N/A'} - ${quoteData.hoodieColor || 'N/A'}` : '',
                        beanie: quoteData.beanieStyle ? `${quoteData.beanieStyle} - ${quoteData.beanieColor || 'N/A'}` : '',
                        gloves: quoteData.glovesStyle ? `${quoteData.glovesStyle} - ${quoteData.glovesSize || 'N/A'} - ${quoteData.glovesColor || 'N/A'}` : ''
                    };

                    // Log bundle configuration for debugging
                    console.log('Bundle configuration being saved:', bundleConfig);
                    console.log('Beanie data from quoteData:', {
                        style: quoteData.beanieStyle,
                        color: quoteData.beanieColor
                    });
                    console.log('Gloves data from quoteData:', {
                        style: quoteData.glovesStyle,
                        size: quoteData.glovesSize,
                        color: quoteData.glovesColor
                    });
                    console.log('JSON stringified:', JSON.stringify(bundleConfig));

                    // Create quote item with all fields
                    const itemData = {
                        QuoteID: quoteID,
                        LineNumber: 1,
                        StyleNumber: 'XMAS-BUNDLE',
                        ProductName: 'Christmas Gift Box Bundle',
                        Quantity: quoteData.totalQuantity || 1,
                        FinalUnitPrice: quoteData.unitPrice || 0,
                        LineTotal: quoteData.totalPrice || 0,

                        // Customer Information (using correct field names)
                        First: quoteData.firstName,
                        Last: quoteData.lastName,
                        Email: quoteData.email,
                        Phone: quoteData.phone,
                        Company: quoteData.company,

                        // Delivery Information (using correct field names)
                        DeliveryMethod: quoteData.deliveryMethod,
                        Shipping_Address: quoteData.shippingAddress || '',
                        Shipping_City: quoteData.shippingCity || '',
                        Shipping_State: quoteData.shippingState || '',
                        Shipping_Zip: quoteData.shippingZip || '',

                        // Customization
                        EmbroideryLocation: `Jacket: ${quoteData.jacketEmbLocation || 'N/A'}, Hoodie: ${quoteData.hoodieEmbLocation || 'N/A'}`,
                        Thread_Colors: quoteData.threadColors || '',
                        Image_Upload: quoteData.imageUpload || '', // ExternalKey from file upload

                        // Bundle details and special instructions
                        BundleConfiguration: JSON.stringify(bundleConfig),
                        Notes: quoteData.specialInstructions || quoteData.description || 'Christmas Gift Box Bundle',

                        // Additional Fields
                        RushOrder: quoteData.rushOrder ? true : false,
                        DeliveryDate: quoteData.dueDate || ''
                    };

                    // Log the item data being sent
                    console.log('Sending item data to API:', itemData);
                    console.log('BundleConfiguration field:', itemData.BundleConfiguration);

                    // Create item with 10-second timeout
                    const itemController = new AbortController();
                    const itemTimeoutId = setTimeout(() => itemController.abort(), 10000);

                    const itemResponse = await fetch(`${this.apiBase}/api/quote_items`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData),
                        signal: itemController.signal
                    });

                    clearTimeout(itemTimeoutId);

                    if (!itemResponse.ok) {
                        const errorText = await itemResponse.text();
                        console.error('Item creation failed:', itemResponse.statusText, errorText);
                        console.error('Failed item data:', itemData);
                        console.error('API endpoint used:', `${this.apiBase}/api/quote_items`);
                        // Still return success for quote creation even if item fails
                        return { success: true, quoteID, warning: 'Item creation failed but quote was created' };
                    } else {
                        const itemResult = await itemResponse.json();
                        console.log('Item created successfully:', itemResult);
                    }

                    return { success: true, quoteID };
                } catch (error) {
                    console.error('Error submitting quote:', error);
                    return { success: false, error: error.message };
                }
            }
        }

        // Flag to prevent double submissions - make it global for easier debugging
        window.isSubmitting = false;

        // Helper function to update submission progress
        function updateSubmissionProgress(stepName, message) {
            const overlay = document.getElementById('submissionOverlay');
            const messageEl = overlay.querySelector('.submission-message');
            const steps = overlay.querySelectorAll('.submission-step');

            steps.forEach(step => {
                const stepData = step.getAttribute('data-step');
                if (stepData === stepName) {
                    step.classList.add('active');
                    step.classList.remove('complete');
                } else if (step.classList.contains('active')) {
                    step.classList.remove('active');
                    step.classList.add('complete');
                }
            });

            if (messageEl && message) {
                messageEl.textContent = message;
            }
        }

        // Submit Order Function - Make it globally accessible
        window.submitOrder = async function(button) {
            // Debug log for mobile
            if (window.mobileDebug) {
                window.mobileDebug.log('submitOrder function called');
            }

            // Prevent submission within first 2 seconds of page load
            if (window.pageLoadTime && Date.now() - window.pageLoadTime < 2000) {
                console.warn('Preventing submission within 2 seconds of page load');
                return;
            }

            // Verify we're on Step 7 before allowing submission
            if (currentStep !== 7) {
                console.error('Submit called but not on Step 7. Current step:', currentStep);
                alert('Please complete all steps before submitting your order.');
                return;
            }

            // Detect automated submission attempts
            if (!userHasInteracted) {
                console.error('No user interaction detected - blocking automated submission');
                alert('Please interact with the form before submitting.');
                return;
            }

            // Check if navigation was suspiciously fast (reached Step 7 in under 5 seconds)
            if (window.pageLoadTime && Date.now() - window.pageLoadTime < 5000) {
                console.warn('Reached Step 7 suspiciously fast - possible automation');
                // Still allow but log for debugging
            }

            // Prevent double submissions
            if (window.isSubmitting) {
                console.log('Already submitting, ignoring duplicate click');
                return;
            }

            try {
                window.isSubmitting = true;

                // Show loading overlay immediately
                const overlay = document.getElementById('submissionOverlay');
                overlay.classList.add('active');

                // Set a 30-second timeout to auto-recover if submission gets stuck
                const submissionTimeout = setTimeout(() => {
                    if (window.isSubmitting) {
                        console.warn('[Submit] 20s failsafe triggered — auto-recovering UI');
                        finalizeSubmission();
                        alert('The submission is taking longer than expected. Please try again or contact support at 253-922-5793.');
                    }
                }, 20000);

                // Start with validation step
                updateSubmissionProgress('validate', 'Validating your order details...');

                // Small delay to show the overlay
                await new Promise(resolve => setTimeout(resolve, 300));
                // Validate required fields
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;

                if (!firstName || !lastName || !email || !phone) {
                    overlay.classList.remove('active');
                    window.isSubmitting = false;
                    clearTimeout(submissionTimeout);
                    alert('Please fill in all required contact information');
                    return;
                }

                // Validate shipping fields if shipping is selected
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value;
                if (deliveryMethod === 'Ship') {
                    const address = document.getElementById('address1')?.value;
                    const city = document.getElementById('city')?.value;
                    const state = document.getElementById('state')?.value;
                    const zipCode = document.getElementById('zipCode')?.value;

                    if (!address || !city || !state || !zipCode) {
                        overlay.classList.remove('active');
                        window.isSubmitting = false;
                        clearTimeout(submissionTimeout);
                        alert('Please fill in all required shipping information including ZIP code');
                        console.warn('Missing shipping fields:', { address, city, state, zipCode });
                        return;
                    }
                }

                // Update button to show processing state (but not disabled)
                const submitBtn = button || document.getElementById('submitBtn');
                const originalButtonHTML = submitBtn ? submitBtn.innerHTML : '';
                if (submitBtn) {
                    submitBtn.classList.add('processing');
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                }

                // CRITICAL FIX: Centralized cleanup function to ensure UI always resets
                const finalizeSubmission = () => {
                    try {
                        const overlayEl = document.getElementById('submissionOverlay');
                        if (overlayEl) overlayEl.classList.remove('active');
                    } catch (e) {
                        console.warn('[Submit] overlay finalize error:', e);
                    }
                    try {
                        window.isSubmitting = false;
                    } catch (e) {
                        console.warn('[Submit] flag finalize error:', e);
                    }
                    try {
                        if (typeof submissionTimeout !== 'undefined') clearTimeout(submissionTimeout);
                    } catch (e) {
                        console.warn('[Submit] timeout finalize error:', e);
                    }
                    try {
                        const btn = button || document.getElementById('submitBtn');
                        if (btn) {
                            btn.classList.remove('processing');
                            btn.innerHTML = originalButtonHTML || '<i class="fas fa-paper-plane"></i> Submit Order';
                        }
                    } catch (e) {
                        console.warn('[Submit] button finalize error:', e);
                    }
                };

            // Upload logo if present
            let imageExternalKey = null;
            if (window.selectedLogoFile) {
                updateSubmissionProgress('logo', 'Uploading your logo...');
                await new Promise(resolve => setTimeout(resolve, 200));
                imageExternalKey = await uploadFileToAPI(window.selectedLogoFile);
            } else {
                // Skip logo step if no logo
                const logoStep = document.querySelector('.submission-step[data-step="logo"]');
                if (logoStep) {
                    logoStep.style.display = 'none';
                }
            }

            // Collect all form data
            const quoteData = {
                // Customer Info
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phone,
                company: document.getElementById('companyName').value,

                // Delivery Info
                deliveryMethod: document.querySelector('input[name="deliveryMethod"]:checked').value,
                shippingAddress: document.getElementById('address1')?.value,
                shippingCity: document.getElementById('city')?.value,
                shippingState: document.getElementById('state')?.value,
                shippingZip: document.getElementById('zipCode')?.value,

                // Customization
                jacketEmbLocation: document.getElementById('jacketEmbLocation')?.value,
                hoodieEmbLocation: document.getElementById('hoodieEmbLocation')?.value,
                threadColors: document.getElementById('threadColors')?.value,
                specialInstructions: document.getElementById('specialInstructions')?.value,
                imageUpload: imageExternalKey,

                // Bundle Contents with color
                jacketStyle: selectedItems.jacket?.id,
                jacketSize: selectedItems.jacket?.selectedSize,
                jacketColor: selectedItems.jacket?.selectedColor,
                hoodieStyle: selectedItems.hoodie?.id,
                hoodieSize: selectedItems.hoodie?.selectedSize,
                hoodieColor: selectedItems.hoodie?.selectedColor,
                beanieStyle: selectedItems.beanie?.id,
                beanieColor: selectedItems.beanie?.selectedColor,
                glovesStyle: selectedItems.gloves?.id,
                glovesSize: selectedItems.gloves?.selectedSize,
                glovesColor: selectedItems.gloves?.selectedColor,

                // Additional Info
                rushOrder: document.getElementById('rushOrder')?.checked,
                dueDate: document.getElementById('deliveryDate')?.value,

                // Totals
                totalQuantity: calculateTotalQuantity(),
                totalPrice: calculateTotalPrice(),
                unitPrice: calculateUnitPrice(),
                description: generateBundleDescription()
            };

            // Log the quote data before submission
            console.log('Complete quote data being submitted:', quoteData);
            console.log('Selected items:', selectedItems);
            console.log('Selected items - beanie specifically:', {
                full: selectedItems.beanie,
                id: selectedItems.beanie?.id,
                color: selectedItems.beanie?.selectedColor
            });

            // Log shipping details specifically
            console.log('Shipping details being submitted:', {
                deliveryMethod: quoteData.deliveryMethod,
                address: quoteData.shippingAddress,
                city: quoteData.shippingCity,
                state: quoteData.shippingState,
                zip: quoteData.shippingZip,
                dueDate: quoteData.dueDate
            });

            // Log if any items are missing
            if (!selectedItems.jacket?.id) console.warn('Jacket not selected or missing ID');
            if (!selectedItems.hoodie?.id) console.warn('Hoodie not selected or missing ID');
            if (!selectedItems.beanie?.id) console.warn('Beanie not selected or missing ID');
            if (!selectedItems.gloves?.id) console.warn('Gloves not selected or missing ID:', selectedItems.gloves);

            // Submit to API
            updateSubmissionProgress('quote', 'Creating your quote...');
            await new Promise(resolve => setTimeout(resolve, 200));
            const quoteService = new ChristmasBundleQuoteService();
            const result = await quoteService.submitQuote(quoteData);

            if (result.success) {
                // Send confirmation email with 10-second timeout
                updateSubmissionProgress('email', 'Sending confirmation email...');
                await new Promise(resolve => setTimeout(resolve, 200));
                const emailResult = await Promise.race([
                    sendConfirmationEmail(quoteData, result.quoteID),
                    new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Email timeout after 10 seconds')), 10000)
                    )
                ]);

                if (!emailResult.success) {
                    console.error('Email failed to send:', emailResult.error);
                    // Still show success modal even if email fails
                }

                // Hide overlay
                const overlay = document.getElementById('submissionOverlay');
                overlay.classList.remove('active');

                // Clear the timeout since submission completed successfully
                clearTimeout(submissionTimeout);

                // Schedule cleanup FIRST so it happens even if the modal throws
                setTimeout(() => {
                    try { resetForm(); } catch (e) { console.error('[Submit] resetForm error:', e); }
                    finalizeSubmission();
                }, 3000);

                // Show success modal (do not allow this to block cleanup)
                try {
                    showSuccessModal(result.quoteID);
                } catch (e) {
                    console.error('[Submit] showSuccessModal error:', e);
                    // Cleanup still scheduled above
                }
            } else {
                alert('There was an error submitting your order. Please try again.');
                finalizeSubmission();
            }
            } catch (error) {
                // Comprehensive error handling for mobile
                console.error('Error in submitOrder:', error);

                // Show user-friendly error message
                let errorMessage = 'An error occurred while submitting your order. ';
                if (!navigator.onLine) {
                    errorMessage += 'Please check your internet connection and try again.';
                } else if (error.message && error.message.includes('network')) {
                    errorMessage += 'Network error. Please check your connection and try again.';
                } else {
                    errorMessage += 'Please try again or contact support at 253-922-5793.';
                }

                alert(errorMessage);
                finalizeSubmission();
            }
        }

        // Helper functions for order submission
        function calculateTotalQuantity() {
            let total = 0;
            if (selectedItems.jacket) total++;
            if (selectedItems.hoodie) total++;
            if (selectedItems.beanie) total++;
            if (selectedItems.gloves) total++;
            return total;
        }

        function calculateTotalPrice() {
            // Calculate the actual retail value of the bundle
            let total = 0;

            // Use the global selectedItems object which contains the actual selected products
            if (selectedItems.jacket && selectedItems.jacket.retailPrice) {
                total += selectedItems.jacket.retailPrice;
            }
            if (selectedItems.hoodie && selectedItems.hoodie.retailPrice) {
                total += selectedItems.hoodie.retailPrice;
            }
            if (selectedItems.beanie && selectedItems.beanie.retailPrice) {
                total += selectedItems.beanie.retailPrice;
            }
            if (selectedItems.gloves && selectedItems.gloves.retailPrice) {
                total += selectedItems.gloves.retailPrice;
            }

            // Add gift box and shipping (from RETAIL_PRICES)
            total += RETAIL_PRICES.giftBox || 9;   // Gift box
            total += RETAIL_PRICES.shipping || 25; // Shipping

            // Return the total retail value
            return total;
        }

        function calculateUnitPrice() {
            // For a bundle, return the full bundle value
            return calculateTotalPrice();
        }

        function generateBundleDescription() {
            const items = [];
            if (selectedItems.jacket) items.push(`Jacket: ${selectedItems.jacket.id}`);
            if (selectedItems.hoodie) items.push(`Hoodie: ${selectedItems.hoodie.id}`);
            if (selectedItems.beanie) items.push(`Beanie: ${selectedItems.beanie.id}`);
            if (selectedItems.gloves) items.push(`Gloves: ${selectedItems.gloves.id}`);
            return items.join(', ') || 'Christmas Gift Box';
        }

        // Populate Review Data for Step 7
        function populateReviewData() {
            // Update Order Summary values
            const retailValue = calculateRetailValue();
            const retailValueElement = document.getElementById('orderSummaryRetailValue');
            const savingsElement = document.getElementById('orderSummarySavings');

            if (retailValueElement) {
                retailValueElement.textContent = `$${retailValue.toFixed(2)}`;
            }
            if (savingsElement) {
                savingsElement.textContent = `$${retailValue.toFixed(2)}`;
            }

            // Populate Selected Items with new compact card design
            const reviewItemsDiv = document.getElementById('reviewItems');
            reviewItemsDiv.innerHTML = '';

            const itemTypes = [
                { key: 'jacket', label: 'Jacket', icon: '🧥' },
                { key: 'hoodie', label: 'Hoodie', icon: '👔' },
                { key: 'beanie', label: 'Beanie', icon: '🧢' },
                { key: 'gloves', label: 'Gloves', icon: '🧤' }
            ];

            // All 4 items are required now, so display them all with images
            itemTypes.forEach(type => {
                const item = selectedItems[type.key];
                if (item) {
                    // Get the image URL - prefer color-specific image if available
                    let imageUrl = '';
                    if (item.selectedColorData && item.selectedColorData.MAIN_IMAGE_URL) {
                        imageUrl = item.selectedColorData.MAIN_IMAGE_URL;
                    } else if (item.selectedColorData && item.selectedColorData.FRONT_FLAT) {
                        imageUrl = item.selectedColorData.FRONT_FLAT;
                    } else if (item.image) {
                        imageUrl = item.image;
                    } else {
                        // Fallback placeholder
                        imageUrl = 'https://via.placeholder.com/80x80/f3f4f6/9ca3af?text=' + type.label;
                    }

                    // Get color hex code for swatch
                    let colorHex = '#e5e7eb';
                    if (item.selectedColorData && item.selectedColorData.HEX_CODE) {
                        colorHex = item.selectedColorData.HEX_CODE;
                    } else if (item.selectedColorCode) {
                        colorHex = item.selectedColorCode;
                    }

                    // Create compact product card
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'product-item-card';
                    itemDiv.innerHTML = `
                        <div class="product-item-image">
                            <img src="${imageUrl}" alt="${item.name || type.label}" onerror="this.src='https://via.placeholder.com/80x80/f3f4f6/9ca3af?text=${type.label}'">
                        </div>
                        <div class="product-item-details">
                            <div class="product-item-name">${item.name || item.id || 'Product'}</div>
                            <div class="product-item-meta">
                                <div class="product-item-meta-row">
                                    <span>Color:</span>
                                    <span class="review-color-swatch" style="background-color: ${colorHex};"></span>
                                    <span>${item.selectedColor || 'Not selected'}</span>
                                </div>
                                ${type.key !== 'beanie' ? `
                                <div class="product-item-meta-row">
                                    <span>Size: ${item.selectedSize || 'Not selected'}</span>
                                </div>` : '<div class="product-item-meta-row"><span>Size: One Size</span></div>'}
                            </div>
                        </div>
                        <div class="product-item-price">
                            ${item.retailPrice ? `<div class="retail-price">$${item.retailPrice.toFixed(2)}</div>` : ''}
                            <div class="free-tag">FREE</div>
                        </div>
                    `;
                    reviewItemsDiv.appendChild(itemDiv);
                }
            });

            // Populate Customization Details with improved layout
            const reviewCustomDiv = document.getElementById('reviewCustomization');
            const logoFile = document.getElementById('logoFile').files[0];
            const jacketLoc = document.getElementById('jacketEmbLocation')?.value || 'Standard';
            const hoodieLoc = document.getElementById('hoodieEmbLocation')?.value || 'Standard';
            const threadColors = document.getElementById('threadColors')?.value || 'Not specified';
            const specialInstructions = document.getElementById('specialInstructions')?.value || 'None';

            // Format thread colors properly
            const formattedThreadColors = threadColors ?
                threadColors.split(/\s+and\s+|\s+/)
                    .filter(color => color.length > 0)
                    .map(color => color.charAt(0).toUpperCase() + color.slice(1))
                    .join(', ') : 'Not specified';

            // Build customization HTML with new grid layout
            let customizationHTML = '<div class="customization-grid">';

            // Logo section - spans 2 columns if logo exists
            if (logoFile) {
                customizationHTML += `
                    <div class="logo-preview-container">
                        <div class="customization-label">Company Logo</div>
                        <div class="customization-value">${logoFile.name}</div>
                        ${window.selectedLogoDataURL ?
                            `<img src="${window.selectedLogoDataURL}" class="logo-preview-image" alt="Company Logo">` :
                            '<div id="logoPreviewPlaceholder"></div>'}
                    </div>
                `;
            }

            // Thread colors
            customizationHTML += `
                <div class="customization-item">
                    <div class="customization-label">Thread Colors</div>
                    <div class="customization-value">${formattedThreadColors}</div>
                </div>
            `;

            // Jacket embroidery location
            customizationHTML += `
                <div class="customization-item">
                    <div class="customization-label">Jacket Embroidery</div>
                    <div class="customization-value">${jacketLoc}</div>
                </div>
            `;

            // Hoodie embroidery location
            customizationHTML += `
                <div class="customization-item">
                    <div class="customization-label">Hoodie Embroidery</div>
                    <div class="customization-value">${hoodieLoc}</div>
                </div>
            `;

            // Special instructions - spans full width if present
            if (specialInstructions && specialInstructions !== 'None') {
                customizationHTML += `
                    <div class="customization-item" style="grid-column: span 2;">
                        <div class="customization-label">Special Instructions</div>
                        <div class="customization-value">${specialInstructions}</div>
                    </div>
                `;
            }

            customizationHTML += '</div>';
            reviewCustomDiv.innerHTML = customizationHTML;

            // Load logo preview if file exists and dataURL not ready
            if (logoFile && !window.selectedLogoDataURL) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    window.selectedLogoDataURL = e.target.result;
                    const placeholder = document.getElementById('logoPreviewPlaceholder');
                    if (placeholder) {
                        placeholder.outerHTML = `<img src="${e.target.result}" class="logo-preview-image" alt="Company Logo">`;
                    }
                };
                reader.readAsDataURL(logoFile);
            }

            // Populate Delivery Information with compact layout
            const reviewDeliveryDiv = document.getElementById('reviewDelivery');
            const firstName = document.getElementById('firstName').value || '';
            const lastName = document.getElementById('lastName').value || '';
            const company = document.getElementById('companyName').value || '';
            const email = document.getElementById('email').value || '';
            const phone = document.getElementById('phone').value || '';
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'Not selected';
            const deliveryDate = document.getElementById('deliveryDate')?.value || 'Not specified';

            // Build compact delivery info
            let deliveryHTML = '<div class="delivery-info-compact">';

            // Contact person
            deliveryHTML += `
                <div class="delivery-info-item">
                    <div class="delivery-info-icon">
                        <i class="fas fa-user"></i> Contact
                    </div>
                    <div class="delivery-info-value">${firstName} ${lastName}</div>
                    ${company ? `<div class="delivery-info-value" style="font-size: 13px; font-weight: 400; color: #6b7280;">${company}</div>` : ''}
                </div>
            `;

            // Communication
            deliveryHTML += `
                <div class="delivery-info-item">
                    <div class="delivery-info-icon">
                        <i class="fas fa-envelope"></i> Communication
                    </div>
                    <div class="delivery-info-value">${email}</div>
                    <div class="delivery-info-value" style="font-size: 13px; font-weight: 400; color: #6b7280;">${phone}</div>
                </div>
            `;

            // Delivery details
            deliveryHTML += `
                <div class="delivery-info-item">
                    <div class="delivery-info-icon">
                        <i class="fas fa-${deliveryMethod === 'Ship' ? 'truck' : 'building'}"></i> Delivery
                    </div>
                    <div class="delivery-info-value">${deliveryMethod}</div>
                    ${deliveryDate !== 'Not specified' ? `<div class="delivery-info-value" style="font-size: 13px; font-weight: 400; color: #6b7280;">By: ${new Date(deliveryDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>` : ''}
                </div>
            `;

            deliveryHTML += '</div>';

            // Add shipping address separately if Ship is selected
            if (deliveryMethod === 'Ship') {
                const address1 = document.getElementById('address1')?.value || '';
                const address2 = document.getElementById('address2')?.value || '';
                const city = document.getElementById('city')?.value || '';
                const state = document.getElementById('state')?.value || '';
                const zip = document.getElementById('zipCode')?.value || '';

                if (address1 && city && state) {
                    deliveryHTML += `
                        <div style="margin-top: 15px; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 3px solid #dc2626;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #6b7280; font-size: 14px;">
                                <i class="fas fa-map-marker-alt" style="color: #dc2626;"></i>
                                <span style="font-weight: 600;">Shipping Address</span>
                            </div>
                            <div style="font-size: 14px; color: #1f2937; line-height: 1.5;">
                                ${address1}<br>
                                ${address2 ? address2 + '<br>' : ''}
                                ${city}, ${state} ${zip}
                            </div>
                        </div>
                    `;
                }
            }

            reviewDeliveryDiv.innerHTML = deliveryHTML;
        }

        function showSuccessModal(quoteID) {
            const modal = document.getElementById('successModal');
            const referenceNumber = document.getElementById('referenceNumber');

            // Display the quote ID prominently
            referenceNumber.textContent = quoteID;
            referenceNumber.style.cssText = 'font-size: 28px; font-weight: 700; color: #16a34a; background: #f0fdf4; padding: 15px 25px; border-radius: 8px; border: 2px solid #16a34a; letter-spacing: 1px;';

            // Populate SIMPLIFIED order confirmation details
            const orderDetails = document.getElementById('orderConfirmationDetails');
            let detailsHTML = '';

            // Calculate total value for display
            let totalRetailValue = 0;
            if (selectedItems.jacket && selectedItems.jacket.retailPrice) totalRetailValue += selectedItems.jacket.retailPrice;
            if (selectedItems.hoodie && selectedItems.hoodie.retailPrice) totalRetailValue += selectedItems.hoodie.retailPrice;
            if (selectedItems.beanie && selectedItems.beanie.retailPrice) totalRetailValue += selectedItems.beanie.retailPrice;
            if (selectedItems.gloves && selectedItems.gloves.retailPrice) totalRetailValue += selectedItems.gloves.retailPrice;
            totalRetailValue += RETAIL_PRICES.giftBox;
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked');
            if (deliveryMethod && deliveryMethod.value === 'Ship') {
                totalRetailValue += RETAIL_PRICES.shipping;
            }

            // Show ONLY simplified summary - much shorter!
            detailsHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: #6b7280; font-size: 14px;">Bundle Items:</span>
                    <span style="color: #374151; font-weight: 600;">4 items</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: #6b7280; font-size: 14px;">Total Value:</span>
                    <span style="text-decoration: line-through; color: #9ca3af;">$${totalRetailValue}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #6b7280; font-size: 14px;">Your Price:</span>
                    <span style="color: #16a34a; font-weight: 700; font-size: 18px;">FREE!</span>
                </div>
            `;

            orderDetails.innerHTML = detailsHTML;
            modal.classList.add('active');
        }

        function resetForm() {
            // Reset to step 1
            currentStep = 1;
            highestStepReached = 1;
            selectedItems = { jacket: null, hoodie: null, beanie: null, gloves: null, logo: null };

            // Clear form fields
            document.querySelectorAll('.form-input').forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });

            // Reset file upload
            window.selectedLogoFile = null;
            document.getElementById('logoFile').value = '';
            document.getElementById('logoPreview').classList.remove('active');

            // Update display
            updateProgress();
            updateSummary();

            // Close modal
            document.getElementById('successModal').classList.remove('active');
        }

        // Function to attach submit button handlers (called when Step 7 loads)
        function attachSubmitHandlers() {
            // CRITICAL: Verify we're actually on Step 7 before attaching handlers
            if (currentStep !== 7) {
                console.warn('attachSubmitHandlers called but not on Step 7. Current step:', currentStep);
                return;
            }

            // Also verify Step 7 is actually visible
            const step7Element = document.getElementById('step7');
            if (!step7Element || !step7Element.classList.contains('active')) {
                console.warn('attachSubmitHandlers called but Step 7 is not visible');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn && !submitBtn.hasAttribute('data-handlers-attached')) {
                // Define handler functions
                function handleSubmitClick(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Prevent double submission on devices that fire both touch and click
                    if (e.detail > 1) return;
                    if (window.mobileDebug) window.mobileDebug.log('Submit button clicked');
                    window.submitOrder(submitBtn);
                }

                function handleSubmitTouch(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (window.mobileDebug) window.mobileDebug.log('Submit button touched');
                    // Prevent the click event from also firing
                    submitBtn.removeEventListener('click', handleSubmitClick);
                    window.submitOrder(submitBtn);
                    // Re-add click listener after a short delay
                    setTimeout(function() {
                        submitBtn.addEventListener('click', handleSubmitClick);
                    }, 500);
                }

                // Store handlers on the button element for later removal if needed
                submitBtn._handleSubmitClick = handleSubmitClick;
                submitBtn._handleSubmitTouch = handleSubmitTouch;

                // Add event listeners
                submitBtn.addEventListener('click', handleSubmitClick);
                submitBtn.addEventListener('touchend', handleSubmitTouch);

                // Mark as attached to prevent duplicates
                submitBtn.setAttribute('data-handlers-attached', 'true');
                console.log('Submit button handlers attached successfully');
            }
        }

        // Global reset function for customer support
        window.resetSubmission = function() {
            window.isSubmitting = false;
            const overlay = document.getElementById('submissionOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('processing');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Order';
            }
            console.log('Submission state has been reset. You can now submit your order.');
            return 'Ready to submit';
        };

        // Phone number formatting function
        function formatPhoneNumber(value) {
            // Remove all non-digit characters
            const phoneNumber = value.replace(/\D/g, '');

            // Format based on length
            if (phoneNumber.length === 0) {
                return '';
            } else if (phoneNumber.length <= 3) {
                return `(${phoneNumber}`;
            } else if (phoneNumber.length <= 6) {
                return `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3)}`;
            } else if (phoneNumber.length <= 10) {
                return `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3, 6)}-${phoneNumber.slice(6)}`;
            } else {
                // Limit to 10 digits
                return `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3, 6)}-${phoneNumber.slice(6, 10)}`;
            }
        }

        // Initialize phone formatting
        function initializePhoneFormatting() {
            const phoneInput = document.getElementById('phone');
            if (!phoneInput) return;

            phoneInput.addEventListener('input', function(e) {
                const cursorPosition = e.target.selectionStart;
                const previousValue = e.target.value;
                const formattedValue = formatPhoneNumber(e.target.value);

                e.target.value = formattedValue;

                // Adjust cursor position intelligently
                if (formattedValue.length > previousValue.length) {
                    // Adding characters - move cursor forward
                    const diff = formattedValue.length - previousValue.length;
                    e.target.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
                } else if (formattedValue.length < previousValue.length) {
                    // Removing characters - adjust cursor
                    let newPosition = cursorPosition;

                    // If we just deleted a formatting character, move cursor back one more
                    if (previousValue[cursorPosition - 1] === ' ' ||
                        previousValue[cursorPosition - 1] === '-' ||
                        previousValue[cursorPosition - 1] === '(' ||
                        previousValue[cursorPosition - 1] === ')') {
                        newPosition = Math.max(0, cursorPosition - 1);
                    }

                    e.target.setSelectionRange(newPosition, newPosition);
                }
            });

            // Handle paste event
            phoneInput.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const formattedValue = formatPhoneNumber(pastedText);
                e.target.value = formattedValue;
            });

            // Prevent non-numeric input on mobile
            phoneInput.addEventListener('keypress', function(e) {
                const char = String.fromCharCode(e.which);
                if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 46) {
                    e.preventDefault();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // CRITICAL: Force page to start at Step 1 and prevent auto-navigation
            currentStep = 1;
            highestStepReached = 1;

            // Hide all steps except Step 1
            for (let i = 1; i <= 7; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    if (i === 1) {
                        stepElement.classList.add('active');
                    } else {
                        stepElement.classList.remove('active');
                    }
                }

                // Reset progress indicators
                const progressStep = document.querySelector(`[data-step="${i}"]`);
                if (progressStep) {
                    if (i === 1) {
                        progressStep.classList.add('active');
                        progressStep.classList.remove('completed');
                    } else {
                        progressStep.classList.remove('active');
                        progressStep.classList.remove('completed');
                    }
                }
            }

            // Ensure submission overlay is hidden on page load
            window.isSubmitting = false;
            const overlay = document.getElementById('submissionOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                overlay.style.display = 'none';
                setTimeout(() => {
                    overlay.style.display = '';
                }, 100);
            }

            // Prevent form submission for first 2 seconds after page load
            window.pageLoadTime = Date.now();

            // Track user interaction - add listeners for actual user events
            document.addEventListener('click', function() {
                if (!userHasInteracted) {
                    console.log('User interaction detected');
                    userHasInteracted = true;
                }
            }, { once: true });

            document.addEventListener('touchstart', function() {
                if (!userHasInteracted) {
                    console.log('User touch interaction detected');
                    userHasInteracted = true;
                }
            }, { once: true });

            // Clear all form fields on page load to prevent autofill issues
            const deliveryForm = document.getElementById('deliveryForm');
            if (deliveryForm) {
                deliveryForm.reset();
                // Also clear individual fields to be sure
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
                document.getElementById('companyName').value = '';
                document.getElementById('email').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('address1').value = '';
                document.getElementById('address2').value = '';
                document.getElementById('city').value = '';
                document.getElementById('state').value = '';
                document.getElementById('zipCode').value = '';
            }

            initializeSnowEffect();
            showLoadingState();
            await loadChristmasProducts();
            renderProducts();
            setupDragDrop();
            updateSummary();

            // Initialize phone number formatting
            initializePhoneFormatting();

            // Show scroll indicator on first step
            showScrollIndicator();

            // NOTE: Submit button event listeners are now attached in attachSubmitHandlers()
            // when Step 7 is reached, not on page load. This prevents accidental triggering.

            // Initialize delivery date field with 2 weeks minimum
            initializeDeliveryDate();
        });

        // Calendar state variables
        let currentCalendarMonth = new Date();
        let selectedCalendarDate = null;
        let minSelectableDate = null;

        // Initialize delivery date with custom calendar
        function initializeDeliveryDate() {
            const dateInput = document.getElementById('deliveryDate');
            if (!dateInput) return;

            // Calculate minimum date (2 weeks from today, skip weekends)
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            minSelectableDate = new Date(today);
            minSelectableDate.setDate(minSelectableDate.getDate() + 14);

            // If minimum date is weekend, move to next Monday
            while (isWeekend(minSelectableDate)) {
                minSelectableDate.setDate(minSelectableDate.getDate() + 1);
            }

            // Set initial selected date to minimum selectable date
            selectedCalendarDate = new Date(minSelectableDate);
            dateInput.value = formatDate(selectedCalendarDate);

            // Initialize calendar
            currentCalendarMonth = new Date(minSelectableDate.getFullYear(), minSelectableDate.getMonth(), 1);
            renderCalendar();

            // Close calendar when clicking outside
            document.addEventListener('click', function(e) {
                const calendar = document.getElementById('customCalendar');
                const dateWrapper = document.querySelector('.date-input-wrapper');
                if (!dateWrapper.contains(e.target)) {
                    calendar.classList.remove('show');
                }
            });
        }

        // Format date for input (YYYY-MM-DD)
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Check if date is a weekend
        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday or Saturday
        }

        // Check if date is within the 2-week buffer
        function isWithinBuffer(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const bufferEnd = new Date(today);
            bufferEnd.setDate(bufferEnd.getDate() + 13); // 13 days + today = 14 days

            return date < bufferEnd;
        }

        // Check if date is selectable
        function isDateSelectable(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Can't select past dates
            if (date < today) return false;

            // Can't select weekends
            if (isWeekend(date)) return false;

            // Can't select dates within 2-week buffer
            if (isWithinBuffer(date)) return false;

            return true;
        }

        // Open custom calendar
        function openCustomCalendar() {
            const calendar = document.getElementById('customCalendar');

            // Ensure we have a selected date and calendar opens to its month
            if (selectedCalendarDate) {
                // Set calendar to the month of the selected date
                currentCalendarMonth = new Date(selectedCalendarDate.getFullYear(), selectedCalendarDate.getMonth(), 1);
            } else if (minSelectableDate) {
                // Fallback to minimum selectable date's month
                currentCalendarMonth = new Date(minSelectableDate.getFullYear(), minSelectableDate.getMonth(), 1);
                selectedCalendarDate = new Date(minSelectableDate);
                const dateInput = document.getElementById('deliveryDate');
                dateInput.value = formatDate(selectedCalendarDate);
            }

            calendar.classList.add('show');
            renderCalendar();
        }

        // Close custom calendar
        function closeCustomCalendar() {
            const calendar = document.getElementById('customCalendar');
            calendar.classList.remove('show');
        }

        // Render the calendar
        function renderCalendar() {
            const calendar = document.getElementById('customCalendar');
            if (!calendar) return;

            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            const firstDayOfWeek = firstDay.getDay();
            const lastDateOfMonth = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];

            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)" ${!canNavigateToPrevMonth() ? 'disabled' : ''}>‹</button>
                    <div class="calendar-month-year">${monthNames[month]} ${year}</div>
                    <button class="calendar-nav" onclick="changeMonth(1)">›</button>
                </div>
                <div class="calendar-grid">
            `;

            // Day headers
            const dayHeaders = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // Previous month days
            for (let i = firstDayOfWeek; i > 0; i--) {
                const date = prevLastDate - i + 1;
                html += `<div class="calendar-day other-month disabled">${date}</div>`;
            }

            // Current month days
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let date = 1; date <= lastDateOfMonth; date++) {
                const currentDate = new Date(year, month, date);
                currentDate.setHours(0, 0, 0, 0);

                let classes = ['calendar-day'];

                // Check if today
                if (currentDate.getTime() === today.getTime()) {
                    classes.push('today');
                }

                // Check if selected
                if (selectedCalendarDate && currentDate.getTime() === selectedCalendarDate.getTime()) {
                    classes.push('selected');
                }

                // Check if weekend
                if (isWeekend(currentDate)) {
                    classes.push('weekend');
                }

                // Check if within buffer period
                if (isWithinBuffer(currentDate)) {
                    classes.push('buffer-period');
                    classes.push('disabled');
                }

                // Check if past date
                if (currentDate < today) {
                    classes.push('disabled');
                }

                // Check if selectable
                const selectable = isDateSelectable(currentDate);
                if (!selectable) {
                    classes.push('disabled');
                }

                const onclick = selectable ? `onclick="selectDate(${year}, ${month}, ${date})"` : '';

                html += `<div class="${classes.join(' ')}" ${onclick}>${date}</div>`;
            }

            // Next month days
            const remainingDays = 42 - (firstDayOfWeek + lastDateOfMonth); // 6 rows * 7 days
            for (let date = 1; date <= remainingDays; date++) {
                html += `<div class="calendar-day other-month disabled">${date}</div>`;
            }

            html += `
                </div>
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color available"></div>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color buffer"></div>
                        <span>2-week buffer</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color weekend"></div>
                        <span>Weekend</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color unavailable"></div>
                        <span>Unavailable</span>
                    </div>
                </div>
            `;

            calendar.innerHTML = html;
        }

        // Check if can navigate to previous month
        function canNavigateToPrevMonth() {
            const today = new Date();
            const currentYear = currentCalendarMonth.getFullYear();
            const currentMonth = currentCalendarMonth.getMonth();

            return currentYear > today.getFullYear() ||
                   (currentYear === today.getFullYear() && currentMonth > today.getMonth());
        }

        // Change calendar month
        function changeMonth(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            renderCalendar();
        }

        // Select a date from calendar
        function selectDate(year, month, date) {
            selectedCalendarDate = new Date(year, month, date);
            const dateInput = document.getElementById('deliveryDate');
            dateInput.value = formatDate(selectedCalendarDate);

            // Clear any validation messages
            const validationMessage = document.getElementById('dateValidationMessage');
            validationMessage.classList.remove('show');

            renderCalendar();
            closeCustomCalendar();
        }

        // Validate selected date (for form submission)
        function validateDeliveryDate() {
            const dateInput = document.getElementById('deliveryDate');
            const validationMessage = document.getElementById('dateValidationMessage');

            // If no date selected, use the default (2 weeks out)
            if (!dateInput.value) {
                // Calculate minimum date again
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let defaultDate = new Date(today);
                defaultDate.setDate(defaultDate.getDate() + 14);

                // Skip weekends
                while (isWeekend(defaultDate)) {
                    defaultDate.setDate(defaultDate.getDate() + 1);
                }

                // Set the default date
                dateInput.value = formatDate(defaultDate);
                selectedCalendarDate = defaultDate;

                // Clear any error messages since we're providing a valid default
                validationMessage.classList.remove('show');
                return true;
            }

            const selectedDate = new Date(dateInput.value);

            if (!isDateSelectable(selectedDate)) {
                validationMessage.textContent = 'Selected date is not available. Please choose a weekday at least 2 weeks from today.';
                validationMessage.classList.add('show');
                return false;
            }

            validationMessage.classList.remove('show');
            return true;
        }

        // Show scroll indicator function
        function showScrollIndicator() {
            const indicator = document.getElementById('scrollIndicator');
            if (currentStep === 1 || currentStep === 2) {
                indicator.classList.add('show');

                // Hide indicator when user scrolls
                let hasScrolled = false;
                const handleScroll = () => {
                    if (!hasScrolled && window.scrollY > 50) {
                        hasScrolled = true;
                        indicator.classList.remove('show');
                        window.removeEventListener('scroll', handleScroll);
                    }
                };
                window.addEventListener('scroll', handleScroll);
            } else {
                indicator.classList.remove('show');
            }
        }

        // Show loading state
        function showLoadingState() {
            const grids = ['jacketGrid', 'hoodieGrid', 'beanieGrid'];
            grids.forEach(gridId => {
                const grid = document.getElementById(gridId);
                if (grid) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 20px; color: #666;">Loading products...</p>
                        </div>
                    `;
                }
            });
        }

        // Load products from API
        async function loadChristmasProducts() {
            try {
                // First, fetch size upcharges for all products
                const allStyles = Object.values(PRODUCT_STYLES).flat();
                const upchargePromises = allStyles.map(style => fetchSizeUpcharges(style));
                await Promise.all(upchargePromises);
                console.log('[Size Upcharges] All upcharges fetched:', sizeUpchargeCache);

                for (const [category, styles] of Object.entries(PRODUCT_STYLES)) {
                    const categoryProducts = [];

                    for (const style of styles) {
                        try {
                            // Fetch product data with colors from single endpoint
                            const response = await fetch(`/api/product-colors?styleNumber=${style}`);
                            const result = await response.json();

                            if (result && result.colors) {
                                let colors = result.colors || [];
                                const productTitle = result.productTitle || '';
                                const productDescription = result.PRODUCT_DESCRIPTION || result.description || '';

                                // Skip inventory validation for initial load to improve performance
                                // Instead, use hardcoded exclusions for known problematic colors

                                // Hardcoded exclusion list for colors with known zero inventory
                                const EXCLUDED_COLORS = {
                                    'CTK121': ['Dark Brown'] // This color has zero inventory
                                };

                                // Apply exclusions if this product has known issues
                                if (EXCLUDED_COLORS[style]) {
                                    const excludedList = EXCLUDED_COLORS[style];
                                    const originalCount = colors.length;

                                    colors = colors.filter(color => {
                                        const colorName = color.COLOR_NAME || color.CATALOG_COLOR || '';
                                        const isExcluded = excludedList.some(excluded =>
                                            colorName.toLowerCase().includes(excluded.toLowerCase())
                                        );

                                        if (isExcluded) {
                                            console.log(`Excluding ${colorName} for ${style} - known zero inventory`);
                                        }

                                        return !isExcluded;
                                    });

                                    if (colors.length === 0) {
                                        console.warn(`Product ${style} has no available colors after exclusions`);
                                        categoryProducts.push(createFallbackProduct(style, category));
                                        continue;
                                    }
                                }

                                // Extract product name from title (format: "Name. StyleNumber")
                                const productName = productTitle.split('.')[0].trim() || `Style ${style}`;

                                // Set price as FREE but get retail value for display
                                let productPrice = 'FREE';
                                let retailPrice = 0;

                                // Get retail price based on product type and style
                                if (category === 'jackets' && RETAIL_PRICES.jackets[style]) {
                                    retailPrice = RETAIL_PRICES.jackets[style];
                                } else if (category === 'hoodies') {
                                    retailPrice = RETAIL_PRICES.hoodies;
                                } else if (category === 'beanies') {
                                    retailPrice = RETAIL_PRICES.beanies;
                                } else if (category === 'gloves') {
                                    retailPrice = RETAIL_PRICES.gloves;
                                }

                                // Get first color's image as the main product image
                                const mainImage = colors[0]?.MAIN_IMAGE_URL ||
                                                colors[0]?.FRONT_MODEL ||
                                                colors[0]?.FRONT_FLAT ||
                                                null;

                                // Get actual sizes from API for this product
                                let sizes = [];
                                if (category === 'beanies') {
                                    sizes = ['One Size'];
                                } else if (category === 'gloves') {
                                    // Gloves only come in M, L, XL
                                    sizes = ['M', 'L', 'XL'];
                                } else {
                                    // Fetch actual sizes from API using first color
                                    const apiSizes = await fetchDefaultSizesForProduct(style, colors);
                                    if (apiSizes && apiSizes.length > 0) {
                                        sizes = apiSizes;
                                    } else {
                                        // Fallback sizes if API fails - but limited based on product type
                                        console.warn(`Using fallback sizes for ${style}`);
                                        if (style === 'F281') {
                                            // F281 specifically only goes to 4XL
                                            sizes = ['S', 'M', 'L', 'XL', '2XL', '3XL', '4XL'];
                                        } else if (category === 'jackets' || category === 'hoodies') {
                                            // Default jacket/hoodie sizes - conservative approach
                                            sizes = ['S', 'M', 'L', 'XL', '2XL', '3XL', '4XL'];
                                        } else {
                                            sizes = ['S', 'M', 'L', 'XL', '2XL', '3XL'];
                                        }
                                    }
                                }

                                categoryProducts.push({
                                    id: style,
                                    name: productName,
                                    description: productDescription,
                                    price: productPrice,
                                    retailPrice: retailPrice,
                                    image: mainImage,
                                    colors: colors, // These now include COLOR_SQUARE_IMAGE
                                    sizes: sizes,
                                    rawData: result
                                });
                            } else {
                                console.warn(`Could not load product ${style}: No color data available`);
                                categoryProducts.push(createFallbackProduct(style, category));
                            }
                        } catch (error) {
                            console.error(`Error fetching ${style}:`, error);
                            categoryProducts.push(createFallbackProduct(style, category));
                        }
                    }

                    products[category] = categoryProducts;
                }
            } catch (error) {
                console.error('Error loading products:', error);
                // Use fallback products
                loadFallbackProducts();
            }
        }

        // Create fallback product
        function createFallbackProduct(style, category) {
            const fallbackNames = {
                'CT104670': 'Carhartt Storm Defender Shoreline Jacket',
                'CT100617': 'Carhartt Rain Defender Jacket',
                'CT103828': 'Carhartt Duck Detroit Jacket',
                'CTK121': 'Carhartt Midweight Hoodie',
                'F281': 'Sport-Tek Super Heavyweight Hoodie',
                'CT104597': 'Carhartt Watch Cap 2.0'
            };

            // Get retail price for fallback product
            let retailPrice = 0;
            if (category === 'jackets' && RETAIL_PRICES.jackets[style]) {
                retailPrice = RETAIL_PRICES.jackets[style];
            } else if (category === 'hoodies') {
                retailPrice = RETAIL_PRICES.hoodies;
            } else if (category === 'beanies') {
                retailPrice = RETAIL_PRICES.beanies;
            } else if (category === 'gloves') {
                retailPrice = RETAIL_PRICES.gloves;
            }

            return {
                id: style,
                name: fallbackNames[style] || `Product ${style}`,
                price: 'FREE',
                retailPrice: retailPrice,
                image: null,
                colors: [
                    { COLOR_NAME: 'Black', COLOR_SQUARE_IMAGE: null, HEX_CODE: '#000000' },
                    { COLOR_NAME: 'Navy', COLOR_SQUARE_IMAGE: null, HEX_CODE: '#1e3a8a' }
                ],
                sizes: category === 'beanies' ? ['One Size'] :
                      style === 'F281' ? ['S', 'M', 'L', 'XL', '2XL', '3XL', '4XL'] : // F281 only goes to 4XL
                      ['S', 'M', 'L', 'XL', '2XL', '3XL', '4XL'] // Conservative default
            };
        }

        // Load fallback products
        function loadFallbackProducts() {
            products.jackets = PRODUCT_STYLES.jackets.map(style => createFallbackProduct(style, 'jackets'));
            products.hoodies = PRODUCT_STYLES.hoodies.map(style => createFallbackProduct(style, 'hoodies'));
            products.beanies = PRODUCT_STYLES.beanies.map(style => createFallbackProduct(style, 'beanies'));
            products.gloves = PRODUCT_STYLES.gloves.map(style => createFallbackProduct(style, 'gloves'));
        }

        // Snow Effect
        function initializeSnowEffect() {
            const snowOverlay = document.getElementById('snowOverlay');
            const snowflakeCount = 50;

            for (let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.innerHTML = '❄';
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.animationDuration = Math.random() * 3 + 2 + 's';
                snowflake.style.opacity = Math.random();
                snowflake.style.fontSize = Math.random() * 10 + 10 + 'px';
                snowflake.style.animationDelay = Math.random() * 2 + 's';
                snowOverlay.appendChild(snowflake);
            }
        }

        // Render Products
        function renderProducts() {
            renderJackets();
            renderHoodies();
            renderBeanies();
            renderGloves();
        }

        function renderJackets() {
            const grid = document.getElementById('jacketGrid');
            grid.innerHTML = '';

            products.jackets.forEach(product => {
                grid.appendChild(createProductCard(product, 'jacket'));
            });
        }

        function renderHoodies() {
            const grid = document.getElementById('hoodieGrid');
            grid.innerHTML = '';

            products.hoodies.forEach(product => {
                grid.appendChild(createProductCard(product, 'hoodie'));
            });
        }

        function renderBeanies() {
            const grid = document.getElementById('beanieGrid');
            grid.innerHTML = '';

            products.beanies.forEach(product => {
                grid.appendChild(createProductCard(product, 'beanie'));
            });
        }

        function renderGloves() {
            const grid = document.getElementById('glovesGrid');
            grid.innerHTML = '';

            // Add specific gloves data if not already loaded
            if (products.gloves.length === 0) {
                // Create default gloves product
                products.gloves = [{
                    id: 'CTGD0794',
                    name: 'Carhartt® High-Dexterity Open-Cuff Glove',
                    price: 'FREE',
                    retailPrice: RETAIL_PRICES.gloves,
                    description: 'Premium insulated work gloves included FREE with your gift box',
                    image: 'https://cdnm.sanmar.com/imglib/mresjpg/2024/f5/CTGD0794_blackbarley_glove_main.jpg',
                    colors: [
                        {
                            COLOR_NAME: 'Black Barley',
                            COLOR_CODE: 'BLACKBARLEY',
                            COLOR_SWATCH_IMG: null
                        }
                    ],
                    sizes: ['M', 'L', 'XL']
                }];
            }

            products.gloves.forEach(product => {
                grid.appendChild(createProductCard(product, 'gloves'));
            });
        }

        // Create Product Card
        function createProductCard(product, type) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.productId = product.id;
            card.dataset.productType = type;

            // Check if this product is already selected
            const isSelected = selectedItems[type]?.id === product.id;

            // Add selected class if this product is selected
            if (isSelected) {
                card.classList.add('selected');
            }

            // Generate size buttons from actual API data
            const sizeButtons = createSizeButtons(product);

            // Generate color swatches from actual API data
            const colorSwatches = createColorSwatches(product);

            const buttonText = isSelected ? 'Change Selection' : `Select This ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const buttonClass = isSelected ? 'select-btn selected' : 'select-btn';

            card.innerHTML = `
                <div class="product-image" ${product.image ? `onclick="openZoomModal('${product.image}')"` : ''}>
                    ${product.image ?
                        `<img src="${product.image}" alt="${product.name}" loading="lazy" onerror="this.src='/placeholder.jpg'">` :
                        `<div class="placeholder"><i class="fas fa-${type === 'jacket' ? 'tshirt' : type === 'hoodie' ? 'hoodie' : 'hat-winter'}"></i></div>`
                    }
                    <div class="selected-badge">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
                <div class="product-info">
                    <div class="product-style">${product.id}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">
                        ${product.retailPrice ? `<span class="retail-value">$${product.retailPrice} value</span>` : ''}
                        <span class="free-badge">FREE!</span>
                    </div>
                    ${product.description ? `<div class="product-description" title="${product.description}">${product.description.substring(0, 100)}${product.description.length > 100 ? '...' : ''}</div>` : ''}

                    <div class="selection-group">
                        <div class="selection-label">Select Color:<span class="required-indicator">*</span></div>
                        <div class="color-grid color-swatches">
                            ${colorSwatches}
                        </div>
                    </div>

                    <div class="selection-group">
                        <div class="selection-label">Select Size:<span class="required-indicator">*</span></div>
                        <div class="size-grid">
                            ${sizeButtons}
                        </div>
                    </div>

                    <button class="${buttonClass}" onclick="selectProduct('${product.id}', '${type}')">
                        ${buttonText}
                    </button>
                </div>
            `;

            // Add click handler to the whole card after innerHTML is set
            card.addEventListener('click', function(e) {
                // Don't trigger if clicking on buttons or interactive elements
                if (!e.target.closest('.size-btn') && !e.target.closest('.color-swatch') && !e.target.closest('.select-btn') && !e.target.closest('.product-image')) {
                    selectProduct(product.id, type);
                }
            });

            // Auto-select OSFA for beanie since it's the only size option
            if (type === 'beanie') {
                setTimeout(() => {
                    const osfaBtn = card.querySelector('.size-btn[data-size="OSFA"]');
                    if (osfaBtn && !card.querySelector('.size-btn.selected')) {
                        console.log('Auto-selecting OSFA for beanie');
                        osfaBtn.click();
                    }
                }, 100);
            }

            // Auto-select single options after card is fully rendered
            // This handles both beanies (OSFA) and gloves (Black Barley) automatically
            setTimeout(() => {
                autoSelectSingleOptions(card);
                // Update the button state based on current selections
                updateProductButtonState(card);
            }, 100);

            return card;
        }

        // Create size buttons from API data
        function createSizeButtons(product) {
            const sizes = product.sizes || [];

            // Handle different size formats
            if (Array.isArray(sizes) && sizes.length > 0) {
                return sizes.map(size => {
                    const sizeCode = typeof size === 'string' ? size : (size.code || size.name || size);
                    return `<button class="size-btn" data-size="${sizeCode}" onclick="selectSize(event, '${product.id}')">${sizeCode}</button>`;
                }).join('');
            }

            // Fallback
            return '<button class="size-btn" data-size="One Size" onclick="selectSize(event, \'' + product.id + '\')">One Size</button>';
        }

        // Create color swatches from API data
        function createColorSwatches(product) {
            const colors = product.colors || [];

            if (Array.isArray(colors) && colors.length > 0) {
                return colors.map(color => {
                    // Extract data from API response
                    const colorName = color.COLOR_NAME || color.name || 'Unknown';
                    const colorCode = color.CATALOG_COLOR || color.code || colorName;
                    const swatchImage = color.COLOR_SQUARE_IMAGE || '';
                    const hexColor = color.HEX_CODE || color.hex || '#cccccc';

                    // Store additional image URLs for this color
                    const colorImages = {
                        main: color.MAIN_IMAGE_URL || '',
                        frontModel: color.FRONT_MODEL || '',
                        backModel: color.BACK_MODEL || '',
                        frontFlat: color.FRONT_FLAT || '',
                        backFlat: color.BACK_FLAT || ''
                    };

                    // Always prefer the actual swatch image from API
                    const swatchStyle = swatchImage ?
                        `background-image: url('${swatchImage}');` :
                        `background-color: ${hexColor};`;

                    return `
                        <div class="color-swatch"
                             data-color="${colorName}"
                             data-color-code="${colorCode}"
                             data-color-images='${JSON.stringify(colorImages)}'
                             onclick="selectColor(event, '${product.id}')"
                             title="${colorName}">
                            <div class="swatch-image" style="${swatchStyle}"></div>
                            <div class="swatch-name">${colorName}</div>
                        </div>
                    `;
                }).join('');
            }

            // Fallback with basic colors
            return `
                <div class="color-swatch" data-color="Black" onclick="selectColor(event, '${product.id}')" title="Black">
                    <div class="swatch-image" style="background-color: #000000"></div>
                    <div class="swatch-name">Black</div>
                </div>
                <div class="color-swatch" data-color="Navy" onclick="selectColor(event, '${product.id}')" title="Navy">
                    <div class="swatch-image" style="background-color: #1e3a8a"></div>
                    <div class="swatch-name">Navy</div>
                </div>
            `;
        }

        // Get Color Hex (fallback for when no swatch image is available)
        function getColorHex(colorName) {
            const colors = {
                'Black': '#000000',
                'Navy': '#1e3a8a',
                'Dark Gray': '#6b7280',
                'Brown': '#92400e',
                'Carhartt Brown': '#8b4513',
                'Heather Gray': '#9ca3af',
                'Carbon Heather': '#4b5563',
                'Athletic Heather': '#d1d5db',
                'Dark Green': '#14532d',
                'Coal Heather': '#374151',
                'White': '#ffffff',
                'Red': '#dc2626'
            };
            return colors[colorName] || '#cccccc';
        }

        // Auto-select single options to reduce user clicks
        function autoSelectSingleOptions(card) {
            const productType = card.dataset.productType;
            const productId = card.dataset.productId;

            // Auto-select single size option
            const sizeButtons = card.querySelectorAll('.size-btn');
            if (sizeButtons.length === 1) {
                const singleSizeBtn = sizeButtons[0];
                const size = singleSizeBtn.dataset.size;

                // Mark as selected
                singleSizeBtn.classList.add('selected');

                console.log(`[Auto-Select] ${productType} ${productId}: Auto-selected single size option '${size}'`);

                // For beanies with OSFA, we could optionally add visual indicator
                if (size === 'One Size' || size === 'OSFA') {
                    singleSizeBtn.style.pointerEvents = 'none'; // Make it non-clickable since it's the only option
                    singleSizeBtn.style.opacity = '1'; // Keep it fully visible
                }
            }

            // Auto-select single color option
            const colorSwatches = card.querySelectorAll('.color-swatch');
            if (colorSwatches.length === 1) {
                const singleColorSwatch = colorSwatches[0];
                const colorName = singleColorSwatch.dataset.colorName;

                // Mark as selected
                singleColorSwatch.classList.add('selected');

                console.log(`[Auto-Select] ${productType} ${productId}: Auto-selected single color option '${colorName}'`);

                // For gloves with only Black Barley
                if (productType === 'gloves') {
                    singleColorSwatch.style.pointerEvents = 'none'; // Make it non-clickable since it's the only option
                }
            }

            // Check if product is now complete (has all required selections)
            const isComplete = isProductSelectionComplete(card);
            if (isComplete) {
                // Enable the select button since all options are auto-selected
                const selectBtn = card.querySelector('.select-btn');
                if (selectBtn) {
                    selectBtn.disabled = false;
                    console.log(`[Auto-Select] ${productType} ${productId}: Product ready for selection with auto-selected options`);
                }
            }
        }

        // Check if a product card has all required selections
        function isProductSelectionComplete(card) {
            // Check size selection if size options exist
            const sizeGrid = card.querySelector('.size-grid');
            if (sizeGrid) {
                const selectedSize = card.querySelector('.size-btn.selected');
                if (!selectedSize) return false;
            }

            // Check color selection if color options exist
            const colorOptions = card.querySelector('.color-options');
            if (colorOptions) {
                const selectedColor = card.querySelector('.color-swatch.selected');
                if (!selectedColor) return false;
            }

            return true;
        }

        // Selection Functions
        function selectSize(event, productId) {
            event.stopPropagation();
            const button = event.target;
            const card = button.closest('.product-card');
            const selectedSize = button.dataset.size;

            // Clear other size selections in this card
            card.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');

            // Update the retail value display with size upcharge
            const type = card.dataset.productType;
            const product = products[type + 's']?.find(p => p.id === productId);

            if (product && product.id) {
                // Get base retail price
                let basePrice = 0;
                if (type === 'jacket' && RETAIL_PRICES.jackets[product.id]) {
                    basePrice = RETAIL_PRICES.jackets[product.id];
                } else if (type === 'hoodie') {
                    basePrice = RETAIL_PRICES.hoodies;
                } else if (type === 'beanie') {
                    basePrice = RETAIL_PRICES.beanies;
                } else if (type === 'gloves') {
                    basePrice = RETAIL_PRICES.gloves;
                }

                // Add size upcharge
                const upcharges = sizeUpchargeCache[product.id] || {};
                const upcharge = upcharges[selectedSize] || 0;
                const totalValue = basePrice + upcharge;

                // Update the retail value display on the card
                const retailValueElement = card.querySelector('.retail-value');
                if (retailValueElement) {
                    retailValueElement.textContent = `$${totalValue} value`;

                    // Add visual feedback for upcharge
                    if (upcharge > 0) {
                        retailValueElement.title = `Base: $${basePrice} + Size upcharge: $${upcharge}`;
                    } else {
                        retailValueElement.title = '';
                    }
                }

                console.log(`[Value Update] ${type} ${product.id} size ${selectedSize}: $${basePrice} + $${upcharge} = $${totalValue}`);
            }

            // If this product is already selected, update the continue button state
            if (card.classList.contains('selected')) {
                const type = card.dataset.productType;
                // Re-run selectProduct to update the selection with the size
                selectProduct(productId, type);
            }

            // Update the Select button state to reflect the new selection
            updateProductButtonState(card);
        }

        async function selectColor(event, productId) {
            event.stopPropagation();
            const swatch = event.target.closest('.color-swatch');
            const card = swatch.closest('.product-card');

            // IMPORTANT: Capture the currently selected size BEFORE any DOM updates
            const previouslySelectedSize = card.querySelector('.size-btn.selected')?.dataset.size;

            // Clear other color selections in this card
            card.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            swatch.classList.add('selected');

            // Update product image based on selected color
            const colorImages = swatch.dataset.colorImages;
            if (colorImages) {
                try {
                    const images = JSON.parse(colorImages);
                    const productImage = card.querySelector('.product-image img');

                    // Use the first available image from the color
                    const newImage = images.main || images.frontModel || images.frontFlat;

                    if (productImage && newImage) {
                        productImage.src = newImage;
                        productImage.alt = swatch.dataset.color + ' - ' + productId;
                        // Update the zoom modal onclick
                        const productImageDiv = card.querySelector('.product-image');
                        if (productImageDiv) {
                            productImageDiv.setAttribute('onclick', `openZoomModal('${newImage}')`);
                        }
                    }
                } catch (e) {
                    console.error('Error updating product image:', e);
                }
            }

            // Fetch actual sizes for this color
            const colorCode = swatch.dataset.colorCode || swatch.dataset.color;
            try {
                const sizesResponse = await fetch(`/api/sizes-by-style-color?styleNumber=${productId}&color=${encodeURIComponent(colorCode)}`);

                if (sizesResponse.ok) {
                    const sizesData = await sizesResponse.json();
                    // Pass the previously selected size to the update function
                    updateProductSizes(card, sizesData, productId, previouslySelectedSize);
                }
            } catch (error) {
                console.warn('Could not fetch sizes for color:', error);
            }
        }

        // Validate color availability by checking inventory per size
        async function validateColorAvailability(colors, styleNumber) {
            const availableColors = [];

            for (const color of colors) {
                try {
                    const colorCode = color.COLOR_CODE || color.CATALOG_COLOR || color.COLOR_NAME;
                    if (!colorCode) continue;

                    // Check inventory for this color
                    const response = await fetch(`/api/sizes-by-style-color?styleNumber=${styleNumber}&color=${encodeURIComponent(colorCode)}`);

                    if (response.ok) {
                        const data = await response.json();

                        // Check if ANY size has inventory (not just grandTotal)
                        let hasAnyInventory = false;
                        const availableSizesForColor = [];

                        if (data.sizeTotals && Array.isArray(data.sizeTotals)) {
                            // Check each size's inventory
                            data.sizeTotals.forEach((inventory, index) => {
                                if (inventory > 0) {
                                    hasAnyInventory = true;
                                    if (data.sizes && data.sizes[index]) {
                                        availableSizesForColor.push({
                                            size: data.sizes[index],
                                            inventory: inventory
                                        });
                                    }
                                }
                            });
                        } else if (data.grandTotal && data.grandTotal > 0) {
                            // Fallback to grandTotal if sizeTotals not available
                            hasAnyInventory = true;
                        }

                        if (hasAnyInventory) {
                            // Store inventory data with the color for later use
                            color._inventoryData = data;
                            color._availableSizes = availableSizesForColor;
                            availableColors.push(color);
                        } else {
                            console.warn(`Filtering out ${colorCode} for ${styleNumber} - zero inventory across all sizes`);
                        }
                    } else {
                        // If we can't check inventory, include the color (fail open)
                        availableColors.push(color);
                    }
                } catch (error) {
                    console.warn(`Could not validate color ${color.COLOR_NAME}:`, error);
                    // If validation fails, include the color to avoid blocking
                    availableColors.push(color);
                }
            }

            return availableColors;
        }

        // Fetch default sizes for a product using its first available color
        async function fetchDefaultSizesForProduct(styleNumber, colors) {
            try {
                // Get the first available color
                const firstColor = colors[0]?.COLOR_CODE || colors[0]?.COLOR_NAME;
                if (!firstColor) {
                    console.warn(`No color available for product ${styleNumber}`);
                    return null;
                }

                const response = await fetch(`/api/sizes-by-style-color?styleNumber=${styleNumber}&color=${encodeURIComponent(firstColor)}`);

                if (!response.ok) {
                    console.warn(`Failed to fetch sizes for ${styleNumber} with color ${firstColor}`);
                    return null;
                }

                const sizesData = await response.json();
                return extractSizesFromData(sizesData);
            } catch (error) {
                console.error(`Error fetching sizes for product ${styleNumber}:`, error);
                showErrorBanner(`Unable to load sizes for product ${styleNumber}. Please refresh the page.`);
                return null;
            }
        }

        // Extract sizes with inventory from API response data
        function extractSizesWithInventory(sizesData) {
            const sizesWithInventory = [];

            if (sizesData && typeof sizesData === 'object') {
                // Check if it has sizes and sizeTotals arrays (standard format)
                if (sizesData.sizes && sizesData.sizeTotals &&
                    Array.isArray(sizesData.sizes) && Array.isArray(sizesData.sizeTotals)) {

                    sizesData.sizes.forEach((size, index) => {
                        const inventory = sizesData.sizeTotals[index] || 0;
                        sizesWithInventory.push({
                            size: size,
                            inventory: inventory,
                            available: inventory > 0
                        });
                    });
                }
                // Check if it's an array of size objects
                else if (Array.isArray(sizesData)) {
                    sizesData.forEach(item => {
                        if (item.SIZE || item.size) {
                            sizesWithInventory.push({
                                size: item.SIZE || item.size,
                                inventory: item.inventory || item.quantity || 1,
                                available: true
                            });
                        }
                    });
                }
                // Fallback: check standard size fields
                else {
                    const sizeFields = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '2XL', '3XL', '4XL', '5XL', '6XL'];
                    sizeFields.forEach(size => {
                        const inventory = sizesData[size] || sizesData[size.toLowerCase()] || 0;
                        if (inventory !== undefined) {
                            sizesWithInventory.push({
                                size: size === 'XXL' ? '2XL' : size,
                                inventory: parseInt(inventory),
                                available: parseInt(inventory) > 0
                            });
                        }
                    });
                }
            }

            return sizesWithInventory;
        }

        // Extract sizes from API response data (backward compatibility)
        function extractSizesFromData(sizesData) {
            const sizesWithInventory = extractSizesWithInventory(sizesData);
            // Return only available sizes
            return sizesWithInventory
                .filter(item => item.available)
                .map(item => item.size);
        }

        // Update sizes based on API response with inventory awareness
        function updateProductSizes(card, sizesData, productId, preservedSize = null) {
            const sizeGrid = card.querySelector('.size-grid');
            if (!sizeGrid || !sizesData) return;

            // Use the passed-in preserved size, or try to get it from current selection
            const previouslySelectedSize = preservedSize || card.querySelector('.size-btn.selected')?.dataset.size;

            // Get sizes with inventory information
            const sizesWithInventory = extractSizesWithInventory(sizesData);

            // Generate size buttons - show all sizes but disable out-of-stock
            if (sizesWithInventory.length > 0) {
                const sizeButtons = sizesWithInventory.map(sizeInfo => {
                    const { size, inventory, available } = sizeInfo;

                    // Create button with appropriate styling and state
                    if (available) {
                        // Available size - normal button
                        return `<button class="size-btn" data-size="${size}" data-inventory="${inventory}"
                                onclick="selectSize(event, '${productId}')">${size}</button>`;
                    } else {
                        // Out of stock - disabled button with visual indicator
                        return `<button class="size-btn out-of-stock" data-size="${size}"
                                disabled style="opacity: 0.4; cursor: not-allowed; position: relative;"
                                title="Out of Stock">${size}</button>`;
                    }
                }).join('');

                sizeGrid.innerHTML = sizeButtons;

                // Re-apply the previously selected size if it still exists and is available
                if (previouslySelectedSize) {
                    // Use setTimeout to ensure DOM is fully updated
                    setTimeout(() => {
                        const sizeBtn = sizeGrid.querySelector(`.size-btn[data-size="${previouslySelectedSize}"]:not(:disabled)`);
                        if (sizeBtn) {
                            sizeBtn.classList.add('selected');
                            console.log('Size preserved:', previouslySelectedSize); // Debug log
                        } else {
                            console.log('Size not available in new color:', previouslySelectedSize); // Debug log
                        }

                        // Update the Select button state after color and size selections
                        updateProductButtonState(card);
                    }, 0);
                }

                // Add CSS for out-of-stock styling if not already present
                if (!document.querySelector('#out-of-stock-styles')) {
                    const style = document.createElement('style');
                    style.id = 'out-of-stock-styles';
                    style.textContent = `
                        .size-btn.out-of-stock {
                            text-decoration: line-through;
                            background: #e5e7eb !important;
                            color: #9ca3af !important;
                            border-color: #d1d5db !important;
                        }
                        .size-btn.out-of-stock:hover {
                            background: #e5e7eb !important;
                            transform: none !important;
                        }
                    `;
                    document.head.appendChild(style);
                }

                // Clear any previous size selection
                const selectedSize = card.querySelector('.size-btn.selected');
                if (selectedSize) {
                    selectedSize.classList.remove('selected');
                }
            }
        }

        // Select Product
        function selectProduct(productId, type) {
            console.log(`selectProduct called for ${type}: ${productId}`);
            const card = document.querySelector(`[data-product-id="${productId}"]`);

            // Get selected size and color FIRST before any changes
            const selectedSize = card.querySelector('.size-btn.selected')?.dataset.size;
            const selectedColorElement = card.querySelector('.color-swatch.selected');
            const selectedColor = selectedColorElement?.dataset.color;
            const selectedColorCode = selectedColorElement?.dataset.colorCode;

            // VALIDATE FIRST - Check what's missing
            const hasColorOptions = card.querySelector('.color-swatches');
            const hasSizeOptions = card.querySelector('.size-grid');

            // Check for missing selections
            if ((hasColorOptions && !selectedColor) || (hasSizeOptions && !selectedSize)) {
                console.log(`${type} validation failed - missing required fields`);

                // Determine specific error message
                let errorMessage = '';
                if (hasColorOptions && !selectedColor && hasSizeOptions && !selectedSize) {
                    errorMessage = `Please select a color and size for the ${type}.`;
                    // Highlight both areas
                    const colorSwatches = card.querySelector('.color-swatches');
                    const sizeGrid = card.querySelector('.size-grid');
                    if (colorSwatches) colorSwatches.classList.add('missing-selection');
                    if (sizeGrid) sizeGrid.classList.add('missing-selection');
                } else if (hasColorOptions && !selectedColor) {
                    errorMessage = `Please select a color for the ${type}.`;
                    // Highlight color area
                    const colorSwatches = card.querySelector('.color-swatches');
                    if (colorSwatches) colorSwatches.classList.add('missing-selection');
                } else if (hasSizeOptions && !selectedSize) {
                    errorMessage = `Please select a size for the ${type}.`;
                    // Highlight size area
                    const sizeGrid = card.querySelector('.size-grid');
                    if (sizeGrid) sizeGrid.classList.add('missing-selection');
                }

                // Show inline error
                showInlineError(errorMessage);

                // Remove highlights after 3 seconds
                setTimeout(() => {
                    card.querySelectorAll('.missing-selection').forEach(el => {
                        el.classList.remove('missing-selection');
                    });
                }, 3000);

                // Don't proceed with selection
                updateContinueButtons();
                return;
            }

            // VALIDATION PASSED - Now we can mark as selected
            // Clear previous selection of this type
            document.querySelectorAll(`[data-product-type="${type}"]`).forEach(c => {
                c.classList.remove('selected');
            });

            // Mark this card as selected
            card.classList.add('selected');

            // Find product data
            let product = null;
            if (type === 'jacket') {
                product = products.jackets.find(p => p.id === productId);
            } else if (type === 'hoodie') {
                product = products.hoodies.find(p => p.id === productId);
            } else if (type === 'beanie') {
                product = products.beanies.find(p => p.id === productId);
            } else if (type === 'gloves') {
                product = products.gloves.find(p => p.id === productId);
            }

            // Find the selected color object from the product
            let selectedColorData = null;
            if (product && product.colors) {
                selectedColorData = product.colors.find(c => {
                    if (typeof c === 'string') {
                        return c === selectedColor;
                    } else {
                        return (c.COLOR_NAME || c.name) === selectedColor;
                    }
                });
            }

            // Calculate retail price with size upcharges
            let itemRetailPrice = product.retailPrice || 0;
            if (selectedSize && product.id) {
                // Get base retail price
                if (type === 'jacket' && RETAIL_PRICES.jackets[product.id]) {
                    itemRetailPrice = RETAIL_PRICES.jackets[product.id];
                } else if (type === 'hoodie') {
                    itemRetailPrice = RETAIL_PRICES.hoodies;
                } else if (type === 'beanie') {
                    itemRetailPrice = RETAIL_PRICES.beanies;
                } else if (type === 'gloves') {
                    itemRetailPrice = RETAIL_PRICES.gloves;
                }

                // Add size upcharge
                const upcharges = sizeUpchargeCache[product.id] || {};
                const upcharge = upcharges[selectedSize] || 0;
                itemRetailPrice += upcharge;

                console.log(`[Value Calc] ${type} ${product.id} size ${selectedSize}: base $${itemRetailPrice - upcharge} + upcharge $${upcharge} = $${itemRetailPrice}`);
            }

            // Save selection with full product data
            selectedItems[type] = {
                ...product,
                selectedSize,
                selectedColor,
                selectedColorCode,
                selectedColorData, // Store the full color object for later use
                retailPrice: itemRetailPrice // Store calculated retail price with upcharge
            };

            console.log(`${type} saved successfully:`, selectedItems[type]);

            // Update button text on all cards of this type
            document.querySelectorAll(`[data-product-type="${type}"] .select-btn`).forEach(btn => {
                const btnCard = btn.closest('.product-card');
                if (btnCard.classList.contains('selected')) {
                    btn.textContent = 'Change Selection';
                    btn.classList.add('selected');
                } else {
                    btn.textContent = `Select This ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                    btn.classList.remove('selected');
                }
            });

            // Enable next button
            const nextButton = document.getElementById(`${type}Next`);
            nextButton.disabled = false;

            // Show helper text
            showSelectionHelper();

            // Auto-scroll to Continue button with smooth animation
            setTimeout(() => {
                nextButton.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                // Add a temporary glow effect to draw attention
                nextButton.style.transition = 'all 0.5s ease';
                nextButton.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.8)';
                setTimeout(() => {
                    nextButton.style.boxShadow = '';
                }, 2000);
            }, 300);

            // Update summary
            updateSummary();
            updateValueSummaryBanner(); // Update value banner when products are selected
        }


        // Skip Functions - REMOVED (all items now required)

        // Update Gift Box Display Function
        function updateGiftBoxDisplay() {
            // Update the sidebar gift box display
            updateSummary();
        }

        // Check what's missing on any product cards for the current step
        function checkMissingSelections(stepNumber) {
            const typeMap = {
                1: 'jacket',
                2: 'hoodie',
                3: 'beanie',
                4: 'gloves'
            };

            const type = typeMap[stepNumber];
            if (!type) return { hasInteraction: false, missingColor: false, missingSize: false };

            // Find all product cards for this type
            const cards = document.querySelectorAll(`[data-product-type="${type}"]`);
            let hasInteraction = false;
            let missingColor = false;
            let missingSize = false;

            cards.forEach(card => {
                const hasColorOptions = card.querySelector('.color-swatches');
                const hasSizeOptions = card.querySelector('.size-grid');
                const hasSelectedColor = card.querySelector('.color-swatch.selected');
                const hasSelectedSize = card.querySelector('.size-btn.selected');

                // Check if user has made any selection on this card
                if (hasSelectedColor || hasSelectedSize) {
                    hasInteraction = true;
                }

                // Check what's missing
                if (hasColorOptions && !hasSelectedColor && (hasSelectedSize || card.querySelector('.select-btn:focus'))) {
                    missingColor = true;
                    hasInteraction = true;
                }

                if (hasSizeOptions && !hasSelectedSize && (hasSelectedColor || card.querySelector('.select-btn:focus'))) {
                    missingSize = true;
                    hasInteraction = true;
                }
            });

            return { hasInteraction, missingColor, missingSize };
        }

        // Update product card button states based on selections
        function updateProductButtonState(card) {
            if (!card) return;

            const productId = card.dataset.productId;
            const productType = card.dataset.productType;
            const selectBtn = card.querySelector(`button[onclick*="selectProduct"]`);

            if (!selectBtn) return;

            // Check if product is already selected
            const isAlreadySelected = card.classList.contains('selected');

            // Check if all required fields are selected
            const hasColorOptions = card.querySelector('.color-swatches');
            const hasSizeOptions = card.querySelector('.size-grid');

            let colorSelected = true;
            let sizeSelected = true;

            if (hasColorOptions) {
                colorSelected = !!card.querySelector('.color-swatch.selected');
            }

            if (hasSizeOptions) {
                sizeSelected = !!card.querySelector('.size-btn.selected');
            }

            // AUTO-SELECT: Disabled on page load to prevent automation issues
            // Only auto-select if user has interacted with the page (after 3 seconds)
            if (colorSelected && sizeSelected && !isAlreadySelected) {
                // Check if enough time has passed since page load (3 seconds)
                if (window.pageLoadTime && Date.now() - window.pageLoadTime > 3000) {
                    console.log(`Auto-selecting ${productType} since all options are selected`);
                    selectProduct(productId, productType);
                    return; // Exit early since selectProduct will update everything
                } else {
                    // Don't auto-select during initial page load
                    console.log(`Skipping auto-select for ${productType} - too soon after page load`);
                }
            }

            // Update button state and text
            if (isAlreadySelected) {
                selectBtn.disabled = false;
                selectBtn.classList.remove('disabled-btn');
                selectBtn.classList.add('select-btn', 'selected');
                selectBtn.innerHTML = '<i class="fas fa-check-circle"></i> Product Selected';
            } else if (colorSelected && sizeSelected) {
                selectBtn.disabled = false;
                selectBtn.classList.remove('disabled-btn');
                selectBtn.classList.add('select-btn');
                selectBtn.innerHTML = '<i class="fas fa-check"></i> Select This ' +
                    productType.charAt(0).toUpperCase() + productType.slice(1);
            } else {
                selectBtn.disabled = true;
                selectBtn.classList.add('disabled-btn');
                selectBtn.classList.remove('select-btn');

                // Show what's missing
                if (!colorSelected && !sizeSelected) {
                    selectBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Select Color & Size First';
                } else if (!colorSelected) {
                    selectBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Select Color First';
                } else if (!sizeSelected) {
                    selectBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Select Size First';
                }
            }
        }

        // Calculate Retail Value Function
        function calculateRetailValue() {
            let total = 0;
            if (selectedItems.jacket && selectedItems.jacket.retailPrice) {
                total += selectedItems.jacket.retailPrice;
            }
            if (selectedItems.hoodie && selectedItems.hoodie.retailPrice) {
                total += selectedItems.hoodie.retailPrice;
            }
            if (selectedItems.beanie && selectedItems.beanie.retailPrice) {
                total += selectedItems.beanie.retailPrice;
            }
            if (selectedItems.gloves && selectedItems.gloves.retailPrice) {
                total += selectedItems.gloves.retailPrice;
            }
            // Add gift box and shipping
            total += RETAIL_PRICES.giftBox || 9;
            total += RETAIL_PRICES.shipping || 25;
            return total;
        }

        // Inline Error Display Function
        function showInlineError(message) {
            // Remove any existing error messages
            const existingError = document.querySelector('.inline-error-message');
            if (existingError) {
                existingError.remove();
            }

            // Create error message element
            const errorDiv = document.createElement('div');
            errorDiv.className = 'inline-error-message';
            errorDiv.style.cssText = `
                background: #ffebee;
                border: 2px solid #f44336;
                color: #b71c1c;
                padding: 12px 20px;
                border-radius: 8px;
                margin: 20px auto;
                max-width: 600px;
                text-align: center;
                font-weight: 500;
                animation: shake 0.5s;
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            `;
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i> ${message}
            `;

            // Add to page
            document.body.appendChild(errorDiv);

            // Remove after 5 seconds
            setTimeout(() => {
                errorDiv.style.opacity = '0';
                errorDiv.style.transition = 'opacity 0.3s';
                setTimeout(() => errorDiv.remove(), 300);
            }, 5000);

            // Also highlight missing selections
            highlightMissingSelections();
        }

        // Highlight Missing Selections
        function highlightMissingSelections() {
            // Remove existing highlights
            document.querySelectorAll('.missing-selection').forEach(el => {
                el.classList.remove('missing-selection');
            });

            // Check current step and highlight missing items
            const currentStepElement = document.getElementById(`step${currentStep}`);

            if (currentStep === 1 && selectedItems.jacket) {
                // Highlight missing color or size
                const jacketCard = document.querySelector('[data-product-type="jacket"].selected');
                if (jacketCard) {
                    if (!jacketCard.querySelector('.color-swatch.selected')) {
                        const colorSection = jacketCard.querySelector('.color-swatches');
                        if (colorSection) colorSection.classList.add('missing-selection');
                    }
                    if (!jacketCard.querySelector('.size-btn.selected')) {
                        const sizeSection = jacketCard.querySelector('.size-grid');
                        if (sizeSection) sizeSection.classList.add('missing-selection');
                    }
                }
            }
            // Similar for other steps...
        }

        // Navigation
        window.goToStep = function(targetStep) {
            // Convert to number if string
            targetStep = parseInt(targetStep);

            // Detect automation - prevent if navigating too fast
            const now = Date.now();
            if (lastStepNavigationTime && now - lastStepNavigationTime < 300) {
                console.warn('Suspicious navigation pattern detected - blocking rapid navigation');
                return;
            }

            // Only allow navigation to visited steps (up to highestStepReached)
            if (targetStep >= 1 && targetStep <= highestStepReached) {
                // Update navigation timing
                lastStepNavigationTime = now;
                // Hide current step
                document.getElementById(`step${currentStep}`).classList.remove('active');
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');

                // Update completed status for all steps
                // Mark all steps before target as completed
                for (let i = 1; i < targetStep; i++) {
                    document.querySelector(`[data-step="${i}"]`).classList.add('completed');
                    document.querySelector(`[data-step="${i}"]`).classList.remove('active');
                }

                // Mark target step as active (not completed)
                document.querySelector(`[data-step="${targetStep}"]`).classList.remove('completed');
                document.querySelector(`[data-step="${targetStep}"]`).classList.add('active');

                // Mark all steps after target as not active and not completed
                for (let i = targetStep + 1; i <= 7; i++) {
                    const stepElement = document.querySelector(`[data-step="${i}"]`);
                    if (stepElement) {
                        stepElement.classList.remove('active');
                        stepElement.classList.remove('completed');
                    }
                }

                // Update current step
                currentStep = targetStep;

                // Show target step
                document.getElementById(`step${currentStep}`).classList.add('active');

                // Remove completed class from current step and add active
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('completed');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');

                // Initialize delivery date when reaching step 5
                if (currentStep === 5) {
                    setTimeout(() => {
                        initializeDeliveryDate();
                    }, 100);
                }

                // Update submit button state if on last step
                if (currentStep === 6) {
                    validateForm();
                }

                // Reset submission state when entering Step 7
                if (currentStep === 7) {
                    // IMPORTANT: Reset any stuck submission state when entering Step 7
                    window.isSubmitting = false;
                    const overlay = document.getElementById('submissionOverlay');
                    if (overlay) {
                        overlay.classList.remove('active');
                        // Force style recalculation to ensure it's hidden
                        overlay.style.display = 'none';
                        setTimeout(() => {
                            overlay.style.display = '';
                        }, 10);
                    }

                    // Populate the review data
                    populateReviewData();

                    // Attach submit button handlers after a delay
                    // This delay ensures the DOM is fully settled before attaching handlers
                    setTimeout(() => {
                        attachSubmitHandlers();
                    }, 200);
                }

                // Update continue button states based on selections
                updateContinueButtons();

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            // If trying to go forward to unvisited step, do nothing (cursor: not-allowed will show)
        }

        // Validate current step selections
        function validateCurrentStep() {
            switch(currentStep) {
                case 1: // Jacket step - REQUIRED
                    if (!selectedItems.jacket) return false;
                    // Check if we have the required fields OR if the card is properly selected in DOM
                    const jacketCard = document.querySelector('[data-product-type="jacket"].selected');
                    if (jacketCard) {
                        // If card is selected, ensure we have color and size
                        const hasColor = selectedItems.jacket.selectedColor || jacketCard.querySelector('.color-swatch.selected');
                        const hasSize = selectedItems.jacket.selectedSize || jacketCard.querySelector('.size-btn.selected');
                        return hasColor && hasSize;
                    }
                    return selectedItems.jacket.selectedColor && selectedItems.jacket.selectedSize;

                case 2: // Hoodie step - NOW REQUIRED (no skipping)
                    if (!selectedItems.hoodie) return false;
                    const hoodieCard = document.querySelector('[data-product-type="hoodie"].selected');
                    if (hoodieCard) {
                        const hasColor = selectedItems.hoodie.selectedColor || hoodieCard.querySelector('.color-swatch.selected');
                        const hasSize = selectedItems.hoodie.selectedSize || hoodieCard.querySelector('.size-btn.selected');
                        return hasColor && hasSize;
                    }
                    return selectedItems.hoodie.selectedColor && selectedItems.hoodie.selectedSize;

                case 3: // Beanie step - REQUIRED
                    if (!selectedItems.beanie) return false;
                    const beanieCard = document.querySelector('[data-product-type="beanie"].selected');
                    if (beanieCard) {
                        const hasColor = selectedItems.beanie.selectedColor || beanieCard.querySelector('.color-swatch.selected');
                        return hasColor;
                    }
                    // Beanies usually have OSFA, so just check color
                    return selectedItems.beanie.selectedColor;

                case 4: // Gloves step - NOW REQUIRED (no skipping)
                    if (!selectedItems.gloves) return false;
                    const glovesCard = document.querySelector('[data-product-type="gloves"].selected');
                    if (glovesCard) {
                        const hasSize = selectedItems.gloves.selectedSize || glovesCard.querySelector('.size-btn.selected');
                        return hasSize;
                    }
                    return selectedItems.gloves.selectedSize;

                default:
                    return true; // Other steps don't require product validation
            }
        }

        window.nextStep = function() {
            // Prevent rapid navigation (500ms cooldown between steps)
            const now = Date.now();
            if (lastStepNavigationTime && now - lastStepNavigationTime < 500) {
                console.warn('Navigation too fast - preventing rapid step advancement');
                return;
            }

            // Require user interaction before allowing navigation (except for Step 5 which has no products)
            if (!userHasInteracted && currentStep < 5) {
                console.warn('No user interaction detected - blocking automated navigation');
                return;
            }

            // Validate current step before advancing
            if (!validateCurrentStep()) {
                let missingInfo = '';
                const productNames = {
                    1: 'jacket',
                    2: 'hoodie',
                    3: 'beanie',
                    4: 'gloves'
                };

                const productName = productNames[currentStep];

                // Check what's missing on the current step's product cards
                const missing = checkMissingSelections(currentStep);

                // Provide specific feedback based on what's missing
                if (missing.hasInteraction) {
                    // User has started selecting but hasn't completed
                    if (missing.missingColor && missing.missingSize) {
                        missingInfo = `Please select a color and size for the ${productName}.`;
                    } else if (missing.missingColor) {
                        // Be more specific for beanies since size is often auto-selected
                        if (productName === 'beanie') {
                            missingInfo = `Please select a color for the beanie.`;
                        } else {
                            missingInfo = `Please select a color for the ${productName}.`;
                        }
                    } else if (missing.missingSize) {
                        missingInfo = `Please select a size for the ${productName}.`;
                    } else {
                        // User interacted but selection isn't complete
                        missingInfo = `Please complete your ${productName} selection.`;
                    }
                } else {
                    // No interaction at all - check if something is in selectedItems but incomplete
                    const item = selectedItems[productName];
                    if (item) {
                        // Item partially selected in data but not complete
                        if (!item.selectedColor && !item.selectedSize) {
                            missingInfo = `Please select a color and size for the ${productName}.`;
                        } else if (!item.selectedColor) {
                            missingInfo = `Please select a color for the ${productName}.`;
                        } else if (!item.selectedSize) {
                            missingInfo = `Please select a size for the ${productName}.`;
                        } else {
                            missingInfo = `Please complete your ${productName} selection.`;
                        }
                    } else {
                        // Nothing selected at all
                        missingInfo = `Please select a ${productName}. All items are required.`;
                    }
                }

                // Log for debugging
                console.log('Validation failed:', {
                    step: currentStep,
                    product: productName,
                    hasInteraction: missing.hasInteraction,
                    missingColor: missing.missingColor,
                    missingSize: missing.missingSize,
                    errorMessage: missingInfo
                });

                // Show inline error instead of alert
                showInlineError(missingInfo || 'Please complete your selection before continuing.');
                return;
            }

            if (currentStep < 7) {
                // Update navigation timing
                lastStepNavigationTime = Date.now();

                // Hide current step
                document.getElementById(`step${currentStep}`).classList.remove('active');

                // Update progress
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');

                currentStep++;

                // Update highest step reached
                if (currentStep > highestStepReached) {
                    highestStepReached = currentStep;
                }

                // Show next step
                document.getElementById(`step${currentStep}`).classList.add('active');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');

                // Initialize delivery date when reaching step 5
                if (currentStep === 5) {
                    setTimeout(() => {
                        initializeDeliveryDate();
                    }, 100);
                }

                // Populate review data when reaching step 7
                if (currentStep === 7) {
                    // IMPORTANT: Reset any stuck submission state when entering Step 7
                    window.isSubmitting = false;
                    const overlay = document.getElementById('submissionOverlay');
                    if (overlay) {
                        overlay.classList.remove('active');
                        // Force style recalculation to ensure it's hidden
                        overlay.style.display = 'none';
                        setTimeout(() => {
                            overlay.style.display = '';
                        }, 10);
                    }

                    // Populate the review data
                    populateReviewData();

                    // Ensure submit button has handlers attached after a delay
                    // This delay ensures the DOM is fully settled before attaching handlers
                    setTimeout(() => {
                        attachSubmitHandlers();
                    }, 200);
                }

                // Show scroll indicator for product selection steps
                showScrollIndicator();

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        window.previousStep = function() {
            if (currentStep > 1) {
                // Hide current step
                document.getElementById(`step${currentStep}`).classList.remove('active');
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');

                // Update current step
                currentStep--;

                // Show previous step
                document.getElementById(`step${currentStep}`).classList.add('active');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');

                // Update progress bar - mark current as active, not completed
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('completed');

                // Update summary and continue buttons
                updateSummary();
                updateContinueButtons();

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Update continue button states based on selections
        function updateContinueButtons() {
            // Helper function to check if a product is FULLY selected with ALL required attributes
            function isProductFullyComplete(type) {
                const item = selectedItems[type];
                if (!item || !item.id) return false;

                // Check the actual product card to verify selections match
                const card = document.querySelector(`[data-product-id="${item.id}"]`);
                if (!card || !card.classList.contains('selected')) return false;

                // For jackets and hoodies - MUST have color AND size
                if (type === 'jacket' || type === 'hoodie') {
                    if (!item.selectedColor || !item.selectedSize) return false;
                    // Double-check the DOM
                    const hasColorSelected = card.querySelector('.color-swatch.selected');
                    const hasSizeSelected = card.querySelector('.size-btn.selected');
                    return hasColorSelected && hasSizeSelected;
                }

                // For beanies - MUST have color (size is often OSFA)
                if (type === 'beanie') {
                    if (!item.selectedColor) return false;
                    const hasColorSelected = card.querySelector('.color-swatch.selected');
                    return hasColorSelected;
                }

                // For gloves - MUST have size (and color if available)
                if (type === 'gloves') {
                    if (!item.selectedSize) return false;
                    const hasSizeSelected = card.querySelector('.size-btn.selected');
                    // If gloves have color options, check that too
                    const hasColorOptions = card.querySelector('.color-swatches');
                    if (hasColorOptions) {
                        if (!item.selectedColor) return false;
                        const hasColorSelected = card.querySelector('.color-swatch.selected');
                        return hasSizeSelected && hasColorSelected;
                    }
                    return hasSizeSelected;
                }

                return true;
            }

            // Update jacket continue button - ALL items are now REQUIRED
            if (isProductFullyComplete('jacket')) {
                document.getElementById('jacketNext')?.removeAttribute('disabled');
            } else {
                document.getElementById('jacketNext')?.setAttribute('disabled', 'disabled');
            }

            // Update hoodie continue button - ALL items are now REQUIRED (no skipping)
            if (isProductFullyComplete('hoodie')) {
                document.getElementById('hoodieNext')?.removeAttribute('disabled');
            } else {
                document.getElementById('hoodieNext')?.setAttribute('disabled', 'disabled');
            }

            // Update beanie continue button - ALL items are now REQUIRED
            if (isProductFullyComplete('beanie')) {
                document.getElementById('beanieNext')?.removeAttribute('disabled');
            } else {
                document.getElementById('beanieNext')?.setAttribute('disabled', 'disabled');
            }

            // Update gloves continue button - ALL items are now REQUIRED (no skipping)
            if (isProductFullyComplete('gloves')) {
                document.getElementById('glovesNext')?.removeAttribute('disabled');
            } else {
                document.getElementById('glovesNext')?.setAttribute('disabled', 'disabled');
            }
        }

        // Logo Upload with validation
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Clear any previous file selection first to prevent freezing
            if (window.selectedLogoFile) {
                window.selectedLogoFile = null;
                document.getElementById('logoPreview').classList.remove('active');
                document.getElementById('previewImage').src = '';
                selectedItems.logo = null;
            }

            // Validate file type - INCLUDING PDF support
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/svg+xml', 'application/pdf'];
            const maxSize = 20 * 1024 * 1024; // 20MB

            if (!validTypes.includes(file.type)) {
                alert('Please upload an image (PNG, JPG, GIF, SVG) or PDF file');
                event.target.value = '';
                return;
            }

            if (file.size > maxSize) {
                alert('File size must be less than 20MB');
                event.target.value = '';
                return;
            }

            // Store the actual file for upload
            window.selectedLogoFile = file;

            // Show preview for images
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('logoPreview').classList.add('active');
                    selectedItems.logo = e.target.result;
                    updateSummary();
                };
                reader.readAsDataURL(file);
            } else {
                // For PDFs, just show filename
                document.getElementById('logoPreview').innerHTML = `
                    <div class="pdf-preview">
                        <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc2626;"></i>
                        <p>${file.name}</p>
                        <button type="button" onclick="removeLogo()" class="btn btn-sm">Remove</button>
                    </div>
                `;
                document.getElementById('logoPreview').classList.add('active');
                selectedItems.logo = file.name;
                updateSummary();
            }
        }

        // Upload file to Caspio via API
        async function uploadFileToAPI(file) {
            try {
                // Add timestamp to filename to avoid conflicts
                const timestamp = Date.now();
                const nameParts = file.name.split('.');
                const extension = nameParts.pop();
                const baseName = nameParts.join('.');
                const uniqueFileName = `${baseName}_${timestamp}.${extension}`;

                // Create a new File object with the unique name
                const uniqueFile = new File([file], uniqueFileName, { type: file.type });

                const formData = new FormData();
                formData.append('file', uniqueFile);

                const response = await fetch('https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/files/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('File uploaded successfully:', result);

                // Return the ExternalKey for storing in the database
                return result.ExternalKey || result.externalKey || result.id;
            } catch (error) {
                console.error('Error uploading file:', error);
                // Don't stop the submission, just log the error
                return null;
            }
        }

        // Remove logo
        function removeLogo() {
            document.getElementById('logoFile').value = '';
            document.getElementById('logoPreview').classList.remove('active');
            document.getElementById('previewImage').src = '';
            window.selectedLogoFile = null;
            selectedItems.logo = null;
            updateSummary();
        }

        // Toggle pricing info bar
        function togglePricing() {
            const infoBar = document.getElementById('pricingInfoBar');

            if (infoBar.classList.contains('collapsed')) {
                infoBar.classList.remove('collapsed');
                infoBar.classList.add('expanded');
            } else {
                infoBar.classList.remove('expanded');
                infoBar.classList.add('collapsed');
            }
        }

        // Toggle between Ship and Pickup
        function toggleDeliveryFields() {
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const shippingFields = document.getElementById('shippingFields');
            const pickupInfo = document.getElementById('pickupInfo');

            // Update value banner when shipping method changes
            updateValueSummaryBanner();

            if (deliveryMethod === 'Ship') {
                shippingFields.style.display = 'block';
                pickupInfo.style.display = 'none';

                // Make shipping fields required
                const addressField = document.getElementById('address1');
                const cityField = document.getElementById('city');
                const stateField = document.getElementById('state');
                const zipField = document.getElementById('zipCode');

                if (addressField) addressField.required = true;
                if (cityField) cityField.required = true;
                if (stateField) stateField.required = true;
                if (zipField) zipField.required = true;
            } else {
                shippingFields.style.display = 'none';
                pickupInfo.style.display = 'block';

                // Remove required from shipping fields
                const addressField = document.getElementById('address1');
                const cityField = document.getElementById('city');
                const stateField = document.getElementById('state');
                const zipField = document.getElementById('zipCode');

                if (addressField) addressField.required = false;
                if (cityField) cityField.required = false;
                if (stateField) stateField.required = false;
                if (zipField) zipField.required = false;
            }
        }

        // Drag and Drop
        function setupDragDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const input = document.getElementById('logoFile');
                    input.files = e.dataTransfer.files;
                    handleLogoUpload({ target: input });
                }
            });
        }

        // Update Summary
        function updateSummary() {
            const summaryItems = document.getElementById('summaryItems');
            const hasItems = selectedItems.jacket || selectedItems.hoodie || selectedItems.beanie || selectedItems.gloves;

            if (!hasItems) {
                summaryItems.innerHTML = `
                    <div class="summary-empty">
                        <div class="summary-empty-icon">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <div>Start building your gift box</div>
                    </div>
                `;
                // Only disable submit button if it exists
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                }
                return;
            }

            let html = '';

            // Add selected items
            if (selectedItems.jacket) {
                html += createSummaryItem(selectedItems.jacket, 'jacket');
            }
            if (selectedItems.hoodie) {
                html += createSummaryItem(selectedItems.hoodie, 'hoodie');
            }
            if (selectedItems.beanie) {
                html += createSummaryItem(selectedItems.beanie, 'beanie');
            }

            // Add gloves (if selected, show selected size; otherwise show pending selection)
            const gloveImageUrl = 'https://cdnm.sanmar.com/imglib/mresjpg/2024/f5/CTGD0794_blackbarley_glove_main.jpg';

            if (selectedItems.gloves) {
                // Create unique ID for glove image
                const gloveImageId = `summary-img-gloves-${Date.now()}`;
                html += `
                    <div class="summary-item">
                        <div class="summary-item-image" id="${gloveImageId}-container">
                            <img id="${gloveImageId}"
                                 src="${gloveImageUrl}"
                                 alt="Carhartt Work Gloves - ${selectedItems.gloves.selectedColor}"
                                 onerror="handleImageError('${gloveImageId}', 'fa-mitten')">
                            <div class="image-fallback">
                                <i class="fas fa-mitten"></i>
                            </div>
                        </div>
                        <div class="summary-item-details">
                            <div class="summary-item-name">Carhartt Work Gloves</div>
                            <div class="summary-item-specs">CTGD0794 • ${selectedItems.gloves.selectedSize || 'Size not selected'} • ${selectedItems.gloves.selectedColor || 'Black Barley'}</div>
                        </div>
                    </div>
                `;
            } else {
                // Create unique ID for unselected glove image
                const gloveImageId = `summary-img-gloves-pending-${Date.now()}`;
                html += `
                    <div class="summary-item" style="opacity: 0.5;">
                        <div class="summary-item-image" id="${gloveImageId}-container">
                            <img id="${gloveImageId}"
                                 src="${gloveImageUrl}"
                                 alt="Carhartt Work Gloves"
                                 onerror="handleImageError('${gloveImageId}', 'fa-mitten')">
                            <div class="image-fallback">
                                <i class="fas fa-mitten"></i>
                            </div>
                        </div>
                        <div class="summary-item-details">
                            <div class="summary-item-name">Carhartt Work Gloves</div>
                            <div class="summary-item-specs">CTGD0794 • Size not selected • Included</div>
                        </div>
                    </div>
                `;
            }

            summaryItems.innerHTML = html;

            // Enable submit if on last step and form is valid
            if (currentStep === 6) {
                validateForm();
            }
        }

        function createSummaryItem(item, type) {
            // Get the correct product image for the selected color
            let productImage = null;
            let fallbackIcon = type === 'jacket' ? 'fa-tshirt' : type === 'hoodie' ? 'fa-hoodie' : 'fa-hat-winter';

            // Try to get image from selectedColorData (which contains the color-specific image)
            if (item.selectedColorData) {
                // Priority order: MAIN_IMAGE_URL, then FRONT_FLAT, then FRONT_MODEL
                productImage = item.selectedColorData.MAIN_IMAGE_URL ||
                              item.selectedColorData.FRONT_FLAT ||
                              item.selectedColorData.FRONT_MODEL ||
                              item.selectedColorData.IMAGE_URL;

                // Handle cases where image might be empty string
                if (productImage === '' || productImage === 'null' || productImage === null) {
                    productImage = null;
                }
            }

            // Fallback to default product image if no color-specific image
            if (!productImage && item.image) {
                productImage = item.image;
            }

            // Create unique ID for this item's image to handle error events
            const imageId = `summary-img-${type}-${Date.now()}`;

            // Determine what to display - image or icon
            const imageContent = productImage
                ? `<img id="${imageId}"
                        src="${productImage}"
                        alt="${item.name} - ${item.selectedColor}"
                        onerror="handleImageError('${imageId}', '${fallbackIcon}')">
                   <div class="image-fallback">
                        <i class="fas ${fallbackIcon}"></i>
                   </div>`
                : `<i class="fas ${fallbackIcon}"></i>`;

            return `
                <div class="summary-item">
                    <div class="summary-item-image" id="${imageId}-container">
                        ${imageContent}
                    </div>
                    <div class="summary-item-details">
                        <div class="summary-item-name">${item.name}</div>
                        <div class="summary-item-specs">${item.id} • ${type === 'beanie' ? 'OSFA' : (item.selectedSize || 'Size not selected')} • ${item.selectedColor || 'Color not selected'}</div>
                    </div>
                    <div class="summary-item-remove" onclick="removeItem('${type}')">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            `;
        }

        // Handle image load errors
        function handleImageError(imageId, fallbackIcon) {
            const container = document.getElementById(`${imageId}-container`);
            if (container) {
                container.classList.add('fallback-active');
            }
            // Log for debugging
            console.log(`Image failed to load for ${imageId}, showing fallback icon`);
        }

        // Debug function to verify image selection
        function debugGiftBoxImages() {
            console.log('=== Gift Box Image Debug ===');
            ['jacket', 'hoodie', 'beanie'].forEach(type => {
                const item = selectedItems[type];
                if (item) {
                    console.log(`\n${type.toUpperCase()}:`);
                    console.log(`  Product: ${item.name} (${item.id})`);
                    console.log(`  Selected Color: ${item.selectedColor}`);
                    if (item.selectedColorData) {
                        console.log(`  Color Data Available: Yes`);
                        console.log(`  MAIN_IMAGE_URL: ${item.selectedColorData.MAIN_IMAGE_URL || 'Not available'}`);
                        console.log(`  FRONT_FLAT: ${item.selectedColorData.FRONT_FLAT || 'Not available'}`);
                        console.log(`  FRONT_MODEL: ${item.selectedColorData.FRONT_MODEL || 'Not available'}`);
                    } else {
                        console.log(`  Color Data Available: No`);
                        console.log(`  Fallback Image: ${item.image || 'None'}`);
                    }
                }
            });
            console.log('\n=== End Debug ===');
        }

        // Add debug command to window for testing
        window.debugGiftBox = debugGiftBoxImages;

        function removeItem(type) {
            selectedItems[type] = null;

            // Clear selection in UI
            document.querySelectorAll(`[data-product-type="${type}"]`).forEach(card => {
                card.classList.remove('selected');
            });

            // Disable next button for that step
            if (document.getElementById(`${type}Next`)) {
                document.getElementById(`${type}Next`).disabled = true;
            }

            updateSummary();
            updateValueSummaryBanner(); // Update value banner when summary updates
        }

        // Calculate and update value summary banner
        function updateValueSummaryBanner() {
            const banner = document.getElementById('valueSummaryBanner');

            // Calculate total retail value
            let totalValue = 0;

            // Add selected items retail prices
            if (selectedItems.jacket && selectedItems.jacket.retailPrice) {
                totalValue += selectedItems.jacket.retailPrice;
            }
            if (selectedItems.hoodie && selectedItems.hoodie.retailPrice) {
                totalValue += selectedItems.hoodie.retailPrice;
            }
            if (selectedItems.beanie && selectedItems.beanie.retailPrice) {
                totalValue += selectedItems.beanie.retailPrice;
            }
            if (selectedItems.gloves && selectedItems.gloves.retailPrice) {
                totalValue += selectedItems.gloves.retailPrice;
            }

            // Add gift box and handling
            totalValue += RETAIL_PRICES.giftBox;

            // Add shipping if selected
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked');
            if (deliveryMethod && deliveryMethod.value === 'ship') {
                totalValue += RETAIL_PRICES.shipping;
            }

            // Only show banner if items are selected
            if (selectedItems.jacket || selectedItems.hoodie || selectedItems.beanie || selectedItems.gloves) {
                banner.style.display = 'block';
                document.getElementById('totalValueAmount').textContent = `$${totalValue}`;
                document.getElementById('totalSavingsAmount').textContent = `$${totalValue}`;
            } else {
                banner.style.display = 'none';
            }
        }

        // Form Validation
        function validateForm() {
            const form = document.getElementById('deliveryForm');
            const isValid = form.checkValidity();
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = !isValid;
            }
        }

        // Add event listeners for form validation
        document.querySelectorAll('#deliveryForm input, #deliveryForm select').forEach(input => {
            input.addEventListener('input', validateForm);
        });

        // Submit Gift Box
        async function submitGiftBox() {
            // Validate and ensure delivery date has a value
            validateDeliveryDate();

            // Get delivery date value (will have default if empty)
            let deliveryDateValue = document.getElementById('deliveryDate').value;

            // Final safeguard: if still no date, calculate default
            if (!deliveryDateValue) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let defaultDate = new Date(today);
                defaultDate.setDate(defaultDate.getDate() + 14);

                // Skip weekends
                while (isWeekend(defaultDate)) {
                    defaultDate.setDate(defaultDate.getDate() + 1);
                }

                deliveryDateValue = formatDate(defaultDate);
                document.getElementById('deliveryDate').value = deliveryDateValue;
            }

            // Collect all data
            const formData = {
                items: {
                    jacket: selectedItems.jacket,
                    hoodie: selectedItems.hoodie,
                    beanie: selectedItems.beanie
                },
                customization: {
                    logo: selectedItems.logo,
                    jacketEmbLocation: document.getElementById('jacketEmbLocation')?.value,
                    hoodieEmbLocation: document.getElementById('hoodieEmbLocation')?.value,
                    threadColors: document.getElementById('threadColors')?.value,
                    specialInstructions: document.getElementById('specialInstructions')?.value
                },
                delivery: {
                    contactName: document.getElementById('contactName').value,
                    companyName: document.getElementById('companyName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address1: document.getElementById('address1').value,
                    address2: document.getElementById('address2').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipCode: document.getElementById('zipCode').value,
                    dueDate: deliveryDateValue
                }
            };

            // Generate reference number
            const referenceNumber = generateReferenceNumber();
            document.getElementById('referenceNumber').textContent = referenceNumber;

            // Here you would normally send this data to your server
            console.log('Submitting gift box request:', formData);

            // Show success modal
            document.getElementById('successModal').classList.add('active');
        }

        function generateReferenceNumber() {
            const date = new Date();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `XMAS${month}${day}-${random}`;
        }

        function closeModal() {
            document.getElementById('successModal').classList.remove('active');
            // Reset form
            resetForm();
        }

        // Allow clicking outside the modal to close it
        function closeModalOnBackdrop(event) {
            if (event.target.id === 'successModal') {
                closeModal();
            }
        }

        function resetForm() {
            currentStep = 1;
            selectedItems = {
                jacket: null,
                hoodie: null,
                beanie: null,
                gloves: null,
                logo: null,
                customization: {},
                delivery: {}
            };

            // Reset UI
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('step1').classList.add('active');

            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.querySelector('[data-step="1"]').classList.add('active');

            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });

            document.querySelectorAll('.size-btn, .color-swatch').forEach(btn => {
                btn.classList.remove('selected');
            });

            document.querySelectorAll('.select-btn').forEach(btn => {
                btn.disabled = true;
            });

            document.getElementById('deliveryForm').reset();
            document.getElementById('logoPreview').classList.remove('active');

            updateSummary();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // DEBUG FUNCTIONS FOR TESTING
        // ============================================

        // Store last submitted quote ID for debugging
        window.lastSubmittedQuoteID = null;

        // Programmatically submit a test order with all fields filled
        window.debugSubmitTestOrder = async function() {
            console.log('=== STARTING AUTOMATED TEST ORDER SUBMISSION ===');

            // Reset form first
            resetForm();

            // Step 1: Fill contact information
            document.getElementById('firstName').value = 'Test';
            document.getElementById('lastName').value = 'Debug' + Date.now();
            document.getElementById('email').value = 'test@nwcustomapparel.com';
            document.getElementById('phone').value = '2531234567';
            document.getElementById('companyName').value = 'Test Company Debug';

            // Step 2: Set delivery to Ship and fill address
            document.querySelector('input[value="Ship"]').checked = true;
            toggleDeliveryFields();

            document.getElementById('address1').value = '123 Test Street';
            document.getElementById('city').value = 'Tacoma';
            document.getElementById('state').value = 'WA';
            document.getElementById('zipCode').value = '98402';

            // Step 3: Set delivery date (2 weeks from now)
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 14);
            document.getElementById('deliveryDate').value = futureDate.toISOString().split('T')[0];

            // Step 4: Check rush order
            document.getElementById('rushOrder').checked = true;

            // Step 5: Set customization
            document.getElementById('jacketEmbLocation').value = 'left-chest';
            document.getElementById('hoodieEmbLocation').value = 'right-chest';
            document.getElementById('threadColors').value = 'Red, Blue, Green';
            document.getElementById('specialInstructions').value = 'DEBUG TEST ORDER - ' + new Date().toISOString();

            // Step 6: Pre-select all items with sizes and colors
            selectedItems = {
                jacket: {
                    id: 'CT104670',
                    name: 'Carhartt Jacket',
                    selectedSize: 'XL',
                    selectedColor: 'Black',
                    price: 50
                },
                hoodie: {
                    id: 'F281',
                    name: 'Gildan Hoodie',
                    selectedSize: 'XL',
                    selectedColor: 'Red',
                    price: 50
                },
                beanie: {
                    id: 'CT104597',
                    name: 'Carhartt Beanie',
                    selectedSize: 'OSFA',
                    selectedColor: 'Navy',
                    price: 50
                },
                gloves: {
                    id: 'CTGD0794',
                    name: 'Carhartt Gloves',
                    selectedSize: 'L',
                    selectedColor: 'Black Barley',
                    price: 50
                }
            };

            console.log('Test order data prepared:', {
                contact: {
                    name: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value
                },
                shipping: {
                    method: document.querySelector('input[name="deliveryMethod"]:checked').value,
                    address: document.getElementById('address1').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipCode: document.getElementById('zipCode').value
                },
                dueDate: testData.formData.dueDate,
                items: selectedItems
            });

            // Submit the order
            try {
                await submitOrder();
                console.log('=== TEST ORDER SUBMITTED SUCCESSFULLY ===');
                console.log('Quote ID:', window.lastSubmittedQuoteID);
                return window.lastSubmittedQuoteID;
            } catch (error) {
                console.error('Test order submission failed:', error);
                return null;
            }
        };

        // Query database to check what was actually saved
        window.debugCheckOrder = async function(quoteID) {
            if (!quoteID) {
                console.error('Please provide a quote ID');
                return;
            }

            console.log(`=== CHECKING DATABASE FOR ORDER ${quoteID} ===`);

            try {
                // Query quote_sessions
                const sessionResponse = await fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/quote_sessions`);
                const sessions = await sessionResponse.json();
                const session = sessions.find(s => s.QuoteID === quoteID);

                // Query quote_items
                const itemsResponse = await fetch(`https://caspio-pricing-proxy-ab30a049961a.herokuapp.com/api/quote_items?quoteID=${encodeURIComponent(quoteID)}`);
                const items = await itemsResponse.json();

                console.log('=== DATABASE CHECK RESULTS ===');
                console.log('Session found:', session ? 'Yes' : 'No');
                if (session) {
                    console.log('Session DeliveryDate:', session.DeliveryDate);
                    console.log('Session DeliveryMethod:', session.DeliveryMethod);
                    console.log('Session Status:', session.Status);
                }

                console.log('Items found:', items.length);
                if (items.length > 0) {
                    console.log('Item[0] DeliveryDate:', items[0].DeliveryDate);
                    console.log('Item[0] DeliveryMethod:', items[0].DeliveryMethod);
                    console.log('Item[0] Shipping_Zip:', items[0].Shipping_Zip);
                    console.log('Item[0] Shipping_Address:', items[0].Shipping_Address);
                    console.log('Item[0] Shipping_City:', items[0].Shipping_City);
                    console.log('Item[0] Shipping_State:', items[0].Shipping_State);
                    console.log('Item[0] RushOrder:', items[0].RushOrder);

                    // Parse and check bundle configuration
                    try {
                        const bundleConfig = JSON.parse(items[0].BundleConfiguration);
                        console.log('Bundle Configuration:', bundleConfig);
                        console.log('- Jacket:', bundleConfig.jacket);
                        console.log('- Hoodie:', bundleConfig.hoodie);
                        console.log('- Beanie:', bundleConfig.beanie);
                        console.log('- Gloves:', bundleConfig.gloves);
                    } catch (e) {
                        console.error('Could not parse BundleConfiguration');
                    }
                }

                return { session, items };
            } catch (error) {
                console.error('Database check failed:', error);
                return null;
            }
        };

        // Run full test and check
        window.debugFullTest = async function() {
            console.log('=== RUNNING FULL DEBUG TEST ===');
            console.log('1. Submitting test order...');

            const quoteID = await window.debugSubmitTestOrder();

            if (quoteID) {
                console.log('2. Waiting 2 seconds for database...');
                await new Promise(resolve => setTimeout(resolve, 2000));

                console.log('3. Checking database...');
                const dbData = await window.debugCheckOrder(quoteID);

                console.log('4. Test complete. Check the staff dashboard for:', quoteID);
                console.log('Dashboard URL: /staff-dashboard.html');

                return { quoteID, dbData };
            } else {
                console.error('Test failed - no quote ID returned');
                return null;
            }
        };

        // Override submitQuote in ChristmasBundleQuoteService to capture quote ID
        const originalSubmitQuote = ChristmasBundleQuoteService.prototype.submitQuote;
        ChristmasBundleQuoteService.prototype.submitQuote = async function(quoteData) {
            const result = await originalSubmitQuote.call(this, quoteData);
            if (result && result.success && result.quoteID) {
                window.lastSubmittedQuoteID = result.quoteID;
            }
            return result;
        };

        // ============================================
        // SPINNER DEBUG FUNCTIONS
        // ============================================

        // Check spinner and submission state
        window.debugSpinner = function() {
            const overlay = document.getElementById('submissionOverlay');
            const submitBtn = document.getElementById('submitBtn');
            const modal = document.getElementById('successModal');

            console.log('=== SPINNER DEBUG INFO ===');
            console.log('Overlay element exists:', !!overlay);
            console.log('Overlay has "active" class:', overlay?.classList.contains('active'));
            console.log('Overlay display style:', overlay?.style.display);
            console.log('Overlay computed display:', overlay ? window.getComputedStyle(overlay).display : 'N/A');
            console.log('');
            console.log('Submission state (isSubmitting):', window.isSubmitting);
            console.log('Current step:', currentStep);
            console.log('User has interacted:', userHasInteracted);
            console.log('');
            console.log('Submit button exists:', !!submitBtn);
            console.log('Submit button disabled:', submitBtn?.disabled);
            console.log('Submit button HTML:', submitBtn?.innerHTML);
            console.log('Submit button has handlers:', submitBtn?.hasAttribute('data-handlers-attached'));
            console.log('');
            console.log('Success modal exists:', !!modal);
            console.log('Success modal has "active" class:', modal?.classList.contains('active'));

            return 'Debug info logged above';
        };

        // Force remove spinner
        window.clearSpinner = function() {
            console.log('=== FORCE CLEARING SPINNER ===');

            const overlay = document.getElementById('submissionOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                overlay.style.display = 'none';
                console.log('✓ Overlay "active" class removed');
                console.log('✓ Overlay display set to "none"');
            } else {
                console.log('✗ Overlay element not found!');
            }

            window.isSubmitting = false;
            console.log('✓ isSubmitting set to false');

            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('processing');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Order';
                console.log('✓ Submit button reset');
            } else {
                console.log('✗ Submit button not found!');
            }

            return 'Spinner cleared - try submitting again';
        };

        // Enable detailed submission flow logging
        window.debugSubmissionFlow = function() {
            console.log('=== ENABLING SUBMISSION FLOW DEBUG ===');

            // Monkey-patch submitOrder to add logging
            const originalSubmitOrder = window.submitOrder;
            window.submitOrder = async function(button) {
                console.log('📍 submitOrder called');
                console.log('  - currentStep:', currentStep);
                console.log('  - isSubmitting:', window.isSubmitting);
                console.log('  - userHasInteracted:', userHasInteracted);

                try {
                    const result = await originalSubmitOrder.call(this, button);
                    console.log('📍 submitOrder completed successfully');
                    return result;
                } catch (error) {
                    console.error('📍 submitOrder failed:', error);
                    throw error;
                }
            };

            // Monkey-patch showSuccessModal to add logging
            const originalShowSuccess = showSuccessModal;
            window.showSuccessModal = function(quoteID) {
                console.log('📍 showSuccessModal called with quote ID:', quoteID);

                const modal = document.getElementById('successModal');
                if (!modal) {
                    console.error('❌ Success modal element not found!');
                    return;
                }

                try {
                    originalShowSuccess(quoteID);
                    console.log('✓ Success modal shown');
                } catch (error) {
                    console.error('❌ Error showing success modal:', error);
                }
            };

            return 'Submission flow debugging enabled - submit an order to see detailed logs';
        };

        // Test success modal directly
        window.testSuccessModal = function() {
            console.log('=== TESTING SUCCESS MODAL ===');

            const modal = document.getElementById('successModal');
            if (!modal) {
                console.error('❌ Success modal element not found!');
                return 'Modal element missing';
            }

            const referenceNumber = document.getElementById('referenceNumber');
            if (!referenceNumber) {
                console.error('❌ Reference number element not found!');
                return 'Reference number element missing';
            }

            const orderDetails = document.getElementById('orderConfirmationDetails');
            if (!orderDetails) {
                console.error('❌ Order details element not found!');
                return 'Order details element missing';
            }

            console.log('✓ All modal elements found');

            // Try to show it with test data
            try {
                showSuccessModal('TEST-123');
                console.log('✓ Modal shown with test data');

                // Hide it after 3 seconds
                setTimeout(() => {
                    modal.classList.remove('active');
                    console.log('✓ Modal hidden');
                }, 3000);

                return 'Modal test successful - should be visible now';
            } catch (error) {
                console.error('❌ Error showing modal:', error);
                return 'Modal test failed - check console for error';
            }
        };

        // Monitor overlay changes
        window.monitorOverlay = function() {
            console.log('=== MONITORING OVERLAY CHANGES ===');

            const overlay = document.getElementById('submissionOverlay');
            if (!overlay) {
                console.error('❌ Overlay element not found!');
                return;
            }

            // Create MutationObserver to watch for changes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        console.log('📍 Overlay class changed:', overlay.className);
                        console.log('  - Has "active":', overlay.classList.contains('active'));
                    }
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        console.log('📍 Overlay style changed:', overlay.style.cssText);
                    }
                });
            });

            observer.observe(overlay, {
                attributes: true,
                attributeFilter: ['class', 'style']
            });

            console.log('✓ Now monitoring overlay changes');
            console.log('  - Current classes:', overlay.className);
            console.log('  - Current style:', overlay.style.cssText);

            // Store observer so it can be disconnected
            window.overlayObserver = observer;

            return 'Monitoring started - submit an order to see overlay changes';
        };

        console.log('Debug functions loaded. Available commands:');
        console.log('- window.debugSubmitTestOrder() - Submit a test order');
        console.log('- window.debugCheckOrder("XMAS####-###") - Check database for an order');
        console.log('- window.debugFullTest() - Run full test and check');
        console.log('');
        console.log('🔍 SPINNER DEBUG COMMANDS:');
        console.log('- window.debugSpinner() - Check spinner and submission state');
        console.log('- window.clearSpinner() - Force remove the spinner');
        console.log('- window.debugSubmissionFlow() - Enable detailed submission logging');
        console.log('- window.testSuccessModal() - Test if success modal works');
        console.log('- window.monitorOverlay() - Monitor overlay changes in real-time');
    </script>
</body>
</html>