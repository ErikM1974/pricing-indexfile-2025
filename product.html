<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWCA Pricing Tool - Product Details</title>
    <script src="tab-initializers.js"></script>
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --primary-color: #0056b3;
            --primary-light: #e6f0ff;
            --secondary-color: #5cb85c;
            --secondary-light: #eaffea;
            --text-color: #333;
            --text-light: #666;
            --border-color: #ddd;
            --border-light: #eee;
            --background-color: #fff;
            --background-light: #f8f8f8;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 20px;
            --spacing-lg: 30px;
            --font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
        }

        /* --- General & Search CSS --- */
        body {
            font-family: var(--font-family);
            padding: var(--spacing-md);
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.5;
            background-color: var(--background-light);
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--background-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-md);
        }
        
        h1 {
            color: var(--primary-color);
            font-size: 1.8em;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-light);
        }
        
        hr {
            margin: var(--spacing-lg) 0;
            border: 0;
            border-top: 1px solid var(--border-light);
        }
        
        .style-search-container {
            position: relative;
            margin-bottom: var(--spacing-md);
            max-width: 450px;
            display: flex;
            align-items: center;
            background-color: var(--background-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-sm);
        }
        
        .style-search-container label {
            margin-right: var(--spacing-sm);
            font-weight: bold;
            font-size: 0.95em;
            color: var(--primary-color);
        }
        
        #style-search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color var(--transition-fast);
        }
        
        #style-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        #search-button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1em;
            margin-left: var(--spacing-sm);
            transition: background-color var(--transition-fast);
        }
        
        #search-button:hover {
            background-color: #004494;
        }
        
        #style-suggestions-list {
            position: absolute;
            border: 1px solid var(--border-color);
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
        }
        
        .suggestions-hidden { display: none; }
        .suggestions-visible { display: block; }
        
        #style-suggestions-list div {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid var(--border-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95em;
            transition: background-color var(--transition-fast);
        }
        
        #style-suggestions-list div:last-child { border-bottom: none; }
        #style-suggestions-list div:hover { background-color: var(--primary-light); }

        /* --- Product Info & Gallery CSS --- */
        .product-gallery-container-dp2 {
            padding: var(--spacing-md) 0;
            box-sizing: border-box;
            margin-top: var(--spacing-md);
        }
        
        .product-info-wrapper-dp2 {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
            align-items: flex-start;
        }
        
        .product-image-area-dp2 {
            flex: 0 0 400px;
            max-width: 100%;
            min-width: 300px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        
        .main-image-wrapper-dp2 {
            width: 100%;
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border-color);
            min-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            overflow: hidden;
            background-color: white;
            box-shadow: var(--shadow-sm);
            position: relative;
        }
        
        #main-product-image-dp2 {
            display: block;
            max-width: 100%;
            max-height: 500px;
            height: auto;
            background-color: #fff;
            transition: transform var(--transition-normal);
        }
        
        .main-image-wrapper-dp2:hover #main-product-image-dp2 {
            transform: scale(1.03);
        }
        
        .additional-images-dp2 {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            justify-content: center;
            padding-top: var(--spacing-md);
        }
        
        .product-thumbnail-dp2 {
            width: 80px;
            height: 80px;
            border: 2px solid var(--border-color);
            object-fit: cover;
            cursor: pointer;
            border-radius: var(--radius-sm);
            opacity: 0.8;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }
        
        .product-thumbnail-dp2:hover {
            opacity: 1.0;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }
        
        .product-thumbnail-dp2.active-thumbnail {
            opacity: 1.0;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
            transform: scale(1.05);
        }
        
        .product-details-area-dp2 {
            flex: 1;
            min-width: 300px;
            box-sizing: border-box;
            padding: var(--spacing-sm);
            background-color: var(--background-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }
        
        .product-details-area-dp2 h2 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.6em;
            line-height: 1.2;
            color: var(--primary-color);
            font-weight: 600;
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
        }
        
        .product-details-area-dp2 p {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1em;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .product-details-area-dp2 p.style-number {
            color: var(--text-light);
            font-size: 0.9em;
            background-color: var(--background-light);
            display: inline-block;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
        }
        
        .product-details-area-dp2 p.selected-color {
            font-weight: bold;
            color: var(--text-color);
            font-size: 1.1em;
            margin-top: var(--spacing-sm);
        }
        
        .product-details-area-dp2 p.product-description {
            color: var(--text-color);
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-light);
            line-height: 1.7;
        }
        
        @media (max-width: 768px) {
            .product-info-wrapper-dp2 {
                flex-direction: column;
            }
            
            .product-image-area-dp2 {
                order: 1;
                width: 100%;
                max-width: 450px;
                margin: 0 auto;
            }
            
            .product-details-area-dp2 {
                order: 2;
                width: 100%;
            }
        }
        
        .loading-message, .error-message {
            padding: var(--spacing-lg);
            text-align: center;
            font-style: italic;
            color: var(--text-light);
            background-color: var(--background-light);
            border-radius: var(--radius-md);
            margin: var(--spacing-md) 0;
        }
        
        .error-message {
            color: #c00;
            font-weight: bold;
            background-color: #fff0f0;
            border: 1px solid #ffcccc;
        }

        /* --- Swatch Styles --- */
        #swatch-area, #inline-swatch-area, .product-swatches {
            margin: var(--spacing-md) 0;
            padding: var(--spacing-md);
            background-color: var(--background-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }
        
        #inline-swatch-area {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: var(--background-light);
            border-radius: var(--radius-sm);
            border-top: 1px solid var(--border-light);
            box-shadow: none;
        }
        
        #swatch-area p, #inline-swatch-area p {
            text-align: left;
            margin-bottom: var(--spacing-md);
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: var(--spacing-xs);
        }
        
        #inline-swatch-area p {
            margin-bottom: var(--spacing-sm);
            font-size: 1em;
        }
        
        .swatch-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: var(--spacing-md);
            justify-content: center;
            max-height: 320px;
            overflow-y: auto;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            background-color: var(--background-light);
        }
        #inline-swatch-area .swatch-container, .product-swatches .swatch-container {
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: var(--spacing-sm);
            max-height: 200px;
            background-color: transparent;
            padding: 0;
        }
        
        .product-swatches {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: var(--background-light);
            border-radius: var(--radius-sm);
            border-top: 1px solid var(--border-light);
        }
        
        .swatch-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            transition: transform var(--transition-fast);
        }
        
        #inline-swatch-area .swatch-wrapper, .product-swatches .swatch-wrapper {
            width: 70px;
        }
        
        .swatch-wrapper:hover {
            transform: translateY(-3px);
        }
        
        .color-swatch-item {
            width: 60px;
            height: 60px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: all var(--transition-fast);
            display: inline-block;
            overflow: hidden;
            margin-bottom: var(--spacing-xs);
            box-shadow: var(--shadow-sm);
        }
        
        #inline-swatch-area .color-swatch-item, .product-swatches .color-swatch-item {
            width: 50px;
            height: 50px;
        }
        
        .color-swatch-item:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .color-swatch-item.active-swatch {
            border-color: var(--primary-color);
            transform: scale(1.1);
            box-shadow: 0 0 0 4px var(--primary-light);
        }
        
        .color-name {
            font-size: 0.8em;
            text-align: center;
            color: var(--text-color);
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: var(--spacing-xs);
            font-weight: 500;
        }
        
        #inline-swatch-area .color-name, .product-swatches .color-name {
            max-width: 70px;
            font-size: 0.75em;
        }

        /* --- Tab Styles --- */
        .tabs-container {
            margin-top: var(--spacing-lg);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            background-color: var(--background-color);
        }
        
        .tab-nav {
            display: flex;
            flex-wrap: wrap;
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: var(--background-light);
            position: relative;
        }
        
        .tab-link {
            padding: 15px 20px;
            cursor: pointer;
            background-color: transparent;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1em;
            text-align: center;
            flex-grow: 1;
            transition: all var(--transition-fast);
            position: relative;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .tab-link:hover {
            background-color: rgba(0,0,0,0.03);
            color: var(--primary-color);
        }
        
        .tab-link.active {
            color: var(--primary-color);
            font-weight: bold;
            border-bottom: 3px solid var(--primary-color);
            background-color: var(--background-color);
        }
        
        .tab-content-panel {
            padding: var(--spacing-lg);
            border-top: none;
            visibility: hidden;
            height: 0;
            overflow: hidden;
            opacity: 0;
            position: absolute;
            z-index: -1;
            transition: opacity var(--transition-normal);
        }
        
        .tab-content-panel.active {
            visibility: visible;
            height: auto;
            overflow: visible;
            opacity: 1;
            position: static;
            z-index: 1;
        }
        
        /* Special style to hide raw JavaScript code in embroidery panel */
        #embroidery-panel pre,
        #embroidery-panel code,
        #embroidery-panel > *:not(iframe):not(.loading-message):not(#dp5-wrapper) {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            width: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Ensure iframe is visible */
        #embroidery-panel iframe {
            display: block !important;
            visibility: visible !important;
            height: 600px !important;
            width: 100% !important;
            border: none !important;
        }
        
        /* Hide script tags and code blocks in tab content */
        .tab-content-panel script,
        .tab-content-panel pre,
        .tab-content-panel code,
        pre:contains("new function"),
        pre:contains("this.appKey"),
        pre:contains("function requestDataPage"),
        /* More aggressive selectors to hide script content */
        .tab-content-panel > div:not(.loading-message):not(.iframe-container):not([id$="-wrapper"]):not(.error-message),
        .tab-content-panel > div > div:not(.loading-message):not(.iframe-container):not([id$="-wrapper"]):not(.error-message),
        .tab-content-panel:has(pre:contains("new function")),
        .tab-content-panel:has(pre:contains("this.appKey")),
        .tab-content-panel:has(pre:contains("function requestDataPage")),
        .tab-content-panel:has(pre:contains("subdomain")),
        .tab-content-panel:has(pre:contains("appKey")),
        .tab-content-panel:has(pre:contains("userQuery")),
        /* Hide any text that looks like JavaScript code */
        .tab-content-panel > :not(iframe):contains("new function"),
        .tab-content-panel > :not(iframe):contains("this.appKey"),
        .tab-content-panel > :not(iframe):contains("function requestDataPage"),
        .tab-content-panel > :not(iframe):contains("subdomain"),
        .tab-content-panel > :not(iframe):contains("appKey"),
        .tab-content-panel > :not(iframe):contains("userQuery"),
        /* Extremely aggressive selectors to hide specific JavaScript code */
        .tab-content-panel > *:not(#dp5-wrapper):not(#dp6-wrapper):not(#dp7-wrapper):not(#dp8-wrapper),
        #embroidery-panel > *:not(#dp5-wrapper),
        #cap-emb-panel > *:not(#dp7-wrapper),
        #dtg-panel > *:not(#dp6-wrapper),
        #screenprint-panel > *:not(#dp8-wrapper),
        /* Target the specific JavaScript code that's being displayed */
        .tab-content-panel pre[style*="background-color: rgb(0, 0, 0)"],
        .tab-content-panel div[style*="background-color: rgb(0, 0, 0)"],
        .tab-content-panel pre:contains("new function"),
        .tab-content-panel div:contains("new function"),
        .tab-content-panel pre:contains("this.appKey"),
        .tab-content-panel div:contains("this.appKey"),
        .tab-content-panel pre:contains("function requestDataPage"),
        .tab-content-panel div:contains("function requestDataPage"),
        .tab-content-panel pre:contains("subdomain"),
        .tab-content-panel div:contains("subdomain"),
        .tab-content-panel pre:contains("appKey"),
        .tab-content-panel div:contains("appKey"),
        .tab-content-panel pre:contains("userQuery"),
        .tab-content-panel div:contains("userQuery"),
        .tab-content-panel pre:contains("isDotNet"),
        .tab-content-panel div:contains("isDotNet"),
        .tab-content-panel pre:contains("targetScript"),
        .tab-content-panel div:contains("targetScript"),
        .tab-content-panel pre:contains("document.getElementsByTagName"),
        .tab-content-panel div:contains("document.getElementsByTagName"),
        .tab-content-panel pre:contains("document.createElement"),
        .tab-content-panel div:contains("document.createElement") {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            width: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Add a style to ensure iframes are visible */
        .tab-content-panel iframe {
            display: block !important;
            visibility: visible !important;
            height: 600px !important;
            width: 100% !important;
            border: none !important;
            margin-top: 15px !important;
        }
        
        /* Style for iframe containers */
        .iframe-container {
            width: 100%;
            min-height: 600px;
            border: none;
            margin-top: 15px;
        }
        
        /* Special styles for embroidery panels to hide script content */
        #embroidery-panel, #cap-emb-panel, #dtg-panel, #screenprint-panel {
            position: relative;
        }
        
        #embroidery-panel > *:not(#dp5-wrapper),
        #cap-emb-panel > *:not(#dp7-wrapper),
        #dtg-panel > *:not(#dp6-wrapper),
        #screenprint-panel > *:not(#dp8-wrapper) {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            width: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Extremely aggressive styles for embroidery panel */
        #embroidery-panel {
            position: relative;
            overflow: hidden;
        }
        
        #embroidery-panel::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 1;
        }
        
        #embroidery-panel #dp5-wrapper {
            position: relative;
            z-index: 2;
        }
        
        #embroidery-panel #dp5-wrapper .loading-message,
        #embroidery-panel #dp5-wrapper .iframe-container,
        #embroidery-panel #dp5-wrapper iframe {
            position: relative;
            z-index: 3;
            display: block !important;
            visibility: visible !important;
        }
        
        /* Hide all direct text nodes in the panel */
        #embroidery-panel > :not(#dp5-wrapper) {
            font-size: 0 !important;
            color: transparent !important;
            background: transparent !important;
        }
        
        /* Ensure wrapper divs are visible */
        #dp5-wrapper, #dp6-wrapper, #dp7-wrapper, #dp8-wrapper {
            display: block !important;
            visibility: visible !important;
            width: 100% !important;
            min-height: 600px !important;
        }

        /* --- Custom Inventory Table Styles --- */
        #inventory-area h4 {
            margin-bottom: var(--spacing-md);
            font-size: 1.2em;
            color: var(--primary-color);
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--border-light);
        }
        
        #inventory-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--border-color);
            font-size: 0.95em;
            margin-top: var(--spacing-md);
            border-radius: var(--radius-sm);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        #inventory-table th,
        #inventory-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            vertical-align: middle;
        }
        
        #inventory-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            text-align: center;
            position: sticky;
            top: 0;
        }
        
        #inventory-table th:first-child {
            text-align: left;
            border-top-left-radius: var(--radius-sm);
        }
        
        #inventory-table th:last-child {
            border-top-right-radius: var(--radius-sm);
        }
        
        #inventory-table td:nth-child(n+2) {
            text-align: center;
        }
        
        #inventory-table tbody tr:nth-child(even) {
            background-color: var(--background-light);
        }
        
        #inventory-table tbody tr:hover {
            background-color: var(--primary-light);
        }
        
        #inventory-table tfoot td {
            font-weight: bold;
            background-color: var(--background-light);
            border-top: 2px solid var(--primary-color);
        }
        
        #inventory-table tfoot td:first-child {
            text-align: left;
        }

        /* --- Embedded DP Styles --- */
         #inventory-panel > #inventory-area { padding: 0; margin-top: 0; }
         .tab-content-panel > div[id$="-wrapper"] { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;}
         .tab-content-panel > div[id$="-wrapper"]:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}

        /* Gallery item styling from index.html */
        a.gallery-item-link {
            display: block;           /* Make the link behave like a block/box */
            text-align: center;       /* Center the product title text */
            text-decoration: none;    /* Remove underline from text */
            color: #333333;          /* Set text color (dark grey) */
            font-size: 0.9em;         /* Adjust font size */
            line-height: 1.3;         /* Adjust line spacing */
            padding: 5px;             /* Add a little padding inside the link area */
            height: 100%;             /* Make link fill its container vertically */
            box-sizing: border-box;   /* Include padding in height/width */
        }

        /* Style the image specifically within this link */
        a.gallery-item-link img {
            display: block !important;            /* Make image a block */
            margin: 0 auto 10px auto !important;  /* FORCE center image horizontally, add 10px space below */
            max-width: 100% !important;           /* FORCE image to fit container width */
            height: auto !important;              /* FORCE height to adjust automatically */
            width: auto !important;               /* FORCE override of inline width */
            border-radius: 3px;                   /* Optional: slightly rounded image corners */
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Product Search and Details</h1>

    <div class="back-button-container">
        <a href="/index.html" class="back-to-gallery-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px; vertical-align: text-bottom;">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Gallery
        </a>
    </div>

    <div class="style-search-container">
        <label for="style-search-input">Search Style:</label>
        <input type="text" id="style-search-input" placeholder="Enter Style (e.g., PC61)" autocomplete="off">
        <button id="search-button">Search</button>
        <div id="style-suggestions-list" class="suggestions-hidden"></div>
    </div>

    <hr>

    <div id="product-info-area"></div>
    <div id="swatch-area" style="display: none;"></div> <!-- Hidden but kept for backward compatibility -->
    <!-- Swatch area moved into product-info-area via JavaScript -->

    <hr>

    <div class="tabs-container">
        <div class="tab-nav">
            <a href="#" class="tab-link active" data-tab-target="#inventory-panel">Inventory</a>
        </div>
        
        <!-- Pricing Options -->
        <div class="pricing-options" style="padding: 20px; margin-top: 20px; border-top: 1px solid #ddd;">
            <h3 style="margin-top: 0; color: var(--primary-color); font-size: 1.4em; margin-bottom: 15px;">Pricing Options</h3>
            <p style="margin-bottom: 20px;">Click on any option below to view detailed pricing information:</p>
            
            <div class="pricing-links" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                <a href="/pricing/embroidery?StyleNumber={styleNumber}&COLOR={colorCode}" class="pricing-link" style="display: flex; flex-direction: column; align-items: center; width: 150px; padding: 20px; background-color: var(--background-light); border-radius: 8px; text-decoration: none; color: var(--text-color); transition: all 0.3s; border: 1px solid var(--border-color);">
                    <div class="pricing-icon" style="font-size: 2em; margin-bottom: 10px;">🧵</div>
                    <div class="pricing-name" style="font-weight: bold; text-align: center;">Embroidery</div>
                </a>
                <a href="/pricing/cap-embroidery?StyleNumber={styleNumber}&COLOR={colorCode}" class="pricing-link" style="display: flex; flex-direction: column; align-items: center; width: 150px; padding: 20px; background-color: var(--background-light); border-radius: 8px; text-decoration: none; color: var(--text-color); transition: all 0.3s; border: 1px solid var(--border-color);">
                    <div class="pricing-icon" style="font-size: 2em; margin-bottom: 10px;">🧢</div>
                    <div class="pricing-name" style="font-weight: bold; text-align: center;">Cap Embroidery</div>
                </a>
                <a href="/pricing/dtg?StyleNumber={styleNumber}&COLOR={colorCode}" class="pricing-link" style="display: flex; flex-direction: column; align-items: center; width: 150px; padding: 20px; background-color: var(--background-light); border-radius: 8px; text-decoration: none; color: var(--text-color); transition: all 0.3s; border: 1px solid var(--border-color);">
                    <div class="pricing-icon" style="font-size: 2em; margin-bottom: 10px;">👕</div>
                    <div class="pricing-name" style="font-weight: bold; text-align: center;">DTG</div>
                </a>
                <a href="/pricing/screen-print?StyleNumber={styleNumber}&COLOR={colorCode}" class="pricing-link" style="display: flex; flex-direction: column; align-items: center; width: 150px; padding: 20px; background-color: var(--background-light); border-radius: 8px; text-decoration: none; color: var(--text-color); transition: all 0.3s; border: 1px solid var(--border-color);">
                    <div class="pricing-icon" style="font-size: 2em; margin-bottom: 10px;">🖨️</div>
                    <div class="pricing-name" style="font-weight: bold; text-align: center;">Screen Print</div>
                </a>
                <a href="/pricing/dtf?StyleNumber={styleNumber}&COLOR={colorCode}" class="pricing-link" style="display: flex; flex-direction: column; align-items: center; width: 150px; padding: 20px; background-color: var(--background-light); border-radius: 8px; text-decoration: none; color: var(--text-color); transition: all 0.3s; border: 1px solid var(--border-color);">
                    <div class="pricing-icon" style="font-size: 2em; margin-bottom: 10px;">🎨</div>
                    <div class="pricing-name" style="font-weight: bold; text-align: center;">DTF</div>
                </a>
            </div>
        </div>

        <div class="tab-content">
            <div id="inventory-panel" class="tab-content-panel active">
                <div id="inventory-area">
                    <p><i>Select a style to load inventory...</i></p>
                </div>
            </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                console.log("DOM Loaded. Initializing scripts...");
        
                // --- Global State ---
                window.selectedStyleNumber = null;
                window.selectedColorName = null;
                window.selectedCatalogColor = null;
        
                // --- API URL ---
                const API_PROXY_BASE_URL = 'https://caspio-pricing-proxy-ab30a049961a.herokuapp.com';
                console.log("API Base URL:", API_PROXY_BASE_URL);
        
                // --- DOM Element References ---
                const styleSearchInput = document.getElementById('style-search-input');
                const searchButton = document.getElementById('search-button');
                const suggestionsList = document.getElementById('style-suggestions-list');
                const productInfoArea = document.getElementById('product-info-area');
                const swatchArea = document.getElementById('swatch-area');
                const inventoryArea = document.getElementById('inventory-area');
                const tabNav = document.querySelector('.tab-nav');
                const tabLinks = document.querySelectorAll('.tab-link');
                const tabContentPanels = document.querySelectorAll('.tab-content-panel');
        
                // --- Helper Functions ---
                function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
                function sortSizesLogical(sizes) { const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL', '6XL', 'OSFM']; const knownSizes = sizes.filter(s => s && sizeOrder.includes(s.toUpperCase())).sort((a, b) => sizeOrder.indexOf(a.toUpperCase()) - sizeOrder.indexOf(b.toUpperCase())); const numericSizes = sizes.filter(s => s && !isNaN(parseInt(s))).sort((a, b) => parseInt(a) - parseInt(b)); const otherSizes = sizes.filter(s => s && isNaN(parseInt(s)) && !sizeOrder.includes(s.toUpperCase())).sort(); return [...knownSizes, ...numericSizes, ...otherSizes]; }
        
                // --- Autocomplete Functions ---
                async function fetchStyleSuggestions(searchTerm) {
                     console.log("StyleSearch: fetchStyleSuggestions called with term:", searchTerm); if (!styleSearchInput || !suggestionsList) return; if (!searchTerm || searchTerm.length < 2) { clearSuggestions(); return; } console.log("StyleSearch: Fetching suggestions from API..."); const searchUrl = `${API_PROXY_BASE_URL}/api/stylesearch?term=${encodeURIComponent(searchTerm)}`; console.log("StyleSearch: API URL:", searchUrl); try { const response = await fetch(searchUrl); console.log("StyleSearch: API Response Status:", response.status); if (!response.ok) { const errorText = await response.text(); console.error("StyleSearch: API Response Text:", errorText); throw new Error(`API Error ${response.status}: ${response.statusText}`); } const suggestions = await response.json(); console.log("StyleSearch: Suggestions received from API:", suggestions); displaySuggestions(suggestions); } catch (error) { console.error("StyleSearch: Failed to fetch or parse suggestions:", error); clearSuggestions(); }
                 }
                function displaySuggestions(suggestions) {
                     console.log("StyleSearch: displaySuggestions called with:", suggestions); if (!suggestionsList) return; clearSuggestions(); if (!suggestions || suggestions.length === 0) { console.log("StyleSearch: No suggestions to display."); suggestionsList.classList.replace('suggestions-visible', 'suggestions-hidden'); return; } suggestions.forEach(suggestion => { const div = document.createElement('div'); div.textContent = suggestion.label; div.dataset.styleNumber = suggestion.value; div.addEventListener('click', () => { handleSuggestionSelection(suggestion.value, suggestion.label); }); suggestionsList.appendChild(div); }); suggestionsList.classList.replace('suggestions-hidden', 'suggestions-visible'); console.log("StyleSearch: Suggestions displayed.");
                }
                function clearSuggestions() { if (suggestionsList) { suggestionsList.innerHTML = ''; suggestionsList.classList.replace('suggestions-visible', 'suggestions-hidden'); } }
                function handleSuggestionSelection(selectedStyleNumber, selectedLabel) {
                     console.log("StyleSearch: Style selected:", selectedStyleNumber); if (styleSearchInput) { styleSearchInput.value = selectedStyleNumber; } clearSuggestions();
                     updatePageForStyle(selectedStyleNumber); // Trigger updates
                }
        
                // --- Product Details Functions ---
                async function loadProductInfo(styleNumber, colorName) {
                     console.log(`ProductInfo: Loading details for Style: ${styleNumber}, Color: ${colorName || 'Initial Load'}`);
                     if (!productInfoArea) return;
        
                     // If it's not the initial load (colorName is provided), only update images and color name
                     if (colorName) {
                         console.log("ProductInfo: Updating existing details for new color.");
                         const colorNameSpan = document.getElementById('product-info-color-name');
                         if (colorNameSpan) colorNameSpan.textContent = colorName || 'N/A';
        
                         // Fetch only image details if needed, or assume base details object is sufficient
                         // For simplicity, let's assume we need to fetch again to get color-specific images
                         const catalogColor = window.selectedCatalogColor || colorName;
                         const detailApiUrl = `${API_PROXY_BASE_URL}/api/product-details?styleNumber=${encodeURIComponent(styleNumber)}&COLOR_NAME=${encodeURIComponent(colorName)}&CATALOG_COLOR=${encodeURIComponent(catalogColor)}`;
                         console.log(`ProductInfo: Fetching image details from URL: ${detailApiUrl}`);
                         try {
                             const response = await fetch(detailApiUrl);
                             if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                             const details = await response.json();
                             
                             const mainImageUrl = details.FRONT_MODEL || details.FRONT_FLAT || '';
                             const altText = `Product image for ${details.PRODUCT_TITLE || styleNumber} - ${colorName}`;
                             const thumb1 = details.FRONT_MODEL;
                             const thumb2 = details.BACK_FLAT;
                             const thumb3 = details.BACK_MODEL;
                             const thumb4 = details.FRONT_FLAT;
        
                             // Update only the image elements
                             const mainImage = document.getElementById('main-product-image-dp2');
                             const additionalImagesContainer = productInfoArea.querySelector('.additional-images-dp2');
                             
                             if (mainImage) {
                                 mainImage.src = mainImageUrl;
                                 mainImage.alt = altText;
                             }
                             if (additionalImagesContainer) {
                                 additionalImagesContainer.innerHTML = `
                                     ${createThumbnailHtml(thumb1, altText)}
                                     ${createThumbnailHtml(thumb4, altText)}
                                     ${createThumbnailHtml(thumb2, altText)}
                                     ${createThumbnailHtml(thumb3, altText)}
                                 `;
                                 setupImageGallery(); // Re-setup gallery listeners
                             }
                             console.log("ProductInfo: Images updated for new color.");
        
                         } catch (error) {
                             console.error("ProductInfo: Failed to update images for color:", error);
                             // Optionally display an error message near the images
                         }
                         return; // Exit after updating color-specific parts
                     }
        
                     // --- Initial Load Logic ---
                     console.log("ProductInfo: Performing initial load.");
                     productInfoArea.innerHTML = '<div class="loading-message">Loading product details...</div>';
                     
                     const detailApiUrl = `${API_PROXY_BASE_URL}/api/product-details?styleNumber=${encodeURIComponent(styleNumber)}`;
                     console.log(`ProductInfo: Fetching initial details from URL: ${detailApiUrl}`);
                     
                     try {
                         const response = await fetch(detailApiUrl);
                         if (!response.ok) {
                             if (response.status === 404) throw new Error(`Details not found.`);
                             else throw new Error(`API Error: ${response.statusText}`);
                         }
                         
                         const details = await response.json();
                         console.log(`ProductInfo: Received initial data:`, details);
                         
                         const mainImageUrl = details.FRONT_MODEL || details.FRONT_FLAT || '';
                         const altText = `Product image for ${details.PRODUCT_TITLE || styleNumber} - Default`;
                         const thumb1 = details.FRONT_MODEL;
                         const thumb2 = details.BACK_FLAT;
                         const thumb3 = details.BACK_MODEL;
                         const thumb4 = details.FRONT_FLAT;
        
                         // Build the full HTML structure including the inline swatch placeholder
                         productInfoArea.innerHTML = `<div class="product-gallery-container-dp2">
                             <div class="product-info-wrapper-dp2">
                                 <div class="product-image-area-dp2">
                                     <div class="main-image-wrapper-dp2">
                                         <img id="main-product-image-dp2" src="${mainImageUrl}" alt="${altText}" onerror="this.style.display='none';">
                                     </div>
                                     <div class="additional-images-dp2">
                                         ${createThumbnailHtml(thumb1, altText)}
                                         ${createThumbnailHtml(thumb4, altText)}
                                         ${createThumbnailHtml(thumb2, altText)}
                                         ${createThumbnailHtml(thumb3, altText)}
                                     </div>
                                 </div>
                                 <div class="product-details-area-dp2">
                                     <h2>${details.PRODUCT_TITLE || ''}</h2>
                                     <p class="style-number">Style: ${styleNumber}</p>
                                     <p class="selected-color">Color: <span id="product-info-color-name">Select Color</span></p>
                                     <p class="product-description">${details.PRODUCT_DESCRIPTION || ''}</p>
                                     <!-- Inline swatch area - will be populated by loadSwatches function -->
                                     <div id="inline-swatch-area" class="product-swatches"></div>
                                 </div>
                             </div>
                         </div>`;
                         
                         setupImageGallery();
                     } catch (error) {
                         console.error("ProductInfo: Failed to load initial details:", error);
                         if (productInfoArea) productInfoArea.innerHTML = `<div class="error-message">Error loading product details: ${error.message}</div>`;
                     }
                 }
                // --- Thumbnail Click Handler ---
                function handleThumbnailClick(event) {
                    if (!event.target.classList.contains('product-thumbnail-dp2')) return;
                    
                    const clickedThumb = event.target;
                    const mainImage = document.getElementById('main-product-image-dp2');
                    const thumbnailContainer = clickedThumb.closest('.additional-images-dp2');
                    
                    if (!mainImage || !thumbnailContainer) return;
                    
                    const newImageSrc = clickedThumb.getAttribute('src');
                    if (newImageSrc) {
                        mainImage.setAttribute('src', newImageSrc);
                        
                        // Update active thumbnail styling
                        const allThumbnails = thumbnailContainer.querySelectorAll('.product-thumbnail-dp2');
                        allThumbnails.forEach(t => {
                            t.classList.remove('active-thumbnail');
                            t.style.opacity = '0.7';
                            t.style.border = '1px solid #ccc';
                        });
                        
                        clickedThumb.classList.add('active-thumbnail');
                        clickedThumb.style.opacity = '1.0';
                        clickedThumb.style.border = '2px solid #007bff';
                        
                        console.log('ImageGallery: Main image updated.');
                    }
                }
        
                // --- Swatch Functions ---
                async function loadSwatches(styleNumber) {
                     console.log(`Swatches: Loading for Style: ${styleNumber}`);
                     
                     // Target the inline swatch area directly
                     const inlineSwatchArea = document.getElementById('inline-swatch-area');
                     
                     if (!inlineSwatchArea) {
                         // This should ideally not happen if loadProductInfo ran correctly
                         console.error("Swatches: Critical Error - Inline swatch area (#inline-swatch-area) not found in DOM.");
                         // Optionally update the hidden original area as a fallback?
                         const originalSwatchArea = document.getElementById('swatch-area');
                         if (originalSwatchArea) {
                             originalSwatchArea.innerHTML = '<div class="error-message">Error displaying swatches inline.</div>';
                         }
                         return;
                     }
                     
                     console.log("Swatches: Found inline swatch area. Setting loading message.");
                     inlineSwatchArea.innerHTML = '<div class="loading-message">Loading swatches...</div>';
                     
                     // Keep a reference to the target area
                     const swatchArea = inlineSwatchArea;
                     
                     swatchArea.innerHTML = '<div class="loading-message">Loading swatches...</div>';
                     
                     const swatchApiUrl = `${API_PROXY_BASE_URL}/api/color-swatches?styleNumber=${encodeURIComponent(styleNumber)}`;
                     
                     try {
                         const response = await fetch(swatchApiUrl);
                         if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                         
                         const swatches = await response.json();
                         console.log(`Swatches: Data received: ${swatches.length} records`);
                         
                         // Clear the inline area
                         inlineSwatchArea.innerHTML = '';
                         
                         if (!swatches || swatches.length === 0) {
                             inlineSwatchArea.innerHTML = '<p>No color options found.</p>';
                             return;
                         }
                         
                         // Create content directly in the inline area
                         const title = document.createElement('p');
                         title.textContent = 'Available Colors:';
                         inlineSwatchArea.appendChild(title);
                         
                         const container = document.createElement('div');
                         container.className = 'swatch-container';
                         inlineSwatchArea.appendChild(container);
                     // *** FIX: De-duplicate swatches by COLOR_NAME before creating elements ***
                     const uniqueSwatchesMap = new Map();
                     swatches.filter(s => s.COLOR_NAME && s.COLOR_SQUARE_IMAGE) // Ensure valid data
                             .forEach(swatch => {
                                 if (!uniqueSwatchesMap.has(swatch.COLOR_NAME)) {
                                     uniqueSwatchesMap.set(swatch.COLOR_NAME, swatch);
                                 }
                             });
        
                     const uniqueSortedSwatches = Array.from(uniqueSwatchesMap.values())
                                                      .sort((a, b) => a.COLOR_NAME.localeCompare(b.COLOR_NAME));
        
                     console.log(`Swatches: Displaying ${uniqueSortedSwatches.length} unique valid swatches.`);
        
                     // Function to create a swatch element
                     const createSwatchElement = (swatch, targetContainer) => {
                         const swatchWrapper = document.createElement('div');
                         swatchWrapper.className = 'swatch-wrapper';
                         const swatchElement = document.createElement('div');
                         swatchElement.className = 'color-swatch-item';
                         swatchElement.title = swatch.COLOR_NAME;
                         swatchElement.style.backgroundImage = `url('${swatch.COLOR_SQUARE_IMAGE}')`;
                         swatchElement.dataset.colorName = swatch.COLOR_NAME;
                         swatchElement.dataset.catalogColor = swatch.CATALOG_COLOR;
                         swatchElement.addEventListener('click', handleSwatchClick);
                         const colorNameElement = document.createElement('div');
                         colorNameElement.className = 'color-name';
                         colorNameElement.textContent = swatch.COLOR_NAME;
                         swatchWrapper.appendChild(swatchElement);
                         swatchWrapper.appendChild(colorNameElement);
                         targetContainer.appendChild(swatchWrapper);
                         return swatchElement;
                     };
                     
                     // Add swatches to the inline container
                     let firstSwatchElement = null;
                     
                     uniqueSortedSwatches.forEach(swatch => { // Iterate over unique swatches
                         const element = createSwatchElement(swatch, container); // Append to the inline container
                         if (!firstSwatchElement) firstSwatchElement = element;
                     });
                     
                     console.log(`Swatches: Appended ${uniqueSortedSwatches.length} swatch elements to #inline-swatch-area.`);
                     
                     // Auto-click first swatch
                     if (firstSwatchElement) {
                         console.log("Swatches: Auto-clicking first swatch:", firstSwatchElement.dataset.colorName);
                         firstSwatchElement.click();
                     } else {
                         console.log("Swatches: No first swatch element found to auto-click.");
                     }
                     } catch (error) {
                         console.error("Swatches: Failed to load:", error);
                         if (swatchArea) {
                             swatchArea.innerHTML = `<div class="error-message">Error loading swatches: ${error.message}</div>`;
                         }
                     }
                 }
                function handleSwatchClick(event) {
                    const clickedSwatch = event.currentTarget;
                    const colorIndex = clickedSwatch.dataset.colorIndex;
                    
                    // Find the color object in our stored data
                    const colorObject = window.currentProductData.colors[colorIndex] ||
                                      window.currentProductData.colors.find(c =>
                                          c.CATALOG_COLOR === clickedSwatch.dataset.catalogColor ||
                                          c.COLOR_NAME === clickedSwatch.dataset.colorName
                                      );
                    
                    if (!colorObject) {
                        console.error("Swatches: Could not find color object for clicked swatch");
                        return;
                    }
                    
                    console.log(`Swatches: Clicked Color: ${colorObject.COLOR_NAME}, Code: ${colorObject.CATALOG_COLOR}`);
                    
                    // Update active swatch styling
                    const allSwatches = document.querySelectorAll('#swatch-area .color-swatch-item, #inline-swatch-area .color-swatch-item');
                    allSwatches.forEach(sw => sw.classList.remove('active-swatch'));
                    clickedSwatch.classList.add('active-swatch');
                    
                    // Update product display with the selected color
                    updateProductDisplayForColor(colorObject);
                    
                    // Update inventory and pricing
                    loadInventory(window.selectedStyleNumber, colorObject.CATALOG_COLOR);
                    triggerPricingDataPageUpdates(window.selectedStyleNumber, colorObject.CATALOG_COLOR);
                    updatePricingLinks(window.selectedStyleNumber, colorObject.COLOR_NAME);
                }
        
                // --- Inventory Update Function (Using New Tabular API) ---
                 async function loadInventory(styleNumber, catalogColor) {
                      console.log(`Inventory: Loading for Style: ${styleNumber}, Color Code: ${catalogColor || 'ALL'}`);
                      if (!inventoryArea) {
                          console.error("Inventory display area not found!");
                          return;
                      }
                      
                      inventoryArea.innerHTML = '<div class="loading-message">Loading Inventory...</div>';
                      
                      // Use the new endpoint that returns data in tabular format
                      let inventoryApiUrl = `${API_PROXY_BASE_URL}/api/sizes-by-style-color?styleNumber=${encodeURIComponent(styleNumber)}`;
                      if (catalogColor) {
                          inventoryApiUrl += `&color=${encodeURIComponent(catalogColor)}`;
                      }
                      console.log("Inventory API URL:", inventoryApiUrl);
                      
                      try {
                           const response = await fetch(inventoryApiUrl);
                           if (!response.ok) {
                               throw new Error(`API Error fetching inventory: ${response.statusText}`);
                           }
                           
                           const data = await response.json();
                           console.log("Inventory data received:", data);
                           
                           if (!data || !data.sizes || data.sizes.length === 0 || !data.warehouses || data.warehouses.length === 0) {
                               inventoryArea.innerHTML = '<div class="info-message" style="padding: 15px; background-color: #f8f9fa; border-left: 4px solid #17a2b8; margin: 15px 0;"><p>No inventory data available for this style/color combination.</p></div>';
                               return;
                           }
                           
                           // Extract data from the response
                           const { style, color, sizes, warehouses, sizeTotals, grandTotal } = data;
                           
                           // Build the HTML for the inventory table
                           let tableHtml = `<h4>Inventory Levels (${color})</h4>`;
                           
                           tableHtml += '<table id="inventory-table"><thead><tr><th>Warehouse</th>';
                           
                           // Create table headers with sizes
                           sizes.forEach(size => {
                               tableHtml += `<th>${size}</th>`;
                           });
                           
                           tableHtml += '</tr></thead><tbody>';
                           
                           // Create table rows for each warehouse
                           warehouses.forEach(warehouse => {
                               tableHtml += `<tr><td>${warehouse.name}</td>`;
                               
                               // Add cells for each size's inventory quantity
                               warehouse.inventory.forEach((quantity, index) => {
                                   // Color coding based on quantity
                                   let textColor;
                                   if (quantity <= 0) {
                                       textColor = '#E53935'; // Red for no stock
                                   } else if (quantity < 24) {
                                       textColor = '#F57C00'; // Orange for low stock
                                   } else {
                                       textColor = '#388E3C'; // Green for good stock
                                   }
                                   
                                   tableHtml += `<td style="text-align:center; color: ${textColor}; ${quantity < 24 && quantity > 0 ? 'font-weight: bold;' : ''}">${quantity}</td>`;
                               });
                               
                               tableHtml += '</tr>';
                           });
                           
                           // Add totals row
                           tableHtml += '</tbody><tfoot><tr>';
                           tableHtml += '<td>TOTAL INVENTORY</td>';
                           
                           // Add total cells for each size
                           sizeTotals.forEach(total => {
                               tableHtml += `<td style="text-align:center; font-weight: bold;">${total}</td>`;
                           });
                           
                           tableHtml += '</tr></tfoot></table>';
                           
                           inventoryArea.innerHTML = tableHtml;
                      } catch (error) {
                          console.error("Inventory: Failed to load:", error);
                          if (inventoryArea) {
                              inventoryArea.innerHTML = `<div class="error-message">Error loading inventory: ${error.message}</div>`;
                          }
                      }
                 }
        
                // --- Pricing Calculators Trigger Function ---
                 function triggerPricingDataPageUpdates(styleNumber, catalogColor) {
                      console.log(`Pricing: Triggering update for Style=${styleNumber}, Color=${catalogColor}`);
                      // Set global vars for DPs to read
                      window.selectedStyleNumber = styleNumber;
                      window.selectedCatalogColor = catalogColor;
                      window.selectedColorName = window.selectedColorName; // Keep existing name
                      
                      // Update URL with parameters
                      const url = new URL(window.location);
                      url.searchParams.set('StyleNumber', styleNumber);
                      
                      // Always use the catalog color code for URL parameters instead of color name
                      // This ensures better compatibility with the Caspio datapage
                      if (catalogColor) {
                          console.log(`Using catalog color code for URL parameter: ${catalogColor}`);
                          url.searchParams.set('COLOR', catalogColor);
                      } else if (window.selectedColorName) {
                          console.log(`No catalog color available, using color name: ${window.selectedColorName}`);
                          url.searchParams.set('COLOR', window.selectedColorName);
                      }
                      
                      window.history.replaceState({}, '', url);
                      console.log("URL updated with parameters:", url.search);
        
                      // Call each pricing calculator's init function
                      if (typeof initDp5ApiFetch === 'function') {
                          console.log("Calling initDp5ApiFetch with styleNumber:", styleNumber);
                          initDp5ApiFetch(styleNumber);
                      }
                      if (typeof initDp6ApiFetch === 'function') {
                          console.log("Calling initDp6ApiFetch with styleNumber:", styleNumber);
                          initDp6ApiFetch(styleNumber);
                      }
                      if (typeof initDp7ApiFetch === 'function') {
                          console.log("Calling initDp7ApiFetch with styleNumber:", styleNumber);
                          initDp7ApiFetch(styleNumber);
                      }
                      if (typeof initDp8ApiFetch === 'function') {
                          console.log("Calling initDp8ApiFetch with styleNumber:", styleNumber);
                          initDp8ApiFetch(styleNumber);
                      }
                      if (typeof initDtfApiFetch === 'function') {
                          console.log("Calling initDtfApiFetch with styleNumber:", styleNumber);
                          initDtfApiFetch(styleNumber);
                      }
                 }
                 
                 // --- Update Pricing Links Function ---
                 function updatePricingLinks(styleNumber, colorCode) {
                     console.log(`Updating pricing links for Style=${styleNumber}, Color=${colorCode || 'N/A'}`);
                     
                     if (!styleNumber) {
                         console.warn("Cannot update pricing links: No style number provided");
                         return;
                     }
                     
                     // Make sure we're using the current selected color if one isn't provided
                     if (!colorCode && window.selectedColorName) {
                         colorCode = window.selectedColorName;
                         console.log(`No color code provided, using selected color name: ${colorCode}`);
                     }
                     
                     // Always prefer the catalog color code over the color name for better compatibility with Caspio
                     const colorToUse = window.selectedCatalogColor || colorCode;
                     console.log(`Using color for pricing links: ${colorToUse}`);
                     
                     const pricingLinks = document.querySelectorAll('.pricing-link');
                     pricingLinks.forEach(link => {
                         // Get the link's base path (e.g., "/pricing/embroidery")
                         const currentHref = link.getAttribute('href');
                         const urlParts = currentHref.split('?');
                         const basePath = urlParts[0]; // This should be like "/pricing/embroidery", "/pricing/dtg", etc.
                         
                         // Reconstruct the new href with the current style and selected color
                         // Ensure styleNumber and colorToUse are properly encoded for URLs
                         const newHref = `${basePath}?StyleNumber=${encodeURIComponent(styleNumber)}&COLOR=${encodeURIComponent(colorToUse || '')}`;
                         
                         // Log the constructed URL for debugging
                         console.log(`DEBUG - Pricing link for ${basePath}: ${newHref}`);
                         
                         // Set the updated href attribute on the link
                         link.setAttribute('href', newHref);
                         
                         // Add hover effect
                         link.addEventListener('mouseover', function() {
                             this.style.transform = 'translateY(-5px)';
                             this.style.boxShadow = 'var(--shadow-md)';
                             this.style.borderColor = 'var(--primary-color)';
                         });
                         
                         link.addEventListener('mouseout', function() {
                             this.style.transform = 'translateY(0)';
                             this.style.boxShadow = 'var(--shadow-sm)';
                             this.style.borderColor = 'var(--border-color)';
                         });
                     });
                     
                     console.log("Pricing links updated successfully");
                 }
         
                // --- New Product Data Loading Function ---
                async function loadProductData(styleNumber) {
                    console.log(`ProductData: Loading data for Style: ${styleNumber}`);
                    if (!productInfoArea) return;

                    // Show loading message
                    productInfoArea.innerHTML = '<div class="loading-message">Loading product details...</div>';
                    
                    // Make a single call to the product-colors endpoint
                    const productApiUrl = `${API_PROXY_BASE_URL}/api/product-colors?styleNumber=${encodeURIComponent(styleNumber)}`;
                    console.log(`ProductData: Fetching from URL: ${productApiUrl}`);
                    
                    try {
                        const response = await fetch(productApiUrl);
                        if (!response.ok) {
                            if (response.status === 404) throw new Error(`Product not found.`);
                            else throw new Error(`API Error: ${response.statusText}`);
                        }
                        
                        // Store the entire response in a global variable
                        const productData = await response.json();
                        window.currentProductData = productData;
                        console.log(`ProductData: Received data:`, productData);
                        
                        // Check if we have valid data
                        if (!productData || !productData.colors || productData.colors.length === 0) {
                            throw new Error('No product data or colors available.');
                        }
                        
                        // Build the initial product display structure
                        buildProductDisplay(productData, styleNumber);
                        
                        // Generate and display color swatches
                        generateColorSwatches(productData.colors);
                        
                        // Determine initial color to display
                        const urlParams = new URLSearchParams(window.location.search);
                        const colorParam = urlParams.get('COLOR') || urlParams.get('catalogColor');
                        
                        // Find the color in our data
                        let initialColorObject = null;
                        
                        if (colorParam) {
                            // Try to match by CATALOG_COLOR first, then by COLOR_NAME
                            initialColorObject = productData.colors.find(c =>
                                c.CATALOG_COLOR === colorParam || c.COLOR_NAME === colorParam
                            );
                        }
                        
                        // If no color found from URL or no URL parameter, use the first color
                        if (!initialColorObject && productData.colors.length > 0) {
                            initialColorObject = productData.colors[0];
                        }
                        
                        // Update display with the selected color
                        if (initialColorObject) {
                            updateProductDisplayForColor(initialColorObject);
                            
                            // Highlight the corresponding swatch
                            const swatches = document.querySelectorAll('#inline-swatch-area .color-swatch-item');
                            swatches.forEach(swatch => {
                                if (swatch.dataset.catalogColor === initialColorObject.CATALOG_COLOR) {
                                    swatch.classList.add('active-swatch');
                                }
                            });
                            
                            // Update inventory and pricing
                            loadInventory(styleNumber, initialColorObject.CATALOG_COLOR);
                            triggerPricingDataPageUpdates(styleNumber, initialColorObject.CATALOG_COLOR);
                            updatePricingLinks(styleNumber, initialColorObject.COLOR_NAME);
                        }
                        
                    } catch (error) {
                        console.error("ProductData: Failed to load:", error);
                        if (productInfoArea) {
                            productInfoArea.innerHTML = `<div class="error-message">Error loading product data: ${error.message}</div>`;
                        }
                    }
                }

                // --- Helper function to build the initial product display ---
                function buildProductDisplay(productData, styleNumber) {
                    console.log("ProductDisplay: Building initial display");
                    
                    // Create the basic structure
                    productInfoArea.innerHTML = `<div class="product-gallery-container-dp2">
                        <div class="product-info-wrapper-dp2">
                            <div class="product-image-area-dp2">
                                <div class="main-image-wrapper-dp2">
                                    <img id="main-product-image-dp2" src="" alt="Product image" onerror="this.style.display='none';">
                                </div>
                                <div class="additional-images-dp2">
                                    <!-- Thumbnails will be populated by updateProductDisplayForColor -->
                                </div>
                            </div>
                            <div class="product-details-area-dp2">
                                <h2>${productData.productTitle || ''}</h2>
                                <p class="style-number">Style: ${styleNumber}</p>
                                <p class="selected-color">Color: <span id="product-info-color-name">Select Color</span></p>
                                <p class="product-description">${productData.PRODUCT_DESCRIPTION || ''}</p>
                                <!-- Inline swatch area -->
                                <div id="inline-swatch-area" class="product-swatches"></div>
                            </div>
                        </div>
                    </div>`;
                }

                // --- Function to generate color swatches ---
                function generateColorSwatches(colors) {
                    console.log(`Swatches: Generating from ${colors.length} colors`);
                    
                    const inlineSwatchArea = document.getElementById('inline-swatch-area');
                    if (!inlineSwatchArea) {
                        console.error("Swatches: Inline swatch area not found!");
                        return;
                    }
                    
                    // Clear the swatch area
                    inlineSwatchArea.innerHTML = '';
                    
                    if (!colors || colors.length === 0) {
                        inlineSwatchArea.innerHTML = '<p>No color options found.</p>';
                        return;
                    }
                    
                    // Create title
                    const title = document.createElement('p');
                    title.textContent = 'Available Colors:';
                    inlineSwatchArea.appendChild(title);
                    
                    // Create container
                    const container = document.createElement('div');
                    container.className = 'swatch-container';
                    inlineSwatchArea.appendChild(container);
                    
                    // Add swatches
                    colors.forEach(color => {
                        if (!color.COLOR_NAME || !color.COLOR_SQUARE_IMAGE) return;
                        
                        const swatchWrapper = document.createElement('div');
                        swatchWrapper.className = 'swatch-wrapper';
                        
                        const swatchElement = document.createElement('div');
                        swatchElement.className = 'color-swatch-item';
                        swatchElement.title = color.COLOR_NAME;
                        swatchElement.style.backgroundImage = `url('${color.COLOR_SQUARE_IMAGE}')`;
                        swatchElement.dataset.colorName = color.COLOR_NAME;
                        swatchElement.dataset.catalogColor = color.CATALOG_COLOR;
                        swatchElement.dataset.colorIndex = colors.indexOf(color); // Store index for easy lookup
                        swatchElement.addEventListener('click', handleSwatchClick);
                        
                        const colorNameElement = document.createElement('div');
                        colorNameElement.className = 'color-name';
                        colorNameElement.textContent = color.COLOR_NAME;
                        
                        swatchWrapper.appendChild(swatchElement);
                        swatchWrapper.appendChild(colorNameElement);
                        container.appendChild(swatchWrapper);
                    });
                    
                    console.log(`Swatches: Generated ${colors.length} swatch elements`);
                }

                // --- Function to update product display for a specific color ---
                function updateProductDisplayForColor(colorObject) {
                    console.log(`ProductDisplay: Updating for color: ${colorObject.COLOR_NAME}`);
                    
                    // Update global variables
                    window.selectedColorName = colorObject.COLOR_NAME;
                    window.selectedCatalogColor = colorObject.CATALOG_COLOR;
                    
                    // Update color name in product info area
                    const colorNameSpan = document.getElementById('product-info-color-name');
                    if (colorNameSpan) colorNameSpan.textContent = colorObject.COLOR_NAME || 'N/A';
                    
                    // Update main product image
                    const mainImage = document.getElementById('main-product-image-dp2');
                    if (mainImage) {
                        // Use the best available image
                        const mainImageUrl = colorObject.MAIN_IMAGE_URL ||
                                           colorObject.FRONT_MODEL ||
                                           colorObject.FRONT_FLAT || '';
                        
                        mainImage.src = mainImageUrl;
                        mainImage.alt = `Product image for ${window.currentProductData.productTitle || window.selectedStyleNumber} - ${colorObject.COLOR_NAME}`;
                    }
                    
                    // Update thumbnails
                    const additionalImagesContainer = document.querySelector('.additional-images-dp2');
                    if (additionalImagesContainer) {
                        const altText = `Product image for ${window.currentProductData.productTitle || window.selectedStyleNumber} - ${colorObject.COLOR_NAME}`;
                        
                        // Create thumbnails from available images
                        additionalImagesContainer.innerHTML = '';
                        
                        // Add thumbnails in priority order
                        const imageSources = [
                            { url: colorObject.FRONT_MODEL, label: 'Front Model' },
                            { url: colorObject.FRONT_FLAT, label: 'Front Flat' },
                            { url: colorObject.BACK_MODEL, label: 'Back Model' },
                            { url: colorObject.BACK_FLAT, label: 'Back Flat' },
                            { url: colorObject.SIDE_MODEL, label: 'Side Model' },
                            { url: colorObject.SIDE_FLAT, label: 'Side Flat' }
                        ];
                        
                        imageSources.forEach(source => {
                            if (source.url && source.url.trim() !== '') {
                                const thumbnail = document.createElement('img');
                                thumbnail.className = 'product-thumbnail-dp2';
                                thumbnail.src = source.url;
                                thumbnail.alt = `${altText} - ${source.label}`;
                                thumbnail.addEventListener('click', handleThumbnailClick);
                                thumbnail.onerror = function() { this.style.display = 'none'; };
                                additionalImagesContainer.appendChild(thumbnail);
                            }
                        });
                        
                        // Activate the first thumbnail
                        const firstThumb = additionalImagesContainer.querySelector('.product-thumbnail-dp2');
                        if (firstThumb) {
                            firstThumb.classList.add('active-thumbnail');
                            firstThumb.style.opacity = '1.0';
                            firstThumb.style.border = '2px solid #007bff';
                        }
                    }
                }

                // --- Main Orchestration Function ---
                async function updatePageForStyle(styleNumber) {
                    console.log(`--- StyleSearch: Updating Page for Style: ${styleNumber} ---`);
                    
                    // Store the style number in global variables
                    window.selectedStyleNumber = styleNumber;
                    window.selectedColorName = null;
                    window.selectedCatalogColor = null;
                    window.currentProductData = null; // Reset product data
                    
                    console.log("Global variables reset:", {
                        selectedStyleNumber: window.selectedStyleNumber,
                        selectedColorName: window.selectedColorName,
                        selectedCatalogColor: window.selectedCatalogColor,
                        currentProductData: window.currentProductData
                    });
                    
                    // Update loading indicators
                    if (productInfoArea) {
                        console.log("Updating product info area with loading message");
                        productInfoArea.innerHTML = '<div class="loading-message">Loading product details...</div>';
                    } else {
                        console.error("Product info area not found!");
                    }
                    
                    // Update inventory area with loading message
                    const inventoryAreaElement = document.getElementById('inventory-area');
                    if (inventoryAreaElement) {
                        console.log("Updating inventory area with loading message");
                        inventoryAreaElement.innerHTML = '<p><i>Loading Inventory...</i></p>';
                    } else {
                        console.error("Inventory area not found!");
                    }
                    
                    // Load product data (which will handle swatches and initial color selection)
                    console.log("Calling loadProductData with styleNumber:", styleNumber);
                    await loadProductData(styleNumber);
                    
                    console.log("--- StyleSearch: Initial updates triggered for style", styleNumber);
                }
        
                // --- Tab Switching Logic ---
                function setupTabs() {
                    if (!tabNav) return; // Exit if tab structure not found
        
                    tabNav.addEventListener('click', (e) => {
                        if (e.target && e.target.classList.contains('tab-link')) {
                            e.preventDefault(); // Prevent default anchor link behavior
        
                            const targetPanelSelector = e.target.getAttribute('data-tab-target');
                            if (!targetPanelSelector) return;
        
                            console.log("Tab clicked, target:", targetPanelSelector);
                            
                            // Add a loading spinner near the clicked tab
                            const spinnerDiv = document.createElement('div');
                            spinnerDiv.className = 'loading-spinner';
                            
                            // Get the position of the clicked tab
                            const tabRect = e.target.getBoundingClientRect();
                            
                            // Position the spinner next to the tab
                            spinnerDiv.style.position = 'absolute';
                            spinnerDiv.style.left = `${tabRect.right + 10}px`;
                            spinnerDiv.style.top = `${tabRect.top + (tabRect.height/2) - 15}px`;
                            spinnerDiv.style.width = '30px';
                            spinnerDiv.style.height = '30px';
                            spinnerDiv.style.border = '3px solid rgba(0, 123, 255, 0.3)';
                            spinnerDiv.style.borderTop = '3px solid #007bff';
                            spinnerDiv.style.borderRadius = '50%';
                            spinnerDiv.style.animation = 'spin 1s linear infinite';
                            spinnerDiv.style.zIndex = '9999';
                            
                            // Add keyframe animation for spinner
                            if (!document.getElementById('spinner-style')) {
                                const styleEl = document.createElement('style');
                                styleEl.id = 'spinner-style';
                                styleEl.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
                                document.head.appendChild(styleEl);
                            }
                            
                            document.body.appendChild(spinnerDiv);
                            setTimeout(() => spinnerDiv.remove(), 3000); // Remove after 3 seconds
        
                            // Remove active class from all links and panels
                            tabLinks.forEach(link => link.classList.remove('active'));
                            tabContentPanels.forEach(panel => panel.classList.remove('active'));
        
                            // Add active class to clicked link and target panel
                            e.target.classList.add('active');
                            const targetPanel = document.querySelector(targetPanelSelector);
                            if (targetPanel) {
                                targetPanel.classList.add('active');
                                console.log("Activated panel:", targetPanelSelector);
                                
                                // Trigger a refresh/re-init for the newly activated DataPage
                                // This is needed if DPs don't display correctly when initially hidden
                                try {
                                    // Add a loading indicator to the panel to show that it's being refreshed
                                    const refreshContainer = document.createElement('div');
                                    refreshContainer.style.display = 'flex';
                                    refreshContainer.style.alignItems = 'center';
                                    refreshContainer.style.margin = '10px 0';
                                    refreshContainer.style.padding = '10px';
                                    refreshContainer.style.backgroundColor = 'var(--background-light)';
                                    refreshContainer.style.borderRadius = 'var(--radius-sm)';
                                    
                                    // Create spinner
                                    const spinner = document.createElement('div');
                                    spinner.style.width = '20px';
                                    spinner.style.height = '20px';
                                    spinner.style.border = '3px solid rgba(0, 123, 255, 0.3)';
                                    spinner.style.borderTop = '3px solid var(--primary-color)';
                                    spinner.style.borderRadius = '50%';
                                    spinner.style.animation = 'spin 1s linear infinite';
                                    spinner.style.marginRight = '10px';
                                    
                                    // Create text
                                    const text = document.createElement('div');
                                    text.textContent = `Refreshing data for ${targetPanelSelector.substring(1)}...`;
                                    text.style.color = 'var(--primary-color)';
                                    
                                    refreshContainer.appendChild(spinner);
                                    refreshContainer.appendChild(text);
                                    targetPanel.prepend(refreshContainer);
                                    
                                    // Store reference for later removal
                                    const refreshIndicator = refreshContainer;
                                    
                                    // Check if we have a style number
                                    if (!window.selectedStyleNumber) {
                                        console.warn("No style number selected for refresh");
                                        
                                        // Update the container to show error state
                                        refreshContainer.style.backgroundColor = '#fff0f0';
                                        refreshContainer.style.border = '1px solid #ffcccc';
                                        
                                        // Replace spinner with error icon
                                        spinner.style.border = 'none';
                                        spinner.style.animation = 'none';
                                        spinner.style.width = '20px';
                                        spinner.style.height = '20px';
                                        spinner.style.borderRadius = '50%';
                                        spinner.style.backgroundColor = '#c00';
                                        spinner.style.position = 'relative';
                                        
                                        // Add X to error icon
                                        spinner.innerHTML = '<span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 12px;">!</span>';
                                        
                                        // Update text
                                        text.textContent = "Error: No style number selected";
                                        text.style.color = '#c00';
                                        
                                        setTimeout(() => refreshIndicator.remove(), 3000);
                                        return;
                                    }
                                    
                                    // Debug: Log the selected style number
                                    console.log("DEBUG - Selected Style Number:", window.selectedStyleNumber);
                                    console.log("DEBUG - URL Parameters:", window.location.search);
                                    
                                    // Refresh the appropriate data page
                                    if (targetPanelSelector === '#embroidery-panel' && typeof initDp5ApiFetch === 'function') {
                                        console.log("Refreshing DP5 (Embroidery) data...");
                                        console.log("Using style number:", window.selectedStyleNumber);
                                        initDp5ApiFetch(window.selectedStyleNumber);
                                        refreshIndicator.textContent = `Refreshing DP5 (Embroidery) data for style ${window.selectedStyleNumber}...`;
                                    } else if (targetPanelSelector === '#cap-emb-panel' && typeof initDp7ApiFetch === 'function') {
                                        console.log("Refreshing DP7 (Cap Embroidery) data...");
                                        initDp7ApiFetch(window.selectedStyleNumber);
                                        refreshIndicator.textContent = `Refreshing DP7 (Cap Embroidery) data for style ${window.selectedStyleNumber}...`;
                                    } else if (targetPanelSelector === '#dtg-panel' && typeof initDp6ApiFetch === 'function') {
                                        console.log("Refreshing DP6 (DTG) data...");
                                        initDp6ApiFetch(window.selectedStyleNumber);
                                        refreshIndicator.textContent = `Refreshing DP6 (DTG) data for style ${window.selectedStyleNumber}...`;
                                    } else if (targetPanelSelector === '#screenprint-panel' && typeof initDp8ApiFetch === 'function') {
                                        console.log("Refreshing DP8 (Screen Print) data...");
                                        initDp8ApiFetch(window.selectedStyleNumber);
                                        refreshIndicator.textContent = `Refreshing DP8 (Screen Print) data for style ${window.selectedStyleNumber}...`;
                                    } else if (targetPanelSelector === '#dtf-panel' && typeof initDtfApiFetch === 'function') {
                                        console.log("Refreshing DTF data...");
                                        initDtfApiFetch(window.selectedStyleNumber);
                                        refreshIndicator.textContent = `Refreshing DTF data for style ${window.selectedStyleNumber}...`;
                                    } else if (targetPanelSelector === '#inventory-panel' && typeof loadInventory === 'function') {
                                        console.log("Refreshing Inventory data...");
                                        loadInventory(window.selectedStyleNumber, window.selectedCatalogColor);
                                        refreshIndicator.textContent = `Refreshing Inventory data for style ${window.selectedStyleNumber}...`;
                                    } else {
                                        refreshIndicator.textContent = `No refresh function found for ${targetPanelSelector}`;
                                        refreshIndicator.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
                                    }
                                    
                                    // Remove the indicator after 3 seconds
                                    setTimeout(() => refreshIndicator.remove(), 3000);
                                } catch (error) {
                                    console.error("Error refreshing data page:", error);
                                    
                                    // Update the container to show error state
                                    refreshContainer.style.backgroundColor = '#fff0f0';
                                    refreshContainer.style.border = '1px solid #ffcccc';
                                    
                                    // Replace spinner with error icon
                                    spinner.style.border = 'none';
                                    spinner.style.animation = 'none';
                                    spinner.style.width = '20px';
                                    spinner.style.height = '20px';
                                    spinner.style.borderRadius = '50%';
                                    spinner.style.backgroundColor = '#c00';
                                    spinner.style.position = 'relative';
                                    
                                    // Add X to error icon
                                    spinner.innerHTML = '<span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 12px;">!</span>';
                                    
                                    // Update text
                                    text.textContent = `Error refreshing data: ${error.message}`;
                                    text.style.color = '#c00';
                                    
                                    // Keep error visible a bit longer
                                    setTimeout(() => refreshIndicator.remove(), 5000);
                                }
                            } else {
                                console.error("Tab target panel not found:", targetPanelSelector);
                            }
                        }
                    });
                    console.log("Tab system initialized.");
                }
        
        
                // --- Initial Event Listeners Setup ---
                if (styleSearchInput) {
                     // Add input event listener for autocomplete
                     styleSearchInput.addEventListener('input', debounce(async (e) => { await fetchStyleSuggestions(e.target.value); }, 300));
                     
                     // Add keydown event listener for Enter key
                     styleSearchInput.addEventListener('keydown', (e) => {
                         console.log("StyleSearch: Keydown event detected, key:", e.key);
                         
                         if (e.key === 'Enter') {
                             console.log("StyleSearch: Enter key detected");
                             e.preventDefault();
                             
                             // Get the input element directly to ensure we have the latest value
                             const inputElement = document.getElementById('style-search-input');
                             const styleNumber = inputElement ? inputElement.value.trim() : '';
                             console.log("StyleSearch: Style number from input:", styleNumber);
                             
                             if (styleNumber) {
                                 console.log("StyleSearch: Enter key pressed with valid value:", styleNumber);
                                 clearSuggestions();
                                 
                                 // Add a spinner to indicate search is in progress
                                 const spinnerContainer = document.createElement('div');
                                 
                                 // Get the position of the search button
                                 const buttonRect = searchButton.getBoundingClientRect();
                                 
                                 // Position the spinner next to the search button
                                 spinnerContainer.style.position = 'absolute';
                                 spinnerContainer.style.left = `${buttonRect.right + 10}px`;
                                 spinnerContainer.style.top = `${buttonRect.top}px`;
                                 spinnerContainer.style.zIndex = '9999';
                                 spinnerContainer.style.display = 'flex';
                                 spinnerContainer.style.alignItems = 'center';
                                 spinnerContainer.style.padding = '8px 12px';
                                 spinnerContainer.style.backgroundColor = 'white';
                                 spinnerContainer.style.borderRadius = '4px';
                                 spinnerContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
                                 
                                 // Create spinner
                                 const spinner = document.createElement('div');
                                 spinner.style.width = '16px';
                                 spinner.style.height = '16px';
                                 spinner.style.border = '2px solid rgba(0, 123, 255, 0.3)';
                                 spinner.style.borderTop = '2px solid var(--primary-color)';
                                 spinner.style.borderRadius = '50%';
                                 spinner.style.animation = 'spin 1s linear infinite';
                                 spinner.style.marginRight = '8px';
                                 
                                 // Create text
                                 const text = document.createElement('div');
                                 text.textContent = `Searching for style: ${styleNumber}...`;
                                 text.style.color = 'var(--primary-color)';
                                 text.style.fontSize = '14px';
                                 
                                 spinnerContainer.appendChild(spinner);
                                 spinnerContainer.appendChild(text);
                                 document.body.appendChild(spinnerContainer);
                                 
                                 // Remove the indicator after 3 seconds
                                 setTimeout(() => spinnerContainer.remove(), 3000);
                                 
                                 // Call the update function
                                 updatePageForStyle(styleNumber);
                             } else {
                                 console.warn("StyleSearch: Empty style number, not processing");
                             }
                         }
                     });
                     
                     // Add search button click event listener
                     const searchButton = document.getElementById('search-button');
                     if (searchButton) {
                         searchButton.addEventListener('click', () => {
                             console.log("StyleSearch: Search button clicked");
                             
                             // Get the input element directly to ensure we have the latest value
                             const inputElement = document.getElementById('style-search-input');
                             if (!inputElement) {
                                 console.error("StyleSearch: Input element not found when button clicked");
                                 return;
                             }
                             
                             const styleNumber = inputElement.value.trim();
                             console.log("StyleSearch: Style number from input:", styleNumber);
                             
                             if (styleNumber) {
                                 console.log("StyleSearch: Search button clicked with valid value:", styleNumber);
                                 clearSuggestions();
                                 
                                 // Add a spinner to indicate search is in progress
                                 const spinnerContainer = document.createElement('div');
                                 
                                 // Get the position of the search input
                                 const inputRect = inputElement.getBoundingClientRect();
                                 
                                 // Position the spinner next to the search input
                                 spinnerContainer.style.position = 'absolute';
                                 spinnerContainer.style.left = `${inputRect.right + 10}px`;
                                 spinnerContainer.style.top = `${inputRect.top}px`;
                                 spinnerContainer.style.zIndex = '9999';
                                 spinnerContainer.style.display = 'flex';
                                 spinnerContainer.style.alignItems = 'center';
                                 spinnerContainer.style.padding = '8px 12px';
                                 spinnerContainer.style.backgroundColor = 'white';
                                 spinnerContainer.style.borderRadius = '4px';
                                 spinnerContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
                                 
                                 // Create spinner
                                 const spinner = document.createElement('div');
                                 spinner.style.width = '16px';
                                 spinner.style.height = '16px';
                                 spinner.style.border = '2px solid rgba(0, 123, 255, 0.3)';
                                 spinner.style.borderTop = '2px solid var(--primary-color)';
                                 spinner.style.borderRadius = '50%';
                                 spinner.style.animation = 'spin 1s linear infinite';
                                 spinner.style.marginRight = '8px';
                                 
                                 // Create text
                                 const text = document.createElement('div');
                                 text.textContent = `Searching for style: ${styleNumber}...`;
                                 text.style.color = 'var(--primary-color)';
                                 text.style.fontSize = '14px';
                                 
                                 spinnerContainer.appendChild(spinner);
                                 spinnerContainer.appendChild(text);
                                 document.body.appendChild(spinnerContainer);
                                 
                                 // Remove the indicator after 3 seconds
                                 setTimeout(() => spinnerContainer.remove(), 3000);
                                 
                                 // Call the update function
                                 updatePageForStyle(styleNumber);
                             } else {
                                 console.warn("StyleSearch: Empty style number, not processing");
                             }
                         });
                     } else {
                         console.error("StyleSearch: Button element #search-button not found at init!");
                     }
                 } else { console.error("StyleSearch: Input element #style-search-input not found at init!"); }
                 
                 // Close suggestions when clicking outside
                 document.addEventListener('click', (e) => { if (styleSearchInput && suggestionsList && !styleSearchInput.contains(e.target) && !suggestionsList.contains(e.target)) { clearSuggestions(); } });
        
                 setupTabs(); // Initialize tab switching functionality
        
                 // --- Add this code to handle incoming StyleNumber from URL ---
                 try {
                     console.log("Checking for StyleNumber parameter in URL...");
                     const urlParams = new URLSearchParams(window.location.search); // Gets the '?StyleNumber=ABC' part
                     const styleNumberFromUrl = urlParams.get('StyleNumber'); // Tries to get the value 'ABC'
        
                     if (styleNumberFromUrl) {
                         console.log("Found StyleNumber in URL:", styleNumberFromUrl);
                         console.log("Automatically loading details for this style...");
        
                         // Update the search input field visually (optional, but good user feedback)
                         if (styleSearchInput) {
                              styleSearchInput.value = styleNumberFromUrl;
                         }
        
                         // Call the main function to load all data for this style
                         updatePageForStyle(styleNumberFromUrl);
        
                     } else {
                         console.log("No StyleNumber parameter found in URL. Page will wait for manual search.");
                         // Optionally display a default message if no style is loaded
                          if (productInfoArea && productInfoArea.innerHTML === '') {
                             productInfoArea.innerHTML = '<p><i>Search for a style number above or click a link from the gallery to view product details.</i></p>';
                          }
                          if (inventoryArea && inventoryArea.innerHTML === '') {
                              inventoryArea.innerHTML = '<p><i>Search for a style number to view inventory.</i></p>';
                          }
                     }
                 } catch (error) {
                     console.error("Error processing URL parameters:", error);
                     // Display a general error message if something goes wrong here
                      if (productInfoArea) {
                         productInfoArea.innerHTML = '<div class="error-message">Error reading initial style information from URL. Please try searching manually.</div>';
                      }
                 }
                 // --- End of code to handle incoming StyleNumber ---
        
                 console.log("Page Initialization Complete.");
        
            }); // End DOMContentLoaded listener
        </script>

            <div id="embroidery-panel" class="tab-content-panel">
                <div id="dp5-wrapper">
                    <div class="loading-message">Select a product to view embroidery pricing...</div>
                </div>
                <style>
                    /* Ensure iframe is properly displayed */
                    #embroidery-panel iframe {
                        display: block !important;
                        visibility: visible !important;
                        height: 600px !important;
                        width: 100% !important;
                        border: none !important;
                        overflow: auto;
                    }
                    
                    /* Style for loading message */
                    #embroidery-panel .loading-message {
                        padding: 20px;
                        text-align: center;
                        color: #555;
                    }
                    
                    /* Style for error messages */
                    #embroidery-panel .error-message {
                        padding: 15px;
                        background-color: #fff0f0;
                        border-left: 4px solid #c00;
                        margin: 15px 0;
                        color: #c00;
                    }
                </style>
            </div>

            <!-- Add a script to clean up any JavaScript code that might be displayed -->
            <script>
                // This script will run when the page loads
                document.addEventListener('DOMContentLoaded', function() {
                    // Function to clean up JavaScript code from tab panels
                    function cleanupJavaScriptCode() {
                        // Get all tab panels
                        const tabPanels = [
                            document.getElementById('embroidery-panel'),
                            document.getElementById('cap-emb-panel'),
                            document.getElementById('dtg-panel'),
                            document.getElementById('screenprint-panel')
                        ];
                        
                        // Process each panel
                        tabPanels.forEach(panel => {
                            if (!panel) return;
                            
                            // Remove any pre elements (which might contain code)
                            const preElements = panel.querySelectorAll('pre');
                            preElements.forEach(pre => {
                                pre.parentNode.removeChild(pre);
                            });
                            
                            // Remove any code elements
                            const codeElements = panel.querySelectorAll('code');
                            codeElements.forEach(code => {
                                code.parentNode.removeChild(code);
                            });
                            
                            // Find and remove any text nodes that contain script code
                            function removeScriptTextNodes(element) {
                                if (!element) return;
                                
                                // Check all child nodes
                                for (let i = 0; i < element.childNodes.length; i++) {
                                    const node = element.childNodes[i];
                                    
                                    // If it's a text node with script content
                                    if (node.nodeType === Node.TEXT_NODE) {
                                        if (node.textContent.includes('new function') ||
                                            node.textContent.includes('this.appKey') ||
                                            node.textContent.includes('function requestDataPage')) {
                                            element.removeChild(node);
                                            i--; // Adjust index since we removed a node
                                        }
                                    }
                                    // If it's an element node, recursively check its children
                                    else if (node.nodeType === Node.ELEMENT_NODE) {
                                        removeScriptTextNodes(node);
                                    }
                                }
                            }
                            
                            // Apply the text node cleanup
                            removeScriptTextNodes(panel);
                        });
                    }
                    
                    // Run cleanup when page loads
                    cleanupJavaScriptCode();
                    
                    // Also run cleanup when tabs are clicked
                    const tabLinks = document.querySelectorAll('.tab-link');
                    tabLinks.forEach(link => {
                        link.addEventListener('click', function() {
                            // Run cleanup after a short delay to ensure content is loaded
                            setTimeout(cleanupJavaScriptCode, 500);
                        });
                    });
                    
                    // Set up a MutationObserver to detect when content changes
                    const observer = new MutationObserver(function(mutations) {
                        // Run cleanup after content changes
                        cleanupJavaScriptCode();
                    });
                    
                    // Observe all tab panels for content changes
                    const tabPanels = document.querySelectorAll('.tab-content-panel');
                    tabPanels.forEach(panel => {
                        observer.observe(panel, {
                            childList: true,
                            subtree: true,
                            characterData: true
                        });
                    });
                });
            </script>
            
            <!-- Additional script to immediately hide script content and handle loading messages -->
            <script>
                // This script runs immediately to hide script content and handle loading messages
                (function() {
                    // TARGETED FIX FOR CASPIO LOADING MESSAGE
                    function setupCaspioLoadingMessageFix() {
                        console.log("Setting up Caspio loading message fix");
                        
                        // Function to hide all loading messages
                        function hideAllLoadingMessages() {
                            const loadingMessages = document.querySelectorAll('.loading-message');
                            loadingMessages.forEach(function(msg) {
                                console.log('Hiding loading message:', msg);
                                msg.style.display = 'none';
                            });
                        }
                        
                        // Function to check if Caspio table is loaded
                        function checkCaspioTableLoaded() {
                            // Check for various indicators that Caspio content has loaded
                            const hasCaspioTable = !!document.querySelector('.matrix-price-table') ||
                                                  !!document.querySelector('.cbResultSetTable') ||
                                                  !!document.querySelector('#matrix-price-body') ||
                                                  !!document.querySelector('.cbResultSet');
                            
                            if (hasCaspioTable) {
                                console.log('Caspio table detected, hiding loading messages');
                                hideAllLoadingMessages();
                                return true;
                            }
                            return false;
                        }
                        
                        // Set up a MutationObserver to detect when Caspio content is added
                        const observer = new MutationObserver(function(mutations) {
                            if (checkCaspioTableLoaded()) {
                                // If we found the table, disconnect the observer
                                observer.disconnect();
                            }
                        });
                        
                        // Start observing the document with the configured parameters
                        observer.observe(document.body, { childList: true, subtree: true });
                        
                        // Also check immediately in case the table is already loaded
                        checkCaspioTableLoaded();
                        
                        // Set up periodic checks to ensure loading message is hidden
                        const checkIntervals = [1000, 2000, 3000, 5000, 8000, 10000];
                        checkIntervals.forEach(interval => {
                            setTimeout(() => {
                                if (document.querySelector('.loading-message')) {
                                    console.log(`Checking for Caspio table after ${interval}ms`);
                                    if (checkCaspioTableLoaded()) {
                                        console.log(`Found Caspio table after ${interval}ms`);
                                    } else {
                                        // If we still have loading messages but no table after 5+ seconds,
                                        // hide them anyway as a fallback
                                        if (interval >= 5000) {
                                            console.log(`No Caspio table found after ${interval}ms, hiding loading messages anyway`);
                                            hideAllLoadingMessages();
                                        }
                                    }
                                }
                            }, interval);
                        });
                    }
                    
                    // Call the setup function immediately
                    setupCaspioLoadingMessageFix();
                    
                    // Also call it when the DOM is fully loaded
                    document.addEventListener('DOMContentLoaded', setupCaspioLoadingMessageFix);
                    // Create a style element to hide script content
                    const styleEl = document.createElement('style');
                    styleEl.id = 'hide-script-content-style';
                    styleEl.textContent = `
                        /* SPECIAL EXCEPTION FOR INVENTORY PANEL - DON'T HIDE ANYTHING */
                        #inventory-panel, #inventory-panel *, #inventory-area, #inventory-area * {
                            visibility: visible !important;
                            display: initial !important;
                            position: static !important;
                            height: auto !important;
                            width: auto !important;
                            overflow: visible !important;
                            opacity: 1 !important;
                        }
                        
                        /* Fix table display specifically */
                        #inventory-table {
                            display: table !important;
                            width: 100% !important;
                            border-collapse: separate !important;
                            border-spacing: 0 !important;
                            margin-top: 15px !important;
                        }
                        #inventory-table thead {
                            display: table-header-group !important;
                        }
                        #inventory-table tbody {
                            display: table-row-group !important;
                        }
                        #inventory-table tfoot {
                            display: table-footer-group !important;
                        }
                        #inventory-table tr {
                            display: table-row !important;
                        }
                        #inventory-table th, #inventory-table td {
                            display: table-cell !important;
                            padding: 8px !important;
                            text-align: left !important;
                        }
                        
                        /* Hide script content in other panels */
                        #embroidery-panel > *:not(#dp5-wrapper):not(.loading-message):not(.iframe-container),
                        #cap-emb-panel > *:not(#dp7-wrapper):not(.loading-message):not(.iframe-container),
                        #dtg-panel > *:not(#dp6-wrapper):not(.loading-message):not(.iframe-container),
                        #screenprint-panel > *:not(#dp8-wrapper):not(.loading-message):not(.iframe-container),
                        #dtf-panel > *:not(#dtf-wrapper):not(.loading-message):not(.iframe-container) {
                            display: none !important;
                            visibility: hidden !important;
                            height: 0 !important;
                            width: 0 !important;
                            overflow: hidden !important;
                            position: absolute !important;
                            left: -9999px !important;
                        }
                        
                        /* Ensure iframe is visible */
                        iframe {
                            display: block !important;
                            visibility: visible !important;
                            height: 600px !important;
                            width: 100% !important;
                            border: none !important;
                        }
                        
                        /* IMPORTANT: Hide loading messages when Caspio table is present */
                        .loading-message:has(+ .matrix-price-table),
                        .loading-message:has(+ .cbResultSetTable),
                        .loading-message:has(~ .matrix-price-table),
                        .loading-message:has(~ .cbResultSetTable),
                        .loading-message:has(+ iframe),
                        .loading-message:has(~ iframe) {
                            display: none !important;
                        }
                        
                        /* Hide loading messages in wrapper divs that contain Caspio content */
                        #dp5-wrapper:has(.matrix-price-table) .loading-message,
                        #dp5-wrapper:has(.cbResultSetTable) .loading-message,
                        #dp5-wrapper:has(iframe) .loading-message,
                        #dp6-wrapper:has(.matrix-price-table) .loading-message,
                        #dp6-wrapper:has(.cbResultSetTable) .loading-message,
                        #dp6-wrapper:has(iframe) .loading-message,
                        #dp7-wrapper:has(.matrix-price-table) .loading-message,
                        #dp7-wrapper:has(.cbResultSetTable) .loading-message,
                        #dp7-wrapper:has(iframe) .loading-message,
                        #dp8-wrapper:has(.matrix-price-table) .loading-message,
                        #dp8-wrapper:has(.cbResultSetTable) .loading-message,
                        #dp8-wrapper:has(iframe) .loading-message,
                        #dtf-wrapper:has(.matrix-price-table) .loading-message,
                        #dtf-wrapper:has(.cbResultSetTable) .loading-message,
                        #dtf-wrapper:has(iframe) .loading-message {
                            display: none !important;
                        }
                    `;
                    document.head.appendChild(styleEl);
                    
                    // Function to clean up script content
                    function aggressiveCleanup() {
                        // Get all tab panels
                        const tabPanels = [
                            document.getElementById('embroidery-panel'),
                            document.getElementById('cap-emb-panel'),
                            document.getElementById('dtg-panel'),
                            document.getElementById('screenprint-panel')
                        ];
                        
                        tabPanels.forEach(panel => {
                            if (!panel) return;
                            
                            // Get all elements in the panel
                            const allElements = panel.querySelectorAll('*');
                            
                            // Check each element
                            allElements.forEach(el => {
                                // Skip specific elements we want to keep
                                if (el.id === 'dp5-wrapper' || el.id === 'dp6-wrapper' ||
                                    el.id === 'dp7-wrapper' || el.id === 'dp8-wrapper' ||
                                    el.classList.contains('loading-message') ||
                                    el.classList.contains('iframe-container') ||
                                    el.tagName === 'IFRAME') {
                                    return;
                                }
                                
                                // Check if the element contains script-like content
                                const text = el.textContent || '';
                                if (text.includes('new function') ||
                                    text.includes('this.appKey') ||
                                    text.includes('function requestDataPage') ||
                                    text.includes('subdomain') ||
                                    text.includes('isDotNet') ||
                                    text.includes('userQuery')) {
                                    
                                    // Hide the element
                                    el.style.display = 'none';
                                    el.style.visibility = 'hidden';
                                    el.style.height = '0';
                                    el.style.width = '0';
                                    el.style.overflow = 'hidden';
                                    el.style.position = 'absolute';
                                    el.style.left = '-9999px';
                                    
                                    // Remove the element's content
                                    el.innerHTML = '';
                                    el.textContent = '';
                                }
                            });
                        });
                    }
                    
                    // Run cleanup immediately
                    aggressiveCleanup();
                    
                    // Run cleanup when DOM is loaded
                    document.addEventListener('DOMContentLoaded', aggressiveCleanup);
                    
                    // Run cleanup when tabs are clicked
                    document.addEventListener('DOMContentLoaded', function() {
                        const tabLinks = document.querySelectorAll('.tab-link');
                        tabLinks.forEach(link => {
                            link.addEventListener('click', function() {
                                // Run cleanup after a short delay
                                setTimeout(aggressiveCleanup, 100);
                                
                                // Run cleanup again after iframe loads
                                setTimeout(aggressiveCleanup, 1000);
                                setTimeout(aggressiveCleanup, 2000);
                            });
                        });
                    });
                    // Run the original script content hiding logic
                })();
                
                // Additional cleanup for any remaining loading messages after a delay
                setTimeout(function() {
                    console.log('Final check for loading messages');
                    const allLoadingMessages = document.querySelectorAll('.loading-message');
                    if (allLoadingMessages.length > 0) {
                        console.log(`Found ${allLoadingMessages.length} loading messages still visible, hiding them`);
                        allLoadingMessages.forEach(function(msg) {
                            msg.style.display = 'none';
                        });
                    } else {
                        console.log('No loading messages found');
                    }
                }, 5000); // Check after 5 seconds
                
                // Add a more aggressive final cleanup
                setTimeout(function() {
                    console.log('FINAL AGGRESSIVE CLEANUP');
                    // Force hide ALL loading messages regardless of context
                    const allLoadingMessages = document.querySelectorAll('.loading-message');
                    allLoadingMessages.forEach(function(msg) {
                        console.log('Forcibly hiding loading message:', msg);
                        msg.style.display = 'none';
                        msg.style.visibility = 'hidden';
                        msg.style.opacity = '0';
                        msg.style.height = '0';
                        msg.style.overflow = 'hidden';
                    });
                    
                    // Also try to find any elements that might contain "loading" text
                    const allElements = document.querySelectorAll('*');
                    allElements.forEach(function(el) {
                        if (el.textContent && el.textContent.toLowerCase().includes('loading')) {
                            const isVisible = window.getComputedStyle(el).display !== 'none';
                            if (isVisible && !el.querySelector('iframe') && !el.closest('iframe')) {
                                console.log('Found element with loading text, hiding:', el);
                                el.style.display = 'none';
                            }
                        }
                    });
                }, 12000); // Final aggressive cleanup after 12 seconds
            </script>

            <div id="cap-emb-panel" class="tab-content-panel">
                <div id="dp7-wrapper">
                    <!-- Content will be loaded dynamically by initDp7ApiFetch -->
                    <div class="loading-message">Select a product to view cap embroidery pricing...</div>
                    <div class="iframe-container"></div>
                </div>
            </div>

            <div id="dtg-panel" class="tab-content-panel">
                <div id="dp6-wrapper">
                    <!-- Content will be loaded dynamically by initDp6ApiFetch -->
                    <div class="loading-message">Select a product to view DTG pricing...</div>
                    <div class="iframe-container"></div>
                </div>
            </div>

            <div id="screenprint-panel" class="tab-content-panel">
                <div id="dp8-wrapper">
                    <!-- Content will be loaded dynamically by initDp8ApiFetch -->
                    <div class="loading-message">Select a product to view screen print pricing...</div>
                    <div class="iframe-container"></div>
                </div>
            </div>

            <div id="dtf-panel" class="tab-content-panel">
                <div id="dtf-wrapper">
                    <!-- Content will be loaded dynamically by initDtfApiFetch -->
                    <div class="loading-message">Select a product to view DTF pricing...</div>
                    <div class="iframe-container"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
