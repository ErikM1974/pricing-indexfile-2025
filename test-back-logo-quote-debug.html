<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back Logo Quote Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .debug-log { background: #000; color: #0f0; padding: 10px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .status { padding: 8px; margin: 5px 0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Back Logo Quote Integration Debug</h1>
    
    <div class="test-section">
        <h3>Back Logo Add-on Simulation</h3>
        <label>
            <input type="checkbox" id="back-logo-addon-checkbox"> Add Back Logo
        </label>
        <div style="margin: 10px 0;">
            <label>Stitch Count: 
                <select id="back-logo-stitch-dropdown">
                    <option value="5000">5,000</option>
                    <option value="6000">6,000</option>
                    <option value="7000">7,000</option>
                    <option value="8000">8,000</option>
                    <option value="10000">10,000</option>
                </select>
            </label>
        </div>
        <div id="back-logo-addon-price-display" style="display: none; font-weight: bold; color: #0066cc;">
            +$5.00 per cap
        </div>
        <div id="back-logo-addon-details" style="display: none;">
            Details shown
        </div>
        <div id="back-logo-price-breakdown">
            $5.00 (5,000 stitches)
        </div>
    </div>

    <div class="test-section">
        <h3>Test Controls</h3>
        <button onclick="testAddonSystem()">Test Addon System</button>
        <button onclick="simulateQuoteAdd()">Simulate Add to Quote</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>Debug Log</h3>
        <div id="debug-log" class="debug-log"></div>
    </div>

    <div class="test-section">
        <h3>Test Results</h3>
        <div id="test-results"></div>
    </div>

    <!-- Load the necessary JavaScript files -->
    <script src="/shared_components/js/cap-embroidery-back-logo-addon.js"></script>
    <script src="/shared_components/js/quote-adapter-base.js"></script>
    <script src="/shared_components/js/cap-embroidery-quote-adapter.js"></script>

    <script>
        // Debug logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[DEBUG] ${message}`);
        }

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const result = document.createElement('div');
            result.className = `status ${type}`;
            result.textContent = message;
            resultsDiv.appendChild(result);
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
            document.getElementById('test-results').innerHTML = '';
        }

        // Test the addon system
        function testAddonSystem() {
            log('=== Testing Back Logo Addon System ===');
            
            if (window.CapEmbroideryBackLogoAddon) {
                log('✓ CapEmbroideryBackLogoAddon found');
                addResult('✓ Back Logo Addon System loaded', 'success');
                
                const state = window.CapEmbroideryBackLogoAddon.getState();
                log(`Initial state: ${JSON.stringify(state)}`);
                
                // Test enabling back logo
                const checkbox = document.getElementById('back-logo-addon-checkbox');
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.dispatchEvent(new Event('change'));
                    log('Checkbox toggled to checked');
                    
                    setTimeout(() => {
                        const newState = window.CapEmbroideryBackLogoAddon.getState();
                        log(`State after toggle: ${JSON.stringify(newState)}`);
                        
                        if (newState.enabled) {
                            addResult('✓ Back logo successfully enabled', 'success');
                        } else {
                            addResult('✗ Back logo not enabled after checkbox toggle', 'error');
                        }
                    }, 100);
                }
            } else {
                log('✗ CapEmbroideryBackLogoAddon not found');
                addResult('✗ Back Logo Addon System not loaded', 'error');
            }
        }

        // Simulate adding to quote
        function simulateQuoteAdd() {
            log('=== Testing Quote Integration ===');
            
            if (window.capEmbroideryQuoteAdapter) {
                log('✓ Cap embroidery quote adapter found');
                
                // Check if back logo is enabled
                const isEnabled = window.CapEmbroideryBackLogoAddon ? 
                    window.CapEmbroideryBackLogoAddon.isEnabled() : false;
                const stitchCount = window.CapEmbroideryBackLogoAddon ? 
                    window.CapEmbroideryBackLogoAddon.getStitchCount() : 0;
                const price = window.CapEmbroideryBackLogoAddon ? 
                    window.CapEmbroideryBackLogoAddon.getPrice() : 0;
                
                log(`Back logo enabled: ${isEnabled}`);
                log(`Stitch count: ${stitchCount}`);
                log(`Price: $${price}`);
                
                // Create a mock quote item
                const mockItemData = {
                    styleNumber: 'TEST-123',
                    productName: 'Test Cap',
                    color: 'Black',
                    quantity: 12,
                    baseUnitPrice: 15.00,
                    stitchCount: '8000',
                    hasBackLogo: isEnabled,
                    backLogoStitchCount: stitchCount,
                    backLogoPrice: price,
                    sizeBreakdown: { 'OSFA': 12 },
                    sizePricing: { 'OSFA': { quantity: 12, basePrice: 15.00, unitPrice: 15.00 + price, lineTotal: (15.00 + price) * 12 } }
                };
                
                log(`Creating quote item with data: ${JSON.stringify(mockItemData, null, 2)}`);
                
                // Create quote item using the adapter
                const quoteItem = window.capEmbroideryQuoteAdapter.createQuoteItem(mockItemData);
                log(`Created quote item: ${JSON.stringify(quoteItem, null, 2)}`);
                
                // Test the render method
                const renderedHTML = window.capEmbroideryQuoteAdapter.renderQuoteItem(quoteItem);
                log(`Rendered HTML: ${renderedHTML}`);
                
                if (isEnabled && quoteItem.hasBackLogo) {
                    addResult('✓ Back logo included in quote item', 'success');
                    if (quoteItem.finalUnitPrice > quoteItem.baseUnitPrice) {
                        addResult('✓ Back logo price included in final unit price', 'success');
                    } else {
                        addResult('✗ Back logo price not included in final unit price', 'error');
                    }
                } else if (isEnabled) {
                    addResult('✗ Back logo enabled but not included in quote', 'error');
                } else {
                    addResult('ℹ Back logo not enabled, quote item created without back logo', 'info');
                }
                
            } else {
                log('✗ Cap embroidery quote adapter not found');
                addResult('✗ Quote adapter not loaded', 'error');
            }
        }

        // Listen for back logo events
        document.addEventListener('backLogoToggled', function(e) {
            log(`Event: backLogoToggled - ${JSON.stringify(e.detail)}`);
        });

        document.addEventListener('backLogoUpdated', function(e) {
            log(`Event: backLogoUpdated - ${JSON.stringify(e.detail)}`);
        });

        // Initialize
        window.addEventListener('load', function() {
            log('Page loaded, systems ready');
            setTimeout(testAddonSystem, 500);
        });
    </script>
</body>
</html>